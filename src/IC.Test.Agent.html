<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{- |

This module contains function to interact with an Internet Computer instance.

The primary customer here is IC.Test.Spec, i.e the test suite. Therefore, the
functions here give access to varoius levels of abstractions, and gives more control
than a &#8220;normal&#8221; agent library would do.

Also, because of the focus on testing, failures are repoted directly with HUnit&#8217;s 'assertFailure'.

As guidance: This modules does _not_ rely on the universal canister.

This module can also be used in a REPL; see 'connect'.

-}</span><span>
</span><span id="line-16"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><span id="line-17"></span><span class="hs-pragma">{-# LANGUAGE ImplicitParams #-}</span><span>
</span><span id="line-18"></span><span class="hs-pragma">{-# LANGUAGE TypeApplications #-}</span><span>
</span><span id="line-19"></span><span class="hs-pragma">{-# LANGUAGE ConstraintKinds #-}</span><span>
</span><span id="line-20"></span><span class="hs-pragma">{-# LANGUAGE LambdaCase #-}</span><span>
</span><span id="line-21"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-22"></span><span class="hs-pragma">{-# LANGUAGE RankNTypes #-}</span><span>
</span><span id="line-23"></span><span class="hs-pragma">{-# LANGUAGE BlockArguments #-}</span><span>
</span><span id="line-24"></span><span class="hs-pragma">{-# LANGUAGE OverloadedLabels #-}</span><span>
</span><span id="line-25"></span><span class="hs-pragma">{-# LANGUAGE TypeOperators #-}</span><span>
</span><span id="line-26"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-27"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><span id="line-28"></span><span class="hs-pragma">{-# LANGUAGE NumericUnderscores #-}</span><span>
</span><span id="line-29"></span><span class="hs-pragma">{-# LANGUAGE DataKinds #-}</span><span>
</span><span id="line-30"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">IC.Test.Agent</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-31"></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">T</span></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text.Encoding</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">T</span></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text.Encoding.Error</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">T</span></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Text.Hex</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">H</span></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString.Lazy</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BS</span></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString.Builder</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BS</span></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.HashMap.Lazy</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">HM</span></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Vector</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Vec</span></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Network.HTTP.Client</span></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Network.HTTP.Client.TLS</span></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Network.HTTP.Types</span></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Numeric.Natural</span></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Char</span></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Test.Tasty.HUnit</span></span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Test.Tasty.Options</span></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Trans</span></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Except</span></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent</span></span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Exception</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">catch</span></span><span class="hs-special">)</span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Traversable</span></span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Word</span></span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">GHC.TypeLits</span></span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.Random</span></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.Exit</span></span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Time.Clock.POSIX</span></span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Codec.Candid</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Principal</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">prettyPrincipal</span></span><span class="hs-special">)</span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Binary.Get</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Get</span></span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Codec.Candid</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Candid</span></span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Row</span></span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Row.Records</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">R</span></span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Row.Variants</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">V</span></span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Row.Internal</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">R</span></span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Row.Dictionaries</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">R</span></span><span>
</span><span id="line-65"></span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="IC.Version.html"><span class="hs-identifier">IC.Version</span></a></span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="IC.HTTP.GenR.html"><span class="hs-identifier">IC.HTTP.GenR</span></a></span><span>
</span><span id="line-68"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="IC.HTTP.GenR.Parse.html"><span class="hs-identifier">IC.HTTP.GenR.Parse</span></a></span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="IC.HTTP.CBOR.html"><span class="hs-identifier">IC.HTTP.CBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.HTTP.CBOR.html#decode"><span class="hs-identifier">decode</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.HTTP.CBOR.html#encode"><span class="hs-identifier">encode</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-70"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="IC.HTTP.RequestId.html"><span class="hs-identifier">IC.HTTP.RequestId</span></a></span><span>
</span><span id="line-71"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="IC.Management.html"><span class="hs-identifier">IC.Management</span></a></span><span>
</span><span id="line-72"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="IC.Crypto.html"><span class="hs-identifier">IC.Crypto</span></a></span><span>
</span><span id="line-73"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="IC.Crypto.DER.html"><span class="hs-identifier">IC.Crypto.DER</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">DER</span></span><span>
</span><span id="line-74"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="IC.Crypto.DER_BLS.html"><span class="hs-identifier">IC.Crypto.DER_BLS</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">DER_BLS</span></span><span>
</span><span id="line-75"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="IC.Id.Forms.html"><span class="hs-identifier">IC.Id.Forms</span></a></span><span>
</span><span id="line-76"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="IC.Test.Options.html"><span class="hs-identifier">IC.Test.Options</span></a></span><span>
</span><span id="line-77"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="IC.HashTree.html"><span class="hs-identifier">IC.HashTree</span></a></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.HashTree.html#Blob"><span class="hs-identifier">Blob</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.HashTree.html#Label"><span class="hs-identifier">Label</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-78"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="IC.Certificate.html"><span class="hs-identifier">IC.Certificate</span></a></span><span>
</span><span id="line-79"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="IC.Certificate.Value.html"><span class="hs-identifier">IC.Certificate.Value</span></a></span><span>
</span><span id="line-80"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="IC.Certificate.CBOR.html"><span class="hs-identifier">IC.Certificate.CBOR</span></a></span><span>
</span><span id="line-81"></span><span>
</span><span id="line-82"></span><span class="hs-comment">-- * Agent configuration</span><span>
</span><span id="line-83"></span><span>
</span><span id="line-84"></span><span class="hs-keyword">data</span><span> </span><span id="AgentConfig"><span class="annot"><a href="IC.Test.Agent.html#AgentConfig"><span class="hs-identifier hs-var">AgentConfig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="AgentConfig"><span class="annot"><a href="IC.Test.Agent.html#AgentConfig"><span class="hs-identifier hs-var">AgentConfig</span></a></span></span><span>
</span><span id="line-85"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="tc_root_key"><span class="annot"><span class="annottext">AgentConfig -&gt; Blob
</span><a href="IC.Test.Agent.html#tc_root_key"><span class="hs-identifier hs-var hs-var">tc_root_key</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span>
</span><span id="line-86"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="tc_manager"><span class="annot"><span class="annottext">AgentConfig -&gt; Manager
</span><a href="IC.Test.Agent.html#tc_manager"><span class="hs-identifier hs-var hs-var">tc_manager</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Manager</span></span><span>
</span><span id="line-87"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="tc_endPoint"><span class="annot"><span class="annottext">AgentConfig -&gt; String
</span><a href="IC.Test.Agent.html#tc_endPoint"><span class="hs-identifier hs-var hs-var">tc_endPoint</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-88"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-89"></span><span>
</span><span id="line-90"></span><span class="annot"><a href="IC.Test.Agent.html#makeAgentConfig"><span class="hs-identifier hs-type">makeAgentConfig</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="IC.Test.Agent.html#AgentConfig"><span class="hs-identifier hs-type">AgentConfig</span></a></span><span>
</span><span id="line-91"></span><span id="makeAgentConfig"><span class="annot"><span class="annottext">makeAgentConfig :: String -&gt; IO AgentConfig
</span><a href="IC.Test.Agent.html#makeAgentConfig"><span class="hs-identifier hs-var hs-var">makeAgentConfig</span></a></span></span><span> </span><span id="local-6989586621679325368"><span class="annot"><span class="annottext">ep' :: String
</span><a href="#local-6989586621679325368"><span class="hs-identifier hs-var">ep'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-92"></span><span>    </span><span id="local-6989586621679325367"><span class="annot"><span class="annottext">Manager
</span><a href="#local-6989586621679325367"><span class="hs-identifier hs-var">manager</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ManagerSettings -&gt; IO Manager
forall (m :: * -&gt; *). MonadIO m =&gt; ManagerSettings -&gt; m Manager
</span><span class="hs-identifier hs-var">newTlsManagerWith</span></span><span> </span><span class="annot"><span class="annottext">(ManagerSettings -&gt; IO Manager) -&gt; ManagerSettings -&gt; IO Manager
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ManagerSettings
</span><span class="hs-identifier hs-var">tlsManagerSettings</span></span><span>
</span><span id="line-93"></span><span>      </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">managerResponseTimeout :: ResponseTimeout
</span><span class="hs-identifier hs-var">managerResponseTimeout</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; ResponseTimeout
</span><span class="hs-identifier hs-var">responseTimeoutMicro</span></span><span> </span><span class="annot"><span class="hs-number">60_000_000</span></span><span> </span><span class="hs-comment">-- 60s</span><span>
</span><span id="line-94"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-95"></span><span>    </span><span id="local-6989586621679325362"><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679325362"><span class="hs-identifier hs-var">request</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; IO Request
forall (m :: * -&gt; *). MonadThrow m =&gt; String -&gt; m Request
</span><span class="hs-identifier hs-var">parseRequest</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; IO Request) -&gt; String -&gt; IO Request
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679325360"><span class="hs-identifier hs-var">ep</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="hs-string">&quot;/api/v2/status&quot;</span></span><span>
</span><span id="line-96"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; IO ()
</span><span class="hs-identifier hs-var">putStrLn</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; IO ()) -&gt; String -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Fetching endpoint status from &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679325360"><span class="hs-identifier hs-var">ep</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="hs-string">&quot;...&quot;</span></span><span>
</span><span id="line-97"></span><span>    </span><span id="local-6989586621679325357"><span class="annot"><span class="annottext">StatusResponse
</span><a href="#local-6989586621679325357"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Request -&gt; Manager -&gt; IO (Response Blob)
</span><span class="hs-identifier hs-var">httpLbs</span></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679325362"><span class="hs-identifier hs-var">request</span></a></span><span> </span><span class="annot"><span class="annottext">Manager
</span><a href="#local-6989586621679325367"><span class="hs-identifier hs-var">manager</span></a></span><span> </span><span class="annot"><span class="annottext">IO (Response Blob) -&gt; (Response Blob -&gt; IO GenR) -&gt; IO GenR
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; Response Blob -&gt; IO GenR
Response Blob -&gt; IO GenR
</span><a href="IC.Test.Agent.html#okCBOR"><span class="hs-identifier hs-var">okCBOR</span></a></span><span> </span><span class="annot"><span class="annottext">IO GenR -&gt; (GenR -&gt; IO StatusResponse) -&gt; IO StatusResponse
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; GenR -&gt; IO StatusResponse
GenR -&gt; IO StatusResponse
</span><a href="IC.Test.Agent.html#statusResonse"><span class="hs-identifier hs-var">statusResonse</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-98"></span><span>        </span><span class="annot"><span class="annottext">IO StatusResponse
-&gt; (HUnitFailure -&gt; IO StatusResponse) -&gt; IO StatusResponse
forall e a. Exception e =&gt; IO a -&gt; (e -&gt; IO a) -&gt; IO a
</span><span class="hs-operator hs-var">`catch`</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HUnitFailure</span></span><span> </span><span class="hs-identifier">_</span><span> </span><span id="local-6989586621679325352"><span class="annot"><span class="annottext">r :: String
</span><a href="#local-6989586621679325352"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; IO ()
</span><span class="hs-identifier hs-var">putStrLn</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679325352"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO StatusResponse -&gt; IO StatusResponse
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">IO StatusResponse
forall a. IO a
</span><span class="hs-identifier hs-var">exitFailure</span></span><span class="hs-special">)</span><span>
</span><span id="line-99"></span><span>
</span><span id="line-100"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; IO ()
</span><span class="hs-identifier hs-var">putStrLn</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; IO ()) -&gt; String -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Spec version tested:  &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; String
</span><span class="hs-identifier hs-var">T.unpack</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="IC.Version.html#specVersion"><span class="hs-identifier hs-var">specVersion</span></a></span><span>
</span><span id="line-101"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; IO ()
</span><span class="hs-identifier hs-var">putStrLn</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; IO ()) -&gt; String -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Spec version claimed: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; String
</span><span class="hs-identifier hs-var">T.unpack</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StatusResponse -&gt; Text
</span><a href="IC.Test.Agent.html#status_api_version"><span class="hs-identifier hs-var hs-var">status_api_version</span></a></span><span> </span><span class="annot"><span class="annottext">StatusResponse
</span><a href="#local-6989586621679325357"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-102"></span><span>
</span><span id="line-103"></span><span>    </span><span class="annot"><span class="annottext">AgentConfig -&gt; IO AgentConfig
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">AgentConfig :: Blob -&gt; Manager -&gt; String -&gt; AgentConfig
</span><a href="IC.Test.Agent.html#AgentConfig"><span class="hs-identifier hs-type hs-type">AgentConfig</span></a></span><span>
</span><span id="line-104"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">tc_root_key :: Blob
</span><a href="IC.Test.Agent.html#tc_root_key"><span class="hs-identifier hs-var">tc_root_key</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StatusResponse -&gt; Blob
</span><a href="IC.Test.Agent.html#status_root_key"><span class="hs-identifier hs-var hs-var">status_root_key</span></a></span><span> </span><span class="annot"><span class="annottext">StatusResponse
</span><a href="#local-6989586621679325357"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-105"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tc_manager :: Manager
</span><a href="IC.Test.Agent.html#tc_manager"><span class="hs-identifier hs-var">tc_manager</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Manager
</span><a href="#local-6989586621679325367"><span class="hs-identifier hs-var">manager</span></a></span><span>
</span><span id="line-106"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tc_endPoint :: String
</span><a href="IC.Test.Agent.html#tc_endPoint"><span class="hs-identifier hs-var">tc_endPoint</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679325360"><span class="hs-identifier hs-var">ep</span></a></span><span>
</span><span id="line-107"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-108"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-109"></span><span>    </span><span class="hs-comment">-- strip trailing slash</span><span>
</span><span id="line-110"></span><span>    </span><span id="local-6989586621679325360"><span class="annot"><span class="annottext">ep :: String
</span><a href="#local-6989586621679325360"><span class="hs-identifier hs-var hs-var">ep</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">String -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679325368"><span class="hs-identifier hs-var">ep'</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; String
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="hs-string">&quot;empty endpoint&quot;</span></span><span>
</span><span id="line-111"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">String -&gt; Char
forall a. [a] -&gt; a
</span><span class="hs-identifier hs-var">last</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679325368"><span class="hs-identifier hs-var">ep'</span></a></span><span> </span><span class="annot"><span class="annottext">Char -&gt; Char -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="hs-char">'/'</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; String
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">init</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679325368"><span class="hs-identifier hs-var">ep'</span></a></span><span>
</span><span id="line-112"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679325368"><span class="hs-identifier hs-var">ep'</span></a></span><span>
</span><span id="line-113"></span><span>
</span><span id="line-114"></span><span class="annot"><a href="IC.Test.Agent.html#preFlight"><span class="hs-identifier hs-type">preFlight</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">OptionSet</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="IC.Test.Agent.html#AgentConfig"><span class="hs-identifier hs-type">AgentConfig</span></a></span><span>
</span><span id="line-115"></span><span id="preFlight"><span class="annot"><span class="annottext">preFlight :: OptionSet -&gt; IO AgentConfig
</span><a href="IC.Test.Agent.html#preFlight"><span class="hs-identifier hs-var hs-var">preFlight</span></a></span></span><span> </span><span id="local-6989586621679325340"><span class="annot"><span class="annottext">os :: OptionSet
</span><a href="#local-6989586621679325340"><span class="hs-identifier hs-var">os</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-116"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="IC.Test.Options.html#Endpoint"><span class="hs-identifier hs-type">Endpoint</span></a></span><span> </span><span id="local-6989586621679325338"><span class="annot"><span class="annottext">ep :: String
</span><a href="#local-6989586621679325338"><span class="hs-identifier hs-var">ep</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OptionSet -&gt; Endpoint
forall v. IsOption v =&gt; OptionSet -&gt; v
</span><span class="hs-identifier hs-var">lookupOption</span></span><span> </span><span class="annot"><span class="annottext">OptionSet
</span><a href="#local-6989586621679325340"><span class="hs-identifier hs-var">os</span></a></span><span>
</span><span id="line-117"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; IO AgentConfig
</span><a href="IC.Test.Agent.html#makeAgentConfig"><span class="hs-identifier hs-var">makeAgentConfig</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679325338"><span class="hs-identifier hs-var">ep</span></a></span><span>
</span><span id="line-118"></span><span>
</span><span id="line-119"></span><span>
</span><span id="line-120"></span><span class="hs-keyword">newtype</span><span> </span><span id="ReplWrapper"><span class="annot"><a href="IC.Test.Agent.html#ReplWrapper"><span class="hs-identifier hs-var">ReplWrapper</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="R"><span class="annot"><a href="IC.Test.Agent.html#R"><span class="hs-identifier hs-var">R</span></a></span></span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679325590"><span class="annot"><a href="#local-6989586621679325590"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Test.Agent.html#HasAgentConfig"><span class="hs-identifier hs-type">HasAgentConfig</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679325590"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679325590"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-121"></span><span>
</span><span id="line-122"></span><span class="hs-comment">-- |  This is for use from the Haskell REPL, see README.md</span><span>
</span><span id="line-123"></span><span class="annot"><a href="IC.Test.Agent.html#connect"><span class="hs-identifier hs-type">connect</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="IC.Test.Agent.html#ReplWrapper"><span class="hs-identifier hs-type">ReplWrapper</span></a></span><span>
</span><span id="line-124"></span><span id="connect"><span class="annot"><span class="annottext">connect :: String -&gt; IO ReplWrapper
</span><a href="IC.Test.Agent.html#connect"><span class="hs-identifier hs-var hs-var">connect</span></a></span></span><span> </span><span id="local-6989586621679325334"><span class="annot"><span class="annottext">ep :: String
</span><a href="#local-6989586621679325334"><span class="hs-identifier hs-var">ep</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-125"></span><span>    </span><span id="local-6989586621679325333"><span class="annot"><span class="annottext">AgentConfig
</span><a href="#local-6989586621679325333"><span class="hs-identifier hs-var">agentConfig</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; IO AgentConfig
</span><a href="IC.Test.Agent.html#makeAgentConfig"><span class="hs-identifier hs-var">makeAgentConfig</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679325334"><span class="hs-identifier hs-var">ep</span></a></span><span>
</span><span id="line-126"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="">?agentConfig</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">agentConfig</span><span>
</span><span id="line-127"></span><span>    </span><span class="annot"><span class="annottext">ReplWrapper -&gt; IO ReplWrapper
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(forall a. (HasAgentConfig =&gt; a) -&gt; a) -&gt; ReplWrapper
</span><a href="IC.Test.Agent.html#R"><span class="hs-identifier hs-var">R</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; a
forall a. (HasAgentConfig =&gt; a) -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span class="hs-special">)</span><span>
</span><span id="line-128"></span><span>
</span><span id="line-129"></span><span class="hs-comment">-- Yes, implicit arguments are frowned upon. But they are also very useful.</span><span>
</span><span id="line-130"></span><span>
</span><span id="line-131"></span><span class="hs-keyword">type</span><span> </span><span id="HasAgentConfig"><span class="annot"><a href="IC.Test.Agent.html#HasAgentConfig"><span class="hs-identifier hs-var">HasAgentConfig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="">?agentConfig</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#AgentConfig"><span class="hs-identifier hs-type">AgentConfig</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-132"></span><span>
</span><span id="line-133"></span><span id="local-6989586621679325331"><span class="annot"><a href="IC.Test.Agent.html#withAgentConfig"><span class="hs-identifier hs-type">withAgentConfig</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#HasAgentConfig"><span class="hs-identifier hs-type">HasAgentConfig</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679325331"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#AgentConfig"><span class="hs-identifier hs-type">AgentConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679325331"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-134"></span><span id="withAgentConfig"><span class="annot"><span class="annottext">withAgentConfig :: (HasAgentConfig =&gt; a) -&gt; AgentConfig -&gt; a
</span><a href="IC.Test.Agent.html#withAgentConfig"><span class="hs-identifier hs-var hs-var">withAgentConfig</span></a></span></span><span> </span><span id="local-6989586621679325329"><span class="annot"><span class="annottext">act :: HasAgentConfig =&gt; a
</span><a href="#local-6989586621679325329"><span class="hs-identifier hs-var">act</span></a></span></span><span> </span><span id="local-6989586621679325328"><span class="annot"><span class="annottext">tc :: AgentConfig
</span><a href="#local-6989586621679325328"><span class="hs-identifier hs-var">tc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="">?agentConfig</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tc</span><span> </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">a
HasAgentConfig =&gt; a
</span><a href="#local-6989586621679325329"><span class="hs-identifier hs-var">act</span></a></span><span>
</span><span id="line-135"></span><span>
</span><span id="line-136"></span><span class="annot"><a href="IC.Test.Agent.html#agentConfig"><span class="hs-identifier hs-type">agentConfig</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#HasAgentConfig"><span class="hs-identifier hs-type">HasAgentConfig</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#AgentConfig"><span class="hs-identifier hs-type">AgentConfig</span></a></span><span>
</span><span id="line-137"></span><span id="agentConfig"><span class="annot"><span class="annottext">agentConfig :: AgentConfig
</span><a href="IC.Test.Agent.html#agentConfig"><span class="hs-identifier hs-var hs-var">agentConfig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasAgentConfig
AgentConfig
</span><a href="#local-6989586621679325326"><span class="hs-var">?agentConfig</span></a></span><span>
</span><span id="line-138"></span><span>
</span><span id="line-139"></span><span class="annot"><a href="IC.Test.Agent.html#endPoint"><span class="hs-identifier hs-type">endPoint</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#HasAgentConfig"><span class="hs-identifier hs-type">HasAgentConfig</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-140"></span><span id="endPoint"><span class="annot"><span class="annottext">endPoint :: String
</span><a href="IC.Test.Agent.html#endPoint"><span class="hs-identifier hs-var hs-var">endPoint</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AgentConfig -&gt; String
</span><a href="IC.Test.Agent.html#tc_endPoint"><span class="hs-identifier hs-var hs-var">tc_endPoint</span></a></span><span> </span><span class="annot"><span class="annottext">AgentConfig
HasAgentConfig =&gt; AgentConfig
</span><a href="IC.Test.Agent.html#agentConfig"><span class="hs-identifier hs-var">agentConfig</span></a></span><span>
</span><span id="line-141"></span><span>
</span><span id="line-142"></span><span class="annot"><a href="IC.Test.Agent.html#agentManager"><span class="hs-identifier hs-type">agentManager</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#HasAgentConfig"><span class="hs-identifier hs-type">HasAgentConfig</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Manager</span></span><span>
</span><span id="line-143"></span><span id="agentManager"><span class="annot"><span class="annottext">agentManager :: Manager
</span><a href="IC.Test.Agent.html#agentManager"><span class="hs-identifier hs-var hs-var">agentManager</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AgentConfig -&gt; Manager
</span><a href="IC.Test.Agent.html#tc_manager"><span class="hs-identifier hs-var hs-var">tc_manager</span></a></span><span> </span><span class="annot"><span class="annottext">AgentConfig
HasAgentConfig =&gt; AgentConfig
</span><a href="IC.Test.Agent.html#agentConfig"><span class="hs-identifier hs-var">agentConfig</span></a></span><span>
</span><span id="line-144"></span><span>
</span><span id="line-145"></span><span>
</span><span id="line-146"></span><span class="hs-comment">-- * Test data for some hardcoded user names</span><span>
</span><span id="line-147"></span><span>
</span><span id="line-148"></span><span class="annot"><a href="IC.Test.Agent.html#doesn%27tExist"><span class="hs-identifier hs-type">doesn'tExist</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span>
</span><span id="line-149"></span><span id="doesn%27tExist"><span class="annot"><span class="annottext">doesn'tExist :: Blob
</span><a href="IC.Test.Agent.html#doesn%27tExist"><span class="hs-identifier hs-var hs-var">doesn'tExist</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-string">&quot;\xDE\xAD\xBE\xEF&quot;</span></span><span> </span><span class="hs-comment">-- hopefully no such canister/user exists</span><span>
</span><span id="line-150"></span><span>
</span><span id="line-151"></span><span class="annot"><a href="IC.Test.Agent.html#defaultSK"><span class="hs-identifier hs-type">defaultSK</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Crypto.html#SecretKey"><span class="hs-identifier hs-type">SecretKey</span></a></span><span>
</span><span id="line-152"></span><span id="defaultSK"><span class="annot"><span class="annottext">defaultSK :: SecretKey
</span><a href="IC.Test.Agent.html#defaultSK"><span class="hs-identifier hs-var hs-var">defaultSK</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Blob -&gt; SecretKey
</span><a href="IC.Crypto.html#createSecretKeyEd25519"><span class="hs-identifier hs-var">createSecretKeyEd25519</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;fixed32byteseedfortesting&quot;</span></span><span>
</span><span id="line-153"></span><span>
</span><span id="line-154"></span><span class="annot"><a href="IC.Test.Agent.html#otherSK"><span class="hs-identifier hs-type">otherSK</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Crypto.html#SecretKey"><span class="hs-identifier hs-type">SecretKey</span></a></span><span>
</span><span id="line-155"></span><span id="otherSK"><span class="annot"><span class="annottext">otherSK :: SecretKey
</span><a href="IC.Test.Agent.html#otherSK"><span class="hs-identifier hs-var hs-var">otherSK</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Blob -&gt; SecretKey
</span><a href="IC.Crypto.html#createSecretKeyEd25519"><span class="hs-identifier hs-var">createSecretKeyEd25519</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;anotherfixed32byteseedfortesting&quot;</span></span><span>
</span><span id="line-156"></span><span>
</span><span id="line-157"></span><span class="annot"><a href="IC.Test.Agent.html#webAuthnECDSASK"><span class="hs-identifier hs-type">webAuthnECDSASK</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Crypto.html#SecretKey"><span class="hs-identifier hs-type">SecretKey</span></a></span><span>
</span><span id="line-158"></span><span id="webAuthnECDSASK"><span class="annot"><span class="annottext">webAuthnECDSASK :: SecretKey
</span><a href="IC.Test.Agent.html#webAuthnECDSASK"><span class="hs-identifier hs-var hs-var">webAuthnECDSASK</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Blob -&gt; SecretKey
</span><a href="IC.Crypto.html#createSecretKeyWebAuthnECDSA"><span class="hs-identifier hs-var">createSecretKeyWebAuthnECDSA</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;webauthnseed&quot;</span></span><span>
</span><span id="line-159"></span><span>
</span><span id="line-160"></span><span class="annot"><a href="IC.Test.Agent.html#webAuthnRSASK"><span class="hs-identifier hs-type">webAuthnRSASK</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Crypto.html#SecretKey"><span class="hs-identifier hs-type">SecretKey</span></a></span><span>
</span><span id="line-161"></span><span id="webAuthnRSASK"><span class="annot"><span class="annottext">webAuthnRSASK :: SecretKey
</span><a href="IC.Test.Agent.html#webAuthnRSASK"><span class="hs-identifier hs-var hs-var">webAuthnRSASK</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Blob -&gt; SecretKey
</span><a href="IC.Crypto.html#createSecretKeyWebAuthnRSA"><span class="hs-identifier hs-var">createSecretKeyWebAuthnRSA</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;webauthnseed&quot;</span></span><span>
</span><span id="line-162"></span><span>
</span><span id="line-163"></span><span class="annot"><a href="IC.Test.Agent.html#ecdsaSK"><span class="hs-identifier hs-type">ecdsaSK</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Crypto.html#SecretKey"><span class="hs-identifier hs-type">SecretKey</span></a></span><span>
</span><span id="line-164"></span><span id="ecdsaSK"><span class="annot"><span class="annottext">ecdsaSK :: SecretKey
</span><a href="IC.Test.Agent.html#ecdsaSK"><span class="hs-identifier hs-var hs-var">ecdsaSK</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Blob -&gt; SecretKey
</span><a href="IC.Crypto.html#createSecretKeyECDSA"><span class="hs-identifier hs-var">createSecretKeyECDSA</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;ecdsaseed&quot;</span></span><span>
</span><span id="line-165"></span><span>
</span><span id="line-166"></span><span class="annot"><a href="IC.Test.Agent.html#secp256k1SK"><span class="hs-identifier hs-type">secp256k1SK</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Crypto.html#SecretKey"><span class="hs-identifier hs-type">SecretKey</span></a></span><span>
</span><span id="line-167"></span><span id="secp256k1SK"><span class="annot"><span class="annottext">secp256k1SK :: SecretKey
</span><a href="IC.Test.Agent.html#secp256k1SK"><span class="hs-identifier hs-var hs-var">secp256k1SK</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Blob -&gt; SecretKey
</span><a href="IC.Crypto.html#createSecretKeySecp256k1"><span class="hs-identifier hs-var">createSecretKeySecp256k1</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;secp256k1seed&quot;</span></span><span>
</span><span id="line-168"></span><span>
</span><span id="line-169"></span><span class="annot"><a href="IC.Test.Agent.html#defaultUser"><span class="hs-identifier hs-type">defaultUser</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span>
</span><span id="line-170"></span><span id="defaultUser"><span class="annot"><span class="annottext">defaultUser :: Blob
</span><a href="IC.Test.Agent.html#defaultUser"><span class="hs-identifier hs-var hs-var">defaultUser</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Blob -&gt; Blob
</span><a href="IC.Id.Forms.html#mkSelfAuthenticatingId"><span class="hs-identifier hs-var">mkSelfAuthenticatingId</span></a></span><span> </span><span class="annot"><span class="annottext">(Blob -&gt; Blob) -&gt; Blob -&gt; Blob
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SecretKey -&gt; Blob
</span><a href="IC.Crypto.html#toPublicKey"><span class="hs-identifier hs-var">toPublicKey</span></a></span><span> </span><span class="annot"><span class="annottext">SecretKey
</span><a href="IC.Test.Agent.html#defaultSK"><span class="hs-identifier hs-var">defaultSK</span></a></span><span>
</span><span id="line-171"></span><span class="annot"><a href="IC.Test.Agent.html#otherUser"><span class="hs-identifier hs-type">otherUser</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span>
</span><span id="line-172"></span><span id="otherUser"><span class="annot"><span class="annottext">otherUser :: Blob
</span><a href="IC.Test.Agent.html#otherUser"><span class="hs-identifier hs-var hs-var">otherUser</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Blob -&gt; Blob
</span><a href="IC.Id.Forms.html#mkSelfAuthenticatingId"><span class="hs-identifier hs-var">mkSelfAuthenticatingId</span></a></span><span> </span><span class="annot"><span class="annottext">(Blob -&gt; Blob) -&gt; Blob -&gt; Blob
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SecretKey -&gt; Blob
</span><a href="IC.Crypto.html#toPublicKey"><span class="hs-identifier hs-var">toPublicKey</span></a></span><span> </span><span class="annot"><span class="annottext">SecretKey
</span><a href="IC.Test.Agent.html#otherSK"><span class="hs-identifier hs-var">otherSK</span></a></span><span>
</span><span id="line-173"></span><span class="annot"><a href="IC.Test.Agent.html#webAuthnECDSAUser"><span class="hs-identifier hs-type">webAuthnECDSAUser</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span>
</span><span id="line-174"></span><span id="webAuthnECDSAUser"><span class="annot"><span class="annottext">webAuthnECDSAUser :: Blob
</span><a href="IC.Test.Agent.html#webAuthnECDSAUser"><span class="hs-identifier hs-var hs-var">webAuthnECDSAUser</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Blob -&gt; Blob
</span><a href="IC.Id.Forms.html#mkSelfAuthenticatingId"><span class="hs-identifier hs-var">mkSelfAuthenticatingId</span></a></span><span> </span><span class="annot"><span class="annottext">(Blob -&gt; Blob) -&gt; Blob -&gt; Blob
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SecretKey -&gt; Blob
</span><a href="IC.Crypto.html#toPublicKey"><span class="hs-identifier hs-var">toPublicKey</span></a></span><span> </span><span class="annot"><span class="annottext">SecretKey
</span><a href="IC.Test.Agent.html#webAuthnECDSASK"><span class="hs-identifier hs-var">webAuthnECDSASK</span></a></span><span>
</span><span id="line-175"></span><span class="annot"><a href="IC.Test.Agent.html#webAuthnRSAUser"><span class="hs-identifier hs-type">webAuthnRSAUser</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span>
</span><span id="line-176"></span><span id="webAuthnRSAUser"><span class="annot"><span class="annottext">webAuthnRSAUser :: Blob
</span><a href="IC.Test.Agent.html#webAuthnRSAUser"><span class="hs-identifier hs-var hs-var">webAuthnRSAUser</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Blob -&gt; Blob
</span><a href="IC.Id.Forms.html#mkSelfAuthenticatingId"><span class="hs-identifier hs-var">mkSelfAuthenticatingId</span></a></span><span> </span><span class="annot"><span class="annottext">(Blob -&gt; Blob) -&gt; Blob -&gt; Blob
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SecretKey -&gt; Blob
</span><a href="IC.Crypto.html#toPublicKey"><span class="hs-identifier hs-var">toPublicKey</span></a></span><span> </span><span class="annot"><span class="annottext">SecretKey
</span><a href="IC.Test.Agent.html#webAuthnRSASK"><span class="hs-identifier hs-var">webAuthnRSASK</span></a></span><span>
</span><span id="line-177"></span><span class="annot"><a href="IC.Test.Agent.html#ecdsaUser"><span class="hs-identifier hs-type">ecdsaUser</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span>
</span><span id="line-178"></span><span id="ecdsaUser"><span class="annot"><span class="annottext">ecdsaUser :: Blob
</span><a href="IC.Test.Agent.html#ecdsaUser"><span class="hs-identifier hs-var hs-var">ecdsaUser</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Blob -&gt; Blob
</span><a href="IC.Id.Forms.html#mkSelfAuthenticatingId"><span class="hs-identifier hs-var">mkSelfAuthenticatingId</span></a></span><span> </span><span class="annot"><span class="annottext">(Blob -&gt; Blob) -&gt; Blob -&gt; Blob
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SecretKey -&gt; Blob
</span><a href="IC.Crypto.html#toPublicKey"><span class="hs-identifier hs-var">toPublicKey</span></a></span><span> </span><span class="annot"><span class="annottext">SecretKey
</span><a href="IC.Test.Agent.html#ecdsaSK"><span class="hs-identifier hs-var">ecdsaSK</span></a></span><span>
</span><span id="line-179"></span><span class="annot"><a href="IC.Test.Agent.html#secp256k1User"><span class="hs-identifier hs-type">secp256k1User</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span>
</span><span id="line-180"></span><span id="secp256k1User"><span class="annot"><span class="annottext">secp256k1User :: Blob
</span><a href="IC.Test.Agent.html#secp256k1User"><span class="hs-identifier hs-var hs-var">secp256k1User</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Blob -&gt; Blob
</span><a href="IC.Id.Forms.html#mkSelfAuthenticatingId"><span class="hs-identifier hs-var">mkSelfAuthenticatingId</span></a></span><span> </span><span class="annot"><span class="annottext">(Blob -&gt; Blob) -&gt; Blob -&gt; Blob
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SecretKey -&gt; Blob
</span><a href="IC.Crypto.html#toPublicKey"><span class="hs-identifier hs-var">toPublicKey</span></a></span><span> </span><span class="annot"><span class="annottext">SecretKey
</span><a href="IC.Test.Agent.html#secp256k1SK"><span class="hs-identifier hs-var">secp256k1SK</span></a></span><span>
</span><span id="line-181"></span><span>
</span><span id="line-182"></span><span class="annot"><a href="IC.Test.Agent.html#anonymousUser"><span class="hs-identifier hs-type">anonymousUser</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span>
</span><span id="line-183"></span><span id="anonymousUser"><span class="annot"><span class="annottext">anonymousUser :: Blob
</span><a href="IC.Test.Agent.html#anonymousUser"><span class="hs-identifier hs-var hs-var">anonymousUser</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-string">&quot;\x04&quot;</span></span><span>
</span><span id="line-184"></span><span>
</span><span id="line-185"></span><span class="hs-comment">-- * Request envelopes</span><span>
</span><span id="line-186"></span><span>
</span><span id="line-187"></span><span id="local-6989586621679325579"><span class="annot"><a href="IC.Test.Agent.html#addIfNotThere"><span class="hs-identifier hs-type">addIfNotThere</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679325579"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">T.Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679325579"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="IC.HTTP.GenR.html#GenR"><span class="hs-identifier hs-type">GenR</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.HTTP.GenR.html#GenR"><span class="hs-identifier hs-type">GenR</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679325579"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="IC.HTTP.GenR.html#GenR"><span class="hs-identifier hs-type">GenR</span></a></span></span><span>
</span><span id="line-188"></span><span id="addIfNotThere"><span class="annot"><span class="annottext">addIfNotThere :: Text -&gt; m GenR -&gt; GenR -&gt; m GenR
</span><a href="IC.Test.Agent.html#addIfNotThere"><span class="hs-identifier hs-var hs-var">addIfNotThere</span></a></span></span><span> </span><span id="local-6989586621679325301"><span class="annot"><span class="annottext">f :: Text
</span><a href="#local-6989586621679325301"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.HTTP.GenR.html#GRec"><span class="hs-identifier hs-type">GRec</span></a></span><span> </span><span id="local-6989586621679325299"><span class="annot"><span class="annottext">hm :: HashMap Text GenR
</span><a href="#local-6989586621679325299"><span class="hs-identifier hs-var">hm</span></a></span></span><span class="hs-special">)</span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679325301"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; HashMap Text GenR -&gt; Bool
forall k a. (Eq k, Hashable k) =&gt; k -&gt; HashMap k a -&gt; Bool
</span><span class="hs-operator hs-var">`HM.member`</span></span><span> </span><span class="annot"><span class="annottext">HashMap Text GenR
</span><a href="#local-6989586621679325299"><span class="hs-identifier hs-var">hm</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">GenR -&gt; m GenR
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashMap Text GenR -&gt; GenR
</span><a href="IC.HTTP.GenR.html#GRec"><span class="hs-identifier hs-var">GRec</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap Text GenR
</span><a href="#local-6989586621679325299"><span class="hs-identifier hs-var">hm</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-189"></span><span class="annot"><a href="IC.Test.Agent.html#addIfNotThere"><span class="hs-identifier hs-var">addIfNotThere</span></a></span><span> </span><span id="local-6989586621679325297"><span class="annot"><span class="annottext">f :: Text
</span><a href="#local-6989586621679325297"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621679325296"><span class="annot"><span class="annottext">a :: m GenR
</span><a href="#local-6989586621679325296"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.HTTP.GenR.html#GRec"><span class="hs-identifier hs-type">GRec</span></a></span><span> </span><span id="local-6989586621679325295"><span class="annot"><span class="annottext">hm :: HashMap Text GenR
</span><a href="#local-6989586621679325295"><span class="hs-identifier hs-var">hm</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-190"></span><span>  </span><span id="local-6989586621679325294"><span class="annot"><span class="annottext">GenR
</span><a href="#local-6989586621679325294"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m GenR
</span><a href="#local-6989586621679325296"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-191"></span><span>  </span><span class="annot"><span class="annottext">GenR -&gt; m GenR
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(GenR -&gt; m GenR) -&gt; GenR -&gt; m GenR
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HashMap Text GenR -&gt; GenR
</span><a href="IC.HTTP.GenR.html#GRec"><span class="hs-identifier hs-var">GRec</span></a></span><span> </span><span class="annot"><span class="annottext">(HashMap Text GenR -&gt; GenR) -&gt; HashMap Text GenR -&gt; GenR
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; GenR -&gt; HashMap Text GenR -&gt; HashMap Text GenR
forall k v.
(Eq k, Hashable k) =&gt;
k -&gt; v -&gt; HashMap k v -&gt; HashMap k v
</span><span class="hs-identifier hs-var">HM.insert</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679325297"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">GenR
</span><a href="#local-6989586621679325294"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap Text GenR
</span><a href="#local-6989586621679325295"><span class="hs-identifier hs-var">hm</span></a></span><span>
</span><span id="line-192"></span><span class="annot"><a href="IC.Test.Agent.html#addIfNotThere"><span class="hs-identifier hs-var">addIfNotThere</span></a></span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; m GenR
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="hs-string">&quot;addIfNotThere: not a record&quot;</span></span><span>
</span><span id="line-193"></span><span>
</span><span id="line-194"></span><span class="annot"><a href="IC.Test.Agent.html#addNonce"><span class="hs-identifier hs-type">addNonce</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.HTTP.GenR.html#GenR"><span class="hs-identifier hs-type">GenR</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="IC.HTTP.GenR.html#GenR"><span class="hs-identifier hs-type">GenR</span></a></span><span>
</span><span id="line-195"></span><span id="addNonce"><span class="annot"><span class="annottext">addNonce :: GenR -&gt; IO GenR
</span><a href="IC.Test.Agent.html#addNonce"><span class="hs-identifier hs-var hs-var">addNonce</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; IO GenR -&gt; GenR -&gt; IO GenR
forall (m :: * -&gt; *). Monad m =&gt; Text -&gt; m GenR -&gt; GenR -&gt; m GenR
</span><a href="IC.Test.Agent.html#addIfNotThere"><span class="hs-identifier hs-var">addIfNotThere</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;nonce&quot;</span></span><span> </span><span class="annot"><span class="annottext">(IO GenR -&gt; GenR -&gt; IO GenR) -&gt; IO GenR -&gt; GenR -&gt; IO GenR
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-196"></span><span>    </span><span class="annot"><span class="annottext">Blob -&gt; GenR
</span><a href="IC.HTTP.GenR.html#GBlob"><span class="hs-identifier hs-var">GBlob</span></a></span><span> </span><span class="annot"><span class="annottext">(Blob -&gt; GenR) -&gt; IO Blob -&gt; IO GenR
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">IO Blob
</span><a href="IC.Test.Agent.html#getRand8Bytes"><span class="hs-identifier hs-var">getRand8Bytes</span></a></span><span>
</span><span id="line-197"></span><span>
</span><span id="line-198"></span><span class="annot"><a href="IC.Test.Agent.html#getRand8Bytes"><span class="hs-identifier hs-type">getRand8Bytes</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">BS.ByteString</span></span><span>
</span><span id="line-199"></span><span id="getRand8Bytes"><span class="annot"><span class="annottext">getRand8Bytes :: IO Blob
</span><a href="IC.Test.Agent.html#getRand8Bytes"><span class="hs-identifier hs-var hs-var">getRand8Bytes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Word8] -&gt; Blob
</span><span class="hs-identifier hs-var">BS.pack</span></span><span> </span><span class="annot"><span class="annottext">([Word8] -&gt; Blob) -&gt; IO [Word8] -&gt; IO Blob
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; IO Word8 -&gt; IO [Word8]
forall (m :: * -&gt; *) a. Applicative m =&gt; Int -&gt; m a -&gt; m [a]
</span><span class="hs-identifier hs-var">replicateM</span></span><span> </span><span class="annot"><span class="hs-number">8</span></span><span> </span><span class="annot"><span class="annottext">IO Word8
forall a (m :: * -&gt; *). (Random a, MonadIO m) =&gt; m a
</span><span class="hs-identifier hs-var">randomIO</span></span><span>
</span><span id="line-200"></span><span>
</span><span id="line-201"></span><span class="hs-comment">-- Adds expiry 1 minute</span><span>
</span><span id="line-202"></span><span class="annot"><a href="IC.Test.Agent.html#addExpiry"><span class="hs-identifier hs-type">addExpiry</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.HTTP.GenR.html#GenR"><span class="hs-identifier hs-type">GenR</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="IC.HTTP.GenR.html#GenR"><span class="hs-identifier hs-type">GenR</span></a></span><span>
</span><span id="line-203"></span><span id="addExpiry"><span class="annot"><span class="annottext">addExpiry :: GenR -&gt; IO GenR
</span><a href="IC.Test.Agent.html#addExpiry"><span class="hs-identifier hs-var hs-var">addExpiry</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; IO GenR -&gt; GenR -&gt; IO GenR
forall (m :: * -&gt; *). Monad m =&gt; Text -&gt; m GenR -&gt; GenR -&gt; m GenR
</span><a href="IC.Test.Agent.html#addIfNotThere"><span class="hs-identifier hs-var">addIfNotThere</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;ingress_expiry&quot;</span></span><span> </span><span class="annot"><span class="annottext">(IO GenR -&gt; GenR -&gt; IO GenR) -&gt; IO GenR -&gt; GenR -&gt; IO GenR
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-204"></span><span>    </span><span id="local-6989586621679325283"><span class="annot"><span class="annottext">POSIXTime
</span><a href="#local-6989586621679325283"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO POSIXTime
</span><span class="hs-identifier hs-var">getPOSIXTime</span></span><span>
</span><span id="line-205"></span><span>    </span><span class="annot"><span class="annottext">GenR -&gt; IO GenR
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(GenR -&gt; IO GenR) -&gt; GenR -&gt; IO GenR
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; GenR
</span><a href="IC.HTTP.GenR.html#GNat"><span class="hs-identifier hs-var">GNat</span></a></span><span> </span><span class="annot"><span class="annottext">(Natural -&gt; GenR) -&gt; Natural -&gt; GenR
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">POSIXTime -&gt; Natural
forall a b. (RealFrac a, Integral b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">round</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">POSIXTime
</span><a href="#local-6989586621679325283"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">POSIXTime -&gt; POSIXTime -&gt; POSIXTime
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="hs-number">60</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">POSIXTime -&gt; POSIXTime -&gt; POSIXTime
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="hs-number">1000_000_000</span></span><span class="hs-special">)</span><span>
</span><span id="line-206"></span><span>
</span><span id="line-207"></span><span class="annot"><a href="IC.Test.Agent.html#envelope"><span class="hs-identifier hs-type">envelope</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Crypto.html#SecretKey"><span class="hs-identifier hs-type">SecretKey</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.HTTP.GenR.html#GenR"><span class="hs-identifier hs-type">GenR</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="IC.HTTP.GenR.html#GenR"><span class="hs-identifier hs-type">GenR</span></a></span><span>
</span><span id="line-208"></span><span id="envelope"><span class="annot"><span class="annottext">envelope :: SecretKey -&gt; GenR -&gt; IO GenR
</span><a href="IC.Test.Agent.html#envelope"><span class="hs-identifier hs-var hs-var">envelope</span></a></span></span><span> </span><span id="local-6989586621679325276"><span class="annot"><span class="annottext">sk :: SecretKey
</span><a href="#local-6989586621679325276"><span class="hs-identifier hs-var">sk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SecretKey -&gt; [(SecretKey, Maybe [Blob])] -&gt; GenR -&gt; IO GenR
</span><a href="IC.Test.Agent.html#delegationEnv"><span class="hs-identifier hs-var">delegationEnv</span></a></span><span> </span><span class="annot"><span class="annottext">SecretKey
</span><a href="#local-6989586621679325276"><span class="hs-identifier hs-var">sk</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-209"></span><span>
</span><span id="line-210"></span><span class="annot"><a href="IC.Test.Agent.html#delegationEnv"><span class="hs-identifier hs-type">delegationEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Crypto.html#SecretKey"><span class="hs-identifier hs-type">SecretKey</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="IC.Crypto.html#SecretKey"><span class="hs-identifier hs-type">SecretKey</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.HTTP.GenR.html#GenR"><span class="hs-identifier hs-type">GenR</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="IC.HTTP.GenR.html#GenR"><span class="hs-identifier hs-type">GenR</span></a></span><span>
</span><span id="line-211"></span><span id="delegationEnv"><span class="annot"><span class="annottext">delegationEnv :: SecretKey -&gt; [(SecretKey, Maybe [Blob])] -&gt; GenR -&gt; IO GenR
</span><a href="IC.Test.Agent.html#delegationEnv"><span class="hs-identifier hs-var hs-var">delegationEnv</span></a></span></span><span> </span><span id="local-6989586621679325274"><span class="annot"><span class="annottext">sk1 :: SecretKey
</span><a href="#local-6989586621679325274"><span class="hs-identifier hs-var">sk1</span></a></span></span><span> </span><span id="local-6989586621679325273"><span class="annot"><span class="annottext">dels :: [(SecretKey, Maybe [Blob])]
</span><a href="#local-6989586621679325273"><span class="hs-identifier hs-var">dels</span></a></span></span><span> </span><span id="local-6989586621679325272"><span class="annot"><span class="annottext">content :: GenR
</span><a href="#local-6989586621679325272"><span class="hs-identifier hs-var">content</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-212"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679325271"><span class="annot"><span class="annottext">sks :: [SecretKey]
</span><a href="#local-6989586621679325271"><span class="hs-identifier hs-var hs-var">sks</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SecretKey
</span><a href="#local-6989586621679325274"><span class="hs-identifier hs-var">sk1</span></a></span><span> </span><span class="annot"><span class="annottext">SecretKey -&gt; [SecretKey] -&gt; [SecretKey]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">((SecretKey, Maybe [Blob]) -&gt; SecretKey)
-&gt; [(SecretKey, Maybe [Blob])] -&gt; [SecretKey]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(SecretKey, Maybe [Blob]) -&gt; SecretKey
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">[(SecretKey, Maybe [Blob])]
</span><a href="#local-6989586621679325273"><span class="hs-identifier hs-var">dels</span></a></span><span>
</span><span id="line-213"></span><span>
</span><span id="line-214"></span><span>    </span><span id="local-6989586621679325270"><span class="annot"><span class="annottext">POSIXTime
</span><a href="#local-6989586621679325270"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO POSIXTime
</span><span class="hs-identifier hs-var">getPOSIXTime</span></span><span>
</span><span id="line-215"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679325269"><span class="annot"><span class="annottext">expiry :: Natural
</span><a href="#local-6989586621679325269"><span class="hs-identifier hs-var hs-var">expiry</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">POSIXTime -&gt; Natural
forall a b. (RealFrac a, Integral b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">round</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">POSIXTime
</span><a href="#local-6989586621679325270"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">POSIXTime -&gt; POSIXTime -&gt; POSIXTime
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="hs-number">60</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">POSIXTime -&gt; POSIXTime -&gt; POSIXTime
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="hs-number">1000_000_000</span></span><span class="hs-special">)</span><span>
</span><span id="line-216"></span><span>    </span><span id="local-6989586621679325268"><span class="annot"><span class="annottext">[GenR]
</span><a href="#local-6989586621679325268"><span class="hs-identifier hs-var">delegations</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(SecretKey, (SecretKey, Maybe [Blob]))]
-&gt; ((SecretKey, (SecretKey, Maybe [Blob])) -&gt; IO GenR) -&gt; IO [GenR]
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f (t b)
</span><span class="hs-identifier hs-var">for</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SecretKey]
-&gt; [(SecretKey, Maybe [Blob])]
-&gt; [(SecretKey, (SecretKey, Maybe [Blob]))]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[SecretKey]
</span><a href="#local-6989586621679325271"><span class="hs-identifier hs-var">sks</span></a></span><span> </span><span class="annot"><span class="annottext">[(SecretKey, Maybe [Blob])]
</span><a href="#local-6989586621679325273"><span class="hs-identifier hs-var">dels</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((SecretKey, (SecretKey, Maybe [Blob])) -&gt; IO GenR) -&gt; IO [GenR])
-&gt; ((SecretKey, (SecretKey, Maybe [Blob])) -&gt; IO GenR) -&gt; IO [GenR]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679325266"><span class="annot"><span class="annottext">sk1 :: SecretKey
</span><a href="#local-6989586621679325266"><span class="hs-identifier hs-var">sk1</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679325265"><span class="annot"><span class="annottext">sk2 :: SecretKey
</span><a href="#local-6989586621679325265"><span class="hs-identifier hs-var">sk2</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679325264"><span class="annot"><span class="annottext">targets :: Maybe [Blob]
</span><a href="#local-6989586621679325264"><span class="hs-identifier hs-var">targets</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-217"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679325263"><span class="annot"><span class="annottext">delegation :: GenR
</span><a href="#local-6989586621679325263"><span class="hs-identifier hs-var hs-var">delegation</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[HashMap Text GenR] -&gt; GenR
</span><a href="IC.HTTP.GenR.html#rec"><span class="hs-identifier hs-var">rec</span></a></span><span> </span><span class="annot"><span class="annottext">([HashMap Text GenR] -&gt; GenR) -&gt; [HashMap Text GenR] -&gt; GenR
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-218"></span><span>            </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="hs-string">&quot;pubkey&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; GenR -&gt; HashMap Text GenR
forall v. Text -&gt; v -&gt; HashMap Text v
</span><a href="IC.HTTP.GenR.html#%3D%3A"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; GenR
</span><a href="IC.HTTP.GenR.html#GBlob"><span class="hs-identifier hs-var">GBlob</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SecretKey -&gt; Blob
</span><a href="IC.Crypto.html#toPublicKey"><span class="hs-identifier hs-var">toPublicKey</span></a></span><span> </span><span class="annot"><span class="annottext">SecretKey
</span><a href="#local-6989586621679325265"><span class="hs-identifier hs-var">sk2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-219"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;expiration&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; GenR -&gt; HashMap Text GenR
forall v. Text -&gt; v -&gt; HashMap Text v
</span><a href="IC.HTTP.GenR.html#%3D%3A"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; GenR
</span><a href="IC.HTTP.GenR.html#GNat"><span class="hs-identifier hs-var">GNat</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679325269"><span class="hs-identifier hs-var">expiry</span></a></span><span>
</span><span id="line-220"></span><span>            </span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[HashMap Text GenR] -&gt; [HashMap Text GenR] -&gt; [HashMap Text GenR]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span>
</span><span id="line-221"></span><span>            </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="hs-string">&quot;targets&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; GenR -&gt; HashMap Text GenR
forall v. Text -&gt; v -&gt; HashMap Text v
</span><a href="IC.HTTP.GenR.html#%3D%3A"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">[GenR] -&gt; GenR
</span><a href="IC.HTTP.GenR.html#GList"><span class="hs-identifier hs-var">GList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Blob -&gt; GenR) -&gt; [Blob] -&gt; [GenR]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; GenR
</span><a href="IC.HTTP.GenR.html#GBlob"><span class="hs-identifier hs-var">GBlob</span></a></span><span> </span><span class="annot"><span class="annottext">[Blob]
</span><a href="#local-6989586621679325259"><span class="hs-identifier hs-var">ts</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679325259"><span class="annot"><span class="annottext">ts :: [Blob]
</span><a href="#local-6989586621679325259"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe [Blob] -&gt; [Maybe [Blob]]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Maybe [Blob]
</span><a href="#local-6989586621679325264"><span class="hs-identifier hs-var">targets</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-222"></span><span>      </span><span id="local-6989586621679325258"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679325258"><span class="hs-identifier hs-var">sig</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Blob -&gt; SecretKey -&gt; Blob -&gt; IO Blob
</span><a href="IC.Crypto.html#sign"><span class="hs-identifier hs-var">sign</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;ic-request-auth-delegation&quot;</span></span><span> </span><span class="annot"><span class="annottext">SecretKey
</span><a href="#local-6989586621679325266"><span class="hs-identifier hs-var">sk1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">GenR -&gt; Blob
</span><a href="IC.HTTP.RequestId.html#requestId"><span class="hs-identifier hs-var">requestId</span></a></span><span> </span><span class="annot"><span class="annottext">GenR
</span><a href="#local-6989586621679325263"><span class="hs-identifier hs-var">delegation</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-223"></span><span>      </span><span class="annot"><span class="annottext">GenR -&gt; IO GenR
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(GenR -&gt; IO GenR) -&gt; GenR -&gt; IO GenR
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[HashMap Text GenR] -&gt; GenR
</span><a href="IC.HTTP.GenR.html#rec"><span class="hs-identifier hs-var">rec</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="hs-string">&quot;delegation&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; GenR -&gt; HashMap Text GenR
forall v. Text -&gt; v -&gt; HashMap Text v
</span><a href="IC.HTTP.GenR.html#%3D%3A"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">GenR
</span><a href="#local-6989586621679325263"><span class="hs-identifier hs-var">delegation</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;signature&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; GenR -&gt; HashMap Text GenR
forall v. Text -&gt; v -&gt; HashMap Text v
</span><a href="IC.HTTP.GenR.html#%3D%3A"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; GenR
</span><a href="IC.HTTP.GenR.html#GBlob"><span class="hs-identifier hs-var">GBlob</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679325258"><span class="hs-identifier hs-var">sig</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-224"></span><span>    </span><span id="local-6989586621679325255"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679325255"><span class="hs-identifier hs-var">sig</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Blob -&gt; SecretKey -&gt; Blob -&gt; IO Blob
</span><a href="IC.Crypto.html#sign"><span class="hs-identifier hs-var">sign</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;ic-request&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SecretKey] -&gt; SecretKey
forall a. [a] -&gt; a
</span><span class="hs-identifier hs-var">last</span></span><span> </span><span class="annot"><span class="annottext">[SecretKey]
</span><a href="#local-6989586621679325271"><span class="hs-identifier hs-var">sks</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">GenR -&gt; Blob
</span><a href="IC.HTTP.RequestId.html#requestId"><span class="hs-identifier hs-var">requestId</span></a></span><span> </span><span class="annot"><span class="annottext">GenR
</span><a href="#local-6989586621679325272"><span class="hs-identifier hs-var">content</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-225"></span><span>    </span><span class="annot"><span class="annottext">GenR -&gt; IO GenR
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(GenR -&gt; IO GenR) -&gt; GenR -&gt; IO GenR
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[HashMap Text GenR] -&gt; GenR
</span><a href="IC.HTTP.GenR.html#rec"><span class="hs-identifier hs-var">rec</span></a></span><span> </span><span class="annot"><span class="annottext">([HashMap Text GenR] -&gt; GenR) -&gt; [HashMap Text GenR] -&gt; GenR
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-226"></span><span>      </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="hs-string">&quot;sender_pubkey&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; GenR -&gt; HashMap Text GenR
forall v. Text -&gt; v -&gt; HashMap Text v
</span><a href="IC.HTTP.GenR.html#%3D%3A"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; GenR
</span><a href="IC.HTTP.GenR.html#GBlob"><span class="hs-identifier hs-var">GBlob</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SecretKey -&gt; Blob
</span><a href="IC.Crypto.html#toPublicKey"><span class="hs-identifier hs-var">toPublicKey</span></a></span><span> </span><span class="annot"><span class="annottext">SecretKey
</span><a href="#local-6989586621679325274"><span class="hs-identifier hs-var">sk1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-227"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;sender_sig&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; GenR -&gt; HashMap Text GenR
forall v. Text -&gt; v -&gt; HashMap Text v
</span><a href="IC.HTTP.GenR.html#%3D%3A"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; GenR
</span><a href="IC.HTTP.GenR.html#GBlob"><span class="hs-identifier hs-var">GBlob</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679325255"><span class="hs-identifier hs-var">sig</span></a></span><span>
</span><span id="line-228"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;content&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; GenR -&gt; HashMap Text GenR
forall v. Text -&gt; v -&gt; HashMap Text v
</span><a href="IC.HTTP.GenR.html#%3D%3A"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">GenR
</span><a href="#local-6989586621679325272"><span class="hs-identifier hs-var">content</span></a></span><span>
</span><span id="line-229"></span><span>      </span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[HashMap Text GenR] -&gt; [HashMap Text GenR] -&gt; [HashMap Text GenR]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span>
</span><span id="line-230"></span><span>      </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="hs-string">&quot;sender_delegation&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; GenR -&gt; HashMap Text GenR
forall v. Text -&gt; v -&gt; HashMap Text v
</span><a href="IC.HTTP.GenR.html#%3D%3A"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">[GenR] -&gt; GenR
</span><a href="IC.HTTP.GenR.html#GList"><span class="hs-identifier hs-var">GList</span></a></span><span> </span><span class="annot"><span class="annottext">[GenR]
</span><a href="#local-6989586621679325268"><span class="hs-identifier hs-var">delegations</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[GenR] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[GenR]
</span><a href="#local-6989586621679325268"><span class="hs-identifier hs-var">delegations</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-231"></span><span>
</span><span id="line-232"></span><span class="hs-comment">-- a little bit of smartness in our combinators: Adding correct envelope, nonce</span><span>
</span><span id="line-233"></span><span class="hs-comment">-- and expiry if it is not already there</span><span>
</span><span id="line-234"></span><span>
</span><span id="line-235"></span><span class="annot"><a href="IC.Test.Agent.html#senderOf"><span class="hs-identifier hs-type">senderOf</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.HTTP.GenR.html#GenR"><span class="hs-identifier hs-type">GenR</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span>
</span><span id="line-236"></span><span id="senderOf"><span class="annot"><span class="annottext">senderOf :: GenR -&gt; Blob
</span><a href="IC.Test.Agent.html#senderOf"><span class="hs-identifier hs-var hs-var">senderOf</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.HTTP.GenR.html#GRec"><span class="hs-identifier hs-type">GRec</span></a></span><span> </span><span id="local-6989586621679325252"><span class="annot"><span class="annottext">hm :: HashMap Text GenR
</span><a href="#local-6989586621679325252"><span class="hs-identifier hs-var">hm</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.HTTP.GenR.html#GBlob"><span class="hs-identifier hs-type">GBlob</span></a></span><span> </span><span id="local-6989586621679325251"><span class="annot"><span class="annottext">id :: Blob
</span><a href="#local-6989586621679325251"><span class="hs-identifier hs-var">id</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Text -&gt; HashMap Text GenR -&gt; Maybe GenR
forall k v. (Eq k, Hashable k) =&gt; k -&gt; HashMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">HM.lookup</span></span><span> </span><span class="annot"><span class="hs-string">&quot;sender&quot;</span></span><span> </span><span class="annot"><span class="annottext">HashMap Text GenR
</span><a href="#local-6989586621679325252"><span class="hs-identifier hs-var">hm</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679325251"><span class="hs-identifier hs-var">id</span></a></span><span>
</span><span id="line-237"></span><span class="annot"><a href="IC.Test.Agent.html#senderOf"><span class="hs-identifier hs-var">senderOf</span></a></span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="IC.Test.Agent.html#anonymousUser"><span class="hs-identifier hs-var">anonymousUser</span></a></span><span>
</span><span id="line-238"></span><span>
</span><span id="line-239"></span><span class="annot"><a href="IC.Test.Agent.html#addNonceExpiryEnv"><span class="hs-identifier hs-type">addNonceExpiryEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.HTTP.GenR.html#GenR"><span class="hs-identifier hs-type">GenR</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="IC.HTTP.GenR.html#GenR"><span class="hs-identifier hs-type">GenR</span></a></span><span>
</span><span id="line-240"></span><span id="addNonceExpiryEnv"><span class="annot"><span class="annottext">addNonceExpiryEnv :: GenR -&gt; IO GenR
</span><a href="IC.Test.Agent.html#addNonceExpiryEnv"><span class="hs-identifier hs-var hs-var">addNonceExpiryEnv</span></a></span></span><span> </span><span id="local-6989586621679325248"><span class="annot"><span class="annottext">req :: GenR
</span><a href="#local-6989586621679325248"><span class="hs-identifier hs-var">req</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-241"></span><span>  </span><span class="annot"><span class="annottext">GenR -&gt; IO GenR
</span><a href="IC.Test.Agent.html#addNonce"><span class="hs-identifier hs-var">addNonce</span></a></span><span> </span><span class="annot"><span class="annottext">GenR
</span><a href="#local-6989586621679325248"><span class="hs-identifier hs-var">req</span></a></span><span> </span><span class="annot"><span class="annottext">IO GenR -&gt; (GenR -&gt; IO GenR) -&gt; IO GenR
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">GenR -&gt; IO GenR
</span><a href="IC.Test.Agent.html#addExpiry"><span class="hs-identifier hs-var">addExpiry</span></a></span><span> </span><span class="annot"><span class="annottext">IO GenR -&gt; (GenR -&gt; IO GenR) -&gt; IO GenR
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; GenR -&gt; IO GenR
</span><a href="IC.Test.Agent.html#envelopeFor"><span class="hs-identifier hs-var">envelopeFor</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">GenR -&gt; Blob
</span><a href="IC.Test.Agent.html#senderOf"><span class="hs-identifier hs-var">senderOf</span></a></span><span> </span><span class="annot"><span class="annottext">GenR
</span><a href="#local-6989586621679325248"><span class="hs-identifier hs-var">req</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-242"></span><span>
</span><span id="line-243"></span><span class="annot"><a href="IC.Test.Agent.html#envelopeFor"><span class="hs-identifier hs-type">envelopeFor</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.HTTP.GenR.html#GenR"><span class="hs-identifier hs-type">GenR</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="IC.HTTP.GenR.html#GenR"><span class="hs-identifier hs-type">GenR</span></a></span><span>
</span><span id="line-244"></span><span id="envelopeFor"><span class="annot"><span class="annottext">envelopeFor :: Blob -&gt; GenR -&gt; IO GenR
</span><a href="IC.Test.Agent.html#envelopeFor"><span class="hs-identifier hs-var hs-var">envelopeFor</span></a></span></span><span> </span><span id="local-6989586621679325246"><span class="annot"><span class="annottext">u :: Blob
</span><a href="#local-6989586621679325246"><span class="hs-identifier hs-var">u</span></a></span></span><span> </span><span id="local-6989586621679325245"><span class="annot"><span class="annottext">content :: GenR
</span><a href="#local-6989586621679325245"><span class="hs-identifier hs-var">content</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679325246"><span class="hs-identifier hs-var">u</span></a></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; Blob -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="IC.Test.Agent.html#anonymousUser"><span class="hs-identifier hs-var">anonymousUser</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">GenR -&gt; IO GenR
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(GenR -&gt; IO GenR) -&gt; GenR -&gt; IO GenR
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[HashMap Text GenR] -&gt; GenR
</span><a href="IC.HTTP.GenR.html#rec"><span class="hs-identifier hs-var">rec</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="hs-string">&quot;content&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; GenR -&gt; HashMap Text GenR
forall v. Text -&gt; v -&gt; HashMap Text v
</span><a href="IC.HTTP.GenR.html#%3D%3A"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">GenR
</span><a href="#local-6989586621679325245"><span class="hs-identifier hs-var">content</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-245"></span><span class="annot"><a href="IC.Test.Agent.html#envelopeFor"><span class="hs-identifier hs-var">envelopeFor</span></a></span><span> </span><span id="local-6989586621679325244"><span class="annot"><span class="annottext">u :: Blob
</span><a href="#local-6989586621679325244"><span class="hs-identifier hs-var">u</span></a></span></span><span> </span><span id="local-6989586621679325243"><span class="annot"><span class="annottext">content :: GenR
</span><a href="#local-6989586621679325243"><span class="hs-identifier hs-var">content</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SecretKey -&gt; GenR -&gt; IO GenR
</span><a href="IC.Test.Agent.html#envelope"><span class="hs-identifier hs-var">envelope</span></a></span><span> </span><span class="annot"><span class="annottext">SecretKey
</span><a href="#local-6989586621679325242"><span class="hs-identifier hs-var">key</span></a></span><span> </span><span class="annot"><span class="annottext">GenR
</span><a href="#local-6989586621679325243"><span class="hs-identifier hs-var">content</span></a></span><span>
</span><span id="line-246"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-247"></span><span>    </span><span class="annot"><a href="#local-6989586621679325242"><span class="hs-identifier hs-type">key</span></a></span><span> </span><span class="hs-glyph">::</span><span>  </span><span class="annot"><a href="IC.Crypto.html#SecretKey"><span class="hs-identifier hs-type">SecretKey</span></a></span><span>
</span><span id="line-248"></span><span>    </span><span id="local-6989586621679325242"><span class="annot"><span class="annottext">key :: SecretKey
</span><a href="#local-6989586621679325242"><span class="hs-identifier hs-var hs-var">key</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679325244"><span class="hs-identifier hs-var">u</span></a></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; Blob -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="IC.Test.Agent.html#defaultUser"><span class="hs-identifier hs-var">defaultUser</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SecretKey
</span><a href="IC.Test.Agent.html#defaultSK"><span class="hs-identifier hs-var">defaultSK</span></a></span><span>
</span><span id="line-249"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679325244"><span class="hs-identifier hs-var">u</span></a></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; Blob -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="IC.Test.Agent.html#otherUser"><span class="hs-identifier hs-var">otherUser</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SecretKey
</span><a href="IC.Test.Agent.html#otherSK"><span class="hs-identifier hs-var">otherSK</span></a></span><span>
</span><span id="line-250"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679325244"><span class="hs-identifier hs-var">u</span></a></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; Blob -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="IC.Test.Agent.html#webAuthnECDSAUser"><span class="hs-identifier hs-var">webAuthnECDSAUser</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SecretKey
</span><a href="IC.Test.Agent.html#webAuthnECDSASK"><span class="hs-identifier hs-var">webAuthnECDSASK</span></a></span><span>
</span><span id="line-251"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679325244"><span class="hs-identifier hs-var">u</span></a></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; Blob -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="IC.Test.Agent.html#webAuthnRSAUser"><span class="hs-identifier hs-var">webAuthnRSAUser</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SecretKey
</span><a href="IC.Test.Agent.html#webAuthnRSASK"><span class="hs-identifier hs-var">webAuthnRSASK</span></a></span><span>
</span><span id="line-252"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679325244"><span class="hs-identifier hs-var">u</span></a></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; Blob -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="IC.Test.Agent.html#ecdsaUser"><span class="hs-identifier hs-var">ecdsaUser</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SecretKey
</span><a href="IC.Test.Agent.html#ecdsaSK"><span class="hs-identifier hs-var">ecdsaSK</span></a></span><span>
</span><span id="line-253"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679325244"><span class="hs-identifier hs-var">u</span></a></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; Blob -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="IC.Test.Agent.html#secp256k1User"><span class="hs-identifier hs-var">secp256k1User</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SecretKey
</span><a href="IC.Test.Agent.html#secp256k1SK"><span class="hs-identifier hs-var">secp256k1SK</span></a></span><span>
</span><span id="line-254"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679325244"><span class="hs-identifier hs-var">u</span></a></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; Blob -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="IC.Test.Agent.html#anonymousUser"><span class="hs-identifier hs-var">anonymousUser</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SecretKey
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="hs-string">&quot;No key for the anonymous user&quot;</span></span><span>
</span><span id="line-255"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SecretKey
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; SecretKey) -&gt; String -&gt; SecretKey
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Don't know key for user &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679325244"><span class="hs-identifier hs-var">u</span></a></span><span>
</span><span id="line-256"></span><span>
</span><span id="line-257"></span><span class="hs-comment">-- * HUnit error reporting integration</span><span>
</span><span id="line-258"></span><span>
</span><span id="line-259"></span><span id="local-6989586621679325543"><span class="annot"><a href="IC.Test.Agent.html#asRight"><span class="hs-identifier hs-type">asRight</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">T.Text</span></span><span> </span><span class="annot"><a href="#local-6989586621679325543"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679325543"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-260"></span><span id="asRight"><span class="annot"><span class="annottext">asRight :: Either Text a -&gt; IO a
</span><a href="IC.Test.Agent.html#asRight"><span class="hs-identifier hs-var hs-var">asRight</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679325240"><span class="annot"><span class="annottext">err :: Text
</span><a href="#local-6989586621679325240"><span class="hs-identifier hs-var">err</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; IO a
forall a. HasCallStack =&gt; String -&gt; IO a
</span><span class="hs-identifier hs-var">assertFailure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; String
</span><span class="hs-identifier hs-var">T.unpack</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679325240"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-261"></span><span class="annot"><a href="IC.Test.Agent.html#asRight"><span class="hs-identifier hs-var">asRight</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679325238"><span class="annot"><span class="annottext">gr :: a
</span><a href="#local-6989586621679325238"><span class="hs-identifier hs-var">gr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679325238"><span class="hs-identifier hs-var">gr</span></a></span><span>
</span><span id="line-262"></span><span>
</span><span id="line-263"></span><span id="local-6989586621679325521"><span class="annot"><a href="IC.Test.Agent.html#asExceptT"><span class="hs-identifier hs-type">asExceptT</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ExceptT</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">T.Text</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679325521"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679325521"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-264"></span><span id="asExceptT"><span class="annot"><span class="annottext">asExceptT :: ExceptT Text IO a -&gt; IO a
</span><a href="IC.Test.Agent.html#asExceptT"><span class="hs-identifier hs-var hs-var">asExceptT</span></a></span></span><span> </span><span id="local-6989586621679325236"><span class="annot"><span class="annottext">act :: ExceptT Text IO a
</span><a href="#local-6989586621679325236"><span class="hs-identifier hs-var">act</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExceptT Text IO a -&gt; IO (Either Text a)
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="annot"><span class="annottext">ExceptT Text IO a
</span><a href="#local-6989586621679325236"><span class="hs-identifier hs-var">act</span></a></span><span> </span><span class="annot"><span class="annottext">IO (Either Text a) -&gt; (Either Text a -&gt; IO a) -&gt; IO a
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Either Text a -&gt; IO a
forall a. HasCallStack =&gt; Either Text a -&gt; IO a
</span><a href="IC.Test.Agent.html#asRight"><span class="hs-identifier hs-var">asRight</span></a></span><span>
</span><span id="line-265"></span><span>
</span><span id="line-266"></span><span class="hs-comment">-- * Requests</span><span>
</span><span id="line-267"></span><span>
</span><span id="line-268"></span><span class="hs-comment">-- | Posting a CBOR request, returning a raw bytestring</span><span>
</span><span id="line-269"></span><span class="annot"><a href="IC.Test.Agent.html#postCBOR"><span class="hs-identifier hs-type">postCBOR</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#HasAgentConfig"><span class="hs-identifier hs-type">HasAgentConfig</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.HTTP.GenR.html#GenR"><span class="hs-identifier hs-type">GenR</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Response</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">BS.ByteString</span></span><span class="hs-special">)</span><span>
</span><span id="line-270"></span><span id="postCBOR"><span class="annot"><span class="annottext">postCBOR :: String -&gt; GenR -&gt; IO (Response Blob)
</span><a href="IC.Test.Agent.html#postCBOR"><span class="hs-identifier hs-var hs-var">postCBOR</span></a></span></span><span> </span><span id="local-6989586621679325233"><span class="annot"><span class="annottext">path :: String
</span><a href="#local-6989586621679325233"><span class="hs-identifier hs-var">path</span></a></span></span><span> </span><span id="local-6989586621679325232"><span class="annot"><span class="annottext">gr :: GenR
</span><a href="#local-6989586621679325232"><span class="hs-identifier hs-var">gr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-271"></span><span>    </span><span id="local-6989586621679325231"><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679325231"><span class="hs-identifier hs-var">request</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; IO Request
forall (m :: * -&gt; *). MonadThrow m =&gt; String -&gt; m Request
</span><span class="hs-identifier hs-var">parseRequest</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; IO Request) -&gt; String -&gt; IO Request
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
HasAgentConfig =&gt; String
</span><a href="IC.Test.Agent.html#endPoint"><span class="hs-identifier hs-var">endPoint</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679325233"><span class="hs-identifier hs-var">path</span></a></span><span>
</span><span id="line-272"></span><span>    </span><span id="local-6989586621679325230"><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679325230"><span class="hs-identifier hs-var">request</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Request -&gt; IO Request
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Request -&gt; IO Request) -&gt; Request -&gt; IO Request
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679325231"><span class="hs-identifier hs-var">request</span></a></span><span>
</span><span id="line-273"></span><span>      </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">method :: Method
</span><span class="hs-identifier hs-var">method</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-string">&quot;POST&quot;</span></span><span>
</span><span id="line-274"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">requestBody :: RequestBody
</span><span class="hs-identifier hs-var">requestBody</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Blob -&gt; RequestBody
</span><span class="hs-identifier hs-var">RequestBodyLBS</span></span><span> </span><span class="annot"><span class="annottext">(Blob -&gt; RequestBody) -&gt; Blob -&gt; RequestBody
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Builder -&gt; Blob
</span><span class="hs-identifier hs-var">BS.toLazyByteString</span></span><span> </span><span class="annot"><span class="annottext">(Builder -&gt; Blob) -&gt; Builder -&gt; Blob
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">GenR -&gt; Builder
</span><a href="IC.HTTP.CBOR.html#encode"><span class="hs-identifier hs-var">encode</span></a></span><span> </span><span class="annot"><span class="annottext">GenR
</span><a href="#local-6989586621679325232"><span class="hs-identifier hs-var">gr</span></a></span><span>
</span><span id="line-275"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">requestHeaders :: RequestHeaders
</span><span class="hs-identifier hs-var">requestHeaders</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">HeaderName
</span><span class="hs-identifier hs-var">hContentType</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;application/cbor&quot;</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-276"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-277"></span><span>    </span><span class="annot"><span class="annottext">Request -&gt; Manager -&gt; IO (Response Blob)
</span><span class="hs-identifier hs-var">httpLbs</span></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679325230"><span class="hs-identifier hs-var">request</span></a></span><span> </span><span class="annot"><span class="annottext">Manager
HasAgentConfig =&gt; Manager
</span><a href="IC.Test.Agent.html#agentManager"><span class="hs-identifier hs-var">agentManager</span></a></span><span>
</span><span id="line-278"></span><span>
</span><span id="line-279"></span><span class="hs-comment">-- | postCBOR with url based on effective canister id</span><span>
</span><span id="line-280"></span><span class="annot"><a href="IC.Test.Agent.html#postCallCBOR"><span class="hs-identifier hs-type">postCallCBOR</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#postQueryCBOR"><span class="hs-identifier hs-type">postQueryCBOR</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#postReadStateCBOR"><span class="hs-identifier hs-type">postReadStateCBOR</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#HasAgentConfig"><span class="hs-identifier hs-type">HasAgentConfig</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.HTTP.GenR.html#GenR"><span class="hs-identifier hs-type">GenR</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Response</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">BS.ByteString</span></span><span class="hs-special">)</span><span>
</span><span id="line-281"></span><span id="postCallCBOR"><span class="annot"><span class="annottext">postCallCBOR :: Blob -&gt; GenR -&gt; IO (Response Blob)
</span><a href="IC.Test.Agent.html#postCallCBOR"><span class="hs-identifier hs-var hs-var">postCallCBOR</span></a></span></span><span> </span><span id="local-6989586621679325220"><span class="annot"><span class="annottext">cid :: Blob
</span><a href="#local-6989586621679325220"><span class="hs-identifier hs-var">cid</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(HasCallStack, HasAgentConfig) =&gt;
String -&gt; GenR -&gt; IO (Response Blob)
String -&gt; GenR -&gt; IO (Response Blob)
</span><a href="IC.Test.Agent.html#postCBOR"><span class="hs-identifier hs-var">postCBOR</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; GenR -&gt; IO (Response Blob))
-&gt; String -&gt; GenR -&gt; IO (Response Blob)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;/api/v2/canister/&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; String
</span><a href="IC.Test.Agent.html#textual"><span class="hs-identifier hs-var">textual</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679325220"><span class="hs-identifier hs-var">cid</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="hs-string">&quot;/call&quot;</span></span><span>
</span><span id="line-282"></span><span id="postQueryCBOR"><span class="annot"><span class="annottext">postQueryCBOR :: Blob -&gt; GenR -&gt; IO (Response Blob)
</span><a href="IC.Test.Agent.html#postQueryCBOR"><span class="hs-identifier hs-var hs-var">postQueryCBOR</span></a></span></span><span> </span><span id="local-6989586621679325218"><span class="annot"><span class="annottext">cid :: Blob
</span><a href="#local-6989586621679325218"><span class="hs-identifier hs-var">cid</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(HasCallStack, HasAgentConfig) =&gt;
String -&gt; GenR -&gt; IO (Response Blob)
String -&gt; GenR -&gt; IO (Response Blob)
</span><a href="IC.Test.Agent.html#postCBOR"><span class="hs-identifier hs-var">postCBOR</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; GenR -&gt; IO (Response Blob))
-&gt; String -&gt; GenR -&gt; IO (Response Blob)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;/api/v2/canister/&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; String
</span><a href="IC.Test.Agent.html#textual"><span class="hs-identifier hs-var">textual</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679325218"><span class="hs-identifier hs-var">cid</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="hs-string">&quot;/query&quot;</span></span><span>
</span><span id="line-283"></span><span id="postReadStateCBOR"><span class="annot"><span class="annottext">postReadStateCBOR :: Blob -&gt; GenR -&gt; IO (Response Blob)
</span><a href="IC.Test.Agent.html#postReadStateCBOR"><span class="hs-identifier hs-var hs-var">postReadStateCBOR</span></a></span></span><span> </span><span id="local-6989586621679325217"><span class="annot"><span class="annottext">cid :: Blob
</span><a href="#local-6989586621679325217"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(HasCallStack, HasAgentConfig) =&gt;
String -&gt; GenR -&gt; IO (Response Blob)
String -&gt; GenR -&gt; IO (Response Blob)
</span><a href="IC.Test.Agent.html#postCBOR"><span class="hs-identifier hs-var">postCBOR</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; GenR -&gt; IO (Response Blob))
-&gt; String -&gt; GenR -&gt; IO (Response Blob)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;/api/v2/canister/&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; String
</span><a href="IC.Test.Agent.html#textual"><span class="hs-identifier hs-var">textual</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679325217"><span class="hs-identifier hs-var">cid</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="hs-string">&quot;/read_state&quot;</span></span><span>
</span><span id="line-284"></span><span>
</span><span id="line-285"></span><span class="hs-comment">-- | Add envelope to CBOR request, add a nonce and expiry if it is not there,</span><span>
</span><span id="line-286"></span><span class="hs-comment">-- post to &quot;read&quot;, return decoded CBOR</span><span>
</span><span id="line-287"></span><span class="annot"><a href="IC.Test.Agent.html#queryCBOR"><span class="hs-identifier hs-type">queryCBOR</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#HasAgentConfig"><span class="hs-identifier hs-type">HasAgentConfig</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.HTTP.GenR.html#GenR"><span class="hs-identifier hs-type">GenR</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="IC.HTTP.GenR.html#GenR"><span class="hs-identifier hs-type">GenR</span></a></span><span>
</span><span id="line-288"></span><span id="queryCBOR"><span class="annot"><span class="annottext">queryCBOR :: Blob -&gt; GenR -&gt; IO GenR
</span><a href="IC.Test.Agent.html#queryCBOR"><span class="hs-identifier hs-var hs-var">queryCBOR</span></a></span></span><span> </span><span id="local-6989586621679325215"><span class="annot"><span class="annottext">cid :: Blob
</span><a href="#local-6989586621679325215"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span id="local-6989586621679325214"><span class="annot"><span class="annottext">req :: GenR
</span><a href="#local-6989586621679325214"><span class="hs-identifier hs-var">req</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-289"></span><span>  </span><span class="annot"><span class="annottext">GenR -&gt; IO GenR
</span><a href="IC.Test.Agent.html#addNonceExpiryEnv"><span class="hs-identifier hs-var">addNonceExpiryEnv</span></a></span><span> </span><span class="annot"><span class="annottext">GenR
</span><a href="#local-6989586621679325214"><span class="hs-identifier hs-var">req</span></a></span><span> </span><span class="annot"><span class="annottext">IO GenR -&gt; (GenR -&gt; IO (Response Blob)) -&gt; IO (Response Blob)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">(HasCallStack, HasAgentConfig) =&gt;
Blob -&gt; GenR -&gt; IO (Response Blob)
Blob -&gt; GenR -&gt; IO (Response Blob)
</span><a href="IC.Test.Agent.html#postQueryCBOR"><span class="hs-identifier hs-var">postQueryCBOR</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679325215"><span class="hs-identifier hs-var">cid</span></a></span><span> </span><span class="annot"><span class="annottext">IO (Response Blob) -&gt; (Response Blob -&gt; IO GenR) -&gt; IO GenR
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; Response Blob -&gt; IO GenR
Response Blob -&gt; IO GenR
</span><a href="IC.Test.Agent.html#okCBOR"><span class="hs-identifier hs-var">okCBOR</span></a></span><span>
</span><span id="line-290"></span><span>
</span><span id="line-291"></span><span class="hs-comment">-- | Add envelope to CBOR, and a nonce and expiry if not there, post to</span><span>
</span><span id="line-292"></span><span class="hs-comment">-- &quot;submit&quot;. Returns either a HTTP Error code, or if the status is 2xx, poll</span><span>
</span><span id="line-293"></span><span class="hs-comment">-- for the request response, and return decoded CBOR</span><span>
</span><span id="line-294"></span><span class="hs-keyword">type</span><span> </span><span id="HTTPErrOrReqResponse"><span class="annot"><a href="IC.Test.Agent.html#HTTPErrOrReqResponse"><span class="hs-identifier hs-var">HTTPErrOrReqResponse</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">,</span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#ReqResponse"><span class="hs-identifier hs-type">ReqResponse</span></a></span><span>
</span><span id="line-295"></span><span>
</span><span id="line-296"></span><span class="annot"><a href="IC.Test.Agent.html#awaitCall%27"><span class="hs-identifier hs-type">awaitCall'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#HasAgentConfig"><span class="hs-identifier hs-type">HasAgentConfig</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.HTTP.GenR.html#GenR"><span class="hs-identifier hs-type">GenR</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="IC.Test.Agent.html#HTTPErrOrReqResponse"><span class="hs-identifier hs-type">HTTPErrOrReqResponse</span></a></span><span>
</span><span id="line-297"></span><span id="awaitCall%27"><span class="annot"><span class="annottext">awaitCall' :: Blob -&gt; GenR -&gt; IO HTTPErrOrReqResponse
</span><a href="IC.Test.Agent.html#awaitCall%27"><span class="hs-identifier hs-var hs-var">awaitCall'</span></a></span></span><span> </span><span id="local-6989586621679325212"><span class="annot"><span class="annottext">cid :: Blob
</span><a href="#local-6989586621679325212"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span id="local-6989586621679325211"><span class="annot"><span class="annottext">req :: GenR
</span><a href="#local-6989586621679325211"><span class="hs-identifier hs-var">req</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-298"></span><span>  </span><span id="local-6989586621679325210"><span class="annot"><span class="annottext">GenR
</span><a href="#local-6989586621679325210"><span class="hs-identifier hs-var">req</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">GenR -&gt; IO GenR
</span><a href="IC.Test.Agent.html#addNonce"><span class="hs-identifier hs-var">addNonce</span></a></span><span> </span><span class="annot"><span class="annottext">GenR
</span><a href="#local-6989586621679325211"><span class="hs-identifier hs-var">req</span></a></span><span>
</span><span id="line-299"></span><span>  </span><span id="local-6989586621679325209"><span class="annot"><span class="annottext">GenR
</span><a href="#local-6989586621679325209"><span class="hs-identifier hs-var">req</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">GenR -&gt; IO GenR
</span><a href="IC.Test.Agent.html#addExpiry"><span class="hs-identifier hs-var">addExpiry</span></a></span><span> </span><span class="annot"><span class="annottext">GenR
</span><a href="#local-6989586621679325210"><span class="hs-identifier hs-var">req</span></a></span><span>
</span><span id="line-300"></span><span>  </span><span id="local-6989586621679325208"><span class="annot"><span class="annottext">Response Blob
</span><a href="#local-6989586621679325208"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Blob -&gt; GenR -&gt; IO GenR
</span><a href="IC.Test.Agent.html#envelopeFor"><span class="hs-identifier hs-var">envelopeFor</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">GenR -&gt; Blob
</span><a href="IC.Test.Agent.html#senderOf"><span class="hs-identifier hs-var">senderOf</span></a></span><span> </span><span class="annot"><span class="annottext">GenR
</span><a href="#local-6989586621679325209"><span class="hs-identifier hs-var">req</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">GenR
</span><a href="#local-6989586621679325209"><span class="hs-identifier hs-var">req</span></a></span><span> </span><span class="annot"><span class="annottext">IO GenR -&gt; (GenR -&gt; IO (Response Blob)) -&gt; IO (Response Blob)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">(HasCallStack, HasAgentConfig) =&gt;
Blob -&gt; GenR -&gt; IO (Response Blob)
Blob -&gt; GenR -&gt; IO (Response Blob)
</span><a href="IC.Test.Agent.html#postCallCBOR"><span class="hs-identifier hs-var">postCallCBOR</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679325212"><span class="hs-identifier hs-var">cid</span></a></span><span>
</span><span id="line-301"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679325207"><span class="annot"><span class="annottext">code :: Int
</span><a href="#local-6989586621679325207"><span class="hs-identifier hs-var hs-var">code</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Status -&gt; Int
</span><span class="hs-identifier hs-var hs-var">statusCode</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Response Blob -&gt; Status
forall body. Response body -&gt; Status
</span><span class="hs-identifier hs-var hs-var">responseStatus</span></span><span> </span><span class="annot"><span class="annottext">Response Blob
</span><a href="#local-6989586621679325208"><span class="hs-identifier hs-var">res</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-302"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="hs-number">200</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679325207"><span class="hs-identifier hs-var">code</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679325207"><span class="hs-identifier hs-var">code</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="hs-number">300</span></span><span>
</span><span id="line-303"></span><span>  </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-304"></span><span>     </span><span class="annot"><span class="annottext">HasCallStack =&gt; String -&gt; Bool -&gt; IO ()
String -&gt; Bool -&gt; IO ()
</span><span class="hs-identifier hs-var">assertBool</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Response body not empty&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Blob -&gt; Bool
</span><span class="hs-identifier hs-var">BS.null</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Response Blob -&gt; Blob
forall body. Response body -&gt; body
</span><span class="hs-identifier hs-var hs-var">responseBody</span></span><span> </span><span class="annot"><span class="annottext">Response Blob
</span><a href="#local-6989586621679325208"><span class="hs-identifier hs-var">res</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-305"></span><span>     </span><span class="annot"><span class="annottext">ReqResponse -&gt; HTTPErrOrReqResponse
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">(ReqResponse -&gt; HTTPErrOrReqResponse)
-&gt; IO ReqResponse -&gt; IO HTTPErrOrReqResponse
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">HasAgentConfig =&gt; Blob -&gt; Blob -&gt; Blob -&gt; IO ReqResponse
Blob -&gt; Blob -&gt; Blob -&gt; IO ReqResponse
</span><a href="IC.Test.Agent.html#awaitStatus"><span class="hs-identifier hs-var">awaitStatus</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">GenR -&gt; Blob
</span><a href="IC.Test.Agent.html#senderOf"><span class="hs-identifier hs-var">senderOf</span></a></span><span> </span><span class="annot"><span class="annottext">GenR
</span><a href="#local-6989586621679325209"><span class="hs-identifier hs-var">req</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679325212"><span class="hs-identifier hs-var">cid</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">GenR -&gt; Blob
</span><a href="IC.HTTP.RequestId.html#requestId"><span class="hs-identifier hs-var">requestId</span></a></span><span> </span><span class="annot"><span class="annottext">GenR
</span><a href="#local-6989586621679325209"><span class="hs-identifier hs-var">req</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-306"></span><span>  </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-307"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679325197"><span class="annot"><span class="annottext">msg :: String
</span><a href="#local-6989586621679325197"><span class="hs-identifier hs-var hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; String
</span><span class="hs-identifier hs-var">T.unpack</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OnDecodeError -&gt; Method -&gt; Text
</span><span class="hs-identifier hs-var">T.decodeUtf8With</span></span><span> </span><span class="annot"><span class="annottext">OnDecodeError
</span><span class="hs-identifier hs-var">T.lenientDecode</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Blob -&gt; Method
</span><span class="hs-identifier hs-var">BS.toStrict</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int64 -&gt; Blob -&gt; Blob
</span><span class="hs-identifier hs-var">BS.take</span></span><span> </span><span class="annot"><span class="hs-number">200</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Response Blob -&gt; Blob
forall body. Response body -&gt; body
</span><span class="hs-identifier hs-var hs-var">responseBody</span></span><span> </span><span class="annot"><span class="annottext">Response Blob
</span><a href="#local-6989586621679325208"><span class="hs-identifier hs-var">res</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-308"></span><span>    </span><span class="annot"><span class="annottext">HTTPErrOrReqResponse -&gt; IO HTTPErrOrReqResponse
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(HTTPErrOrReqResponse -&gt; IO HTTPErrOrReqResponse)
-&gt; HTTPErrOrReqResponse -&gt; IO HTTPErrOrReqResponse
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Int, String) -&gt; HTTPErrOrReqResponse
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679325207"><span class="hs-identifier hs-var">code</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679325197"><span class="hs-identifier hs-var">msg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-309"></span><span>
</span><span id="line-310"></span><span class="hs-comment">-- | Add envelope to CBOR, and a nonce and expiry if not there, post to</span><span>
</span><span id="line-311"></span><span class="hs-comment">-- &quot;submit&quot;, poll for the request response, and return decoded CBOR</span><span>
</span><span id="line-312"></span><span class="annot"><a href="IC.Test.Agent.html#awaitCall"><span class="hs-identifier hs-type">awaitCall</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#HasAgentConfig"><span class="hs-identifier hs-type">HasAgentConfig</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.HTTP.GenR.html#GenR"><span class="hs-identifier hs-type">GenR</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="IC.Test.Agent.html#ReqResponse"><span class="hs-identifier hs-type">ReqResponse</span></a></span><span>
</span><span id="line-313"></span><span id="awaitCall"><span class="annot"><span class="annottext">awaitCall :: Blob -&gt; GenR -&gt; IO ReqResponse
</span><a href="IC.Test.Agent.html#awaitCall"><span class="hs-identifier hs-var hs-var">awaitCall</span></a></span></span><span> </span><span id="local-6989586621679325191"><span class="annot"><span class="annottext">cid :: Blob
</span><a href="#local-6989586621679325191"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span id="local-6989586621679325190"><span class="annot"><span class="annottext">req :: GenR
</span><a href="#local-6989586621679325190"><span class="hs-identifier hs-var">req</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(HasCallStack, HasAgentConfig) =&gt;
Blob -&gt; GenR -&gt; IO HTTPErrOrReqResponse
Blob -&gt; GenR -&gt; IO HTTPErrOrReqResponse
</span><a href="IC.Test.Agent.html#awaitCall%27"><span class="hs-identifier hs-var">awaitCall'</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679325191"><span class="hs-identifier hs-var">cid</span></a></span><span> </span><span class="annot"><span class="annottext">GenR
</span><a href="#local-6989586621679325190"><span class="hs-identifier hs-var">req</span></a></span><span> </span><span class="annot"><span class="annottext">IO HTTPErrOrReqResponse
-&gt; (HTTPErrOrReqResponse -&gt; IO ReqResponse) -&gt; IO ReqResponse
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; HTTPErrOrReqResponse -&gt; IO ReqResponse
HTTPErrOrReqResponse -&gt; IO ReqResponse
</span><a href="IC.Test.Agent.html#is2xx"><span class="hs-identifier hs-var">is2xx</span></a></span><span>
</span><span id="line-314"></span><span>
</span><span id="line-315"></span><span class="annot"><a href="IC.Test.Agent.html#is2xx"><span class="hs-identifier hs-type">is2xx</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#HTTPErrOrReqResponse"><span class="hs-identifier hs-type">HTTPErrOrReqResponse</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="IC.Test.Agent.html#ReqResponse"><span class="hs-identifier hs-type">ReqResponse</span></a></span><span>
</span><span id="line-316"></span><span id="is2xx"><span class="annot"><span class="annottext">is2xx :: HTTPErrOrReqResponse -&gt; IO ReqResponse
</span><a href="IC.Test.Agent.html#is2xx"><span class="hs-identifier hs-var hs-var">is2xx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-317"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679325188"><span class="annot"><span class="annottext">c :: Int
</span><a href="#local-6989586621679325188"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679325187"><span class="annot"><span class="annottext">msg :: String
</span><a href="#local-6989586621679325187"><span class="hs-identifier hs-var">msg</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; IO ReqResponse
forall a. HasCallStack =&gt; String -&gt; IO a
</span><span class="hs-identifier hs-var">assertFailure</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; IO ReqResponse) -&gt; String -&gt; IO ReqResponse
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Status &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679325188"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="hs-string">&quot; is not 2xx:\n&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679325187"><span class="hs-identifier hs-var">msg</span></a></span><span>
</span><span id="line-318"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679325186"><span class="annot"><span class="annottext">res :: ReqResponse
</span><a href="#local-6989586621679325186"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ReqResponse -&gt; IO ReqResponse
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">ReqResponse
</span><a href="#local-6989586621679325186"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-319"></span><span>
</span><span id="line-320"></span><span class="annot"><a href="IC.Test.Agent.html#getStateCert%27"><span class="hs-identifier hs-type">getStateCert'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#HasAgentConfig"><span class="hs-identifier hs-type">HasAgentConfig</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span class="hs-special">]</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Response</span></span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-321"></span><span id="getStateCert%27"><span class="annot"><span class="annottext">getStateCert' :: Blob -&gt; Blob -&gt; [[Blob]] -&gt; IO (Response Blob)
</span><a href="IC.Test.Agent.html#getStateCert%27"><span class="hs-identifier hs-var hs-var">getStateCert'</span></a></span></span><span> </span><span id="local-6989586621679325184"><span class="annot"><span class="annottext">sender :: Blob
</span><a href="#local-6989586621679325184"><span class="hs-identifier hs-var">sender</span></a></span></span><span> </span><span id="local-6989586621679325183"><span class="annot"><span class="annottext">ecid :: Blob
</span><a href="#local-6989586621679325183"><span class="hs-identifier hs-var">ecid</span></a></span></span><span> </span><span id="local-6989586621679325182"><span class="annot"><span class="annottext">paths :: [[Blob]]
</span><a href="#local-6989586621679325182"><span class="hs-identifier hs-var">paths</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-322"></span><span>    </span><span id="local-6989586621679325181"><span class="annot"><span class="annottext">GenR
</span><a href="#local-6989586621679325181"><span class="hs-identifier hs-var">req</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">GenR -&gt; IO GenR
</span><a href="IC.Test.Agent.html#addExpiry"><span class="hs-identifier hs-var">addExpiry</span></a></span><span> </span><span class="annot"><span class="annottext">(GenR -&gt; IO GenR) -&gt; GenR -&gt; IO GenR
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[HashMap Text GenR] -&gt; GenR
</span><a href="IC.HTTP.GenR.html#rec"><span class="hs-identifier hs-var">rec</span></a></span><span>
</span><span id="line-323"></span><span>      </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="hs-string">&quot;request_type&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; GenR -&gt; HashMap Text GenR
forall v. Text -&gt; v -&gt; HashMap Text v
</span><a href="IC.HTTP.GenR.html#%3D%3A"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; GenR
</span><a href="IC.HTTP.GenR.html#GText"><span class="hs-identifier hs-var">GText</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;read_state&quot;</span></span><span>
</span><span id="line-324"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;sender&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; GenR -&gt; HashMap Text GenR
forall v. Text -&gt; v -&gt; HashMap Text v
</span><a href="IC.HTTP.GenR.html#%3D%3A"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; GenR
</span><a href="IC.HTTP.GenR.html#GBlob"><span class="hs-identifier hs-var">GBlob</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679325184"><span class="hs-identifier hs-var">sender</span></a></span><span>
</span><span id="line-325"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;paths&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; GenR -&gt; HashMap Text GenR
forall v. Text -&gt; v -&gt; HashMap Text v
</span><a href="IC.HTTP.GenR.html#%3D%3A"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">[GenR] -&gt; GenR
</span><a href="IC.HTTP.GenR.html#GList"><span class="hs-identifier hs-var">GList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">([Blob] -&gt; GenR) -&gt; [[Blob]] -&gt; [GenR]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[GenR] -&gt; GenR
</span><a href="IC.HTTP.GenR.html#GList"><span class="hs-identifier hs-var">GList</span></a></span><span> </span><span class="annot"><span class="annottext">([GenR] -&gt; GenR) -&gt; ([Blob] -&gt; [GenR]) -&gt; [Blob] -&gt; GenR
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Blob -&gt; GenR) -&gt; [Blob] -&gt; [GenR]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; GenR
</span><a href="IC.HTTP.GenR.html#GBlob"><span class="hs-identifier hs-var">GBlob</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[[Blob]]
</span><a href="#local-6989586621679325182"><span class="hs-identifier hs-var">paths</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-326"></span><span>      </span><span class="hs-special">]</span><span>
</span><span id="line-327"></span><span>    </span><span class="annot"><span class="annottext">Blob -&gt; GenR -&gt; IO GenR
</span><a href="IC.Test.Agent.html#envelopeFor"><span class="hs-identifier hs-var">envelopeFor</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">GenR -&gt; Blob
</span><a href="IC.Test.Agent.html#senderOf"><span class="hs-identifier hs-var">senderOf</span></a></span><span> </span><span class="annot"><span class="annottext">GenR
</span><a href="#local-6989586621679325181"><span class="hs-identifier hs-var">req</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">GenR
</span><a href="#local-6989586621679325181"><span class="hs-identifier hs-var">req</span></a></span><span> </span><span class="annot"><span class="annottext">IO GenR -&gt; (GenR -&gt; IO (Response Blob)) -&gt; IO (Response Blob)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">(HasCallStack, HasAgentConfig) =&gt;
Blob -&gt; GenR -&gt; IO (Response Blob)
Blob -&gt; GenR -&gt; IO (Response Blob)
</span><a href="IC.Test.Agent.html#postReadStateCBOR"><span class="hs-identifier hs-var">postReadStateCBOR</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679325183"><span class="hs-identifier hs-var">ecid</span></a></span><span>
</span><span id="line-328"></span><span>
</span><span id="line-329"></span><span class="annot"><a href="IC.Test.Agent.html#decodeCert%27"><span class="hs-identifier hs-type">decodeCert'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="IC.Certificate.html#Certificate"><span class="hs-identifier hs-type">Certificate</span></a></span><span>
</span><span id="line-330"></span><span id="decodeCert%27"><span class="annot"><span class="annottext">decodeCert' :: Blob -&gt; IO Certificate
</span><a href="IC.Test.Agent.html#decodeCert%27"><span class="hs-identifier hs-var hs-var">decodeCert'</span></a></span></span><span> </span><span id="local-6989586621679325177"><span class="annot"><span class="annottext">b :: Blob
</span><a href="#local-6989586621679325177"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Text -&gt; IO Certificate)
-&gt; (Certificate -&gt; IO Certificate)
-&gt; Either Text Certificate
-&gt; IO Certificate
forall a c b. (a -&gt; c) -&gt; (b -&gt; c) -&gt; Either a b -&gt; c
</span><span class="hs-identifier hs-var">either</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; IO Certificate
forall a. HasCallStack =&gt; String -&gt; IO a
</span><span class="hs-identifier hs-var">assertFailure</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; IO Certificate)
-&gt; (Text -&gt; String) -&gt; Text -&gt; IO Certificate
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; String
</span><span class="hs-identifier hs-var">T.unpack</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Certificate -&gt; IO Certificate
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Either Text Certificate -&gt; IO Certificate)
-&gt; Either Text Certificate -&gt; IO Certificate
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; Either Text Certificate
</span><a href="IC.Certificate.CBOR.html#decodeCert"><span class="hs-identifier hs-var">decodeCert</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679325177"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-331"></span><span>
</span><span id="line-332"></span><span class="annot"><a href="IC.Test.Agent.html#getStateCert"><span class="hs-identifier hs-type">getStateCert</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#HasAgentConfig"><span class="hs-identifier hs-type">HasAgentConfig</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span class="hs-special">]</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="IC.Certificate.html#Certificate"><span class="hs-identifier hs-type">Certificate</span></a></span><span>
</span><span id="line-333"></span><span id="getStateCert"><span class="annot"><span class="annottext">getStateCert :: Blob -&gt; Blob -&gt; [[Blob]] -&gt; IO Certificate
</span><a href="IC.Test.Agent.html#getStateCert"><span class="hs-identifier hs-var hs-var">getStateCert</span></a></span></span><span> </span><span id="local-6989586621679325173"><span class="annot"><span class="annottext">sender :: Blob
</span><a href="#local-6989586621679325173"><span class="hs-identifier hs-var">sender</span></a></span></span><span> </span><span id="local-6989586621679325172"><span class="annot"><span class="annottext">ecid :: Blob
</span><a href="#local-6989586621679325172"><span class="hs-identifier hs-var">ecid</span></a></span></span><span> </span><span id="local-6989586621679325171"><span class="annot"><span class="annottext">paths :: [[Blob]]
</span><a href="#local-6989586621679325171"><span class="hs-identifier hs-var">paths</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-334"></span><span>    </span><span id="local-6989586621679325170"><span class="annot"><span class="annottext">GenR
</span><a href="#local-6989586621679325170"><span class="hs-identifier hs-var">gr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(HasCallStack, HasAgentConfig) =&gt;
Blob -&gt; Blob -&gt; [[Blob]] -&gt; IO (Response Blob)
Blob -&gt; Blob -&gt; [[Blob]] -&gt; IO (Response Blob)
</span><a href="IC.Test.Agent.html#getStateCert%27"><span class="hs-identifier hs-var">getStateCert'</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679325173"><span class="hs-identifier hs-var">sender</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679325172"><span class="hs-identifier hs-var">ecid</span></a></span><span> </span><span class="annot"><span class="annottext">[[Blob]]
</span><a href="#local-6989586621679325171"><span class="hs-identifier hs-var">paths</span></a></span><span> </span><span class="annot"><span class="annottext">IO (Response Blob) -&gt; (Response Blob -&gt; IO GenR) -&gt; IO GenR
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; Response Blob -&gt; IO GenR
Response Blob -&gt; IO GenR
</span><a href="IC.Test.Agent.html#okCBOR"><span class="hs-identifier hs-var">okCBOR</span></a></span><span>
</span><span id="line-335"></span><span>    </span><span id="local-6989586621679325169"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679325169"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ExceptT Text IO Blob -&gt; IO Blob
forall a. HasCallStack =&gt; ExceptT Text IO a -&gt; IO a
</span><a href="IC.Test.Agent.html#asExceptT"><span class="hs-identifier hs-var">asExceptT</span></a></span><span> </span><span class="annot"><span class="annottext">(ExceptT Text IO Blob -&gt; IO Blob)
-&gt; ExceptT Text IO Blob -&gt; IO Blob
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">RecordM (ExceptT Text IO) Blob -&gt; GenR -&gt; ExceptT Text IO Blob
forall (m :: * -&gt; *) a.
(HasCallStack, Parse m) =&gt;
RecordM m a -&gt; GenR -&gt; m a
</span><a href="IC.HTTP.GenR.Parse.html#record"><span class="hs-identifier hs-var">record</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Field Blob -&gt; Text -&gt; RecordM (ExceptT Text IO) Blob
forall (m :: * -&gt; *) a.
(HasCallStack, Parse m) =&gt;
Field a -&gt; Text -&gt; RecordM m a
</span><a href="IC.HTTP.GenR.Parse.html#field"><span class="hs-identifier hs-var">field</span></a></span><span> </span><span class="annot"><span class="annottext">Field Blob
</span><a href="IC.HTTP.GenR.Parse.html#blob"><span class="hs-identifier hs-var">blob</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;certificate&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">GenR
</span><a href="#local-6989586621679325170"><span class="hs-identifier hs-var">gr</span></a></span><span>
</span><span id="line-336"></span><span>    </span><span id="local-6989586621679325165"><span class="annot"><span class="annottext">Certificate
</span><a href="#local-6989586621679325165"><span class="hs-identifier hs-var">cert</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; Blob -&gt; IO Certificate
Blob -&gt; IO Certificate
</span><a href="IC.Test.Agent.html#decodeCert%27"><span class="hs-identifier hs-var">decodeCert'</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679325169"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-337"></span><span>
</span><span id="line-338"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">HashTree -&gt; Either String ()
</span><a href="IC.HashTree.html#wellFormed"><span class="hs-identifier hs-var">wellFormed</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Certificate -&gt; HashTree
</span><a href="IC.Certificate.html#cert_tree"><span class="hs-identifier hs-var hs-var">cert_tree</span></a></span><span> </span><span class="annot"><span class="annottext">Certificate
</span><a href="#local-6989586621679325165"><span class="hs-identifier hs-var">cert</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-339"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679325162"><span class="annot"><span class="annottext">err :: String
</span><a href="#local-6989586621679325162"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; IO ()
forall a. HasCallStack =&gt; String -&gt; IO a
</span><span class="hs-identifier hs-var">assertFailure</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; IO ()) -&gt; String -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Hash tree not well formed: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679325162"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-340"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-341"></span><span>
</span><span id="line-342"></span><span>    </span><span class="annot"><span class="annottext">Certificate -&gt; IO Certificate
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Certificate
</span><a href="#local-6989586621679325165"><span class="hs-identifier hs-var">cert</span></a></span><span>
</span><span id="line-343"></span><span>
</span><span id="line-344"></span><span class="annot"><a href="IC.Test.Agent.html#extractCertData"><span class="hs-identifier hs-type">extractCertData</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span>
</span><span id="line-345"></span><span id="extractCertData"><span class="annot"><span class="annottext">extractCertData :: Blob -&gt; Blob -&gt; IO Blob
</span><a href="IC.Test.Agent.html#extractCertData"><span class="hs-identifier hs-var hs-var">extractCertData</span></a></span></span><span> </span><span id="local-6989586621679325160"><span class="annot"><span class="annottext">cid :: Blob
</span><a href="#local-6989586621679325160"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span id="local-6989586621679325159"><span class="annot"><span class="annottext">b :: Blob
</span><a href="#local-6989586621679325159"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-346"></span><span>  </span><span id="local-6989586621679325158"><span class="annot"><span class="annottext">Certificate
</span><a href="#local-6989586621679325158"><span class="hs-identifier hs-var">cert</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; Blob -&gt; IO Certificate
Blob -&gt; IO Certificate
</span><a href="IC.Test.Agent.html#decodeCert%27"><span class="hs-identifier hs-var">decodeCert'</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679325159"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-347"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">HashTree -&gt; Either String ()
</span><a href="IC.HashTree.html#wellFormed"><span class="hs-identifier hs-var">wellFormed</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Certificate -&gt; HashTree
</span><a href="IC.Certificate.html#cert_tree"><span class="hs-identifier hs-var hs-var">cert_tree</span></a></span><span> </span><span class="annot"><span class="annottext">Certificate
</span><a href="#local-6989586621679325158"><span class="hs-identifier hs-var">cert</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-348"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679325157"><span class="annot"><span class="annottext">err :: String
</span><a href="#local-6989586621679325157"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; IO ()
forall a. HasCallStack =&gt; String -&gt; IO a
</span><span class="hs-identifier hs-var">assertFailure</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; IO ()) -&gt; String -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Hash tree not well formed: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679325157"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-349"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-350"></span><span>  </span><span class="annot"><span class="annottext">Certificate -&gt; [Blob] -&gt; IO Blob
forall a.
(HasCallStack, CertVal a) =&gt;
Certificate -&gt; [Blob] -&gt; IO a
</span><a href="IC.Test.Agent.html#certValue"><span class="hs-identifier hs-var">certValue</span></a></span><span> </span><span class="annot"><span class="annottext">Certificate
</span><a href="#local-6989586621679325158"><span class="hs-identifier hs-var">cert</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-string">&quot;canister&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679325160"><span class="hs-identifier hs-var">cid</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;certified_data&quot;</span></span><span class="hs-special">]</span><span>
</span><span id="line-351"></span><span>
</span><span id="line-352"></span><span class="annot"><a href="IC.Test.Agent.html#verboseVerify"><span class="hs-identifier hs-type">verboseVerify</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-353"></span><span id="verboseVerify"><span class="annot"><span class="annottext">verboseVerify :: String -&gt; Blob -&gt; Blob -&gt; Blob -&gt; Blob -&gt; IO ()
</span><a href="IC.Test.Agent.html#verboseVerify"><span class="hs-identifier hs-var hs-var">verboseVerify</span></a></span></span><span> </span><span id="local-6989586621679325154"><span class="annot"><span class="annottext">what :: String
</span><a href="#local-6989586621679325154"><span class="hs-identifier hs-var">what</span></a></span></span><span> </span><span id="local-6989586621679325153"><span class="annot"><span class="annottext">domain_sep :: Blob
</span><a href="#local-6989586621679325153"><span class="hs-identifier hs-var">domain_sep</span></a></span></span><span> </span><span id="local-6989586621679325152"><span class="annot"><span class="annottext">pk :: Blob
</span><a href="#local-6989586621679325152"><span class="hs-identifier hs-var">pk</span></a></span></span><span> </span><span id="local-6989586621679325151"><span class="annot"><span class="annottext">msg :: Blob
</span><a href="#local-6989586621679325151"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span id="local-6989586621679325150"><span class="annot"><span class="annottext">sig :: Blob
</span><a href="#local-6989586621679325150"><span class="hs-identifier hs-var">sig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-354"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Blob -&gt; Blob -&gt; Blob -&gt; Blob -&gt; Either Text ()
</span><a href="IC.Crypto.DER_BLS.html#verify"><span class="hs-identifier hs-var">DER_BLS.verify</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679325153"><span class="hs-identifier hs-var">domain_sep</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679325152"><span class="hs-identifier hs-var">pk</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679325151"><span class="hs-identifier hs-var">msg</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679325150"><span class="hs-identifier hs-var">sig</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-355"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679325148"><span class="annot"><span class="annottext">err :: Text
</span><a href="#local-6989586621679325148"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; IO ()
forall a. HasCallStack =&gt; String -&gt; IO a
</span><span class="hs-identifier hs-var">assertFailure</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; IO ()) -&gt; String -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[String] -&gt; String
</span><span class="hs-identifier hs-var">unlines</span></span><span>
</span><span id="line-356"></span><span>            </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="hs-string">&quot;Signature verification failed on &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679325154"><span class="hs-identifier hs-var">what</span></a></span><span>
</span><span id="line-357"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text -&gt; String
</span><span class="hs-identifier hs-var">T.unpack</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679325148"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-358"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;Domain separator:   &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; String
</span><a href="IC.Test.Agent.html#prettyBlob"><span class="hs-identifier hs-var">prettyBlob</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679325153"><span class="hs-identifier hs-var">domain_sep</span></a></span><span>
</span><span id="line-359"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;Public key (DER):   &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; String
</span><a href="IC.Test.Agent.html#asHex"><span class="hs-identifier hs-var">asHex</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679325152"><span class="hs-identifier hs-var">pk</span></a></span><span>
</span><span id="line-360"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;Public key decoded: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span>
</span><span id="line-361"></span><span>               </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Blob -&gt; Either Text (Suite, Blob)
</span><a href="IC.Crypto.DER.html#decode"><span class="hs-identifier hs-var">DER.decode</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679325152"><span class="hs-identifier hs-var">pk</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-362"></span><span>                 </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679325143"><span class="annot"><span class="annottext">err :: Text
</span><a href="#local-6989586621679325143"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text -&gt; String
</span><span class="hs-identifier hs-var">T.unpack</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679325143"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-363"></span><span>                 </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679325142"><span class="annot"><span class="annottext">suite :: Suite
</span><a href="#local-6989586621679325142"><span class="hs-identifier hs-var">suite</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679325141"><span class="annot"><span class="annottext">key :: Blob
</span><a href="#local-6989586621679325141"><span class="hs-identifier hs-var">key</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Blob -&gt; String
</span><a href="IC.Test.Agent.html#asHex"><span class="hs-identifier hs-var">asHex</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679325141"><span class="hs-identifier hs-var">key</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="hs-string">&quot; (&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Suite -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Suite
</span><a href="#local-6989586621679325142"><span class="hs-identifier hs-var">suite</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="hs-string">&quot;)&quot;</span></span><span>
</span><span id="line-364"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;Signature:          &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; String
</span><a href="IC.Test.Agent.html#asHex"><span class="hs-identifier hs-var">asHex</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679325150"><span class="hs-identifier hs-var">sig</span></a></span><span>
</span><span id="line-365"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;Checked message:    &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; String
</span><a href="IC.Test.Agent.html#prettyBlob"><span class="hs-identifier hs-var">prettyBlob</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679325151"><span class="hs-identifier hs-var">msg</span></a></span><span>
</span><span id="line-366"></span><span>            </span><span class="hs-special">]</span><span>
</span><span id="line-367"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-368"></span><span>
</span><span id="line-369"></span><span class="annot"><a href="IC.Test.Agent.html#validateDelegation"><span class="hs-identifier hs-type">validateDelegation</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#HasAgentConfig"><span class="hs-identifier hs-type">HasAgentConfig</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="IC.Certificate.html#Delegation"><span class="hs-identifier hs-type">Delegation</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span>
</span><span id="line-370"></span><span id="validateDelegation"><span class="annot"><span class="annottext">validateDelegation :: Maybe Delegation -&gt; IO Blob
</span><a href="IC.Test.Agent.html#validateDelegation"><span class="hs-identifier hs-var hs-var">validateDelegation</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Blob -&gt; IO Blob
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AgentConfig -&gt; Blob
</span><a href="IC.Test.Agent.html#tc_root_key"><span class="hs-identifier hs-var hs-var">tc_root_key</span></a></span><span> </span><span class="annot"><span class="annottext">AgentConfig
HasAgentConfig =&gt; AgentConfig
</span><a href="IC.Test.Agent.html#agentConfig"><span class="hs-identifier hs-var">agentConfig</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-371"></span><span class="annot"><a href="IC.Test.Agent.html#validateDelegation"><span class="hs-identifier hs-var">validateDelegation</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679325139"><span class="annot"><span class="annottext">del :: Delegation
</span><a href="#local-6989586621679325139"><span class="hs-identifier hs-var">del</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-372"></span><span>    </span><span id="local-6989586621679325138"><span class="annot"><span class="annottext">Certificate
</span><a href="#local-6989586621679325138"><span class="hs-identifier hs-var">cert</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; Blob -&gt; IO Certificate
Blob -&gt; IO Certificate
</span><a href="IC.Test.Agent.html#decodeCert%27"><span class="hs-identifier hs-var">decodeCert'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Delegation -&gt; Blob
</span><a href="IC.Certificate.html#del_certificate"><span class="hs-identifier hs-var hs-var">del_certificate</span></a></span><span> </span><span class="annot"><span class="annottext">Delegation
</span><a href="#local-6989586621679325139"><span class="hs-identifier hs-var">del</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-373"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">HashTree -&gt; Either String ()
</span><a href="IC.HashTree.html#wellFormed"><span class="hs-identifier hs-var">wellFormed</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Certificate -&gt; HashTree
</span><a href="IC.Certificate.html#cert_tree"><span class="hs-identifier hs-var hs-var">cert_tree</span></a></span><span> </span><span class="annot"><span class="annottext">Certificate
</span><a href="#local-6989586621679325138"><span class="hs-identifier hs-var">cert</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-374"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679325136"><span class="annot"><span class="annottext">err :: String
</span><a href="#local-6989586621679325136"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; IO ()
forall a. HasCallStack =&gt; String -&gt; IO a
</span><span class="hs-identifier hs-var">assertFailure</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; IO ()) -&gt; String -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Hash tree not well formed: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679325136"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-375"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-376"></span><span>    </span><span class="annot"><span class="annottext">(HasCallStack, HasAgentConfig) =&gt; String -&gt; Certificate -&gt; IO ()
String -&gt; Certificate -&gt; IO ()
</span><a href="IC.Test.Agent.html#validateStateCert%27"><span class="hs-identifier hs-var">validateStateCert'</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;certificate delegation&quot;</span></span><span> </span><span class="annot"><span class="annottext">Certificate
</span><a href="#local-6989586621679325138"><span class="hs-identifier hs-var">cert</span></a></span><span>
</span><span id="line-377"></span><span>
</span><span id="line-378"></span><span>    </span><span class="annot"><span class="annottext">Certificate -&gt; [Blob] -&gt; IO Blob
forall a.
(HasCallStack, CertVal a) =&gt;
Certificate -&gt; [Blob] -&gt; IO a
</span><a href="IC.Test.Agent.html#certValue"><span class="hs-identifier hs-var">certValue</span></a></span><span> </span><span class="annot"><span class="annottext">Certificate
</span><a href="#local-6989586621679325138"><span class="hs-identifier hs-var">cert</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-string">&quot;subnet&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Delegation -&gt; Blob
</span><a href="IC.Certificate.html#del_subnet_id"><span class="hs-identifier hs-var hs-var">del_subnet_id</span></a></span><span> </span><span class="annot"><span class="annottext">Delegation
</span><a href="#local-6989586621679325139"><span class="hs-identifier hs-var">del</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;public_key&quot;</span></span><span class="hs-special">]</span><span>
</span><span id="line-379"></span><span>
</span><span id="line-380"></span><span class="annot"><a href="IC.Test.Agent.html#validateStateCert%27"><span class="hs-identifier hs-type">validateStateCert'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#HasAgentConfig"><span class="hs-identifier hs-type">HasAgentConfig</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Certificate.html#Certificate"><span class="hs-identifier hs-type">Certificate</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-381"></span><span id="validateStateCert%27"><span class="annot"><span class="annottext">validateStateCert' :: String -&gt; Certificate -&gt; IO ()
</span><a href="IC.Test.Agent.html#validateStateCert%27"><span class="hs-identifier hs-var hs-var">validateStateCert'</span></a></span></span><span> </span><span id="local-6989586621679325133"><span class="annot"><span class="annottext">what :: String
</span><a href="#local-6989586621679325133"><span class="hs-identifier hs-var">what</span></a></span></span><span> </span><span id="local-6989586621679325132"><span class="annot"><span class="annottext">cert :: Certificate
</span><a href="#local-6989586621679325132"><span class="hs-identifier hs-var">cert</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-382"></span><span>    </span><span id="local-6989586621679325131"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679325131"><span class="hs-identifier hs-var">pk</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(HasCallStack, HasAgentConfig) =&gt; Maybe Delegation -&gt; IO Blob
Maybe Delegation -&gt; IO Blob
</span><a href="IC.Test.Agent.html#validateDelegation"><span class="hs-identifier hs-var">validateDelegation</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Certificate -&gt; Maybe Delegation
</span><a href="IC.Certificate.html#cert_delegation"><span class="hs-identifier hs-var hs-var">cert_delegation</span></a></span><span> </span><span class="annot"><span class="annottext">Certificate
</span><a href="#local-6989586621679325132"><span class="hs-identifier hs-var">cert</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-383"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; Blob -&gt; Blob -&gt; Blob -&gt; Blob -&gt; IO ()
</span><a href="IC.Test.Agent.html#verboseVerify"><span class="hs-identifier hs-var">verboseVerify</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679325133"><span class="hs-identifier hs-var">what</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;ic-state-root&quot;</span></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679325131"><span class="hs-identifier hs-var">pk</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashTree -&gt; Blob
</span><a href="IC.HashTree.html#reconstruct"><span class="hs-identifier hs-var">reconstruct</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Certificate -&gt; HashTree
</span><a href="IC.Certificate.html#cert_tree"><span class="hs-identifier hs-var hs-var">cert_tree</span></a></span><span> </span><span class="annot"><span class="annottext">Certificate
</span><a href="#local-6989586621679325132"><span class="hs-identifier hs-var">cert</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Certificate -&gt; Blob
</span><a href="IC.Certificate.html#cert_sig"><span class="hs-identifier hs-var hs-var">cert_sig</span></a></span><span> </span><span class="annot"><span class="annottext">Certificate
</span><a href="#local-6989586621679325132"><span class="hs-identifier hs-var">cert</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-384"></span><span>
</span><span id="line-385"></span><span class="annot"><a href="IC.Test.Agent.html#validateStateCert"><span class="hs-identifier hs-type">validateStateCert</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#HasAgentConfig"><span class="hs-identifier hs-type">HasAgentConfig</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Certificate.html#Certificate"><span class="hs-identifier hs-type">Certificate</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-386"></span><span id="validateStateCert"><span class="annot"><span class="annottext">validateStateCert :: Certificate -&gt; IO ()
</span><a href="IC.Test.Agent.html#validateStateCert"><span class="hs-identifier hs-var hs-var">validateStateCert</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(HasCallStack, HasAgentConfig) =&gt; String -&gt; Certificate -&gt; IO ()
String -&gt; Certificate -&gt; IO ()
</span><a href="IC.Test.Agent.html#validateStateCert%27"><span class="hs-identifier hs-var">validateStateCert'</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;certificate&quot;</span></span><span>
</span><span id="line-387"></span><span>
</span><span id="line-388"></span><span class="hs-keyword">data</span><span> </span><span id="ReqResponse"><span class="annot"><a href="IC.Test.Agent.html#ReqResponse"><span class="hs-identifier hs-var">ReqResponse</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Reply"><span class="annot"><a href="IC.Test.Agent.html#Reply"><span class="hs-identifier hs-var">Reply</span></a></span></span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="Reject"><span class="annot"><a href="IC.Test.Agent.html#Reject"><span class="hs-identifier hs-var">Reject</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Natural</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">T.Text</span></span><span>
</span><span id="line-389"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679325121"><span id="local-6989586621679325123"><span class="annot"><span class="annottext">ReqResponse -&gt; ReqResponse -&gt; Bool
(ReqResponse -&gt; ReqResponse -&gt; Bool)
-&gt; (ReqResponse -&gt; ReqResponse -&gt; Bool) -&gt; Eq ReqResponse
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: ReqResponse -&gt; ReqResponse -&gt; Bool
$c/= :: ReqResponse -&gt; ReqResponse -&gt; Bool
== :: ReqResponse -&gt; ReqResponse -&gt; Bool
$c== :: ReqResponse -&gt; ReqResponse -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679325114"><span id="local-6989586621679325116"><span id="local-6989586621679325118"><span class="annot"><span class="annottext">Int -&gt; ReqResponse -&gt; String -&gt; String
[ReqResponse] -&gt; String -&gt; String
ReqResponse -&gt; String
(Int -&gt; ReqResponse -&gt; String -&gt; String)
-&gt; (ReqResponse -&gt; String)
-&gt; ([ReqResponse] -&gt; String -&gt; String)
-&gt; Show ReqResponse
forall a.
(Int -&gt; a -&gt; String -&gt; String)
-&gt; (a -&gt; String) -&gt; ([a] -&gt; String -&gt; String) -&gt; Show a
showList :: [ReqResponse] -&gt; String -&gt; String
$cshowList :: [ReqResponse] -&gt; String -&gt; String
show :: ReqResponse -&gt; String
$cshow :: ReqResponse -&gt; String
showsPrec :: Int -&gt; ReqResponse -&gt; String -&gt; String
$cshowsPrec :: Int -&gt; ReqResponse -&gt; String -&gt; String
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-390"></span><span class="hs-keyword">data</span><span> </span><span id="ReqStatus"><span class="annot"><a href="IC.Test.Agent.html#ReqStatus"><span class="hs-identifier hs-var">ReqStatus</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Processing"><span class="annot"><a href="IC.Test.Agent.html#Processing"><span class="hs-identifier hs-var">Processing</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="Pending"><span class="annot"><a href="IC.Test.Agent.html#Pending"><span class="hs-identifier hs-var">Pending</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="Responded"><span class="annot"><a href="IC.Test.Agent.html#Responded"><span class="hs-identifier hs-var">Responded</span></a></span></span><span> </span><span class="annot"><a href="IC.Test.Agent.html#ReqResponse"><span class="hs-identifier hs-type">ReqResponse</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="UnknownStatus"><span class="annot"><a href="IC.Test.Agent.html#UnknownStatus"><span class="hs-identifier hs-var">UnknownStatus</span></a></span></span><span>
</span><span id="line-391"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679325105"><span id="local-6989586621679325107"><span class="annot"><span class="annottext">ReqStatus -&gt; ReqStatus -&gt; Bool
(ReqStatus -&gt; ReqStatus -&gt; Bool)
-&gt; (ReqStatus -&gt; ReqStatus -&gt; Bool) -&gt; Eq ReqStatus
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: ReqStatus -&gt; ReqStatus -&gt; Bool
$c/= :: ReqStatus -&gt; ReqStatus -&gt; Bool
== :: ReqStatus -&gt; ReqStatus -&gt; Bool
$c== :: ReqStatus -&gt; ReqStatus -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679325099"><span id="local-6989586621679325101"><span id="local-6989586621679325103"><span class="annot"><span class="annottext">Int -&gt; ReqStatus -&gt; String -&gt; String
[ReqStatus] -&gt; String -&gt; String
ReqStatus -&gt; String
(Int -&gt; ReqStatus -&gt; String -&gt; String)
-&gt; (ReqStatus -&gt; String)
-&gt; ([ReqStatus] -&gt; String -&gt; String)
-&gt; Show ReqStatus
forall a.
(Int -&gt; a -&gt; String -&gt; String)
-&gt; (a -&gt; String) -&gt; ([a] -&gt; String -&gt; String) -&gt; Show a
showList :: [ReqStatus] -&gt; String -&gt; String
$cshowList :: [ReqStatus] -&gt; String -&gt; String
show :: ReqStatus -&gt; String
$cshow :: ReqStatus -&gt; String
showsPrec :: Int -&gt; ReqStatus -&gt; String -&gt; String
$cshowsPrec :: Int -&gt; ReqStatus -&gt; String -&gt; String
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-392"></span><span>
</span><span id="line-393"></span><span class="annot"><a href="IC.Test.Agent.html#prettyPath"><span class="hs-identifier hs-type">prettyPath</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-394"></span><span id="prettyPath"><span class="annot"><span class="annottext">prettyPath :: [Blob] -&gt; String
</span><a href="IC.Test.Agent.html#prettyPath"><span class="hs-identifier hs-var hs-var">prettyPath</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Blob -&gt; String) -&gt; [Blob] -&gt; String
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="hs-string">&quot;/&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(String -&gt; String) -&gt; (Blob -&gt; String) -&gt; Blob -&gt; String
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; String -&gt; String
</span><a href="IC.Test.Agent.html#shorten"><span class="hs-identifier hs-var">shorten</span></a></span><span> </span><span class="annot"><span class="hs-number">15</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; String) -&gt; (Blob -&gt; String) -&gt; Blob -&gt; String
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; String
</span><a href="IC.Test.Agent.html#prettyBlob"><span class="hs-identifier hs-var">prettyBlob</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-395"></span><span>
</span><span id="line-396"></span><span class="annot"><a href="IC.Test.Agent.html#prettyBlob"><span class="hs-identifier hs-type">prettyBlob</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-397"></span><span id="prettyBlob"><span class="annot"><span class="annottext">prettyBlob :: Blob -&gt; String
</span><a href="IC.Test.Agent.html#prettyBlob"><span class="hs-identifier hs-var hs-var">prettyBlob</span></a></span></span><span> </span><span id="local-6989586621679325095"><span class="annot"><span class="annottext">x :: Blob
</span><a href="#local-6989586621679325095"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-398"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679325094"><span class="annot"><span class="annottext">s :: String
</span><a href="#local-6989586621679325094"><span class="hs-identifier hs-var hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Word8 -&gt; Char) -&gt; [Word8] -&gt; String
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Char
</span><span class="hs-identifier hs-var">chr</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Char) -&gt; (Word8 -&gt; Int) -&gt; Word8 -&gt; Char
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Word8 -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Blob -&gt; [Word8]
</span><span class="hs-identifier hs-var">BS.unpack</span></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679325095"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">in</span><span>
</span><span id="line-399"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">(Char -&gt; Bool) -&gt; String -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="annot"><span class="annottext">Char -&gt; Bool
</span><span class="hs-identifier hs-var">isPrint</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679325094"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679325094"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Blob -&gt; String
</span><a href="IC.Test.Agent.html#asHex"><span class="hs-identifier hs-var">asHex</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679325095"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-400"></span><span>
</span><span id="line-401"></span><span id="local-6989586621679325512"><span class="annot"><a href="IC.Test.Agent.html#certValue"><span class="hs-identifier hs-type">certValue</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Certificate.Value.html#CertVal"><span class="hs-identifier hs-type">CertVal</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679325512"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Certificate.html#Certificate"><span class="hs-identifier hs-type">Certificate</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679325512"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-402"></span><span id="certValue"><span class="annot"><span class="annottext">certValue :: Certificate -&gt; [Blob] -&gt; IO a
</span><a href="IC.Test.Agent.html#certValue"><span class="hs-identifier hs-var hs-var">certValue</span></a></span></span><span> </span><span id="local-6989586621679325089"><span class="annot"><span class="annottext">cert :: Certificate
</span><a href="#local-6989586621679325089"><span class="hs-identifier hs-var">cert</span></a></span></span><span> </span><span id="local-6989586621679325088"><span class="annot"><span class="annottext">path :: [Blob]
</span><a href="#local-6989586621679325088"><span class="hs-identifier hs-var">path</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">HashTree -&gt; [Blob] -&gt; Res
</span><a href="IC.HashTree.html#lookupPath"><span class="hs-identifier hs-var">lookupPath</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Certificate -&gt; HashTree
</span><a href="IC.Certificate.html#cert_tree"><span class="hs-identifier hs-var hs-var">cert_tree</span></a></span><span> </span><span class="annot"><span class="annottext">Certificate
</span><a href="#local-6989586621679325089"><span class="hs-identifier hs-var">cert</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Blob]
</span><a href="#local-6989586621679325088"><span class="hs-identifier hs-var">path</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-403"></span><span>    </span><span class="annot"><a href="IC.HashTree.html#Found"><span class="hs-identifier hs-type">Found</span></a></span><span> </span><span id="local-6989586621679325085"><span class="annot"><span class="annottext">b :: Blob
</span><a href="#local-6989586621679325085"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Blob -&gt; Maybe a
forall a. CertVal a =&gt; Blob -&gt; Maybe a
</span><a href="IC.Certificate.Value.html#fromCertVal"><span class="hs-identifier hs-var">fromCertVal</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679325085"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-404"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679325083"><span class="annot"><span class="annottext">x :: a
</span><a href="#local-6989586621679325083"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679325083"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-405"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; IO a
forall a. HasCallStack =&gt; String -&gt; IO a
</span><span class="hs-identifier hs-var">assertFailure</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; IO a) -&gt; String -&gt; IO a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Cannot parse &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Blob] -&gt; String
</span><a href="IC.Test.Agent.html#prettyPath"><span class="hs-identifier hs-var">prettyPath</span></a></span><span> </span><span class="annot"><span class="annottext">[Blob]
</span><a href="#local-6989586621679325088"><span class="hs-identifier hs-var">path</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="hs-string">&quot; from &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679325085"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-406"></span><span>    </span><span id="local-6989586621679325082"><span class="annot"><span class="annottext">x :: Res
</span><a href="#local-6989586621679325082"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; IO a
forall a. HasCallStack =&gt; String -&gt; IO a
</span><span class="hs-identifier hs-var">assertFailure</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; IO a) -&gt; String -&gt; IO a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Expected to find &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Blob] -&gt; String
</span><a href="IC.Test.Agent.html#prettyPath"><span class="hs-identifier hs-var">prettyPath</span></a></span><span> </span><span class="annot"><span class="annottext">[Blob]
</span><a href="#local-6989586621679325088"><span class="hs-identifier hs-var">path</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="hs-string">&quot;, but got &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Res -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Res
</span><a href="#local-6989586621679325082"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-407"></span><span>
</span><span id="line-408"></span><span class="annot"><a href="IC.Test.Agent.html#certValueAbsent"><span class="hs-identifier hs-type">certValueAbsent</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Certificate.html#Certificate"><span class="hs-identifier hs-type">Certificate</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-409"></span><span id="certValueAbsent"><span class="annot"><span class="annottext">certValueAbsent :: Certificate -&gt; [Blob] -&gt; IO ()
</span><a href="IC.Test.Agent.html#certValueAbsent"><span class="hs-identifier hs-var hs-var">certValueAbsent</span></a></span></span><span> </span><span id="local-6989586621679325080"><span class="annot"><span class="annottext">cert :: Certificate
</span><a href="#local-6989586621679325080"><span class="hs-identifier hs-var">cert</span></a></span></span><span> </span><span id="local-6989586621679325079"><span class="annot"><span class="annottext">path :: [Blob]
</span><a href="#local-6989586621679325079"><span class="hs-identifier hs-var">path</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">HashTree -&gt; [Blob] -&gt; Res
</span><a href="IC.HashTree.html#lookupPath"><span class="hs-identifier hs-var">lookupPath</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Certificate -&gt; HashTree
</span><a href="IC.Certificate.html#cert_tree"><span class="hs-identifier hs-var hs-var">cert_tree</span></a></span><span> </span><span class="annot"><span class="annottext">Certificate
</span><a href="#local-6989586621679325080"><span class="hs-identifier hs-var">cert</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Blob]
</span><a href="#local-6989586621679325079"><span class="hs-identifier hs-var">path</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-410"></span><span>    </span><span class="annot"><a href="IC.HashTree.html#Absent"><span class="hs-identifier hs-type">Absent</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-411"></span><span>    </span><span id="local-6989586621679325077"><span class="annot"><span class="annottext">x :: Res
</span><a href="#local-6989586621679325077"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; IO ()
forall a. HasCallStack =&gt; String -&gt; IO a
</span><span class="hs-identifier hs-var">assertFailure</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; IO ()) -&gt; String -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Path &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Blob] -&gt; String
</span><a href="IC.Test.Agent.html#prettyPath"><span class="hs-identifier hs-var">prettyPath</span></a></span><span> </span><span class="annot"><span class="annottext">[Blob]
</span><a href="#local-6989586621679325079"><span class="hs-identifier hs-var">path</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="hs-string">&quot; should be absent, but got &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Res -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Res
</span><a href="#local-6989586621679325077"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-412"></span><span>
</span><span id="line-413"></span><span class="annot"><a href="IC.Test.Agent.html#getRequestStatus"><span class="hs-identifier hs-type">getRequestStatus</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#HasAgentConfig"><span class="hs-identifier hs-type">HasAgentConfig</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="IC.Test.Agent.html#ReqStatus"><span class="hs-identifier hs-type">ReqStatus</span></a></span><span>
</span><span id="line-414"></span><span id="getRequestStatus"><span class="annot"><span class="annottext">getRequestStatus :: Blob -&gt; Blob -&gt; Blob -&gt; IO ReqStatus
</span><a href="IC.Test.Agent.html#getRequestStatus"><span class="hs-identifier hs-var hs-var">getRequestStatus</span></a></span></span><span> </span><span id="local-6989586621679325075"><span class="annot"><span class="annottext">sender :: Blob
</span><a href="#local-6989586621679325075"><span class="hs-identifier hs-var">sender</span></a></span></span><span> </span><span id="local-6989586621679325074"><span class="annot"><span class="annottext">cid :: Blob
</span><a href="#local-6989586621679325074"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span id="local-6989586621679325073"><span class="annot"><span class="annottext">rid :: Blob
</span><a href="#local-6989586621679325073"><span class="hs-identifier hs-var">rid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-415"></span><span>    </span><span id="local-6989586621679325072"><span class="annot"><span class="annottext">Certificate
</span><a href="#local-6989586621679325072"><span class="hs-identifier hs-var">cert</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(HasCallStack, HasAgentConfig) =&gt;
Blob -&gt; Blob -&gt; [[Blob]] -&gt; IO Certificate
Blob -&gt; Blob -&gt; [[Blob]] -&gt; IO Certificate
</span><a href="IC.Test.Agent.html#getStateCert"><span class="hs-identifier hs-var">getStateCert</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679325075"><span class="hs-identifier hs-var">sender</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679325074"><span class="hs-identifier hs-var">cid</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="annot"><span class="hs-string">&quot;request_status&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679325073"><span class="hs-identifier hs-var">rid</span></a></span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><span id="line-416"></span><span>
</span><span id="line-417"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">HashTree -&gt; [Blob] -&gt; Res
</span><a href="IC.HashTree.html#lookupPath"><span class="hs-identifier hs-var">lookupPath</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Certificate -&gt; HashTree
</span><a href="IC.Certificate.html#cert_tree"><span class="hs-identifier hs-var hs-var">cert_tree</span></a></span><span> </span><span class="annot"><span class="annottext">Certificate
</span><a href="#local-6989586621679325072"><span class="hs-identifier hs-var">cert</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-string">&quot;request_status&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679325073"><span class="hs-identifier hs-var">rid</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;status&quot;</span></span><span class="hs-special">]</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-418"></span><span>      </span><span class="annot"><a href="IC.HashTree.html#Absent"><span class="hs-identifier hs-type">Absent</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ReqStatus -&gt; IO ReqStatus
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">ReqStatus
</span><a href="IC.Test.Agent.html#UnknownStatus"><span class="hs-identifier hs-var">UnknownStatus</span></a></span><span>
</span><span id="line-419"></span><span>      </span><span class="annot"><a href="IC.HashTree.html#Found"><span class="hs-identifier hs-type">Found</span></a></span><span> </span><span class="hs-string">&quot;processing&quot;</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ReqStatus -&gt; IO ReqStatus
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">ReqStatus
</span><a href="IC.Test.Agent.html#Processing"><span class="hs-identifier hs-var">Processing</span></a></span><span>
</span><span id="line-420"></span><span>      </span><span class="annot"><a href="IC.HashTree.html#Found"><span class="hs-identifier hs-type">Found</span></a></span><span> </span><span class="hs-string">&quot;received&quot;</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ReqStatus -&gt; IO ReqStatus
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">ReqStatus
</span><a href="IC.Test.Agent.html#Pending"><span class="hs-identifier hs-var">Pending</span></a></span><span>
</span><span id="line-421"></span><span>      </span><span class="annot"><a href="IC.HashTree.html#Found"><span class="hs-identifier hs-type">Found</span></a></span><span> </span><span class="hs-string">&quot;replied&quot;</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-422"></span><span>        </span><span id="local-6989586621679325071"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679325071"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Certificate -&gt; [Blob] -&gt; IO Blob
forall a.
(HasCallStack, CertVal a) =&gt;
Certificate -&gt; [Blob] -&gt; IO a
</span><a href="IC.Test.Agent.html#certValue"><span class="hs-identifier hs-var">certValue</span></a></span><span> </span><span class="annot"><span class="annottext">Certificate
</span><a href="#local-6989586621679325072"><span class="hs-identifier hs-var">cert</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-string">&quot;request_status&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679325073"><span class="hs-identifier hs-var">rid</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;reply&quot;</span></span><span class="hs-special">]</span><span>
</span><span id="line-423"></span><span>        </span><span class="annot"><span class="annottext">HasCallStack =&gt; Certificate -&gt; [Blob] -&gt; IO ()
Certificate -&gt; [Blob] -&gt; IO ()
</span><a href="IC.Test.Agent.html#certValueAbsent"><span class="hs-identifier hs-var">certValueAbsent</span></a></span><span> </span><span class="annot"><span class="annottext">Certificate
</span><a href="#local-6989586621679325072"><span class="hs-identifier hs-var">cert</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-string">&quot;request_status&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679325073"><span class="hs-identifier hs-var">rid</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;reject_code&quot;</span></span><span class="hs-special">]</span><span>
</span><span id="line-424"></span><span>        </span><span class="annot"><span class="annottext">HasCallStack =&gt; Certificate -&gt; [Blob] -&gt; IO ()
Certificate -&gt; [Blob] -&gt; IO ()
</span><a href="IC.Test.Agent.html#certValueAbsent"><span class="hs-identifier hs-var">certValueAbsent</span></a></span><span> </span><span class="annot"><span class="annottext">Certificate
</span><a href="#local-6989586621679325072"><span class="hs-identifier hs-var">cert</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-string">&quot;request_status&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679325073"><span class="hs-identifier hs-var">rid</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;reject_message&quot;</span></span><span class="hs-special">]</span><span>
</span><span id="line-425"></span><span>        </span><span class="annot"><span class="annottext">ReqStatus -&gt; IO ReqStatus
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(ReqStatus -&gt; IO ReqStatus) -&gt; ReqStatus -&gt; IO ReqStatus
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ReqResponse -&gt; ReqStatus
</span><a href="IC.Test.Agent.html#Responded"><span class="hs-identifier hs-var">Responded</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Blob -&gt; ReqResponse
</span><a href="IC.Test.Agent.html#Reply"><span class="hs-identifier hs-var">Reply</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679325071"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-426"></span><span>      </span><span class="annot"><a href="IC.HashTree.html#Found"><span class="hs-identifier hs-type">Found</span></a></span><span> </span><span class="hs-string">&quot;rejected&quot;</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-427"></span><span>        </span><span class="annot"><span class="annottext">HasCallStack =&gt; Certificate -&gt; [Blob] -&gt; IO ()
Certificate -&gt; [Blob] -&gt; IO ()
</span><a href="IC.Test.Agent.html#certValueAbsent"><span class="hs-identifier hs-var">certValueAbsent</span></a></span><span> </span><span class="annot"><span class="annottext">Certificate
</span><a href="#local-6989586621679325072"><span class="hs-identifier hs-var">cert</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-string">&quot;request_status&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679325073"><span class="hs-identifier hs-var">rid</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;reply&quot;</span></span><span class="hs-special">]</span><span>
</span><span id="line-428"></span><span>        </span><span id="local-6989586621679325070"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679325070"><span class="hs-identifier hs-var">code</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Certificate -&gt; [Blob] -&gt; IO Natural
forall a.
(HasCallStack, CertVal a) =&gt;
Certificate -&gt; [Blob] -&gt; IO a
</span><a href="IC.Test.Agent.html#certValue"><span class="hs-identifier hs-var">certValue</span></a></span><span> </span><span class="annot"><span class="annottext">Certificate
</span><a href="#local-6989586621679325072"><span class="hs-identifier hs-var">cert</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-string">&quot;request_status&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679325073"><span class="hs-identifier hs-var">rid</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;reject_code&quot;</span></span><span class="hs-special">]</span><span>
</span><span id="line-429"></span><span>        </span><span id="local-6989586621679325069"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679325069"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Certificate -&gt; [Blob] -&gt; IO Text
forall a.
(HasCallStack, CertVal a) =&gt;
Certificate -&gt; [Blob] -&gt; IO a
</span><a href="IC.Test.Agent.html#certValue"><span class="hs-identifier hs-var">certValue</span></a></span><span> </span><span class="annot"><span class="annottext">Certificate
</span><a href="#local-6989586621679325072"><span class="hs-identifier hs-var">cert</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-string">&quot;request_status&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679325073"><span class="hs-identifier hs-var">rid</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;reject_message&quot;</span></span><span class="hs-special">]</span><span>
</span><span id="line-430"></span><span>        </span><span class="annot"><span class="annottext">ReqStatus -&gt; IO ReqStatus
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(ReqStatus -&gt; IO ReqStatus) -&gt; ReqStatus -&gt; IO ReqStatus
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ReqResponse -&gt; ReqStatus
</span><a href="IC.Test.Agent.html#Responded"><span class="hs-identifier hs-var">Responded</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Natural -&gt; Text -&gt; ReqResponse
</span><a href="IC.Test.Agent.html#Reject"><span class="hs-identifier hs-var">Reject</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679325070"><span class="hs-identifier hs-var">code</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679325069"><span class="hs-identifier hs-var">msg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-431"></span><span>      </span><span class="annot"><a href="IC.HashTree.html#Found"><span class="hs-identifier hs-type">Found</span></a></span><span> </span><span id="local-6989586621679325068"><span class="annot"><span class="annottext">s :: Blob
</span><a href="#local-6989586621679325068"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; IO ReqStatus
forall a. HasCallStack =&gt; String -&gt; IO a
</span><span class="hs-identifier hs-var">assertFailure</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; IO ReqStatus) -&gt; String -&gt; IO ReqStatus
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Unexpected status &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679325068"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-432"></span><span>      </span><span class="hs-comment">-- This case should not happen with a compliant IC, but let</span><span>
</span><span id="line-433"></span><span>      </span><span class="hs-comment">-- us be liberal here, and strict in a dedicated test</span><span>
</span><span id="line-434"></span><span>      </span><span class="annot"><a href="IC.HashTree.html#Unknown"><span class="hs-identifier hs-type">Unknown</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ReqStatus -&gt; IO ReqStatus
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">ReqStatus
</span><a href="IC.Test.Agent.html#UnknownStatus"><span class="hs-identifier hs-var">UnknownStatus</span></a></span><span>
</span><span id="line-435"></span><span>      </span><span id="local-6989586621679325066"><span class="annot"><span class="annottext">x :: Res
</span><a href="#local-6989586621679325066"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; IO ReqStatus
forall a. HasCallStack =&gt; String -&gt; IO a
</span><span class="hs-identifier hs-var">assertFailure</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; IO ReqStatus) -&gt; String -&gt; IO ReqStatus
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Unexpected request status, got &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Res -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Res
</span><a href="#local-6989586621679325066"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-436"></span><span>
</span><span id="line-437"></span><span class="annot"><a href="IC.Test.Agent.html#awaitStatus"><span class="hs-identifier hs-type">awaitStatus</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#HasAgentConfig"><span class="hs-identifier hs-type">HasAgentConfig</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="IC.Test.Agent.html#ReqResponse"><span class="hs-identifier hs-type">ReqResponse</span></a></span><span>
</span><span id="line-438"></span><span id="awaitStatus"><span class="annot"><span class="annottext">awaitStatus :: Blob -&gt; Blob -&gt; Blob -&gt; IO ReqResponse
</span><a href="IC.Test.Agent.html#awaitStatus"><span class="hs-identifier hs-var hs-var">awaitStatus</span></a></span></span><span> </span><span id="local-6989586621679325065"><span class="annot"><span class="annottext">sender :: Blob
</span><a href="#local-6989586621679325065"><span class="hs-identifier hs-var">sender</span></a></span></span><span> </span><span id="local-6989586621679325064"><span class="annot"><span class="annottext">cid :: Blob
</span><a href="#local-6989586621679325064"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span id="local-6989586621679325063"><span class="annot"><span class="annottext">rid :: Blob
</span><a href="#local-6989586621679325063"><span class="hs-identifier hs-var">rid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO (Maybe ReqResponse) -&gt; IO ReqResponse
forall a. HasCallStack =&gt; IO (Maybe a) -&gt; IO a
</span><a href="#local-6989586621679325062"><span class="hs-identifier hs-var">loop</span></a></span><span> </span><span class="annot"><span class="annottext">(IO (Maybe ReqResponse) -&gt; IO ReqResponse)
-&gt; IO (Maybe ReqResponse) -&gt; IO ReqResponse
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="IC.Test.Agent.html#pollDelay"><span class="hs-identifier hs-var">pollDelay</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO ReqStatus -&gt; IO ReqStatus
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">(HasCallStack, HasAgentConfig) =&gt;
Blob -&gt; Blob -&gt; Blob -&gt; IO ReqStatus
Blob -&gt; Blob -&gt; Blob -&gt; IO ReqStatus
</span><a href="IC.Test.Agent.html#getRequestStatus"><span class="hs-identifier hs-var">getRequestStatus</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679325065"><span class="hs-identifier hs-var">sender</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679325064"><span class="hs-identifier hs-var">cid</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679325063"><span class="hs-identifier hs-var">rid</span></a></span><span> </span><span class="annot"><span class="annottext">IO ReqStatus
-&gt; (ReqStatus -&gt; IO (Maybe ReqResponse)) -&gt; IO (Maybe ReqResponse)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-439"></span><span>    </span><span class="annot"><a href="IC.Test.Agent.html#Responded"><span class="hs-identifier hs-type">Responded</span></a></span><span> </span><span id="local-6989586621679325060"><span class="annot"><span class="annottext">x :: ReqResponse
</span><a href="#local-6989586621679325060"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe ReqResponse -&gt; IO (Maybe ReqResponse)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe ReqResponse -&gt; IO (Maybe ReqResponse))
-&gt; Maybe ReqResponse -&gt; IO (Maybe ReqResponse)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ReqResponse -&gt; Maybe ReqResponse
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">ReqResponse
</span><a href="#local-6989586621679325060"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-440"></span><span>    </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe ReqResponse -&gt; IO (Maybe ReqResponse)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe ReqResponse
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-441"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-442"></span><span>    </span><span id="local-6989586621679325497"><span class="annot"><a href="#local-6989586621679325062"><span class="hs-identifier hs-type">loop</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621679325497"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679325497"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-443"></span><span>    </span><span id="local-6989586621679325062"><span class="annot"><span class="annottext">loop :: IO (Maybe a) -&gt; IO a
</span><a href="#local-6989586621679325062"><span class="hs-identifier hs-var hs-var">loop</span></a></span></span><span> </span><span id="local-6989586621679325059"><span class="annot"><span class="annottext">act :: IO (Maybe a)
</span><a href="#local-6989586621679325059"><span class="hs-identifier hs-var">act</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; IO a
</span><a href="#local-6989586621679325058"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-number">0</span></span><span class="hs-glyph">::</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span>
</span><span id="line-444"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-445"></span><span>        </span><span id="local-6989586621679325058"><span class="annot"><span class="annottext">go :: Int -&gt; IO a
</span><a href="#local-6989586621679325058"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-number">10000</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; IO a
forall a. HasCallStack =&gt; String -&gt; IO a
</span><span class="hs-identifier hs-var">assertFailure</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Polling timed out&quot;</span></span><span>
</span><span id="line-446"></span><span>        </span><span class="annot"><a href="#local-6989586621679325058"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621679325057"><span class="annot"><span class="annottext">n :: Int
</span><a href="#local-6989586621679325057"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO (Maybe a)
</span><a href="#local-6989586621679325059"><span class="hs-identifier hs-var">act</span></a></span><span> </span><span class="annot"><span class="annottext">IO (Maybe a) -&gt; (Maybe a -&gt; IO a) -&gt; IO a
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-447"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679325056"><span class="annot"><span class="annottext">r :: a
</span><a href="#local-6989586621679325056"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679325056"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-448"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int -&gt; IO a
</span><a href="#local-6989586621679325058"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679325057"><span class="hs-identifier hs-var">n</span></a></span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span class="annot"><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-449"></span><span>
</span><span id="line-450"></span><span class="annot"><a href="IC.Test.Agent.html#pollDelay"><span class="hs-identifier hs-type">pollDelay</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-451"></span><span id="pollDelay"><span class="annot"><span class="annottext">pollDelay :: IO ()
</span><a href="IC.Test.Agent.html#pollDelay"><span class="hs-identifier hs-var hs-var">pollDelay</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; IO ()
</span><span class="hs-identifier hs-var">threadDelay</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; IO ()) -&gt; Int -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="hs-number">10</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="hs-number">1000</span></span><span> </span><span class="hs-comment">-- 10 milliseonds</span><span>
</span><span id="line-452"></span><span>
</span><span id="line-453"></span><span class="hs-comment">-- How long to wait before checking if a request that should _not_ show up on</span><span>
</span><span id="line-454"></span><span class="hs-comment">-- the system indeed did not show up</span><span>
</span><span id="line-455"></span><span class="annot"><a href="IC.Test.Agent.html#ingressDelay"><span class="hs-identifier hs-type">ingressDelay</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-456"></span><span id="ingressDelay"><span class="annot"><span class="annottext">ingressDelay :: IO ()
</span><a href="IC.Test.Agent.html#ingressDelay"><span class="hs-identifier hs-var hs-var">ingressDelay</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; IO ()
</span><span class="hs-identifier hs-var">threadDelay</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; IO ()) -&gt; Int -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="hs-number">2</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="hs-number">1000</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="hs-number">1000</span></span><span> </span><span class="hs-comment">-- 2 seconds</span><span>
</span><span id="line-457"></span><span>
</span><span id="line-458"></span><span>
</span><span id="line-459"></span><span class="hs-comment">-- * HTTP Response predicates</span><span>
</span><span id="line-460"></span><span>
</span><span id="line-461"></span><span class="annot"><a href="IC.Test.Agent.html#codePred"><span class="hs-identifier hs-type">codePred</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Response</span></span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-462"></span><span id="codePred"><span class="annot"><span class="annottext">codePred :: String -&gt; (Int -&gt; Bool) -&gt; Response Blob -&gt; IO ()
</span><a href="IC.Test.Agent.html#codePred"><span class="hs-identifier hs-var hs-var">codePred</span></a></span></span><span> </span><span id="local-6989586621679325052"><span class="annot"><span class="annottext">expt :: String
</span><a href="#local-6989586621679325052"><span class="hs-identifier hs-var">expt</span></a></span></span><span> </span><span id="local-6989586621679325051"><span class="annot"><span class="annottext">pred :: Int -&gt; Bool
</span><a href="#local-6989586621679325051"><span class="hs-identifier hs-var">pred</span></a></span></span><span> </span><span id="local-6989586621679325050"><span class="annot"><span class="annottext">response :: Response Blob
</span><a href="#local-6989586621679325050"><span class="hs-identifier hs-var">response</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; String -&gt; Bool -&gt; IO ()
String -&gt; Bool -&gt; IO ()
</span><span class="hs-identifier hs-var">assertBool</span></span><span>
</span><span id="line-463"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="hs-string">&quot;Status &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679325049"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="hs-string">&quot; is not &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679325052"><span class="hs-identifier hs-var">expt</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="hs-string">&quot;\n&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679325048"><span class="hs-identifier hs-var">msg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-464"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Bool
</span><a href="#local-6989586621679325051"><span class="hs-identifier hs-var">pred</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679325049"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-465"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-466"></span><span>    </span><span id="local-6989586621679325049"><span class="annot"><span class="annottext">c :: Int
</span><a href="#local-6989586621679325049"><span class="hs-identifier hs-var hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Status -&gt; Int
</span><span class="hs-identifier hs-var hs-var">statusCode</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Response Blob -&gt; Status
forall body. Response body -&gt; Status
</span><span class="hs-identifier hs-var hs-var">responseStatus</span></span><span> </span><span class="annot"><span class="annottext">Response Blob
</span><a href="#local-6989586621679325050"><span class="hs-identifier hs-var">response</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-467"></span><span>    </span><span id="local-6989586621679325048"><span class="annot"><span class="annottext">msg :: String
</span><a href="#local-6989586621679325048"><span class="hs-identifier hs-var hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; String
</span><span class="hs-identifier hs-var">T.unpack</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OnDecodeError -&gt; Method -&gt; Text
</span><span class="hs-identifier hs-var">T.decodeUtf8With</span></span><span> </span><span class="annot"><span class="annottext">OnDecodeError
</span><span class="hs-identifier hs-var">T.lenientDecode</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Blob -&gt; Method
</span><span class="hs-identifier hs-var">BS.toStrict</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int64 -&gt; Blob -&gt; Blob
</span><span class="hs-identifier hs-var">BS.take</span></span><span> </span><span class="annot"><span class="hs-number">200</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Response Blob -&gt; Blob
forall body. Response body -&gt; body
</span><span class="hs-identifier hs-var hs-var">responseBody</span></span><span> </span><span class="annot"><span class="annottext">Response Blob
</span><a href="#local-6989586621679325050"><span class="hs-identifier hs-var">response</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-468"></span><span>
</span><span id="line-469"></span><span class="annot"><a href="IC.Test.Agent.html#code2xx"><span class="hs-identifier hs-type">code2xx</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#code202"><span class="hs-identifier hs-type">code202</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#code4xx"><span class="hs-identifier hs-type">code4xx</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#code202_or_4xx"><span class="hs-identifier hs-type">code202_or_4xx</span></a></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Response</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">BS.ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-470"></span><span id="code2xx"><span class="annot"><span class="annottext">code2xx :: Response Blob -&gt; IO ()
</span><a href="IC.Test.Agent.html#code2xx"><span class="hs-identifier hs-var hs-var">code2xx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; String -&gt; (Int -&gt; Bool) -&gt; Response Blob -&gt; IO ()
String -&gt; (Int -&gt; Bool) -&gt; Response Blob -&gt; IO ()
</span><a href="IC.Test.Agent.html#codePred"><span class="hs-identifier hs-var">codePred</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;2xx&quot;</span></span><span> </span><span class="annot"><span class="annottext">((Int -&gt; Bool) -&gt; Response Blob -&gt; IO ())
-&gt; (Int -&gt; Bool) -&gt; Response Blob -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679325043"><span class="annot"><span class="annottext">c :: Int
</span><a href="#local-6989586621679325043"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-number">200</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679325043"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679325043"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="hs-number">300</span></span><span>
</span><span id="line-471"></span><span id="code202"><span class="annot"><span class="annottext">code202 :: Response Blob -&gt; IO ()
</span><a href="IC.Test.Agent.html#code202"><span class="hs-identifier hs-var hs-var">code202</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; String -&gt; (Int -&gt; Bool) -&gt; Response Blob -&gt; IO ()
String -&gt; (Int -&gt; Bool) -&gt; Response Blob -&gt; IO ()
</span><a href="IC.Test.Agent.html#codePred"><span class="hs-identifier hs-var">codePred</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;202&quot;</span></span><span> </span><span class="annot"><span class="annottext">((Int -&gt; Bool) -&gt; Response Blob -&gt; IO ())
-&gt; (Int -&gt; Bool) -&gt; Response Blob -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679325042"><span class="annot"><span class="annottext">c :: Int
</span><a href="#local-6989586621679325042"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679325042"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="hs-number">202</span></span><span>
</span><span id="line-472"></span><span id="code4xx"><span class="annot"><span class="annottext">code4xx :: Response Blob -&gt; IO ()
</span><a href="IC.Test.Agent.html#code4xx"><span class="hs-identifier hs-var hs-var">code4xx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; String -&gt; (Int -&gt; Bool) -&gt; Response Blob -&gt; IO ()
String -&gt; (Int -&gt; Bool) -&gt; Response Blob -&gt; IO ()
</span><a href="IC.Test.Agent.html#codePred"><span class="hs-identifier hs-var">codePred</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;4xx&quot;</span></span><span> </span><span class="annot"><span class="annottext">((Int -&gt; Bool) -&gt; Response Blob -&gt; IO ())
-&gt; (Int -&gt; Bool) -&gt; Response Blob -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679325041"><span class="annot"><span class="annottext">c :: Int
</span><a href="#local-6989586621679325041"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-number">400</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679325041"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679325041"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="hs-number">500</span></span><span>
</span><span id="line-473"></span><span id="code202_or_4xx"><span class="annot"><span class="annottext">code202_or_4xx :: Response Blob -&gt; IO ()
</span><a href="IC.Test.Agent.html#code202_or_4xx"><span class="hs-identifier hs-var hs-var">code202_or_4xx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; String -&gt; (Int -&gt; Bool) -&gt; Response Blob -&gt; IO ()
String -&gt; (Int -&gt; Bool) -&gt; Response Blob -&gt; IO ()
</span><a href="IC.Test.Agent.html#codePred"><span class="hs-identifier hs-var">codePred</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;202 or 4xx&quot;</span></span><span> </span><span class="annot"><span class="annottext">((Int -&gt; Bool) -&gt; Response Blob -&gt; IO ())
-&gt; (Int -&gt; Bool) -&gt; Response Blob -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679325040"><span class="annot"><span class="annottext">c :: Int
</span><a href="#local-6989586621679325040"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679325040"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="hs-number">202</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="hs-number">400</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679325040"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679325040"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="hs-number">500</span></span><span>
</span><span id="line-474"></span><span>
</span><span id="line-475"></span><span class="hs-comment">-- * CBOR decoding</span><span>
</span><span id="line-476"></span><span>
</span><span id="line-477"></span><span class="annot"><a href="IC.Test.Agent.html#okCBOR"><span class="hs-identifier hs-type">okCBOR</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Response</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">BS.ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="IC.HTTP.GenR.html#GenR"><span class="hs-identifier hs-type">GenR</span></a></span><span>
</span><span id="line-478"></span><span id="okCBOR"><span class="annot"><span class="annottext">okCBOR :: Response Blob -&gt; IO GenR
</span><a href="IC.Test.Agent.html#okCBOR"><span class="hs-identifier hs-var hs-var">okCBOR</span></a></span></span><span> </span><span id="local-6989586621679325038"><span class="annot"><span class="annottext">response :: Response Blob
</span><a href="#local-6989586621679325038"><span class="hs-identifier hs-var">response</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-479"></span><span>  </span><span class="annot"><span class="annottext">HasCallStack =&gt; Response Blob -&gt; IO ()
Response Blob -&gt; IO ()
</span><a href="IC.Test.Agent.html#code2xx"><span class="hs-identifier hs-var">code2xx</span></a></span><span> </span><span class="annot"><span class="annottext">Response Blob
</span><a href="#local-6989586621679325038"><span class="hs-identifier hs-var">response</span></a></span><span>
</span><span id="line-480"></span><span>  </span><span class="annot"><span class="annottext">Either Text GenR -&gt; IO GenR
forall a. HasCallStack =&gt; Either Text a -&gt; IO a
</span><a href="IC.Test.Agent.html#asRight"><span class="hs-identifier hs-var">asRight</span></a></span><span> </span><span class="annot"><span class="annottext">(Either Text GenR -&gt; IO GenR) -&gt; Either Text GenR -&gt; IO GenR
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; Either Text GenR
</span><a href="IC.HTTP.CBOR.html#decode"><span class="hs-identifier hs-var">decode</span></a></span><span> </span><span class="annot"><span class="annottext">(Blob -&gt; Either Text GenR) -&gt; Blob -&gt; Either Text GenR
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Response Blob -&gt; Blob
forall body. Response body -&gt; body
</span><span class="hs-identifier hs-var hs-var">responseBody</span></span><span> </span><span class="annot"><span class="annottext">Response Blob
</span><a href="#local-6989586621679325038"><span class="hs-identifier hs-var">response</span></a></span><span>
</span><span id="line-481"></span><span>
</span><span id="line-482"></span><span class="hs-comment">-- * Response predicates and parsers</span><span>
</span><span id="line-483"></span><span>
</span><span id="line-484"></span><span class="annot"><a href="IC.Test.Agent.html#queryResponse"><span class="hs-identifier hs-type">queryResponse</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.HTTP.GenR.html#GenR"><span class="hs-identifier hs-type">GenR</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="IC.Test.Agent.html#ReqResponse"><span class="hs-identifier hs-type">ReqResponse</span></a></span><span>
</span><span id="line-485"></span><span id="queryResponse"><span class="annot"><span class="annottext">queryResponse :: GenR -&gt; IO ReqResponse
</span><a href="IC.Test.Agent.html#queryResponse"><span class="hs-identifier hs-var hs-var">queryResponse</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExceptT Text IO ReqResponse -&gt; IO ReqResponse
forall a. HasCallStack =&gt; ExceptT Text IO a -&gt; IO a
</span><a href="IC.Test.Agent.html#asExceptT"><span class="hs-identifier hs-var">asExceptT</span></a></span><span> </span><span class="annot"><span class="annottext">(ExceptT Text IO ReqResponse -&gt; IO ReqResponse)
-&gt; (GenR -&gt; ExceptT Text IO ReqResponse) -&gt; GenR -&gt; IO ReqResponse
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">RecordM (ExceptT Text IO) ReqResponse
-&gt; GenR -&gt; ExceptT Text IO ReqResponse
forall (m :: * -&gt; *) a.
(HasCallStack, Parse m) =&gt;
RecordM m a -&gt; GenR -&gt; m a
</span><a href="IC.HTTP.GenR.Parse.html#record"><span class="hs-identifier hs-var">record</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-486"></span><span>    </span><span id="local-6989586621679325036"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679325036"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Field Text -&gt; Text -&gt; RecordM (ExceptT Text IO) Text
forall (m :: * -&gt; *) a.
(HasCallStack, Parse m) =&gt;
Field a -&gt; Text -&gt; RecordM m a
</span><a href="IC.HTTP.GenR.Parse.html#field"><span class="hs-identifier hs-var">field</span></a></span><span> </span><span class="annot"><span class="annottext">Field Text
</span><a href="IC.HTTP.GenR.Parse.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;status&quot;</span></span><span>
</span><span id="line-487"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679325036"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-488"></span><span>      </span><span class="hs-string">&quot;replied&quot;</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-489"></span><span>        </span><span class="annot"><span class="annottext">Blob -&gt; ReqResponse
</span><a href="IC.Test.Agent.html#Reply"><span class="hs-identifier hs-var">Reply</span></a></span><span> </span><span class="annot"><span class="annottext">(Blob -&gt; ReqResponse)
-&gt; RecordM (ExceptT Text IO) Blob
-&gt; RecordM (ExceptT Text IO) ReqResponse
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Field Blob -&gt; Text -&gt; RecordM (ExceptT Text IO) Blob
forall (m :: * -&gt; *) a.
(HasCallStack, Parse m) =&gt;
Field a -&gt; Text -&gt; RecordM m a
</span><a href="IC.HTTP.GenR.Parse.html#field"><span class="hs-identifier hs-var">field</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RecordM m Blob -&gt; GenR -&gt; m Blob
forall (m :: * -&gt; *) a.
(HasCallStack, Parse m) =&gt;
RecordM m a -&gt; GenR -&gt; m a
</span><a href="IC.HTTP.GenR.Parse.html#record"><span class="hs-identifier hs-var">record</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Field Blob -&gt; Text -&gt; RecordM m Blob
forall (m :: * -&gt; *) a.
(HasCallStack, Parse m) =&gt;
Field a -&gt; Text -&gt; RecordM m a
</span><a href="IC.HTTP.GenR.Parse.html#field"><span class="hs-identifier hs-var">field</span></a></span><span> </span><span class="annot"><span class="annottext">Field Blob
</span><a href="IC.HTTP.GenR.Parse.html#blob"><span class="hs-identifier hs-var">blob</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;arg&quot;</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-string">&quot;reply&quot;</span></span><span>
</span><span id="line-490"></span><span>      </span><span class="hs-string">&quot;rejected&quot;</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-491"></span><span>        </span><span id="local-6989586621679325034"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679325034"><span class="hs-identifier hs-var">code</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Field Natural -&gt; Text -&gt; RecordM (ExceptT Text IO) Natural
forall (m :: * -&gt; *) a.
(HasCallStack, Parse m) =&gt;
Field a -&gt; Text -&gt; RecordM m a
</span><a href="IC.HTTP.GenR.Parse.html#field"><span class="hs-identifier hs-var">field</span></a></span><span> </span><span class="annot"><span class="annottext">Field Natural
</span><a href="IC.HTTP.GenR.Parse.html#nat"><span class="hs-identifier hs-var">nat</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;reject_code&quot;</span></span><span>
</span><span id="line-492"></span><span>        </span><span id="local-6989586621679325032"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679325032"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Field Text -&gt; Text -&gt; RecordM (ExceptT Text IO) Text
forall (m :: * -&gt; *) a.
(HasCallStack, Parse m) =&gt;
Field a -&gt; Text -&gt; RecordM m a
</span><a href="IC.HTTP.GenR.Parse.html#field"><span class="hs-identifier hs-var">field</span></a></span><span> </span><span class="annot"><span class="annottext">Field Text
</span><a href="IC.HTTP.GenR.Parse.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;reject_message&quot;</span></span><span>
</span><span id="line-493"></span><span>        </span><span class="annot"><span class="annottext">ReqResponse -&gt; RecordM (ExceptT Text IO) ReqResponse
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(ReqResponse -&gt; RecordM (ExceptT Text IO) ReqResponse)
-&gt; ReqResponse -&gt; RecordM (ExceptT Text IO) ReqResponse
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; Text -&gt; ReqResponse
</span><a href="IC.Test.Agent.html#Reject"><span class="hs-identifier hs-var">Reject</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679325034"><span class="hs-identifier hs-var">code</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679325032"><span class="hs-identifier hs-var">msg</span></a></span><span>
</span><span id="line-494"></span><span>      </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ExceptT Text IO ReqResponse
-&gt; RecordM (ExceptT Text IO) ReqResponse
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(ExceptT Text IO ReqResponse
 -&gt; RecordM (ExceptT Text IO) ReqResponse)
-&gt; ExceptT Text IO ReqResponse
-&gt; RecordM (ExceptT Text IO) ReqResponse
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; ExceptT Text IO ReqResponse
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; ExceptT Text IO ReqResponse)
-&gt; Text -&gt; ExceptT Text IO ReqResponse
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Unexpected status &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">T.pack</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679325036"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-495"></span><span>
</span><span id="line-496"></span><span class="annot"><a href="IC.Test.Agent.html#isReject"><span class="hs-identifier hs-type">isReject</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Natural</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#ReqResponse"><span class="hs-identifier hs-type">ReqResponse</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-497"></span><span id="isReject"><span class="annot"><span class="annottext">isReject :: [Natural] -&gt; ReqResponse -&gt; IO ()
</span><a href="IC.Test.Agent.html#isReject"><span class="hs-identifier hs-var hs-var">isReject</span></a></span></span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Test.Agent.html#Reply"><span class="hs-identifier hs-type">Reply</span></a></span><span> </span><span id="local-6989586621679325027"><span class="annot"><span class="annottext">r :: Blob
</span><a href="#local-6989586621679325027"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-498"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; IO ()
forall a. HasCallStack =&gt; String -&gt; IO a
</span><span class="hs-identifier hs-var">assertFailure</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; IO ()) -&gt; String -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Expected reject, got reply:&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; String
</span><a href="IC.Test.Agent.html#prettyBlob"><span class="hs-identifier hs-var">prettyBlob</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679325027"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-499"></span><span class="annot"><a href="IC.Test.Agent.html#isReject"><span class="hs-identifier hs-var">isReject</span></a></span><span> </span><span id="local-6989586621679325026"><span class="annot"><span class="annottext">codes :: [Natural]
</span><a href="#local-6989586621679325026"><span class="hs-identifier hs-var">codes</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Test.Agent.html#Reject"><span class="hs-identifier hs-type">Reject</span></a></span><span> </span><span id="local-6989586621679325025"><span class="annot"><span class="annottext">n :: Natural
</span><a href="#local-6989586621679325025"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621679325024"><span class="annot"><span class="annottext">msg :: Text
</span><a href="#local-6989586621679325024"><span class="hs-identifier hs-var">msg</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-500"></span><span>  </span><span class="annot"><span class="annottext">HasCallStack =&gt; String -&gt; Bool -&gt; IO ()
String -&gt; Bool -&gt; IO ()
</span><span class="hs-identifier hs-var">assertBool</span></span><span>
</span><span id="line-501"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="hs-string">&quot;Reject code &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679325025"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="hs-string">&quot; not in &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Natural] -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">[Natural]
</span><a href="#local-6989586621679325026"><span class="hs-identifier hs-var">codes</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="hs-string">&quot;\n&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; String
</span><span class="hs-identifier hs-var">T.unpack</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679325024"><span class="hs-identifier hs-var">msg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-502"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679325025"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; [Natural] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="annot"><span class="annottext">[Natural]
</span><a href="#local-6989586621679325026"><span class="hs-identifier hs-var">codes</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-503"></span><span>
</span><span id="line-504"></span><span class="annot"><a href="IC.Test.Agent.html#isErrOrReject"><span class="hs-identifier hs-type">isErrOrReject</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Natural</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#HTTPErrOrReqResponse"><span class="hs-identifier hs-type">HTTPErrOrReqResponse</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-505"></span><span id="isErrOrReject"><span class="annot"><span class="annottext">isErrOrReject :: [Natural] -&gt; HTTPErrOrReqResponse -&gt; IO ()
</span><a href="IC.Test.Agent.html#isErrOrReject"><span class="hs-identifier hs-var hs-var">isErrOrReject</span></a></span></span><span> </span><span id="local-6989586621679325021"><span class="annot"><span class="annottext">_codes :: [Natural]
</span><a href="#local-6989586621679325021"><span class="hs-identifier hs-var">_codes</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679325020"><span class="annot"><span class="annottext">c :: Int
</span><a href="#local-6989586621679325020"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679325019"><span class="annot"><span class="annottext">msg :: String
</span><a href="#local-6989586621679325019"><span class="hs-identifier hs-var">msg</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-506"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-number">400</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679325020"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679325020"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="hs-number">600</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-507"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; IO ()
forall a. HasCallStack =&gt; String -&gt; IO a
</span><span class="hs-identifier hs-var">assertFailure</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; IO ()) -&gt; String -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-508"></span><span>        </span><span class="annot"><span class="hs-string">&quot;Status &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679325020"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="hs-string">&quot; is not 4xx or 5xx:\n&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679325019"><span class="hs-identifier hs-var">msg</span></a></span><span>
</span><span id="line-509"></span><span class="annot"><a href="IC.Test.Agent.html#isErrOrReject"><span class="hs-identifier hs-var">isErrOrReject</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; IO ()
forall a. HasCallStack =&gt; String -&gt; IO a
</span><span class="hs-identifier hs-var">assertFailure</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Got HTTP response, expected HTTP error&quot;</span></span><span>
</span><span id="line-510"></span><span class="annot"><a href="IC.Test.Agent.html#isErrOrReject"><span class="hs-identifier hs-var">isErrOrReject</span></a></span><span> </span><span id="local-6989586621679325018"><span class="annot"><span class="annottext">codes :: [Natural]
</span><a href="#local-6989586621679325018"><span class="hs-identifier hs-var">codes</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679325017"><span class="annot"><span class="annottext">res :: ReqResponse
</span><a href="#local-6989586621679325017"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; [Natural] -&gt; ReqResponse -&gt; IO ()
[Natural] -&gt; ReqResponse -&gt; IO ()
</span><a href="IC.Test.Agent.html#isReject"><span class="hs-identifier hs-var">isReject</span></a></span><span> </span><span class="annot"><span class="annottext">[Natural]
</span><a href="#local-6989586621679325018"><span class="hs-identifier hs-var">codes</span></a></span><span> </span><span class="annot"><span class="annottext">ReqResponse
</span><a href="#local-6989586621679325017"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-511"></span><span>
</span><span id="line-512"></span><span>
</span><span id="line-513"></span><span class="annot"><a href="IC.Test.Agent.html#isReply"><span class="hs-identifier hs-type">isReply</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#ReqResponse"><span class="hs-identifier hs-type">ReqResponse</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span>
</span><span id="line-514"></span><span id="isReply"><span class="annot"><span class="annottext">isReply :: ReqResponse -&gt; IO Blob
</span><a href="IC.Test.Agent.html#isReply"><span class="hs-identifier hs-var hs-var">isReply</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Test.Agent.html#Reply"><span class="hs-identifier hs-type">Reply</span></a></span><span> </span><span id="local-6989586621679325015"><span class="annot"><span class="annottext">b :: Blob
</span><a href="#local-6989586621679325015"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Blob -&gt; IO Blob
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679325015"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-515"></span><span class="annot"><a href="IC.Test.Agent.html#isReply"><span class="hs-identifier hs-var">isReply</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Test.Agent.html#Reject"><span class="hs-identifier hs-type">Reject</span></a></span><span> </span><span id="local-6989586621679325014"><span class="annot"><span class="annottext">n :: Natural
</span><a href="#local-6989586621679325014"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621679325013"><span class="annot"><span class="annottext">msg :: Text
</span><a href="#local-6989586621679325013"><span class="hs-identifier hs-var">msg</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-516"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; IO Blob
forall a. HasCallStack =&gt; String -&gt; IO a
</span><span class="hs-identifier hs-var">assertFailure</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; IO Blob) -&gt; String -&gt; IO Blob
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Unexpected reject (code &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679325014"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="hs-string">&quot;): &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; String
</span><span class="hs-identifier hs-var">T.unpack</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679325013"><span class="hs-identifier hs-var">msg</span></a></span><span>
</span><span id="line-517"></span><span>
</span><span id="line-518"></span><span class="hs-comment">-- Convenience decoders</span><span>
</span><span id="line-519"></span><span>
</span><span id="line-520"></span><span class="annot"><a href="IC.Test.Agent.html#asWord32"><span class="hs-identifier hs-type">asWord32</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word32</span></span><span>
</span><span id="line-521"></span><span id="asWord32"><span class="annot"><span class="annottext">asWord32 :: Blob -&gt; IO Word32
</span><a href="IC.Test.Agent.html#asWord32"><span class="hs-identifier hs-var hs-var">asWord32</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Get Word32 -&gt; Blob -&gt; IO Word32
forall a. HasCallStack =&gt; Get a -&gt; Blob -&gt; IO a
</span><a href="IC.Test.Agent.html#runGet"><span class="hs-identifier hs-var">runGet</span></a></span><span> </span><span class="annot"><span class="annottext">Get Word32
</span><span class="hs-identifier hs-var">Get.getWord32le</span></span><span>
</span><span id="line-522"></span><span>
</span><span id="line-523"></span><span class="annot"><a href="IC.Test.Agent.html#asWord64"><span class="hs-identifier hs-type">asWord64</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word64</span></span><span>
</span><span id="line-524"></span><span id="asWord64"><span class="annot"><span class="annottext">asWord64 :: Blob -&gt; IO Word64
</span><a href="IC.Test.Agent.html#asWord64"><span class="hs-identifier hs-var hs-var">asWord64</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Get Word64 -&gt; Blob -&gt; IO Word64
forall a. HasCallStack =&gt; Get a -&gt; Blob -&gt; IO a
</span><a href="IC.Test.Agent.html#runGet"><span class="hs-identifier hs-var">runGet</span></a></span><span> </span><span class="annot"><span class="annottext">Get Word64
</span><span class="hs-identifier hs-var">Get.getWord64le</span></span><span>
</span><span id="line-525"></span><span>
</span><span id="line-526"></span><span class="annot"><a href="IC.Test.Agent.html#as2Word64"><span class="hs-identifier hs-type">as2Word64</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Word64</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word64</span></span><span class="hs-special">)</span><span>
</span><span id="line-527"></span><span id="as2Word64"><span class="annot"><span class="annottext">as2Word64 :: Blob -&gt; IO (Word64, Word64)
</span><a href="IC.Test.Agent.html#as2Word64"><span class="hs-identifier hs-var hs-var">as2Word64</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Get (Word64, Word64) -&gt; Blob -&gt; IO (Word64, Word64)
forall a. HasCallStack =&gt; Get a -&gt; Blob -&gt; IO a
</span><a href="IC.Test.Agent.html#runGet"><span class="hs-identifier hs-var">runGet</span></a></span><span> </span><span class="annot"><span class="annottext">(Get (Word64, Word64) -&gt; Blob -&gt; IO (Word64, Word64))
-&gt; Get (Word64, Word64) -&gt; Blob -&gt; IO (Word64, Word64)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Word64 -&gt; Word64 -&gt; (Word64, Word64))
-&gt; Get Word64 -&gt; Get (Word64 -&gt; (Word64, Word64))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Get Word64
</span><span class="hs-identifier hs-var">Get.getWord64le</span></span><span> </span><span class="annot"><span class="annottext">Get (Word64 -&gt; (Word64, Word64))
-&gt; Get Word64 -&gt; Get (Word64, Word64)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Get Word64
</span><span class="hs-identifier hs-var">Get.getWord64le</span></span><span>
</span><span id="line-528"></span><span>
</span><span id="line-529"></span><span id="local-6989586621679325006"><span class="annot"><a href="IC.Test.Agent.html#bothSame"><span class="hs-identifier hs-type">bothSame</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="#local-6989586621679325006"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="annot"><a href="#local-6989586621679325006"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679325006"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679325006"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Assertion</span></span></span><span>
</span><span id="line-530"></span><span id="bothSame"><span class="annot"><span class="annottext">bothSame :: (a, a) -&gt; IO ()
</span><a href="IC.Test.Agent.html#bothSame"><span class="hs-identifier hs-var hs-var">bothSame</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679325003"><span class="annot"><span class="annottext">x :: a
</span><a href="#local-6989586621679325003"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679325002"><span class="annot"><span class="annottext">y :: a
</span><a href="#local-6989586621679325002"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679325003"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; IO ()
forall a. (Eq a, Show a, HasCallStack) =&gt; a -&gt; a -&gt; IO ()
</span><span class="hs-operator hs-var">@?=</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679325002"><span class="hs-identifier hs-var">y</span></a></span><span>
</span><span id="line-531"></span><span>
</span><span id="line-532"></span><span id="local-6989586621679325483"><span class="annot"><a href="IC.Test.Agent.html#runGet"><span class="hs-identifier hs-type">runGet</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Get.Get</span></span><span> </span><span class="annot"><a href="#local-6989586621679325483"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679325483"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-533"></span><span id="runGet"><span class="annot"><span class="annottext">runGet :: Get a -&gt; Blob -&gt; IO a
</span><a href="IC.Test.Agent.html#runGet"><span class="hs-identifier hs-var hs-var">runGet</span></a></span></span><span> </span><span id="local-6989586621679325000"><span class="annot"><span class="annottext">a :: Get a
</span><a href="#local-6989586621679325000"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679324999"><span class="annot"><span class="annottext">b :: Blob
</span><a href="#local-6989586621679324999"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span>  </span><span class="annot"><span class="annottext">Get a -&gt; Blob -&gt; Either (Blob, Int64, String) (Blob, Int64, a)
forall a.
Get a -&gt; Blob -&gt; Either (Blob, Int64, String) (Blob, Int64, a)
</span><span class="hs-identifier hs-var">Get.runGetOrFail</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Get a
</span><a href="#local-6989586621679325000"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">Get a -&gt; Get () -&gt; Get a
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b -&gt; f a
</span><span class="hs-operator hs-var">&lt;*</span></span><span> </span><span class="annot"><span class="annottext">Get ()
</span><a href="#local-6989586621679324996"><span class="hs-identifier hs-var">done</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324999"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-534"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679324995"><span class="annot"><span class="annottext">err :: String
</span><a href="#local-6989586621679324995"><span class="hs-identifier hs-var">err</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-535"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; IO a
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; IO a) -&gt; String -&gt; IO a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Could not parse &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324999"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="hs-string">&quot;: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679324995"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-536"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679324994"><span class="annot"><span class="annottext">x :: a
</span><a href="#local-6989586621679324994"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679324994"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-537"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-538"></span><span>    </span><span id="local-6989586621679324996"><span class="annot"><span class="annottext">done :: Get ()
</span><a href="#local-6989586621679324996"><span class="hs-identifier hs-var hs-var">done</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-539"></span><span>        </span><span id="local-6989586621679324993"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679324993"><span class="hs-identifier hs-var">nothing_left</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Get Bool
</span><span class="hs-identifier hs-var">Get.isEmpty</span></span><span>
</span><span id="line-540"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; Get () -&gt; Get ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679324993"><span class="hs-identifier hs-var">nothing_left</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Get ()
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="hs-string">&quot;left-over bytes&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-541"></span><span>
</span><span id="line-542"></span><span class="hs-comment">-- * Status endpoint parsing</span><span>
</span><span id="line-543"></span><span>
</span><span id="line-544"></span><span class="hs-keyword">data</span><span> </span><span id="StatusResponse"><span class="annot"><a href="IC.Test.Agent.html#StatusResponse"><span class="hs-identifier hs-var">StatusResponse</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="StatusResponse"><span class="annot"><a href="IC.Test.Agent.html#StatusResponse"><span class="hs-identifier hs-var">StatusResponse</span></a></span></span><span>
</span><span id="line-545"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="status_api_version"><span class="annot"><span class="annottext">StatusResponse -&gt; Text
</span><a href="IC.Test.Agent.html#status_api_version"><span class="hs-identifier hs-var hs-var">status_api_version</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">T.Text</span></span><span>
</span><span id="line-546"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="status_root_key"><span class="annot"><span class="annottext">StatusResponse -&gt; Blob
</span><a href="IC.Test.Agent.html#status_root_key"><span class="hs-identifier hs-var hs-var">status_root_key</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span>
</span><span id="line-547"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-548"></span><span>
</span><span id="line-549"></span><span class="annot"><a href="IC.Test.Agent.html#statusResonse"><span class="hs-identifier hs-type">statusResonse</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.HTTP.GenR.html#GenR"><span class="hs-identifier hs-type">GenR</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="IC.Test.Agent.html#StatusResponse"><span class="hs-identifier hs-type">StatusResponse</span></a></span><span>
</span><span id="line-550"></span><span id="statusResonse"><span class="annot"><span class="annottext">statusResonse :: GenR -&gt; IO StatusResponse
</span><a href="IC.Test.Agent.html#statusResonse"><span class="hs-identifier hs-var hs-var">statusResonse</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExceptT Text IO StatusResponse -&gt; IO StatusResponse
forall a. HasCallStack =&gt; ExceptT Text IO a -&gt; IO a
</span><a href="IC.Test.Agent.html#asExceptT"><span class="hs-identifier hs-var">asExceptT</span></a></span><span> </span><span class="annot"><span class="annottext">(ExceptT Text IO StatusResponse -&gt; IO StatusResponse)
-&gt; (GenR -&gt; ExceptT Text IO StatusResponse)
-&gt; GenR
-&gt; IO StatusResponse
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">RecordM (ExceptT Text IO) StatusResponse
-&gt; GenR -&gt; ExceptT Text IO StatusResponse
forall (m :: * -&gt; *) a.
(HasCallStack, Parse m) =&gt;
RecordM m a -&gt; GenR -&gt; m a
</span><a href="IC.HTTP.GenR.Parse.html#record"><span class="hs-identifier hs-var">record</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-551"></span><span>    </span><span id="local-6989586621679324989"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679324989"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Field Text -&gt; Text -&gt; RecordM (ExceptT Text IO) Text
forall (m :: * -&gt; *) a.
(HasCallStack, Parse m) =&gt;
Field a -&gt; Text -&gt; RecordM m a
</span><a href="IC.HTTP.GenR.Parse.html#field"><span class="hs-identifier hs-var">field</span></a></span><span> </span><span class="annot"><span class="annottext">Field Text
</span><a href="IC.HTTP.GenR.Parse.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;ic_api_version&quot;</span></span><span>
</span><span id="line-552"></span><span>    </span><span class="annot"><span class="annottext">Maybe Text
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Field Text -&gt; Text -&gt; RecordM (ExceptT Text IO) (Maybe Text)
forall (m :: * -&gt; *) a.
(HasCallStack, Parse m) =&gt;
Field a -&gt; Text -&gt; RecordM m (Maybe a)
</span><a href="IC.HTTP.GenR.Parse.html#optionalField"><span class="hs-identifier hs-var">optionalField</span></a></span><span> </span><span class="annot"><span class="annottext">Field Text
</span><a href="IC.HTTP.GenR.Parse.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;impl_source&quot;</span></span><span>
</span><span id="line-553"></span><span>    </span><span class="annot"><span class="annottext">Maybe Text
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Field Text -&gt; Text -&gt; RecordM (ExceptT Text IO) (Maybe Text)
forall (m :: * -&gt; *) a.
(HasCallStack, Parse m) =&gt;
Field a -&gt; Text -&gt; RecordM m (Maybe a)
</span><a href="IC.HTTP.GenR.Parse.html#optionalField"><span class="hs-identifier hs-var">optionalField</span></a></span><span> </span><span class="annot"><span class="annottext">Field Text
</span><a href="IC.HTTP.GenR.Parse.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;impl_version&quot;</span></span><span>
</span><span id="line-554"></span><span>    </span><span class="annot"><span class="annottext">Maybe Text
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Field Text -&gt; Text -&gt; RecordM (ExceptT Text IO) (Maybe Text)
forall (m :: * -&gt; *) a.
(HasCallStack, Parse m) =&gt;
Field a -&gt; Text -&gt; RecordM m (Maybe a)
</span><a href="IC.HTTP.GenR.Parse.html#optionalField"><span class="hs-identifier hs-var">optionalField</span></a></span><span> </span><span class="annot"><span class="annottext">Field Text
</span><a href="IC.HTTP.GenR.Parse.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;impl_revision&quot;</span></span><span>
</span><span id="line-555"></span><span>    </span><span id="local-6989586621679324987"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324987"><span class="hs-identifier hs-var">pk</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Field Blob -&gt; Text -&gt; RecordM (ExceptT Text IO) Blob
forall (m :: * -&gt; *) a.
(HasCallStack, Parse m) =&gt;
Field a -&gt; Text -&gt; RecordM m a
</span><a href="IC.HTTP.GenR.Parse.html#field"><span class="hs-identifier hs-var">field</span></a></span><span> </span><span class="annot"><span class="annottext">Field Blob
</span><a href="IC.HTTP.GenR.Parse.html#blob"><span class="hs-identifier hs-var">blob</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;root_key&quot;</span></span><span>
</span><span id="line-556"></span><span>    </span><span class="annot"><span class="annottext">RecordM (ExceptT Text IO) ()
forall (m :: * -&gt; *). Monad m =&gt; RecordM m ()
</span><a href="IC.HTTP.GenR.Parse.html#swallowAllFields"><span class="hs-identifier hs-var">swallowAllFields</span></a></span><span> </span><span class="hs-comment">-- More fields are explicitly allowed</span><span>
</span><span id="line-557"></span><span>    </span><span class="annot"><span class="annottext">StatusResponse -&gt; RecordM (ExceptT Text IO) StatusResponse
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">StatusResponse :: Text -&gt; Blob -&gt; StatusResponse
</span><a href="IC.Test.Agent.html#StatusResponse"><span class="hs-identifier hs-type hs-type">StatusResponse</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">status_api_version :: Text
</span><a href="IC.Test.Agent.html#status_api_version"><span class="hs-identifier hs-var">status_api_version</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679324989"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">status_root_key :: Blob
</span><a href="IC.Test.Agent.html#status_root_key"><span class="hs-identifier hs-var">status_root_key</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324987"><span class="hs-identifier hs-var">pk</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-558"></span><span>
</span><span id="line-559"></span><span class="hs-comment">-- * Interacting with aaaaa-aa (via HTTP)</span><span>
</span><span id="line-560"></span><span>
</span><span id="line-561"></span><span class="hs-comment">{-
The code below has some repetition. That&#8217;s because we have

 A) multiple ways of _calling_ the Management Canister
    (as default user, as specific user, via canister, with or without cycles),
 B) different things we want to know
    (just the Candid-decoded reply, or the response, or even the HTTP error)
 C) and then of course different methods (which affect response decoding)

So far, there is some duplication here because of that. Eventually, this should
be refactored so that the test can declarative pick A, B and C separately.
-}</span><span>
</span><span id="line-573"></span><span>
</span><span id="line-574"></span><span class="hs-comment">-- how to reach the management canister</span><span>
</span><span id="line-575"></span><span class="hs-keyword">type</span><span> </span><span id="IC00"><span class="annot"><a href="IC.Test.Agent.html#IC00"><span class="hs-identifier hs-var">IC00</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">T.Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="IC.Test.Agent.html#ReqResponse"><span class="hs-identifier hs-type">ReqResponse</span></a></span><span>
</span><span id="line-576"></span><span>
</span><span id="line-577"></span><span class="annot"><a href="IC.Test.Agent.html#ic00as"><span class="hs-identifier hs-type">ic00as</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Test.Agent.html#HasAgentConfig"><span class="hs-identifier hs-type">HasAgentConfig</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#IC00"><span class="hs-identifier hs-type">IC00</span></a></span><span>
</span><span id="line-578"></span><span id="ic00as"><span class="annot"><span class="annottext">ic00as :: Blob -&gt; IC00
</span><a href="IC.Test.Agent.html#ic00as"><span class="hs-identifier hs-var hs-var">ic00as</span></a></span></span><span> </span><span id="local-6989586621679324983"><span class="annot"><span class="annottext">user :: Blob
</span><a href="#local-6989586621679324983"><span class="hs-identifier hs-var">user</span></a></span></span><span> </span><span id="local-6989586621679324982"><span class="annot"><span class="annottext">ecid :: Blob
</span><a href="#local-6989586621679324982"><span class="hs-identifier hs-var">ecid</span></a></span></span><span> </span><span id="local-6989586621679324981"><span class="annot"><span class="annottext">method_name :: Text
</span><a href="#local-6989586621679324981"><span class="hs-identifier hs-var">method_name</span></a></span></span><span> </span><span id="local-6989586621679324980"><span class="annot"><span class="annottext">arg :: Blob
</span><a href="#local-6989586621679324980"><span class="hs-identifier hs-var">arg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(HasCallStack, HasAgentConfig) =&gt; Blob -&gt; GenR -&gt; IO ReqResponse
Blob -&gt; GenR -&gt; IO ReqResponse
</span><a href="IC.Test.Agent.html#awaitCall"><span class="hs-identifier hs-var">awaitCall</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324982"><span class="hs-identifier hs-var">ecid</span></a></span><span> </span><span class="annot"><span class="annottext">(GenR -&gt; IO ReqResponse) -&gt; GenR -&gt; IO ReqResponse
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[HashMap Text GenR] -&gt; GenR
</span><a href="IC.HTTP.GenR.html#rec"><span class="hs-identifier hs-var">rec</span></a></span><span>
</span><span id="line-579"></span><span>      </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="hs-string">&quot;request_type&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; GenR -&gt; HashMap Text GenR
forall v. Text -&gt; v -&gt; HashMap Text v
</span><a href="IC.HTTP.GenR.html#%3D%3A"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; GenR
</span><a href="IC.HTTP.GenR.html#GText"><span class="hs-identifier hs-var">GText</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;call&quot;</span></span><span>
</span><span id="line-580"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;sender&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; GenR -&gt; HashMap Text GenR
forall v. Text -&gt; v -&gt; HashMap Text v
</span><a href="IC.HTTP.GenR.html#%3D%3A"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; GenR
</span><a href="IC.HTTP.GenR.html#GBlob"><span class="hs-identifier hs-var">GBlob</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324983"><span class="hs-identifier hs-var">user</span></a></span><span>
</span><span id="line-581"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;canister_id&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; GenR -&gt; HashMap Text GenR
forall v. Text -&gt; v -&gt; HashMap Text v
</span><a href="IC.HTTP.GenR.html#%3D%3A"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; GenR
</span><a href="IC.HTTP.GenR.html#GBlob"><span class="hs-identifier hs-var">GBlob</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;&quot;</span></span><span>
</span><span id="line-582"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;method_name&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; GenR -&gt; HashMap Text GenR
forall v. Text -&gt; v -&gt; HashMap Text v
</span><a href="IC.HTTP.GenR.html#%3D%3A"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; GenR
</span><a href="IC.HTTP.GenR.html#GText"><span class="hs-identifier hs-var">GText</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679324981"><span class="hs-identifier hs-var">method_name</span></a></span><span>
</span><span id="line-583"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;arg&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; GenR -&gt; HashMap Text GenR
forall v. Text -&gt; v -&gt; HashMap Text v
</span><a href="IC.HTTP.GenR.html#%3D%3A"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; GenR
</span><a href="IC.HTTP.GenR.html#GBlob"><span class="hs-identifier hs-var">GBlob</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324980"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-584"></span><span>      </span><span class="hs-special">]</span><span>
</span><span id="line-585"></span><span>
</span><span id="line-586"></span><span class="annot"><a href="IC.Test.Agent.html#ic00"><span class="hs-identifier hs-type">ic00</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#HasAgentConfig"><span class="hs-identifier hs-type">HasAgentConfig</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#IC00"><span class="hs-identifier hs-type">IC00</span></a></span><span>
</span><span id="line-587"></span><span id="ic00"><span class="annot"><span class="annottext">ic00 :: IC00
</span><a href="IC.Test.Agent.html#ic00"><span class="hs-identifier hs-var hs-var">ic00</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(HasAgentConfig, HasCallStack) =&gt; Blob -&gt; IC00
Blob -&gt; IC00
</span><a href="IC.Test.Agent.html#ic00as"><span class="hs-identifier hs-var">ic00as</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="IC.Test.Agent.html#defaultUser"><span class="hs-identifier hs-var">defaultUser</span></a></span><span>
</span><span id="line-588"></span><span>
</span><span id="line-589"></span><span class="hs-comment">-- A variant that allows non-200 responses to submit</span><span>
</span><span id="line-590"></span><span class="annot"><a href="IC.Test.Agent.html#ic00as%27"><span class="hs-identifier hs-type">ic00as'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#HasAgentConfig"><span class="hs-identifier hs-type">HasAgentConfig</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">T.Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="IC.Test.Agent.html#HTTPErrOrReqResponse"><span class="hs-identifier hs-type">HTTPErrOrReqResponse</span></a></span><span>
</span><span id="line-591"></span><span id="ic00as%27"><span class="annot"><span class="annottext">ic00as' :: Blob -&gt; Blob -&gt; Text -&gt; Blob -&gt; IO HTTPErrOrReqResponse
</span><a href="IC.Test.Agent.html#ic00as%27"><span class="hs-identifier hs-var hs-var">ic00as'</span></a></span></span><span> </span><span id="local-6989586621679324977"><span class="annot"><span class="annottext">user :: Blob
</span><a href="#local-6989586621679324977"><span class="hs-identifier hs-var">user</span></a></span></span><span> </span><span id="local-6989586621679324976"><span class="annot"><span class="annottext">cid :: Blob
</span><a href="#local-6989586621679324976"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span id="local-6989586621679324975"><span class="annot"><span class="annottext">method_name :: Text
</span><a href="#local-6989586621679324975"><span class="hs-identifier hs-var">method_name</span></a></span></span><span> </span><span id="local-6989586621679324974"><span class="annot"><span class="annottext">arg :: Blob
</span><a href="#local-6989586621679324974"><span class="hs-identifier hs-var">arg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(HasCallStack, HasAgentConfig) =&gt;
Blob -&gt; GenR -&gt; IO HTTPErrOrReqResponse
Blob -&gt; GenR -&gt; IO HTTPErrOrReqResponse
</span><a href="IC.Test.Agent.html#awaitCall%27"><span class="hs-identifier hs-var">awaitCall'</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324976"><span class="hs-identifier hs-var">cid</span></a></span><span> </span><span class="annot"><span class="annottext">(GenR -&gt; IO HTTPErrOrReqResponse)
-&gt; GenR -&gt; IO HTTPErrOrReqResponse
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[HashMap Text GenR] -&gt; GenR
</span><a href="IC.HTTP.GenR.html#rec"><span class="hs-identifier hs-var">rec</span></a></span><span>
</span><span id="line-592"></span><span>      </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="hs-string">&quot;request_type&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; GenR -&gt; HashMap Text GenR
forall v. Text -&gt; v -&gt; HashMap Text v
</span><a href="IC.HTTP.GenR.html#%3D%3A"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; GenR
</span><a href="IC.HTTP.GenR.html#GText"><span class="hs-identifier hs-var">GText</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;call&quot;</span></span><span>
</span><span id="line-593"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;sender&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; GenR -&gt; HashMap Text GenR
forall v. Text -&gt; v -&gt; HashMap Text v
</span><a href="IC.HTTP.GenR.html#%3D%3A"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; GenR
</span><a href="IC.HTTP.GenR.html#GBlob"><span class="hs-identifier hs-var">GBlob</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324977"><span class="hs-identifier hs-var">user</span></a></span><span>
</span><span id="line-594"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;canister_id&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; GenR -&gt; HashMap Text GenR
forall v. Text -&gt; v -&gt; HashMap Text v
</span><a href="IC.HTTP.GenR.html#%3D%3A"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; GenR
</span><a href="IC.HTTP.GenR.html#GBlob"><span class="hs-identifier hs-var">GBlob</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;&quot;</span></span><span>
</span><span id="line-595"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;method_name&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; GenR -&gt; HashMap Text GenR
forall v. Text -&gt; v -&gt; HashMap Text v
</span><a href="IC.HTTP.GenR.html#%3D%3A"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; GenR
</span><a href="IC.HTTP.GenR.html#GText"><span class="hs-identifier hs-var">GText</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679324975"><span class="hs-identifier hs-var">method_name</span></a></span><span>
</span><span id="line-596"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;arg&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; GenR -&gt; HashMap Text GenR
forall v. Text -&gt; v -&gt; HashMap Text v
</span><a href="IC.HTTP.GenR.html#%3D%3A"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; GenR
</span><a href="IC.HTTP.GenR.html#GBlob"><span class="hs-identifier hs-var">GBlob</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324974"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-597"></span><span>      </span><span class="hs-special">]</span><span>
</span><span id="line-598"></span><span>
</span><span id="line-599"></span><span class="hs-comment">-- Now wrapping the concrete calls</span><span>
</span><span id="line-600"></span><span class="hs-comment">-- (using Candid.toCandidService is tricky because of all stuff like passing through the effective canister id)</span><span>
</span><span id="line-601"></span><span class="hs-comment">--</span><span>
</span><span id="line-602"></span><span class="annot"><a href="IC.Test.Agent.html#callIC"><span class="hs-identifier hs-type">callIC</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679325424"><span class="annot"><a href="#local-6989586621679325424"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span id="local-6989586621679325423"><span class="annot"><a href="#local-6989586621679325423"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span id="local-6989586621679325422"><span class="annot"><a href="#local-6989586621679325422"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-603"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#HasAgentConfig"><span class="hs-identifier hs-type">HasAgentConfig</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-604"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">KnownSymbol</span></span><span> </span><span class="annot"><a href="#local-6989586621679325424"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-605"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679325423"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679325422"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-glyph hs-type">~</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Management.html#ICManagement"><span class="hs-identifier hs-type">ICManagement</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">.!</span></span><span> </span><span class="annot"><a href="#local-6989586621679325424"><span class="hs-identifier hs-type">s</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-606"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Candid.CandidArg</span></span><span> </span><span class="annot"><a href="#local-6989586621679325423"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Candid.CandidArg</span></span><span> </span><span class="annot"><a href="#local-6989586621679325422"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-607"></span><span>  </span><span class="annot"><a href="IC.Test.Agent.html#IC00"><span class="hs-identifier hs-type">IC00</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Label</span></span><span> </span><span class="annot"><a href="#local-6989586621679325424"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679325423"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679325422"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-608"></span><span id="callIC"><span class="annot"><span class="annottext">callIC :: IC00 -&gt; Blob -&gt; Label s -&gt; a -&gt; IO b
</span><a href="IC.Test.Agent.html#callIC"><span class="hs-identifier hs-var hs-var">callIC</span></a></span></span><span> </span><span id="local-6989586621679324972"><span class="annot"><span class="annottext">ic00 :: IC00
</span><a href="#local-6989586621679324972"><span class="hs-identifier hs-var">ic00</span></a></span></span><span> </span><span id="local-6989586621679324971"><span class="annot"><span class="annottext">ecid :: Blob
</span><a href="#local-6989586621679324971"><span class="hs-identifier hs-var">ecid</span></a></span></span><span> </span><span id="local-6989586621679324970"><span class="annot"><span class="annottext">l :: Label s
</span><a href="#local-6989586621679324970"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span id="local-6989586621679324969"><span class="annot"><span class="annottext">x :: a
</span><a href="#local-6989586621679324969"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-609"></span><span>    </span><span id="local-6989586621679324968"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324968"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IC00
</span><a href="#local-6989586621679324972"><span class="hs-identifier hs-var">ic00</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324971"><span class="hs-identifier hs-var">ecid</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">T.pack</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Label s -&gt; String
forall (n :: Symbol) (proxy :: Symbol -&gt; *).
KnownSymbol n =&gt;
proxy n -&gt; String
</span><span class="hs-identifier hs-var">symbolVal</span></span><span> </span><span class="annot"><span class="annottext">Label s
</span><a href="#local-6989586621679324970"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Blob
forall a. CandidArg a =&gt; a -&gt; Blob
</span><span class="hs-identifier hs-var">Candid.encode</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679324969"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IO ReqResponse -&gt; (ReqResponse -&gt; IO Blob) -&gt; IO Blob
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; ReqResponse -&gt; IO Blob
ReqResponse -&gt; IO Blob
</span><a href="IC.Test.Agent.html#isReply"><span class="hs-identifier hs-var">isReply</span></a></span><span>
</span><span id="line-610"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Blob -&gt; Either String b
forall a. CandidArg a =&gt; Blob -&gt; Either String a
</span><span class="hs-identifier hs-var">Candid.decode</span></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324968"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-611"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679324964"><span class="annot"><span class="annottext">err :: String
</span><a href="#local-6989586621679324964"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; IO b
forall a. HasCallStack =&gt; String -&gt; IO a
</span><span class="hs-identifier hs-var">assertFailure</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; IO b) -&gt; String -&gt; IO b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Candid decoding error: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679324964"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-612"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679324963"><span class="annot"><span class="annottext">y :: b
</span><a href="#local-6989586621679324963"><span class="hs-identifier hs-var">y</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">b -&gt; IO b
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679324963"><span class="hs-identifier hs-var">y</span></a></span><span>
</span><span id="line-613"></span><span>
</span><span id="line-614"></span><span class="hs-comment">-- The following line noise is me getting out of my way</span><span>
</span><span id="line-615"></span><span class="hs-comment">-- to be able to use `ic_create` etc. by passing a record that contains</span><span>
</span><span id="line-616"></span><span class="hs-comment">-- a subset of settings, without Maybe</span><span>
</span><span id="line-617"></span><span class="hs-keyword">type</span><span> </span><span class="hs-keyword">family</span><span> </span><span id="UnRec"><span class="annot"><a href="IC.Test.Agent.html#UnRec"><span class="hs-identifier hs-var">UnRec</span></a></span></span><span> </span><span id="local-6989586621679324962"><span class="annot"><a href="#local-6989586621679324962"><span class="hs-identifier hs-type">r</span></a></span></span><span> </span><span class="hs-keyword">where</span><span> </span><span id="UnRec"><span class="annot"><a href="IC.Test.Agent.html#UnRec"><span class="hs-identifier hs-var">UnRec</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">R.Rec</span></span><span> </span><span id="local-6989586621679324961"><span class="annot"><a href="#local-6989586621679324961"><span class="hs-identifier hs-type hs-type">r</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621679324961"><span class="hs-identifier hs-type">r</span></a></span><span>
</span><span id="line-618"></span><span class="hs-keyword">type</span><span> </span><span id="PartialSettings"><span class="annot"><a href="IC.Test.Agent.html#PartialSettings"><span class="hs-identifier hs-var">PartialSettings</span></a></span></span><span> </span><span id="local-6989586621679324960"><span class="annot"><a href="#local-6989586621679324960"><span class="hs-identifier hs-type">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">R.Forall</span></span><span> </span><span class="annot"><a href="#local-6989586621679324960"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">R.Unconstrained1</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">R.Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621679324960"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">.//</span></span><span> </span><span class="annot"><a href="IC.Test.Agent.html#UnRec"><span class="hs-identifier hs-type">UnRec</span></a></span><span> </span><span class="annot"><a href="IC.Management.html#Settings"><span class="hs-identifier hs-type">Settings</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&#8776;</span></span><span> </span><span class="annot"><a href="IC.Test.Agent.html#UnRec"><span class="hs-identifier hs-type">UnRec</span></a></span><span> </span><span class="annot"><a href="IC.Management.html#Settings"><span class="hs-identifier hs-type">Settings</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-619"></span><span id="local-6989586621679325412"><span class="annot"><a href="IC.Test.Agent.html#fromPartialSettings"><span class="hs-identifier hs-type">fromPartialSettings</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#PartialSettings"><span class="hs-identifier hs-type">PartialSettings</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679325412"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">R.Rec</span></span><span> </span><span class="annot"><a href="#local-6989586621679325412"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Management.html#Settings"><span class="hs-identifier hs-type">Settings</span></a></span></span><span>
</span><span id="line-620"></span><span id="fromPartialSettings"><span class="annot"><span class="annottext">fromPartialSettings :: Rec r -&gt; Settings
</span><a href="IC.Test.Agent.html#fromPartialSettings"><span class="hs-identifier hs-var hs-var">fromPartialSettings</span></a></span></span><span> </span><span id="local-6989586621679324957"><span class="annot"><span class="annottext">r :: Rec r
</span><a href="#local-6989586621679324957"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-621"></span><span>    </span><span class="annot"><span class="annottext">(forall a. a -&gt; Maybe a) -&gt; Rec r -&gt; Rec (Map Maybe r)
forall (f :: * -&gt; *) (r :: Row *).
FreeForall r =&gt;
(forall a. a -&gt; f a) -&gt; Rec r -&gt; Rec (Map f r)
</span><span class="hs-identifier hs-var">R.map'</span></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Rec r
</span><a href="#local-6989586621679324957"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Rec (Map Maybe r)
-&gt; Rec
     ('R
        '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
           &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
           &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
           &quot;memory_allocation&quot; ':-&gt; Maybe Natural])
-&gt; Rec
     (Map Maybe r
      .// 'R
            '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
               &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
               &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
               &quot;memory_allocation&quot; ':-&gt; Maybe Natural])
forall (r :: Row *) (r' :: Row *).
Rec r -&gt; Rec r' -&gt; Rec (r .// r')
</span><span class="hs-operator hs-var">.//</span></span><span>
</span><span id="line-622"></span><span>    </span><span class="annot"><span class="annottext">(forall a. IsA Unconstrained1 Maybe a =&gt; a) -&gt; Rec (UnRec Settings)
forall (c :: * -&gt; Constraint) (&#961; :: Row *).
(Forall &#961; c, AllUniqueLabels &#961;) =&gt;
(forall a. c a =&gt; a) -&gt; Rec &#961;
</span><span class="hs-identifier hs-var">R.default'</span></span><span> </span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">R.IsA</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">R.Unconstrained1</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="IC.Test.Agent.html#UnRec"><span class="hs-identifier hs-type">UnRec</span></a></span><span> </span><span class="annot"><a href="IC.Management.html#Settings"><span class="hs-identifier hs-type">Settings</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a. IsA Unconstrained1 Maybe a =&gt; a
</span><a href="#local-6989586621679324953"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-623"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-624"></span><span>    </span><span class="annot"><a href="#local-6989586621679324953"><span class="hs-identifier hs-type">d</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679324952"><span class="annot"><a href="#local-6989586621679324952"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">R.IsA</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">R.Unconstrained1</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621679324952"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679324952"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-625"></span><span>    </span><span id="local-6989586621679324953"><span class="annot"><span class="annottext">d :: a
</span><a href="#local-6989586621679324953"><span class="hs-identifier hs-var hs-var">d</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">IsA Unconstrained1 Maybe a =&gt; As Unconstrained1 Maybe a
forall k k1 (c :: k -&gt; Constraint) (f :: k -&gt; k1) (a :: k1).
IsA c f a =&gt;
As c f a
</span><span class="hs-identifier hs-var">R.as</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-identifier hs-type">R.Unconstrained1</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621679324952"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-keyword">of</span><span> </span><span class="annot"><span class="hs-identifier hs-type">R.As</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-626"></span><span>
</span><span id="line-627"></span><span id="local-6989586621679324949"><span class="annot"><a href="IC.Test.Agent.html#ic_create"><span class="hs-identifier hs-type">ic_create</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#HasAgentConfig"><span class="hs-identifier hs-type">HasAgentConfig</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#PartialSettings"><span class="hs-identifier hs-type">PartialSettings</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679324949"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#IC00"><span class="hs-identifier hs-type">IC00</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Rec</span></span><span> </span><span class="annot"><a href="#local-6989586621679324949"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span></span><span>
</span><span id="line-628"></span><span id="ic_create"><span class="annot"><span class="annottext">ic_create :: IC00 -&gt; Rec r -&gt; IO Blob
</span><a href="IC.Test.Agent.html#ic_create"><span class="hs-identifier hs-var hs-var">ic_create</span></a></span></span><span> </span><span id="local-6989586621679324947"><span class="annot"><span class="annottext">ic00 :: IC00
</span><a href="#local-6989586621679324947"><span class="hs-identifier hs-var">ic00</span></a></span></span><span> </span><span id="local-6989586621679324946"><span class="annot"><span class="annottext">ps :: Rec r
</span><a href="#local-6989586621679324946"><span class="hs-identifier hs-var">ps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-629"></span><span>  </span><span id="local-6989586621679324945"><span class="annot"><span class="annottext">Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
</span><a href="#local-6989586621679324945"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IC00
-&gt; Blob
-&gt; Label &quot;create_canister&quot;
-&gt; Rec
     ('R
        '[ &quot;settings&quot;
           ':-&gt; Maybe
                  (Rec
                     ('R
                        '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                           &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                           &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                           &quot;memory_allocation&quot; ':-&gt; Maybe Natural]))])
-&gt; IO (Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal]))
forall (s :: Symbol) a b.
(HasCallStack, HasAgentConfig, KnownSymbol s,
 (a -&gt; IO b) ~ (ICManagement IO .! s), CandidArg a, CandidArg b) =&gt;
IC00 -&gt; Blob -&gt; Label s -&gt; a -&gt; IO b
</span><a href="IC.Test.Agent.html#callIC"><span class="hs-identifier hs-var">callIC</span></a></span><span> </span><span class="annot"><span class="annottext">IC00
</span><a href="#local-6989586621679324947"><span class="hs-identifier hs-var">ic00</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;create_canister&quot; (Label &quot;create_canister&quot;)
Label &quot;create_canister&quot;
</span><a href="#local-6989586621679324944"><span class="hs-var">#create_canister</span></a></span><span> </span><span class="annot"><span class="annottext">(Rec
   ('R
      '[ &quot;settings&quot;
         ':-&gt; Maybe
                (Rec
                   ('R
                      '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                         &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                         &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                         &quot;memory_allocation&quot; ':-&gt; Maybe Natural]))])
 -&gt; IO (Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])))
-&gt; Rec
     ('R
        '[ &quot;settings&quot;
           ':-&gt; Maybe
                  (Rec
                     ('R
                        '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                           &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                           &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                           &quot;memory_allocation&quot; ':-&gt; Maybe Natural]))])
-&gt; IO (Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal]))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Rec Empty
</span><span class="hs-identifier hs-var">empty</span></span><span>
</span><span id="line-630"></span><span>    </span><span class="annot"><span class="annottext">Rec Empty
-&gt; Rec
     ('R
        '[ &quot;settings&quot;
           ':-&gt; Maybe
                  (Rec
                     ('R
                        '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                           &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                           &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                           &quot;memory_allocation&quot; ':-&gt; Maybe Natural]))])
-&gt; Rec
     (Empty
      .+ 'R
           '[ &quot;settings&quot;
              ':-&gt; Maybe
                     (Rec
                        ('R
                           '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                              &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                              &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                              &quot;memory_allocation&quot; ':-&gt; Maybe Natural]))])
forall (l :: Row *) (r :: Row *).
FreeForall l =&gt;
Rec l -&gt; Rec r -&gt; Rec (l .+ r)
</span><span class="hs-operator hs-var">.+</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;settings&quot; (Label &quot;settings&quot;)
Label &quot;settings&quot;
</span><a href="#local-6989586621679324941"><span class="hs-var">#settings</span></a></span><span> </span><span class="annot"><span class="annottext">Label &quot;settings&quot;
-&gt; Maybe
     (Rec
        ('R
           '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
              &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
              &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
              &quot;memory_allocation&quot; ':-&gt; Maybe Natural]))
-&gt; Rec
     (&quot;settings&quot;
      .== Maybe
            (Rec
               ('R
                  '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                     &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                     &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                     &quot;memory_allocation&quot; ':-&gt; Maybe Natural])))
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec (l .== a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">Rec
  ('R
     '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
        &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
        &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
        &quot;memory_allocation&quot; ':-&gt; Maybe Natural])
-&gt; Maybe
     (Rec
        ('R
           '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
              &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
              &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
              &quot;memory_allocation&quot; ':-&gt; Maybe Natural]))
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Rec r -&gt; Settings
forall (r :: Row *). PartialSettings r =&gt; Rec r -&gt; Settings
</span><a href="IC.Test.Agent.html#fromPartialSettings"><span class="hs-identifier hs-var">fromPartialSettings</span></a></span><span> </span><span class="annot"><span class="annottext">Rec r
</span><a href="#local-6989586621679324946"><span class="hs-identifier hs-var">ps</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-631"></span><span>  </span><span class="annot"><span class="annottext">Blob -&gt; IO Blob
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Principal -&gt; Blob
</span><span class="hs-identifier hs-var hs-var">rawPrincipal</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
</span><a href="#local-6989586621679324945"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; Label &quot;canister_id&quot;
-&gt; 'R '[ &quot;canister_id&quot; ':-&gt; Principal] .! &quot;canister_id&quot;
forall (l :: Symbol) (r :: Row *).
KnownSymbol l =&gt;
Rec r -&gt; Label l -&gt; r .! l
</span><span class="hs-operator hs-var">.!</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;canister_id&quot; (Label &quot;canister_id&quot;)
Label &quot;canister_id&quot;
</span><a href="#local-6989586621679324937"><span class="hs-var">#canister_id</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-632"></span><span>
</span><span id="line-633"></span><span id="local-6989586621679324936"><span class="annot"><a href="IC.Test.Agent.html#ic_provisional_create"><span class="hs-identifier hs-type">ic_provisional_create</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-634"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#HasAgentConfig"><span class="hs-identifier hs-type">HasAgentConfig</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#PartialSettings"><span class="hs-identifier hs-type">PartialSettings</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679324936"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-635"></span><span>    </span><span class="annot"><a href="IC.Test.Agent.html#IC00"><span class="hs-identifier hs-type">IC00</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Natural</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Rec</span></span><span> </span><span class="annot"><a href="#local-6989586621679324936"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span></span><span>
</span><span id="line-636"></span><span id="ic_provisional_create"><span class="annot"><span class="annottext">ic_provisional_create :: IC00 -&gt; Maybe Natural -&gt; Rec r -&gt; IO Blob
</span><a href="IC.Test.Agent.html#ic_provisional_create"><span class="hs-identifier hs-var hs-var">ic_provisional_create</span></a></span></span><span> </span><span id="local-6989586621679324934"><span class="annot"><span class="annottext">ic00 :: IC00
</span><a href="#local-6989586621679324934"><span class="hs-identifier hs-var">ic00</span></a></span></span><span> </span><span id="local-6989586621679324933"><span class="annot"><span class="annottext">cycles :: Maybe Natural
</span><a href="#local-6989586621679324933"><span class="hs-identifier hs-var">cycles</span></a></span></span><span> </span><span id="local-6989586621679324932"><span class="annot"><span class="annottext">ps :: Rec r
</span><a href="#local-6989586621679324932"><span class="hs-identifier hs-var">ps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-637"></span><span>  </span><span id="local-6989586621679324931"><span class="annot"><span class="annottext">Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
</span><a href="#local-6989586621679324931"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IC00
-&gt; Blob
-&gt; Label &quot;provisional_create_canister_with_cycles&quot;
-&gt; Rec
     ('R
        (Inject
           (&quot;settings&quot;
            ':-&gt; Maybe
                   (Rec
                      ('R
                         '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                            &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                            &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                            &quot;memory_allocation&quot; ':-&gt; Maybe Natural])))
           '[ &quot;amount&quot; ':-&gt; Maybe Natural]))
-&gt; IO (Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal]))
forall (s :: Symbol) a b.
(HasCallStack, HasAgentConfig, KnownSymbol s,
 (a -&gt; IO b) ~ (ICManagement IO .! s), CandidArg a, CandidArg b) =&gt;
IC00 -&gt; Blob -&gt; Label s -&gt; a -&gt; IO b
</span><a href="IC.Test.Agent.html#callIC"><span class="hs-identifier hs-var">callIC</span></a></span><span> </span><span class="annot"><span class="annottext">IC00
</span><a href="#local-6989586621679324934"><span class="hs-identifier hs-var">ic00</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;provisional_create_canister_with_cycles&quot;
  (Label &quot;provisional_create_canister_with_cycles&quot;)
Label &quot;provisional_create_canister_with_cycles&quot;
</span><a href="#local-6989586621679324930"><span class="hs-var">#provisional_create_canister_with_cycles</span></a></span><span> </span><span class="annot"><span class="annottext">(Rec
   ('R
      (Inject
         (&quot;settings&quot;
          ':-&gt; Maybe
                 (Rec
                    ('R
                       '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                          &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                          &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                          &quot;memory_allocation&quot; ':-&gt; Maybe Natural])))
         '[ &quot;amount&quot; ':-&gt; Maybe Natural]))
 -&gt; IO (Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])))
-&gt; Rec
     ('R
        (Inject
           (&quot;settings&quot;
            ':-&gt; Maybe
                   (Rec
                      ('R
                         '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                            &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                            &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                            &quot;memory_allocation&quot; ':-&gt; Maybe Natural])))
           '[ &quot;amount&quot; ':-&gt; Maybe Natural]))
-&gt; IO (Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal]))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Rec Empty
</span><span class="hs-identifier hs-var">empty</span></span><span>
</span><span id="line-638"></span><span>    </span><span class="annot"><span class="annottext">Rec Empty
-&gt; Rec ('R '[ &quot;amount&quot; ':-&gt; Maybe Natural])
-&gt; Rec (Empty .+ 'R '[ &quot;amount&quot; ':-&gt; Maybe Natural])
forall (l :: Row *) (r :: Row *).
FreeForall l =&gt;
Rec l -&gt; Rec r -&gt; Rec (l .+ r)
</span><span class="hs-operator hs-var">.+</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;amount&quot; (Label &quot;amount&quot;)
Label &quot;amount&quot;
</span><a href="#local-6989586621679324929"><span class="hs-var">#amount</span></a></span><span> </span><span class="annot"><span class="annottext">Label &quot;amount&quot; -&gt; Maybe Natural -&gt; Rec (&quot;amount&quot; .== Maybe Natural)
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec (l .== a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">Maybe Natural
</span><a href="#local-6989586621679324933"><span class="hs-identifier hs-var">cycles</span></a></span><span>
</span><span id="line-639"></span><span>    </span><span class="annot"><span class="annottext">Rec ('R '[ &quot;amount&quot; ':-&gt; Maybe Natural])
-&gt; Rec
     ('R
        '[ &quot;settings&quot;
           ':-&gt; Maybe
                  (Rec
                     ('R
                        '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                           &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                           &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                           &quot;memory_allocation&quot; ':-&gt; Maybe Natural]))])
-&gt; Rec
     ('R '[ &quot;amount&quot; ':-&gt; Maybe Natural]
      .+ 'R
           '[ &quot;settings&quot;
              ':-&gt; Maybe
                     (Rec
                        ('R
                           '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                              &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                              &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                              &quot;memory_allocation&quot; ':-&gt; Maybe Natural]))])
forall (l :: Row *) (r :: Row *).
FreeForall l =&gt;
Rec l -&gt; Rec r -&gt; Rec (l .+ r)
</span><span class="hs-operator hs-var">.+</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;settings&quot; (Label &quot;settings&quot;)
Label &quot;settings&quot;
</span><a href="#local-6989586621679324928"><span class="hs-var">#settings</span></a></span><span> </span><span class="annot"><span class="annottext">Label &quot;settings&quot;
-&gt; Maybe
     (Rec
        ('R
           '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
              &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
              &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
              &quot;memory_allocation&quot; ':-&gt; Maybe Natural]))
-&gt; Rec
     (&quot;settings&quot;
      .== Maybe
            (Rec
               ('R
                  '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                     &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                     &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                     &quot;memory_allocation&quot; ':-&gt; Maybe Natural])))
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec (l .== a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">Rec
  ('R
     '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
        &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
        &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
        &quot;memory_allocation&quot; ':-&gt; Maybe Natural])
-&gt; Maybe
     (Rec
        ('R
           '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
              &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
              &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
              &quot;memory_allocation&quot; ':-&gt; Maybe Natural]))
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Rec r -&gt; Settings
forall (r :: Row *). PartialSettings r =&gt; Rec r -&gt; Settings
</span><a href="IC.Test.Agent.html#fromPartialSettings"><span class="hs-identifier hs-var">fromPartialSettings</span></a></span><span> </span><span class="annot"><span class="annottext">Rec r
</span><a href="#local-6989586621679324932"><span class="hs-identifier hs-var">ps</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-640"></span><span>  </span><span class="annot"><span class="annottext">Blob -&gt; IO Blob
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Principal -&gt; Blob
</span><span class="hs-identifier hs-var hs-var">rawPrincipal</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
</span><a href="#local-6989586621679324931"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; Label &quot;canister_id&quot;
-&gt; 'R '[ &quot;canister_id&quot; ':-&gt; Principal] .! &quot;canister_id&quot;
forall (l :: Symbol) (r :: Row *).
KnownSymbol l =&gt;
Rec r -&gt; Label l -&gt; r .! l
</span><span class="hs-operator hs-var">.!</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;canister_id&quot; (Label &quot;canister_id&quot;)
Label &quot;canister_id&quot;
</span><a href="#local-6989586621679324927"><span class="hs-var">#canister_id</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-641"></span><span>
</span><span id="line-642"></span><span class="annot"><a href="IC.Test.Agent.html#ic_install"><span class="hs-identifier hs-type">ic_install</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#HasAgentConfig"><span class="hs-identifier hs-type">HasAgentConfig</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#IC00"><span class="hs-identifier hs-type">IC00</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Management.html#InstallMode"><span class="hs-identifier hs-type">InstallMode</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-643"></span><span id="ic_install"><span class="annot"><span class="annottext">ic_install :: IC00 -&gt; InstallMode -&gt; Blob -&gt; Blob -&gt; Blob -&gt; IO ()
</span><a href="IC.Test.Agent.html#ic_install"><span class="hs-identifier hs-var hs-var">ic_install</span></a></span></span><span> </span><span id="local-6989586621679324925"><span class="annot"><span class="annottext">ic00 :: IC00
</span><a href="#local-6989586621679324925"><span class="hs-identifier hs-var">ic00</span></a></span></span><span> </span><span id="local-6989586621679324924"><span class="annot"><span class="annottext">mode :: InstallMode
</span><a href="#local-6989586621679324924"><span class="hs-identifier hs-var">mode</span></a></span></span><span> </span><span id="local-6989586621679324923"><span class="annot"><span class="annottext">canister_id :: Blob
</span><a href="#local-6989586621679324923"><span class="hs-identifier hs-var">canister_id</span></a></span></span><span> </span><span id="local-6989586621679324922"><span class="annot"><span class="annottext">wasm_module :: Blob
</span><a href="#local-6989586621679324922"><span class="hs-identifier hs-var">wasm_module</span></a></span></span><span> </span><span id="local-6989586621679324921"><span class="annot"><span class="annottext">arg :: Blob
</span><a href="#local-6989586621679324921"><span class="hs-identifier hs-var">arg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-644"></span><span>  </span><span class="annot"><span class="annottext">IC00
-&gt; Blob
-&gt; Label &quot;install_code&quot;
-&gt; Rec
     ('R
        (Inject
           (&quot;arg&quot; ':-&gt; Blob)
           '[ &quot;canister_id&quot; ':-&gt; Principal,
              &quot;mode&quot;
              ':-&gt; Var
                     ('R '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()]),
              &quot;wasm_module&quot; ':-&gt; Blob]))
-&gt; IO ()
forall (s :: Symbol) a b.
(HasCallStack, HasAgentConfig, KnownSymbol s,
 (a -&gt; IO b) ~ (ICManagement IO .! s), CandidArg a, CandidArg b) =&gt;
IC00 -&gt; Blob -&gt; Label s -&gt; a -&gt; IO b
</span><a href="IC.Test.Agent.html#callIC"><span class="hs-identifier hs-var">callIC</span></a></span><span> </span><span class="annot"><span class="annottext">IC00
</span><a href="#local-6989586621679324925"><span class="hs-identifier hs-var">ic00</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324923"><span class="hs-identifier hs-var">canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;install_code&quot; (Label &quot;install_code&quot;)
Label &quot;install_code&quot;
</span><a href="#local-6989586621679324920"><span class="hs-var">#install_code</span></a></span><span> </span><span class="annot"><span class="annottext">(Rec
   ('R
      (Inject
         (&quot;arg&quot; ':-&gt; Blob)
         '[ &quot;canister_id&quot; ':-&gt; Principal,
            &quot;mode&quot;
            ':-&gt; Var
                   ('R '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()]),
            &quot;wasm_module&quot; ':-&gt; Blob]))
 -&gt; IO ())
-&gt; Rec
     ('R
        (Inject
           (&quot;arg&quot; ':-&gt; Blob)
           '[ &quot;canister_id&quot; ':-&gt; Principal,
              &quot;mode&quot;
              ':-&gt; Var
                     ('R '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()]),
              &quot;wasm_module&quot; ':-&gt; Blob]))
-&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Rec Empty
</span><span class="hs-identifier hs-var">empty</span></span><span>
</span><span id="line-645"></span><span>    </span><span class="annot"><span class="annottext">Rec Empty
-&gt; Rec
     ('R
        '[ &quot;mode&quot;
           ':-&gt; Var
                  ('R
                     '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()])])
-&gt; Rec
     (Empty
      .+ 'R
           '[ &quot;mode&quot;
              ':-&gt; Var
                     ('R
                        '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()])])
forall (l :: Row *) (r :: Row *).
FreeForall l =&gt;
Rec l -&gt; Rec r -&gt; Rec (l .+ r)
</span><span class="hs-operator hs-var">.+</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;mode&quot; (Label &quot;mode&quot;)
Label &quot;mode&quot;
</span><a href="#local-6989586621679324919"><span class="hs-var">#mode</span></a></span><span> </span><span class="annot"><span class="annottext">Label &quot;mode&quot;
-&gt; Var
     ('R '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()])
-&gt; Rec
     (&quot;mode&quot;
      .== Var
            ('R '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()]))
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec (l .== a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">InstallMode
Var
  ('R '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()])
</span><a href="#local-6989586621679324924"><span class="hs-identifier hs-var">mode</span></a></span><span>
</span><span id="line-646"></span><span>    </span><span class="annot"><span class="annottext">Rec
  ('R
     '[ &quot;mode&quot;
        ':-&gt; Var
               ('R
                  '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()])])
-&gt; Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; Rec
     ('R
        '[ &quot;mode&quot;
           ':-&gt; Var
                  ('R '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()])]
      .+ 'R '[ &quot;canister_id&quot; ':-&gt; Principal])
forall (l :: Row *) (r :: Row *).
FreeForall l =&gt;
Rec l -&gt; Rec r -&gt; Rec (l .+ r)
</span><span class="hs-operator hs-var">.+</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;canister_id&quot; (Label &quot;canister_id&quot;)
Label &quot;canister_id&quot;
</span><a href="#local-6989586621679324918"><span class="hs-var">#canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">Label &quot;canister_id&quot;
-&gt; Principal -&gt; Rec (&quot;canister_id&quot; .== Principal)
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec (l .== a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; Principal
</span><span class="hs-identifier hs-var">Principal</span></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324923"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-647"></span><span>    </span><span class="annot"><span class="annottext">Rec
  ('R
     '[ &quot;canister_id&quot; ':-&gt; Principal,
        &quot;mode&quot;
        ':-&gt; Var
               ('R
                  '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()])])
-&gt; Rec ('R '[ &quot;wasm_module&quot; ':-&gt; Blob])
-&gt; Rec
     ('R
        '[ &quot;canister_id&quot; ':-&gt; Principal,
           &quot;mode&quot;
           ':-&gt; Var
                  ('R '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()])]
      .+ 'R '[ &quot;wasm_module&quot; ':-&gt; Blob])
forall (l :: Row *) (r :: Row *).
FreeForall l =&gt;
Rec l -&gt; Rec r -&gt; Rec (l .+ r)
</span><span class="hs-operator hs-var">.+</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;wasm_module&quot; (Label &quot;wasm_module&quot;)
Label &quot;wasm_module&quot;
</span><a href="#local-6989586621679324916"><span class="hs-var">#wasm_module</span></a></span><span> </span><span class="annot"><span class="annottext">Label &quot;wasm_module&quot; -&gt; Blob -&gt; Rec (&quot;wasm_module&quot; .== Blob)
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec (l .== a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324922"><span class="hs-identifier hs-var">wasm_module</span></a></span><span>
</span><span id="line-648"></span><span>    </span><span class="annot"><span class="annottext">Rec
  ('R
     '[ &quot;canister_id&quot; ':-&gt; Principal,
        &quot;mode&quot;
        ':-&gt; Var
               ('R '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()]),
        &quot;wasm_module&quot; ':-&gt; Blob])
-&gt; Rec ('R '[ &quot;arg&quot; ':-&gt; Blob])
-&gt; Rec
     ('R
        '[ &quot;canister_id&quot; ':-&gt; Principal,
           &quot;mode&quot;
           ':-&gt; Var
                  ('R '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()]),
           &quot;wasm_module&quot; ':-&gt; Blob]
      .+ 'R '[ &quot;arg&quot; ':-&gt; Blob])
forall (l :: Row *) (r :: Row *).
FreeForall l =&gt;
Rec l -&gt; Rec r -&gt; Rec (l .+ r)
</span><span class="hs-operator hs-var">.+</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;arg&quot; (Label &quot;arg&quot;)
Label &quot;arg&quot;
</span><a href="#local-6989586621679324915"><span class="hs-var">#arg</span></a></span><span> </span><span class="annot"><span class="annottext">Label &quot;arg&quot; -&gt; Blob -&gt; Rec (&quot;arg&quot; .== Blob)
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec (l .== a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324921"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-649"></span><span>
</span><span id="line-650"></span><span class="annot"><a href="IC.Test.Agent.html#ic_uninstall"><span class="hs-identifier hs-type">ic_uninstall</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#HasAgentConfig"><span class="hs-identifier hs-type">HasAgentConfig</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#IC00"><span class="hs-identifier hs-type">IC00</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-651"></span><span id="ic_uninstall"><span class="annot"><span class="annottext">ic_uninstall :: IC00 -&gt; Blob -&gt; IO ()
</span><a href="IC.Test.Agent.html#ic_uninstall"><span class="hs-identifier hs-var hs-var">ic_uninstall</span></a></span></span><span> </span><span id="local-6989586621679324913"><span class="annot"><span class="annottext">ic00 :: IC00
</span><a href="#local-6989586621679324913"><span class="hs-identifier hs-var">ic00</span></a></span></span><span> </span><span id="local-6989586621679324912"><span class="annot"><span class="annottext">canister_id :: Blob
</span><a href="#local-6989586621679324912"><span class="hs-identifier hs-var">canister_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-652"></span><span>  </span><span class="annot"><span class="annottext">IC00
-&gt; Blob
-&gt; Label &quot;uninstall_code&quot;
-&gt; Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; IO ()
forall (s :: Symbol) a b.
(HasCallStack, HasAgentConfig, KnownSymbol s,
 (a -&gt; IO b) ~ (ICManagement IO .! s), CandidArg a, CandidArg b) =&gt;
IC00 -&gt; Blob -&gt; Label s -&gt; a -&gt; IO b
</span><a href="IC.Test.Agent.html#callIC"><span class="hs-identifier hs-var">callIC</span></a></span><span> </span><span class="annot"><span class="annottext">IC00
</span><a href="#local-6989586621679324913"><span class="hs-identifier hs-var">ic00</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324912"><span class="hs-identifier hs-var">canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;uninstall_code&quot; (Label &quot;uninstall_code&quot;)
Label &quot;uninstall_code&quot;
</span><a href="#local-6989586621679324911"><span class="hs-var">#uninstall_code</span></a></span><span> </span><span class="annot"><span class="annottext">(Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal]) -&gt; IO ())
-&gt; Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal]) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Rec Empty
</span><span class="hs-identifier hs-var">empty</span></span><span>
</span><span id="line-653"></span><span>    </span><span class="annot"><span class="annottext">Rec Empty
-&gt; Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; Rec (Empty .+ 'R '[ &quot;canister_id&quot; ':-&gt; Principal])
forall (l :: Row *) (r :: Row *).
FreeForall l =&gt;
Rec l -&gt; Rec r -&gt; Rec (l .+ r)
</span><span class="hs-operator hs-var">.+</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;canister_id&quot; (Label &quot;canister_id&quot;)
Label &quot;canister_id&quot;
</span><a href="#local-6989586621679324910"><span class="hs-var">#canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">Label &quot;canister_id&quot;
-&gt; Principal -&gt; Rec (&quot;canister_id&quot; .== Principal)
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec (l .== a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; Principal
</span><span class="hs-identifier hs-var">Principal</span></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324912"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-654"></span><span>
</span><span id="line-655"></span><span class="annot"><a href="IC.Test.Agent.html#ic_set_controllers"><span class="hs-identifier hs-type">ic_set_controllers</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#HasAgentConfig"><span class="hs-identifier hs-type">HasAgentConfig</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#IC00"><span class="hs-identifier hs-type">IC00</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-656"></span><span id="ic_set_controllers"><span class="annot"><span class="annottext">ic_set_controllers :: IC00 -&gt; Blob -&gt; [Blob] -&gt; IO ()
</span><a href="IC.Test.Agent.html#ic_set_controllers"><span class="hs-identifier hs-var hs-var">ic_set_controllers</span></a></span></span><span> </span><span id="local-6989586621679324908"><span class="annot"><span class="annottext">ic00 :: IC00
</span><a href="#local-6989586621679324908"><span class="hs-identifier hs-var">ic00</span></a></span></span><span> </span><span id="local-6989586621679324907"><span class="annot"><span class="annottext">canister_id :: Blob
</span><a href="#local-6989586621679324907"><span class="hs-identifier hs-var">canister_id</span></a></span></span><span> </span><span id="local-6989586621679324906"><span class="annot"><span class="annottext">new_controllers :: [Blob]
</span><a href="#local-6989586621679324906"><span class="hs-identifier hs-var">new_controllers</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-657"></span><span>  </span><span class="annot"><span class="annottext">IC00
-&gt; Blob
-&gt; Label &quot;update_settings&quot;
-&gt; Rec
     ('R
        (Inject
           (&quot;settings&quot;
            ':-&gt; Rec
                   ('R
                      '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                         &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                         &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                         &quot;memory_allocation&quot; ':-&gt; Maybe Natural]))
           '[ &quot;canister_id&quot; ':-&gt; Principal]))
-&gt; IO ()
forall (s :: Symbol) a b.
(HasCallStack, HasAgentConfig, KnownSymbol s,
 (a -&gt; IO b) ~ (ICManagement IO .! s), CandidArg a, CandidArg b) =&gt;
IC00 -&gt; Blob -&gt; Label s -&gt; a -&gt; IO b
</span><a href="IC.Test.Agent.html#callIC"><span class="hs-identifier hs-var">callIC</span></a></span><span> </span><span class="annot"><span class="annottext">IC00
</span><a href="#local-6989586621679324908"><span class="hs-identifier hs-var">ic00</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324907"><span class="hs-identifier hs-var">canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;update_settings&quot; (Label &quot;update_settings&quot;)
Label &quot;update_settings&quot;
</span><a href="#local-6989586621679324905"><span class="hs-var">#update_settings</span></a></span><span> </span><span class="annot"><span class="annottext">(Rec
   ('R
      (Inject
         (&quot;settings&quot;
          ':-&gt; Rec
                 ('R
                    '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                       &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                       &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                       &quot;memory_allocation&quot; ':-&gt; Maybe Natural]))
         '[ &quot;canister_id&quot; ':-&gt; Principal]))
 -&gt; IO ())
-&gt; Rec
     ('R
        (Inject
           (&quot;settings&quot;
            ':-&gt; Rec
                   ('R
                      '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                         &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                         &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                         &quot;memory_allocation&quot; ':-&gt; Maybe Natural]))
           '[ &quot;canister_id&quot; ':-&gt; Principal]))
-&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Rec Empty
</span><span class="hs-identifier hs-var">empty</span></span><span>
</span><span id="line-658"></span><span>    </span><span class="annot"><span class="annottext">Rec Empty
-&gt; Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; Rec (Empty .+ 'R '[ &quot;canister_id&quot; ':-&gt; Principal])
forall (l :: Row *) (r :: Row *).
FreeForall l =&gt;
Rec l -&gt; Rec r -&gt; Rec (l .+ r)
</span><span class="hs-operator hs-var">.+</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;canister_id&quot; (Label &quot;canister_id&quot;)
Label &quot;canister_id&quot;
</span><a href="#local-6989586621679324904"><span class="hs-var">#canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">Label &quot;canister_id&quot;
-&gt; Principal -&gt; Rec (&quot;canister_id&quot; .== Principal)
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec (l .== a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; Principal
</span><span class="hs-identifier hs-var">Principal</span></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324907"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-659"></span><span>    </span><span class="annot"><span class="annottext">Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; Rec
     ('R
        '[ &quot;settings&quot;
           ':-&gt; Rec
                  ('R
                     '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                        &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                        &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                        &quot;memory_allocation&quot; ':-&gt; Maybe Natural])])
-&gt; Rec
     ('R '[ &quot;canister_id&quot; ':-&gt; Principal]
      .+ 'R
           '[ &quot;settings&quot;
              ':-&gt; Rec
                     ('R
                        '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                           &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                           &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                           &quot;memory_allocation&quot; ':-&gt; Maybe Natural])])
forall (l :: Row *) (r :: Row *).
FreeForall l =&gt;
Rec l -&gt; Rec r -&gt; Rec (l .+ r)
</span><span class="hs-operator hs-var">.+</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;settings&quot; (Label &quot;settings&quot;)
Label &quot;settings&quot;
</span><a href="#local-6989586621679324903"><span class="hs-var">#settings</span></a></span><span> </span><span class="annot"><span class="annottext">Label &quot;settings&quot;
-&gt; Rec
     ('R
        '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
           &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
           &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
           &quot;memory_allocation&quot; ':-&gt; Maybe Natural])
-&gt; Rec
     (&quot;settings&quot;
      .== Rec
            ('R
               '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                  &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                  &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                  &quot;memory_allocation&quot; ':-&gt; Maybe Natural]))
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec (l .== a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">Rec ('R '[ &quot;controllers&quot; ':-&gt; Vector Principal]) -&gt; Settings
forall (r :: Row *). PartialSettings r =&gt; Rec r -&gt; Settings
</span><a href="IC.Test.Agent.html#fromPartialSettings"><span class="hs-identifier hs-var">fromPartialSettings</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IsLabel &quot;controllers&quot; (Label &quot;controllers&quot;)
Label &quot;controllers&quot;
</span><a href="#local-6989586621679324902"><span class="hs-var">#controllers</span></a></span><span> </span><span class="annot"><span class="annottext">Label &quot;controllers&quot;
-&gt; Vector Principal -&gt; Rec (&quot;controllers&quot; .== Vector Principal)
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec (l .== a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">[Principal] -&gt; Vector Principal
forall a. [a] -&gt; Vector a
</span><span class="hs-identifier hs-var">Vec.fromList</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Blob -&gt; Principal) -&gt; [Blob] -&gt; [Principal]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; Principal
</span><span class="hs-identifier hs-var">Principal</span></span><span> </span><span class="annot"><span class="annottext">[Blob]
</span><a href="#local-6989586621679324906"><span class="hs-identifier hs-var">new_controllers</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-660"></span><span>
</span><span id="line-661"></span><span class="annot"><a href="IC.Test.Agent.html#ic_start_canister"><span class="hs-identifier hs-type">ic_start_canister</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#HasAgentConfig"><span class="hs-identifier hs-type">HasAgentConfig</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#IC00"><span class="hs-identifier hs-type">IC00</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-662"></span><span id="ic_start_canister"><span class="annot"><span class="annottext">ic_start_canister :: IC00 -&gt; Blob -&gt; IO ()
</span><a href="IC.Test.Agent.html#ic_start_canister"><span class="hs-identifier hs-var hs-var">ic_start_canister</span></a></span></span><span> </span><span id="local-6989586621679324899"><span class="annot"><span class="annottext">ic00 :: IC00
</span><a href="#local-6989586621679324899"><span class="hs-identifier hs-var">ic00</span></a></span></span><span> </span><span id="local-6989586621679324898"><span class="annot"><span class="annottext">canister_id :: Blob
</span><a href="#local-6989586621679324898"><span class="hs-identifier hs-var">canister_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-663"></span><span>  </span><span class="annot"><span class="annottext">IC00
-&gt; Blob
-&gt; Label &quot;start_canister&quot;
-&gt; Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; IO ()
forall (s :: Symbol) a b.
(HasCallStack, HasAgentConfig, KnownSymbol s,
 (a -&gt; IO b) ~ (ICManagement IO .! s), CandidArg a, CandidArg b) =&gt;
IC00 -&gt; Blob -&gt; Label s -&gt; a -&gt; IO b
</span><a href="IC.Test.Agent.html#callIC"><span class="hs-identifier hs-var">callIC</span></a></span><span> </span><span class="annot"><span class="annottext">IC00
</span><a href="#local-6989586621679324899"><span class="hs-identifier hs-var">ic00</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324898"><span class="hs-identifier hs-var">canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;start_canister&quot; (Label &quot;start_canister&quot;)
Label &quot;start_canister&quot;
</span><a href="#local-6989586621679324897"><span class="hs-var">#start_canister</span></a></span><span> </span><span class="annot"><span class="annottext">(Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal]) -&gt; IO ())
-&gt; Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal]) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Rec Empty
</span><span class="hs-identifier hs-var">empty</span></span><span>
</span><span id="line-664"></span><span>    </span><span class="annot"><span class="annottext">Rec Empty
-&gt; Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; Rec (Empty .+ 'R '[ &quot;canister_id&quot; ':-&gt; Principal])
forall (l :: Row *) (r :: Row *).
FreeForall l =&gt;
Rec l -&gt; Rec r -&gt; Rec (l .+ r)
</span><span class="hs-operator hs-var">.+</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;canister_id&quot; (Label &quot;canister_id&quot;)
Label &quot;canister_id&quot;
</span><a href="#local-6989586621679324896"><span class="hs-var">#canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">Label &quot;canister_id&quot;
-&gt; Principal -&gt; Rec (&quot;canister_id&quot; .== Principal)
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec (l .== a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; Principal
</span><span class="hs-identifier hs-var">Principal</span></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324898"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-665"></span><span>
</span><span id="line-666"></span><span class="annot"><a href="IC.Test.Agent.html#ic_stop_canister"><span class="hs-identifier hs-type">ic_stop_canister</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#HasAgentConfig"><span class="hs-identifier hs-type">HasAgentConfig</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#IC00"><span class="hs-identifier hs-type">IC00</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-667"></span><span id="ic_stop_canister"><span class="annot"><span class="annottext">ic_stop_canister :: IC00 -&gt; Blob -&gt; IO ()
</span><a href="IC.Test.Agent.html#ic_stop_canister"><span class="hs-identifier hs-var hs-var">ic_stop_canister</span></a></span></span><span> </span><span id="local-6989586621679324894"><span class="annot"><span class="annottext">ic00 :: IC00
</span><a href="#local-6989586621679324894"><span class="hs-identifier hs-var">ic00</span></a></span></span><span> </span><span id="local-6989586621679324893"><span class="annot"><span class="annottext">canister_id :: Blob
</span><a href="#local-6989586621679324893"><span class="hs-identifier hs-var">canister_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-668"></span><span>  </span><span class="annot"><span class="annottext">IC00
-&gt; Blob
-&gt; Label &quot;stop_canister&quot;
-&gt; Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; IO ()
forall (s :: Symbol) a b.
(HasCallStack, HasAgentConfig, KnownSymbol s,
 (a -&gt; IO b) ~ (ICManagement IO .! s), CandidArg a, CandidArg b) =&gt;
IC00 -&gt; Blob -&gt; Label s -&gt; a -&gt; IO b
</span><a href="IC.Test.Agent.html#callIC"><span class="hs-identifier hs-var">callIC</span></a></span><span> </span><span class="annot"><span class="annottext">IC00
</span><a href="#local-6989586621679324894"><span class="hs-identifier hs-var">ic00</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324893"><span class="hs-identifier hs-var">canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;stop_canister&quot; (Label &quot;stop_canister&quot;)
Label &quot;stop_canister&quot;
</span><a href="#local-6989586621679324892"><span class="hs-var">#stop_canister</span></a></span><span> </span><span class="annot"><span class="annottext">(Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal]) -&gt; IO ())
-&gt; Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal]) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Rec Empty
</span><span class="hs-identifier hs-var">empty</span></span><span>
</span><span id="line-669"></span><span>    </span><span class="annot"><span class="annottext">Rec Empty
-&gt; Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; Rec (Empty .+ 'R '[ &quot;canister_id&quot; ':-&gt; Principal])
forall (l :: Row *) (r :: Row *).
FreeForall l =&gt;
Rec l -&gt; Rec r -&gt; Rec (l .+ r)
</span><span class="hs-operator hs-var">.+</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;canister_id&quot; (Label &quot;canister_id&quot;)
Label &quot;canister_id&quot;
</span><a href="#local-6989586621679324891"><span class="hs-var">#canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">Label &quot;canister_id&quot;
-&gt; Principal -&gt; Rec (&quot;canister_id&quot; .== Principal)
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec (l .== a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; Principal
</span><span class="hs-identifier hs-var">Principal</span></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324893"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-670"></span><span>
</span><span id="line-671"></span><span class="annot"><a href="IC.Test.Agent.html#ic_canister_status"><span class="hs-identifier hs-type">ic_canister_status</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-672"></span><span>    </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679324889"><span class="annot"><a href="#local-6989586621679324889"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span id="local-6989586621679324888"><span class="annot"><a href="#local-6989586621679324888"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679324889"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679324888"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-glyph hs-type">~</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Management.html#ICManagement"><span class="hs-identifier hs-type">ICManagement</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">.!</span></span><span> </span><span class="annot"><span class="hs-string">&quot;canister_status&quot;</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-673"></span><span>    </span><span class="annot"><a href="IC.Test.Agent.html#HasAgentConfig"><span class="hs-identifier hs-type">HasAgentConfig</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#IC00"><span class="hs-identifier hs-type">IC00</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679324888"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-674"></span><span id="ic_canister_status"><span class="annot"><span class="annottext">ic_canister_status :: IC00 -&gt; Blob -&gt; IO b
</span><a href="IC.Test.Agent.html#ic_canister_status"><span class="hs-identifier hs-var hs-var">ic_canister_status</span></a></span></span><span> </span><span id="local-6989586621679324887"><span class="annot"><span class="annottext">ic00 :: IC00
</span><a href="#local-6989586621679324887"><span class="hs-identifier hs-var">ic00</span></a></span></span><span> </span><span id="local-6989586621679324886"><span class="annot"><span class="annottext">canister_id :: Blob
</span><a href="#local-6989586621679324886"><span class="hs-identifier hs-var">canister_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-675"></span><span>  </span><span class="annot"><span class="annottext">IC00
-&gt; Blob
-&gt; Label &quot;canister_status&quot;
-&gt; Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; IO b
forall (s :: Symbol) a b.
(HasCallStack, HasAgentConfig, KnownSymbol s,
 (a -&gt; IO b) ~ (ICManagement IO .! s), CandidArg a, CandidArg b) =&gt;
IC00 -&gt; Blob -&gt; Label s -&gt; a -&gt; IO b
</span><a href="IC.Test.Agent.html#callIC"><span class="hs-identifier hs-var">callIC</span></a></span><span> </span><span class="annot"><span class="annottext">IC00
</span><a href="#local-6989586621679324887"><span class="hs-identifier hs-var">ic00</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324886"><span class="hs-identifier hs-var">canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;canister_status&quot; (Label &quot;canister_status&quot;)
Label &quot;canister_status&quot;
</span><a href="#local-6989586621679324885"><span class="hs-var">#canister_status</span></a></span><span> </span><span class="annot"><span class="annottext">(Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal]) -&gt; IO b)
-&gt; Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal]) -&gt; IO b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Rec Empty
</span><span class="hs-identifier hs-var">empty</span></span><span>
</span><span id="line-676"></span><span>    </span><span class="annot"><span class="annottext">Rec Empty
-&gt; Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; Rec (Empty .+ 'R '[ &quot;canister_id&quot; ':-&gt; Principal])
forall (l :: Row *) (r :: Row *).
FreeForall l =&gt;
Rec l -&gt; Rec r -&gt; Rec (l .+ r)
</span><span class="hs-operator hs-var">.+</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;canister_id&quot; (Label &quot;canister_id&quot;)
Label &quot;canister_id&quot;
</span><a href="#local-6989586621679324884"><span class="hs-var">#canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">Label &quot;canister_id&quot;
-&gt; Principal -&gt; Rec (&quot;canister_id&quot; .== Principal)
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec (l .== a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; Principal
</span><span class="hs-identifier hs-var">Principal</span></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324886"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-677"></span><span>
</span><span id="line-678"></span><span class="annot"><a href="IC.Test.Agent.html#ic_deposit_cycles"><span class="hs-identifier hs-type">ic_deposit_cycles</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#HasAgentConfig"><span class="hs-identifier hs-type">HasAgentConfig</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#IC00"><span class="hs-identifier hs-type">IC00</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-679"></span><span id="ic_deposit_cycles"><span class="annot"><span class="annottext">ic_deposit_cycles :: IC00 -&gt; Blob -&gt; IO ()
</span><a href="IC.Test.Agent.html#ic_deposit_cycles"><span class="hs-identifier hs-var hs-var">ic_deposit_cycles</span></a></span></span><span> </span><span id="local-6989586621679324882"><span class="annot"><span class="annottext">ic00 :: IC00
</span><a href="#local-6989586621679324882"><span class="hs-identifier hs-var">ic00</span></a></span></span><span> </span><span id="local-6989586621679324881"><span class="annot"><span class="annottext">canister_id :: Blob
</span><a href="#local-6989586621679324881"><span class="hs-identifier hs-var">canister_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-680"></span><span>  </span><span class="annot"><span class="annottext">IC00
-&gt; Blob
-&gt; Label &quot;deposit_cycles&quot;
-&gt; Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; IO ()
forall (s :: Symbol) a b.
(HasCallStack, HasAgentConfig, KnownSymbol s,
 (a -&gt; IO b) ~ (ICManagement IO .! s), CandidArg a, CandidArg b) =&gt;
IC00 -&gt; Blob -&gt; Label s -&gt; a -&gt; IO b
</span><a href="IC.Test.Agent.html#callIC"><span class="hs-identifier hs-var">callIC</span></a></span><span> </span><span class="annot"><span class="annottext">IC00
</span><a href="#local-6989586621679324882"><span class="hs-identifier hs-var">ic00</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324881"><span class="hs-identifier hs-var">canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;deposit_cycles&quot; (Label &quot;deposit_cycles&quot;)
Label &quot;deposit_cycles&quot;
</span><a href="#local-6989586621679324880"><span class="hs-var">#deposit_cycles</span></a></span><span> </span><span class="annot"><span class="annottext">(Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal]) -&gt; IO ())
-&gt; Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal]) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Rec Empty
</span><span class="hs-identifier hs-var">empty</span></span><span>
</span><span id="line-681"></span><span>    </span><span class="annot"><span class="annottext">Rec Empty
-&gt; Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; Rec (Empty .+ 'R '[ &quot;canister_id&quot; ':-&gt; Principal])
forall (l :: Row *) (r :: Row *).
FreeForall l =&gt;
Rec l -&gt; Rec r -&gt; Rec (l .+ r)
</span><span class="hs-operator hs-var">.+</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;canister_id&quot; (Label &quot;canister_id&quot;)
Label &quot;canister_id&quot;
</span><a href="#local-6989586621679324879"><span class="hs-var">#canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">Label &quot;canister_id&quot;
-&gt; Principal -&gt; Rec (&quot;canister_id&quot; .== Principal)
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec (l .== a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; Principal
</span><span class="hs-identifier hs-var">Principal</span></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324881"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-682"></span><span>
</span><span id="line-683"></span><span class="annot"><a href="IC.Test.Agent.html#ic_top_up"><span class="hs-identifier hs-type">ic_top_up</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#HasAgentConfig"><span class="hs-identifier hs-type">HasAgentConfig</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#IC00"><span class="hs-identifier hs-type">IC00</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Natural</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-684"></span><span id="ic_top_up"><span class="annot"><span class="annottext">ic_top_up :: IC00 -&gt; Blob -&gt; Natural -&gt; IO ()
</span><a href="IC.Test.Agent.html#ic_top_up"><span class="hs-identifier hs-var hs-var">ic_top_up</span></a></span></span><span> </span><span id="local-6989586621679324877"><span class="annot"><span class="annottext">ic00 :: IC00
</span><a href="#local-6989586621679324877"><span class="hs-identifier hs-var">ic00</span></a></span></span><span> </span><span id="local-6989586621679324876"><span class="annot"><span class="annottext">canister_id :: Blob
</span><a href="#local-6989586621679324876"><span class="hs-identifier hs-var">canister_id</span></a></span></span><span> </span><span id="local-6989586621679324875"><span class="annot"><span class="annottext">amount :: Natural
</span><a href="#local-6989586621679324875"><span class="hs-identifier hs-var">amount</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-685"></span><span>  </span><span class="annot"><span class="annottext">IC00
-&gt; Blob
-&gt; Label &quot;provisional_top_up_canister&quot;
-&gt; Rec
     ('R
        (Inject (&quot;amount&quot; ':-&gt; Natural) '[ &quot;canister_id&quot; ':-&gt; Principal]))
-&gt; IO ()
forall (s :: Symbol) a b.
(HasCallStack, HasAgentConfig, KnownSymbol s,
 (a -&gt; IO b) ~ (ICManagement IO .! s), CandidArg a, CandidArg b) =&gt;
IC00 -&gt; Blob -&gt; Label s -&gt; a -&gt; IO b
</span><a href="IC.Test.Agent.html#callIC"><span class="hs-identifier hs-var">callIC</span></a></span><span> </span><span class="annot"><span class="annottext">IC00
</span><a href="#local-6989586621679324877"><span class="hs-identifier hs-var">ic00</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324876"><span class="hs-identifier hs-var">canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;provisional_top_up_canister&quot; (Label &quot;provisional_top_up_canister&quot;)
Label &quot;provisional_top_up_canister&quot;
</span><a href="#local-6989586621679324874"><span class="hs-var">#provisional_top_up_canister</span></a></span><span> </span><span class="annot"><span class="annottext">(Rec
   ('R
      (Inject (&quot;amount&quot; ':-&gt; Natural) '[ &quot;canister_id&quot; ':-&gt; Principal]))
 -&gt; IO ())
-&gt; Rec
     ('R
        (Inject (&quot;amount&quot; ':-&gt; Natural) '[ &quot;canister_id&quot; ':-&gt; Principal]))
-&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Rec Empty
</span><span class="hs-identifier hs-var">empty</span></span><span>
</span><span id="line-686"></span><span>    </span><span class="annot"><span class="annottext">Rec Empty
-&gt; Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; Rec (Empty .+ 'R '[ &quot;canister_id&quot; ':-&gt; Principal])
forall (l :: Row *) (r :: Row *).
FreeForall l =&gt;
Rec l -&gt; Rec r -&gt; Rec (l .+ r)
</span><span class="hs-operator hs-var">.+</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;canister_id&quot; (Label &quot;canister_id&quot;)
Label &quot;canister_id&quot;
</span><a href="#local-6989586621679324873"><span class="hs-var">#canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">Label &quot;canister_id&quot;
-&gt; Principal -&gt; Rec (&quot;canister_id&quot; .== Principal)
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec (l .== a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; Principal
</span><span class="hs-identifier hs-var">Principal</span></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324876"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-687"></span><span>    </span><span class="annot"><span class="annottext">Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; Rec ('R '[ &quot;amount&quot; ':-&gt; Natural])
-&gt; Rec
     ('R '[ &quot;canister_id&quot; ':-&gt; Principal]
      .+ 'R '[ &quot;amount&quot; ':-&gt; Natural])
forall (l :: Row *) (r :: Row *).
FreeForall l =&gt;
Rec l -&gt; Rec r -&gt; Rec (l .+ r)
</span><span class="hs-operator hs-var">.+</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;amount&quot; (Label &quot;amount&quot;)
Label &quot;amount&quot;
</span><a href="#local-6989586621679324872"><span class="hs-var">#amount</span></a></span><span> </span><span class="annot"><span class="annottext">Label &quot;amount&quot; -&gt; Natural -&gt; Rec (&quot;amount&quot; .== Natural)
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec (l .== a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679324875"><span class="hs-identifier hs-var">amount</span></a></span><span>
</span><span id="line-688"></span><span>
</span><span id="line-689"></span><span class="annot"><a href="IC.Test.Agent.html#ic_delete_canister"><span class="hs-identifier hs-type">ic_delete_canister</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#HasAgentConfig"><span class="hs-identifier hs-type">HasAgentConfig</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#IC00"><span class="hs-identifier hs-type">IC00</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-690"></span><span id="ic_delete_canister"><span class="annot"><span class="annottext">ic_delete_canister :: IC00 -&gt; Blob -&gt; IO ()
</span><a href="IC.Test.Agent.html#ic_delete_canister"><span class="hs-identifier hs-var hs-var">ic_delete_canister</span></a></span></span><span> </span><span id="local-6989586621679324870"><span class="annot"><span class="annottext">ic00 :: IC00
</span><a href="#local-6989586621679324870"><span class="hs-identifier hs-var">ic00</span></a></span></span><span> </span><span id="local-6989586621679324869"><span class="annot"><span class="annottext">canister_id :: Blob
</span><a href="#local-6989586621679324869"><span class="hs-identifier hs-var">canister_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-691"></span><span>  </span><span class="annot"><span class="annottext">IC00
-&gt; Blob
-&gt; Label &quot;delete_canister&quot;
-&gt; Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; IO ()
forall (s :: Symbol) a b.
(HasCallStack, HasAgentConfig, KnownSymbol s,
 (a -&gt; IO b) ~ (ICManagement IO .! s), CandidArg a, CandidArg b) =&gt;
IC00 -&gt; Blob -&gt; Label s -&gt; a -&gt; IO b
</span><a href="IC.Test.Agent.html#callIC"><span class="hs-identifier hs-var">callIC</span></a></span><span> </span><span class="annot"><span class="annottext">IC00
</span><a href="#local-6989586621679324870"><span class="hs-identifier hs-var">ic00</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324869"><span class="hs-identifier hs-var">canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;delete_canister&quot; (Label &quot;delete_canister&quot;)
Label &quot;delete_canister&quot;
</span><a href="#local-6989586621679324868"><span class="hs-var">#delete_canister</span></a></span><span> </span><span class="annot"><span class="annottext">(Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal]) -&gt; IO ())
-&gt; Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal]) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Rec Empty
</span><span class="hs-identifier hs-var">empty</span></span><span>
</span><span id="line-692"></span><span>    </span><span class="annot"><span class="annottext">Rec Empty
-&gt; Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; Rec (Empty .+ 'R '[ &quot;canister_id&quot; ':-&gt; Principal])
forall (l :: Row *) (r :: Row *).
FreeForall l =&gt;
Rec l -&gt; Rec r -&gt; Rec (l .+ r)
</span><span class="hs-operator hs-var">.+</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;canister_id&quot; (Label &quot;canister_id&quot;)
Label &quot;canister_id&quot;
</span><a href="#local-6989586621679324867"><span class="hs-var">#canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">Label &quot;canister_id&quot;
-&gt; Principal -&gt; Rec (&quot;canister_id&quot; .== Principal)
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec (l .== a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; Principal
</span><span class="hs-identifier hs-var">Principal</span></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324869"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-693"></span><span>
</span><span id="line-694"></span><span class="annot"><a href="IC.Test.Agent.html#ic_raw_rand"><span class="hs-identifier hs-type">ic_raw_rand</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#HasAgentConfig"><span class="hs-identifier hs-type">HasAgentConfig</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#IC00"><span class="hs-identifier hs-type">IC00</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span>
</span><span id="line-695"></span><span id="ic_raw_rand"><span class="annot"><span class="annottext">ic_raw_rand :: IC00 -&gt; IO Blob
</span><a href="IC.Test.Agent.html#ic_raw_rand"><span class="hs-identifier hs-var hs-var">ic_raw_rand</span></a></span></span><span> </span><span id="local-6989586621679324865"><span class="annot"><span class="annottext">ic00 :: IC00
</span><a href="#local-6989586621679324865"><span class="hs-identifier hs-var">ic00</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-696"></span><span>  </span><span class="annot"><span class="annottext">IC00 -&gt; Blob -&gt; Label &quot;raw_rand&quot; -&gt; () -&gt; IO Blob
forall (s :: Symbol) a b.
(HasCallStack, HasAgentConfig, KnownSymbol s,
 (a -&gt; IO b) ~ (ICManagement IO .! s), CandidArg a, CandidArg b) =&gt;
IC00 -&gt; Blob -&gt; Label s -&gt; a -&gt; IO b
</span><a href="IC.Test.Agent.html#callIC"><span class="hs-identifier hs-var">callIC</span></a></span><span> </span><span class="annot"><span class="annottext">IC00
</span><a href="#local-6989586621679324865"><span class="hs-identifier hs-var">ic00</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;raw_rand&quot; (Label &quot;raw_rand&quot;)
Label &quot;raw_rand&quot;
</span><a href="#local-6989586621679324864"><span class="hs-var">#raw_rand</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-697"></span><span>
</span><span id="line-698"></span><span class="hs-comment">-- Primed variants return the response (reply or reject)</span><span>
</span><span id="line-699"></span><span class="annot"><a href="IC.Test.Agent.html#callIC%27"><span class="hs-identifier hs-type">callIC'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679325399"><span class="annot"><a href="#local-6989586621679325399"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span id="local-6989586621679325398"><span class="annot"><a href="#local-6989586621679325398"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span id="local-6989586621679325397"><span class="annot"><a href="#local-6989586621679325397"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-700"></span><span>  </span><span class="annot"><a href="IC.Test.Agent.html#HasAgentConfig"><span class="hs-identifier hs-type">HasAgentConfig</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-701"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">KnownSymbol</span></span><span> </span><span class="annot"><a href="#local-6989586621679325399"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-702"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679325398"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679325397"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-glyph hs-type">~</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Management.html#ICManagement"><span class="hs-identifier hs-type">ICManagement</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">.!</span></span><span> </span><span class="annot"><a href="#local-6989586621679325399"><span class="hs-identifier hs-type">s</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-703"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Candid.CandidArg</span></span><span> </span><span class="annot"><a href="#local-6989586621679325398"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-704"></span><span>  </span><span class="annot"><a href="IC.Test.Agent.html#IC00"><span class="hs-identifier hs-type">IC00</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Label</span></span><span> </span><span class="annot"><a href="#local-6989586621679325399"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679325398"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="IC.Test.Agent.html#ReqResponse"><span class="hs-identifier hs-type">ReqResponse</span></a></span><span>
</span><span id="line-705"></span><span id="callIC%27"><span class="annot"><span class="annottext">callIC' :: IC00 -&gt; Blob -&gt; Label s -&gt; a -&gt; IO ReqResponse
</span><a href="IC.Test.Agent.html#callIC%27"><span class="hs-identifier hs-var hs-var">callIC'</span></a></span></span><span> </span><span id="local-6989586621679324862"><span class="annot"><span class="annottext">ic00 :: IC00
</span><a href="#local-6989586621679324862"><span class="hs-identifier hs-var">ic00</span></a></span></span><span> </span><span id="local-6989586621679324861"><span class="annot"><span class="annottext">ecid :: Blob
</span><a href="#local-6989586621679324861"><span class="hs-identifier hs-var">ecid</span></a></span></span><span> </span><span id="local-6989586621679324860"><span class="annot"><span class="annottext">l :: Label s
</span><a href="#local-6989586621679324860"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span id="local-6989586621679324859"><span class="annot"><span class="annottext">x :: a
</span><a href="#local-6989586621679324859"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IC00
</span><a href="#local-6989586621679324862"><span class="hs-identifier hs-var">ic00</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324861"><span class="hs-identifier hs-var">ecid</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">T.pack</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Label s -&gt; String
forall (n :: Symbol) (proxy :: Symbol -&gt; *).
KnownSymbol n =&gt;
proxy n -&gt; String
</span><span class="hs-identifier hs-var">symbolVal</span></span><span> </span><span class="annot"><span class="annottext">Label s
</span><a href="#local-6989586621679324860"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Blob
forall a. CandidArg a =&gt; a -&gt; Blob
</span><span class="hs-identifier hs-var">Candid.encode</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679324859"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-706"></span><span>
</span><span id="line-707"></span><span id="local-6989586621679324858"><span class="annot"><a href="IC.Test.Agent.html#ic_create%27"><span class="hs-identifier hs-type">ic_create'</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-708"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#HasAgentConfig"><span class="hs-identifier hs-type">HasAgentConfig</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#PartialSettings"><span class="hs-identifier hs-type">PartialSettings</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679324858"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-709"></span><span>    </span><span class="annot"><a href="IC.Test.Agent.html#IC00"><span class="hs-identifier hs-type">IC00</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Rec</span></span><span> </span><span class="annot"><a href="#local-6989586621679324858"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="IC.Test.Agent.html#ReqResponse"><span class="hs-identifier hs-type">ReqResponse</span></a></span></span><span>
</span><span id="line-710"></span><span id="ic_create%27"><span class="annot"><span class="annottext">ic_create' :: IC00 -&gt; Rec r -&gt; IO ReqResponse
</span><a href="IC.Test.Agent.html#ic_create%27"><span class="hs-identifier hs-var hs-var">ic_create'</span></a></span></span><span> </span><span id="local-6989586621679324856"><span class="annot"><span class="annottext">ic00 :: IC00
</span><a href="#local-6989586621679324856"><span class="hs-identifier hs-var">ic00</span></a></span></span><span> </span><span id="local-6989586621679324855"><span class="annot"><span class="annottext">ps :: Rec r
</span><a href="#local-6989586621679324855"><span class="hs-identifier hs-var">ps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-711"></span><span>  </span><span class="annot"><span class="annottext">IC00
-&gt; Blob
-&gt; Label &quot;create_canister&quot;
-&gt; Rec
     ('R
        '[ &quot;settings&quot;
           ':-&gt; Maybe
                  (Rec
                     ('R
                        '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                           &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                           &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                           &quot;memory_allocation&quot; ':-&gt; Maybe Natural]))])
-&gt; IO ReqResponse
forall (s :: Symbol) a b.
(HasAgentConfig, KnownSymbol s,
 (a -&gt; IO b) ~ (ICManagement IO .! s), CandidArg a) =&gt;
IC00 -&gt; Blob -&gt; Label s -&gt; a -&gt; IO ReqResponse
</span><a href="IC.Test.Agent.html#callIC%27"><span class="hs-identifier hs-var">callIC'</span></a></span><span> </span><span class="annot"><span class="annottext">IC00
</span><a href="#local-6989586621679324856"><span class="hs-identifier hs-var">ic00</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;create_canister&quot; (Label &quot;create_canister&quot;)
Label &quot;create_canister&quot;
</span><a href="#local-6989586621679324854"><span class="hs-var">#create_canister</span></a></span><span> </span><span class="annot"><span class="annottext">(Rec
   ('R
      '[ &quot;settings&quot;
         ':-&gt; Maybe
                (Rec
                   ('R
                      '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                         &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                         &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                         &quot;memory_allocation&quot; ':-&gt; Maybe Natural]))])
 -&gt; IO ReqResponse)
-&gt; Rec
     ('R
        '[ &quot;settings&quot;
           ':-&gt; Maybe
                  (Rec
                     ('R
                        '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                           &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                           &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                           &quot;memory_allocation&quot; ':-&gt; Maybe Natural]))])
-&gt; IO ReqResponse
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Rec Empty
</span><span class="hs-identifier hs-var">empty</span></span><span>
</span><span id="line-712"></span><span>    </span><span class="annot"><span class="annottext">Rec Empty
-&gt; Rec
     ('R
        '[ &quot;settings&quot;
           ':-&gt; Maybe
                  (Rec
                     ('R
                        '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                           &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                           &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                           &quot;memory_allocation&quot; ':-&gt; Maybe Natural]))])
-&gt; Rec
     (Empty
      .+ 'R
           '[ &quot;settings&quot;
              ':-&gt; Maybe
                     (Rec
                        ('R
                           '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                              &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                              &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                              &quot;memory_allocation&quot; ':-&gt; Maybe Natural]))])
forall (l :: Row *) (r :: Row *).
FreeForall l =&gt;
Rec l -&gt; Rec r -&gt; Rec (l .+ r)
</span><span class="hs-operator hs-var">.+</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;settings&quot; (Label &quot;settings&quot;)
Label &quot;settings&quot;
</span><a href="#local-6989586621679324853"><span class="hs-var">#settings</span></a></span><span> </span><span class="annot"><span class="annottext">Label &quot;settings&quot;
-&gt; Maybe
     (Rec
        ('R
           '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
              &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
              &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
              &quot;memory_allocation&quot; ':-&gt; Maybe Natural]))
-&gt; Rec
     (&quot;settings&quot;
      .== Maybe
            (Rec
               ('R
                  '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                     &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                     &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                     &quot;memory_allocation&quot; ':-&gt; Maybe Natural])))
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec (l .== a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">Rec
  ('R
     '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
        &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
        &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
        &quot;memory_allocation&quot; ':-&gt; Maybe Natural])
-&gt; Maybe
     (Rec
        ('R
           '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
              &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
              &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
              &quot;memory_allocation&quot; ':-&gt; Maybe Natural]))
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Rec r -&gt; Settings
forall (r :: Row *). PartialSettings r =&gt; Rec r -&gt; Settings
</span><a href="IC.Test.Agent.html#fromPartialSettings"><span class="hs-identifier hs-var">fromPartialSettings</span></a></span><span> </span><span class="annot"><span class="annottext">Rec r
</span><a href="#local-6989586621679324855"><span class="hs-identifier hs-var">ps</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-713"></span><span>
</span><span id="line-714"></span><span id="local-6989586621679324852"><span class="annot"><a href="IC.Test.Agent.html#ic_provisional_create%27"><span class="hs-identifier hs-type">ic_provisional_create'</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-715"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#HasAgentConfig"><span class="hs-identifier hs-type">HasAgentConfig</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#PartialSettings"><span class="hs-identifier hs-type">PartialSettings</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679324852"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-716"></span><span>    </span><span class="annot"><a href="IC.Test.Agent.html#IC00"><span class="hs-identifier hs-type">IC00</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Natural</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Rec</span></span><span> </span><span class="annot"><a href="#local-6989586621679324852"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="IC.Test.Agent.html#ReqResponse"><span class="hs-identifier hs-type">ReqResponse</span></a></span></span><span>
</span><span id="line-717"></span><span id="ic_provisional_create%27"><span class="annot"><span class="annottext">ic_provisional_create' :: IC00 -&gt; Maybe Natural -&gt; Rec r -&gt; IO ReqResponse
</span><a href="IC.Test.Agent.html#ic_provisional_create%27"><span class="hs-identifier hs-var hs-var">ic_provisional_create'</span></a></span></span><span> </span><span id="local-6989586621679324850"><span class="annot"><span class="annottext">ic00 :: IC00
</span><a href="#local-6989586621679324850"><span class="hs-identifier hs-var">ic00</span></a></span></span><span> </span><span id="local-6989586621679324849"><span class="annot"><span class="annottext">cycles :: Maybe Natural
</span><a href="#local-6989586621679324849"><span class="hs-identifier hs-var">cycles</span></a></span></span><span> </span><span id="local-6989586621679324848"><span class="annot"><span class="annottext">ps :: Rec r
</span><a href="#local-6989586621679324848"><span class="hs-identifier hs-var">ps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-718"></span><span>  </span><span class="annot"><span class="annottext">IC00
-&gt; Blob
-&gt; Label &quot;provisional_create_canister_with_cycles&quot;
-&gt; Rec
     ('R
        (Inject
           (&quot;settings&quot;
            ':-&gt; Maybe
                   (Rec
                      ('R
                         '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                            &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                            &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                            &quot;memory_allocation&quot; ':-&gt; Maybe Natural])))
           '[ &quot;amount&quot; ':-&gt; Maybe Natural]))
-&gt; IO ReqResponse
forall (s :: Symbol) a b.
(HasAgentConfig, KnownSymbol s,
 (a -&gt; IO b) ~ (ICManagement IO .! s), CandidArg a) =&gt;
IC00 -&gt; Blob -&gt; Label s -&gt; a -&gt; IO ReqResponse
</span><a href="IC.Test.Agent.html#callIC%27"><span class="hs-identifier hs-var">callIC'</span></a></span><span> </span><span class="annot"><span class="annottext">IC00
</span><a href="#local-6989586621679324850"><span class="hs-identifier hs-var">ic00</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;provisional_create_canister_with_cycles&quot;
  (Label &quot;provisional_create_canister_with_cycles&quot;)
Label &quot;provisional_create_canister_with_cycles&quot;
</span><a href="#local-6989586621679324847"><span class="hs-var">#provisional_create_canister_with_cycles</span></a></span><span> </span><span class="annot"><span class="annottext">(Rec
   ('R
      (Inject
         (&quot;settings&quot;
          ':-&gt; Maybe
                 (Rec
                    ('R
                       '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                          &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                          &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                          &quot;memory_allocation&quot; ':-&gt; Maybe Natural])))
         '[ &quot;amount&quot; ':-&gt; Maybe Natural]))
 -&gt; IO ReqResponse)
-&gt; Rec
     ('R
        (Inject
           (&quot;settings&quot;
            ':-&gt; Maybe
                   (Rec
                      ('R
                         '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                            &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                            &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                            &quot;memory_allocation&quot; ':-&gt; Maybe Natural])))
           '[ &quot;amount&quot; ':-&gt; Maybe Natural]))
-&gt; IO ReqResponse
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Rec Empty
</span><span class="hs-identifier hs-var">empty</span></span><span>
</span><span id="line-719"></span><span>    </span><span class="annot"><span class="annottext">Rec Empty
-&gt; Rec ('R '[ &quot;amount&quot; ':-&gt; Maybe Natural])
-&gt; Rec (Empty .+ 'R '[ &quot;amount&quot; ':-&gt; Maybe Natural])
forall (l :: Row *) (r :: Row *).
FreeForall l =&gt;
Rec l -&gt; Rec r -&gt; Rec (l .+ r)
</span><span class="hs-operator hs-var">.+</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;amount&quot; (Label &quot;amount&quot;)
Label &quot;amount&quot;
</span><a href="#local-6989586621679324846"><span class="hs-var">#amount</span></a></span><span> </span><span class="annot"><span class="annottext">Label &quot;amount&quot; -&gt; Maybe Natural -&gt; Rec (&quot;amount&quot; .== Maybe Natural)
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec (l .== a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">Maybe Natural
</span><a href="#local-6989586621679324849"><span class="hs-identifier hs-var">cycles</span></a></span><span>
</span><span id="line-720"></span><span>    </span><span class="annot"><span class="annottext">Rec ('R '[ &quot;amount&quot; ':-&gt; Maybe Natural])
-&gt; Rec
     ('R
        '[ &quot;settings&quot;
           ':-&gt; Maybe
                  (Rec
                     ('R
                        '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                           &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                           &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                           &quot;memory_allocation&quot; ':-&gt; Maybe Natural]))])
-&gt; Rec
     ('R '[ &quot;amount&quot; ':-&gt; Maybe Natural]
      .+ 'R
           '[ &quot;settings&quot;
              ':-&gt; Maybe
                     (Rec
                        ('R
                           '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                              &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                              &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                              &quot;memory_allocation&quot; ':-&gt; Maybe Natural]))])
forall (l :: Row *) (r :: Row *).
FreeForall l =&gt;
Rec l -&gt; Rec r -&gt; Rec (l .+ r)
</span><span class="hs-operator hs-var">.+</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;settings&quot; (Label &quot;settings&quot;)
Label &quot;settings&quot;
</span><a href="#local-6989586621679324845"><span class="hs-var">#settings</span></a></span><span> </span><span class="annot"><span class="annottext">Label &quot;settings&quot;
-&gt; Maybe
     (Rec
        ('R
           '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
              &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
              &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
              &quot;memory_allocation&quot; ':-&gt; Maybe Natural]))
-&gt; Rec
     (&quot;settings&quot;
      .== Maybe
            (Rec
               ('R
                  '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                     &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                     &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                     &quot;memory_allocation&quot; ':-&gt; Maybe Natural])))
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec (l .== a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">Rec
  ('R
     '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
        &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
        &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
        &quot;memory_allocation&quot; ':-&gt; Maybe Natural])
-&gt; Maybe
     (Rec
        ('R
           '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
              &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
              &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
              &quot;memory_allocation&quot; ':-&gt; Maybe Natural]))
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Rec r -&gt; Settings
forall (r :: Row *). PartialSettings r =&gt; Rec r -&gt; Settings
</span><a href="IC.Test.Agent.html#fromPartialSettings"><span class="hs-identifier hs-var">fromPartialSettings</span></a></span><span> </span><span class="annot"><span class="annottext">Rec r
</span><a href="#local-6989586621679324848"><span class="hs-identifier hs-var">ps</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-721"></span><span>
</span><span id="line-722"></span><span class="annot"><a href="IC.Test.Agent.html#ic_install%27"><span class="hs-identifier hs-type">ic_install'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#HasAgentConfig"><span class="hs-identifier hs-type">HasAgentConfig</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#IC00"><span class="hs-identifier hs-type">IC00</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Management.html#InstallMode"><span class="hs-identifier hs-type">InstallMode</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="IC.Test.Agent.html#ReqResponse"><span class="hs-identifier hs-type">ReqResponse</span></a></span><span>
</span><span id="line-723"></span><span id="ic_install%27"><span class="annot"><span class="annottext">ic_install' :: IC00 -&gt; InstallMode -&gt; Blob -&gt; Blob -&gt; Blob -&gt; IO ReqResponse
</span><a href="IC.Test.Agent.html#ic_install%27"><span class="hs-identifier hs-var hs-var">ic_install'</span></a></span></span><span> </span><span id="local-6989586621679324843"><span class="annot"><span class="annottext">ic00 :: IC00
</span><a href="#local-6989586621679324843"><span class="hs-identifier hs-var">ic00</span></a></span></span><span> </span><span id="local-6989586621679324842"><span class="annot"><span class="annottext">mode :: InstallMode
</span><a href="#local-6989586621679324842"><span class="hs-identifier hs-var">mode</span></a></span></span><span> </span><span id="local-6989586621679324841"><span class="annot"><span class="annottext">canister_id :: Blob
</span><a href="#local-6989586621679324841"><span class="hs-identifier hs-var">canister_id</span></a></span></span><span> </span><span id="local-6989586621679324840"><span class="annot"><span class="annottext">wasm_module :: Blob
</span><a href="#local-6989586621679324840"><span class="hs-identifier hs-var">wasm_module</span></a></span></span><span> </span><span id="local-6989586621679324839"><span class="annot"><span class="annottext">arg :: Blob
</span><a href="#local-6989586621679324839"><span class="hs-identifier hs-var">arg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-724"></span><span>  </span><span class="annot"><span class="annottext">IC00
-&gt; Blob
-&gt; Label &quot;install_code&quot;
-&gt; Rec
     ('R
        (Inject
           (&quot;arg&quot; ':-&gt; Blob)
           '[ &quot;canister_id&quot; ':-&gt; Principal,
              &quot;mode&quot;
              ':-&gt; Var
                     ('R '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()]),
              &quot;wasm_module&quot; ':-&gt; Blob]))
-&gt; IO ReqResponse
forall (s :: Symbol) a b.
(HasAgentConfig, KnownSymbol s,
 (a -&gt; IO b) ~ (ICManagement IO .! s), CandidArg a) =&gt;
IC00 -&gt; Blob -&gt; Label s -&gt; a -&gt; IO ReqResponse
</span><a href="IC.Test.Agent.html#callIC%27"><span class="hs-identifier hs-var">callIC'</span></a></span><span> </span><span class="annot"><span class="annottext">IC00
</span><a href="#local-6989586621679324843"><span class="hs-identifier hs-var">ic00</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324841"><span class="hs-identifier hs-var">canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;install_code&quot; (Label &quot;install_code&quot;)
Label &quot;install_code&quot;
</span><a href="#local-6989586621679324838"><span class="hs-var">#install_code</span></a></span><span> </span><span class="annot"><span class="annottext">(Rec
   ('R
      (Inject
         (&quot;arg&quot; ':-&gt; Blob)
         '[ &quot;canister_id&quot; ':-&gt; Principal,
            &quot;mode&quot;
            ':-&gt; Var
                   ('R '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()]),
            &quot;wasm_module&quot; ':-&gt; Blob]))
 -&gt; IO ReqResponse)
-&gt; Rec
     ('R
        (Inject
           (&quot;arg&quot; ':-&gt; Blob)
           '[ &quot;canister_id&quot; ':-&gt; Principal,
              &quot;mode&quot;
              ':-&gt; Var
                     ('R '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()]),
              &quot;wasm_module&quot; ':-&gt; Blob]))
-&gt; IO ReqResponse
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Rec Empty
</span><span class="hs-identifier hs-var">empty</span></span><span>
</span><span id="line-725"></span><span>    </span><span class="annot"><span class="annottext">Rec Empty
-&gt; Rec
     ('R
        '[ &quot;mode&quot;
           ':-&gt; Var
                  ('R
                     '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()])])
-&gt; Rec
     (Empty
      .+ 'R
           '[ &quot;mode&quot;
              ':-&gt; Var
                     ('R
                        '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()])])
forall (l :: Row *) (r :: Row *).
FreeForall l =&gt;
Rec l -&gt; Rec r -&gt; Rec (l .+ r)
</span><span class="hs-operator hs-var">.+</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;mode&quot; (Label &quot;mode&quot;)
Label &quot;mode&quot;
</span><a href="#local-6989586621679324837"><span class="hs-var">#mode</span></a></span><span> </span><span class="annot"><span class="annottext">Label &quot;mode&quot;
-&gt; Var
     ('R '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()])
-&gt; Rec
     (&quot;mode&quot;
      .== Var
            ('R '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()]))
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec (l .== a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">InstallMode
Var
  ('R '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()])
</span><a href="#local-6989586621679324842"><span class="hs-identifier hs-var">mode</span></a></span><span>
</span><span id="line-726"></span><span>    </span><span class="annot"><span class="annottext">Rec
  ('R
     '[ &quot;mode&quot;
        ':-&gt; Var
               ('R
                  '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()])])
-&gt; Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; Rec
     ('R
        '[ &quot;mode&quot;
           ':-&gt; Var
                  ('R '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()])]
      .+ 'R '[ &quot;canister_id&quot; ':-&gt; Principal])
forall (l :: Row *) (r :: Row *).
FreeForall l =&gt;
Rec l -&gt; Rec r -&gt; Rec (l .+ r)
</span><span class="hs-operator hs-var">.+</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;canister_id&quot; (Label &quot;canister_id&quot;)
Label &quot;canister_id&quot;
</span><a href="#local-6989586621679324836"><span class="hs-var">#canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">Label &quot;canister_id&quot;
-&gt; Principal -&gt; Rec (&quot;canister_id&quot; .== Principal)
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec (l .== a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; Principal
</span><span class="hs-identifier hs-var">Principal</span></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324841"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-727"></span><span>    </span><span class="annot"><span class="annottext">Rec
  ('R
     '[ &quot;canister_id&quot; ':-&gt; Principal,
        &quot;mode&quot;
        ':-&gt; Var
               ('R
                  '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()])])
-&gt; Rec ('R '[ &quot;wasm_module&quot; ':-&gt; Blob])
-&gt; Rec
     ('R
        '[ &quot;canister_id&quot; ':-&gt; Principal,
           &quot;mode&quot;
           ':-&gt; Var
                  ('R '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()])]
      .+ 'R '[ &quot;wasm_module&quot; ':-&gt; Blob])
forall (l :: Row *) (r :: Row *).
FreeForall l =&gt;
Rec l -&gt; Rec r -&gt; Rec (l .+ r)
</span><span class="hs-operator hs-var">.+</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;wasm_module&quot; (Label &quot;wasm_module&quot;)
Label &quot;wasm_module&quot;
</span><a href="#local-6989586621679324835"><span class="hs-var">#wasm_module</span></a></span><span> </span><span class="annot"><span class="annottext">Label &quot;wasm_module&quot; -&gt; Blob -&gt; Rec (&quot;wasm_module&quot; .== Blob)
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec (l .== a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324840"><span class="hs-identifier hs-var">wasm_module</span></a></span><span>
</span><span id="line-728"></span><span>    </span><span class="annot"><span class="annottext">Rec
  ('R
     '[ &quot;canister_id&quot; ':-&gt; Principal,
        &quot;mode&quot;
        ':-&gt; Var
               ('R '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()]),
        &quot;wasm_module&quot; ':-&gt; Blob])
-&gt; Rec ('R '[ &quot;arg&quot; ':-&gt; Blob])
-&gt; Rec
     ('R
        '[ &quot;canister_id&quot; ':-&gt; Principal,
           &quot;mode&quot;
           ':-&gt; Var
                  ('R '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()]),
           &quot;wasm_module&quot; ':-&gt; Blob]
      .+ 'R '[ &quot;arg&quot; ':-&gt; Blob])
forall (l :: Row *) (r :: Row *).
FreeForall l =&gt;
Rec l -&gt; Rec r -&gt; Rec (l .+ r)
</span><span class="hs-operator hs-var">.+</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;arg&quot; (Label &quot;arg&quot;)
Label &quot;arg&quot;
</span><a href="#local-6989586621679324834"><span class="hs-var">#arg</span></a></span><span> </span><span class="annot"><span class="annottext">Label &quot;arg&quot; -&gt; Blob -&gt; Rec (&quot;arg&quot; .== Blob)
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec (l .== a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324839"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-729"></span><span>
</span><span id="line-730"></span><span id="local-6989586621679325394"><span class="annot"><a href="IC.Test.Agent.html#ic_update_settings%27"><span class="hs-identifier hs-type">ic_update_settings'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Test.Agent.html#HasAgentConfig"><span class="hs-identifier hs-type">HasAgentConfig</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#PartialSettings"><span class="hs-identifier hs-type">PartialSettings</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679325394"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#IC00"><span class="hs-identifier hs-type">IC00</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Rec</span></span><span> </span><span class="annot"><a href="#local-6989586621679325394"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="IC.Test.Agent.html#ReqResponse"><span class="hs-identifier hs-type">ReqResponse</span></a></span></span><span>
</span><span id="line-731"></span><span id="ic_update_settings%27"><span class="annot"><span class="annottext">ic_update_settings' :: IC00 -&gt; Blob -&gt; Rec r -&gt; IO ReqResponse
</span><a href="IC.Test.Agent.html#ic_update_settings%27"><span class="hs-identifier hs-var hs-var">ic_update_settings'</span></a></span></span><span> </span><span id="local-6989586621679324832"><span class="annot"><span class="annottext">ic00 :: IC00
</span><a href="#local-6989586621679324832"><span class="hs-identifier hs-var">ic00</span></a></span></span><span> </span><span id="local-6989586621679324831"><span class="annot"><span class="annottext">canister_id :: Blob
</span><a href="#local-6989586621679324831"><span class="hs-identifier hs-var">canister_id</span></a></span></span><span> </span><span id="local-6989586621679324830"><span class="annot"><span class="annottext">r :: Rec r
</span><a href="#local-6989586621679324830"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-732"></span><span>  </span><span class="annot"><span class="annottext">IC00
-&gt; Blob
-&gt; Label &quot;update_settings&quot;
-&gt; Rec
     ('R
        (Inject
           (&quot;settings&quot;
            ':-&gt; Rec
                   ('R
                      '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                         &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                         &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                         &quot;memory_allocation&quot; ':-&gt; Maybe Natural]))
           '[ &quot;canister_id&quot; ':-&gt; Principal]))
-&gt; IO ReqResponse
forall (s :: Symbol) a b.
(HasAgentConfig, KnownSymbol s,
 (a -&gt; IO b) ~ (ICManagement IO .! s), CandidArg a) =&gt;
IC00 -&gt; Blob -&gt; Label s -&gt; a -&gt; IO ReqResponse
</span><a href="IC.Test.Agent.html#callIC%27"><span class="hs-identifier hs-var">callIC'</span></a></span><span> </span><span class="annot"><span class="annottext">IC00
</span><a href="#local-6989586621679324832"><span class="hs-identifier hs-var">ic00</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324831"><span class="hs-identifier hs-var">canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;update_settings&quot; (Label &quot;update_settings&quot;)
Label &quot;update_settings&quot;
</span><a href="#local-6989586621679324829"><span class="hs-var">#update_settings</span></a></span><span> </span><span class="annot"><span class="annottext">(Rec
   ('R
      (Inject
         (&quot;settings&quot;
          ':-&gt; Rec
                 ('R
                    '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                       &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                       &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                       &quot;memory_allocation&quot; ':-&gt; Maybe Natural]))
         '[ &quot;canister_id&quot; ':-&gt; Principal]))
 -&gt; IO ReqResponse)
-&gt; Rec
     ('R
        (Inject
           (&quot;settings&quot;
            ':-&gt; Rec
                   ('R
                      '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                         &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                         &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                         &quot;memory_allocation&quot; ':-&gt; Maybe Natural]))
           '[ &quot;canister_id&quot; ':-&gt; Principal]))
-&gt; IO ReqResponse
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Rec Empty
</span><span class="hs-identifier hs-var">empty</span></span><span>
</span><span id="line-733"></span><span>    </span><span class="annot"><span class="annottext">Rec Empty
-&gt; Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; Rec (Empty .+ 'R '[ &quot;canister_id&quot; ':-&gt; Principal])
forall (l :: Row *) (r :: Row *).
FreeForall l =&gt;
Rec l -&gt; Rec r -&gt; Rec (l .+ r)
</span><span class="hs-operator hs-var">.+</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;canister_id&quot; (Label &quot;canister_id&quot;)
Label &quot;canister_id&quot;
</span><a href="#local-6989586621679324828"><span class="hs-var">#canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">Label &quot;canister_id&quot;
-&gt; Principal -&gt; Rec (&quot;canister_id&quot; .== Principal)
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec (l .== a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; Principal
</span><span class="hs-identifier hs-var">Principal</span></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324831"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-734"></span><span>    </span><span class="annot"><span class="annottext">Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; Rec
     ('R
        '[ &quot;settings&quot;
           ':-&gt; Rec
                  ('R
                     '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                        &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                        &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                        &quot;memory_allocation&quot; ':-&gt; Maybe Natural])])
-&gt; Rec
     ('R '[ &quot;canister_id&quot; ':-&gt; Principal]
      .+ 'R
           '[ &quot;settings&quot;
              ':-&gt; Rec
                     ('R
                        '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                           &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                           &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                           &quot;memory_allocation&quot; ':-&gt; Maybe Natural])])
forall (l :: Row *) (r :: Row *).
FreeForall l =&gt;
Rec l -&gt; Rec r -&gt; Rec (l .+ r)
</span><span class="hs-operator hs-var">.+</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;settings&quot; (Label &quot;settings&quot;)
Label &quot;settings&quot;
</span><a href="#local-6989586621679324827"><span class="hs-var">#settings</span></a></span><span> </span><span class="annot"><span class="annottext">Label &quot;settings&quot;
-&gt; Rec
     ('R
        '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
           &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
           &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
           &quot;memory_allocation&quot; ':-&gt; Maybe Natural])
-&gt; Rec
     (&quot;settings&quot;
      .== Rec
            ('R
               '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                  &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                  &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                  &quot;memory_allocation&quot; ':-&gt; Maybe Natural]))
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec (l .== a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">Rec r -&gt; Settings
forall (r :: Row *). PartialSettings r =&gt; Rec r -&gt; Settings
</span><a href="IC.Test.Agent.html#fromPartialSettings"><span class="hs-identifier hs-var">fromPartialSettings</span></a></span><span> </span><span class="annot"><span class="annottext">Rec r
</span><a href="#local-6989586621679324830"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-735"></span><span>
</span><span id="line-736"></span><span class="annot"><a href="IC.Test.Agent.html#ic_set_controllers%27"><span class="hs-identifier hs-type">ic_set_controllers'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#HasAgentConfig"><span class="hs-identifier hs-type">HasAgentConfig</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#IC00"><span class="hs-identifier hs-type">IC00</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="IC.Test.Agent.html#ReqResponse"><span class="hs-identifier hs-type">ReqResponse</span></a></span><span>
</span><span id="line-737"></span><span id="ic_set_controllers%27"><span class="annot"><span class="annottext">ic_set_controllers' :: IC00 -&gt; Blob -&gt; [Blob] -&gt; IO ReqResponse
</span><a href="IC.Test.Agent.html#ic_set_controllers%27"><span class="hs-identifier hs-var hs-var">ic_set_controllers'</span></a></span></span><span> </span><span id="local-6989586621679324825"><span class="annot"><span class="annottext">ic00 :: IC00
</span><a href="#local-6989586621679324825"><span class="hs-identifier hs-var">ic00</span></a></span></span><span> </span><span id="local-6989586621679324824"><span class="annot"><span class="annottext">canister_id :: Blob
</span><a href="#local-6989586621679324824"><span class="hs-identifier hs-var">canister_id</span></a></span></span><span> </span><span id="local-6989586621679324823"><span class="annot"><span class="annottext">new_controllers :: [Blob]
</span><a href="#local-6989586621679324823"><span class="hs-identifier hs-var">new_controllers</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-738"></span><span>  </span><span class="annot"><span class="annottext">IC00
-&gt; Blob
-&gt; Rec ('R '[ &quot;controllers&quot; ':-&gt; Vector Principal])
-&gt; IO ReqResponse
forall (r :: Row *).
(HasAgentConfig, PartialSettings r) =&gt;
IC00 -&gt; Blob -&gt; Rec r -&gt; IO ReqResponse
</span><a href="IC.Test.Agent.html#ic_update_settings%27"><span class="hs-identifier hs-var">ic_update_settings'</span></a></span><span> </span><span class="annot"><span class="annottext">IC00
</span><a href="#local-6989586621679324825"><span class="hs-identifier hs-var">ic00</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324824"><span class="hs-identifier hs-var">canister_id</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IsLabel &quot;controllers&quot; (Label &quot;controllers&quot;)
Label &quot;controllers&quot;
</span><a href="#local-6989586621679324822"><span class="hs-var">#controllers</span></a></span><span> </span><span class="annot"><span class="annottext">Label &quot;controllers&quot;
-&gt; Vector Principal -&gt; Rec (&quot;controllers&quot; .== Vector Principal)
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec (l .== a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">[Principal] -&gt; Vector Principal
forall a. [a] -&gt; Vector a
</span><span class="hs-identifier hs-var">Vec.fromList</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Blob -&gt; Principal) -&gt; [Blob] -&gt; [Principal]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; Principal
</span><span class="hs-identifier hs-var">Principal</span></span><span> </span><span class="annot"><span class="annottext">[Blob]
</span><a href="#local-6989586621679324823"><span class="hs-identifier hs-var">new_controllers</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-739"></span><span>
</span><span id="line-740"></span><span class="annot"><a href="IC.Test.Agent.html#ic_delete_canister%27"><span class="hs-identifier hs-type">ic_delete_canister'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#HasAgentConfig"><span class="hs-identifier hs-type">HasAgentConfig</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#IC00"><span class="hs-identifier hs-type">IC00</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="IC.Test.Agent.html#ReqResponse"><span class="hs-identifier hs-type">ReqResponse</span></a></span><span>
</span><span id="line-741"></span><span id="ic_delete_canister%27"><span class="annot"><span class="annottext">ic_delete_canister' :: IC00 -&gt; Blob -&gt; IO ReqResponse
</span><a href="IC.Test.Agent.html#ic_delete_canister%27"><span class="hs-identifier hs-var hs-var">ic_delete_canister'</span></a></span></span><span> </span><span id="local-6989586621679324820"><span class="annot"><span class="annottext">ic00 :: IC00
</span><a href="#local-6989586621679324820"><span class="hs-identifier hs-var">ic00</span></a></span></span><span> </span><span id="local-6989586621679324819"><span class="annot"><span class="annottext">canister_id :: Blob
</span><a href="#local-6989586621679324819"><span class="hs-identifier hs-var">canister_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-742"></span><span>  </span><span class="annot"><span class="annottext">IC00
-&gt; Blob
-&gt; Label &quot;delete_canister&quot;
-&gt; Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; IO ReqResponse
forall (s :: Symbol) a b.
(HasAgentConfig, KnownSymbol s,
 (a -&gt; IO b) ~ (ICManagement IO .! s), CandidArg a) =&gt;
IC00 -&gt; Blob -&gt; Label s -&gt; a -&gt; IO ReqResponse
</span><a href="IC.Test.Agent.html#callIC%27"><span class="hs-identifier hs-var">callIC'</span></a></span><span> </span><span class="annot"><span class="annottext">IC00
</span><a href="#local-6989586621679324820"><span class="hs-identifier hs-var">ic00</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324819"><span class="hs-identifier hs-var">canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;delete_canister&quot; (Label &quot;delete_canister&quot;)
Label &quot;delete_canister&quot;
</span><a href="#local-6989586621679324818"><span class="hs-var">#delete_canister</span></a></span><span> </span><span class="annot"><span class="annottext">(Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal]) -&gt; IO ReqResponse)
-&gt; Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal]) -&gt; IO ReqResponse
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Rec Empty
</span><span class="hs-identifier hs-var">empty</span></span><span>
</span><span id="line-743"></span><span>    </span><span class="annot"><span class="annottext">Rec Empty
-&gt; Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; Rec (Empty .+ 'R '[ &quot;canister_id&quot; ':-&gt; Principal])
forall (l :: Row *) (r :: Row *).
FreeForall l =&gt;
Rec l -&gt; Rec r -&gt; Rec (l .+ r)
</span><span class="hs-operator hs-var">.+</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;canister_id&quot; (Label &quot;canister_id&quot;)
Label &quot;canister_id&quot;
</span><a href="#local-6989586621679324817"><span class="hs-var">#canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">Label &quot;canister_id&quot;
-&gt; Principal -&gt; Rec (&quot;canister_id&quot; .== Principal)
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec (l .== a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; Principal
</span><span class="hs-identifier hs-var">Principal</span></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324819"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-744"></span><span>
</span><span id="line-745"></span><span class="annot"><a href="IC.Test.Agent.html#ic_deposit_cycles%27"><span class="hs-identifier hs-type">ic_deposit_cycles'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#HasAgentConfig"><span class="hs-identifier hs-type">HasAgentConfig</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#IC00"><span class="hs-identifier hs-type">IC00</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="IC.Test.Agent.html#ReqResponse"><span class="hs-identifier hs-type">ReqResponse</span></a></span><span>
</span><span id="line-746"></span><span id="ic_deposit_cycles%27"><span class="annot"><span class="annottext">ic_deposit_cycles' :: IC00 -&gt; Blob -&gt; IO ReqResponse
</span><a href="IC.Test.Agent.html#ic_deposit_cycles%27"><span class="hs-identifier hs-var hs-var">ic_deposit_cycles'</span></a></span></span><span> </span><span id="local-6989586621679324815"><span class="annot"><span class="annottext">ic00 :: IC00
</span><a href="#local-6989586621679324815"><span class="hs-identifier hs-var">ic00</span></a></span></span><span> </span><span id="local-6989586621679324814"><span class="annot"><span class="annottext">canister_id :: Blob
</span><a href="#local-6989586621679324814"><span class="hs-identifier hs-var">canister_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-747"></span><span>  </span><span class="annot"><span class="annottext">IC00
-&gt; Blob
-&gt; Label &quot;deposit_cycles&quot;
-&gt; Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; IO ReqResponse
forall (s :: Symbol) a b.
(HasAgentConfig, KnownSymbol s,
 (a -&gt; IO b) ~ (ICManagement IO .! s), CandidArg a) =&gt;
IC00 -&gt; Blob -&gt; Label s -&gt; a -&gt; IO ReqResponse
</span><a href="IC.Test.Agent.html#callIC%27"><span class="hs-identifier hs-var">callIC'</span></a></span><span> </span><span class="annot"><span class="annottext">IC00
</span><a href="#local-6989586621679324815"><span class="hs-identifier hs-var">ic00</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324814"><span class="hs-identifier hs-var">canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;deposit_cycles&quot; (Label &quot;deposit_cycles&quot;)
Label &quot;deposit_cycles&quot;
</span><a href="#local-6989586621679324813"><span class="hs-var">#deposit_cycles</span></a></span><span> </span><span class="annot"><span class="annottext">(Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal]) -&gt; IO ReqResponse)
-&gt; Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal]) -&gt; IO ReqResponse
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Rec Empty
</span><span class="hs-identifier hs-var">empty</span></span><span>
</span><span id="line-748"></span><span>    </span><span class="annot"><span class="annottext">Rec Empty
-&gt; Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; Rec (Empty .+ 'R '[ &quot;canister_id&quot; ':-&gt; Principal])
forall (l :: Row *) (r :: Row *).
FreeForall l =&gt;
Rec l -&gt; Rec r -&gt; Rec (l .+ r)
</span><span class="hs-operator hs-var">.+</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;canister_id&quot; (Label &quot;canister_id&quot;)
Label &quot;canister_id&quot;
</span><a href="#local-6989586621679324812"><span class="hs-var">#canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">Label &quot;canister_id&quot;
-&gt; Principal -&gt; Rec (&quot;canister_id&quot; .== Principal)
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec (l .== a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; Principal
</span><span class="hs-identifier hs-var">Principal</span></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324814"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-749"></span><span>
</span><span id="line-750"></span><span class="annot"><a href="IC.Test.Agent.html#ic_top_up%27"><span class="hs-identifier hs-type">ic_top_up'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#HasAgentConfig"><span class="hs-identifier hs-type">HasAgentConfig</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#IC00"><span class="hs-identifier hs-type">IC00</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Natural</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="IC.Test.Agent.html#ReqResponse"><span class="hs-identifier hs-type">ReqResponse</span></a></span><span>
</span><span id="line-751"></span><span id="ic_top_up%27"><span class="annot"><span class="annottext">ic_top_up' :: IC00 -&gt; Blob -&gt; Natural -&gt; IO ReqResponse
</span><a href="IC.Test.Agent.html#ic_top_up%27"><span class="hs-identifier hs-var hs-var">ic_top_up'</span></a></span></span><span> </span><span id="local-6989586621679324810"><span class="annot"><span class="annottext">ic00 :: IC00
</span><a href="#local-6989586621679324810"><span class="hs-identifier hs-var">ic00</span></a></span></span><span> </span><span id="local-6989586621679324809"><span class="annot"><span class="annottext">canister_id :: Blob
</span><a href="#local-6989586621679324809"><span class="hs-identifier hs-var">canister_id</span></a></span></span><span> </span><span id="local-6989586621679324808"><span class="annot"><span class="annottext">amount :: Natural
</span><a href="#local-6989586621679324808"><span class="hs-identifier hs-var">amount</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-752"></span><span>  </span><span class="annot"><span class="annottext">IC00
-&gt; Blob
-&gt; Label &quot;provisional_top_up_canister&quot;
-&gt; Rec
     ('R
        (Inject (&quot;amount&quot; ':-&gt; Natural) '[ &quot;canister_id&quot; ':-&gt; Principal]))
-&gt; IO ReqResponse
forall (s :: Symbol) a b.
(HasAgentConfig, KnownSymbol s,
 (a -&gt; IO b) ~ (ICManagement IO .! s), CandidArg a) =&gt;
IC00 -&gt; Blob -&gt; Label s -&gt; a -&gt; IO ReqResponse
</span><a href="IC.Test.Agent.html#callIC%27"><span class="hs-identifier hs-var">callIC'</span></a></span><span> </span><span class="annot"><span class="annottext">IC00
</span><a href="#local-6989586621679324810"><span class="hs-identifier hs-var">ic00</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324809"><span class="hs-identifier hs-var">canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;provisional_top_up_canister&quot; (Label &quot;provisional_top_up_canister&quot;)
Label &quot;provisional_top_up_canister&quot;
</span><a href="#local-6989586621679324807"><span class="hs-var">#provisional_top_up_canister</span></a></span><span> </span><span class="annot"><span class="annottext">(Rec
   ('R
      (Inject (&quot;amount&quot; ':-&gt; Natural) '[ &quot;canister_id&quot; ':-&gt; Principal]))
 -&gt; IO ReqResponse)
-&gt; Rec
     ('R
        (Inject (&quot;amount&quot; ':-&gt; Natural) '[ &quot;canister_id&quot; ':-&gt; Principal]))
-&gt; IO ReqResponse
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Rec Empty
</span><span class="hs-identifier hs-var">empty</span></span><span>
</span><span id="line-753"></span><span>    </span><span class="annot"><span class="annottext">Rec Empty
-&gt; Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; Rec (Empty .+ 'R '[ &quot;canister_id&quot; ':-&gt; Principal])
forall (l :: Row *) (r :: Row *).
FreeForall l =&gt;
Rec l -&gt; Rec r -&gt; Rec (l .+ r)
</span><span class="hs-operator hs-var">.+</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;canister_id&quot; (Label &quot;canister_id&quot;)
Label &quot;canister_id&quot;
</span><a href="#local-6989586621679324806"><span class="hs-var">#canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">Label &quot;canister_id&quot;
-&gt; Principal -&gt; Rec (&quot;canister_id&quot; .== Principal)
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec (l .== a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; Principal
</span><span class="hs-identifier hs-var">Principal</span></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324809"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-754"></span><span>    </span><span class="annot"><span class="annottext">Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; Rec ('R '[ &quot;amount&quot; ':-&gt; Natural])
-&gt; Rec
     ('R '[ &quot;canister_id&quot; ':-&gt; Principal]
      .+ 'R '[ &quot;amount&quot; ':-&gt; Natural])
forall (l :: Row *) (r :: Row *).
FreeForall l =&gt;
Rec l -&gt; Rec r -&gt; Rec (l .+ r)
</span><span class="hs-operator hs-var">.+</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;amount&quot; (Label &quot;amount&quot;)
Label &quot;amount&quot;
</span><a href="#local-6989586621679324805"><span class="hs-var">#amount</span></a></span><span> </span><span class="annot"><span class="annottext">Label &quot;amount&quot; -&gt; Natural -&gt; Rec (&quot;amount&quot; .== Natural)
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec (l .== a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679324808"><span class="hs-identifier hs-var">amount</span></a></span><span>
</span><span id="line-755"></span><span>
</span><span id="line-756"></span><span class="hs-comment">-- Double primed variants are only for requests from users (so they take the user,</span><span>
</span><span id="line-757"></span><span class="hs-comment">-- not a generic ic00 thing), and return the HTTP error code or the response</span><span>
</span><span id="line-758"></span><span class="hs-comment">-- (reply or reject)</span><span>
</span><span id="line-759"></span><span>
</span><span id="line-760"></span><span class="annot"><a href="IC.Test.Agent.html#callIC%27%27"><span class="hs-identifier hs-type">callIC''</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679325391"><span class="annot"><a href="#local-6989586621679325391"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span id="local-6989586621679325390"><span class="annot"><a href="#local-6989586621679325390"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span id="local-6989586621679325389"><span class="annot"><a href="#local-6989586621679325389"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-761"></span><span>  </span><span class="annot"><a href="IC.Test.Agent.html#HasAgentConfig"><span class="hs-identifier hs-type">HasAgentConfig</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-762"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">KnownSymbol</span></span><span> </span><span class="annot"><a href="#local-6989586621679325391"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-763"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679325390"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679325389"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-glyph hs-type">~</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Management.html#ICManagement"><span class="hs-identifier hs-type">ICManagement</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">.!</span></span><span> </span><span class="annot"><a href="#local-6989586621679325391"><span class="hs-identifier hs-type">s</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-764"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Candid.CandidArg</span></span><span> </span><span class="annot"><a href="#local-6989586621679325390"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-765"></span><span>  </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Label</span></span><span> </span><span class="annot"><a href="#local-6989586621679325391"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679325390"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="IC.Test.Agent.html#HTTPErrOrReqResponse"><span class="hs-identifier hs-type">HTTPErrOrReqResponse</span></a></span><span>
</span><span id="line-766"></span><span id="callIC%27%27"><span class="annot"><span class="annottext">callIC'' :: Blob -&gt; Blob -&gt; Label s -&gt; a -&gt; IO HTTPErrOrReqResponse
</span><a href="IC.Test.Agent.html#callIC%27%27"><span class="hs-identifier hs-var hs-var">callIC''</span></a></span></span><span> </span><span id="local-6989586621679324803"><span class="annot"><span class="annottext">user :: Blob
</span><a href="#local-6989586621679324803"><span class="hs-identifier hs-var">user</span></a></span></span><span> </span><span id="local-6989586621679324802"><span class="annot"><span class="annottext">ecid :: Blob
</span><a href="#local-6989586621679324802"><span class="hs-identifier hs-var">ecid</span></a></span></span><span> </span><span id="local-6989586621679324801"><span class="annot"><span class="annottext">l :: Label s
</span><a href="#local-6989586621679324801"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span id="local-6989586621679324800"><span class="annot"><span class="annottext">x :: a
</span><a href="#local-6989586621679324800"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasAgentConfig =&gt;
Blob -&gt; Blob -&gt; Text -&gt; Blob -&gt; IO HTTPErrOrReqResponse
Blob -&gt; Blob -&gt; Text -&gt; Blob -&gt; IO HTTPErrOrReqResponse
</span><a href="IC.Test.Agent.html#ic00as%27"><span class="hs-identifier hs-var">ic00as'</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324803"><span class="hs-identifier hs-var">user</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324802"><span class="hs-identifier hs-var">ecid</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">T.pack</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Label s -&gt; String
forall (n :: Symbol) (proxy :: Symbol -&gt; *).
KnownSymbol n =&gt;
proxy n -&gt; String
</span><span class="hs-identifier hs-var">symbolVal</span></span><span> </span><span class="annot"><span class="annottext">Label s
</span><a href="#local-6989586621679324801"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Blob
forall a. CandidArg a =&gt; a -&gt; Blob
</span><span class="hs-identifier hs-var">Candid.encode</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679324800"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-767"></span><span>
</span><span id="line-768"></span><span class="annot"><a href="IC.Test.Agent.html#ic_install%27%27"><span class="hs-identifier hs-type">ic_install''</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#HasAgentConfig"><span class="hs-identifier hs-type">HasAgentConfig</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Management.html#InstallMode"><span class="hs-identifier hs-type">InstallMode</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="IC.Test.Agent.html#HTTPErrOrReqResponse"><span class="hs-identifier hs-type">HTTPErrOrReqResponse</span></a></span><span>
</span><span id="line-769"></span><span id="ic_install%27%27"><span class="annot"><span class="annottext">ic_install'' :: Blob
-&gt; InstallMode -&gt; Blob -&gt; Blob -&gt; Blob -&gt; IO HTTPErrOrReqResponse
</span><a href="IC.Test.Agent.html#ic_install%27%27"><span class="hs-identifier hs-var hs-var">ic_install''</span></a></span></span><span> </span><span id="local-6989586621679324798"><span class="annot"><span class="annottext">user :: Blob
</span><a href="#local-6989586621679324798"><span class="hs-identifier hs-var">user</span></a></span></span><span> </span><span id="local-6989586621679324797"><span class="annot"><span class="annottext">mode :: InstallMode
</span><a href="#local-6989586621679324797"><span class="hs-identifier hs-var">mode</span></a></span></span><span> </span><span id="local-6989586621679324796"><span class="annot"><span class="annottext">canister_id :: Blob
</span><a href="#local-6989586621679324796"><span class="hs-identifier hs-var">canister_id</span></a></span></span><span> </span><span id="local-6989586621679324795"><span class="annot"><span class="annottext">wasm_module :: Blob
</span><a href="#local-6989586621679324795"><span class="hs-identifier hs-var">wasm_module</span></a></span></span><span> </span><span id="local-6989586621679324794"><span class="annot"><span class="annottext">arg :: Blob
</span><a href="#local-6989586621679324794"><span class="hs-identifier hs-var">arg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-770"></span><span>  </span><span class="annot"><span class="annottext">Blob
-&gt; Blob
-&gt; Label &quot;install_code&quot;
-&gt; Rec
     ('R
        (Inject
           (&quot;arg&quot; ':-&gt; Blob)
           '[ &quot;canister_id&quot; ':-&gt; Principal,
              &quot;mode&quot;
              ':-&gt; Var
                     ('R '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()]),
              &quot;wasm_module&quot; ':-&gt; Blob]))
-&gt; IO HTTPErrOrReqResponse
forall (s :: Symbol) a b.
(HasAgentConfig, KnownSymbol s,
 (a -&gt; IO b) ~ (ICManagement IO .! s), CandidArg a) =&gt;
Blob -&gt; Blob -&gt; Label s -&gt; a -&gt; IO HTTPErrOrReqResponse
</span><a href="IC.Test.Agent.html#callIC%27%27"><span class="hs-identifier hs-var">callIC''</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324798"><span class="hs-identifier hs-var">user</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324796"><span class="hs-identifier hs-var">canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;install_code&quot; (Label &quot;install_code&quot;)
Label &quot;install_code&quot;
</span><a href="#local-6989586621679324793"><span class="hs-var">#install_code</span></a></span><span> </span><span class="annot"><span class="annottext">(Rec
   ('R
      (Inject
         (&quot;arg&quot; ':-&gt; Blob)
         '[ &quot;canister_id&quot; ':-&gt; Principal,
            &quot;mode&quot;
            ':-&gt; Var
                   ('R '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()]),
            &quot;wasm_module&quot; ':-&gt; Blob]))
 -&gt; IO HTTPErrOrReqResponse)
-&gt; Rec
     ('R
        (Inject
           (&quot;arg&quot; ':-&gt; Blob)
           '[ &quot;canister_id&quot; ':-&gt; Principal,
              &quot;mode&quot;
              ':-&gt; Var
                     ('R '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()]),
              &quot;wasm_module&quot; ':-&gt; Blob]))
-&gt; IO HTTPErrOrReqResponse
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Rec Empty
</span><span class="hs-identifier hs-var">empty</span></span><span>
</span><span id="line-771"></span><span>    </span><span class="annot"><span class="annottext">Rec Empty
-&gt; Rec
     ('R
        '[ &quot;mode&quot;
           ':-&gt; Var
                  ('R
                     '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()])])
-&gt; Rec
     (Empty
      .+ 'R
           '[ &quot;mode&quot;
              ':-&gt; Var
                     ('R
                        '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()])])
forall (l :: Row *) (r :: Row *).
FreeForall l =&gt;
Rec l -&gt; Rec r -&gt; Rec (l .+ r)
</span><span class="hs-operator hs-var">.+</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;mode&quot; (Label &quot;mode&quot;)
Label &quot;mode&quot;
</span><a href="#local-6989586621679324792"><span class="hs-var">#mode</span></a></span><span> </span><span class="annot"><span class="annottext">Label &quot;mode&quot;
-&gt; Var
     ('R '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()])
-&gt; Rec
     (&quot;mode&quot;
      .== Var
            ('R '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()]))
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec (l .== a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">InstallMode
Var
  ('R '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()])
</span><a href="#local-6989586621679324797"><span class="hs-identifier hs-var">mode</span></a></span><span>
</span><span id="line-772"></span><span>    </span><span class="annot"><span class="annottext">Rec
  ('R
     '[ &quot;mode&quot;
        ':-&gt; Var
               ('R
                  '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()])])
-&gt; Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; Rec
     ('R
        '[ &quot;mode&quot;
           ':-&gt; Var
                  ('R '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()])]
      .+ 'R '[ &quot;canister_id&quot; ':-&gt; Principal])
forall (l :: Row *) (r :: Row *).
FreeForall l =&gt;
Rec l -&gt; Rec r -&gt; Rec (l .+ r)
</span><span class="hs-operator hs-var">.+</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;canister_id&quot; (Label &quot;canister_id&quot;)
Label &quot;canister_id&quot;
</span><a href="#local-6989586621679324791"><span class="hs-var">#canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">Label &quot;canister_id&quot;
-&gt; Principal -&gt; Rec (&quot;canister_id&quot; .== Principal)
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec (l .== a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; Principal
</span><span class="hs-identifier hs-var">Principal</span></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324796"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-773"></span><span>    </span><span class="annot"><span class="annottext">Rec
  ('R
     '[ &quot;canister_id&quot; ':-&gt; Principal,
        &quot;mode&quot;
        ':-&gt; Var
               ('R
                  '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()])])
-&gt; Rec ('R '[ &quot;wasm_module&quot; ':-&gt; Blob])
-&gt; Rec
     ('R
        '[ &quot;canister_id&quot; ':-&gt; Principal,
           &quot;mode&quot;
           ':-&gt; Var
                  ('R '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()])]
      .+ 'R '[ &quot;wasm_module&quot; ':-&gt; Blob])
forall (l :: Row *) (r :: Row *).
FreeForall l =&gt;
Rec l -&gt; Rec r -&gt; Rec (l .+ r)
</span><span class="hs-operator hs-var">.+</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;wasm_module&quot; (Label &quot;wasm_module&quot;)
Label &quot;wasm_module&quot;
</span><a href="#local-6989586621679324790"><span class="hs-var">#wasm_module</span></a></span><span> </span><span class="annot"><span class="annottext">Label &quot;wasm_module&quot; -&gt; Blob -&gt; Rec (&quot;wasm_module&quot; .== Blob)
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec (l .== a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324795"><span class="hs-identifier hs-var">wasm_module</span></a></span><span>
</span><span id="line-774"></span><span>    </span><span class="annot"><span class="annottext">Rec
  ('R
     '[ &quot;canister_id&quot; ':-&gt; Principal,
        &quot;mode&quot;
        ':-&gt; Var
               ('R '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()]),
        &quot;wasm_module&quot; ':-&gt; Blob])
-&gt; Rec ('R '[ &quot;arg&quot; ':-&gt; Blob])
-&gt; Rec
     ('R
        '[ &quot;canister_id&quot; ':-&gt; Principal,
           &quot;mode&quot;
           ':-&gt; Var
                  ('R '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()]),
           &quot;wasm_module&quot; ':-&gt; Blob]
      .+ 'R '[ &quot;arg&quot; ':-&gt; Blob])
forall (l :: Row *) (r :: Row *).
FreeForall l =&gt;
Rec l -&gt; Rec r -&gt; Rec (l .+ r)
</span><span class="hs-operator hs-var">.+</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;arg&quot; (Label &quot;arg&quot;)
Label &quot;arg&quot;
</span><a href="#local-6989586621679324789"><span class="hs-var">#arg</span></a></span><span> </span><span class="annot"><span class="annottext">Label &quot;arg&quot; -&gt; Blob -&gt; Rec (&quot;arg&quot; .== Blob)
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec (l .== a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324794"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-775"></span><span>
</span><span id="line-776"></span><span class="annot"><a href="IC.Test.Agent.html#ic_uninstall%27%27"><span class="hs-identifier hs-type">ic_uninstall''</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#HasAgentConfig"><span class="hs-identifier hs-type">HasAgentConfig</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="IC.Test.Agent.html#HTTPErrOrReqResponse"><span class="hs-identifier hs-type">HTTPErrOrReqResponse</span></a></span><span>
</span><span id="line-777"></span><span id="ic_uninstall%27%27"><span class="annot"><span class="annottext">ic_uninstall'' :: Blob -&gt; Blob -&gt; IO HTTPErrOrReqResponse
</span><a href="IC.Test.Agent.html#ic_uninstall%27%27"><span class="hs-identifier hs-var hs-var">ic_uninstall''</span></a></span></span><span> </span><span id="local-6989586621679324787"><span class="annot"><span class="annottext">user :: Blob
</span><a href="#local-6989586621679324787"><span class="hs-identifier hs-var">user</span></a></span></span><span> </span><span id="local-6989586621679324786"><span class="annot"><span class="annottext">canister_id :: Blob
</span><a href="#local-6989586621679324786"><span class="hs-identifier hs-var">canister_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-778"></span><span>  </span><span class="annot"><span class="annottext">Blob
-&gt; Blob
-&gt; Label &quot;uninstall_code&quot;
-&gt; Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; IO HTTPErrOrReqResponse
forall (s :: Symbol) a b.
(HasAgentConfig, KnownSymbol s,
 (a -&gt; IO b) ~ (ICManagement IO .! s), CandidArg a) =&gt;
Blob -&gt; Blob -&gt; Label s -&gt; a -&gt; IO HTTPErrOrReqResponse
</span><a href="IC.Test.Agent.html#callIC%27%27"><span class="hs-identifier hs-var">callIC''</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324787"><span class="hs-identifier hs-var">user</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324786"><span class="hs-identifier hs-var">canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;uninstall_code&quot; (Label &quot;uninstall_code&quot;)
Label &quot;uninstall_code&quot;
</span><a href="#local-6989586621679324785"><span class="hs-var">#uninstall_code</span></a></span><span> </span><span class="annot"><span class="annottext">(Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
 -&gt; IO HTTPErrOrReqResponse)
-&gt; Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; IO HTTPErrOrReqResponse
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Rec Empty
</span><span class="hs-identifier hs-var">empty</span></span><span>
</span><span id="line-779"></span><span>    </span><span class="annot"><span class="annottext">Rec Empty
-&gt; Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; Rec (Empty .+ 'R '[ &quot;canister_id&quot; ':-&gt; Principal])
forall (l :: Row *) (r :: Row *).
FreeForall l =&gt;
Rec l -&gt; Rec r -&gt; Rec (l .+ r)
</span><span class="hs-operator hs-var">.+</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;canister_id&quot; (Label &quot;canister_id&quot;)
Label &quot;canister_id&quot;
</span><a href="#local-6989586621679324784"><span class="hs-var">#canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">Label &quot;canister_id&quot;
-&gt; Principal -&gt; Rec (&quot;canister_id&quot; .== Principal)
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec (l .== a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; Principal
</span><span class="hs-identifier hs-var">Principal</span></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324786"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-780"></span><span>
</span><span id="line-781"></span><span class="annot"><a href="IC.Test.Agent.html#ic_set_controllers%27%27"><span class="hs-identifier hs-type">ic_set_controllers''</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#HasAgentConfig"><span class="hs-identifier hs-type">HasAgentConfig</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="IC.Test.Agent.html#HTTPErrOrReqResponse"><span class="hs-identifier hs-type">HTTPErrOrReqResponse</span></a></span><span>
</span><span id="line-782"></span><span id="ic_set_controllers%27%27"><span class="annot"><span class="annottext">ic_set_controllers'' :: Blob -&gt; Blob -&gt; [Blob] -&gt; IO HTTPErrOrReqResponse
</span><a href="IC.Test.Agent.html#ic_set_controllers%27%27"><span class="hs-identifier hs-var hs-var">ic_set_controllers''</span></a></span></span><span> </span><span id="local-6989586621679324782"><span class="annot"><span class="annottext">user :: Blob
</span><a href="#local-6989586621679324782"><span class="hs-identifier hs-var">user</span></a></span></span><span> </span><span id="local-6989586621679324781"><span class="annot"><span class="annottext">canister_id :: Blob
</span><a href="#local-6989586621679324781"><span class="hs-identifier hs-var">canister_id</span></a></span></span><span> </span><span id="local-6989586621679324780"><span class="annot"><span class="annottext">new_controllers :: [Blob]
</span><a href="#local-6989586621679324780"><span class="hs-identifier hs-var">new_controllers</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-783"></span><span>  </span><span class="annot"><span class="annottext">Blob
-&gt; Blob
-&gt; Label &quot;update_settings&quot;
-&gt; Rec
     ('R
        (Inject
           (&quot;settings&quot;
            ':-&gt; Rec
                   ('R
                      '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                         &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                         &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                         &quot;memory_allocation&quot; ':-&gt; Maybe Natural]))
           '[ &quot;canister_id&quot; ':-&gt; Principal]))
-&gt; IO HTTPErrOrReqResponse
forall (s :: Symbol) a b.
(HasAgentConfig, KnownSymbol s,
 (a -&gt; IO b) ~ (ICManagement IO .! s), CandidArg a) =&gt;
Blob -&gt; Blob -&gt; Label s -&gt; a -&gt; IO HTTPErrOrReqResponse
</span><a href="IC.Test.Agent.html#callIC%27%27"><span class="hs-identifier hs-var">callIC''</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324782"><span class="hs-identifier hs-var">user</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324781"><span class="hs-identifier hs-var">canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;update_settings&quot; (Label &quot;update_settings&quot;)
Label &quot;update_settings&quot;
</span><a href="#local-6989586621679324779"><span class="hs-var">#update_settings</span></a></span><span> </span><span class="annot"><span class="annottext">(Rec
   ('R
      (Inject
         (&quot;settings&quot;
          ':-&gt; Rec
                 ('R
                    '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                       &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                       &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                       &quot;memory_allocation&quot; ':-&gt; Maybe Natural]))
         '[ &quot;canister_id&quot; ':-&gt; Principal]))
 -&gt; IO HTTPErrOrReqResponse)
-&gt; Rec
     ('R
        (Inject
           (&quot;settings&quot;
            ':-&gt; Rec
                   ('R
                      '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                         &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                         &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                         &quot;memory_allocation&quot; ':-&gt; Maybe Natural]))
           '[ &quot;canister_id&quot; ':-&gt; Principal]))
-&gt; IO HTTPErrOrReqResponse
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Rec Empty
</span><span class="hs-identifier hs-var">empty</span></span><span>
</span><span id="line-784"></span><span>    </span><span class="annot"><span class="annottext">Rec Empty
-&gt; Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; Rec (Empty .+ 'R '[ &quot;canister_id&quot; ':-&gt; Principal])
forall (l :: Row *) (r :: Row *).
FreeForall l =&gt;
Rec l -&gt; Rec r -&gt; Rec (l .+ r)
</span><span class="hs-operator hs-var">.+</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;canister_id&quot; (Label &quot;canister_id&quot;)
Label &quot;canister_id&quot;
</span><a href="#local-6989586621679324778"><span class="hs-var">#canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">Label &quot;canister_id&quot;
-&gt; Principal -&gt; Rec (&quot;canister_id&quot; .== Principal)
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec (l .== a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; Principal
</span><span class="hs-identifier hs-var">Principal</span></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324781"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-785"></span><span>    </span><span class="annot"><span class="annottext">Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; Rec
     ('R
        '[ &quot;settings&quot;
           ':-&gt; Rec
                  ('R
                     '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                        &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                        &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                        &quot;memory_allocation&quot; ':-&gt; Maybe Natural])])
-&gt; Rec
     ('R '[ &quot;canister_id&quot; ':-&gt; Principal]
      .+ 'R
           '[ &quot;settings&quot;
              ':-&gt; Rec
                     ('R
                        '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                           &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                           &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                           &quot;memory_allocation&quot; ':-&gt; Maybe Natural])])
forall (l :: Row *) (r :: Row *).
FreeForall l =&gt;
Rec l -&gt; Rec r -&gt; Rec (l .+ r)
</span><span class="hs-operator hs-var">.+</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;settings&quot; (Label &quot;settings&quot;)
Label &quot;settings&quot;
</span><a href="#local-6989586621679324777"><span class="hs-var">#settings</span></a></span><span> </span><span class="annot"><span class="annottext">Label &quot;settings&quot;
-&gt; Rec
     ('R
        '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
           &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
           &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
           &quot;memory_allocation&quot; ':-&gt; Maybe Natural])
-&gt; Rec
     (&quot;settings&quot;
      .== Rec
            ('R
               '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                  &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                  &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                  &quot;memory_allocation&quot; ':-&gt; Maybe Natural]))
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec (l .== a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">Rec ('R '[ &quot;controllers&quot; ':-&gt; Vector Principal]) -&gt; Settings
forall (r :: Row *). PartialSettings r =&gt; Rec r -&gt; Settings
</span><a href="IC.Test.Agent.html#fromPartialSettings"><span class="hs-identifier hs-var">fromPartialSettings</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IsLabel &quot;controllers&quot; (Label &quot;controllers&quot;)
Label &quot;controllers&quot;
</span><a href="#local-6989586621679324776"><span class="hs-var">#controllers</span></a></span><span> </span><span class="annot"><span class="annottext">Label &quot;controllers&quot;
-&gt; Vector Principal -&gt; Rec (&quot;controllers&quot; .== Vector Principal)
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec (l .== a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">[Principal] -&gt; Vector Principal
forall a. [a] -&gt; Vector a
</span><span class="hs-identifier hs-var">Vec.fromList</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Blob -&gt; Principal) -&gt; [Blob] -&gt; [Principal]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; Principal
</span><span class="hs-identifier hs-var">Principal</span></span><span> </span><span class="annot"><span class="annottext">[Blob]
</span><a href="#local-6989586621679324780"><span class="hs-identifier hs-var">new_controllers</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-786"></span><span>
</span><span id="line-787"></span><span class="annot"><a href="IC.Test.Agent.html#ic_start_canister%27%27"><span class="hs-identifier hs-type">ic_start_canister''</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#HasAgentConfig"><span class="hs-identifier hs-type">HasAgentConfig</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="IC.Test.Agent.html#HTTPErrOrReqResponse"><span class="hs-identifier hs-type">HTTPErrOrReqResponse</span></a></span><span>
</span><span id="line-788"></span><span id="ic_start_canister%27%27"><span class="annot"><span class="annottext">ic_start_canister'' :: Blob -&gt; Blob -&gt; IO HTTPErrOrReqResponse
</span><a href="IC.Test.Agent.html#ic_start_canister%27%27"><span class="hs-identifier hs-var hs-var">ic_start_canister''</span></a></span></span><span> </span><span id="local-6989586621679324774"><span class="annot"><span class="annottext">user :: Blob
</span><a href="#local-6989586621679324774"><span class="hs-identifier hs-var">user</span></a></span></span><span> </span><span id="local-6989586621679324773"><span class="annot"><span class="annottext">canister_id :: Blob
</span><a href="#local-6989586621679324773"><span class="hs-identifier hs-var">canister_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-789"></span><span>  </span><span class="annot"><span class="annottext">Blob
-&gt; Blob
-&gt; Label &quot;start_canister&quot;
-&gt; Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; IO HTTPErrOrReqResponse
forall (s :: Symbol) a b.
(HasAgentConfig, KnownSymbol s,
 (a -&gt; IO b) ~ (ICManagement IO .! s), CandidArg a) =&gt;
Blob -&gt; Blob -&gt; Label s -&gt; a -&gt; IO HTTPErrOrReqResponse
</span><a href="IC.Test.Agent.html#callIC%27%27"><span class="hs-identifier hs-var">callIC''</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324774"><span class="hs-identifier hs-var">user</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324773"><span class="hs-identifier hs-var">canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;start_canister&quot; (Label &quot;start_canister&quot;)
Label &quot;start_canister&quot;
</span><a href="#local-6989586621679324772"><span class="hs-var">#start_canister</span></a></span><span> </span><span class="annot"><span class="annottext">(Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
 -&gt; IO HTTPErrOrReqResponse)
-&gt; Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; IO HTTPErrOrReqResponse
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Rec Empty
</span><span class="hs-identifier hs-var">empty</span></span><span>
</span><span id="line-790"></span><span>    </span><span class="annot"><span class="annottext">Rec Empty
-&gt; Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; Rec (Empty .+ 'R '[ &quot;canister_id&quot; ':-&gt; Principal])
forall (l :: Row *) (r :: Row *).
FreeForall l =&gt;
Rec l -&gt; Rec r -&gt; Rec (l .+ r)
</span><span class="hs-operator hs-var">.+</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;canister_id&quot; (Label &quot;canister_id&quot;)
Label &quot;canister_id&quot;
</span><a href="#local-6989586621679324771"><span class="hs-var">#canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">Label &quot;canister_id&quot;
-&gt; Principal -&gt; Rec (&quot;canister_id&quot; .== Principal)
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec (l .== a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; Principal
</span><span class="hs-identifier hs-var">Principal</span></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324773"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-791"></span><span>
</span><span id="line-792"></span><span class="annot"><a href="IC.Test.Agent.html#ic_stop_canister%27%27"><span class="hs-identifier hs-type">ic_stop_canister''</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#HasAgentConfig"><span class="hs-identifier hs-type">HasAgentConfig</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="IC.Test.Agent.html#HTTPErrOrReqResponse"><span class="hs-identifier hs-type">HTTPErrOrReqResponse</span></a></span><span>
</span><span id="line-793"></span><span id="ic_stop_canister%27%27"><span class="annot"><span class="annottext">ic_stop_canister'' :: Blob -&gt; Blob -&gt; IO HTTPErrOrReqResponse
</span><a href="IC.Test.Agent.html#ic_stop_canister%27%27"><span class="hs-identifier hs-var hs-var">ic_stop_canister''</span></a></span></span><span> </span><span id="local-6989586621679324769"><span class="annot"><span class="annottext">user :: Blob
</span><a href="#local-6989586621679324769"><span class="hs-identifier hs-var">user</span></a></span></span><span> </span><span id="local-6989586621679324768"><span class="annot"><span class="annottext">canister_id :: Blob
</span><a href="#local-6989586621679324768"><span class="hs-identifier hs-var">canister_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-794"></span><span>  </span><span class="annot"><span class="annottext">Blob
-&gt; Blob
-&gt; Label &quot;stop_canister&quot;
-&gt; Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; IO HTTPErrOrReqResponse
forall (s :: Symbol) a b.
(HasAgentConfig, KnownSymbol s,
 (a -&gt; IO b) ~ (ICManagement IO .! s), CandidArg a) =&gt;
Blob -&gt; Blob -&gt; Label s -&gt; a -&gt; IO HTTPErrOrReqResponse
</span><a href="IC.Test.Agent.html#callIC%27%27"><span class="hs-identifier hs-var">callIC''</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324769"><span class="hs-identifier hs-var">user</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324768"><span class="hs-identifier hs-var">canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;stop_canister&quot; (Label &quot;stop_canister&quot;)
Label &quot;stop_canister&quot;
</span><a href="#local-6989586621679324767"><span class="hs-var">#stop_canister</span></a></span><span> </span><span class="annot"><span class="annottext">(Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
 -&gt; IO HTTPErrOrReqResponse)
-&gt; Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; IO HTTPErrOrReqResponse
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Rec Empty
</span><span class="hs-identifier hs-var">empty</span></span><span>
</span><span id="line-795"></span><span>    </span><span class="annot"><span class="annottext">Rec Empty
-&gt; Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; Rec (Empty .+ 'R '[ &quot;canister_id&quot; ':-&gt; Principal])
forall (l :: Row *) (r :: Row *).
FreeForall l =&gt;
Rec l -&gt; Rec r -&gt; Rec (l .+ r)
</span><span class="hs-operator hs-var">.+</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;canister_id&quot; (Label &quot;canister_id&quot;)
Label &quot;canister_id&quot;
</span><a href="#local-6989586621679324766"><span class="hs-var">#canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">Label &quot;canister_id&quot;
-&gt; Principal -&gt; Rec (&quot;canister_id&quot; .== Principal)
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec (l .== a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; Principal
</span><span class="hs-identifier hs-var">Principal</span></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324768"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-796"></span><span>
</span><span id="line-797"></span><span class="annot"><a href="IC.Test.Agent.html#ic_canister_status%27%27"><span class="hs-identifier hs-type">ic_canister_status''</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#HasAgentConfig"><span class="hs-identifier hs-type">HasAgentConfig</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="IC.Test.Agent.html#HTTPErrOrReqResponse"><span class="hs-identifier hs-type">HTTPErrOrReqResponse</span></a></span><span>
</span><span id="line-798"></span><span id="ic_canister_status%27%27"><span class="annot"><span class="annottext">ic_canister_status'' :: Blob -&gt; Blob -&gt; IO HTTPErrOrReqResponse
</span><a href="IC.Test.Agent.html#ic_canister_status%27%27"><span class="hs-identifier hs-var hs-var">ic_canister_status''</span></a></span></span><span> </span><span id="local-6989586621679324764"><span class="annot"><span class="annottext">user :: Blob
</span><a href="#local-6989586621679324764"><span class="hs-identifier hs-var">user</span></a></span></span><span> </span><span id="local-6989586621679324763"><span class="annot"><span class="annottext">canister_id :: Blob
</span><a href="#local-6989586621679324763"><span class="hs-identifier hs-var">canister_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-799"></span><span>  </span><span class="annot"><span class="annottext">Blob
-&gt; Blob
-&gt; Label &quot;canister_status&quot;
-&gt; Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; IO HTTPErrOrReqResponse
forall (s :: Symbol) a b.
(HasAgentConfig, KnownSymbol s,
 (a -&gt; IO b) ~ (ICManagement IO .! s), CandidArg a) =&gt;
Blob -&gt; Blob -&gt; Label s -&gt; a -&gt; IO HTTPErrOrReqResponse
</span><a href="IC.Test.Agent.html#callIC%27%27"><span class="hs-identifier hs-var">callIC''</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324764"><span class="hs-identifier hs-var">user</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324763"><span class="hs-identifier hs-var">canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;canister_status&quot; (Label &quot;canister_status&quot;)
Label &quot;canister_status&quot;
</span><a href="#local-6989586621679324762"><span class="hs-var">#canister_status</span></a></span><span> </span><span class="annot"><span class="annottext">(Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
 -&gt; IO HTTPErrOrReqResponse)
-&gt; Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; IO HTTPErrOrReqResponse
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Rec Empty
</span><span class="hs-identifier hs-var">empty</span></span><span>
</span><span id="line-800"></span><span>    </span><span class="annot"><span class="annottext">Rec Empty
-&gt; Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; Rec (Empty .+ 'R '[ &quot;canister_id&quot; ':-&gt; Principal])
forall (l :: Row *) (r :: Row *).
FreeForall l =&gt;
Rec l -&gt; Rec r -&gt; Rec (l .+ r)
</span><span class="hs-operator hs-var">.+</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;canister_id&quot; (Label &quot;canister_id&quot;)
Label &quot;canister_id&quot;
</span><a href="#local-6989586621679324761"><span class="hs-var">#canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">Label &quot;canister_id&quot;
-&gt; Principal -&gt; Rec (&quot;canister_id&quot; .== Principal)
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec (l .== a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; Principal
</span><span class="hs-identifier hs-var">Principal</span></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324763"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-801"></span><span>
</span><span id="line-802"></span><span class="annot"><a href="IC.Test.Agent.html#ic_delete_canister%27%27"><span class="hs-identifier hs-type">ic_delete_canister''</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#HasAgentConfig"><span class="hs-identifier hs-type">HasAgentConfig</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="IC.Test.Agent.html#HTTPErrOrReqResponse"><span class="hs-identifier hs-type">HTTPErrOrReqResponse</span></a></span><span>
</span><span id="line-803"></span><span id="ic_delete_canister%27%27"><span class="annot"><span class="annottext">ic_delete_canister'' :: Blob -&gt; Blob -&gt; IO HTTPErrOrReqResponse
</span><a href="IC.Test.Agent.html#ic_delete_canister%27%27"><span class="hs-identifier hs-var hs-var">ic_delete_canister''</span></a></span></span><span> </span><span id="local-6989586621679324759"><span class="annot"><span class="annottext">user :: Blob
</span><a href="#local-6989586621679324759"><span class="hs-identifier hs-var">user</span></a></span></span><span> </span><span id="local-6989586621679324758"><span class="annot"><span class="annottext">canister_id :: Blob
</span><a href="#local-6989586621679324758"><span class="hs-identifier hs-var">canister_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-804"></span><span>  </span><span class="annot"><span class="annottext">Blob
-&gt; Blob
-&gt; Label &quot;delete_canister&quot;
-&gt; Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; IO HTTPErrOrReqResponse
forall (s :: Symbol) a b.
(HasAgentConfig, KnownSymbol s,
 (a -&gt; IO b) ~ (ICManagement IO .! s), CandidArg a) =&gt;
Blob -&gt; Blob -&gt; Label s -&gt; a -&gt; IO HTTPErrOrReqResponse
</span><a href="IC.Test.Agent.html#callIC%27%27"><span class="hs-identifier hs-var">callIC''</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324759"><span class="hs-identifier hs-var">user</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324758"><span class="hs-identifier hs-var">canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;delete_canister&quot; (Label &quot;delete_canister&quot;)
Label &quot;delete_canister&quot;
</span><a href="#local-6989586621679324757"><span class="hs-var">#delete_canister</span></a></span><span> </span><span class="annot"><span class="annottext">(Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
 -&gt; IO HTTPErrOrReqResponse)
-&gt; Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; IO HTTPErrOrReqResponse
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Rec Empty
</span><span class="hs-identifier hs-var">empty</span></span><span>
</span><span id="line-805"></span><span>    </span><span class="annot"><span class="annottext">Rec Empty
-&gt; Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; Rec (Empty .+ 'R '[ &quot;canister_id&quot; ':-&gt; Principal])
forall (l :: Row *) (r :: Row *).
FreeForall l =&gt;
Rec l -&gt; Rec r -&gt; Rec (l .+ r)
</span><span class="hs-operator hs-var">.+</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;canister_id&quot; (Label &quot;canister_id&quot;)
Label &quot;canister_id&quot;
</span><a href="#local-6989586621679324756"><span class="hs-var">#canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">Label &quot;canister_id&quot;
-&gt; Principal -&gt; Rec (&quot;canister_id&quot; .== Principal)
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec (l .== a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; Principal
</span><span class="hs-identifier hs-var">Principal</span></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324758"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-806"></span><span>
</span><span id="line-807"></span><span class="annot"><a href="IC.Test.Agent.html#ic_deposit_cycles%27%27"><span class="hs-identifier hs-type">ic_deposit_cycles''</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#HasAgentConfig"><span class="hs-identifier hs-type">HasAgentConfig</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="IC.Test.Agent.html#HTTPErrOrReqResponse"><span class="hs-identifier hs-type">HTTPErrOrReqResponse</span></a></span><span>
</span><span id="line-808"></span><span id="ic_deposit_cycles%27%27"><span class="annot"><span class="annottext">ic_deposit_cycles'' :: Blob -&gt; Blob -&gt; IO HTTPErrOrReqResponse
</span><a href="IC.Test.Agent.html#ic_deposit_cycles%27%27"><span class="hs-identifier hs-var hs-var">ic_deposit_cycles''</span></a></span></span><span> </span><span id="local-6989586621679324754"><span class="annot"><span class="annottext">user :: Blob
</span><a href="#local-6989586621679324754"><span class="hs-identifier hs-var">user</span></a></span></span><span> </span><span id="local-6989586621679324753"><span class="annot"><span class="annottext">canister_id :: Blob
</span><a href="#local-6989586621679324753"><span class="hs-identifier hs-var">canister_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-809"></span><span>  </span><span class="annot"><span class="annottext">Blob
-&gt; Blob
-&gt; Label &quot;deposit_cycles&quot;
-&gt; Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; IO HTTPErrOrReqResponse
forall (s :: Symbol) a b.
(HasAgentConfig, KnownSymbol s,
 (a -&gt; IO b) ~ (ICManagement IO .! s), CandidArg a) =&gt;
Blob -&gt; Blob -&gt; Label s -&gt; a -&gt; IO HTTPErrOrReqResponse
</span><a href="IC.Test.Agent.html#callIC%27%27"><span class="hs-identifier hs-var">callIC''</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324754"><span class="hs-identifier hs-var">user</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324753"><span class="hs-identifier hs-var">canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;deposit_cycles&quot; (Label &quot;deposit_cycles&quot;)
Label &quot;deposit_cycles&quot;
</span><a href="#local-6989586621679324752"><span class="hs-var">#deposit_cycles</span></a></span><span> </span><span class="annot"><span class="annottext">(Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
 -&gt; IO HTTPErrOrReqResponse)
-&gt; Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; IO HTTPErrOrReqResponse
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Rec Empty
</span><span class="hs-identifier hs-var">empty</span></span><span>
</span><span id="line-810"></span><span>    </span><span class="annot"><span class="annottext">Rec Empty
-&gt; Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; Rec (Empty .+ 'R '[ &quot;canister_id&quot; ':-&gt; Principal])
forall (l :: Row *) (r :: Row *).
FreeForall l =&gt;
Rec l -&gt; Rec r -&gt; Rec (l .+ r)
</span><span class="hs-operator hs-var">.+</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;canister_id&quot; (Label &quot;canister_id&quot;)
Label &quot;canister_id&quot;
</span><a href="#local-6989586621679324751"><span class="hs-var">#canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">Label &quot;canister_id&quot;
-&gt; Principal -&gt; Rec (&quot;canister_id&quot; .== Principal)
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec (l .== a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; Principal
</span><span class="hs-identifier hs-var">Principal</span></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324753"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-811"></span><span>
</span><span id="line-812"></span><span class="annot"><a href="IC.Test.Agent.html#ic_raw_rand%27%27"><span class="hs-identifier hs-type">ic_raw_rand''</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#HasAgentConfig"><span class="hs-identifier hs-type">HasAgentConfig</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="IC.Test.Agent.html#HTTPErrOrReqResponse"><span class="hs-identifier hs-type">HTTPErrOrReqResponse</span></a></span><span>
</span><span id="line-813"></span><span id="ic_raw_rand%27%27"><span class="annot"><span class="annottext">ic_raw_rand'' :: Blob -&gt; IO HTTPErrOrReqResponse
</span><a href="IC.Test.Agent.html#ic_raw_rand%27%27"><span class="hs-identifier hs-var hs-var">ic_raw_rand''</span></a></span></span><span> </span><span id="local-6989586621679324749"><span class="annot"><span class="annottext">user :: Blob
</span><a href="#local-6989586621679324749"><span class="hs-identifier hs-var">user</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-814"></span><span>  </span><span class="annot"><span class="annottext">Blob -&gt; Blob -&gt; Label &quot;raw_rand&quot; -&gt; () -&gt; IO HTTPErrOrReqResponse
forall (s :: Symbol) a b.
(HasAgentConfig, KnownSymbol s,
 (a -&gt; IO b) ~ (ICManagement IO .! s), CandidArg a) =&gt;
Blob -&gt; Blob -&gt; Label s -&gt; a -&gt; IO HTTPErrOrReqResponse
</span><a href="IC.Test.Agent.html#callIC%27%27"><span class="hs-identifier hs-var">callIC''</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679324749"><span class="hs-identifier hs-var">user</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;raw_rand&quot; (Label &quot;raw_rand&quot;)
Label &quot;raw_rand&quot;
</span><a href="#local-6989586621679324748"><span class="hs-var">#raw_rand</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-815"></span><span>
</span><span id="line-816"></span><span>
</span><span id="line-817"></span><span class="hs-comment">-- A barrier</span><span>
</span><span id="line-818"></span><span>
</span><span id="line-819"></span><span class="hs-comment">-- This will stop and start all mentioned canisters. This guarantees</span><span>
</span><span id="line-820"></span><span class="hs-comment">-- that all outstanding callbacks are handled</span><span>
</span><span id="line-821"></span><span class="annot"><a href="IC.Test.Agent.html#barrier"><span class="hs-identifier hs-type">barrier</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Test.Agent.html#HasAgentConfig"><span class="hs-identifier hs-type">HasAgentConfig</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-822"></span><span id="barrier"><span class="annot"><span class="annottext">barrier :: [Blob] -&gt; IO ()
</span><a href="IC.Test.Agent.html#barrier"><span class="hs-identifier hs-var hs-var">barrier</span></a></span></span><span> </span><span id="local-6989586621679324746"><span class="annot"><span class="annottext">cids :: [Blob]
</span><a href="#local-6989586621679324746"><span class="hs-identifier hs-var">cids</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-823"></span><span>  </span><span class="annot"><span class="annottext">(Blob -&gt; IO ()) -&gt; [Blob] -&gt; IO ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasAgentConfig =&gt; IC00 -&gt; Blob -&gt; IO ()
IC00 -&gt; Blob -&gt; IO ()
</span><a href="IC.Test.Agent.html#ic_stop_canister"><span class="hs-identifier hs-var">ic_stop_canister</span></a></span><span> </span><span class="annot"><span class="annottext">HasAgentConfig =&gt; IC00
IC00
</span><a href="IC.Test.Agent.html#ic00"><span class="hs-identifier hs-var">ic00</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Blob]
</span><a href="#local-6989586621679324746"><span class="hs-identifier hs-var">cids</span></a></span><span>
</span><span id="line-824"></span><span>  </span><span class="annot"><span class="annottext">(Blob -&gt; IO ()) -&gt; [Blob] -&gt; IO ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasAgentConfig =&gt; IC00 -&gt; Blob -&gt; IO ()
IC00 -&gt; Blob -&gt; IO ()
</span><a href="IC.Test.Agent.html#ic_start_canister"><span class="hs-identifier hs-var">ic_start_canister</span></a></span><span> </span><span class="annot"><span class="annottext">HasAgentConfig =&gt; IC00
IC00
</span><a href="IC.Test.Agent.html#ic00"><span class="hs-identifier hs-var">ic00</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Blob]
</span><a href="#local-6989586621679324746"><span class="hs-identifier hs-var">cids</span></a></span><span>
</span><span id="line-825"></span><span>
</span><span id="line-826"></span><span class="hs-comment">-- Convenience around Data.Row.Variants used as enums</span><span>
</span><span id="line-827"></span><span>
</span><span id="line-828"></span><span id="local-6989586621679324743"><span id="local-6989586621679324744"><span class="annot"><a href="IC.Test.Agent.html#enum"><span class="hs-identifier hs-type">enum</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">AllUniqueLabels</span></span><span> </span><span class="annot"><a href="#local-6989586621679324744"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">KnownSymbol</span></span><span> </span><span class="annot"><a href="#local-6989586621679324743"><span class="hs-identifier hs-type">l</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679324744"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">.!</span></span><span> </span><span class="annot"><a href="#local-6989586621679324743"><span class="hs-identifier hs-type">l</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-glyph hs-type">~</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Label</span></span><span> </span><span class="annot"><a href="#local-6989586621679324743"><span class="hs-identifier hs-type">l</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Var</span></span><span> </span><span class="annot"><a href="#local-6989586621679324744"><span class="hs-identifier hs-type">r</span></a></span></span></span><span>
</span><span id="line-829"></span><span id="enum"><span class="annot"><span class="annottext">enum :: Label l -&gt; Var r
</span><a href="IC.Test.Agent.html#enum"><span class="hs-identifier hs-var hs-var">enum</span></a></span></span><span> </span><span id="local-6989586621679324741"><span class="annot"><span class="annottext">l :: Label l
</span><a href="#local-6989586621679324741"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Label l -&gt; (r .! l) -&gt; Var r
forall (l :: Symbol) (r :: Row *).
(AllUniqueLabels r, KnownSymbol l) =&gt;
Label l -&gt; (r .! l) -&gt; Var r
</span><span class="hs-identifier hs-var">V.IsJust</span></span><span> </span><span class="annot"><span class="annottext">Label l
</span><a href="#local-6989586621679324741"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-830"></span><span>
</span><span id="line-831"></span><span class="hs-comment">-- Other utilities</span><span>
</span><span id="line-832"></span><span>
</span><span id="line-833"></span><span class="annot"><a href="IC.Test.Agent.html#asHex"><span class="hs-identifier hs-type">asHex</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-834"></span><span id="asHex"><span class="annot"><span class="annottext">asHex :: Blob -&gt; String
</span><a href="IC.Test.Agent.html#asHex"><span class="hs-identifier hs-var hs-var">asHex</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; String
</span><span class="hs-identifier hs-var">T.unpack</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; String) -&gt; (Blob -&gt; Text) -&gt; Blob -&gt; String
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Method -&gt; Text
</span><span class="hs-identifier hs-var">H.encodeHex</span></span><span> </span><span class="annot"><span class="annottext">(Method -&gt; Text) -&gt; (Blob -&gt; Method) -&gt; Blob -&gt; Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; Method
</span><span class="hs-identifier hs-var">BS.toStrict</span></span><span>
</span><span id="line-835"></span><span>
</span><span id="line-836"></span><span class="annot"><a href="IC.Test.Agent.html#textual"><span class="hs-identifier hs-type">textual</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Id.Forms.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-837"></span><span id="textual"><span class="annot"><span class="annottext">textual :: Blob -&gt; String
</span><a href="IC.Test.Agent.html#textual"><span class="hs-identifier hs-var hs-var">textual</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; String
</span><span class="hs-identifier hs-var">T.unpack</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; String) -&gt; (Blob -&gt; Text) -&gt; Blob -&gt; String
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Principal -&gt; Text
</span><span class="hs-identifier hs-var">prettyPrincipal</span></span><span> </span><span class="annot"><span class="annottext">(Principal -&gt; Text) -&gt; (Blob -&gt; Principal) -&gt; Blob -&gt; Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; Principal
</span><span class="hs-identifier hs-var">Principal</span></span><span>
</span><span id="line-838"></span><span>
</span><span id="line-839"></span><span class="annot"><a href="IC.Test.Agent.html#shorten"><span class="hs-identifier hs-type">shorten</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-840"></span><span id="shorten"><span class="annot"><span class="annottext">shorten :: Int -&gt; String -&gt; String
</span><a href="IC.Test.Agent.html#shorten"><span class="hs-identifier hs-var hs-var">shorten</span></a></span></span><span> </span><span id="local-6989586621679324738"><span class="annot"><span class="annottext">n :: Int
</span><a href="#local-6989586621679324738"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621679324737"><span class="annot"><span class="annottext">s :: String
</span><a href="#local-6989586621679324737"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679324736"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">String -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679324735"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="hs-string">&quot;&#8230;&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-841"></span><span>  </span><span class="hs-keyword">where</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679324736"><span class="annot"><span class="annottext">a :: String
</span><a href="#local-6989586621679324736"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679324735"><span class="annot"><span class="annottext">b :: String
</span><a href="#local-6989586621679324735"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; String -&gt; (String, String)
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">splitAt</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679324738"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679324737"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-842"></span></pre></body></html>