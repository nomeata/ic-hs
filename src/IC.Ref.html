<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE TypeOperators #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE TypeApplications #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE ConstraintKinds #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE LambdaCase #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE RankNTypes #-}</span><span>
</span><span id="line-10"></span><span class="hs-pragma">{-# LANGUAGE OverloadedLabels #-}</span><span>
</span><span id="line-11"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><span id="line-12"></span><span class="hs-pragma">{-# LANGUAGE DataKinds #-}</span><span>
</span><span id="line-13"></span><span class="hs-pragma">{-# LANGUAGE AllowAmbiguousTypes #-}</span><span>
</span><span id="line-14"></span><span class="hs-pragma">{-# LANGUAGE MultiWayIf #-}</span><span>
</span><span id="line-15"></span><span>
</span><span id="line-16"></span><span class="hs-comment">{-|
This module implements the main abstract logic of the Internet Computer. It
assumes a pure and abstracted view on Canisters (provided by &quot;IC.Canister&quot;),
and deals with abstract requests ('CallRequest', 'QueryRequest', ...), so HTTP
and CBOR-level processing has already happened.
-}</span><span>
</span><span id="line-22"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">IC.Ref</span><span>
</span><span id="line-23"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="IC.Ref.html#IC"><span class="hs-identifier">IC</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-24"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#CallRequest"><span class="hs-identifier">CallRequest</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-25"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#callerOfCallRequest"><span class="hs-identifier">callerOfCallRequest</span></a></span><span>
</span><span id="line-26"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#QueryRequest"><span class="hs-identifier">QueryRequest</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-27"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#ReadStateRequest"><span class="hs-identifier">ReadStateRequest</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-28"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#RequestStatus"><span class="hs-identifier">RequestStatus</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-29"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#ReqResponse"><span class="hs-identifier">ReqResponse</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#CallResponse"><span class="hs-identifier">CallResponse</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-31"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#initialIC"><span class="hs-identifier">initialIC</span></a></span><span>
</span><span id="line-32"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#authCallRequest"><span class="hs-identifier">authCallRequest</span></a></span><span>
</span><span id="line-33"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#authQueryRequest"><span class="hs-identifier">authQueryRequest</span></a></span><span>
</span><span id="line-34"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#authReadStateRequest"><span class="hs-identifier">authReadStateRequest</span></a></span><span>
</span><span id="line-35"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#submitRequest"><span class="hs-identifier">submitRequest</span></a></span><span>
</span><span id="line-36"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#handleQuery"><span class="hs-identifier">handleQuery</span></a></span><span>
</span><span id="line-37"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#handleReadState"><span class="hs-identifier">handleReadState</span></a></span><span>
</span><span id="line-38"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#runStep"><span class="hs-identifier">runStep</span></a></span><span>
</span><span id="line-39"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#runToCompletion"><span class="hs-identifier">runToCompletion</span></a></span><span>
</span><span id="line-40"></span><span>  </span><span class="annot"><span class="hs-comment">-- $ Exported for use as a library, e.g. in testing</span></span><span>
</span><span id="line-41"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#setAllTimesTo"><span class="hs-identifier">setAllTimesTo</span></a></span><span>
</span><span id="line-42"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#createEmptyCanister"><span class="hs-identifier">createEmptyCanister</span></a></span><span>
</span><span id="line-43"></span><span>  </span><span class="annot"><span class="hs-comment">-- $ Exported merely for debug introspection</span></span><span>
</span><span id="line-44"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#CallContext"><span class="hs-identifier">CallContext</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#Message"><span class="hs-identifier">Message</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-46"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#CanState"><span class="hs-identifier">CanState</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-47"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#CallOrigin"><span class="hs-identifier">CallOrigin</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-48"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#EntryPoint"><span class="hs-identifier">EntryPoint</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-49"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#RunStatus"><span class="hs-identifier">RunStatus</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-50"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#CanisterContent"><span class="hs-identifier">CanisterContent</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-51"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-52"></span><span class="hs-keyword">where</span><span>
</span><span id="line-53"></span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">M</span></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Row</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">R</span></span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Row.Variants</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">V</span></span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString.Lazy</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BS</span></span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">T</span></span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Vector</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Vec</span></span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Set</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">S</span></span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List</span></span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Numeric.Natural</span></span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Functor</span></span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.State.Class</span></span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Except</span></span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Random.Lazy</span></span><span>
</span><span id="line-68"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Sequence</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Seq</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Foldable</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">toList</span></span><span class="hs-special">)</span><span>
</span><span id="line-70"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Codec.Candid</span></span><span>
</span><span id="line-71"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Row</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-operator">(.==)</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-operator">(.+)</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-operator">(.!)</span></span><span class="hs-special">,</span><span> </span><span class="hs-keyword">type</span><span> </span><span class="annot"><span class="hs-operator">(.!)</span></span><span class="hs-special">)</span><span>
</span><span id="line-72"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">GHC.Stack</span></span><span>
</span><span id="line-73"></span><span>
</span><span id="line-74"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="IC.Types.html"><span class="hs-identifier">IC.Types</span></a></span><span>
</span><span id="line-75"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="IC.Constants.html"><span class="hs-identifier">IC.Constants</span></a></span><span>
</span><span id="line-76"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="IC.Canister.html"><span class="hs-identifier">IC.Canister</span></a></span><span>
</span><span id="line-77"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="IC.CBOR.Utils.html"><span class="hs-identifier">IC.CBOR.Utils</span></a></span><span>
</span><span id="line-78"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="IC.Id.Fresh.html"><span class="hs-identifier">IC.Id.Fresh</span></a></span><span>
</span><span id="line-79"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="IC.Utils.html"><span class="hs-identifier">IC.Utils</span></a></span><span>
</span><span id="line-80"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="IC.Management.html"><span class="hs-identifier">IC.Management</span></a></span><span>
</span><span id="line-81"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="IC.HashTree.html"><span class="hs-identifier">IC.HashTree</span></a></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.HashTree.html#Blob"><span class="hs-identifier">Blob</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-82"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="IC.Certificate.html"><span class="hs-identifier">IC.Certificate</span></a></span><span>
</span><span id="line-83"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="IC.Certificate.Value.html"><span class="hs-identifier">IC.Certificate.Value</span></a></span><span>
</span><span id="line-84"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="IC.Certificate.CBOR.html"><span class="hs-identifier">IC.Certificate.CBOR</span></a></span><span>
</span><span id="line-85"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="IC.Crypto.html"><span class="hs-identifier">IC.Crypto</span></a></span><span>
</span><span id="line-86"></span><span>
</span><span id="line-87"></span><span class="hs-comment">-- Abstract HTTP Interface</span><span>
</span><span id="line-88"></span><span>
</span><span id="line-89"></span><span class="hs-keyword">data</span><span> </span><span id="CallRequest"><span class="annot"><a href="IC.Ref.html#CallRequest"><span class="hs-identifier hs-var">CallRequest</span></a></span></span><span>
</span><span id="line-90"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span id="CallRequest"><span class="annot"><a href="IC.Ref.html#CallRequest"><span class="hs-identifier hs-var">CallRequest</span></a></span></span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="annot"><a href="IC.Types.html#UserId"><span class="hs-identifier hs-type">UserId</span></a></span><span> </span><span class="annot"><a href="IC.Types.html#MethodName"><span class="hs-identifier hs-type">MethodName</span></a></span><span> </span><span class="annot"><a href="IC.Types.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span>
</span><span id="line-91"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679323083"><span id="local-6989586621679323085"><span class="annot"><span class="annottext">CallRequest -&gt; CallRequest -&gt; Bool
(CallRequest -&gt; CallRequest -&gt; Bool)
-&gt; (CallRequest -&gt; CallRequest -&gt; Bool) -&gt; Eq CallRequest
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: CallRequest -&gt; CallRequest -&gt; Bool
$c/= :: CallRequest -&gt; CallRequest -&gt; Bool
== :: CallRequest -&gt; CallRequest -&gt; Bool
$c== :: CallRequest -&gt; CallRequest -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679323067"><span id="local-6989586621679323069"><span id="local-6989586621679323071"><span id="local-6989586621679323073"><span id="local-6989586621679323075"><span id="local-6989586621679323077"><span id="local-6989586621679323079"><span class="annot"><span class="annottext">Eq CallRequest
Eq CallRequest =&gt;
(CallRequest -&gt; CallRequest -&gt; Ordering)
-&gt; (CallRequest -&gt; CallRequest -&gt; Bool)
-&gt; (CallRequest -&gt; CallRequest -&gt; Bool)
-&gt; (CallRequest -&gt; CallRequest -&gt; Bool)
-&gt; (CallRequest -&gt; CallRequest -&gt; Bool)
-&gt; (CallRequest -&gt; CallRequest -&gt; CallRequest)
-&gt; (CallRequest -&gt; CallRequest -&gt; CallRequest)
-&gt; Ord CallRequest
CallRequest -&gt; CallRequest -&gt; Bool
CallRequest -&gt; CallRequest -&gt; Ordering
CallRequest -&gt; CallRequest -&gt; CallRequest
forall a.
Eq a =&gt;
(a -&gt; a -&gt; Ordering)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; a)
-&gt; (a -&gt; a -&gt; a)
-&gt; Ord a
min :: CallRequest -&gt; CallRequest -&gt; CallRequest
$cmin :: CallRequest -&gt; CallRequest -&gt; CallRequest
max :: CallRequest -&gt; CallRequest -&gt; CallRequest
$cmax :: CallRequest -&gt; CallRequest -&gt; CallRequest
&gt;= :: CallRequest -&gt; CallRequest -&gt; Bool
$c&gt;= :: CallRequest -&gt; CallRequest -&gt; Bool
&gt; :: CallRequest -&gt; CallRequest -&gt; Bool
$c&gt; :: CallRequest -&gt; CallRequest -&gt; Bool
&lt;= :: CallRequest -&gt; CallRequest -&gt; Bool
$c&lt;= :: CallRequest -&gt; CallRequest -&gt; Bool
&lt; :: CallRequest -&gt; CallRequest -&gt; Bool
$c&lt; :: CallRequest -&gt; CallRequest -&gt; Bool
compare :: CallRequest -&gt; CallRequest -&gt; Ordering
$ccompare :: CallRequest -&gt; CallRequest -&gt; Ordering
$cp1Ord :: Eq CallRequest
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Ord</span></span></span></span></span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679323060"><span id="local-6989586621679323062"><span id="local-6989586621679323064"><span class="annot"><span class="annottext">Int -&gt; CallRequest -&gt; ShowS
[CallRequest] -&gt; ShowS
CallRequest -&gt; String
(Int -&gt; CallRequest -&gt; ShowS)
-&gt; (CallRequest -&gt; String)
-&gt; ([CallRequest] -&gt; ShowS)
-&gt; Show CallRequest
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [CallRequest] -&gt; ShowS
$cshowList :: [CallRequest] -&gt; ShowS
show :: CallRequest -&gt; String
$cshow :: CallRequest -&gt; String
showsPrec :: Int -&gt; CallRequest -&gt; ShowS
$cshowsPrec :: Int -&gt; CallRequest -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-92"></span><span>
</span><span id="line-93"></span><span class="hs-keyword">data</span><span> </span><span id="QueryRequest"><span class="annot"><a href="IC.Ref.html#QueryRequest"><span class="hs-identifier hs-var">QueryRequest</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="QueryRequest"><span class="annot"><a href="IC.Ref.html#QueryRequest"><span class="hs-identifier hs-var">QueryRequest</span></a></span></span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="annot"><a href="IC.Types.html#UserId"><span class="hs-identifier hs-type">UserId</span></a></span><span> </span><span class="annot"><a href="IC.Types.html#MethodName"><span class="hs-identifier hs-type">MethodName</span></a></span><span> </span><span class="annot"><a href="IC.Types.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span>
</span><span id="line-94"></span><span class="hs-keyword">data</span><span> </span><span id="ReadStateRequest"><span class="annot"><a href="IC.Ref.html#ReadStateRequest"><span class="hs-identifier hs-var">ReadStateRequest</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ReadStateRequest"><span class="annot"><a href="IC.Ref.html#ReadStateRequest"><span class="hs-identifier hs-var">ReadStateRequest</span></a></span></span><span> </span><span class="annot"><a href="IC.Types.html#UserId"><span class="hs-identifier hs-type">UserId</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="IC.HashTree.html#Path"><span class="hs-identifier hs-type">Path</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-95"></span><span>
</span><span id="line-96"></span><span class="hs-keyword">data</span><span> </span><span id="RequestStatus"><span class="annot"><a href="IC.Ref.html#RequestStatus"><span class="hs-identifier hs-var">RequestStatus</span></a></span></span><span>
</span><span id="line-97"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="Received"><span class="annot"><a href="IC.Ref.html#Received"><span class="hs-identifier hs-var">Received</span></a></span></span><span>
</span><span id="line-98"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="Processing"><span class="annot"><a href="IC.Ref.html#Processing"><span class="hs-identifier hs-var">Processing</span></a></span></span><span>
</span><span id="line-99"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="CallResponse"><span class="annot"><a href="IC.Ref.html#CallResponse"><span class="hs-identifier hs-var">CallResponse</span></a></span></span><span> </span><span class="annot"><a href="IC.Ref.html#CallResponse"><span class="hs-identifier hs-type">CallResponse</span></a></span><span>
</span><span id="line-100"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679323048"><span id="local-6989586621679323050"><span id="local-6989586621679323052"><span class="annot"><span class="annottext">Int -&gt; RequestStatus -&gt; ShowS
[RequestStatus] -&gt; ShowS
RequestStatus -&gt; String
(Int -&gt; RequestStatus -&gt; ShowS)
-&gt; (RequestStatus -&gt; String)
-&gt; ([RequestStatus] -&gt; ShowS)
-&gt; Show RequestStatus
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [RequestStatus] -&gt; ShowS
$cshowList :: [RequestStatus] -&gt; ShowS
show :: RequestStatus -&gt; String
$cshow :: RequestStatus -&gt; String
showsPrec :: Int -&gt; RequestStatus -&gt; ShowS
$cshowsPrec :: Int -&gt; RequestStatus -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-101"></span><span>
</span><span id="line-102"></span><span class="hs-keyword">data</span><span> </span><span id="CallResponse"><span class="annot"><a href="IC.Ref.html#CallResponse"><span class="hs-identifier hs-var">CallResponse</span></a></span></span><span>
</span><span id="line-103"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="Rejected"><span class="annot"><a href="IC.Ref.html#Rejected"><span class="hs-identifier hs-var">Rejected</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Types.html#RejectCode"><span class="hs-identifier hs-type">RejectCode</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span class="hs-special">)</span><span>
</span><span id="line-104"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="Replied"><span class="annot"><a href="IC.Ref.html#Replied"><span class="hs-identifier hs-var">Replied</span></a></span></span><span> </span><span class="annot"><a href="IC.Types.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span>
</span><span id="line-105"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679323040"><span id="local-6989586621679323042"><span id="local-6989586621679323044"><span class="annot"><span class="annottext">Int -&gt; CallResponse -&gt; ShowS
[CallResponse] -&gt; ShowS
CallResponse -&gt; String
(Int -&gt; CallResponse -&gt; ShowS)
-&gt; (CallResponse -&gt; String)
-&gt; ([CallResponse] -&gt; ShowS)
-&gt; Show CallResponse
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [CallResponse] -&gt; ShowS
$cshowList :: [CallResponse] -&gt; ShowS
show :: CallResponse -&gt; String
$cshow :: CallResponse -&gt; String
showsPrec :: Int -&gt; CallResponse -&gt; ShowS
$cshowsPrec :: Int -&gt; CallResponse -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-106"></span><span>
</span><span id="line-107"></span><span class="hs-keyword">data</span><span> </span><span id="ReqResponse"><span class="annot"><a href="IC.Ref.html#ReqResponse"><span class="hs-identifier hs-var">ReqResponse</span></a></span></span><span>
</span><span id="line-108"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="QueryResponse"><span class="annot"><a href="IC.Ref.html#QueryResponse"><span class="hs-identifier hs-var">QueryResponse</span></a></span></span><span> </span><span class="annot"><a href="IC.Ref.html#CallResponse"><span class="hs-identifier hs-type">CallResponse</span></a></span><span>
</span><span id="line-109"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="ReadStateResponse"><span class="annot"><a href="IC.Ref.html#ReadStateResponse"><span class="hs-identifier hs-var">ReadStateResponse</span></a></span></span><span> </span><span class="annot"><a href="IC.Certificate.html#Certificate"><span class="hs-identifier hs-type">Certificate</span></a></span><span>
</span><span id="line-110"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679323032"><span id="local-6989586621679323034"><span id="local-6989586621679323036"><span class="annot"><span class="annottext">Int -&gt; ReqResponse -&gt; ShowS
[ReqResponse] -&gt; ShowS
ReqResponse -&gt; String
(Int -&gt; ReqResponse -&gt; ShowS)
-&gt; (ReqResponse -&gt; String)
-&gt; ([ReqResponse] -&gt; ShowS)
-&gt; Show ReqResponse
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [ReqResponse] -&gt; ShowS
$cshowList :: [ReqResponse] -&gt; ShowS
show :: ReqResponse -&gt; String
$cshow :: ReqResponse -&gt; String
showsPrec :: Int -&gt; ReqResponse -&gt; ShowS
$cshowsPrec :: Int -&gt; ReqResponse -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-111"></span><span>
</span><span id="line-112"></span><span class="hs-comment">-- IC state</span><span>
</span><span id="line-113"></span><span>
</span><span id="line-114"></span><span class="hs-comment">-- The canister state</span><span>
</span><span id="line-115"></span><span>
</span><span id="line-116"></span><span class="hs-keyword">data</span><span> </span><span id="RunStatus"><span class="annot"><a href="IC.Ref.html#RunStatus"><span class="hs-identifier hs-var">RunStatus</span></a></span></span><span>
</span><span id="line-117"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="IsRunning"><span class="annot"><a href="IC.Ref.html#IsRunning"><span class="hs-identifier hs-var">IsRunning</span></a></span></span><span>
</span><span id="line-118"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="IsStopping"><span class="annot"><a href="IC.Ref.html#IsStopping"><span class="hs-identifier hs-var">IsStopping</span></a></span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="IC.Ref.html#CallId"><span class="hs-identifier hs-type">CallId</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-119"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="IsStopped"><span class="annot"><a href="IC.Ref.html#IsStopped"><span class="hs-identifier hs-var">IsStopped</span></a></span></span><span>
</span><span id="line-120"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="IsDeleted"><span class="annot"><a href="IC.Ref.html#IsDeleted"><span class="hs-identifier hs-var">IsDeleted</span></a></span></span><span> </span><span class="hs-comment">-- not actually a run state, but convenient in this code</span><span>
</span><span id="line-121"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679323021"><span id="local-6989586621679323023"><span id="local-6989586621679323025"><span class="annot"><span class="annottext">Int -&gt; RunStatus -&gt; ShowS
[RunStatus] -&gt; ShowS
RunStatus -&gt; String
(Int -&gt; RunStatus -&gt; ShowS)
-&gt; (RunStatus -&gt; String)
-&gt; ([RunStatus] -&gt; ShowS)
-&gt; Show RunStatus
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [RunStatus] -&gt; ShowS
$cshowList :: [RunStatus] -&gt; ShowS
show :: RunStatus -&gt; String
$cshow :: RunStatus -&gt; String
showsPrec :: Int -&gt; RunStatus -&gt; ShowS
$cshowsPrec :: Int -&gt; RunStatus -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-122"></span><span>
</span><span id="line-123"></span><span class="hs-keyword">data</span><span> </span><span id="CanisterContent"><span class="annot"><a href="IC.Ref.html#CanisterContent"><span class="hs-identifier hs-var">CanisterContent</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="CanisterContent"><span class="annot"><a href="IC.Ref.html#CanisterContent"><span class="hs-identifier hs-var">CanisterContent</span></a></span></span><span>
</span><span id="line-124"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="can_mod"><span class="annot"><span class="annottext">CanisterContent -&gt; CanisterModule
</span><a href="IC.Ref.html#can_mod"><span class="hs-identifier hs-var hs-var">can_mod</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Canister.html#CanisterModule"><span class="hs-identifier hs-type">CanisterModule</span></a></span><span>
</span><span id="line-125"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="wasm_state"><span class="annot"><span class="annottext">CanisterContent -&gt; WasmState
</span><a href="IC.Ref.html#wasm_state"><span class="hs-identifier hs-var hs-var">wasm_state</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Canister.html#WasmState"><span class="hs-identifier hs-type">WasmState</span></a></span><span>
</span><span id="line-126"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-127"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679323012"><span id="local-6989586621679323014"><span id="local-6989586621679323016"><span class="annot"><span class="annottext">Int -&gt; CanisterContent -&gt; ShowS
[CanisterContent] -&gt; ShowS
CanisterContent -&gt; String
(Int -&gt; CanisterContent -&gt; ShowS)
-&gt; (CanisterContent -&gt; String)
-&gt; ([CanisterContent] -&gt; ShowS)
-&gt; Show CanisterContent
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [CanisterContent] -&gt; ShowS
$cshowList :: [CanisterContent] -&gt; ShowS
show :: CanisterContent -&gt; String
$cshow :: CanisterContent -&gt; String
showsPrec :: Int -&gt; CanisterContent -&gt; ShowS
$cshowsPrec :: Int -&gt; CanisterContent -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-128"></span><span>
</span><span id="line-129"></span><span class="hs-keyword">data</span><span> </span><span id="CanState"><span class="annot"><a href="IC.Ref.html#CanState"><span class="hs-identifier hs-var">CanState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="CanState"><span class="annot"><a href="IC.Ref.html#CanState"><span class="hs-identifier hs-var">CanState</span></a></span></span><span>
</span><span id="line-130"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="content"><span class="annot"><span class="annottext">CanState -&gt; Maybe CanisterContent
</span><a href="IC.Ref.html#content"><span class="hs-identifier hs-var hs-var">content</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="IC.Ref.html#CanisterContent"><span class="hs-identifier hs-type">CanisterContent</span></a></span><span> </span><span class="hs-comment">-- absent when empty</span><span>
</span><span id="line-131"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="run_status"><span class="annot"><span class="annottext">CanState -&gt; RunStatus
</span><a href="IC.Ref.html#run_status"><span class="hs-identifier hs-var hs-var">run_status</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#RunStatus"><span class="hs-identifier hs-type">RunStatus</span></a></span><span>
</span><span id="line-132"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="controllers"><span class="annot"><span class="annottext">CanState -&gt; Set EntityId
</span><a href="IC.Ref.html#controllers"><span class="hs-identifier hs-var hs-var">controllers</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.Set</span></span><span> </span><span class="annot"><a href="IC.Types.html#EntityId"><span class="hs-identifier hs-type">EntityId</span></a></span><span>
</span><span id="line-133"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="memory_allocation"><span class="annot"><span class="annottext">CanState -&gt; Natural
</span><a href="IC.Ref.html#memory_allocation"><span class="hs-identifier hs-var hs-var">memory_allocation</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Natural</span></span><span>
</span><span id="line-134"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="compute_allocation"><span class="annot"><span class="annottext">CanState -&gt; Natural
</span><a href="IC.Ref.html#compute_allocation"><span class="hs-identifier hs-var hs-var">compute_allocation</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Natural</span></span><span>
</span><span id="line-135"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="freezing_threshold"><span class="annot"><span class="annottext">CanState -&gt; Natural
</span><a href="IC.Ref.html#freezing_threshold"><span class="hs-identifier hs-var hs-var">freezing_threshold</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Natural</span></span><span>
</span><span id="line-136"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="time"><span class="annot"><span class="annottext">CanState -&gt; Timestamp
</span><a href="IC.Ref.html#time"><span class="hs-identifier hs-var hs-var">time</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Types.html#Timestamp"><span class="hs-identifier hs-type">Timestamp</span></a></span><span>
</span><span id="line-137"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="cycle_balance"><span class="annot"><span class="annottext">CanState -&gt; Natural
</span><a href="IC.Ref.html#cycle_balance"><span class="hs-identifier hs-var hs-var">cycle_balance</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Natural</span></span><span>
</span><span id="line-138"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="certified_data"><span class="annot"><span class="annottext">CanState -&gt; Blob
</span><a href="IC.Ref.html#certified_data"><span class="hs-identifier hs-var hs-var">certified_data</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Types.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span>
</span><span id="line-139"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-140"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679322996"><span id="local-6989586621679322998"><span id="local-6989586621679323000"><span class="annot"><span class="annottext">Int -&gt; CanState -&gt; ShowS
[CanState] -&gt; ShowS
CanState -&gt; String
(Int -&gt; CanState -&gt; ShowS)
-&gt; (CanState -&gt; String) -&gt; ([CanState] -&gt; ShowS) -&gt; Show CanState
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [CanState] -&gt; ShowS
$cshowList :: [CanState] -&gt; ShowS
show :: CanState -&gt; String
$cshow :: CanState -&gt; String
showsPrec :: Int -&gt; CanState -&gt; ShowS
$cshowsPrec :: Int -&gt; CanState -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-141"></span><span>
</span><span id="line-142"></span><span class="hs-comment">-- A canister entry point is either a publicly named function, or a closure</span><span>
</span><span id="line-143"></span><span class="hs-comment">-- (callback + environment)</span><span>
</span><span id="line-144"></span><span class="hs-keyword">data</span><span> </span><span id="EntryPoint"><span class="annot"><a href="IC.Ref.html#EntryPoint"><span class="hs-identifier hs-var">EntryPoint</span></a></span></span><span>
</span><span id="line-145"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="Public"><span class="annot"><a href="IC.Ref.html#Public"><span class="hs-identifier hs-var">Public</span></a></span></span><span> </span><span class="annot"><a href="IC.Types.html#MethodName"><span class="hs-identifier hs-type">MethodName</span></a></span><span> </span><span class="annot"><a href="IC.Types.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span>
</span><span id="line-146"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="Closure"><span class="annot"><a href="IC.Ref.html#Closure"><span class="hs-identifier hs-var">Closure</span></a></span></span><span> </span><span class="annot"><a href="IC.Types.html#Callback"><span class="hs-identifier hs-type">Callback</span></a></span><span> </span><span class="annot"><a href="IC.Types.html#Response"><span class="hs-identifier hs-type">Response</span></a></span><span> </span><span class="annot"><a href="IC.Types.html#Cycles"><span class="hs-identifier hs-type">Cycles</span></a></span><span>
</span><span id="line-147"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679322987"><span id="local-6989586621679322989"><span id="local-6989586621679322991"><span class="annot"><span class="annottext">Int -&gt; EntryPoint -&gt; ShowS
[EntryPoint] -&gt; ShowS
EntryPoint -&gt; String
(Int -&gt; EntryPoint -&gt; ShowS)
-&gt; (EntryPoint -&gt; String)
-&gt; ([EntryPoint] -&gt; ShowS)
-&gt; Show EntryPoint
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [EntryPoint] -&gt; ShowS
$cshowList :: [EntryPoint] -&gt; ShowS
show :: EntryPoint -&gt; String
$cshow :: EntryPoint -&gt; String
showsPrec :: Int -&gt; EntryPoint -&gt; ShowS
$cshowsPrec :: Int -&gt; EntryPoint -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-148"></span><span>
</span><span id="line-149"></span><span class="hs-keyword">type</span><span> </span><span id="CallId"><span class="annot"><a href="IC.Ref.html#CallId"><span class="hs-identifier hs-var">CallId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-150"></span><span class="hs-keyword">data</span><span> </span><span id="CallContext"><span class="annot"><a href="IC.Ref.html#CallContext"><span class="hs-identifier hs-var">CallContext</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="CallContext"><span class="annot"><a href="IC.Ref.html#CallContext"><span class="hs-identifier hs-var">CallContext</span></a></span></span><span>
</span><span id="line-151"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="canister"><span class="annot"><span class="annottext">CallContext -&gt; EntityId
</span><a href="IC.Ref.html#canister"><span class="hs-identifier hs-var hs-var">canister</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span>
</span><span id="line-152"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="origin"><span class="annot"><span class="annottext">CallContext -&gt; CallOrigin
</span><a href="IC.Ref.html#origin"><span class="hs-identifier hs-var hs-var">origin</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#CallOrigin"><span class="hs-identifier hs-type">CallOrigin</span></a></span><span>
</span><span id="line-153"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="responded"><span class="annot"><span class="annottext">CallContext -&gt; Responded
</span><a href="IC.Ref.html#responded"><span class="hs-identifier hs-var hs-var">responded</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Types.html#Responded"><span class="hs-identifier hs-type">Responded</span></a></span><span>
</span><span id="line-154"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="deleted"><span class="annot"><span class="annottext">CallContext -&gt; Bool
</span><a href="IC.Ref.html#deleted"><span class="hs-identifier hs-var hs-var">deleted</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-155"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="available_cycles"><span class="annot"><span class="annottext">CallContext -&gt; Natural
</span><a href="IC.Ref.html#available_cycles"><span class="hs-identifier hs-var hs-var">available_cycles</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Types.html#Cycles"><span class="hs-identifier hs-type">Cycles</span></a></span><span>
</span><span id="line-156"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="last_trap"><span class="annot"><span class="annottext">CallContext -&gt; Maybe String
</span><a href="IC.Ref.html#last_trap"><span class="hs-identifier hs-var hs-var">last_trap</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-157"></span><span>      </span><span class="hs-comment">-- ^ non-normative, but yields better reject messages</span><span>
</span><span id="line-158"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-159"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679322974"><span id="local-6989586621679322976"><span id="local-6989586621679322978"><span class="annot"><span class="annottext">Int -&gt; CallContext -&gt; ShowS
[CallContext] -&gt; ShowS
CallContext -&gt; String
(Int -&gt; CallContext -&gt; ShowS)
-&gt; (CallContext -&gt; String)
-&gt; ([CallContext] -&gt; ShowS)
-&gt; Show CallContext
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [CallContext] -&gt; ShowS
$cshowList :: [CallContext] -&gt; ShowS
show :: CallContext -&gt; String
$cshow :: CallContext -&gt; String
showsPrec :: Int -&gt; CallContext -&gt; ShowS
$cshowsPrec :: Int -&gt; CallContext -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-160"></span><span>
</span><span id="line-161"></span><span class="hs-keyword">data</span><span> </span><span id="CallOrigin"><span class="annot"><a href="IC.Ref.html#CallOrigin"><span class="hs-identifier hs-var">CallOrigin</span></a></span></span><span>
</span><span id="line-162"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="FromUser"><span class="annot"><a href="IC.Ref.html#FromUser"><span class="hs-identifier hs-var">FromUser</span></a></span></span><span> </span><span class="annot"><a href="IC.Types.html#RequestID"><span class="hs-identifier hs-type">RequestID</span></a></span><span>
</span><span id="line-163"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="FromCanister"><span class="annot"><a href="IC.Ref.html#FromCanister"><span class="hs-identifier hs-var">FromCanister</span></a></span></span><span> </span><span class="annot"><a href="IC.Ref.html#CallId"><span class="hs-identifier hs-type">CallId</span></a></span><span> </span><span class="annot"><a href="IC.Types.html#Callback"><span class="hs-identifier hs-type">Callback</span></a></span><span>
</span><span id="line-164"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679322965"><span id="local-6989586621679322967"><span id="local-6989586621679322969"><span class="annot"><span class="annottext">Int -&gt; CallOrigin -&gt; ShowS
[CallOrigin] -&gt; ShowS
CallOrigin -&gt; String
(Int -&gt; CallOrigin -&gt; ShowS)
-&gt; (CallOrigin -&gt; String)
-&gt; ([CallOrigin] -&gt; ShowS)
-&gt; Show CallOrigin
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [CallOrigin] -&gt; ShowS
$cshowList :: [CallOrigin] -&gt; ShowS
show :: CallOrigin -&gt; String
$cshow :: CallOrigin -&gt; String
showsPrec :: Int -&gt; CallOrigin -&gt; ShowS
$cshowsPrec :: Int -&gt; CallOrigin -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-165"></span><span>
</span><span id="line-166"></span><span class="hs-keyword">data</span><span> </span><span id="Message"><span class="annot"><a href="IC.Ref.html#Message"><span class="hs-identifier hs-var">Message</span></a></span></span><span>
</span><span id="line-167"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="CallMessage"><span class="annot"><a href="IC.Ref.html#CallMessage"><span class="hs-identifier hs-var">CallMessage</span></a></span></span><span>
</span><span id="line-168"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="call_context"><span class="annot"><span class="annottext">Message -&gt; Int
</span><a href="IC.Ref.html#call_context"><span class="hs-identifier hs-var hs-var">call_context</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#CallId"><span class="hs-identifier hs-type">CallId</span></a></span><span>
</span><span id="line-169"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="entry"><span class="annot"><span class="annottext">Message -&gt; EntryPoint
</span><a href="IC.Ref.html#entry"><span class="hs-identifier hs-var hs-var">entry</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#EntryPoint"><span class="hs-identifier hs-type">EntryPoint</span></a></span><span>
</span><span id="line-170"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-171"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="ResponseMessage"><span class="annot"><a href="IC.Ref.html#ResponseMessage"><span class="hs-identifier hs-var">ResponseMessage</span></a></span></span><span>
</span><span id="line-172"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="call_context"><span class="annot"><a href="IC.Ref.html#call_context"><span class="hs-identifier hs-var">call_context</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#CallId"><span class="hs-identifier hs-type">CallId</span></a></span><span>
</span><span id="line-173"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="response"><span class="annot"><span class="annottext">Message -&gt; Response
</span><a href="IC.Ref.html#response"><span class="hs-identifier hs-var hs-var">response</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Types.html#Response"><span class="hs-identifier hs-type">Response</span></a></span><span>
</span><span id="line-174"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="refunded_cycles"><span class="annot"><span class="annottext">Message -&gt; Natural
</span><a href="IC.Ref.html#refunded_cycles"><span class="hs-identifier hs-var hs-var">refunded_cycles</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Types.html#Cycles"><span class="hs-identifier hs-type">Cycles</span></a></span><span>
</span><span id="line-175"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-176"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679322953"><span id="local-6989586621679322955"><span id="local-6989586621679322957"><span class="annot"><span class="annottext">Int -&gt; Message -&gt; ShowS
[Message] -&gt; ShowS
Message -&gt; String
(Int -&gt; Message -&gt; ShowS)
-&gt; (Message -&gt; String) -&gt; ([Message] -&gt; ShowS) -&gt; Show Message
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [Message] -&gt; ShowS
$cshowList :: [Message] -&gt; ShowS
show :: Message -&gt; String
$cshow :: Message -&gt; String
showsPrec :: Int -&gt; Message -&gt; ShowS
$cshowsPrec :: Int -&gt; Message -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-177"></span><span>
</span><span id="line-178"></span><span class="hs-comment">-- Finally, the full IC state:</span><span>
</span><span id="line-179"></span><span>
</span><span id="line-180"></span><span class="hs-keyword">data</span><span> </span><span id="IC"><span class="annot"><a href="IC.Ref.html#IC"><span class="hs-identifier hs-var">IC</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="IC"><span class="annot"><a href="IC.Ref.html#IC"><span class="hs-identifier hs-var">IC</span></a></span></span><span>
</span><span id="line-181"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="canisters"><span class="annot"><span class="annottext">IC -&gt; EntityId &#8614; CanState
</span><a href="IC.Ref.html#canisters"><span class="hs-identifier hs-var hs-var">canisters</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="annot"><a href="IC.Types.html#%21A6"><span class="hs-operator hs-type">&#8614;</span></a></span><span> </span><span class="annot"><a href="IC.Ref.html#CanState"><span class="hs-identifier hs-type">CanState</span></a></span><span>
</span><span id="line-182"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="requests"><span class="annot"><span class="annottext">IC -&gt; Blob &#8614; (CallRequest, RequestStatus)
</span><a href="IC.Ref.html#requests"><span class="hs-identifier hs-var hs-var">requests</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Types.html#RequestID"><span class="hs-identifier hs-type">RequestID</span></a></span><span> </span><span class="annot"><a href="IC.Types.html#%21A6"><span class="hs-operator hs-type">&#8614;</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Ref.html#CallRequest"><span class="hs-identifier hs-type">CallRequest</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#RequestStatus"><span class="hs-identifier hs-type">RequestStatus</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-183"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="messages"><span class="annot"><span class="annottext">IC -&gt; Seq Message
</span><a href="IC.Ref.html#messages"><span class="hs-identifier hs-var hs-var">messages</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Seq</span></span><span> </span><span class="annot"><a href="IC.Ref.html#Message"><span class="hs-identifier hs-type">Message</span></a></span><span>
</span><span id="line-184"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="call_contexts"><span class="annot"><span class="annottext">IC -&gt; Int &#8614; CallContext
</span><a href="IC.Ref.html#call_contexts"><span class="hs-identifier hs-var hs-var">call_contexts</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#CallId"><span class="hs-identifier hs-type">CallId</span></a></span><span> </span><span class="annot"><a href="IC.Types.html#%21A6"><span class="hs-operator hs-type">&#8614;</span></a></span><span> </span><span class="annot"><a href="IC.Ref.html#CallContext"><span class="hs-identifier hs-type">CallContext</span></a></span><span>
</span><span id="line-185"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="rng"><span class="annot"><span class="annottext">IC -&gt; StdGen
</span><a href="IC.Ref.html#rng"><span class="hs-identifier hs-var hs-var">rng</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StdGen</span></span><span>
</span><span id="line-186"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="secretRootKey"><span class="annot"><span class="annottext">IC -&gt; SecretKey
</span><a href="IC.Ref.html#secretRootKey"><span class="hs-identifier hs-var hs-var">secretRootKey</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Crypto.html#SecretKey"><span class="hs-identifier hs-type">SecretKey</span></a></span><span>
</span><span id="line-187"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="secretSubnetKey"><span class="annot"><span class="annottext">IC -&gt; SecretKey
</span><a href="IC.Ref.html#secretSubnetKey"><span class="hs-identifier hs-var hs-var">secretSubnetKey</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Crypto.html#SecretKey"><span class="hs-identifier hs-type">SecretKey</span></a></span><span>
</span><span id="line-188"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-189"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679322939"><span id="local-6989586621679322941"><span id="local-6989586621679322943"><span class="annot"><span class="annottext">Int -&gt; IC -&gt; ShowS
[IC] -&gt; ShowS
IC -&gt; String
(Int -&gt; IC -&gt; ShowS)
-&gt; (IC -&gt; String) -&gt; ([IC] -&gt; ShowS) -&gt; Show IC
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [IC] -&gt; ShowS
$cshowList :: [IC] -&gt; ShowS
show :: IC -&gt; String
$cshow :: IC -&gt; String
showsPrec :: Int -&gt; IC -&gt; ShowS
$cshowsPrec :: Int -&gt; IC -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-190"></span><span>
</span><span id="line-191"></span><span class="hs-comment">-- The functions below want stateful access to a value of type 'IC'</span><span>
</span><span id="line-192"></span><span class="hs-keyword">type</span><span> </span><span id="ICM"><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-var">ICM</span></a></span></span><span> </span><span id="local-6989586621679322938"><span class="annot"><a href="#local-6989586621679322938"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadState</span></span><span> </span><span class="annot"><a href="IC.Ref.html#IC"><span class="hs-identifier hs-type">IC</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679322938"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span class="hs-special">)</span><span>
</span><span id="line-193"></span><span>
</span><span id="line-194"></span><span class="annot"><a href="IC.Ref.html#initialIC"><span class="hs-identifier hs-type">initialIC</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="IC.Ref.html#IC"><span class="hs-identifier hs-type">IC</span></a></span><span>
</span><span id="line-195"></span><span id="initialIC"><span class="annot"><span class="annottext">initialIC :: IO IC
</span><a href="IC.Ref.html#initialIC"><span class="hs-identifier hs-var hs-var">initialIC</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-196"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679322937"><span class="annot"><span class="annottext">sk1 :: SecretKey
</span><a href="#local-6989586621679322937"><span class="hs-identifier hs-var hs-var">sk1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Blob -&gt; SecretKey
</span><a href="IC.Crypto.html#createSecretKeyBLS"><span class="hs-identifier hs-var">createSecretKeyBLS</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;ic-ref's very secure secret key&quot;</span></span><span>
</span><span id="line-197"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679322935"><span class="annot"><span class="annottext">sk2 :: SecretKey
</span><a href="#local-6989586621679322935"><span class="hs-identifier hs-var hs-var">sk2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Blob -&gt; SecretKey
</span><a href="IC.Crypto.html#createSecretKeyBLS"><span class="hs-identifier hs-var">createSecretKeyBLS</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;ic-ref's very secure subnet key&quot;</span></span><span>
</span><span id="line-198"></span><span>    </span><span class="annot"><span class="annottext">(EntityId &#8614; CanState)
-&gt; (Blob &#8614; (CallRequest, RequestStatus))
-&gt; Seq Message
-&gt; (Int &#8614; CallContext)
-&gt; StdGen
-&gt; SecretKey
-&gt; SecretKey
-&gt; IC
</span><a href="IC.Ref.html#IC"><span class="hs-identifier hs-var">IC</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId &#8614; CanState
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">Blob &#8614; (CallRequest, RequestStatus)
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">Seq Message
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">Int &#8614; CallContext
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">(StdGen -&gt; SecretKey -&gt; SecretKey -&gt; IC)
-&gt; IO StdGen -&gt; IO (SecretKey -&gt; SecretKey -&gt; IC)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">IO StdGen
forall (m :: * -&gt; *). MonadIO m =&gt; m StdGen
</span><span class="hs-identifier hs-var">newStdGen</span></span><span> </span><span class="annot"><span class="annottext">IO (SecretKey -&gt; SecretKey -&gt; IC)
-&gt; IO SecretKey -&gt; IO (SecretKey -&gt; IC)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">SecretKey -&gt; IO SecretKey
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">SecretKey
</span><a href="#local-6989586621679322937"><span class="hs-identifier hs-var">sk1</span></a></span><span> </span><span class="annot"><span class="annottext">IO (SecretKey -&gt; IC) -&gt; IO SecretKey -&gt; IO IC
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">SecretKey -&gt; IO SecretKey
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">SecretKey
</span><a href="#local-6989586621679322935"><span class="hs-identifier hs-var">sk2</span></a></span><span>
</span><span id="line-199"></span><span>
</span><span id="line-200"></span><span class="hs-comment">-- Request handling</span><span>
</span><span id="line-201"></span><span>
</span><span id="line-202"></span><span class="annot"><a href="IC.Ref.html#findRequest"><span class="hs-identifier hs-type">findRequest</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Types.html#RequestID"><span class="hs-identifier hs-type">RequestID</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Ref.html#IC"><span class="hs-identifier hs-type">IC</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Ref.html#CallRequest"><span class="hs-identifier hs-type">CallRequest</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#RequestStatus"><span class="hs-identifier hs-type">RequestStatus</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-203"></span><span id="findRequest"><span class="annot"><span class="annottext">findRequest :: Blob -&gt; IC -&gt; Maybe (CallRequest, RequestStatus)
</span><a href="IC.Ref.html#findRequest"><span class="hs-identifier hs-var hs-var">findRequest</span></a></span></span><span> </span><span id="local-6989586621679322931"><span class="annot"><span class="annottext">rid :: Blob
</span><a href="#local-6989586621679322931"><span class="hs-identifier hs-var">rid</span></a></span></span><span> </span><span id="local-6989586621679322930"><span class="annot"><span class="annottext">ic :: IC
</span><a href="#local-6989586621679322930"><span class="hs-identifier hs-var">ic</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Blob
-&gt; (Blob &#8614; (CallRequest, RequestStatus))
-&gt; Maybe (CallRequest, RequestStatus)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679322931"><span class="hs-identifier hs-var">rid</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IC -&gt; Blob &#8614; (CallRequest, RequestStatus)
</span><a href="IC.Ref.html#requests"><span class="hs-identifier hs-var hs-var">requests</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679322930"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-204"></span><span>
</span><span id="line-205"></span><span id="local-6989586621679323343"><span class="annot"><a href="IC.Ref.html#setReqStatus"><span class="hs-identifier hs-type">setReqStatus</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323343"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#RequestID"><span class="hs-identifier hs-type">RequestID</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Ref.html#RequestStatus"><span class="hs-identifier hs-type">RequestStatus</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323343"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-206"></span><span id="setReqStatus"><span class="annot"><span class="annottext">setReqStatus :: Blob -&gt; RequestStatus -&gt; m ()
</span><a href="IC.Ref.html#setReqStatus"><span class="hs-identifier hs-var hs-var">setReqStatus</span></a></span></span><span> </span><span id="local-6989586621679322927"><span class="annot"><span class="annottext">rid :: Blob
</span><a href="#local-6989586621679322927"><span class="hs-identifier hs-var">rid</span></a></span></span><span> </span><span id="local-6989586621679322926"><span class="annot"><span class="annottext">s :: RequestStatus
</span><a href="#local-6989586621679322926"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(IC -&gt; IC) -&gt; m ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((IC -&gt; IC) -&gt; m ()) -&gt; (IC -&gt; IC) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679322924"><span class="annot"><span class="annottext">ic :: IC
</span><a href="#local-6989586621679322924"><span class="hs-identifier hs-var">ic</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-207"></span><span>  </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679322924"><span class="hs-identifier hs-var">ic</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">requests :: Blob &#8614; (CallRequest, RequestStatus)
</span><a href="IC.Ref.html#requests"><span class="hs-identifier hs-var">requests</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((CallRequest, RequestStatus) -&gt; (CallRequest, RequestStatus))
-&gt; Blob
-&gt; (Blob &#8614; (CallRequest, RequestStatus))
-&gt; Blob &#8614; (CallRequest, RequestStatus)
forall k a. Ord k =&gt; (a -&gt; a) -&gt; k -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.adjust</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679322922"><span class="annot"><span class="annottext">r :: CallRequest
</span><a href="#local-6989586621679322922"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CallRequest
</span><a href="#local-6989586621679322922"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">RequestStatus
</span><a href="#local-6989586621679322926"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679322927"><span class="hs-identifier hs-var">rid</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IC -&gt; Blob &#8614; (CallRequest, RequestStatus)
</span><a href="IC.Ref.html#requests"><span class="hs-identifier hs-var hs-var">requests</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679322924"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-208"></span><span>
</span><span id="line-209"></span><span class="annot"><a href="IC.Ref.html#calleeOfCallRequest"><span class="hs-identifier hs-type">calleeOfCallRequest</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#CallRequest"><span class="hs-identifier hs-type">CallRequest</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#EntityId"><span class="hs-identifier hs-type">EntityId</span></a></span><span>
</span><span id="line-210"></span><span id="calleeOfCallRequest"><span class="annot"><span class="annottext">calleeOfCallRequest :: CallRequest -&gt; EntityId
</span><a href="IC.Ref.html#calleeOfCallRequest"><span class="hs-identifier hs-var hs-var">calleeOfCallRequest</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-211"></span><span>    </span><span class="annot"><a href="IC.Ref.html#CallRequest"><span class="hs-identifier hs-type">CallRequest</span></a></span><span> </span><span id="local-6989586621679322920"><span class="annot"><span class="annottext">canister_id :: EntityId
</span><a href="#local-6989586621679322920"><span class="hs-identifier hs-var">canister_id</span></a></span></span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322920"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-212"></span><span>
</span><span id="line-213"></span><span class="annot"><a href="IC.Ref.html#callerOfCallRequest"><span class="hs-identifier hs-type">callerOfCallRequest</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#CallRequest"><span class="hs-identifier hs-type">CallRequest</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#EntityId"><span class="hs-identifier hs-type">EntityId</span></a></span><span>
</span><span id="line-214"></span><span id="callerOfCallRequest"><span class="annot"><span class="annottext">callerOfCallRequest :: CallRequest -&gt; EntityId
</span><a href="IC.Ref.html#callerOfCallRequest"><span class="hs-identifier hs-var hs-var">callerOfCallRequest</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-215"></span><span>    </span><span class="annot"><a href="IC.Ref.html#CallRequest"><span class="hs-identifier hs-type">CallRequest</span></a></span><span> </span><span class="hs-identifier">_</span><span> </span><span id="local-6989586621679322919"><span class="annot"><span class="annottext">user_id :: EntityId
</span><a href="#local-6989586621679322919"><span class="hs-identifier hs-var">user_id</span></a></span></span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322919"><span class="hs-identifier hs-var">user_id</span></a></span><span>
</span><span id="line-216"></span><span>
</span><span id="line-217"></span><span id="local-6989586621679323319"><span class="annot"><a href="IC.Ref.html#callerOfRequest"><span class="hs-identifier hs-type">callerOfRequest</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323319"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#RequestID"><span class="hs-identifier hs-type">RequestID</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323319"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="IC.Types.html#EntityId"><span class="hs-identifier hs-type">EntityId</span></a></span></span><span>
</span><span id="line-218"></span><span id="callerOfRequest"><span class="annot"><span class="annottext">callerOfRequest :: Blob -&gt; m EntityId
</span><a href="IC.Ref.html#callerOfRequest"><span class="hs-identifier hs-var hs-var">callerOfRequest</span></a></span></span><span> </span><span id="local-6989586621679322917"><span class="annot"><span class="annottext">rid :: Blob
</span><a href="#local-6989586621679322917"><span class="hs-identifier hs-var">rid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(IC -&gt; Maybe (CallRequest, RequestStatus))
-&gt; m (Maybe (CallRequest, RequestStatus))
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Blob
-&gt; (Blob &#8614; (CallRequest, RequestStatus))
-&gt; Maybe (CallRequest, RequestStatus)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679322917"><span class="hs-identifier hs-var">rid</span></a></span><span> </span><span class="annot"><span class="annottext">((Blob &#8614; (CallRequest, RequestStatus))
 -&gt; Maybe (CallRequest, RequestStatus))
-&gt; (IC -&gt; Blob &#8614; (CallRequest, RequestStatus))
-&gt; IC
-&gt; Maybe (CallRequest, RequestStatus)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">IC -&gt; Blob &#8614; (CallRequest, RequestStatus)
</span><a href="IC.Ref.html#requests"><span class="hs-identifier hs-var hs-var">requests</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">m (Maybe (CallRequest, RequestStatus))
-&gt; (Maybe (CallRequest, RequestStatus) -&gt; m EntityId) -&gt; m EntityId
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-219"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679322914"><span class="annot"><span class="annottext">ar :: CallRequest
</span><a href="#local-6989586621679322914"><span class="hs-identifier hs-var">ar</span></a></span></span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; m EntityId
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CallRequest -&gt; EntityId
</span><a href="IC.Ref.html#callerOfCallRequest"><span class="hs-identifier hs-var">callerOfCallRequest</span></a></span><span> </span><span class="annot"><span class="annottext">CallRequest
</span><a href="#local-6989586621679322914"><span class="hs-identifier hs-var">ar</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-220"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; m EntityId
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="hs-string">&quot;callerOfRequest&quot;</span></span><span>
</span><span id="line-221"></span><span>
</span><span id="line-222"></span><span>
</span><span id="line-223"></span><span class="hs-comment">-- Canister handling</span><span>
</span><span id="line-224"></span><span>
</span><span id="line-225"></span><span id="local-6989586621679323235"><span class="annot"><a href="IC.Ref.html#createEmptyCanister"><span class="hs-identifier hs-type">createEmptyCanister</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323235"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.Set</span></span><span> </span><span class="annot"><a href="IC.Types.html#EntityId"><span class="hs-identifier hs-type">EntityId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#Timestamp"><span class="hs-identifier hs-type">Timestamp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323235"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-226"></span><span id="createEmptyCanister"><span class="annot"><span class="annottext">createEmptyCanister :: EntityId -&gt; Set EntityId -&gt; Timestamp -&gt; m ()
</span><a href="IC.Ref.html#createEmptyCanister"><span class="hs-identifier hs-var hs-var">createEmptyCanister</span></a></span></span><span> </span><span id="local-6989586621679322912"><span class="annot"><span class="annottext">cid :: EntityId
</span><a href="#local-6989586621679322912"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span id="local-6989586621679322911"><span class="annot"><span class="annottext">controllers :: Set EntityId
</span><a href="#local-6989586621679322911"><span class="hs-identifier hs-var">controllers</span></a></span></span><span> </span><span id="local-6989586621679322910"><span class="annot"><span class="annottext">time :: Timestamp
</span><a href="#local-6989586621679322910"><span class="hs-identifier hs-var">time</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(IC -&gt; IC) -&gt; m ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((IC -&gt; IC) -&gt; m ()) -&gt; (IC -&gt; IC) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679322909"><span class="annot"><span class="annottext">ic :: IC
</span><a href="#local-6989586621679322909"><span class="hs-identifier hs-var">ic</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-227"></span><span>    </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679322909"><span class="hs-identifier hs-var">ic</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">canisters :: EntityId &#8614; CanState
</span><a href="IC.Ref.html#canisters"><span class="hs-identifier hs-var">canisters</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EntityId
-&gt; CanState -&gt; (EntityId &#8614; CanState) -&gt; EntityId &#8614; CanState
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322912"><span class="hs-identifier hs-var">cid</span></a></span><span> </span><span class="annot"><span class="annottext">CanState
</span><a href="#local-6989586621679322907"><span class="hs-identifier hs-var">can</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IC -&gt; EntityId &#8614; CanState
</span><a href="IC.Ref.html#canisters"><span class="hs-identifier hs-var hs-var">canisters</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679322909"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-228"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-229"></span><span>    </span><span id="local-6989586621679322907"><span class="annot"><span class="annottext">can :: CanState
</span><a href="#local-6989586621679322907"><span class="hs-identifier hs-var hs-var">can</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CanState :: Maybe CanisterContent
-&gt; RunStatus
-&gt; Set EntityId
-&gt; Natural
-&gt; Natural
-&gt; Natural
-&gt; Timestamp
-&gt; Natural
-&gt; Blob
-&gt; CanState
</span><a href="IC.Ref.html#CanState"><span class="hs-identifier hs-type hs-type">CanState</span></a></span><span>
</span><span id="line-230"></span><span>      </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">content :: Maybe CanisterContent
</span><a href="IC.Ref.html#content"><span class="hs-identifier hs-var">content</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe CanisterContent
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-231"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">run_status :: RunStatus
</span><a href="IC.Ref.html#run_status"><span class="hs-identifier hs-var">run_status</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RunStatus
</span><a href="IC.Ref.html#IsRunning"><span class="hs-identifier hs-var">IsRunning</span></a></span><span>
</span><span id="line-232"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">controllers :: Set EntityId
</span><a href="IC.Ref.html#controllers"><span class="hs-identifier hs-var">controllers</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set EntityId
</span><a href="#local-6989586621679322911"><span class="hs-identifier hs-var">controllers</span></a></span><span>
</span><span id="line-233"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">memory_allocation :: Natural
</span><a href="IC.Ref.html#memory_allocation"><span class="hs-identifier hs-var">memory_allocation</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-number">0</span></span><span>
</span><span id="line-234"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">compute_allocation :: Natural
</span><a href="IC.Ref.html#compute_allocation"><span class="hs-identifier hs-var">compute_allocation</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-number">0</span></span><span>
</span><span id="line-235"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">freezing_threshold :: Natural
</span><a href="IC.Ref.html#freezing_threshold"><span class="hs-identifier hs-var">freezing_threshold</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-number">2592000</span></span><span>
</span><span id="line-236"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">time :: Timestamp
</span><a href="IC.Ref.html#time"><span class="hs-identifier hs-var">time</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Timestamp
</span><a href="#local-6989586621679322910"><span class="hs-identifier hs-var">time</span></a></span><span>
</span><span id="line-237"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cycle_balance :: Natural
</span><a href="IC.Ref.html#cycle_balance"><span class="hs-identifier hs-var">cycle_balance</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-number">0</span></span><span>
</span><span id="line-238"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">certified_data :: Blob
</span><a href="IC.Ref.html#certified_data"><span class="hs-identifier hs-var">certified_data</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-string">&quot;&quot;</span></span><span>
</span><span id="line-239"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-240"></span><span>
</span><span id="line-241"></span><span id="local-6989586621679323400"><span class="annot"><a href="IC.Ref.html#canisterMustExist"><span class="hs-identifier hs-type">canisterMustExist</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Ref.html#CanReject"><span class="hs-identifier hs-type">CanReject</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323400"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323400"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323400"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-242"></span><span id="canisterMustExist"><span class="annot"><span class="annottext">canisterMustExist :: EntityId -&gt; m ()
</span><a href="IC.Ref.html#canisterMustExist"><span class="hs-identifier hs-var hs-var">canisterMustExist</span></a></span></span><span> </span><span id="local-6989586621679322904"><span class="annot"><span class="annottext">cid :: EntityId
</span><a href="#local-6989586621679322904"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-243"></span><span>  </span><span class="annot"><span class="annottext">(IC -&gt; Maybe CanState) -&gt; m (Maybe CanState)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EntityId -&gt; (EntityId &#8614; CanState) -&gt; Maybe CanState
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322904"><span class="hs-identifier hs-var">cid</span></a></span><span> </span><span class="annot"><span class="annottext">((EntityId &#8614; CanState) -&gt; Maybe CanState)
-&gt; (IC -&gt; EntityId &#8614; CanState) -&gt; IC -&gt; Maybe CanState
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">IC -&gt; EntityId &#8614; CanState
</span><a href="IC.Ref.html#canisters"><span class="hs-identifier hs-var hs-var">canisters</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">m (Maybe CanState) -&gt; (Maybe CanState -&gt; m ()) -&gt; m ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-244"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-245"></span><span>      </span><span class="annot"><span class="annottext">RejectCode -&gt; String -&gt; m ()
forall (m :: * -&gt; *) a2.
CanReject m =&gt;
RejectCode -&gt; String -&gt; m a2
</span><a href="IC.Ref.html#reject"><span class="hs-identifier hs-var">reject</span></a></span><span> </span><span class="annot"><span class="annottext">RejectCode
</span><a href="IC.Types.html#RC_DESTINATION_INVALID"><span class="hs-identifier hs-var">RC_DESTINATION_INVALID</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-string">&quot;canister does not exist: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; String
</span><a href="IC.Types.html#prettyID"><span class="hs-identifier hs-var">prettyID</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322904"><span class="hs-identifier hs-var">cid</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-246"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><a href="IC.Ref.html#CanState"><span class="hs-identifier hs-type">CanState</span></a></span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">run_status :: CanState -&gt; RunStatus
</span><a href="IC.Ref.html#run_status"><span class="hs-identifier hs-var">run_status</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RunStatus
</span><a href="IC.Ref.html#IsDeleted"><span class="hs-identifier hs-var">IsDeleted</span></a></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-247"></span><span>      </span><span class="annot"><span class="annottext">RejectCode -&gt; String -&gt; m ()
forall (m :: * -&gt; *) a2.
CanReject m =&gt;
RejectCode -&gt; String -&gt; m a2
</span><a href="IC.Ref.html#reject"><span class="hs-identifier hs-var">reject</span></a></span><span> </span><span class="annot"><span class="annottext">RejectCode
</span><a href="IC.Types.html#RC_DESTINATION_INVALID"><span class="hs-identifier hs-var">RC_DESTINATION_INVALID</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-string">&quot;canister no longer exists: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; String
</span><a href="IC.Types.html#prettyID"><span class="hs-identifier hs-var">prettyID</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322904"><span class="hs-identifier hs-var">cid</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-248"></span><span>    </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-249"></span><span>
</span><span id="line-250"></span><span id="local-6989586621679323399"><span class="annot"><a href="IC.Ref.html#isCanisterEmpty"><span class="hs-identifier hs-type">isCanisterEmpty</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323399"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323399"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span></span><span>
</span><span id="line-251"></span><span id="isCanisterEmpty"><span class="annot"><span class="annottext">isCanisterEmpty :: EntityId -&gt; m Bool
</span><a href="IC.Ref.html#isCanisterEmpty"><span class="hs-identifier hs-var hs-var">isCanisterEmpty</span></a></span></span><span> </span><span id="local-6989586621679322899"><span class="annot"><span class="annottext">cid :: EntityId
</span><a href="#local-6989586621679322899"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe CanisterContent -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isNothing</span></span><span> </span><span class="annot"><span class="annottext">(Maybe CanisterContent -&gt; Bool)
-&gt; (CanState -&gt; Maybe CanisterContent) -&gt; CanState -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">CanState -&gt; Maybe CanisterContent
</span><a href="IC.Ref.html#content"><span class="hs-identifier hs-var hs-var">content</span></a></span><span> </span><span class="annot"><span class="annottext">(CanState -&gt; Bool) -&gt; m CanState -&gt; m Bool
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; m CanState
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; m CanState
</span><a href="IC.Ref.html#getCanister"><span class="hs-identifier hs-var">getCanister</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322899"><span class="hs-identifier hs-var">cid</span></a></span><span>
</span><span id="line-252"></span><span>
</span><span id="line-253"></span><span>
</span><span id="line-254"></span><span class="hs-comment">-- the following functions assume the canister does exist;</span><span>
</span><span id="line-255"></span><span class="hs-comment">-- it would be an internal error if they dont</span><span>
</span><span id="line-256"></span><span>
</span><span id="line-257"></span><span id="local-6989586621679323467"><span class="annot"><a href="IC.Ref.html#getCanister"><span class="hs-identifier hs-type">getCanister</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323467"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323467"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="IC.Ref.html#CanState"><span class="hs-identifier hs-type">CanState</span></a></span></span><span>
</span><span id="line-258"></span><span id="getCanister"><span class="annot"><span class="annottext">getCanister :: EntityId -&gt; m CanState
</span><a href="IC.Ref.html#getCanister"><span class="hs-identifier hs-var hs-var">getCanister</span></a></span></span><span> </span><span id="local-6989586621679322896"><span class="annot"><span class="annottext">cid :: EntityId
</span><a href="#local-6989586621679322896"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-259"></span><span>  </span><span class="annot"><span class="annottext">(IC -&gt; Maybe CanState) -&gt; m (Maybe CanState)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EntityId -&gt; (EntityId &#8614; CanState) -&gt; Maybe CanState
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322896"><span class="hs-identifier hs-var">cid</span></a></span><span> </span><span class="annot"><span class="annottext">((EntityId &#8614; CanState) -&gt; Maybe CanState)
-&gt; (IC -&gt; EntityId &#8614; CanState) -&gt; IC -&gt; Maybe CanState
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">IC -&gt; EntityId &#8614; CanState
</span><a href="IC.Ref.html#canisters"><span class="hs-identifier hs-var hs-var">canisters</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-260"></span><span>    </span><span class="annot"><span class="annottext">m (Maybe CanState) -&gt; m CanState -&gt; m CanState
forall (m :: * -&gt; *) a. Monad m =&gt; m (Maybe a) -&gt; m a -&gt; m a
</span><a href="IC.Ref.html#orElse"><span class="hs-operator hs-var">`orElse`</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; m CanState
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-string">&quot;canister does not exist: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; String
</span><a href="IC.Types.html#prettyID"><span class="hs-identifier hs-var">prettyID</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322896"><span class="hs-identifier hs-var">cid</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-261"></span><span>
</span><span id="line-262"></span><span id="local-6989586621679323458"><span class="annot"><a href="IC.Ref.html#modCanister"><span class="hs-identifier hs-type">modCanister</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323458"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Ref.html#CanState"><span class="hs-identifier hs-type">CanState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Ref.html#CanState"><span class="hs-identifier hs-type">CanState</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323458"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-263"></span><span id="modCanister"><span class="annot"><span class="annottext">modCanister :: EntityId -&gt; (CanState -&gt; CanState) -&gt; m ()
</span><a href="IC.Ref.html#modCanister"><span class="hs-identifier hs-var hs-var">modCanister</span></a></span></span><span> </span><span id="local-6989586621679322893"><span class="annot"><span class="annottext">cid :: EntityId
</span><a href="#local-6989586621679322893"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span id="local-6989586621679322892"><span class="annot"><span class="annottext">f :: CanState -&gt; CanState
</span><a href="#local-6989586621679322892"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-264"></span><span>    </span><span class="annot"><span class="annottext">m CanState -&gt; m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(m CanState -&gt; m ()) -&gt; m CanState -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; m CanState
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; m CanState
</span><a href="IC.Ref.html#getCanister"><span class="hs-identifier hs-var">getCanister</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322893"><span class="hs-identifier hs-var">cid</span></a></span><span>
</span><span id="line-265"></span><span>    </span><span class="annot"><span class="annottext">(IC -&gt; IC) -&gt; m ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((IC -&gt; IC) -&gt; m ()) -&gt; (IC -&gt; IC) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679322890"><span class="annot"><span class="annottext">ic :: IC
</span><a href="#local-6989586621679322890"><span class="hs-identifier hs-var">ic</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679322890"><span class="hs-identifier hs-var">ic</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">canisters :: EntityId &#8614; CanState
</span><a href="IC.Ref.html#canisters"><span class="hs-identifier hs-var">canisters</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CanState -&gt; CanState)
-&gt; EntityId -&gt; (EntityId &#8614; CanState) -&gt; EntityId &#8614; CanState
forall k a. Ord k =&gt; (a -&gt; a) -&gt; k -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.adjust</span></span><span> </span><span class="annot"><span class="annottext">CanState -&gt; CanState
</span><a href="#local-6989586621679322892"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322893"><span class="hs-identifier hs-var">cid</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IC -&gt; EntityId &#8614; CanState
</span><a href="IC.Ref.html#canisters"><span class="hs-identifier hs-var hs-var">canisters</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679322890"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-266"></span><span>
</span><span id="line-267"></span><span id="local-6989586621679323212"><span class="annot"><a href="IC.Ref.html#setCanisterContent"><span class="hs-identifier hs-type">setCanisterContent</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323212"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Ref.html#CanisterContent"><span class="hs-identifier hs-type">CanisterContent</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323212"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-268"></span><span id="setCanisterContent"><span class="annot"><span class="annottext">setCanisterContent :: EntityId -&gt; CanisterContent -&gt; m ()
</span><a href="IC.Ref.html#setCanisterContent"><span class="hs-identifier hs-var hs-var">setCanisterContent</span></a></span></span><span> </span><span id="local-6989586621679322888"><span class="annot"><span class="annottext">cid :: EntityId
</span><a href="#local-6989586621679322888"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span id="local-6989586621679322887"><span class="annot"><span class="annottext">content :: CanisterContent
</span><a href="#local-6989586621679322887"><span class="hs-identifier hs-var">content</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; (CanState -&gt; CanState) -&gt; m ()
forall (m :: * -&gt; *).
ICM m =&gt;
EntityId -&gt; (CanState -&gt; CanState) -&gt; m ()
</span><a href="IC.Ref.html#modCanister"><span class="hs-identifier hs-var">modCanister</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322888"><span class="hs-identifier hs-var">cid</span></a></span><span> </span><span class="annot"><span class="annottext">((CanState -&gt; CanState) -&gt; m ()) -&gt; (CanState -&gt; CanState) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-269"></span><span>    </span><span class="hs-glyph">\</span><span id="local-6989586621679322886"><span class="annot"><span class="annottext">cs :: CanState
</span><a href="#local-6989586621679322886"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CanState
</span><a href="#local-6989586621679322886"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">content :: Maybe CanisterContent
</span><a href="IC.Ref.html#content"><span class="hs-identifier hs-var">content</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CanisterContent -&gt; Maybe CanisterContent
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">CanisterContent
</span><a href="#local-6989586621679322887"><span class="hs-identifier hs-var">content</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-270"></span><span>
</span><span id="line-271"></span><span id="local-6989586621679323454"><span class="annot"><a href="IC.Ref.html#modCanisterContent"><span class="hs-identifier hs-type">modCanisterContent</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323454"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Ref.html#CanisterContent"><span class="hs-identifier hs-type">CanisterContent</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Ref.html#CanisterContent"><span class="hs-identifier hs-type">CanisterContent</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323454"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-272"></span><span id="modCanisterContent"><span class="annot"><span class="annottext">modCanisterContent :: EntityId -&gt; (CanisterContent -&gt; CanisterContent) -&gt; m ()
</span><a href="IC.Ref.html#modCanisterContent"><span class="hs-identifier hs-var hs-var">modCanisterContent</span></a></span></span><span> </span><span id="local-6989586621679322884"><span class="annot"><span class="annottext">cid :: EntityId
</span><a href="#local-6989586621679322884"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span id="local-6989586621679322883"><span class="annot"><span class="annottext">f :: CanisterContent -&gt; CanisterContent
</span><a href="#local-6989586621679322883"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-273"></span><span>    </span><span class="annot"><span class="annottext">EntityId -&gt; (CanState -&gt; CanState) -&gt; m ()
forall (m :: * -&gt; *).
ICM m =&gt;
EntityId -&gt; (CanState -&gt; CanState) -&gt; m ()
</span><a href="IC.Ref.html#modCanister"><span class="hs-identifier hs-var">modCanister</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322884"><span class="hs-identifier hs-var">cid</span></a></span><span> </span><span class="annot"><span class="annottext">((CanState -&gt; CanState) -&gt; m ()) -&gt; (CanState -&gt; CanState) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679322882"><span class="annot"><span class="annottext">c :: CanState
</span><a href="#local-6989586621679322882"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CanState
</span><a href="#local-6989586621679322882"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">content :: Maybe CanisterContent
</span><a href="IC.Ref.html#content"><span class="hs-identifier hs-var">content</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CanisterContent -&gt; Maybe CanisterContent
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CanisterContent -&gt; CanisterContent
</span><a href="#local-6989586621679322883"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CanisterContent -&gt; Maybe CanisterContent -&gt; CanisterContent
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">CanisterContent
</span><a href="#local-6989586621679322880"><span class="hs-identifier hs-var">err</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CanState -&gt; Maybe CanisterContent
</span><a href="IC.Ref.html#content"><span class="hs-identifier hs-var hs-var">content</span></a></span><span> </span><span class="annot"><span class="annottext">CanState
</span><a href="#local-6989586621679322882"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-274"></span><span>  </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621679322880"><span class="annot"><span class="annottext">err :: CanisterContent
</span><a href="#local-6989586621679322880"><span class="hs-identifier hs-var hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; CanisterContent
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-string">&quot;canister is empty: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; String
</span><a href="IC.Types.html#prettyID"><span class="hs-identifier hs-var">prettyID</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322884"><span class="hs-identifier hs-var">cid</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-275"></span><span>
</span><span id="line-276"></span><span id="local-6989586621679323297"><span class="annot"><a href="IC.Ref.html#setCanisterState"><span class="hs-identifier hs-type">setCanisterState</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323297"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Canister.html#WasmState"><span class="hs-identifier hs-type">WasmState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323297"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-277"></span><span id="setCanisterState"><span class="annot"><span class="annottext">setCanisterState :: EntityId -&gt; WasmState -&gt; m ()
</span><a href="IC.Ref.html#setCanisterState"><span class="hs-identifier hs-var hs-var">setCanisterState</span></a></span></span><span> </span><span id="local-6989586621679322878"><span class="annot"><span class="annottext">cid :: EntityId
</span><a href="#local-6989586621679322878"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span id="local-6989586621679322877"><span class="annot"><span class="annottext">wasm_state :: WasmState
</span><a href="#local-6989586621679322877"><span class="hs-identifier hs-var">wasm_state</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; (CanisterContent -&gt; CanisterContent) -&gt; m ()
forall (m :: * -&gt; *).
ICM m =&gt;
EntityId -&gt; (CanisterContent -&gt; CanisterContent) -&gt; m ()
</span><a href="IC.Ref.html#modCanisterContent"><span class="hs-identifier hs-var">modCanisterContent</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322878"><span class="hs-identifier hs-var">cid</span></a></span><span> </span><span class="annot"><span class="annottext">((CanisterContent -&gt; CanisterContent) -&gt; m ())
-&gt; (CanisterContent -&gt; CanisterContent) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-278"></span><span>    </span><span class="hs-glyph">\</span><span id="local-6989586621679322876"><span class="annot"><span class="annottext">cs :: CanisterContent
</span><a href="#local-6989586621679322876"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CanisterContent
</span><a href="#local-6989586621679322876"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">wasm_state :: WasmState
</span><a href="IC.Ref.html#wasm_state"><span class="hs-identifier hs-var">wasm_state</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679322877"><span class="hs-identifier hs-var">wasm_state</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-279"></span><span>
</span><span id="line-280"></span><span id="local-6989586621679323368"><span class="annot"><a href="IC.Ref.html#getControllers"><span class="hs-identifier hs-type">getControllers</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323368"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323368"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">S.Set</span></span><span> </span><span class="annot"><a href="IC.Types.html#EntityId"><span class="hs-identifier hs-type">EntityId</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-281"></span><span id="getControllers"><span class="annot"><span class="annottext">getControllers :: EntityId -&gt; m (Set EntityId)
</span><a href="IC.Ref.html#getControllers"><span class="hs-identifier hs-var hs-var">getControllers</span></a></span></span><span> </span><span id="local-6989586621679322874"><span class="annot"><span class="annottext">cid :: EntityId
</span><a href="#local-6989586621679322874"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CanState -&gt; Set EntityId
</span><a href="IC.Ref.html#controllers"><span class="hs-identifier hs-var hs-var">controllers</span></a></span><span> </span><span class="annot"><span class="annottext">(CanState -&gt; Set EntityId) -&gt; m CanState -&gt; m (Set EntityId)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; m CanState
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; m CanState
</span><a href="IC.Ref.html#getCanister"><span class="hs-identifier hs-var">getCanister</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322874"><span class="hs-identifier hs-var">cid</span></a></span><span>
</span><span id="line-282"></span><span>
</span><span id="line-283"></span><span id="local-6989586621679323228"><span class="annot"><a href="IC.Ref.html#setControllers"><span class="hs-identifier hs-type">setControllers</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323228"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">S.Set</span></span><span> </span><span class="annot"><a href="IC.Types.html#EntityId"><span class="hs-identifier hs-type">EntityId</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323228"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-284"></span><span id="setControllers"><span class="annot"><span class="annottext">setControllers :: EntityId -&gt; Set EntityId -&gt; m ()
</span><a href="IC.Ref.html#setControllers"><span class="hs-identifier hs-var hs-var">setControllers</span></a></span></span><span> </span><span id="local-6989586621679322872"><span class="annot"><span class="annottext">cid :: EntityId
</span><a href="#local-6989586621679322872"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span id="local-6989586621679322871"><span class="annot"><span class="annottext">controllers :: Set EntityId
</span><a href="#local-6989586621679322871"><span class="hs-identifier hs-var">controllers</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; (CanState -&gt; CanState) -&gt; m ()
forall (m :: * -&gt; *).
ICM m =&gt;
EntityId -&gt; (CanState -&gt; CanState) -&gt; m ()
</span><a href="IC.Ref.html#modCanister"><span class="hs-identifier hs-var">modCanister</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322872"><span class="hs-identifier hs-var">cid</span></a></span><span> </span><span class="annot"><span class="annottext">((CanState -&gt; CanState) -&gt; m ()) -&gt; (CanState -&gt; CanState) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-285"></span><span>    </span><span class="hs-glyph">\</span><span id="local-6989586621679322870"><span class="annot"><span class="annottext">cs :: CanState
</span><a href="#local-6989586621679322870"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CanState
</span><a href="#local-6989586621679322870"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">controllers :: Set EntityId
</span><a href="IC.Ref.html#controllers"><span class="hs-identifier hs-var">controllers</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set EntityId
</span><a href="#local-6989586621679322871"><span class="hs-identifier hs-var">controllers</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-286"></span><span>
</span><span id="line-287"></span><span id="local-6989586621679322869"><span class="annot"><a href="IC.Ref.html#setComputeAllocation"><span class="hs-identifier hs-type">setComputeAllocation</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679322869"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Natural</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679322869"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-288"></span><span id="setComputeAllocation"><span class="annot"><span class="annottext">setComputeAllocation :: EntityId -&gt; Natural -&gt; m ()
</span><a href="IC.Ref.html#setComputeAllocation"><span class="hs-identifier hs-var hs-var">setComputeAllocation</span></a></span></span><span> </span><span id="local-6989586621679322867"><span class="annot"><span class="annottext">cid :: EntityId
</span><a href="#local-6989586621679322867"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span id="local-6989586621679322866"><span class="annot"><span class="annottext">n :: Natural
</span><a href="#local-6989586621679322866"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; (CanState -&gt; CanState) -&gt; m ()
forall (m :: * -&gt; *).
ICM m =&gt;
EntityId -&gt; (CanState -&gt; CanState) -&gt; m ()
</span><a href="IC.Ref.html#modCanister"><span class="hs-identifier hs-var">modCanister</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322867"><span class="hs-identifier hs-var">cid</span></a></span><span> </span><span class="annot"><span class="annottext">((CanState -&gt; CanState) -&gt; m ()) -&gt; (CanState -&gt; CanState) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-289"></span><span>    </span><span class="hs-glyph">\</span><span id="local-6989586621679322865"><span class="annot"><span class="annottext">cs :: CanState
</span><a href="#local-6989586621679322865"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CanState
</span><a href="#local-6989586621679322865"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">compute_allocation :: Natural
</span><a href="IC.Ref.html#compute_allocation"><span class="hs-identifier hs-var">compute_allocation</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679322866"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-290"></span><span>
</span><span id="line-291"></span><span id="local-6989586621679322864"><span class="annot"><a href="IC.Ref.html#setMemoryAllocation"><span class="hs-identifier hs-type">setMemoryAllocation</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679322864"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Natural</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679322864"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-292"></span><span id="setMemoryAllocation"><span class="annot"><span class="annottext">setMemoryAllocation :: EntityId -&gt; Natural -&gt; m ()
</span><a href="IC.Ref.html#setMemoryAllocation"><span class="hs-identifier hs-var hs-var">setMemoryAllocation</span></a></span></span><span> </span><span id="local-6989586621679322862"><span class="annot"><span class="annottext">cid :: EntityId
</span><a href="#local-6989586621679322862"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span id="local-6989586621679322861"><span class="annot"><span class="annottext">n :: Natural
</span><a href="#local-6989586621679322861"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; (CanState -&gt; CanState) -&gt; m ()
forall (m :: * -&gt; *).
ICM m =&gt;
EntityId -&gt; (CanState -&gt; CanState) -&gt; m ()
</span><a href="IC.Ref.html#modCanister"><span class="hs-identifier hs-var">modCanister</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322862"><span class="hs-identifier hs-var">cid</span></a></span><span> </span><span class="annot"><span class="annottext">((CanState -&gt; CanState) -&gt; m ()) -&gt; (CanState -&gt; CanState) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-293"></span><span>    </span><span class="hs-glyph">\</span><span id="local-6989586621679322860"><span class="annot"><span class="annottext">cs :: CanState
</span><a href="#local-6989586621679322860"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CanState
</span><a href="#local-6989586621679322860"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">memory_allocation :: Natural
</span><a href="IC.Ref.html#memory_allocation"><span class="hs-identifier hs-var">memory_allocation</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679322861"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-294"></span><span>
</span><span id="line-295"></span><span id="local-6989586621679322859"><span class="annot"><a href="IC.Ref.html#setFreezingThreshold"><span class="hs-identifier hs-type">setFreezingThreshold</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679322859"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Natural</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679322859"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-296"></span><span id="setFreezingThreshold"><span class="annot"><span class="annottext">setFreezingThreshold :: EntityId -&gt; Natural -&gt; m ()
</span><a href="IC.Ref.html#setFreezingThreshold"><span class="hs-identifier hs-var hs-var">setFreezingThreshold</span></a></span></span><span> </span><span id="local-6989586621679322857"><span class="annot"><span class="annottext">cid :: EntityId
</span><a href="#local-6989586621679322857"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span id="local-6989586621679322856"><span class="annot"><span class="annottext">n :: Natural
</span><a href="#local-6989586621679322856"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; (CanState -&gt; CanState) -&gt; m ()
forall (m :: * -&gt; *).
ICM m =&gt;
EntityId -&gt; (CanState -&gt; CanState) -&gt; m ()
</span><a href="IC.Ref.html#modCanister"><span class="hs-identifier hs-var">modCanister</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322857"><span class="hs-identifier hs-var">cid</span></a></span><span> </span><span class="annot"><span class="annottext">((CanState -&gt; CanState) -&gt; m ()) -&gt; (CanState -&gt; CanState) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-297"></span><span>    </span><span class="hs-glyph">\</span><span id="local-6989586621679322855"><span class="annot"><span class="annottext">cs :: CanState
</span><a href="#local-6989586621679322855"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CanState
</span><a href="#local-6989586621679322855"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">freezing_threshold :: Natural
</span><a href="IC.Ref.html#freezing_threshold"><span class="hs-identifier hs-var">freezing_threshold</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679322856"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-298"></span><span>
</span><span id="line-299"></span><span id="local-6989586621679323411"><span class="annot"><a href="IC.Ref.html#getBalance"><span class="hs-identifier hs-type">getBalance</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323411"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323411"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Natural</span></span></span><span>
</span><span id="line-300"></span><span id="getBalance"><span class="annot"><span class="annottext">getBalance :: EntityId -&gt; m Natural
</span><a href="IC.Ref.html#getBalance"><span class="hs-identifier hs-var hs-var">getBalance</span></a></span></span><span> </span><span id="local-6989586621679322853"><span class="annot"><span class="annottext">cid :: EntityId
</span><a href="#local-6989586621679322853"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CanState -&gt; Natural
</span><a href="IC.Ref.html#cycle_balance"><span class="hs-identifier hs-var hs-var">cycle_balance</span></a></span><span> </span><span class="annot"><span class="annottext">(CanState -&gt; Natural) -&gt; m CanState -&gt; m Natural
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; m CanState
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; m CanState
</span><a href="IC.Ref.html#getCanister"><span class="hs-identifier hs-var">getCanister</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322853"><span class="hs-identifier hs-var">cid</span></a></span><span>
</span><span id="line-301"></span><span>
</span><span id="line-302"></span><span id="local-6989586621679323296"><span class="annot"><a href="IC.Ref.html#setBalance"><span class="hs-identifier hs-type">setBalance</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323296"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Natural</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323296"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-303"></span><span id="setBalance"><span class="annot"><span class="annottext">setBalance :: EntityId -&gt; Natural -&gt; m ()
</span><a href="IC.Ref.html#setBalance"><span class="hs-identifier hs-var hs-var">setBalance</span></a></span></span><span> </span><span id="local-6989586621679322851"><span class="annot"><span class="annottext">cid :: EntityId
</span><a href="#local-6989586621679322851"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span id="local-6989586621679322850"><span class="annot"><span class="annottext">balance :: Natural
</span><a href="#local-6989586621679322850"><span class="hs-identifier hs-var">balance</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; (CanState -&gt; CanState) -&gt; m ()
forall (m :: * -&gt; *).
ICM m =&gt;
EntityId -&gt; (CanState -&gt; CanState) -&gt; m ()
</span><a href="IC.Ref.html#modCanister"><span class="hs-identifier hs-var">modCanister</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322851"><span class="hs-identifier hs-var">cid</span></a></span><span> </span><span class="annot"><span class="annottext">((CanState -&gt; CanState) -&gt; m ()) -&gt; (CanState -&gt; CanState) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-304"></span><span>    </span><span class="hs-glyph">\</span><span id="local-6989586621679322849"><span class="annot"><span class="annottext">cs :: CanState
</span><a href="#local-6989586621679322849"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CanState
</span><a href="#local-6989586621679322849"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cycle_balance :: Natural
</span><a href="IC.Ref.html#cycle_balance"><span class="hs-identifier hs-var">cycle_balance</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Natural -&gt; Natural -&gt; Natural
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">min</span></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="IC.Constants.html#cMAX_CANISTER_BALANCE"><span class="hs-identifier hs-var">cMAX_CANISTER_BALANCE</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679322850"><span class="hs-identifier hs-var">balance</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-305"></span><span>
</span><span id="line-306"></span><span id="local-6989586621679323284"><span class="annot"><a href="IC.Ref.html#setCertifiedData"><span class="hs-identifier hs-type">setCertifiedData</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323284"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323284"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-307"></span><span id="setCertifiedData"><span class="annot"><span class="annottext">setCertifiedData :: EntityId -&gt; Blob -&gt; m ()
</span><a href="IC.Ref.html#setCertifiedData"><span class="hs-identifier hs-var hs-var">setCertifiedData</span></a></span></span><span> </span><span id="local-6989586621679322845"><span class="annot"><span class="annottext">cid :: EntityId
</span><a href="#local-6989586621679322845"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span id="local-6989586621679322844"><span class="annot"><span class="annottext">b :: Blob
</span><a href="#local-6989586621679322844"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; (CanState -&gt; CanState) -&gt; m ()
forall (m :: * -&gt; *).
ICM m =&gt;
EntityId -&gt; (CanState -&gt; CanState) -&gt; m ()
</span><a href="IC.Ref.html#modCanister"><span class="hs-identifier hs-var">modCanister</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322845"><span class="hs-identifier hs-var">cid</span></a></span><span> </span><span class="annot"><span class="annottext">((CanState -&gt; CanState) -&gt; m ()) -&gt; (CanState -&gt; CanState) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-308"></span><span>    </span><span class="hs-glyph">\</span><span id="local-6989586621679322843"><span class="annot"><span class="annottext">cs :: CanState
</span><a href="#local-6989586621679322843"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CanState
</span><a href="#local-6989586621679322843"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">certified_data :: Blob
</span><a href="IC.Ref.html#certified_data"><span class="hs-identifier hs-var">certified_data</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679322844"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-309"></span><span>
</span><span id="line-310"></span><span id="local-6989586621679323409"><span class="annot"><a href="IC.Ref.html#getRunStatus"><span class="hs-identifier hs-type">getRunStatus</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323409"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323409"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="IC.Ref.html#RunStatus"><span class="hs-identifier hs-type">RunStatus</span></a></span></span><span>
</span><span id="line-311"></span><span id="getRunStatus"><span class="annot"><span class="annottext">getRunStatus :: EntityId -&gt; m RunStatus
</span><a href="IC.Ref.html#getRunStatus"><span class="hs-identifier hs-var hs-var">getRunStatus</span></a></span></span><span> </span><span id="local-6989586621679322841"><span class="annot"><span class="annottext">cid :: EntityId
</span><a href="#local-6989586621679322841"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CanState -&gt; RunStatus
</span><a href="IC.Ref.html#run_status"><span class="hs-identifier hs-var hs-var">run_status</span></a></span><span> </span><span class="annot"><span class="annottext">(CanState -&gt; RunStatus) -&gt; m CanState -&gt; m RunStatus
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; m CanState
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; m CanState
</span><a href="IC.Ref.html#getCanister"><span class="hs-identifier hs-var">getCanister</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322841"><span class="hs-identifier hs-var">cid</span></a></span><span>
</span><span id="line-312"></span><span>
</span><span id="line-313"></span><span id="local-6989586621679323197"><span class="annot"><a href="IC.Ref.html#setRunStatus"><span class="hs-identifier hs-type">setRunStatus</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323197"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Ref.html#RunStatus"><span class="hs-identifier hs-type">RunStatus</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323197"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-314"></span><span id="setRunStatus"><span class="annot"><span class="annottext">setRunStatus :: EntityId -&gt; RunStatus -&gt; m ()
</span><a href="IC.Ref.html#setRunStatus"><span class="hs-identifier hs-var hs-var">setRunStatus</span></a></span></span><span> </span><span id="local-6989586621679322839"><span class="annot"><span class="annottext">cid :: EntityId
</span><a href="#local-6989586621679322839"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span id="local-6989586621679322838"><span class="annot"><span class="annottext">run_status :: RunStatus
</span><a href="#local-6989586621679322838"><span class="hs-identifier hs-var">run_status</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; (CanState -&gt; CanState) -&gt; m ()
forall (m :: * -&gt; *).
ICM m =&gt;
EntityId -&gt; (CanState -&gt; CanState) -&gt; m ()
</span><a href="IC.Ref.html#modCanister"><span class="hs-identifier hs-var">modCanister</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322839"><span class="hs-identifier hs-var">cid</span></a></span><span> </span><span class="annot"><span class="annottext">((CanState -&gt; CanState) -&gt; m ()) -&gt; (CanState -&gt; CanState) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-315"></span><span>    </span><span class="hs-glyph">\</span><span id="local-6989586621679322837"><span class="annot"><span class="annottext">cs :: CanState
</span><a href="#local-6989586621679322837"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CanState
</span><a href="#local-6989586621679322837"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">run_status :: RunStatus
</span><a href="IC.Ref.html#run_status"><span class="hs-identifier hs-var">run_status</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RunStatus
</span><a href="#local-6989586621679322838"><span class="hs-identifier hs-var">run_status</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-316"></span><span>
</span><span id="line-317"></span><span id="local-6989586621679323398"><span class="annot"><a href="IC.Ref.html#getCanisterState"><span class="hs-identifier hs-type">getCanisterState</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323398"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323398"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="IC.Canister.html#WasmState"><span class="hs-identifier hs-type">WasmState</span></a></span></span><span>
</span><span id="line-318"></span><span id="getCanisterState"><span class="annot"><span class="annottext">getCanisterState :: EntityId -&gt; m WasmState
</span><a href="IC.Ref.html#getCanisterState"><span class="hs-identifier hs-var hs-var">getCanisterState</span></a></span></span><span> </span><span id="local-6989586621679322835"><span class="annot"><span class="annottext">cid :: EntityId
</span><a href="#local-6989586621679322835"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CanisterContent -&gt; WasmState
</span><a href="IC.Ref.html#wasm_state"><span class="hs-identifier hs-var hs-var">wasm_state</span></a></span><span> </span><span class="annot"><span class="annottext">(CanisterContent -&gt; WasmState)
-&gt; (CanState -&gt; CanisterContent) -&gt; CanState -&gt; WasmState
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Maybe CanisterContent -&gt; CanisterContent
forall a. HasCallStack =&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromJust</span></span><span> </span><span class="annot"><span class="annottext">(Maybe CanisterContent -&gt; CanisterContent)
-&gt; (CanState -&gt; Maybe CanisterContent)
-&gt; CanState
-&gt; CanisterContent
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">CanState -&gt; Maybe CanisterContent
</span><a href="IC.Ref.html#content"><span class="hs-identifier hs-var hs-var">content</span></a></span><span> </span><span class="annot"><span class="annottext">(CanState -&gt; WasmState) -&gt; m CanState -&gt; m WasmState
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; m CanState
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; m CanState
</span><a href="IC.Ref.html#getCanister"><span class="hs-identifier hs-var">getCanister</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322835"><span class="hs-identifier hs-var">cid</span></a></span><span>
</span><span id="line-319"></span><span>
</span><span id="line-320"></span><span id="local-6989586621679323397"><span class="annot"><a href="IC.Ref.html#getCanisterMod"><span class="hs-identifier hs-type">getCanisterMod</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323397"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323397"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="IC.Canister.html#CanisterModule"><span class="hs-identifier hs-type">CanisterModule</span></a></span></span><span>
</span><span id="line-321"></span><span id="getCanisterMod"><span class="annot"><span class="annottext">getCanisterMod :: EntityId -&gt; m CanisterModule
</span><a href="IC.Ref.html#getCanisterMod"><span class="hs-identifier hs-var hs-var">getCanisterMod</span></a></span></span><span> </span><span id="local-6989586621679322832"><span class="annot"><span class="annottext">cid :: EntityId
</span><a href="#local-6989586621679322832"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CanisterContent -&gt; CanisterModule
</span><a href="IC.Ref.html#can_mod"><span class="hs-identifier hs-var hs-var">can_mod</span></a></span><span> </span><span class="annot"><span class="annottext">(CanisterContent -&gt; CanisterModule)
-&gt; (CanState -&gt; CanisterContent) -&gt; CanState -&gt; CanisterModule
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Maybe CanisterContent -&gt; CanisterContent
forall a. HasCallStack =&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromJust</span></span><span> </span><span class="annot"><span class="annottext">(Maybe CanisterContent -&gt; CanisterContent)
-&gt; (CanState -&gt; Maybe CanisterContent)
-&gt; CanState
-&gt; CanisterContent
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">CanState -&gt; Maybe CanisterContent
</span><a href="IC.Ref.html#content"><span class="hs-identifier hs-var hs-var">content</span></a></span><span> </span><span class="annot"><span class="annottext">(CanState -&gt; CanisterModule) -&gt; m CanState -&gt; m CanisterModule
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; m CanState
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; m CanState
</span><a href="IC.Ref.html#getCanister"><span class="hs-identifier hs-var">getCanister</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322832"><span class="hs-identifier hs-var">cid</span></a></span><span>
</span><span id="line-322"></span><span>
</span><span id="line-323"></span><span id="local-6989586621679323412"><span class="annot"><a href="IC.Ref.html#getCanisterTime"><span class="hs-identifier hs-type">getCanisterTime</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323412"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323412"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="IC.Types.html#Timestamp"><span class="hs-identifier hs-type">Timestamp</span></a></span></span><span>
</span><span id="line-324"></span><span id="getCanisterTime"><span class="annot"><span class="annottext">getCanisterTime :: EntityId -&gt; m Timestamp
</span><a href="IC.Ref.html#getCanisterTime"><span class="hs-identifier hs-var hs-var">getCanisterTime</span></a></span></span><span> </span><span id="local-6989586621679322830"><span class="annot"><span class="annottext">cid :: EntityId
</span><a href="#local-6989586621679322830"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CanState -&gt; Timestamp
</span><a href="IC.Ref.html#time"><span class="hs-identifier hs-var hs-var">time</span></a></span><span> </span><span class="annot"><span class="annottext">(CanState -&gt; Timestamp) -&gt; m CanState -&gt; m Timestamp
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; m CanState
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; m CanState
</span><a href="IC.Ref.html#getCanister"><span class="hs-identifier hs-var">getCanister</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322830"><span class="hs-identifier hs-var">cid</span></a></span><span>
</span><span id="line-325"></span><span>
</span><span id="line-326"></span><span>
</span><span id="line-327"></span><span class="annot"><a href="IC.Ref.html#module_hash"><span class="hs-identifier hs-type">module_hash</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#CanState"><span class="hs-identifier hs-type">CanState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="IC.Types.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span>
</span><span id="line-328"></span><span id="module_hash"><span class="annot"><span class="annottext">module_hash :: CanState -&gt; Maybe Blob
</span><a href="IC.Ref.html#module_hash"><span class="hs-identifier hs-var hs-var">module_hash</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CanisterContent -&gt; Blob) -&gt; Maybe CanisterContent -&gt; Maybe Blob
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CanisterModule -&gt; Blob
</span><a href="IC.Canister.html#raw_wasm_hash"><span class="hs-identifier hs-var hs-var">raw_wasm_hash</span></a></span><span> </span><span class="annot"><span class="annottext">(CanisterModule -&gt; Blob)
-&gt; (CanisterContent -&gt; CanisterModule) -&gt; CanisterContent -&gt; Blob
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">CanisterContent -&gt; CanisterModule
</span><a href="IC.Ref.html#can_mod"><span class="hs-identifier hs-var hs-var">can_mod</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Maybe CanisterContent -&gt; Maybe Blob)
-&gt; (CanState -&gt; Maybe CanisterContent) -&gt; CanState -&gt; Maybe Blob
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">CanState -&gt; Maybe CanisterContent
</span><a href="IC.Ref.html#content"><span class="hs-identifier hs-var hs-var">content</span></a></span><span>
</span><span id="line-329"></span><span>
</span><span id="line-330"></span><span class="hs-comment">-- Authentication and authorization of requests</span><span>
</span><span id="line-331"></span><span class="hs-comment">--</span><span>
</span><span id="line-332"></span><span class="hs-comment">-- The envelope has already been validated. So this includes</span><span>
</span><span id="line-333"></span><span class="hs-comment">--  * Comparing the envelope validity with the contents</span><span>
</span><span id="line-334"></span><span class="hs-comment">--  * Authorization of the sender</span><span>
</span><span id="line-335"></span><span class="hs-comment">--  * ingress message inspection</span><span>
</span><span id="line-336"></span><span class="hs-comment">--  * checking the correct effective id</span><span>
</span><span id="line-337"></span><span>
</span><span id="line-338"></span><span class="hs-keyword">type</span><span> </span><span id="RequestValidation"><span class="annot"><a href="IC.Ref.html#RequestValidation"><span class="hs-identifier hs-var">RequestValidation</span></a></span></span><span> </span><span id="local-6989586621679322827"><span class="annot"><a href="#local-6989586621679322827"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">T.Text</span></span><span> </span><span class="annot"><a href="#local-6989586621679322827"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679322827"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-339"></span><span>
</span><span id="line-340"></span><span id="local-6989586621679322826"><span class="annot"><a href="IC.Ref.html#authCallRequest"><span class="hs-identifier hs-type">authCallRequest</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#RequestValidation"><span class="hs-identifier hs-type">RequestValidation</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679322826"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#Timestamp"><span class="hs-identifier hs-type">Timestamp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#EnvValidity"><span class="hs-identifier hs-type">EnvValidity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Ref.html#CallRequest"><span class="hs-identifier hs-type">CallRequest</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679322826"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-341"></span><span id="authCallRequest"><span class="annot"><span class="annottext">authCallRequest :: Timestamp -&gt; EntityId -&gt; EnvValidity -&gt; CallRequest -&gt; m ()
</span><a href="IC.Ref.html#authCallRequest"><span class="hs-identifier hs-var hs-var">authCallRequest</span></a></span></span><span> </span><span id="local-6989586621679322825"><span class="annot"><span class="annottext">t :: Timestamp
</span><a href="#local-6989586621679322825"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621679322824"><span class="annot"><span class="annottext">ecid :: EntityId
</span><a href="#local-6989586621679322824"><span class="hs-identifier hs-var">ecid</span></a></span></span><span> </span><span id="local-6989586621679322823"><span class="annot"><span class="annottext">ev :: EnvValidity
</span><a href="#local-6989586621679322823"><span class="hs-identifier hs-var">ev</span></a></span></span><span> </span><span id="local-6989586621679322822"><span class="annot"><span class="annottext">r :: CallRequest
</span><a href="#local-6989586621679322822"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="IC.Ref.html#CallRequest"><span class="hs-identifier hs-type">CallRequest</span></a></span><span> </span><span id="local-6989586621679322821"><span class="annot"><span class="annottext">canister_id :: EntityId
</span><a href="#local-6989586621679322821"><span class="hs-identifier hs-var">canister_id</span></a></span></span><span> </span><span id="local-6989586621679322820"><span class="annot"><span class="annottext">user_id :: EntityId
</span><a href="#local-6989586621679322820"><span class="hs-identifier hs-var">user_id</span></a></span></span><span> </span><span id="local-6989586621679322819"><span class="annot"><span class="annottext">meth :: String
</span><a href="#local-6989586621679322819"><span class="hs-identifier hs-var">meth</span></a></span></span><span> </span><span id="local-6989586621679322818"><span class="annot"><span class="annottext">arg :: Blob
</span><a href="#local-6989586621679322818"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-342"></span><span>    </span><span class="annot"><span class="annottext">EntityId -&gt; EntityId -&gt; String -&gt; Blob -&gt; m ()
forall (m :: * -&gt; *).
RequestValidation m =&gt;
EntityId -&gt; EntityId -&gt; String -&gt; Blob -&gt; m ()
</span><a href="IC.Ref.html#checkEffectiveCanisterID"><span class="hs-identifier hs-var">checkEffectiveCanisterID</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322824"><span class="hs-identifier hs-var">ecid</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322821"><span class="hs-identifier hs-var">canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679322819"><span class="hs-identifier hs-var">meth</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679322818"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-343"></span><span>    </span><span class="annot"><span class="annottext">EnvValidity -&gt; Timestamp -&gt; m ()
EnvValidity
-&gt; forall (m :: * -&gt; *). MonadError Text m =&gt; Timestamp -&gt; m ()
</span><a href="IC.Types.html#valid_when"><span class="hs-identifier hs-var hs-var">valid_when</span></a></span><span> </span><span class="annot"><span class="annottext">EnvValidity
</span><a href="#local-6989586621679322823"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">Timestamp
</span><a href="#local-6989586621679322825"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-344"></span><span>    </span><span class="annot"><span class="annottext">EnvValidity -&gt; EntityId -&gt; m ()
EnvValidity
-&gt; forall (m :: * -&gt; *). MonadError Text m =&gt; EntityId -&gt; m ()
</span><a href="IC.Types.html#valid_for"><span class="hs-identifier hs-var hs-var">valid_for</span></a></span><span> </span><span class="annot"><span class="annottext">EnvValidity
</span><a href="#local-6989586621679322823"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322820"><span class="hs-identifier hs-var">user_id</span></a></span><span>
</span><span id="line-345"></span><span>    </span><span class="annot"><span class="annottext">EnvValidity -&gt; EntityId -&gt; m ()
EnvValidity
-&gt; forall (m :: * -&gt; *). MonadError Text m =&gt; EntityId -&gt; m ()
</span><a href="IC.Types.html#valid_where"><span class="hs-identifier hs-var hs-var">valid_where</span></a></span><span> </span><span class="annot"><span class="annottext">EnvValidity
</span><a href="#local-6989586621679322823"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322821"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-346"></span><span>    </span><span class="annot"><span class="annottext">CallRequest -&gt; m ()
forall (m :: * -&gt; *). RequestValidation m =&gt; CallRequest -&gt; m ()
</span><a href="IC.Ref.html#inspectIngress"><span class="hs-identifier hs-var">inspectIngress</span></a></span><span> </span><span class="annot"><span class="annottext">CallRequest
</span><a href="#local-6989586621679322822"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-347"></span><span>
</span><span id="line-348"></span><span id="local-6989586621679322812"><span class="annot"><a href="IC.Ref.html#authQueryRequest"><span class="hs-identifier hs-type">authQueryRequest</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#RequestValidation"><span class="hs-identifier hs-type">RequestValidation</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679322812"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#Timestamp"><span class="hs-identifier hs-type">Timestamp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#EnvValidity"><span class="hs-identifier hs-type">EnvValidity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Ref.html#QueryRequest"><span class="hs-identifier hs-type">QueryRequest</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679322812"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-349"></span><span id="authQueryRequest"><span class="annot"><span class="annottext">authQueryRequest :: Timestamp -&gt; EntityId -&gt; EnvValidity -&gt; QueryRequest -&gt; m ()
</span><a href="IC.Ref.html#authQueryRequest"><span class="hs-identifier hs-var hs-var">authQueryRequest</span></a></span></span><span> </span><span id="local-6989586621679322811"><span class="annot"><span class="annottext">t :: Timestamp
</span><a href="#local-6989586621679322811"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621679322810"><span class="annot"><span class="annottext">ecid :: EntityId
</span><a href="#local-6989586621679322810"><span class="hs-identifier hs-var">ecid</span></a></span></span><span> </span><span id="local-6989586621679322809"><span class="annot"><span class="annottext">ev :: EnvValidity
</span><a href="#local-6989586621679322809"><span class="hs-identifier hs-var">ev</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Ref.html#QueryRequest"><span class="hs-identifier hs-type">QueryRequest</span></a></span><span> </span><span id="local-6989586621679322808"><span class="annot"><span class="annottext">canister_id :: EntityId
</span><a href="#local-6989586621679322808"><span class="hs-identifier hs-var">canister_id</span></a></span></span><span> </span><span id="local-6989586621679322807"><span class="annot"><span class="annottext">user_id :: EntityId
</span><a href="#local-6989586621679322807"><span class="hs-identifier hs-var">user_id</span></a></span></span><span> </span><span id="local-6989586621679322806"><span class="annot"><span class="annottext">meth :: String
</span><a href="#local-6989586621679322806"><span class="hs-identifier hs-var">meth</span></a></span></span><span> </span><span id="local-6989586621679322805"><span class="annot"><span class="annottext">arg :: Blob
</span><a href="#local-6989586621679322805"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-350"></span><span>    </span><span class="annot"><span class="annottext">EntityId -&gt; EntityId -&gt; String -&gt; Blob -&gt; m ()
forall (m :: * -&gt; *).
RequestValidation m =&gt;
EntityId -&gt; EntityId -&gt; String -&gt; Blob -&gt; m ()
</span><a href="IC.Ref.html#checkEffectiveCanisterID"><span class="hs-identifier hs-var">checkEffectiveCanisterID</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322810"><span class="hs-identifier hs-var">ecid</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322808"><span class="hs-identifier hs-var">canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679322806"><span class="hs-identifier hs-var">meth</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679322805"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-351"></span><span>    </span><span class="annot"><span class="annottext">EnvValidity -&gt; Timestamp -&gt; m ()
EnvValidity
-&gt; forall (m :: * -&gt; *). MonadError Text m =&gt; Timestamp -&gt; m ()
</span><a href="IC.Types.html#valid_when"><span class="hs-identifier hs-var hs-var">valid_when</span></a></span><span> </span><span class="annot"><span class="annottext">EnvValidity
</span><a href="#local-6989586621679322809"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">Timestamp
</span><a href="#local-6989586621679322811"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-352"></span><span>    </span><span class="annot"><span class="annottext">EnvValidity -&gt; EntityId -&gt; m ()
EnvValidity
-&gt; forall (m :: * -&gt; *). MonadError Text m =&gt; EntityId -&gt; m ()
</span><a href="IC.Types.html#valid_for"><span class="hs-identifier hs-var hs-var">valid_for</span></a></span><span> </span><span class="annot"><span class="annottext">EnvValidity
</span><a href="#local-6989586621679322809"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322807"><span class="hs-identifier hs-var">user_id</span></a></span><span>
</span><span id="line-353"></span><span>    </span><span class="annot"><span class="annottext">EnvValidity -&gt; EntityId -&gt; m ()
EnvValidity
-&gt; forall (m :: * -&gt; *). MonadError Text m =&gt; EntityId -&gt; m ()
</span><a href="IC.Types.html#valid_where"><span class="hs-identifier hs-var hs-var">valid_where</span></a></span><span> </span><span class="annot"><span class="annottext">EnvValidity
</span><a href="#local-6989586621679322809"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322808"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-354"></span><span>
</span><span id="line-355"></span><span id="local-6989586621679322804"><span class="annot"><a href="IC.Ref.html#authReadStateRequest"><span class="hs-identifier hs-type">authReadStateRequest</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#RequestValidation"><span class="hs-identifier hs-type">RequestValidation</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679322804"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#Timestamp"><span class="hs-identifier hs-type">Timestamp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#EnvValidity"><span class="hs-identifier hs-type">EnvValidity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Ref.html#ReadStateRequest"><span class="hs-identifier hs-type">ReadStateRequest</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679322804"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-356"></span><span id="authReadStateRequest"><span class="annot"><span class="annottext">authReadStateRequest :: Timestamp -&gt; EntityId -&gt; EnvValidity -&gt; ReadStateRequest -&gt; m ()
</span><a href="IC.Ref.html#authReadStateRequest"><span class="hs-identifier hs-var hs-var">authReadStateRequest</span></a></span></span><span> </span><span id="local-6989586621679322803"><span class="annot"><span class="annottext">t :: Timestamp
</span><a href="#local-6989586621679322803"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621679322802"><span class="annot"><span class="annottext">ecid :: EntityId
</span><a href="#local-6989586621679322802"><span class="hs-identifier hs-var">ecid</span></a></span></span><span> </span><span id="local-6989586621679322801"><span class="annot"><span class="annottext">ev :: EnvValidity
</span><a href="#local-6989586621679322801"><span class="hs-identifier hs-var">ev</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Ref.html#ReadStateRequest"><span class="hs-identifier hs-type">ReadStateRequest</span></a></span><span> </span><span id="local-6989586621679322800"><span class="annot"><span class="annottext">user_id :: EntityId
</span><a href="#local-6989586621679322800"><span class="hs-identifier hs-var">user_id</span></a></span></span><span> </span><span id="local-6989586621679322799"><span class="annot"><span class="annottext">paths :: [Path]
</span><a href="#local-6989586621679322799"><span class="hs-identifier hs-var">paths</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-357"></span><span>    </span><span class="annot"><span class="annottext">EnvValidity -&gt; Timestamp -&gt; m ()
EnvValidity
-&gt; forall (m :: * -&gt; *). MonadError Text m =&gt; Timestamp -&gt; m ()
</span><a href="IC.Types.html#valid_when"><span class="hs-identifier hs-var hs-var">valid_when</span></a></span><span> </span><span class="annot"><span class="annottext">EnvValidity
</span><a href="#local-6989586621679322801"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">Timestamp
</span><a href="#local-6989586621679322803"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-358"></span><span>    </span><span class="annot"><span class="annottext">EnvValidity -&gt; EntityId -&gt; m ()
EnvValidity
-&gt; forall (m :: * -&gt; *). MonadError Text m =&gt; EntityId -&gt; m ()
</span><a href="IC.Types.html#valid_for"><span class="hs-identifier hs-var hs-var">valid_for</span></a></span><span> </span><span class="annot"><span class="annottext">EnvValidity
</span><a href="#local-6989586621679322801"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322800"><span class="hs-identifier hs-var">user_id</span></a></span><span>
</span><span id="line-359"></span><span>    </span><span class="hs-comment">-- Implement ACL for read requests here</span><span>
</span><span id="line-360"></span><span>    </span><span class="annot"><span class="annottext">[Path] -&gt; (Path -&gt; m ()) -&gt; m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="annot"><span class="annottext">[Path]
</span><a href="#local-6989586621679322799"><span class="hs-identifier hs-var">paths</span></a></span><span> </span><span class="annot"><span class="annottext">((Path -&gt; m ()) -&gt; m ()) -&gt; (Path -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-361"></span><span>      </span><span class="hs-special">[</span><span class="hs-string">&quot;time&quot;</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-362"></span><span>      </span><span class="hs-special">(</span><span class="hs-string">&quot;subnet&quot;</span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-363"></span><span>      </span><span class="hs-special">(</span><span class="hs-string">&quot;canister&quot;</span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621679322797"><span class="annot"><span class="annottext">cid :: Blob
</span><a href="#local-6989586621679322797"><span class="hs-identifier hs-var">cid</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="hs-string">&quot;module_hash&quot;</span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-364"></span><span>        </span><span class="annot"><span class="annottext">EntityId -&gt; EntityId -&gt; m ()
forall (m :: * -&gt; *).
RequestValidation m =&gt;
EntityId -&gt; EntityId -&gt; m ()
</span><a href="IC.Ref.html#assertEffectiveCanisterId"><span class="hs-identifier hs-var">assertEffectiveCanisterId</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322802"><span class="hs-identifier hs-var">ecid</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Blob -&gt; EntityId
</span><a href="IC.Types.html#EntityId"><span class="hs-identifier hs-var">EntityId</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679322797"><span class="hs-identifier hs-var">cid</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-365"></span><span>      </span><span class="hs-special">(</span><span class="hs-string">&quot;canister&quot;</span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621679322794"><span class="annot"><span class="annottext">cid :: Blob
</span><a href="#local-6989586621679322794"><span class="hs-identifier hs-var">cid</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="hs-string">&quot;controllers&quot;</span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-366"></span><span>        </span><span class="annot"><span class="annottext">EntityId -&gt; EntityId -&gt; m ()
forall (m :: * -&gt; *).
RequestValidation m =&gt;
EntityId -&gt; EntityId -&gt; m ()
</span><a href="IC.Ref.html#assertEffectiveCanisterId"><span class="hs-identifier hs-var">assertEffectiveCanisterId</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322802"><span class="hs-identifier hs-var">ecid</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Blob -&gt; EntityId
</span><a href="IC.Types.html#EntityId"><span class="hs-identifier hs-var">EntityId</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679322794"><span class="hs-identifier hs-var">cid</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-367"></span><span>      </span><span class="hs-special">(</span><span class="hs-string">&quot;request_status&quot;</span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621679322793"><span class="annot"><span class="annottext">rid :: Blob
</span><a href="#local-6989586621679322793"><span class="hs-identifier hs-var">rid</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-368"></span><span>        </span><span class="annot"><span class="annottext">(IC -&gt; Maybe (CallRequest, RequestStatus))
-&gt; m (Maybe (CallRequest, RequestStatus))
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Blob -&gt; IC -&gt; Maybe (CallRequest, RequestStatus)
</span><a href="IC.Ref.html#findRequest"><span class="hs-identifier hs-var">findRequest</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679322793"><span class="hs-identifier hs-var">rid</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">m (Maybe (CallRequest, RequestStatus))
-&gt; (Maybe (CallRequest, RequestStatus) -&gt; m ()) -&gt; m ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-369"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679322792"><span class="annot"><span class="annottext">ar :: CallRequest
</span><a href="#local-6989586621679322792"><span class="hs-identifier hs-var">ar</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="IC.Ref.html#CallRequest"><span class="hs-identifier hs-type">CallRequest</span></a></span><span> </span><span id="local-6989586621679322791"><span class="annot"><span class="annottext">cid :: EntityId
</span><a href="#local-6989586621679322791"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span class="hs-identifier">_</span><span> </span><span id="local-6989586621679322790"><span class="annot"><span class="annottext">meth :: String
</span><a href="#local-6989586621679322790"><span class="hs-identifier hs-var">meth</span></a></span></span><span> </span><span id="local-6989586621679322789"><span class="annot"><span class="annottext">arg :: Blob
</span><a href="#local-6989586621679322789"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-370"></span><span>            </span><span class="annot"><span class="annottext">EntityId -&gt; EntityId -&gt; String -&gt; Blob -&gt; m ()
forall (m :: * -&gt; *).
RequestValidation m =&gt;
EntityId -&gt; EntityId -&gt; String -&gt; Blob -&gt; m ()
</span><a href="IC.Ref.html#checkEffectiveCanisterID"><span class="hs-identifier hs-var">checkEffectiveCanisterID</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322802"><span class="hs-identifier hs-var">ecid</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322791"><span class="hs-identifier hs-var">cid</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679322790"><span class="hs-identifier hs-var">meth</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679322789"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-371"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322800"><span class="hs-identifier hs-var">user_id</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; EntityId -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">CallRequest -&gt; EntityId
</span><a href="IC.Ref.html#callerOfCallRequest"><span class="hs-identifier hs-var">callerOfCallRequest</span></a></span><span> </span><span class="annot"><span class="annottext">CallRequest
</span><a href="#local-6989586621679322792"><span class="hs-identifier hs-var">ar</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-372"></span><span>              </span><span class="annot"><span class="annottext">Text -&gt; m ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="hs-string">&quot;User is not authorized to read this request status&quot;</span></span><span>
</span><span id="line-373"></span><span>            </span><span class="annot"><span class="annottext">EnvValidity -&gt; EntityId -&gt; m ()
EnvValidity
-&gt; forall (m :: * -&gt; *). MonadError Text m =&gt; EntityId -&gt; m ()
</span><a href="IC.Types.html#valid_where"><span class="hs-identifier hs-var hs-var">valid_where</span></a></span><span> </span><span class="annot"><span class="annottext">EnvValidity
</span><a href="#local-6989586621679322801"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CallRequest -&gt; EntityId
</span><a href="IC.Ref.html#calleeOfCallRequest"><span class="hs-identifier hs-var">calleeOfCallRequest</span></a></span><span> </span><span class="annot"><span class="annottext">CallRequest
</span><a href="#local-6989586621679322792"><span class="hs-identifier hs-var">ar</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-374"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-375"></span><span>      </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text -&gt; m ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="hs-string">&quot;User is not authorized to read unspecified state paths&quot;</span></span><span>
</span><span id="line-376"></span><span>
</span><span id="line-377"></span><span id="local-6989586621679323395"><span class="annot"><a href="IC.Ref.html#canisterEnv"><span class="hs-identifier hs-type">canisterEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323395"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323395"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="IC.Types.html#Env"><span class="hs-identifier hs-type">Env</span></a></span></span><span>
</span><span id="line-378"></span><span id="canisterEnv"><span class="annot"><span class="annottext">canisterEnv :: EntityId -&gt; m Env
</span><a href="IC.Ref.html#canisterEnv"><span class="hs-identifier hs-var hs-var">canisterEnv</span></a></span></span><span> </span><span id="local-6989586621679322785"><span class="annot"><span class="annottext">canister_id :: EntityId
</span><a href="#local-6989586621679322785"><span class="hs-identifier hs-var">canister_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-379"></span><span>  </span><span id="local-6989586621679322784"><span class="annot"><span class="annottext">Timestamp
</span><a href="#local-6989586621679322784"><span class="hs-identifier hs-var">env_time</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; m Timestamp
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; m Timestamp
</span><a href="IC.Ref.html#getCanisterTime"><span class="hs-identifier hs-var">getCanisterTime</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322785"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-380"></span><span>  </span><span id="local-6989586621679322783"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679322783"><span class="hs-identifier hs-var">env_balance</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; m Natural
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; m Natural
</span><a href="IC.Ref.html#getBalance"><span class="hs-identifier hs-var">getBalance</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322785"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-381"></span><span>  </span><span id="local-6989586621679322782"><span class="annot"><span class="annottext">Status
</span><a href="#local-6989586621679322782"><span class="hs-identifier hs-var">env_status</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; m RunStatus
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; m RunStatus
</span><a href="IC.Ref.html#getRunStatus"><span class="hs-identifier hs-var">getRunStatus</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322785"><span class="hs-identifier hs-var">canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">m RunStatus -&gt; (RunStatus -&gt; Status) -&gt; m Status
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><span class="hs-operator hs-var">&lt;&amp;&gt;</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-382"></span><span>      </span><span class="annot"><a href="IC.Ref.html#IsRunning"><span class="hs-identifier hs-type">IsRunning</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Status
</span><a href="IC.Types.html#Running"><span class="hs-identifier hs-var">Running</span></a></span><span>
</span><span id="line-383"></span><span>      </span><span class="annot"><a href="IC.Ref.html#IsStopping"><span class="hs-identifier hs-type">IsStopping</span></a></span><span> </span><span id="local-6989586621679322779"><span class="annot"><span class="annottext">_pending :: [Int]
</span><a href="#local-6989586621679322779"><span class="hs-identifier hs-var">_pending</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Status
</span><a href="IC.Types.html#Stopping"><span class="hs-identifier hs-var">Stopping</span></a></span><span>
</span><span id="line-384"></span><span>      </span><span class="annot"><a href="IC.Ref.html#IsStopped"><span class="hs-identifier hs-type">IsStopped</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Status
</span><a href="IC.Types.html#Stopped"><span class="hs-identifier hs-var">Stopped</span></a></span><span>
</span><span id="line-385"></span><span>      </span><span class="annot"><a href="IC.Ref.html#IsDeleted"><span class="hs-identifier hs-type">IsDeleted</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; Status
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="hs-string">&quot;deleted canister encountered&quot;</span></span><span>
</span><span id="line-386"></span><span>  </span><span class="annot"><span class="annottext">Env -&gt; m Env
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Env -&gt; m Env) -&gt; Env -&gt; m Env
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Env :: EntityId -&gt; Timestamp -&gt; Natural -&gt; Status -&gt; Maybe Blob -&gt; Env
</span><a href="IC.Types.html#Env"><span class="hs-identifier hs-type hs-type">Env</span></a></span><span>
</span><span id="line-387"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">env_self :: EntityId
</span><a href="IC.Types.html#env_self"><span class="hs-identifier hs-var">env_self</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322785"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-388"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Timestamp
env_time :: Timestamp
env_time :: Timestamp
</span><a href="IC.Types.html#env_time"><span class="hs-identifier hs-var hs-var">env_time</span></a></span><span>
</span><span id="line-389"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Natural
env_balance :: Natural
env_balance :: Natural
</span><a href="IC.Types.html#env_balance"><span class="hs-identifier hs-var hs-var">env_balance</span></a></span><span>
</span><span id="line-390"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Status
env_status :: Status
env_status :: Status
</span><a href="IC.Types.html#env_status"><span class="hs-identifier hs-var hs-var">env_status</span></a></span><span>
</span><span id="line-391"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">env_certificate :: Maybe Blob
</span><a href="IC.Types.html#env_certificate"><span class="hs-identifier hs-var">env_certificate</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Blob
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-392"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-393"></span><span>
</span><span id="line-394"></span><span class="hs-comment">-- Synchronous requests</span><span>
</span><span id="line-395"></span><span>
</span><span id="line-396"></span><span id="local-6989586621679322769"><span class="annot"><a href="IC.Ref.html#handleQuery"><span class="hs-identifier hs-type">handleQuery</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679322769"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#Timestamp"><span class="hs-identifier hs-type">Timestamp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Ref.html#QueryRequest"><span class="hs-identifier hs-type">QueryRequest</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679322769"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="IC.Ref.html#ReqResponse"><span class="hs-identifier hs-type">ReqResponse</span></a></span></span><span>
</span><span id="line-397"></span><span id="handleQuery"><span class="annot"><span class="annottext">handleQuery :: Timestamp -&gt; QueryRequest -&gt; m ReqResponse
</span><a href="IC.Ref.html#handleQuery"><span class="hs-identifier hs-var hs-var">handleQuery</span></a></span></span><span> </span><span id="local-6989586621679322768"><span class="annot"><span class="annottext">time :: Timestamp
</span><a href="#local-6989586621679322768"><span class="hs-identifier hs-var">time</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Ref.html#QueryRequest"><span class="hs-identifier hs-type">QueryRequest</span></a></span><span> </span><span id="local-6989586621679322767"><span class="annot"><span class="annottext">canister_id :: EntityId
</span><a href="#local-6989586621679322767"><span class="hs-identifier hs-var">canister_id</span></a></span></span><span> </span><span id="local-6989586621679322766"><span class="annot"><span class="annottext">user_id :: EntityId
</span><a href="#local-6989586621679322766"><span class="hs-identifier hs-var">user_id</span></a></span></span><span> </span><span id="local-6989586621679322765"><span class="annot"><span class="annottext">method :: String
</span><a href="#local-6989586621679322765"><span class="hs-identifier hs-var">method</span></a></span></span><span> </span><span id="local-6989586621679322764"><span class="annot"><span class="annottext">arg :: Blob
</span><a href="#local-6989586621679322764"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-398"></span><span>  </span><span class="annot"><span class="annottext">(CallResponse -&gt; ReqResponse) -&gt; m CallResponse -&gt; m ReqResponse
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">CallResponse -&gt; ReqResponse
</span><a href="IC.Ref.html#QueryResponse"><span class="hs-identifier hs-var">QueryResponse</span></a></span><span> </span><span class="annot"><span class="annottext">(m CallResponse -&gt; m ReqResponse)
-&gt; m CallResponse -&gt; m ReqResponse
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((RejectCode, String) -&gt; m CallResponse)
-&gt; (forall (m' :: * -&gt; *).
    (CanReject m', ICM m') =&gt;
    m' CallResponse)
-&gt; m CallResponse
forall (m :: * -&gt; *) b.
ICM m =&gt;
((RejectCode, String) -&gt; m b)
-&gt; (forall (m' :: * -&gt; *). (CanReject m', ICM m') =&gt; m' b) -&gt; m b
</span><a href="IC.Ref.html#onReject"><span class="hs-identifier hs-var">onReject</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CallResponse -&gt; m CallResponse
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(CallResponse -&gt; m CallResponse)
-&gt; ((RejectCode, String) -&gt; CallResponse)
-&gt; (RejectCode, String)
-&gt; m CallResponse
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(RejectCode, String) -&gt; CallResponse
</span><a href="IC.Ref.html#Rejected"><span class="hs-identifier hs-var">Rejected</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((forall (m' :: * -&gt; *). (CanReject m', ICM m') =&gt; m' CallResponse)
 -&gt; m CallResponse)
-&gt; (forall (m' :: * -&gt; *).
    (CanReject m', ICM m') =&gt;
    m' CallResponse)
-&gt; m CallResponse
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-399"></span><span>    </span><span class="annot"><span class="annottext">EntityId -&gt; m' ()
forall (m :: * -&gt; *). (CanReject m, ICM m) =&gt; EntityId -&gt; m ()
</span><a href="IC.Ref.html#canisterMustExist"><span class="hs-identifier hs-var">canisterMustExist</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322767"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-400"></span><span>    </span><span class="annot"><span class="annottext">EntityId -&gt; m' RunStatus
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; m RunStatus
</span><a href="IC.Ref.html#getRunStatus"><span class="hs-identifier hs-var">getRunStatus</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322767"><span class="hs-identifier hs-var">canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">m' RunStatus -&gt; (RunStatus -&gt; m' ()) -&gt; m' ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-401"></span><span>       </span><span class="annot"><a href="IC.Ref.html#IsRunning"><span class="hs-identifier hs-type">IsRunning</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m' ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-402"></span><span>       </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RejectCode -&gt; String -&gt; m' ()
forall (m :: * -&gt; *) a2.
CanReject m =&gt;
RejectCode -&gt; String -&gt; m a2
</span><a href="IC.Ref.html#reject"><span class="hs-identifier hs-var">reject</span></a></span><span> </span><span class="annot"><span class="annottext">RejectCode
</span><a href="IC.Types.html#RC_CANISTER_ERROR"><span class="hs-identifier hs-var">RC_CANISTER_ERROR</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;canister is stopped&quot;</span></span><span>
</span><span id="line-403"></span><span>    </span><span id="local-6989586621679322761"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679322761"><span class="hs-identifier hs-var">empty</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; m' Bool
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; m Bool
</span><a href="IC.Ref.html#isCanisterEmpty"><span class="hs-identifier hs-var">isCanisterEmpty</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322767"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-404"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; m' () -&gt; m' ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679322761"><span class="hs-identifier hs-var">empty</span></a></span><span> </span><span class="annot"><span class="annottext">(m' () -&gt; m' ()) -&gt; m' () -&gt; m' ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">RejectCode -&gt; String -&gt; m' ()
forall (m :: * -&gt; *) a2.
CanReject m =&gt;
RejectCode -&gt; String -&gt; m a2
</span><a href="IC.Ref.html#reject"><span class="hs-identifier hs-var">reject</span></a></span><span> </span><span class="annot"><span class="annottext">RejectCode
</span><a href="IC.Types.html#RC_DESTINATION_INVALID"><span class="hs-identifier hs-var">RC_DESTINATION_INVALID</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;canister is empty&quot;</span></span><span>
</span><span id="line-405"></span><span>    </span><span id="local-6989586621679322759"><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679322759"><span class="hs-identifier hs-var">wasm_state</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; m' WasmState
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; m WasmState
</span><a href="IC.Ref.html#getCanisterState"><span class="hs-identifier hs-var">getCanisterState</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322767"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-406"></span><span>    </span><span id="local-6989586621679322758"><span class="annot"><span class="annottext">CanisterModule
</span><a href="#local-6989586621679322758"><span class="hs-identifier hs-var">can_mod</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; m' CanisterModule
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; m CanisterModule
</span><a href="IC.Ref.html#getCanisterMod"><span class="hs-identifier hs-var">getCanisterMod</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322767"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-407"></span><span>    </span><span id="local-6989586621679322757"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679322757"><span class="hs-identifier hs-var">certificate</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Timestamp -&gt; EntityId -&gt; m' Blob
forall (m :: * -&gt; *). ICM m =&gt; Timestamp -&gt; EntityId -&gt; m Blob
</span><a href="IC.Ref.html#getDataCertificate"><span class="hs-identifier hs-var">getDataCertificate</span></a></span><span> </span><span class="annot"><span class="annottext">Timestamp
</span><a href="#local-6989586621679322768"><span class="hs-identifier hs-var">time</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322767"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-408"></span><span>    </span><span id="local-6989586621679322755"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679322755"><span class="hs-identifier hs-var">env0</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; m' Env
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; m Env
</span><a href="IC.Ref.html#canisterEnv"><span class="hs-identifier hs-var">canisterEnv</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322767"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-409"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679322754"><span class="annot"><span class="annottext">env :: Env
</span><a href="#local-6989586621679322754"><span class="hs-identifier hs-var hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679322755"><span class="hs-identifier hs-var">env0</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">env_certificate :: Maybe Blob
</span><a href="IC.Types.html#env_certificate"><span class="hs-identifier hs-var">env_certificate</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Blob -&gt; Maybe Blob
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679322757"><span class="hs-identifier hs-var">certificate</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-410"></span><span>
</span><span id="line-411"></span><span>    </span><span id="local-6989586621679322753"><span class="annot"><span class="annottext">EntityId -&gt; Env -&gt; Blob -&gt; QueryFunc
</span><a href="#local-6989586621679322753"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe (EntityId -&gt; Env -&gt; Blob -&gt; QueryFunc)
-&gt; m' (Maybe (EntityId -&gt; Env -&gt; Blob -&gt; QueryFunc))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
-&gt; Map String (EntityId -&gt; Env -&gt; Blob -&gt; QueryFunc)
-&gt; Maybe (EntityId -&gt; Env -&gt; Blob -&gt; QueryFunc)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679322765"><span class="hs-identifier hs-var">method</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CanisterModule -&gt; Map String (EntityId -&gt; Env -&gt; Blob -&gt; QueryFunc)
</span><a href="IC.Canister.html#query_methods"><span class="hs-identifier hs-var hs-var">query_methods</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterModule
</span><a href="#local-6989586621679322758"><span class="hs-identifier hs-var">can_mod</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-412"></span><span>      </span><span class="annot"><span class="annottext">m' (Maybe (EntityId -&gt; Env -&gt; Blob -&gt; QueryFunc))
-&gt; m' (EntityId -&gt; Env -&gt; Blob -&gt; QueryFunc)
-&gt; m' (EntityId -&gt; Env -&gt; Blob -&gt; QueryFunc)
forall (m :: * -&gt; *) a. Monad m =&gt; m (Maybe a) -&gt; m a -&gt; m a
</span><a href="IC.Ref.html#orElse"><span class="hs-operator hs-var">`orElse`</span></a></span><span> </span><span class="annot"><span class="annottext">RejectCode -&gt; String -&gt; m' (EntityId -&gt; Env -&gt; Blob -&gt; QueryFunc)
forall (m :: * -&gt; *) a2.
CanReject m =&gt;
RejectCode -&gt; String -&gt; m a2
</span><a href="IC.Ref.html#reject"><span class="hs-identifier hs-var">reject</span></a></span><span> </span><span class="annot"><span class="annottext">RejectCode
</span><a href="IC.Types.html#RC_DESTINATION_INVALID"><span class="hs-identifier hs-var">RC_DESTINATION_INVALID</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;query method does not exist&quot;</span></span><span>
</span><span id="line-413"></span><span>
</span><span id="line-414"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; Env -&gt; Blob -&gt; QueryFunc
</span><a href="#local-6989586621679322753"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322766"><span class="hs-identifier hs-var">user_id</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679322754"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679322764"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679322759"><span class="hs-identifier hs-var">wasm_state</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-415"></span><span>      </span><span class="annot"><a href="IC.Types.html#Trap"><span class="hs-identifier hs-type">Trap</span></a></span><span> </span><span id="local-6989586621679322750"><span class="annot"><span class="annottext">msg :: String
</span><a href="#local-6989586621679322750"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RejectCode -&gt; String -&gt; m' CallResponse
forall (m :: * -&gt; *) a2.
CanReject m =&gt;
RejectCode -&gt; String -&gt; m a2
</span><a href="IC.Ref.html#reject"><span class="hs-identifier hs-var">reject</span></a></span><span> </span><span class="annot"><span class="annottext">RejectCode
</span><a href="IC.Types.html#RC_CANISTER_ERROR"><span class="hs-identifier hs-var">RC_CANISTER_ERROR</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; m' CallResponse) -&gt; String -&gt; m' CallResponse
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;canister trapped: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679322750"><span class="hs-identifier hs-var">msg</span></a></span><span>
</span><span id="line-416"></span><span>      </span><span class="annot"><a href="IC.Types.html#Return"><span class="hs-identifier hs-type">Return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Types.html#Reject"><span class="hs-identifier hs-type">Reject</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679322747"><span class="annot"><span class="annottext">rc :: RejectCode
</span><a href="#local-6989586621679322747"><span class="hs-identifier hs-var">rc</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679322746"><span class="annot"><span class="annottext">rm :: String
</span><a href="#local-6989586621679322746"><span class="hs-identifier hs-var">rm</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RejectCode -&gt; String -&gt; m' CallResponse
forall (m :: * -&gt; *) a2.
CanReject m =&gt;
RejectCode -&gt; String -&gt; m a2
</span><a href="IC.Ref.html#reject"><span class="hs-identifier hs-var">reject</span></a></span><span> </span><span class="annot"><span class="annottext">RejectCode
</span><a href="#local-6989586621679322747"><span class="hs-identifier hs-var">rc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679322746"><span class="hs-identifier hs-var">rm</span></a></span><span>
</span><span id="line-417"></span><span>      </span><span class="annot"><a href="IC.Types.html#Return"><span class="hs-identifier hs-type">Return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Types.html#Reply"><span class="hs-identifier hs-type">Reply</span></a></span><span> </span><span id="local-6989586621679322744"><span class="annot"><span class="annottext">res :: Blob
</span><a href="#local-6989586621679322744"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CallResponse -&gt; m' CallResponse
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(CallResponse -&gt; m' CallResponse)
-&gt; CallResponse -&gt; m' CallResponse
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; CallResponse
</span><a href="IC.Ref.html#Replied"><span class="hs-identifier hs-var">Replied</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679322744"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-418"></span><span>
</span><span id="line-419"></span><span id="local-6989586621679322743"><span class="annot"><a href="IC.Ref.html#handleReadState"><span class="hs-identifier hs-type">handleReadState</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679322743"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#Timestamp"><span class="hs-identifier hs-type">Timestamp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Ref.html#ReadStateRequest"><span class="hs-identifier hs-type">ReadStateRequest</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679322743"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="IC.Ref.html#ReqResponse"><span class="hs-identifier hs-type">ReqResponse</span></a></span></span><span>
</span><span id="line-420"></span><span id="handleReadState"><span class="annot"><span class="annottext">handleReadState :: Timestamp -&gt; ReadStateRequest -&gt; m ReqResponse
</span><a href="IC.Ref.html#handleReadState"><span class="hs-identifier hs-var hs-var">handleReadState</span></a></span></span><span> </span><span id="local-6989586621679322742"><span class="annot"><span class="annottext">time :: Timestamp
</span><a href="#local-6989586621679322742"><span class="hs-identifier hs-var">time</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Ref.html#ReadStateRequest"><span class="hs-identifier hs-type">ReadStateRequest</span></a></span><span> </span><span id="local-6989586621679322741"><span class="annot"><span class="annottext">_sender :: EntityId
</span><a href="#local-6989586621679322741"><span class="hs-identifier hs-var">_sender</span></a></span></span><span> </span><span id="local-6989586621679322740"><span class="annot"><span class="annottext">paths :: [Path]
</span><a href="#local-6989586621679322740"><span class="hs-identifier hs-var">paths</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-421"></span><span>    </span><span class="hs-comment">-- NB: Already authorized in authSyncRequest</span><span>
</span><span id="line-422"></span><span>    </span><span id="local-6989586621679322739"><span class="annot"><span class="annottext">Certificate
</span><a href="#local-6989586621679322739"><span class="hs-identifier hs-var">cert</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Timestamp -&gt; [Path] -&gt; m Certificate
forall (m :: * -&gt; *). ICM m =&gt; Timestamp -&gt; [Path] -&gt; m Certificate
</span><a href="IC.Ref.html#getPrunedCertificate"><span class="hs-identifier hs-var">getPrunedCertificate</span></a></span><span> </span><span class="annot"><span class="annottext">Timestamp
</span><a href="#local-6989586621679322742"><span class="hs-identifier hs-var">time</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><span class="hs-string">&quot;time&quot;</span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Path -&gt; [Path] -&gt; [Path]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[Path]
</span><a href="#local-6989586621679322740"><span class="hs-identifier hs-var">paths</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-423"></span><span>    </span><span class="annot"><span class="annottext">ReqResponse -&gt; m ReqResponse
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(ReqResponse -&gt; m ReqResponse) -&gt; ReqResponse -&gt; m ReqResponse
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Certificate -&gt; ReqResponse
</span><a href="IC.Ref.html#ReadStateResponse"><span class="hs-identifier hs-var">ReadStateResponse</span></a></span><span> </span><span class="annot"><span class="annottext">Certificate
</span><a href="#local-6989586621679322739"><span class="hs-identifier hs-var">cert</span></a></span><span>
</span><span id="line-424"></span><span>
</span><span id="line-425"></span><span id="local-6989586621679323434"><span class="annot"><a href="IC.Ref.html#checkEffectiveCanisterID"><span class="hs-identifier hs-type">checkEffectiveCanisterID</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#RequestValidation"><span class="hs-identifier hs-type">RequestValidation</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323434"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#MethodName"><span class="hs-identifier hs-type">MethodName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323434"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-426"></span><span id="checkEffectiveCanisterID"><span class="annot"><span class="annottext">checkEffectiveCanisterID :: EntityId -&gt; EntityId -&gt; String -&gt; Blob -&gt; m ()
</span><a href="IC.Ref.html#checkEffectiveCanisterID"><span class="hs-identifier hs-var hs-var">checkEffectiveCanisterID</span></a></span></span><span> </span><span id="local-6989586621679322737"><span class="annot"><span class="annottext">ecid :: EntityId
</span><a href="#local-6989586621679322737"><span class="hs-identifier hs-var">ecid</span></a></span></span><span> </span><span id="local-6989586621679322736"><span class="annot"><span class="annottext">cid :: EntityId
</span><a href="#local-6989586621679322736"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span id="local-6989586621679322735"><span class="annot"><span class="annottext">method :: String
</span><a href="#local-6989586621679322735"><span class="hs-identifier hs-var">method</span></a></span></span><span> </span><span id="local-6989586621679322734"><span class="annot"><span class="annottext">arg :: Blob
</span><a href="#local-6989586621679322734"><span class="hs-identifier hs-var">arg</span></a></span></span><span>
</span><span id="line-427"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322736"><span class="hs-identifier hs-var">cid</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; EntityId -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="IC.Ref.html#managementCanisterId"><span class="hs-identifier hs-var">managementCanisterId</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679322735"><span class="hs-identifier hs-var">method</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-428"></span><span>    </span><span class="hs-string">&quot;provisional_create_canister_with_cycles&quot;</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-429"></span><span>    </span><span class="hs-string">&quot;raw_rand&quot;</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text -&gt; m ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="hs-string">&quot;raw_rand() cannot be invoked via ingress calls&quot;</span></span><span>
</span><span id="line-430"></span><span>    </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Blob -&gt; Either String (Rec (&quot;canister_id&quot; .== Principal))
forall a. CandidArg a =&gt; Blob -&gt; Either String a
</span><span class="hs-identifier hs-var">Codec.Candid.decode</span></span><span> </span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">R.Rec</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-string">&quot;canister_id&quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">R..==</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Principal</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679322734"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-431"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679322731"><span class="annot"><span class="annottext">err :: String
</span><a href="#local-6989586621679322731"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-432"></span><span>            </span><span class="annot"><span class="annottext">Text -&gt; m ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; m ()) -&gt; Text -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;call to management canister is not valid candid: &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">T.pack</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679322731"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-433"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679322729"><span class="annot"><span class="annottext">r :: Rec (&quot;canister_id&quot; .== Principal)
</span><a href="#local-6989586621679322729"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-434"></span><span>            </span><span class="annot"><span class="annottext">EntityId -&gt; EntityId -&gt; m ()
forall (m :: * -&gt; *).
RequestValidation m =&gt;
EntityId -&gt; EntityId -&gt; m ()
</span><a href="IC.Ref.html#assertEffectiveCanisterId"><span class="hs-identifier hs-var">assertEffectiveCanisterId</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322737"><span class="hs-identifier hs-var">ecid</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Principal -&gt; EntityId
</span><a href="IC.Management.html#principalToEntityId"><span class="hs-identifier hs-var">principalToEntityId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Rec (&quot;canister_id&quot; .== Principal)
Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
</span><a href="#local-6989586621679322729"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; Label &quot;canister_id&quot;
-&gt; 'R '[ &quot;canister_id&quot; ':-&gt; Principal] .! &quot;canister_id&quot;
forall (l :: Symbol) (r :: Row *).
KnownSymbol l =&gt;
Rec r -&gt; Label l -&gt; r .! l
</span><span class="hs-operator hs-var">.!</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;canister_id&quot; (Label &quot;canister_id&quot;)
Label &quot;canister_id&quot;
</span><a href="#local-6989586621679322727"><span class="hs-var">#canister_id</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-435"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; EntityId -&gt; m ()
forall (m :: * -&gt; *).
RequestValidation m =&gt;
EntityId -&gt; EntityId -&gt; m ()
</span><a href="IC.Ref.html#assertEffectiveCanisterId"><span class="hs-identifier hs-var">assertEffectiveCanisterId</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322737"><span class="hs-identifier hs-var">ecid</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322736"><span class="hs-identifier hs-var">cid</span></a></span><span>
</span><span id="line-436"></span><span>
</span><span id="line-437"></span><span id="local-6989586621679323419"><span class="annot"><a href="IC.Ref.html#assertEffectiveCanisterId"><span class="hs-identifier hs-type">assertEffectiveCanisterId</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#RequestValidation"><span class="hs-identifier hs-type">RequestValidation</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323419"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323419"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-438"></span><span id="assertEffectiveCanisterId"><span class="annot"><span class="annottext">assertEffectiveCanisterId :: EntityId -&gt; EntityId -&gt; m ()
</span><a href="IC.Ref.html#assertEffectiveCanisterId"><span class="hs-identifier hs-var hs-var">assertEffectiveCanisterId</span></a></span></span><span> </span><span id="local-6989586621679322726"><span class="annot"><span class="annottext">ecid :: EntityId
</span><a href="#local-6989586621679322726"><span class="hs-identifier hs-var">ecid</span></a></span></span><span> </span><span id="local-6989586621679322725"><span class="annot"><span class="annottext">cid :: EntityId
</span><a href="#local-6989586621679322725"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-439"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322726"><span class="hs-identifier hs-var">ecid</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; EntityId -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322725"><span class="hs-identifier hs-var">cid</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-440"></span><span>    </span><span class="annot"><span class="annottext">Text -&gt; m ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; m ()) -&gt; Text -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;expected effective canister_id &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">T.pack</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EntityId -&gt; String
</span><a href="IC.Types.html#prettyID"><span class="hs-identifier hs-var">prettyID</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322725"><span class="hs-identifier hs-var">cid</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="hs-string">&quot;, got &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">T.pack</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EntityId -&gt; String
</span><a href="IC.Types.html#prettyID"><span class="hs-identifier hs-var">prettyID</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322726"><span class="hs-identifier hs-var">ecid</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-441"></span><span>
</span><span id="line-442"></span><span id="local-6989586621679323429"><span class="annot"><a href="IC.Ref.html#inspectIngress"><span class="hs-identifier hs-type">inspectIngress</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#RequestValidation"><span class="hs-identifier hs-type">RequestValidation</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323429"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Ref.html#CallRequest"><span class="hs-identifier hs-type">CallRequest</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323429"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-443"></span><span id="inspectIngress"><span class="annot"><span class="annottext">inspectIngress :: CallRequest -&gt; m ()
</span><a href="IC.Ref.html#inspectIngress"><span class="hs-identifier hs-var hs-var">inspectIngress</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Ref.html#CallRequest"><span class="hs-identifier hs-type">CallRequest</span></a></span><span> </span><span id="local-6989586621679322724"><span class="annot"><span class="annottext">canister_id :: EntityId
</span><a href="#local-6989586621679322724"><span class="hs-identifier hs-var">canister_id</span></a></span></span><span> </span><span id="local-6989586621679322723"><span class="annot"><span class="annottext">user_id :: EntityId
</span><a href="#local-6989586621679322723"><span class="hs-identifier hs-var">user_id</span></a></span></span><span> </span><span id="local-6989586621679322722"><span class="annot"><span class="annottext">method :: String
</span><a href="#local-6989586621679322722"><span class="hs-identifier hs-var">method</span></a></span></span><span> </span><span id="local-6989586621679322721"><span class="annot"><span class="annottext">arg :: Blob
</span><a href="#local-6989586621679322721"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-444"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322724"><span class="hs-identifier hs-var">canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; EntityId -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="IC.Ref.html#managementCanisterId"><span class="hs-identifier hs-var">managementCanisterId</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-445"></span><span>    </span><span class="hs-keyword">if</span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679322722"><span class="hs-identifier hs-var">method</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; [String] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-string">&quot;provisional_create_canister_with_cycles&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;provisional_top_up_canister&quot;</span></span><span class="hs-special">]</span><span>
</span><span id="line-446"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-447"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679322722"><span class="hs-identifier hs-var">method</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; [String] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="hs-string">&quot;raw_rand&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;deposit_cycles&quot;</span></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-448"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text -&gt; m ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; m ()) -&gt; Text -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Management method &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">T.pack</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679322722"><span class="hs-identifier hs-var">method</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="hs-string">&quot; cannot be invoked via an ingress call&quot;</span></span><span>
</span><span id="line-449"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679322722"><span class="hs-identifier hs-var">method</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; [String] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="IC.Management.html#managementMethods"><span class="hs-identifier hs-var">managementMethods</span></a></span><span>
</span><span id="line-450"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Blob -&gt; Either String (Rec (&quot;canister_id&quot; .== Principal))
forall a. CandidArg a =&gt; Blob -&gt; Either String a
</span><span class="hs-identifier hs-var">decode</span></span><span> </span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">R.Rec</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-string">&quot;canister_id&quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">R..==</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Principal</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679322721"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-451"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679322718"><span class="annot"><span class="annottext">msg :: String
</span><a href="#local-6989586621679322718"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text -&gt; m ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; m ()) -&gt; Text -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Candid failed to decode: &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">T.pack</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679322718"><span class="hs-identifier hs-var">msg</span></a></span><span>
</span><span id="line-452"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679322717"><span class="annot"><span class="annottext">r :: Rec (&quot;canister_id&quot; .== Principal)
</span><a href="#local-6989586621679322717"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-453"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679322716"><span class="annot"><span class="annottext">canister_id :: EntityId
</span><a href="#local-6989586621679322716"><span class="hs-identifier hs-var hs-var">canister_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Principal -&gt; EntityId
</span><a href="IC.Management.html#principalToEntityId"><span class="hs-identifier hs-var">principalToEntityId</span></a></span><span> </span><span class="annot"><span class="annottext">(Principal -&gt; EntityId) -&gt; Principal -&gt; EntityId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Rec (&quot;canister_id&quot; .== Principal)
Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
</span><a href="#local-6989586621679322717"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; Label &quot;canister_id&quot;
-&gt; 'R '[ &quot;canister_id&quot; ':-&gt; Principal] .! &quot;canister_id&quot;
forall (l :: Symbol) (r :: Row *).
KnownSymbol l =&gt;
Rec r -&gt; Label l -&gt; r .! l
</span><span class="hs-operator hs-var">.!</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;canister_id&quot; (Label &quot;canister_id&quot;)
Label &quot;canister_id&quot;
</span><a href="#local-6989586621679322715"><span class="hs-var">#canister_id</span></a></span><span>
</span><span id="line-454"></span><span>            </span><span class="annot"><span class="annottext">((RejectCode, String) -&gt; m ())
-&gt; (forall (m' :: * -&gt; *). (CanReject m', ICM m') =&gt; m' ()) -&gt; m ()
forall (m :: * -&gt; *) b.
ICM m =&gt;
((RejectCode, String) -&gt; m b)
-&gt; (forall (m' :: * -&gt; *). (CanReject m', ICM m') =&gt; m' b) -&gt; m b
</span><a href="IC.Ref.html#onReject"><span class="hs-identifier hs-var">onReject</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; m ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; m ())
-&gt; ((RejectCode, String) -&gt; Text) -&gt; (RejectCode, String) -&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">T.pack</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Text)
-&gt; ((RejectCode, String) -&gt; String) -&gt; (RejectCode, String) -&gt; Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(RejectCode, String) -&gt; String
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((forall (m' :: * -&gt; *). (CanReject m', ICM m') =&gt; m' ()) -&gt; m ())
-&gt; (forall (m' :: * -&gt; *). (CanReject m', ICM m') =&gt; m' ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-455"></span><span>                </span><span class="annot"><span class="annottext">EntityId -&gt; m' ()
forall (m :: * -&gt; *). (CanReject m, ICM m) =&gt; EntityId -&gt; m ()
</span><a href="IC.Ref.html#canisterMustExist"><span class="hs-identifier hs-var">canisterMustExist</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322716"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-456"></span><span>            </span><span id="local-6989586621679322714"><span class="annot"><span class="annottext">Set EntityId
</span><a href="#local-6989586621679322714"><span class="hs-identifier hs-var">controllers</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; m (Set EntityId)
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; m (Set EntityId)
</span><a href="IC.Ref.html#getControllers"><span class="hs-identifier hs-var">getControllers</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322716"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-457"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322723"><span class="hs-identifier hs-var">user_id</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; Set EntityId -&gt; Bool
forall a. Ord a =&gt; a -&gt; Set a -&gt; Bool
</span><span class="hs-operator hs-var">`S.member`</span></span><span> </span><span class="annot"><span class="annottext">Set EntityId
</span><a href="#local-6989586621679322714"><span class="hs-identifier hs-var">controllers</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-458"></span><span>                </span><span class="annot"><span class="annottext">Text -&gt; m ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Wrong sender&quot;</span></span><span>
</span><span id="line-459"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-460"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text -&gt; m ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; m ()) -&gt; Text -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Unknown management method &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">T.pack</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679322722"><span class="hs-identifier hs-var">method</span></a></span><span>
</span><span id="line-461"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-462"></span><span>    </span><span class="annot"><span class="annottext">((RejectCode, String) -&gt; m ())
-&gt; (forall (m' :: * -&gt; *). (CanReject m', ICM m') =&gt; m' ()) -&gt; m ()
forall (m :: * -&gt; *) b.
ICM m =&gt;
((RejectCode, String) -&gt; m b)
-&gt; (forall (m' :: * -&gt; *). (CanReject m', ICM m') =&gt; m' b) -&gt; m b
</span><a href="IC.Ref.html#onReject"><span class="hs-identifier hs-var">onReject</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; m ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; m ())
-&gt; ((RejectCode, String) -&gt; Text) -&gt; (RejectCode, String) -&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">T.pack</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Text)
-&gt; ((RejectCode, String) -&gt; String) -&gt; (RejectCode, String) -&gt; Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(RejectCode, String) -&gt; String
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((forall (m' :: * -&gt; *). (CanReject m', ICM m') =&gt; m' ()) -&gt; m ())
-&gt; (forall (m' :: * -&gt; *). (CanReject m', ICM m') =&gt; m' ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-463"></span><span>        </span><span class="annot"><span class="annottext">EntityId -&gt; m' ()
forall (m :: * -&gt; *). (CanReject m, ICM m) =&gt; EntityId -&gt; m ()
</span><a href="IC.Ref.html#canisterMustExist"><span class="hs-identifier hs-var">canisterMustExist</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322724"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-464"></span><span>    </span><span class="annot"><span class="annottext">EntityId -&gt; m RunStatus
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; m RunStatus
</span><a href="IC.Ref.html#getRunStatus"><span class="hs-identifier hs-var">getRunStatus</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322724"><span class="hs-identifier hs-var">canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">m RunStatus -&gt; (RunStatus -&gt; m ()) -&gt; m ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-465"></span><span>       </span><span class="annot"><a href="IC.Ref.html#IsRunning"><span class="hs-identifier hs-type">IsRunning</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-466"></span><span>       </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text -&gt; m ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="hs-string">&quot;canister is stopped&quot;</span></span><span>
</span><span id="line-467"></span><span>    </span><span id="local-6989586621679322712"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679322712"><span class="hs-identifier hs-var">empty</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; m Bool
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; m Bool
</span><a href="IC.Ref.html#isCanisterEmpty"><span class="hs-identifier hs-var">isCanisterEmpty</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322724"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-468"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679322712"><span class="hs-identifier hs-var">empty</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; m ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="hs-string">&quot;canister is empty&quot;</span></span><span>
</span><span id="line-469"></span><span>    </span><span id="local-6989586621679322711"><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679322711"><span class="hs-identifier hs-var">wasm_state</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; m WasmState
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; m WasmState
</span><a href="IC.Ref.html#getCanisterState"><span class="hs-identifier hs-var">getCanisterState</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322724"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-470"></span><span>    </span><span id="local-6989586621679322710"><span class="annot"><span class="annottext">CanisterModule
</span><a href="#local-6989586621679322710"><span class="hs-identifier hs-var">can_mod</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; m CanisterModule
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; m CanisterModule
</span><a href="IC.Ref.html#getCanisterMod"><span class="hs-identifier hs-var">getCanisterMod</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322724"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-471"></span><span>    </span><span id="local-6989586621679322709"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679322709"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; m Env
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; m Env
</span><a href="IC.Ref.html#canisterEnv"><span class="hs-identifier hs-var">canisterEnv</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322724"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-472"></span><span>
</span><span id="line-473"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CanisterModule
-&gt; String -&gt; EntityId -&gt; Env -&gt; Blob -&gt; WasmState -&gt; TrapOr ()
</span><a href="IC.Canister.html#inspect_message"><span class="hs-identifier hs-var hs-var">inspect_message</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterModule
</span><a href="#local-6989586621679322710"><span class="hs-identifier hs-var">can_mod</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679322722"><span class="hs-identifier hs-var">method</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322723"><span class="hs-identifier hs-var">user_id</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679322709"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679322721"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679322711"><span class="hs-identifier hs-var">wasm_state</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-474"></span><span>      </span><span class="annot"><a href="IC.Types.html#Trap"><span class="hs-identifier hs-type">Trap</span></a></span><span> </span><span id="local-6989586621679322707"><span class="annot"><span class="annottext">msg :: String
</span><a href="#local-6989586621679322707"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text -&gt; m ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; m ()) -&gt; Text -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;canister trapped in inspect_message: &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">T.pack</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679322707"><span class="hs-identifier hs-var">msg</span></a></span><span>
</span><span id="line-475"></span><span>      </span><span class="annot"><a href="IC.Types.html#Return"><span class="hs-identifier hs-type">Return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-476"></span><span>
</span><span id="line-477"></span><span class="hs-comment">-- The state tree</span><span>
</span><span id="line-478"></span><span>
</span><span id="line-479"></span><span class="annot"><a href="IC.Ref.html#stateTree"><span class="hs-identifier hs-type">stateTree</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Types.html#Timestamp"><span class="hs-identifier hs-type">Timestamp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Ref.html#IC"><span class="hs-identifier hs-type">IC</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.HashTree.html#LabeledTree"><span class="hs-identifier hs-type">LabeledTree</span></a></span><span>
</span><span id="line-480"></span><span id="stateTree"><span class="annot"><span class="annottext">stateTree :: Timestamp -&gt; IC -&gt; LabeledTree
</span><a href="IC.Ref.html#stateTree"><span class="hs-identifier hs-var hs-var">stateTree</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Types.html#Timestamp"><span class="hs-identifier hs-type">Timestamp</span></a></span><span> </span><span id="local-6989586621679322704"><span class="annot"><span class="annottext">t :: Natural
</span><a href="#local-6989586621679322704"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679322703"><span class="annot"><span class="annottext">ic :: IC
</span><a href="#local-6989586621679322703"><span class="hs-identifier hs-var">ic</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Map Blob LabeledTree] -&gt; LabeledTree
</span><a href="#local-6989586621679322702"><span class="hs-identifier hs-var">node</span></a></span><span>
</span><span id="line-481"></span><span>  </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="hs-string">&quot;time&quot;</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree -&gt; Map Blob LabeledTree
forall k a. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679322701"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; LabeledTree
forall a. CertVal a =&gt; a -&gt; LabeledTree
</span><a href="#local-6989586621679322700"><span class="hs-identifier hs-var">val</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679322704"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-482"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;request_status&quot;</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree -&gt; Map Blob LabeledTree
forall k a. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679322701"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">[Map Blob LabeledTree] -&gt; LabeledTree
</span><a href="#local-6989586621679322702"><span class="hs-identifier hs-var">node</span></a></span><span>
</span><span id="line-483"></span><span>    </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679322699"><span class="hs-identifier hs-var">rid</span></a></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree -&gt; Map Blob LabeledTree
forall k a. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679322701"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">RequestStatus
</span><a href="#local-6989586621679322698"><span class="hs-identifier hs-var">rs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-484"></span><span>        </span><span class="annot"><a href="IC.Ref.html#Received"><span class="hs-identifier hs-type">Received</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Map Blob LabeledTree] -&gt; LabeledTree
</span><a href="#local-6989586621679322702"><span class="hs-identifier hs-var">node</span></a></span><span>
</span><span id="line-485"></span><span>          </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="hs-string">&quot;status&quot;</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree -&gt; Map Blob LabeledTree
forall k a. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679322701"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; LabeledTree
</span><a href="#local-6989586621679322697"><span class="hs-identifier hs-var">str</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;received&quot;</span></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-486"></span><span>        </span><span class="annot"><a href="IC.Ref.html#Processing"><span class="hs-identifier hs-type">Processing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Map Blob LabeledTree] -&gt; LabeledTree
</span><a href="#local-6989586621679322702"><span class="hs-identifier hs-var">node</span></a></span><span>
</span><span id="line-487"></span><span>          </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="hs-string">&quot;status&quot;</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree -&gt; Map Blob LabeledTree
forall k a. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679322701"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; LabeledTree
</span><a href="#local-6989586621679322697"><span class="hs-identifier hs-var">str</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;processing&quot;</span></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-488"></span><span>        </span><span class="annot"><a href="IC.Ref.html#CallResponse"><span class="hs-identifier hs-type">CallResponse</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Ref.html#Replied"><span class="hs-identifier hs-type">Replied</span></a></span><span> </span><span id="local-6989586621679322696"><span class="annot"><span class="annottext">r :: Blob
</span><a href="#local-6989586621679322696"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Map Blob LabeledTree] -&gt; LabeledTree
</span><a href="#local-6989586621679322702"><span class="hs-identifier hs-var">node</span></a></span><span>
</span><span id="line-489"></span><span>          </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="hs-string">&quot;status&quot;</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree -&gt; Map Blob LabeledTree
forall k a. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679322701"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; LabeledTree
</span><a href="#local-6989586621679322697"><span class="hs-identifier hs-var">str</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;replied&quot;</span></span><span>
</span><span id="line-490"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;reply&quot;</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree -&gt; Map Blob LabeledTree
forall k a. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679322701"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree
forall a. CertVal a =&gt; a -&gt; LabeledTree
</span><a href="#local-6989586621679322700"><span class="hs-identifier hs-var">val</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679322696"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-491"></span><span>          </span><span class="hs-special">]</span><span>
</span><span id="line-492"></span><span>        </span><span class="annot"><a href="IC.Ref.html#CallResponse"><span class="hs-identifier hs-type">CallResponse</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Ref.html#Rejected"><span class="hs-identifier hs-type">Rejected</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679322695"><span class="annot"><span class="annottext">c :: RejectCode
</span><a href="#local-6989586621679322695"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679322694"><span class="annot"><span class="annottext">msg :: String
</span><a href="#local-6989586621679322694"><span class="hs-identifier hs-var">msg</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Map Blob LabeledTree] -&gt; LabeledTree
</span><a href="#local-6989586621679322702"><span class="hs-identifier hs-var">node</span></a></span><span>
</span><span id="line-493"></span><span>          </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="hs-string">&quot;status&quot;</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree -&gt; Map Blob LabeledTree
forall k a. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679322701"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; LabeledTree
</span><a href="#local-6989586621679322697"><span class="hs-identifier hs-var">str</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;rejected&quot;</span></span><span>
</span><span id="line-494"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;reject_code&quot;</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree -&gt; Map Blob LabeledTree
forall k a. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679322701"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; LabeledTree
forall a. CertVal a =&gt; a -&gt; LabeledTree
</span><a href="#local-6989586621679322700"><span class="hs-identifier hs-var">val</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RejectCode -&gt; Natural
</span><a href="IC.Types.html#rejectCode"><span class="hs-identifier hs-var">rejectCode</span></a></span><span> </span><span class="annot"><span class="annottext">RejectCode
</span><a href="#local-6989586621679322695"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-495"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;reject_message&quot;</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree -&gt; Map Blob LabeledTree
forall k a. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679322701"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; LabeledTree
forall a. CertVal a =&gt; a -&gt; LabeledTree
</span><a href="#local-6989586621679322700"><span class="hs-identifier hs-var">val</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">T.pack</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679322694"><span class="hs-identifier hs-var">msg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-496"></span><span>          </span><span class="hs-special">]</span><span>
</span><span id="line-497"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679322699"><span class="annot"><span class="annottext">rid :: Blob
</span><a href="#local-6989586621679322699"><span class="hs-identifier hs-var">rid</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679322698"><span class="annot"><span class="annottext">rs :: RequestStatus
</span><a href="#local-6989586621679322698"><span class="hs-identifier hs-var">rs</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Blob &#8614; (CallRequest, RequestStatus))
-&gt; [(Blob, (CallRequest, RequestStatus))]
forall k a. Map k a -&gt; [(k, a)]
</span><span class="hs-identifier hs-var">M.toList</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IC -&gt; Blob &#8614; (CallRequest, RequestStatus)
</span><a href="IC.Ref.html#requests"><span class="hs-identifier hs-var hs-var">requests</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679322703"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-498"></span><span>    </span><span class="hs-special">]</span><span>
</span><span id="line-499"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;canister&quot;</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree -&gt; Map Blob LabeledTree
forall k a. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679322701"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">[Map Blob LabeledTree] -&gt; LabeledTree
</span><a href="#local-6989586621679322702"><span class="hs-identifier hs-var">node</span></a></span><span>
</span><span id="line-500"></span><span>    </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679322691"><span class="hs-identifier hs-var">cid</span></a></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree -&gt; Map Blob LabeledTree
forall k a. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679322701"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">[Map Blob LabeledTree] -&gt; LabeledTree
</span><a href="#local-6989586621679322702"><span class="hs-identifier hs-var">node</span></a></span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-501"></span><span>      </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="hs-string">&quot;certified_data&quot;</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree -&gt; Map Blob LabeledTree
forall k a. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679322701"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree
forall a. CertVal a =&gt; a -&gt; LabeledTree
</span><a href="#local-6989586621679322700"><span class="hs-identifier hs-var">val</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CanState -&gt; Blob
</span><a href="IC.Ref.html#certified_data"><span class="hs-identifier hs-var hs-var">certified_data</span></a></span><span> </span><span class="annot"><span class="annottext">CanState
</span><a href="#local-6989586621679322690"><span class="hs-identifier hs-var">cs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-502"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;controllers&quot;</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree -&gt; Map Blob LabeledTree
forall k a. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679322701"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree
forall a. CertVal a =&gt; a -&gt; LabeledTree
</span><a href="#local-6989586621679322700"><span class="hs-identifier hs-var">val</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[EntityId] -&gt; Blob
</span><a href="IC.CBOR.Utils.html#encodePrincipalList"><span class="hs-identifier hs-var">encodePrincipalList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set EntityId -&gt; [EntityId]
forall a. Set a -&gt; [a]
</span><span class="hs-identifier hs-var">S.toList</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CanState -&gt; Set EntityId
</span><a href="IC.Ref.html#controllers"><span class="hs-identifier hs-var hs-var">controllers</span></a></span><span> </span><span class="annot"><span class="annottext">CanState
</span><a href="#local-6989586621679322690"><span class="hs-identifier hs-var">cs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-503"></span><span>      </span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[Map Blob LabeledTree]
-&gt; [Map Blob LabeledTree] -&gt; [Map Blob LabeledTree]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span>
</span><span id="line-504"></span><span>      </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="hs-string">&quot;module_hash&quot;</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree -&gt; Map Blob LabeledTree
forall k a. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679322701"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree
forall a. CertVal a =&gt; a -&gt; LabeledTree
</span><a href="#local-6989586621679322700"><span class="hs-identifier hs-var">val</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679322687"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679322687"><span class="annot"><span class="annottext">h :: Blob
</span><a href="#local-6989586621679322687"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe Blob -&gt; [Maybe Blob]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Blob -&gt; [Maybe Blob]) -&gt; Maybe Blob -&gt; [Maybe Blob]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CanState -&gt; Maybe Blob
</span><a href="IC.Ref.html#module_hash"><span class="hs-identifier hs-var">module_hash</span></a></span><span> </span><span class="annot"><span class="annottext">CanState
</span><a href="#local-6989586621679322690"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-505"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-506"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Types.html#EntityId"><span class="hs-identifier hs-type">EntityId</span></a></span><span> </span><span id="local-6989586621679322691"><span class="annot"><span class="annottext">cid :: Blob
</span><a href="#local-6989586621679322691"><span class="hs-identifier hs-var">cid</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679322690"><span class="annot"><span class="annottext">cs :: CanState
</span><a href="#local-6989586621679322690"><span class="hs-identifier hs-var">cs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(EntityId &#8614; CanState) -&gt; [(EntityId, CanState)]
forall k a. Map k a -&gt; [(k, a)]
</span><span class="hs-identifier hs-var">M.toList</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IC -&gt; EntityId &#8614; CanState
</span><a href="IC.Ref.html#canisters"><span class="hs-identifier hs-var hs-var">canisters</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679322703"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-507"></span><span>    </span><span class="hs-special">]</span><span>
</span><span id="line-508"></span><span>  </span><span class="hs-special">]</span><span>
</span><span id="line-509"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-510"></span><span>    </span><span id="local-6989586621679322702"><span class="annot"><span class="annottext">node :: [Map Blob LabeledTree] -&gt; LabeledTree
</span><a href="#local-6989586621679322702"><span class="hs-identifier hs-var hs-var">node</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map Blob LabeledTree -&gt; LabeledTree
</span><a href="IC.HashTree.html#SubTrees"><span class="hs-identifier hs-var">SubTrees</span></a></span><span> </span><span class="annot"><span class="annottext">(Map Blob LabeledTree -&gt; LabeledTree)
-&gt; ([Map Blob LabeledTree] -&gt; Map Blob LabeledTree)
-&gt; [Map Blob LabeledTree]
-&gt; LabeledTree
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[Map Blob LabeledTree] -&gt; Map Blob LabeledTree
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span>
</span><span id="line-511"></span><span>    </span><span id="local-6989586621679323361"><span class="annot"><a href="#local-6989586621679322700"><span class="hs-identifier hs-type">val</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Certificate.Value.html#CertVal"><span class="hs-identifier hs-type">CertVal</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323361"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323361"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.HashTree.html#LabeledTree"><span class="hs-identifier hs-type">LabeledTree</span></a></span></span><span>
</span><span id="line-512"></span><span>    </span><span id="local-6989586621679322700"><span class="annot"><span class="annottext">val :: a -&gt; LabeledTree
</span><a href="#local-6989586621679322700"><span class="hs-identifier hs-var hs-var">val</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree
</span><a href="IC.HashTree.html#Value"><span class="hs-identifier hs-var">Value</span></a></span><span> </span><span class="annot"><span class="annottext">(Blob -&gt; LabeledTree) -&gt; (a -&gt; Blob) -&gt; a -&gt; LabeledTree
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Blob
forall a. CertVal a =&gt; a -&gt; Blob
</span><a href="IC.Certificate.Value.html#toCertVal"><span class="hs-identifier hs-var">toCertVal</span></a></span><span>
</span><span id="line-513"></span><span>    </span><span id="local-6989586621679322697"><span class="annot"><span class="annottext">str :: Text -&gt; LabeledTree
</span><a href="#local-6989586621679322697"><span class="hs-identifier hs-var hs-var">str</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CertVal Text =&gt; Text -&gt; LabeledTree
forall a. CertVal a =&gt; a -&gt; LabeledTree
</span><a href="#local-6989586621679322700"><span class="hs-identifier hs-var">val</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-identifier hs-type">T.Text</span></span><span>
</span><span id="line-514"></span><span>    </span><span id="local-6989586621679322701"><span class="annot"><span class="annottext">=: :: k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679322701"><span class="hs-operator hs-var hs-var">(=:)</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">k -&gt; a -&gt; Map k a
forall k a. k -&gt; a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.singleton</span></span><span>
</span><span id="line-515"></span><span>
</span><span id="line-516"></span><span class="annot"><a href="IC.Ref.html#delegationTree"><span class="hs-identifier hs-type">delegationTree</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Types.html#Timestamp"><span class="hs-identifier hs-type">Timestamp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#SubnetId"><span class="hs-identifier hs-type">SubnetId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.HashTree.html#LabeledTree"><span class="hs-identifier hs-type">LabeledTree</span></a></span><span>
</span><span id="line-517"></span><span id="delegationTree"><span class="annot"><span class="annottext">delegationTree :: Timestamp -&gt; EntityId -&gt; Blob -&gt; LabeledTree
</span><a href="IC.Ref.html#delegationTree"><span class="hs-identifier hs-var hs-var">delegationTree</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Types.html#Timestamp"><span class="hs-identifier hs-type">Timestamp</span></a></span><span> </span><span id="local-6989586621679322680"><span class="annot"><span class="annottext">t :: Natural
</span><a href="#local-6989586621679322680"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Types.html#EntityId"><span class="hs-identifier hs-type">EntityId</span></a></span><span> </span><span id="local-6989586621679322679"><span class="annot"><span class="annottext">subnet_id :: Blob
</span><a href="#local-6989586621679322679"><span class="hs-identifier hs-var">subnet_id</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679322678"><span class="annot"><span class="annottext">subnet_pub_key :: Blob
</span><a href="#local-6989586621679322678"><span class="hs-identifier hs-var">subnet_pub_key</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Map Blob LabeledTree] -&gt; LabeledTree
</span><a href="#local-6989586621679322677"><span class="hs-identifier hs-var">node</span></a></span><span>
</span><span id="line-518"></span><span>  </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="hs-string">&quot;time&quot;</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree -&gt; Map Blob LabeledTree
forall k a. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679322676"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; LabeledTree
forall a. CertVal a =&gt; a -&gt; LabeledTree
</span><a href="#local-6989586621679322675"><span class="hs-identifier hs-var">val</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679322680"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-519"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;subnet&quot;</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree -&gt; Map Blob LabeledTree
forall k a. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679322676"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">[Map Blob LabeledTree] -&gt; LabeledTree
</span><a href="#local-6989586621679322677"><span class="hs-identifier hs-var">node</span></a></span><span>
</span><span id="line-520"></span><span>    </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679322679"><span class="hs-identifier hs-var">subnet_id</span></a></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree -&gt; Map Blob LabeledTree
forall k a. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679322676"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">[Map Blob LabeledTree] -&gt; LabeledTree
</span><a href="#local-6989586621679322677"><span class="hs-identifier hs-var">node</span></a></span><span>
</span><span id="line-521"></span><span>          </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="hs-string">&quot;public_key&quot;</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree -&gt; Map Blob LabeledTree
forall k a. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679322676"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree
forall a. CertVal a =&gt; a -&gt; LabeledTree
</span><a href="#local-6989586621679322675"><span class="hs-identifier hs-var">val</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679322678"><span class="hs-identifier hs-var">subnet_pub_key</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-522"></span><span>    </span><span class="hs-special">]</span><span>
</span><span id="line-523"></span><span>  </span><span class="hs-special">]</span><span>
</span><span id="line-524"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-525"></span><span>    </span><span id="local-6989586621679322677"><span class="annot"><span class="annottext">node :: [Map Blob LabeledTree] -&gt; LabeledTree
</span><a href="#local-6989586621679322677"><span class="hs-identifier hs-var hs-var">node</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map Blob LabeledTree -&gt; LabeledTree
</span><a href="IC.HashTree.html#SubTrees"><span class="hs-identifier hs-var">SubTrees</span></a></span><span> </span><span class="annot"><span class="annottext">(Map Blob LabeledTree -&gt; LabeledTree)
-&gt; ([Map Blob LabeledTree] -&gt; Map Blob LabeledTree)
-&gt; [Map Blob LabeledTree]
-&gt; LabeledTree
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[Map Blob LabeledTree] -&gt; Map Blob LabeledTree
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span>
</span><span id="line-526"></span><span>    </span><span id="local-6989586621679322674"><span class="annot"><a href="#local-6989586621679322675"><span class="hs-identifier hs-type">val</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Certificate.Value.html#CertVal"><span class="hs-identifier hs-type">CertVal</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679322674"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679322674"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.HashTree.html#LabeledTree"><span class="hs-identifier hs-type">LabeledTree</span></a></span></span><span>
</span><span id="line-527"></span><span>    </span><span id="local-6989586621679322675"><span class="annot"><span class="annottext">val :: a -&gt; LabeledTree
</span><a href="#local-6989586621679322675"><span class="hs-identifier hs-var hs-var">val</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree
</span><a href="IC.HashTree.html#Value"><span class="hs-identifier hs-var">Value</span></a></span><span> </span><span class="annot"><span class="annottext">(Blob -&gt; LabeledTree) -&gt; (a -&gt; Blob) -&gt; a -&gt; LabeledTree
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Blob
forall a. CertVal a =&gt; a -&gt; Blob
</span><a href="IC.Certificate.Value.html#toCertVal"><span class="hs-identifier hs-var">toCertVal</span></a></span><span>
</span><span id="line-528"></span><span>    </span><span id="local-6989586621679322676"><span class="annot"><span class="annottext">=: :: k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679322676"><span class="hs-operator hs-var hs-var">(=:)</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">k -&gt; a -&gt; Map k a
forall k a. k -&gt; a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.singleton</span></span><span>
</span><span id="line-529"></span><span>
</span><span id="line-530"></span><span id="local-6989586621679323391"><span class="annot"><a href="IC.Ref.html#getPrunedCertificate"><span class="hs-identifier hs-type">getPrunedCertificate</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323391"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#Timestamp"><span class="hs-identifier hs-type">Timestamp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="IC.HashTree.html#Path"><span class="hs-identifier hs-type">Path</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323391"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="IC.Certificate.html#Certificate"><span class="hs-identifier hs-type">Certificate</span></a></span></span><span>
</span><span id="line-531"></span><span id="getPrunedCertificate"><span class="annot"><span class="annottext">getPrunedCertificate :: Timestamp -&gt; [Path] -&gt; m Certificate
</span><a href="IC.Ref.html#getPrunedCertificate"><span class="hs-identifier hs-var hs-var">getPrunedCertificate</span></a></span></span><span> </span><span id="local-6989586621679322673"><span class="annot"><span class="annottext">time :: Timestamp
</span><a href="#local-6989586621679322673"><span class="hs-identifier hs-var">time</span></a></span></span><span> </span><span id="local-6989586621679322672"><span class="annot"><span class="annottext">paths :: [Path]
</span><a href="#local-6989586621679322672"><span class="hs-identifier hs-var">paths</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-532"></span><span>    </span><span id="local-6989586621679322671"><span class="annot"><span class="annottext">HashTree
</span><a href="#local-6989586621679322671"><span class="hs-identifier hs-var">full_tree</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(IC -&gt; HashTree) -&gt; m HashTree
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LabeledTree -&gt; HashTree
</span><a href="IC.HashTree.html#construct"><span class="hs-identifier hs-var">construct</span></a></span><span> </span><span class="annot"><span class="annottext">(LabeledTree -&gt; HashTree) -&gt; (IC -&gt; LabeledTree) -&gt; IC -&gt; HashTree
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Timestamp -&gt; IC -&gt; LabeledTree
</span><a href="IC.Ref.html#stateTree"><span class="hs-identifier hs-var">stateTree</span></a></span><span> </span><span class="annot"><span class="annottext">Timestamp
</span><a href="#local-6989586621679322673"><span class="hs-identifier hs-var">time</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-533"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679322669"><span class="annot"><span class="annottext">cert_tree :: HashTree
</span><a href="#local-6989586621679322669"><span class="hs-identifier hs-var hs-var">cert_tree</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HashTree -&gt; [Path] -&gt; HashTree
</span><a href="IC.HashTree.html#prune"><span class="hs-identifier hs-var">prune</span></a></span><span> </span><span class="annot"><span class="annottext">HashTree
</span><a href="#local-6989586621679322671"><span class="hs-identifier hs-var">full_tree</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><span class="hs-string">&quot;time&quot;</span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Path -&gt; [Path] -&gt; [Path]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[Path]
</span><a href="#local-6989586621679322672"><span class="hs-identifier hs-var">paths</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-534"></span><span>    </span><span id="local-6989586621679322667"><span class="annot"><span class="annottext">SecretKey
</span><a href="#local-6989586621679322667"><span class="hs-identifier hs-var">sk1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(IC -&gt; SecretKey) -&gt; m SecretKey
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">IC -&gt; SecretKey
</span><a href="IC.Ref.html#secretRootKey"><span class="hs-identifier hs-var hs-var">secretRootKey</span></a></span><span>
</span><span id="line-535"></span><span>    </span><span id="local-6989586621679322666"><span class="annot"><span class="annottext">SecretKey
</span><a href="#local-6989586621679322666"><span class="hs-identifier hs-var">sk2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(IC -&gt; SecretKey) -&gt; m SecretKey
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">IC -&gt; SecretKey
</span><a href="IC.Ref.html#secretSubnetKey"><span class="hs-identifier hs-var hs-var">secretSubnetKey</span></a></span><span>
</span><span id="line-536"></span><span>    </span><span class="annot"><span class="annottext">Certificate -&gt; m Certificate
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Certificate -&gt; m Certificate) -&gt; Certificate -&gt; m Certificate
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Timestamp
-&gt; SecretKey
-&gt; Maybe (EntityId, SecretKey)
-&gt; HashTree
-&gt; Certificate
</span><a href="IC.Ref.html#signCertificate"><span class="hs-identifier hs-var">signCertificate</span></a></span><span> </span><span class="annot"><span class="annottext">Timestamp
</span><a href="#local-6989586621679322673"><span class="hs-identifier hs-var">time</span></a></span><span> </span><span class="annot"><span class="annottext">SecretKey
</span><a href="#local-6989586621679322667"><span class="hs-identifier hs-var">sk1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(EntityId, SecretKey) -&gt; Maybe (EntityId, SecretKey)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322664"><span class="hs-identifier hs-var">fake_subnet_id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SecretKey
</span><a href="#local-6989586621679322666"><span class="hs-identifier hs-var">sk2</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">HashTree
</span><a href="#local-6989586621679322669"><span class="hs-identifier hs-var">cert_tree</span></a></span><span>
</span><span id="line-537"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-538"></span><span>    </span><span id="local-6989586621679322664"><span class="annot"><span class="annottext">fake_subnet_id :: EntityId
</span><a href="#local-6989586621679322664"><span class="hs-identifier hs-var hs-var">fake_subnet_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Blob -&gt; EntityId
</span><a href="IC.Types.html#EntityId"><span class="hs-identifier hs-var">EntityId</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;\x01&quot;</span></span><span>
</span><span id="line-539"></span><span>
</span><span id="line-540"></span><span class="annot"><a href="IC.Ref.html#signCertificate"><span class="hs-identifier hs-type">signCertificate</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Types.html#Timestamp"><span class="hs-identifier hs-type">Timestamp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Crypto.html#SecretKey"><span class="hs-identifier hs-type">SecretKey</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Types.html#SubnetId"><span class="hs-identifier hs-type">SubnetId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Crypto.html#SecretKey"><span class="hs-identifier hs-type">SecretKey</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.HashTree.html#HashTree"><span class="hs-identifier hs-type">HashTree</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Certificate.html#Certificate"><span class="hs-identifier hs-type">Certificate</span></a></span><span>
</span><span id="line-541"></span><span id="signCertificate"><span class="annot"><span class="annottext">signCertificate :: Timestamp
-&gt; SecretKey
-&gt; Maybe (EntityId, SecretKey)
-&gt; HashTree
-&gt; Certificate
</span><a href="IC.Ref.html#signCertificate"><span class="hs-identifier hs-var hs-var">signCertificate</span></a></span></span><span> </span><span id="local-6989586621679322663"><span class="annot"><span class="annottext">time :: Timestamp
</span><a href="#local-6989586621679322663"><span class="hs-identifier hs-var">time</span></a></span></span><span> </span><span id="local-6989586621679322662"><span class="annot"><span class="annottext">rootKey :: SecretKey
</span><a href="#local-6989586621679322662"><span class="hs-identifier hs-var">rootKey</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679322661"><span class="annot"><span class="annottext">subnet_id :: EntityId
</span><a href="#local-6989586621679322661"><span class="hs-identifier hs-var">subnet_id</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679322660"><span class="annot"><span class="annottext">subnet_key :: SecretKey
</span><a href="#local-6989586621679322660"><span class="hs-identifier hs-var">subnet_key</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span id="local-6989586621679322659"><span class="annot"><span class="annottext">cert_tree :: HashTree
</span><a href="#local-6989586621679322659"><span class="hs-identifier hs-var">cert_tree</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-542"></span><span>    </span><span class="annot"><span class="annottext">Certificate :: HashTree -&gt; Blob -&gt; Maybe Delegation -&gt; Certificate
</span><a href="IC.Certificate.html#Certificate"><span class="hs-identifier hs-type hs-type">Certificate</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">HashTree
cert_tree :: HashTree
cert_tree :: HashTree
</span><a href="IC.Certificate.html#cert_tree"><span class="hs-identifier hs-var hs-var">cert_tree</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Blob
cert_sig :: Blob
cert_sig :: Blob
</span><a href="IC.Certificate.html#cert_sig"><span class="hs-identifier hs-var hs-var">cert_sig</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe Delegation
cert_delegation :: Maybe Delegation
cert_delegation :: Maybe Delegation
</span><a href="IC.Certificate.html#cert_delegation"><span class="hs-identifier hs-var hs-var">cert_delegation</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-543"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-544"></span><span>    </span><span id="local-6989586621679322655"><span class="annot"><span class="annottext">cert_sig :: Blob
</span><a href="#local-6989586621679322655"><span class="hs-identifier hs-var hs-var">cert_sig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Blob -&gt; SecretKey -&gt; Blob -&gt; Blob
</span><a href="IC.Crypto.html#signPure"><span class="hs-identifier hs-var">signPure</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;ic-state-root&quot;</span></span><span> </span><span class="annot"><span class="annottext">SecretKey
</span><a href="#local-6989586621679322660"><span class="hs-identifier hs-var">subnet_key</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashTree -&gt; Blob
</span><a href="IC.HashTree.html#reconstruct"><span class="hs-identifier hs-var">reconstruct</span></a></span><span> </span><span class="annot"><span class="annottext">HashTree
</span><a href="#local-6989586621679322659"><span class="hs-identifier hs-var">cert_tree</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-545"></span><span>    </span><span id="local-6989586621679322653"><span class="annot"><span class="annottext">cert_delegation :: Maybe Delegation
</span><a href="#local-6989586621679322653"><span class="hs-identifier hs-var hs-var">cert_delegation</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Delegation -&gt; Maybe Delegation
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Delegation -&gt; Maybe Delegation) -&gt; Delegation -&gt; Maybe Delegation
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Delegation :: Blob -&gt; Blob -&gt; Delegation
</span><a href="IC.Certificate.html#Delegation"><span class="hs-identifier hs-type hs-type">Delegation</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">Blob
del_subnet_id :: Blob
del_subnet_id :: Blob
</span><a href="IC.Certificate.html#del_subnet_id"><span class="hs-identifier hs-var hs-var">del_subnet_id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Blob
del_certificate :: Blob
del_certificate :: Blob
</span><a href="IC.Certificate.html#del_certificate"><span class="hs-identifier hs-var hs-var">del_certificate</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-546"></span><span>    </span><span id="local-6989586621679322647"><span class="annot"><span class="annottext">del_subnet_id :: Blob
</span><a href="#local-6989586621679322647"><span class="hs-identifier hs-var hs-var">del_subnet_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; Blob
</span><a href="IC.Types.html#rawEntityId"><span class="hs-identifier hs-var hs-var">rawEntityId</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322661"><span class="hs-identifier hs-var">subnet_id</span></a></span><span>
</span><span id="line-547"></span><span>    </span><span id="local-6989586621679322645"><span class="annot"><span class="annottext">del_certificate :: Blob
</span><a href="#local-6989586621679322645"><span class="hs-identifier hs-var hs-var">del_certificate</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-548"></span><span>      </span><span class="annot"><span class="annottext">Certificate -&gt; Blob
</span><a href="IC.Certificate.CBOR.html#encodeCert"><span class="hs-identifier hs-var">encodeCert</span></a></span><span> </span><span class="annot"><span class="annottext">(Certificate -&gt; Blob) -&gt; Certificate -&gt; Blob
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-549"></span><span>      </span><span class="annot"><span class="annottext">Timestamp
-&gt; SecretKey
-&gt; Maybe (EntityId, SecretKey)
-&gt; HashTree
-&gt; Certificate
</span><a href="IC.Ref.html#signCertificate"><span class="hs-identifier hs-var">signCertificate</span></a></span><span> </span><span class="annot"><span class="annottext">Timestamp
</span><a href="#local-6989586621679322663"><span class="hs-identifier hs-var">time</span></a></span><span> </span><span class="annot"><span class="annottext">SecretKey
</span><a href="#local-6989586621679322662"><span class="hs-identifier hs-var">rootKey</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (EntityId, SecretKey)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">(HashTree -&gt; Certificate) -&gt; HashTree -&gt; Certificate
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-550"></span><span>      </span><span class="annot"><span class="annottext">LabeledTree -&gt; HashTree
</span><a href="IC.HashTree.html#construct"><span class="hs-identifier hs-var">construct</span></a></span><span> </span><span class="annot"><span class="annottext">(LabeledTree -&gt; HashTree) -&gt; LabeledTree -&gt; HashTree
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-551"></span><span>      </span><span class="annot"><span class="annottext">Timestamp -&gt; EntityId -&gt; Blob -&gt; LabeledTree
</span><a href="IC.Ref.html#delegationTree"><span class="hs-identifier hs-var">delegationTree</span></a></span><span> </span><span class="annot"><span class="annottext">Timestamp
</span><a href="#local-6989586621679322663"><span class="hs-identifier hs-var">time</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322661"><span class="hs-identifier hs-var">subnet_id</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SecretKey -&gt; Blob
</span><a href="IC.Crypto.html#toPublicKey"><span class="hs-identifier hs-var">toPublicKey</span></a></span><span> </span><span class="annot"><span class="annottext">SecretKey
</span><a href="#local-6989586621679322660"><span class="hs-identifier hs-var">subnet_key</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-552"></span><span>
</span><span id="line-553"></span><span class="annot"><a href="IC.Ref.html#signCertificate"><span class="hs-identifier hs-var">signCertificate</span></a></span><span> </span><span id="local-6989586621679322640"><span class="annot"><span class="annottext">_time :: Timestamp
</span><a href="#local-6989586621679322640"><span class="hs-identifier hs-var">_time</span></a></span></span><span> </span><span id="local-6989586621679322639"><span class="annot"><span class="annottext">rootKey :: SecretKey
</span><a href="#local-6989586621679322639"><span class="hs-identifier hs-var">rootKey</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span id="local-6989586621679322638"><span class="annot"><span class="annottext">cert_tree :: HashTree
</span><a href="#local-6989586621679322638"><span class="hs-identifier hs-var">cert_tree</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-554"></span><span>    </span><span class="annot"><span class="annottext">Certificate :: HashTree -&gt; Blob -&gt; Maybe Delegation -&gt; Certificate
</span><a href="IC.Certificate.html#Certificate"><span class="hs-identifier hs-type hs-type">Certificate</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">HashTree
cert_tree :: HashTree
cert_tree :: HashTree
</span><a href="#local-6989586621679322638"><span class="hs-identifier hs-var hs-var">cert_tree</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Blob
cert_sig :: Blob
cert_sig :: Blob
</span><a href="#local-6989586621679322637"><span class="hs-identifier hs-var hs-var">cert_sig</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cert_delegation :: Maybe Delegation
</span><a href="IC.Certificate.html#cert_delegation"><span class="hs-identifier hs-var">cert_delegation</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Delegation
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-555"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-556"></span><span>    </span><span id="local-6989586621679322637"><span class="annot"><span class="annottext">cert_sig :: Blob
</span><a href="#local-6989586621679322637"><span class="hs-identifier hs-var hs-var">cert_sig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Blob -&gt; SecretKey -&gt; Blob -&gt; Blob
</span><a href="IC.Crypto.html#signPure"><span class="hs-identifier hs-var">signPure</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;ic-state-root&quot;</span></span><span> </span><span class="annot"><span class="annottext">SecretKey
</span><a href="#local-6989586621679322639"><span class="hs-identifier hs-var">rootKey</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashTree -&gt; Blob
</span><a href="IC.HashTree.html#reconstruct"><span class="hs-identifier hs-var">reconstruct</span></a></span><span> </span><span class="annot"><span class="annottext">HashTree
</span><a href="#local-6989586621679322638"><span class="hs-identifier hs-var">cert_tree</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-557"></span><span>
</span><span id="line-558"></span><span class="hs-comment">-- If `stateTree` ever becomes a bottleneck:</span><span>
</span><span id="line-559"></span><span class="hs-comment">-- Since ic-ref creates a fresh state tree everytime it is used, we _could_</span><span>
</span><span id="line-560"></span><span class="hs-comment">-- construct one with just the required data, e.g. only of the canister in</span><span>
</span><span id="line-561"></span><span class="hs-comment">-- question. That would not be secure, but `ic-ref` doesn&#8217;t have to be.</span><span>
</span><span id="line-562"></span><span id="local-6989586621679323396"><span class="annot"><a href="IC.Ref.html#getDataCertificate"><span class="hs-identifier hs-type">getDataCertificate</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323396"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#Timestamp"><span class="hs-identifier hs-type">Timestamp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323396"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="IC.Types.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span></span><span>
</span><span id="line-563"></span><span id="getDataCertificate"><span class="annot"><span class="annottext">getDataCertificate :: Timestamp -&gt; EntityId -&gt; m Blob
</span><a href="IC.Ref.html#getDataCertificate"><span class="hs-identifier hs-var hs-var">getDataCertificate</span></a></span></span><span> </span><span id="local-6989586621679322636"><span class="annot"><span class="annottext">t :: Timestamp
</span><a href="#local-6989586621679322636"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621679322635"><span class="annot"><span class="annottext">cid :: EntityId
</span><a href="#local-6989586621679322635"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-564"></span><span>    </span><span class="annot"><span class="annottext">Certificate -&gt; Blob
</span><a href="IC.Certificate.CBOR.html#encodeCert"><span class="hs-identifier hs-var">encodeCert</span></a></span><span> </span><span class="annot"><span class="annottext">(Certificate -&gt; Blob) -&gt; m Certificate -&gt; m Blob
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Timestamp -&gt; [Path] -&gt; m Certificate
forall (m :: * -&gt; *). ICM m =&gt; Timestamp -&gt; [Path] -&gt; m Certificate
</span><a href="IC.Ref.html#getPrunedCertificate"><span class="hs-identifier hs-var">getPrunedCertificate</span></a></span><span> </span><span class="annot"><span class="annottext">Timestamp
</span><a href="#local-6989586621679322636"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-565"></span><span>        </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="annot"><span class="hs-string">&quot;time&quot;</span></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-string">&quot;canister&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; Blob
</span><a href="IC.Types.html#rawEntityId"><span class="hs-identifier hs-var hs-var">rawEntityId</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322635"><span class="hs-identifier hs-var">cid</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;certified_data&quot;</span></span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><span id="line-566"></span><span>
</span><span id="line-567"></span><span class="hs-comment">-- Asynchronous requests</span><span>
</span><span id="line-568"></span><span>
</span><span id="line-569"></span><span class="hs-comment">-- | Submission simply enqueues requests</span><span>
</span><span id="line-570"></span><span>
</span><span id="line-571"></span><span id="local-6989586621679322634"><span class="annot"><a href="IC.Ref.html#submitRequest"><span class="hs-identifier hs-type">submitRequest</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679322634"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#RequestID"><span class="hs-identifier hs-type">RequestID</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Ref.html#CallRequest"><span class="hs-identifier hs-type">CallRequest</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679322634"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-572"></span><span id="submitRequest"><span class="annot"><span class="annottext">submitRequest :: Blob -&gt; CallRequest -&gt; m ()
</span><a href="IC.Ref.html#submitRequest"><span class="hs-identifier hs-var hs-var">submitRequest</span></a></span></span><span> </span><span id="local-6989586621679322633"><span class="annot"><span class="annottext">rid :: Blob
</span><a href="#local-6989586621679322633"><span class="hs-identifier hs-var">rid</span></a></span></span><span> </span><span id="local-6989586621679322632"><span class="annot"><span class="annottext">r :: CallRequest
</span><a href="#local-6989586621679322632"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(IC -&gt; IC) -&gt; m ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((IC -&gt; IC) -&gt; m ()) -&gt; (IC -&gt; IC) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679322631"><span class="annot"><span class="annottext">ic :: IC
</span><a href="#local-6989586621679322631"><span class="hs-identifier hs-var">ic</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-573"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Blob -&gt; (Blob &#8614; (CallRequest, RequestStatus)) -&gt; Bool
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Bool
</span><span class="hs-identifier hs-var">M.member</span></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679322633"><span class="hs-identifier hs-var">rid</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IC -&gt; Blob &#8614; (CallRequest, RequestStatus)
</span><a href="IC.Ref.html#requests"><span class="hs-identifier hs-var hs-var">requests</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679322631"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-574"></span><span>  </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679322631"><span class="hs-identifier hs-var">ic</span></a></span><span>
</span><span id="line-575"></span><span>  </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679322631"><span class="hs-identifier hs-var">ic</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">requests :: Blob &#8614; (CallRequest, RequestStatus)
</span><a href="IC.Ref.html#requests"><span class="hs-identifier hs-var">requests</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Blob
-&gt; (CallRequest, RequestStatus)
-&gt; (Blob &#8614; (CallRequest, RequestStatus))
-&gt; Blob &#8614; (CallRequest, RequestStatus)
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679322633"><span class="hs-identifier hs-var">rid</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CallRequest
</span><a href="#local-6989586621679322632"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RequestStatus
</span><a href="IC.Ref.html#Received"><span class="hs-identifier hs-var">Received</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IC -&gt; Blob &#8614; (CallRequest, RequestStatus)
</span><a href="IC.Ref.html#requests"><span class="hs-identifier hs-var hs-var">requests</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679322631"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-576"></span><span>
</span><span id="line-577"></span><span>
</span><span id="line-578"></span><span class="hs-comment">-- | Eventually, they are processed</span><span>
</span><span id="line-579"></span><span>
</span><span id="line-580"></span><span id="local-6989586621679323142"><span class="annot"><a href="IC.Ref.html#processRequest"><span class="hs-identifier hs-type">processRequest</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323142"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Types.html#RequestID"><span class="hs-identifier hs-type">RequestID</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#CallRequest"><span class="hs-identifier hs-type">CallRequest</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323142"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-581"></span><span id="processRequest"><span class="annot"><span class="annottext">processRequest :: (Blob, CallRequest) -&gt; m ()
</span><a href="IC.Ref.html#processRequest"><span class="hs-identifier hs-var hs-var">processRequest</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679322628"><span class="annot"><span class="annottext">rid :: Blob
</span><a href="#local-6989586621679322628"><span class="hs-identifier hs-var">rid</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#CallRequest"><span class="hs-identifier hs-type">CallRequest</span></a></span><span> </span><span id="local-6989586621679322627"><span class="annot"><span class="annottext">canister_id :: EntityId
</span><a href="#local-6989586621679322627"><span class="hs-identifier hs-var">canister_id</span></a></span></span><span> </span><span id="local-6989586621679322626"><span class="annot"><span class="annottext">_user_id :: EntityId
</span><a href="#local-6989586621679322626"><span class="hs-identifier hs-var">_user_id</span></a></span></span><span> </span><span id="local-6989586621679322625"><span class="annot"><span class="annottext">method :: String
</span><a href="#local-6989586621679322625"><span class="hs-identifier hs-var">method</span></a></span></span><span> </span><span id="local-6989586621679322624"><span class="annot"><span class="annottext">arg :: Blob
</span><a href="#local-6989586621679322624"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-582"></span><span>  </span><span class="annot"><span class="annottext">((RejectCode, String) -&gt; m ())
-&gt; (forall (m' :: * -&gt; *). (CanReject m', ICM m') =&gt; m' ()) -&gt; m ()
forall (m :: * -&gt; *) b.
ICM m =&gt;
((RejectCode, String) -&gt; m b)
-&gt; (forall (m' :: * -&gt; *). (CanReject m', ICM m') =&gt; m' b) -&gt; m b
</span><a href="IC.Ref.html#onReject"><span class="hs-identifier hs-var">onReject</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Blob -&gt; RequestStatus -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; Blob -&gt; RequestStatus -&gt; m ()
</span><a href="IC.Ref.html#setReqStatus"><span class="hs-identifier hs-var">setReqStatus</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679322628"><span class="hs-identifier hs-var">rid</span></a></span><span> </span><span class="annot"><span class="annottext">(RequestStatus -&gt; m ())
-&gt; ((RejectCode, String) -&gt; RequestStatus)
-&gt; (RejectCode, String)
-&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">CallResponse -&gt; RequestStatus
</span><a href="IC.Ref.html#CallResponse"><span class="hs-identifier hs-var">CallResponse</span></a></span><span> </span><span class="annot"><span class="annottext">(CallResponse -&gt; RequestStatus)
-&gt; ((RejectCode, String) -&gt; CallResponse)
-&gt; (RejectCode, String)
-&gt; RequestStatus
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span>  </span><span class="annot"><span class="annottext">(RejectCode, String) -&gt; CallResponse
</span><a href="IC.Ref.html#Rejected"><span class="hs-identifier hs-var">Rejected</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((forall (m' :: * -&gt; *). (CanReject m', ICM m') =&gt; m' ()) -&gt; m ())
-&gt; (forall (m' :: * -&gt; *). (CanReject m', ICM m') =&gt; m' ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-583"></span><span>    </span><span id="local-6989586621679322623"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322623"><span class="hs-identifier hs-var">ctxt_id</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CallContext -&gt; m' Int
forall (m :: * -&gt; *). ICM m =&gt; CallContext -&gt; m Int
</span><a href="IC.Ref.html#newCallContext"><span class="hs-identifier hs-var">newCallContext</span></a></span><span> </span><span class="annot"><span class="annottext">(CallContext -&gt; m' Int) -&gt; CallContext -&gt; m' Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CallContext :: EntityId
-&gt; CallOrigin
-&gt; Responded
-&gt; Bool
-&gt; Natural
-&gt; Maybe String
-&gt; CallContext
</span><a href="IC.Ref.html#CallContext"><span class="hs-identifier hs-type hs-type">CallContext</span></a></span><span>
</span><span id="line-584"></span><span>      </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">canister :: EntityId
</span><a href="IC.Ref.html#canister"><span class="hs-identifier hs-var">canister</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322627"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-585"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">origin :: CallOrigin
</span><a href="IC.Ref.html#origin"><span class="hs-identifier hs-var">origin</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Blob -&gt; CallOrigin
</span><a href="IC.Ref.html#FromUser"><span class="hs-identifier hs-var">FromUser</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679322628"><span class="hs-identifier hs-var">rid</span></a></span><span>
</span><span id="line-586"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">responded :: Responded
</span><a href="IC.Ref.html#responded"><span class="hs-identifier hs-var">responded</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Responded
</span><a href="IC.Types.html#Responded"><span class="hs-identifier hs-var">Responded</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-587"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">deleted :: Bool
</span><a href="IC.Ref.html#deleted"><span class="hs-identifier hs-var">deleted</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-588"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">last_trap :: Maybe String
</span><a href="IC.Ref.html#last_trap"><span class="hs-identifier hs-var">last_trap</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe String
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-589"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">available_cycles :: Natural
</span><a href="IC.Ref.html#available_cycles"><span class="hs-identifier hs-var">available_cycles</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-number">0</span></span><span>
</span><span id="line-590"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-591"></span><span>    </span><span class="annot"><span class="annottext">Message -&gt; m' ()
forall (m :: * -&gt; *). ICM m =&gt; Message -&gt; m ()
</span><a href="IC.Ref.html#enqueueMessage"><span class="hs-identifier hs-var">enqueueMessage</span></a></span><span> </span><span class="annot"><span class="annottext">(Message -&gt; m' ()) -&gt; Message -&gt; m' ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CallMessage :: Int -&gt; EntryPoint -&gt; Message
</span><a href="IC.Ref.html#CallMessage"><span class="hs-identifier hs-type hs-type">CallMessage</span></a></span><span>
</span><span id="line-592"></span><span>      </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">call_context :: Int
</span><a href="IC.Ref.html#call_context"><span class="hs-identifier hs-var">call_context</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322623"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span>
</span><span id="line-593"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">entry :: EntryPoint
</span><a href="IC.Ref.html#entry"><span class="hs-identifier hs-var">entry</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Blob -&gt; EntryPoint
</span><a href="IC.Ref.html#Public"><span class="hs-identifier hs-var">Public</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679322625"><span class="hs-identifier hs-var">method</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679322624"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-594"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-595"></span><span>    </span><span class="annot"><span class="annottext">Blob -&gt; RequestStatus -&gt; m' ()
forall (m :: * -&gt; *). ICM m =&gt; Blob -&gt; RequestStatus -&gt; m ()
</span><a href="IC.Ref.html#setReqStatus"><span class="hs-identifier hs-var">setReqStatus</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679322628"><span class="hs-identifier hs-var">rid</span></a></span><span> </span><span class="annot"><span class="annottext">RequestStatus
</span><a href="IC.Ref.html#Processing"><span class="hs-identifier hs-var">Processing</span></a></span><span>
</span><span id="line-596"></span><span>
</span><span id="line-597"></span><span class="hs-comment">-- Call context handling</span><span>
</span><span id="line-598"></span><span>
</span><span id="line-599"></span><span id="local-6989586621679323341"><span class="annot"><a href="IC.Ref.html#newCallContext"><span class="hs-identifier hs-type">newCallContext</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323341"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Ref.html#CallContext"><span class="hs-identifier hs-type">CallContext</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323341"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="IC.Ref.html#CallId"><span class="hs-identifier hs-type">CallId</span></a></span></span><span>
</span><span id="line-600"></span><span id="newCallContext"><span class="annot"><span class="annottext">newCallContext :: CallContext -&gt; m Int
</span><a href="IC.Ref.html#newCallContext"><span class="hs-identifier hs-var hs-var">newCallContext</span></a></span></span><span> </span><span id="local-6989586621679322617"><span class="annot"><span class="annottext">cc :: CallContext
</span><a href="#local-6989586621679322617"><span class="hs-identifier hs-var">cc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(IC -&gt; (Int, IC)) -&gt; m Int
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; (a, s)) -&gt; m a
</span><span class="hs-identifier hs-var">state</span></span><span> </span><span class="annot"><span class="annottext">((IC -&gt; (Int, IC)) -&gt; m Int) -&gt; (IC -&gt; (Int, IC)) -&gt; m Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679322615"><span class="annot"><span class="annottext">ic :: IC
</span><a href="#local-6989586621679322615"><span class="hs-identifier hs-var">ic</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-601"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679322614"><span class="annot"><span class="annottext">i :: Int
</span><a href="#local-6989586621679322614"><span class="hs-identifier hs-var hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Int &#8614; CallContext) -&gt; Int
forall a. Map Int a -&gt; Int
</span><a href="IC.Utils.html#freshKey"><span class="hs-identifier hs-var">freshKey</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IC -&gt; Int &#8614; CallContext
</span><a href="IC.Ref.html#call_contexts"><span class="hs-identifier hs-var hs-var">call_contexts</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679322615"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-602"></span><span>  </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322614"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679322615"><span class="hs-identifier hs-var">ic</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">call_contexts :: Int &#8614; CallContext
</span><a href="IC.Ref.html#call_contexts"><span class="hs-identifier hs-var">call_contexts</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; CallContext -&gt; (Int &#8614; CallContext) -&gt; Int &#8614; CallContext
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322614"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">CallContext
</span><a href="#local-6989586621679322617"><span class="hs-identifier hs-var">cc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IC -&gt; Int &#8614; CallContext
</span><a href="IC.Ref.html#call_contexts"><span class="hs-identifier hs-var hs-var">call_contexts</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679322615"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-603"></span><span>
</span><span id="line-604"></span><span id="local-6989586621679323329"><span class="annot"><a href="IC.Ref.html#getCallContext"><span class="hs-identifier hs-type">getCallContext</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323329"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Ref.html#CallId"><span class="hs-identifier hs-type">CallId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323329"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="IC.Ref.html#CallContext"><span class="hs-identifier hs-type">CallContext</span></a></span></span><span>
</span><span id="line-605"></span><span id="getCallContext"><span class="annot"><span class="annottext">getCallContext :: Int -&gt; m CallContext
</span><a href="IC.Ref.html#getCallContext"><span class="hs-identifier hs-var hs-var">getCallContext</span></a></span></span><span> </span><span id="local-6989586621679322611"><span class="annot"><span class="annottext">ctxt_id :: Int
</span><a href="#local-6989586621679322611"><span class="hs-identifier hs-var">ctxt_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(IC -&gt; CallContext) -&gt; m CallContext
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Int &#8614; CallContext) -&gt; Int -&gt; CallContext
forall k a. Ord k =&gt; Map k a -&gt; k -&gt; a
</span><span class="hs-operator hs-var">M.!</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322611"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((Int &#8614; CallContext) -&gt; CallContext)
-&gt; (IC -&gt; Int &#8614; CallContext) -&gt; IC -&gt; CallContext
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">IC -&gt; Int &#8614; CallContext
</span><a href="IC.Ref.html#call_contexts"><span class="hs-identifier hs-var hs-var">call_contexts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-606"></span><span>
</span><span id="line-607"></span><span id="local-6989586621679323327"><span class="annot"><a href="IC.Ref.html#modifyCallContext"><span class="hs-identifier hs-type">modifyCallContext</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323327"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Ref.html#CallId"><span class="hs-identifier hs-type">CallId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Ref.html#CallContext"><span class="hs-identifier hs-type">CallContext</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Ref.html#CallContext"><span class="hs-identifier hs-type">CallContext</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323327"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-608"></span><span id="modifyCallContext"><span class="annot"><span class="annottext">modifyCallContext :: Int -&gt; (CallContext -&gt; CallContext) -&gt; m ()
</span><a href="IC.Ref.html#modifyCallContext"><span class="hs-identifier hs-var hs-var">modifyCallContext</span></a></span></span><span> </span><span id="local-6989586621679322608"><span class="annot"><span class="annottext">ctxt_id :: Int
</span><a href="#local-6989586621679322608"><span class="hs-identifier hs-var">ctxt_id</span></a></span></span><span> </span><span id="local-6989586621679322607"><span class="annot"><span class="annottext">f :: CallContext -&gt; CallContext
</span><a href="#local-6989586621679322607"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(IC -&gt; IC) -&gt; m ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((IC -&gt; IC) -&gt; m ()) -&gt; (IC -&gt; IC) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679322606"><span class="annot"><span class="annottext">ic :: IC
</span><a href="#local-6989586621679322606"><span class="hs-identifier hs-var">ic</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-609"></span><span>  </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679322606"><span class="hs-identifier hs-var">ic</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">call_contexts :: Int &#8614; CallContext
</span><a href="IC.Ref.html#call_contexts"><span class="hs-identifier hs-var">call_contexts</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CallContext -&gt; CallContext)
-&gt; Int -&gt; (Int &#8614; CallContext) -&gt; Int &#8614; CallContext
forall k a. Ord k =&gt; (a -&gt; a) -&gt; k -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.adjust</span></span><span> </span><span class="annot"><span class="annottext">CallContext -&gt; CallContext
</span><a href="#local-6989586621679322607"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322608"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IC -&gt; Int &#8614; CallContext
</span><a href="IC.Ref.html#call_contexts"><span class="hs-identifier hs-var hs-var">call_contexts</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679322606"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-610"></span><span>
</span><span id="line-611"></span><span id="local-6989586621679323282"><span class="annot"><a href="IC.Ref.html#getCallContextCycles"><span class="hs-identifier hs-type">getCallContextCycles</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323282"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Ref.html#CallId"><span class="hs-identifier hs-type">CallId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323282"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="IC.Types.html#Cycles"><span class="hs-identifier hs-type">Cycles</span></a></span></span><span>
</span><span id="line-612"></span><span id="getCallContextCycles"><span class="annot"><span class="annottext">getCallContextCycles :: Int -&gt; m Natural
</span><a href="IC.Ref.html#getCallContextCycles"><span class="hs-identifier hs-var hs-var">getCallContextCycles</span></a></span></span><span> </span><span id="local-6989586621679322604"><span class="annot"><span class="annottext">ctxt_id :: Int
</span><a href="#local-6989586621679322604"><span class="hs-identifier hs-var">ctxt_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CallContext -&gt; Natural
</span><a href="IC.Ref.html#available_cycles"><span class="hs-identifier hs-var hs-var">available_cycles</span></a></span><span> </span><span class="annot"><span class="annottext">(CallContext -&gt; Natural) -&gt; m CallContext -&gt; m Natural
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; m CallContext
forall (m :: * -&gt; *). ICM m =&gt; Int -&gt; m CallContext
</span><a href="IC.Ref.html#getCallContext"><span class="hs-identifier hs-var">getCallContext</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322604"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span>
</span><span id="line-613"></span><span>
</span><span id="line-614"></span><span id="local-6989586621679323280"><span class="annot"><a href="IC.Ref.html#setCallContextCycles"><span class="hs-identifier hs-type">setCallContextCycles</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323280"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Ref.html#CallId"><span class="hs-identifier hs-type">CallId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#Cycles"><span class="hs-identifier hs-type">Cycles</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323280"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-615"></span><span id="setCallContextCycles"><span class="annot"><span class="annottext">setCallContextCycles :: Int -&gt; Natural -&gt; m ()
</span><a href="IC.Ref.html#setCallContextCycles"><span class="hs-identifier hs-var hs-var">setCallContextCycles</span></a></span></span><span> </span><span id="local-6989586621679322602"><span class="annot"><span class="annottext">ctxt_id :: Int
</span><a href="#local-6989586621679322602"><span class="hs-identifier hs-var">ctxt_id</span></a></span></span><span> </span><span id="local-6989586621679322601"><span class="annot"><span class="annottext">cycles :: Natural
</span><a href="#local-6989586621679322601"><span class="hs-identifier hs-var">cycles</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; (CallContext -&gt; CallContext) -&gt; m ()
forall (m :: * -&gt; *).
ICM m =&gt;
Int -&gt; (CallContext -&gt; CallContext) -&gt; m ()
</span><a href="IC.Ref.html#modifyCallContext"><span class="hs-identifier hs-var">modifyCallContext</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322602"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span> </span><span class="annot"><span class="annottext">((CallContext -&gt; CallContext) -&gt; m ())
-&gt; (CallContext -&gt; CallContext) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679322600"><span class="annot"><span class="annottext">ctxt :: CallContext
</span><a href="#local-6989586621679322600"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-616"></span><span>  </span><span class="annot"><span class="annottext">CallContext
</span><a href="#local-6989586621679322600"><span class="hs-identifier hs-var">ctxt</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">available_cycles :: Natural
</span><a href="IC.Ref.html#available_cycles"><span class="hs-identifier hs-var">available_cycles</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679322601"><span class="hs-identifier hs-var">cycles</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-617"></span><span>
</span><span id="line-618"></span><span id="local-6989586621679323324"><span class="annot"><a href="IC.Ref.html#respondCallContext"><span class="hs-identifier hs-type">respondCallContext</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323324"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Ref.html#CallId"><span class="hs-identifier hs-type">CallId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#Response"><span class="hs-identifier hs-type">Response</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323324"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-619"></span><span id="respondCallContext"><span class="annot"><span class="annottext">respondCallContext :: Int -&gt; Response -&gt; m ()
</span><a href="IC.Ref.html#respondCallContext"><span class="hs-identifier hs-var hs-var">respondCallContext</span></a></span></span><span> </span><span id="local-6989586621679322598"><span class="annot"><span class="annottext">ctxt_id :: Int
</span><a href="#local-6989586621679322598"><span class="hs-identifier hs-var">ctxt_id</span></a></span></span><span> </span><span id="local-6989586621679322597"><span class="annot"><span class="annottext">response :: Response
</span><a href="#local-6989586621679322597"><span class="hs-identifier hs-var">response</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-620"></span><span>  </span><span id="local-6989586621679322596"><span class="annot"><span class="annottext">CallContext
</span><a href="#local-6989586621679322596"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; m CallContext
forall (m :: * -&gt; *). ICM m =&gt; Int -&gt; m CallContext
</span><a href="IC.Ref.html#getCallContext"><span class="hs-identifier hs-var">getCallContext</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322598"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span>
</span><span id="line-621"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CallContext -&gt; Bool
</span><a href="IC.Ref.html#deleted"><span class="hs-identifier hs-var hs-var">deleted</span></a></span><span> </span><span class="annot"><span class="annottext">CallContext
</span><a href="#local-6989586621679322596"><span class="hs-identifier hs-var">ctxt</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-622"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; m ()
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Internal error: response to deleted call context&quot;</span></span><span>
</span><span id="line-623"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CallContext -&gt; Responded
</span><a href="IC.Ref.html#responded"><span class="hs-identifier hs-var hs-var">responded</span></a></span><span> </span><span class="annot"><span class="annottext">CallContext
</span><a href="#local-6989586621679322596"><span class="hs-identifier hs-var">ctxt</span></a></span><span> </span><span class="annot"><span class="annottext">Responded -&gt; Responded -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Responded
</span><a href="IC.Types.html#Responded"><span class="hs-identifier hs-var">Responded</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-624"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; m ()
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Internal error: Double response&quot;</span></span><span>
</span><span id="line-625"></span><span>  </span><span class="annot"><span class="annottext">Int -&gt; (CallContext -&gt; CallContext) -&gt; m ()
forall (m :: * -&gt; *).
ICM m =&gt;
Int -&gt; (CallContext -&gt; CallContext) -&gt; m ()
</span><a href="IC.Ref.html#modifyCallContext"><span class="hs-identifier hs-var">modifyCallContext</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322598"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span> </span><span class="annot"><span class="annottext">((CallContext -&gt; CallContext) -&gt; m ())
-&gt; (CallContext -&gt; CallContext) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679322595"><span class="annot"><span class="annottext">ctxt :: CallContext
</span><a href="#local-6989586621679322595"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CallContext
</span><a href="#local-6989586621679322595"><span class="hs-identifier hs-var">ctxt</span></a></span><span>
</span><span id="line-626"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">responded :: Responded
</span><a href="IC.Ref.html#responded"><span class="hs-identifier hs-var">responded</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Responded
</span><a href="IC.Types.html#Responded"><span class="hs-identifier hs-var">Responded</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-627"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">available_cycles :: Natural
</span><a href="IC.Ref.html#available_cycles"><span class="hs-identifier hs-var">available_cycles</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-number">0</span></span><span>
</span><span id="line-628"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-629"></span><span>  </span><span class="annot"><span class="annottext">Message -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; Message -&gt; m ()
</span><a href="IC.Ref.html#enqueueMessage"><span class="hs-identifier hs-var">enqueueMessage</span></a></span><span> </span><span class="annot"><span class="annottext">(Message -&gt; m ()) -&gt; Message -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ResponseMessage :: Int -&gt; Response -&gt; Natural -&gt; Message
</span><a href="IC.Ref.html#ResponseMessage"><span class="hs-identifier hs-type hs-type">ResponseMessage</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-630"></span><span>    </span><span class="annot"><span class="annottext">call_context :: Int
</span><a href="IC.Ref.html#call_context"><span class="hs-identifier hs-var">call_context</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322598"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-631"></span><span>    </span><span class="annot"><span class="annottext">Response
response :: Response
response :: Response
</span><a href="#local-6989586621679322597"><span class="hs-identifier hs-var hs-var">response</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-632"></span><span>    </span><span class="annot"><span class="annottext">refunded_cycles :: Natural
</span><a href="IC.Ref.html#refunded_cycles"><span class="hs-identifier hs-var">refunded_cycles</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CallContext -&gt; Natural
</span><a href="IC.Ref.html#available_cycles"><span class="hs-identifier hs-var hs-var">available_cycles</span></a></span><span> </span><span class="annot"><span class="annottext">CallContext
</span><a href="#local-6989586621679322596"><span class="hs-identifier hs-var">ctxt</span></a></span><span>
</span><span id="line-633"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-634"></span><span>
</span><span id="line-635"></span><span id="local-6989586621679323251"><span class="annot"><a href="IC.Ref.html#replyCallContext"><span class="hs-identifier hs-type">replyCallContext</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323251"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Ref.html#CallId"><span class="hs-identifier hs-type">CallId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323251"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-636"></span><span id="replyCallContext"><span class="annot"><span class="annottext">replyCallContext :: Int -&gt; Blob -&gt; m ()
</span><a href="IC.Ref.html#replyCallContext"><span class="hs-identifier hs-var hs-var">replyCallContext</span></a></span></span><span> </span><span id="local-6989586621679322592"><span class="annot"><span class="annottext">ctxt_id :: Int
</span><a href="#local-6989586621679322592"><span class="hs-identifier hs-var">ctxt_id</span></a></span></span><span> </span><span id="local-6989586621679322591"><span class="annot"><span class="annottext">blob :: Blob
</span><a href="#local-6989586621679322591"><span class="hs-identifier hs-var">blob</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-637"></span><span>  </span><span class="annot"><span class="annottext">Int -&gt; Response -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; Int -&gt; Response -&gt; m ()
</span><a href="IC.Ref.html#respondCallContext"><span class="hs-identifier hs-var">respondCallContext</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322592"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Blob -&gt; Response
</span><a href="IC.Types.html#Reply"><span class="hs-identifier hs-var">Reply</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679322591"><span class="hs-identifier hs-var">blob</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-638"></span><span>
</span><span id="line-639"></span><span id="local-6989586621679323312"><span class="annot"><a href="IC.Ref.html#rejectCallContext"><span class="hs-identifier hs-type">rejectCallContext</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323312"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Ref.html#CallId"><span class="hs-identifier hs-type">CallId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Types.html#RejectCode"><span class="hs-identifier hs-type">RejectCode</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323312"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-640"></span><span id="rejectCallContext"><span class="annot"><span class="annottext">rejectCallContext :: Int -&gt; (RejectCode, String) -&gt; m ()
</span><a href="IC.Ref.html#rejectCallContext"><span class="hs-identifier hs-var hs-var">rejectCallContext</span></a></span></span><span> </span><span id="local-6989586621679322589"><span class="annot"><span class="annottext">ctxt_id :: Int
</span><a href="#local-6989586621679322589"><span class="hs-identifier hs-var">ctxt_id</span></a></span></span><span> </span><span id="local-6989586621679322588"><span class="annot"><span class="annottext">r :: (RejectCode, String)
</span><a href="#local-6989586621679322588"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-641"></span><span>  </span><span class="annot"><span class="annottext">Int -&gt; Response -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; Int -&gt; Response -&gt; m ()
</span><a href="IC.Ref.html#respondCallContext"><span class="hs-identifier hs-var">respondCallContext</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322589"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(RejectCode, String) -&gt; Response
</span><a href="IC.Types.html#Reject"><span class="hs-identifier hs-var">Reject</span></a></span><span> </span><span class="annot"><span class="annottext">(RejectCode, String)
</span><a href="#local-6989586621679322588"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-642"></span><span>
</span><span id="line-643"></span><span id="local-6989586621679323200"><span class="annot"><a href="IC.Ref.html#deleteCallContext"><span class="hs-identifier hs-type">deleteCallContext</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323200"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Ref.html#CallId"><span class="hs-identifier hs-type">CallId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323200"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-644"></span><span id="deleteCallContext"><span class="annot"><span class="annottext">deleteCallContext :: Int -&gt; m ()
</span><a href="IC.Ref.html#deleteCallContext"><span class="hs-identifier hs-var hs-var">deleteCallContext</span></a></span></span><span> </span><span id="local-6989586621679322586"><span class="annot"><span class="annottext">ctxt_id :: Int
</span><a href="#local-6989586621679322586"><span class="hs-identifier hs-var">ctxt_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-645"></span><span>  </span><span class="annot"><span class="annottext">Int -&gt; (CallContext -&gt; CallContext) -&gt; m ()
forall (m :: * -&gt; *).
ICM m =&gt;
Int -&gt; (CallContext -&gt; CallContext) -&gt; m ()
</span><a href="IC.Ref.html#modifyCallContext"><span class="hs-identifier hs-var">modifyCallContext</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322586"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span> </span><span class="annot"><span class="annottext">((CallContext -&gt; CallContext) -&gt; m ())
-&gt; (CallContext -&gt; CallContext) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679322585"><span class="annot"><span class="annottext">ctxt :: CallContext
</span><a href="#local-6989586621679322585"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-646"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">CallContext -&gt; Responded
</span><a href="IC.Ref.html#responded"><span class="hs-identifier hs-var hs-var">responded</span></a></span><span> </span><span class="annot"><span class="annottext">CallContext
</span><a href="#local-6989586621679322585"><span class="hs-identifier hs-var">ctxt</span></a></span><span> </span><span class="annot"><span class="annottext">Responded -&gt; Responded -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Responded
</span><a href="IC.Types.html#Responded"><span class="hs-identifier hs-var">Responded</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-647"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">String -&gt; CallContext
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Internal error: deleteCallContext on non-responded call context&quot;</span></span><span>
</span><span id="line-648"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">CallContext -&gt; Bool
</span><a href="IC.Ref.html#deleted"><span class="hs-identifier hs-var hs-var">deleted</span></a></span><span> </span><span class="annot"><span class="annottext">CallContext
</span><a href="#local-6989586621679322585"><span class="hs-identifier hs-var">ctxt</span></a></span><span>
</span><span id="line-649"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">String -&gt; CallContext
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Internal error: deleteCallContext on deleted call context&quot;</span></span><span>
</span><span id="line-650"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">CallContext
</span><a href="#local-6989586621679322585"><span class="hs-identifier hs-var">ctxt</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">deleted :: Bool
</span><a href="IC.Ref.html#deleted"><span class="hs-identifier hs-var">deleted</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-651"></span><span>
</span><span id="line-652"></span><span id="local-6989586621679323302"><span class="annot"><a href="IC.Ref.html#rememberTrap"><span class="hs-identifier hs-type">rememberTrap</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323302"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Ref.html#CallId"><span class="hs-identifier hs-type">CallId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323302"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-653"></span><span id="rememberTrap"><span class="annot"><span class="annottext">rememberTrap :: Int -&gt; String -&gt; m ()
</span><a href="IC.Ref.html#rememberTrap"><span class="hs-identifier hs-var hs-var">rememberTrap</span></a></span></span><span> </span><span id="local-6989586621679322583"><span class="annot"><span class="annottext">ctxt_id :: Int
</span><a href="#local-6989586621679322583"><span class="hs-identifier hs-var">ctxt_id</span></a></span></span><span> </span><span id="local-6989586621679322582"><span class="annot"><span class="annottext">msg :: String
</span><a href="#local-6989586621679322582"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-654"></span><span>  </span><span class="annot"><span class="annottext">Int -&gt; (CallContext -&gt; CallContext) -&gt; m ()
forall (m :: * -&gt; *).
ICM m =&gt;
Int -&gt; (CallContext -&gt; CallContext) -&gt; m ()
</span><a href="IC.Ref.html#modifyCallContext"><span class="hs-identifier hs-var">modifyCallContext</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322583"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span> </span><span class="annot"><span class="annottext">((CallContext -&gt; CallContext) -&gt; m ())
-&gt; (CallContext -&gt; CallContext) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679322581"><span class="annot"><span class="annottext">ctxt :: CallContext
</span><a href="#local-6989586621679322581"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CallContext
</span><a href="#local-6989586621679322581"><span class="hs-identifier hs-var">ctxt</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">last_trap :: Maybe String
</span><a href="IC.Ref.html#last_trap"><span class="hs-identifier hs-var">last_trap</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Maybe String
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679322582"><span class="hs-identifier hs-var">msg</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-655"></span><span>
</span><span id="line-656"></span><span id="local-6989586621679322580"><span class="annot"><a href="IC.Ref.html#callerOfCallID"><span class="hs-identifier hs-type">callerOfCallID</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679322580"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Ref.html#CallId"><span class="hs-identifier hs-type">CallId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679322580"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="IC.Types.html#EntityId"><span class="hs-identifier hs-type">EntityId</span></a></span></span><span>
</span><span id="line-657"></span><span id="callerOfCallID"><span class="annot"><span class="annottext">callerOfCallID :: Int -&gt; m EntityId
</span><a href="IC.Ref.html#callerOfCallID"><span class="hs-identifier hs-var hs-var">callerOfCallID</span></a></span></span><span> </span><span id="local-6989586621679322578"><span class="annot"><span class="annottext">ctxt_id :: Int
</span><a href="#local-6989586621679322578"><span class="hs-identifier hs-var">ctxt_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-658"></span><span>  </span><span id="local-6989586621679322577"><span class="annot"><span class="annottext">CallContext
</span><a href="#local-6989586621679322577"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; m CallContext
forall (m :: * -&gt; *). ICM m =&gt; Int -&gt; m CallContext
</span><a href="IC.Ref.html#getCallContext"><span class="hs-identifier hs-var">getCallContext</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322578"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span>
</span><span id="line-659"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CallContext -&gt; CallOrigin
</span><a href="IC.Ref.html#origin"><span class="hs-identifier hs-var hs-var">origin</span></a></span><span> </span><span class="annot"><span class="annottext">CallContext
</span><a href="#local-6989586621679322577"><span class="hs-identifier hs-var">ctxt</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-660"></span><span>    </span><span class="annot"><a href="IC.Ref.html#FromUser"><span class="hs-identifier hs-type">FromUser</span></a></span><span> </span><span id="local-6989586621679322576"><span class="annot"><span class="annottext">rid :: Blob
</span><a href="#local-6989586621679322576"><span class="hs-identifier hs-var">rid</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Blob -&gt; m EntityId
forall (m :: * -&gt; *). ICM m =&gt; Blob -&gt; m EntityId
</span><a href="IC.Ref.html#callerOfRequest"><span class="hs-identifier hs-var">callerOfRequest</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679322576"><span class="hs-identifier hs-var">rid</span></a></span><span>
</span><span id="line-661"></span><span>    </span><span class="annot"><a href="IC.Ref.html#FromCanister"><span class="hs-identifier hs-type">FromCanister</span></a></span><span> </span><span id="local-6989586621679322575"><span class="annot"><span class="annottext">other_ctxt_id :: Int
</span><a href="#local-6989586621679322575"><span class="hs-identifier hs-var">other_ctxt_id</span></a></span></span><span> </span><span id="local-6989586621679322574"><span class="annot"><span class="annottext">_callback :: Callback
</span><a href="#local-6989586621679322574"><span class="hs-identifier hs-var">_callback</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int -&gt; m EntityId
forall (m :: * -&gt; *). ICM m =&gt; Int -&gt; m EntityId
</span><a href="IC.Ref.html#calleeOfCallID"><span class="hs-identifier hs-var">calleeOfCallID</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322575"><span class="hs-identifier hs-var">other_ctxt_id</span></a></span><span>
</span><span id="line-662"></span><span>
</span><span id="line-663"></span><span id="local-6989586621679323317"><span class="annot"><a href="IC.Ref.html#calleeOfCallID"><span class="hs-identifier hs-type">calleeOfCallID</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323317"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Ref.html#CallId"><span class="hs-identifier hs-type">CallId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323317"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="IC.Types.html#EntityId"><span class="hs-identifier hs-type">EntityId</span></a></span></span><span>
</span><span id="line-664"></span><span id="calleeOfCallID"><span class="annot"><span class="annottext">calleeOfCallID :: Int -&gt; m EntityId
</span><a href="IC.Ref.html#calleeOfCallID"><span class="hs-identifier hs-var hs-var">calleeOfCallID</span></a></span></span><span> </span><span id="local-6989586621679322572"><span class="annot"><span class="annottext">ctxt_id :: Int
</span><a href="#local-6989586621679322572"><span class="hs-identifier hs-var">ctxt_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CallContext -&gt; EntityId
</span><a href="IC.Ref.html#canister"><span class="hs-identifier hs-var hs-var">canister</span></a></span><span> </span><span class="annot"><span class="annottext">(CallContext -&gt; EntityId) -&gt; m CallContext -&gt; m EntityId
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; m CallContext
forall (m :: * -&gt; *). ICM m =&gt; Int -&gt; m CallContext
</span><a href="IC.Ref.html#getCallContext"><span class="hs-identifier hs-var">getCallContext</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322572"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span>
</span><span id="line-665"></span><span>
</span><span id="line-666"></span><span id="local-6989586621679323167"><span class="annot"><a href="IC.Ref.html#respondedCallID"><span class="hs-identifier hs-type">respondedCallID</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323167"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Ref.html#CallId"><span class="hs-identifier hs-type">CallId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323167"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="IC.Types.html#Responded"><span class="hs-identifier hs-type">Responded</span></a></span></span><span>
</span><span id="line-667"></span><span id="respondedCallID"><span class="annot"><span class="annottext">respondedCallID :: Int -&gt; m Responded
</span><a href="IC.Ref.html#respondedCallID"><span class="hs-identifier hs-var hs-var">respondedCallID</span></a></span></span><span> </span><span id="local-6989586621679322570"><span class="annot"><span class="annottext">ctxt_id :: Int
</span><a href="#local-6989586621679322570"><span class="hs-identifier hs-var">ctxt_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CallContext -&gt; Responded
</span><a href="IC.Ref.html#responded"><span class="hs-identifier hs-var hs-var">responded</span></a></span><span> </span><span class="annot"><span class="annottext">(CallContext -&gt; Responded) -&gt; m CallContext -&gt; m Responded
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; m CallContext
forall (m :: * -&gt; *). ICM m =&gt; Int -&gt; m CallContext
</span><a href="IC.Ref.html#getCallContext"><span class="hs-identifier hs-var">getCallContext</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322570"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span>
</span><span id="line-668"></span><span>
</span><span id="line-669"></span><span id="local-6989586621679323294"><span class="annot"><a href="IC.Ref.html#deletedCallID"><span class="hs-identifier hs-type">deletedCallID</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323294"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Ref.html#CallId"><span class="hs-identifier hs-type">CallId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323294"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span></span><span>
</span><span id="line-670"></span><span id="deletedCallID"><span class="annot"><span class="annottext">deletedCallID :: Int -&gt; m Bool
</span><a href="IC.Ref.html#deletedCallID"><span class="hs-identifier hs-var hs-var">deletedCallID</span></a></span></span><span> </span><span id="local-6989586621679322568"><span class="annot"><span class="annottext">ctxt_id :: Int
</span><a href="#local-6989586621679322568"><span class="hs-identifier hs-var">ctxt_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CallContext -&gt; Bool
</span><a href="IC.Ref.html#deleted"><span class="hs-identifier hs-var hs-var">deleted</span></a></span><span> </span><span class="annot"><span class="annottext">(CallContext -&gt; Bool) -&gt; m CallContext -&gt; m Bool
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; m CallContext
forall (m :: * -&gt; *). ICM m =&gt; Int -&gt; m CallContext
</span><a href="IC.Ref.html#getCallContext"><span class="hs-identifier hs-var">getCallContext</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322568"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span>
</span><span id="line-671"></span><span>
</span><span id="line-672"></span><span id="local-6989586621679322567"><span class="annot"><a href="IC.Ref.html#starveCallContext"><span class="hs-identifier hs-type">starveCallContext</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679322567"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Ref.html#CallId"><span class="hs-identifier hs-type">CallId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679322567"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-673"></span><span id="starveCallContext"><span class="annot"><span class="annottext">starveCallContext :: Int -&gt; m ()
</span><a href="IC.Ref.html#starveCallContext"><span class="hs-identifier hs-var hs-var">starveCallContext</span></a></span></span><span> </span><span id="local-6989586621679322565"><span class="annot"><span class="annottext">ctxt_id :: Int
</span><a href="#local-6989586621679322565"><span class="hs-identifier hs-var">ctxt_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-674"></span><span>  </span><span id="local-6989586621679322564"><span class="annot"><span class="annottext">CallContext
</span><a href="#local-6989586621679322564"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; m CallContext
forall (m :: * -&gt; *). ICM m =&gt; Int -&gt; m CallContext
</span><a href="IC.Ref.html#getCallContext"><span class="hs-identifier hs-var">getCallContext</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322565"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span>
</span><span id="line-675"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679322563"><span class="annot"><span class="annottext">msg :: String
</span><a href="#local-6989586621679322563"><span class="hs-identifier hs-var hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679322562"><span class="annot"><span class="annottext">t :: String
</span><a href="#local-6989586621679322562"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CallContext -&gt; Maybe String
</span><a href="IC.Ref.html#last_trap"><span class="hs-identifier hs-var hs-var">last_trap</span></a></span><span> </span><span class="annot"><span class="annottext">CallContext
</span><a href="#local-6989586621679322564"><span class="hs-identifier hs-var">ctxt</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-string">&quot;canister trapped: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679322562"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-676"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-string">&quot;canister did not respond&quot;</span></span><span>
</span><span id="line-677"></span><span>  </span><span class="annot"><span class="annottext">Int -&gt; (RejectCode, String) -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; Int -&gt; (RejectCode, String) -&gt; m ()
</span><a href="IC.Ref.html#rejectCallContext"><span class="hs-identifier hs-var">rejectCallContext</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322565"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RejectCode
</span><a href="IC.Types.html#RC_CANISTER_ERROR"><span class="hs-identifier hs-var">RC_CANISTER_ERROR</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679322563"><span class="hs-identifier hs-var">msg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-678"></span><span>
</span><span id="line-679"></span><span class="hs-comment">-- Message handling</span><span>
</span><span id="line-680"></span><span>
</span><span id="line-681"></span><span id="local-6989586621679323340"><span class="annot"><a href="IC.Ref.html#enqueueMessage"><span class="hs-identifier hs-type">enqueueMessage</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323340"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Ref.html#Message"><span class="hs-identifier hs-type">Message</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323340"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-682"></span><span id="enqueueMessage"><span class="annot"><span class="annottext">enqueueMessage :: Message -&gt; m ()
</span><a href="IC.Ref.html#enqueueMessage"><span class="hs-identifier hs-var hs-var">enqueueMessage</span></a></span></span><span> </span><span id="local-6989586621679322561"><span class="annot"><span class="annottext">m :: Message
</span><a href="#local-6989586621679322561"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(IC -&gt; IC) -&gt; m ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((IC -&gt; IC) -&gt; m ()) -&gt; (IC -&gt; IC) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679322560"><span class="annot"><span class="annottext">ic :: IC
</span><a href="#local-6989586621679322560"><span class="hs-identifier hs-var">ic</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679322560"><span class="hs-identifier hs-var">ic</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">messages :: Seq Message
</span><a href="IC.Ref.html#messages"><span class="hs-identifier hs-var">messages</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IC -&gt; Seq Message
</span><a href="IC.Ref.html#messages"><span class="hs-identifier hs-var hs-var">messages</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679322560"><span class="hs-identifier hs-var">ic</span></a></span><span> </span><span class="annot"><span class="annottext">Seq Message -&gt; Message -&gt; Seq Message
forall a. Seq a -&gt; a -&gt; Seq a
</span><span class="hs-operator hs-var">:|&gt;</span></span><span> </span><span class="annot"><span class="annottext">Message
</span><a href="#local-6989586621679322561"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-683"></span><span>
</span><span id="line-684"></span><span id="local-6989586621679322558"><span class="annot"><a href="IC.Ref.html#processMessage"><span class="hs-identifier hs-type">processMessage</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679322558"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Ref.html#Message"><span class="hs-identifier hs-type">Message</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679322558"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-685"></span><span id="processMessage"><span class="annot"><span class="annottext">processMessage :: Message -&gt; m ()
</span><a href="IC.Ref.html#processMessage"><span class="hs-identifier hs-var hs-var">processMessage</span></a></span></span><span> </span><span id="local-6989586621679322556"><span class="annot"><span class="annottext">m :: Message
</span><a href="#local-6989586621679322556"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Message
</span><a href="#local-6989586621679322556"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-686"></span><span>  </span><span class="annot"><a href="IC.Ref.html#CallMessage"><span class="hs-identifier hs-type">CallMessage</span></a></span><span> </span><span id="local-6989586621679322555"><span class="annot"><span class="annottext">ctxt_id :: Int
</span><a href="#local-6989586621679322555"><span class="hs-identifier hs-var">ctxt_id</span></a></span></span><span> </span><span id="local-6989586621679322554"><span class="annot"><span class="annottext">entry :: EntryPoint
</span><a href="#local-6989586621679322554"><span class="hs-identifier hs-var">entry</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">((RejectCode, String) -&gt; m ())
-&gt; (forall (m' :: * -&gt; *). (CanReject m', ICM m') =&gt; m' ()) -&gt; m ()
forall (m :: * -&gt; *) b.
ICM m =&gt;
((RejectCode, String) -&gt; m b)
-&gt; (forall (m' :: * -&gt; *). (CanReject m', ICM m') =&gt; m' b) -&gt; m b
</span><a href="IC.Ref.html#onReject"><span class="hs-identifier hs-var">onReject</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; (RejectCode, String) -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; Int -&gt; (RejectCode, String) -&gt; m ()
</span><a href="IC.Ref.html#rejectCallContext"><span class="hs-identifier hs-var">rejectCallContext</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322555"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((forall (m' :: * -&gt; *). (CanReject m', ICM m') =&gt; m' ()) -&gt; m ())
-&gt; (forall (m' :: * -&gt; *). (CanReject m', ICM m') =&gt; m' ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-687"></span><span>    </span><span id="local-6989586621679322553"><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322553"><span class="hs-identifier hs-var">callee</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; m' EntityId
forall (m :: * -&gt; *). ICM m =&gt; Int -&gt; m EntityId
</span><a href="IC.Ref.html#calleeOfCallID"><span class="hs-identifier hs-var">calleeOfCallID</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322555"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span>
</span><span id="line-688"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322553"><span class="hs-identifier hs-var">callee</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; EntityId -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="IC.Ref.html#managementCanisterId"><span class="hs-identifier hs-var">managementCanisterId</span></a></span><span>
</span><span id="line-689"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-690"></span><span>      </span><span id="local-6989586621679322552"><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322552"><span class="hs-identifier hs-var">caller</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; m' EntityId
forall (m :: * -&gt; *). ICM m =&gt; Int -&gt; m EntityId
</span><a href="IC.Ref.html#callerOfCallID"><span class="hs-identifier hs-var">callerOfCallID</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322555"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span>
</span><span id="line-691"></span><span>      </span><span class="annot"><span class="annottext">m' () -&gt; m' ()
forall (m :: * -&gt; *) a. CanReject m =&gt; m a -&gt; m a
</span><a href="IC.Ref.html#rejectAsCanister"><span class="hs-identifier hs-var">rejectAsCanister</span></a></span><span> </span><span class="annot"><span class="annottext">(m' () -&gt; m' ()) -&gt; m' () -&gt; m' ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-692"></span><span>        </span><span class="annot"><span class="annottext">EntityId -&gt; Int -&gt; EntryPoint -&gt; m' ()
forall (m :: * -&gt; *).
(CanReject m, ICM m) =&gt;
EntityId -&gt; Int -&gt; EntryPoint -&gt; m ()
</span><a href="IC.Ref.html#invokeManagementCanister"><span class="hs-identifier hs-var">invokeManagementCanister</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322552"><span class="hs-identifier hs-var">caller</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322555"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span> </span><span class="annot"><span class="annottext">EntryPoint
</span><a href="#local-6989586621679322554"><span class="hs-identifier hs-var">entry</span></a></span><span>
</span><span id="line-693"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-694"></span><span>      </span><span class="annot"><span class="annottext">EntityId -&gt; m' ()
forall (m :: * -&gt; *). (CanReject m, ICM m) =&gt; EntityId -&gt; m ()
</span><a href="IC.Ref.html#canisterMustExist"><span class="hs-identifier hs-var">canisterMustExist</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322553"><span class="hs-identifier hs-var">callee</span></a></span><span>
</span><span id="line-695"></span><span>      </span><span class="annot"><span class="annottext">EntityId -&gt; m' RunStatus
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; m RunStatus
</span><a href="IC.Ref.html#getRunStatus"><span class="hs-identifier hs-var">getRunStatus</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322553"><span class="hs-identifier hs-var">callee</span></a></span><span> </span><span class="annot"><span class="annottext">m' RunStatus -&gt; (RunStatus -&gt; m' ()) -&gt; m' ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-696"></span><span>          </span><span class="annot"><a href="IC.Ref.html#IsRunning"><span class="hs-identifier hs-type">IsRunning</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m' ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-697"></span><span>          </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RejectCode -&gt; String -&gt; m' ()
forall (m :: * -&gt; *) a2.
CanReject m =&gt;
RejectCode -&gt; String -&gt; m a2
</span><a href="IC.Ref.html#reject"><span class="hs-identifier hs-var">reject</span></a></span><span> </span><span class="annot"><span class="annottext">RejectCode
</span><a href="IC.Types.html#RC_CANISTER_ERROR"><span class="hs-identifier hs-var">RC_CANISTER_ERROR</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;canister is stopped&quot;</span></span><span>
</span><span id="line-698"></span><span>      </span><span id="local-6989586621679322549"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679322549"><span class="hs-identifier hs-var">empty</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; m' Bool
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; m Bool
</span><a href="IC.Ref.html#isCanisterEmpty"><span class="hs-identifier hs-var">isCanisterEmpty</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322553"><span class="hs-identifier hs-var">callee</span></a></span><span>
</span><span id="line-699"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; m' () -&gt; m' ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679322549"><span class="hs-identifier hs-var">empty</span></a></span><span> </span><span class="annot"><span class="annottext">(m' () -&gt; m' ()) -&gt; m' () -&gt; m' ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">RejectCode -&gt; String -&gt; m' ()
forall (m :: * -&gt; *) a2.
CanReject m =&gt;
RejectCode -&gt; String -&gt; m a2
</span><a href="IC.Ref.html#reject"><span class="hs-identifier hs-var">reject</span></a></span><span> </span><span class="annot"><span class="annottext">RejectCode
</span><a href="IC.Types.html#RC_DESTINATION_INVALID"><span class="hs-identifier hs-var">RC_DESTINATION_INVALID</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;canister is empty&quot;</span></span><span>
</span><span id="line-700"></span><span>      </span><span id="local-6989586621679322548"><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679322548"><span class="hs-identifier hs-var">wasm_state</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; m' WasmState
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; m WasmState
</span><a href="IC.Ref.html#getCanisterState"><span class="hs-identifier hs-var">getCanisterState</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322553"><span class="hs-identifier hs-var">callee</span></a></span><span>
</span><span id="line-701"></span><span>      </span><span id="local-6989586621679322547"><span class="annot"><span class="annottext">CanisterModule
</span><a href="#local-6989586621679322547"><span class="hs-identifier hs-var">can_mod</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; m' CanisterModule
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; m CanisterModule
</span><a href="IC.Ref.html#getCanisterMod"><span class="hs-identifier hs-var">getCanisterMod</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322553"><span class="hs-identifier hs-var">callee</span></a></span><span>
</span><span id="line-702"></span><span>      </span><span id="local-6989586621679322546"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679322546"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; m' Env
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; m Env
</span><a href="IC.Ref.html#canisterEnv"><span class="hs-identifier hs-var">canisterEnv</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322553"><span class="hs-identifier hs-var">callee</span></a></span><span>
</span><span id="line-703"></span><span>      </span><span class="annot"><span class="annottext">Int
-&gt; WasmState
-&gt; CanisterModule
-&gt; Env
-&gt; EntryPoint
-&gt; m' (TrapOr (WasmState, UpdateResult))
forall (m :: * -&gt; *).
ICM m =&gt;
Int
-&gt; WasmState
-&gt; CanisterModule
-&gt; Env
-&gt; EntryPoint
-&gt; m (TrapOr (WasmState, UpdateResult))
</span><a href="IC.Ref.html#invokeEntry"><span class="hs-identifier hs-var">invokeEntry</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322555"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span> </span><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679322548"><span class="hs-identifier hs-var">wasm_state</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterModule
</span><a href="#local-6989586621679322547"><span class="hs-identifier hs-var">can_mod</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679322546"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">EntryPoint
</span><a href="#local-6989586621679322554"><span class="hs-identifier hs-var">entry</span></a></span><span> </span><span class="annot"><span class="annottext">m' (TrapOr (WasmState, UpdateResult))
-&gt; (TrapOr (WasmState, UpdateResult) -&gt; m' ()) -&gt; m' ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-704"></span><span>        </span><span class="annot"><a href="IC.Types.html#Trap"><span class="hs-identifier hs-type">Trap</span></a></span><span> </span><span id="local-6989586621679322544"><span class="annot"><span class="annottext">msg :: String
</span><a href="#local-6989586621679322544"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-705"></span><span>          </span><span class="hs-comment">-- Eventually update cycle balance here</span><span>
</span><span id="line-706"></span><span>          </span><span class="annot"><span class="annottext">Int -&gt; String -&gt; m' ()
forall (m :: * -&gt; *). ICM m =&gt; Int -&gt; String -&gt; m ()
</span><a href="IC.Ref.html#rememberTrap"><span class="hs-identifier hs-var">rememberTrap</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322555"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679322544"><span class="hs-identifier hs-var">msg</span></a></span><span>
</span><span id="line-707"></span><span>        </span><span class="annot"><a href="IC.Types.html#Return"><span class="hs-identifier hs-type">Return</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679322543"><span class="annot"><span class="annottext">new_state :: WasmState
</span><a href="#local-6989586621679322543"><span class="hs-identifier hs-var">new_state</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679322542"><span class="annot"><span class="annottext">call_actions :: CallActions
</span><a href="#local-6989586621679322542"><span class="hs-identifier hs-var">call_actions</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679322541"><span class="annot"><span class="annottext">canister_actions :: CanisterActions
</span><a href="#local-6989586621679322541"><span class="hs-identifier hs-var">canister_actions</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-708"></span><span>          </span><span class="annot"><span class="annottext">Int -&gt; CallActions -&gt; m' ()
forall (m :: * -&gt; *). ICM m =&gt; Int -&gt; CallActions -&gt; m ()
</span><a href="IC.Ref.html#performCallActions"><span class="hs-identifier hs-var">performCallActions</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322555"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span> </span><span class="annot"><span class="annottext">CallActions
</span><a href="#local-6989586621679322542"><span class="hs-identifier hs-var">call_actions</span></a></span><span>
</span><span id="line-709"></span><span>          </span><span class="annot"><span class="annottext">EntityId -&gt; CanisterActions -&gt; m' ()
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; CanisterActions -&gt; m ()
</span><a href="IC.Ref.html#performCanisterActions"><span class="hs-identifier hs-var">performCanisterActions</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322553"><span class="hs-identifier hs-var">callee</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterActions
</span><a href="#local-6989586621679322541"><span class="hs-identifier hs-var">canister_actions</span></a></span><span>
</span><span id="line-710"></span><span>          </span><span class="annot"><span class="annottext">EntityId -&gt; WasmState -&gt; m' ()
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; WasmState -&gt; m ()
</span><a href="IC.Ref.html#setCanisterState"><span class="hs-identifier hs-var">setCanisterState</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322553"><span class="hs-identifier hs-var">callee</span></a></span><span> </span><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679322543"><span class="hs-identifier hs-var">new_state</span></a></span><span>
</span><span id="line-711"></span><span>
</span><span id="line-712"></span><span>  </span><span class="annot"><a href="IC.Ref.html#ResponseMessage"><span class="hs-identifier hs-type">ResponseMessage</span></a></span><span> </span><span id="local-6989586621679322538"><span class="annot"><span class="annottext">ctxt_id :: Int
</span><a href="#local-6989586621679322538"><span class="hs-identifier hs-var">ctxt_id</span></a></span></span><span> </span><span id="local-6989586621679322537"><span class="annot"><span class="annottext">response :: Response
</span><a href="#local-6989586621679322537"><span class="hs-identifier hs-var">response</span></a></span></span><span> </span><span id="local-6989586621679322536"><span class="annot"><span class="annottext">refunded_cycles :: Natural
</span><a href="#local-6989586621679322536"><span class="hs-identifier hs-var">refunded_cycles</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-713"></span><span>    </span><span id="local-6989586621679322535"><span class="annot"><span class="annottext">CallContext
</span><a href="#local-6989586621679322535"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; m CallContext
forall (m :: * -&gt; *). ICM m =&gt; Int -&gt; m CallContext
</span><a href="IC.Ref.html#getCallContext"><span class="hs-identifier hs-var">getCallContext</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322538"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span>
</span><span id="line-714"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CallContext -&gt; CallOrigin
</span><a href="IC.Ref.html#origin"><span class="hs-identifier hs-var hs-var">origin</span></a></span><span> </span><span class="annot"><span class="annottext">CallContext
</span><a href="#local-6989586621679322535"><span class="hs-identifier hs-var">ctxt</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-715"></span><span>      </span><span class="annot"><a href="IC.Ref.html#FromUser"><span class="hs-identifier hs-type">FromUser</span></a></span><span> </span><span id="local-6989586621679322534"><span class="annot"><span class="annottext">rid :: Blob
</span><a href="#local-6989586621679322534"><span class="hs-identifier hs-var">rid</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Blob -&gt; RequestStatus -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; Blob -&gt; RequestStatus -&gt; m ()
</span><a href="IC.Ref.html#setReqStatus"><span class="hs-identifier hs-var">setReqStatus</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679322534"><span class="hs-identifier hs-var">rid</span></a></span><span> </span><span class="annot"><span class="annottext">(RequestStatus -&gt; m ()) -&gt; RequestStatus -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CallResponse -&gt; RequestStatus
</span><a href="IC.Ref.html#CallResponse"><span class="hs-identifier hs-var">CallResponse</span></a></span><span> </span><span class="annot"><span class="annottext">(CallResponse -&gt; RequestStatus) -&gt; CallResponse -&gt; RequestStatus
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-716"></span><span>        </span><span class="hs-comment">-- NB: Here cycles disappear</span><span>
</span><span id="line-717"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621679322537"><span class="hs-identifier hs-var">response</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-718"></span><span>          </span><span class="annot"><a href="IC.Types.html#Reject"><span class="hs-identifier hs-type">Reject</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679322533"><span class="annot"><span class="annottext">rc :: RejectCode
</span><a href="#local-6989586621679322533"><span class="hs-identifier hs-var">rc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679322532"><span class="annot"><span class="annottext">msg :: String
</span><a href="#local-6989586621679322532"><span class="hs-identifier hs-var">msg</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(RejectCode, String) -&gt; CallResponse
</span><a href="IC.Ref.html#Rejected"><span class="hs-identifier hs-var">Rejected</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RejectCode
</span><a href="#local-6989586621679322533"><span class="hs-identifier hs-var">rc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679322532"><span class="hs-identifier hs-var">msg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-719"></span><span>          </span><span class="annot"><a href="IC.Types.html#Reply"><span class="hs-identifier hs-type">Reply</span></a></span><span> </span><span id="local-6989586621679322531"><span class="annot"><span class="annottext">blob :: Blob
</span><a href="#local-6989586621679322531"><span class="hs-identifier hs-var">blob</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Blob -&gt; CallResponse
</span><a href="IC.Ref.html#Replied"><span class="hs-identifier hs-var">Replied</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679322531"><span class="hs-identifier hs-var">blob</span></a></span><span>
</span><span id="line-720"></span><span>      </span><span class="annot"><a href="IC.Ref.html#FromCanister"><span class="hs-identifier hs-type">FromCanister</span></a></span><span> </span><span id="local-6989586621679322530"><span class="annot"><span class="annottext">other_ctxt_id :: Int
</span><a href="#local-6989586621679322530"><span class="hs-identifier hs-var">other_ctxt_id</span></a></span></span><span> </span><span id="local-6989586621679322529"><span class="annot"><span class="annottext">callback :: Callback
</span><a href="#local-6989586621679322529"><span class="hs-identifier hs-var">callback</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-721"></span><span>        </span><span class="hs-comment">-- Add refund to balance</span><span>
</span><span id="line-722"></span><span>        </span><span id="local-6989586621679322528"><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322528"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; m EntityId
forall (m :: * -&gt; *). ICM m =&gt; Int -&gt; m EntityId
</span><a href="IC.Ref.html#calleeOfCallID"><span class="hs-identifier hs-var">calleeOfCallID</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322530"><span class="hs-identifier hs-var">other_ctxt_id</span></a></span><span>
</span><span id="line-723"></span><span>        </span><span id="local-6989586621679322527"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679322527"><span class="hs-identifier hs-var">prev_balance</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; m Natural
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; m Natural
</span><a href="IC.Ref.html#getBalance"><span class="hs-identifier hs-var">getBalance</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322528"><span class="hs-identifier hs-var">cid</span></a></span><span>
</span><span id="line-724"></span><span>        </span><span class="annot"><span class="annottext">EntityId -&gt; Natural -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; Natural -&gt; m ()
</span><a href="IC.Ref.html#setBalance"><span class="hs-identifier hs-var">setBalance</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322528"><span class="hs-identifier hs-var">cid</span></a></span><span> </span><span class="annot"><span class="annottext">(Natural -&gt; m ()) -&gt; Natural -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679322527"><span class="hs-identifier hs-var">prev_balance</span></a></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; Natural -&gt; Natural
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679322536"><span class="hs-identifier hs-var">refunded_cycles</span></a></span><span>
</span><span id="line-725"></span><span>        </span><span class="hs-comment">-- Unless deleted</span><span>
</span><span id="line-726"></span><span>        </span><span id="local-6989586621679322525"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679322525"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; m Bool
forall (m :: * -&gt; *). ICM m =&gt; Int -&gt; m Bool
</span><a href="IC.Ref.html#deletedCallID"><span class="hs-identifier hs-var">deletedCallID</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322530"><span class="hs-identifier hs-var">other_ctxt_id</span></a></span><span>
</span><span id="line-727"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679322525"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-728"></span><span>          </span><span class="hs-comment">-- Enqueue execution</span><span>
</span><span id="line-729"></span><span>          </span><span class="annot"><span class="annottext">Message -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; Message -&gt; m ()
</span><a href="IC.Ref.html#enqueueMessage"><span class="hs-identifier hs-var">enqueueMessage</span></a></span><span> </span><span class="annot"><span class="annottext">(Message -&gt; m ()) -&gt; Message -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CallMessage :: Int -&gt; EntryPoint -&gt; Message
</span><a href="IC.Ref.html#CallMessage"><span class="hs-identifier hs-type hs-type">CallMessage</span></a></span><span>
</span><span id="line-730"></span><span>            </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">call_context :: Int
</span><a href="IC.Ref.html#call_context"><span class="hs-identifier hs-var">call_context</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322530"><span class="hs-identifier hs-var">other_ctxt_id</span></a></span><span>
</span><span id="line-731"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">entry :: EntryPoint
</span><a href="IC.Ref.html#entry"><span class="hs-identifier hs-var">entry</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Callback -&gt; Response -&gt; Natural -&gt; EntryPoint
</span><a href="IC.Ref.html#Closure"><span class="hs-identifier hs-var">Closure</span></a></span><span> </span><span class="annot"><span class="annottext">Callback
</span><a href="#local-6989586621679322529"><span class="hs-identifier hs-var">callback</span></a></span><span> </span><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621679322537"><span class="hs-identifier hs-var">response</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679322536"><span class="hs-identifier hs-var">refunded_cycles</span></a></span><span>
</span><span id="line-732"></span><span>            </span><span class="hs-special">}</span><span>
</span><span id="line-733"></span><span>
</span><span id="line-734"></span><span id="local-6989586621679323299"><span class="annot"><a href="IC.Ref.html#performCallActions"><span class="hs-identifier hs-type">performCallActions</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323299"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Ref.html#CallId"><span class="hs-identifier hs-type">CallId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CallActions"><span class="hs-identifier hs-type">CallActions</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323299"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-735"></span><span id="performCallActions"><span class="annot"><span class="annottext">performCallActions :: Int -&gt; CallActions -&gt; m ()
</span><a href="IC.Ref.html#performCallActions"><span class="hs-identifier hs-var hs-var">performCallActions</span></a></span></span><span> </span><span id="local-6989586621679322524"><span class="annot"><span class="annottext">ctxt_id :: Int
</span><a href="#local-6989586621679322524"><span class="hs-identifier hs-var">ctxt_id</span></a></span></span><span> </span><span id="local-6989586621679322523"><span class="annot"><span class="annottext">ca :: CallActions
</span><a href="#local-6989586621679322523"><span class="hs-identifier hs-var">ca</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-736"></span><span>  </span><span class="annot"><span class="annottext">Int -&gt; [MethodCall] -&gt; Natural -&gt; m ()
forall (m :: * -&gt; *).
ICM m =&gt;
Int -&gt; [MethodCall] -&gt; Natural -&gt; m ()
</span><a href="IC.Ref.html#updateBalances"><span class="hs-identifier hs-var">updateBalances</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322524"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CallActions -&gt; [MethodCall]
</span><a href="IC.Types.html#ca_new_calls"><span class="hs-identifier hs-var hs-var">ca_new_calls</span></a></span><span> </span><span class="annot"><span class="annottext">CallActions
</span><a href="#local-6989586621679322523"><span class="hs-identifier hs-var">ca</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CallActions -&gt; Natural
</span><a href="IC.Types.html#ca_accept"><span class="hs-identifier hs-var hs-var">ca_accept</span></a></span><span> </span><span class="annot"><span class="annottext">CallActions
</span><a href="#local-6989586621679322523"><span class="hs-identifier hs-var">ca</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-737"></span><span>  </span><span class="annot"><span class="annottext">(MethodCall -&gt; m ()) -&gt; [MethodCall] -&gt; m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; MethodCall -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; Int -&gt; MethodCall -&gt; m ()
</span><a href="IC.Ref.html#newCall"><span class="hs-identifier hs-var">newCall</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322524"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CallActions -&gt; [MethodCall]
</span><a href="IC.Types.html#ca_new_calls"><span class="hs-identifier hs-var hs-var">ca_new_calls</span></a></span><span> </span><span class="annot"><span class="annottext">CallActions
</span><a href="#local-6989586621679322523"><span class="hs-identifier hs-var">ca</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-738"></span><span>  </span><span class="annot"><span class="annottext">(Response -&gt; m ()) -&gt; Maybe Response -&gt; m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Response -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; Int -&gt; Response -&gt; m ()
</span><a href="IC.Ref.html#respondCallContext"><span class="hs-identifier hs-var">respondCallContext</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322524"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CallActions -&gt; Maybe Response
</span><a href="IC.Types.html#ca_response"><span class="hs-identifier hs-var hs-var">ca_response</span></a></span><span> </span><span class="annot"><span class="annottext">CallActions
</span><a href="#local-6989586621679322523"><span class="hs-identifier hs-var">ca</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-739"></span><span>
</span><span id="line-740"></span><span>
</span><span id="line-741"></span><span id="local-6989586621679323298"><span class="annot"><a href="IC.Ref.html#performCanisterActions"><span class="hs-identifier hs-type">performCanisterActions</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323298"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterActions"><span class="hs-identifier hs-type">CanisterActions</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323298"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-742"></span><span id="performCanisterActions"><span class="annot"><span class="annottext">performCanisterActions :: EntityId -&gt; CanisterActions -&gt; m ()
</span><a href="IC.Ref.html#performCanisterActions"><span class="hs-identifier hs-var hs-var">performCanisterActions</span></a></span></span><span> </span><span id="local-6989586621679322516"><span class="annot"><span class="annottext">cid :: EntityId
</span><a href="#local-6989586621679322516"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span id="local-6989586621679322515"><span class="annot"><span class="annottext">ca :: CanisterActions
</span><a href="#local-6989586621679322515"><span class="hs-identifier hs-var">ca</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-743"></span><span>  </span><span class="annot"><span class="annottext">(Blob -&gt; m ()) -&gt; Maybe Blob -&gt; m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EntityId -&gt; Blob -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; Blob -&gt; m ()
</span><a href="IC.Ref.html#setCertifiedData"><span class="hs-identifier hs-var">setCertifiedData</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322516"><span class="hs-identifier hs-var">cid</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CanisterActions -&gt; Maybe Blob
</span><a href="IC.Types.html#set_certified_data"><span class="hs-identifier hs-var hs-var">set_certified_data</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterActions
</span><a href="#local-6989586621679322515"><span class="hs-identifier hs-var">ca</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-744"></span><span>
</span><span id="line-745"></span><span id="local-6989586621679323291"><span class="annot"><a href="IC.Ref.html#updateBalances"><span class="hs-identifier hs-type">updateBalances</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323291"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Ref.html#CallId"><span class="hs-identifier hs-type">CallId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="IC.Types.html#MethodCall"><span class="hs-identifier hs-type">MethodCall</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#Cycles"><span class="hs-identifier hs-type">Cycles</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323291"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-746"></span><span id="updateBalances"><span class="annot"><span class="annottext">updateBalances :: Int -&gt; [MethodCall] -&gt; Natural -&gt; m ()
</span><a href="IC.Ref.html#updateBalances"><span class="hs-identifier hs-var hs-var">updateBalances</span></a></span></span><span> </span><span id="local-6989586621679322513"><span class="annot"><span class="annottext">ctxt_id :: Int
</span><a href="#local-6989586621679322513"><span class="hs-identifier hs-var">ctxt_id</span></a></span></span><span> </span><span id="local-6989586621679322512"><span class="annot"><span class="annottext">new_calls :: [MethodCall]
</span><a href="#local-6989586621679322512"><span class="hs-identifier hs-var">new_calls</span></a></span></span><span> </span><span id="local-6989586621679322511"><span class="annot"><span class="annottext">accepted :: Natural
</span><a href="#local-6989586621679322511"><span class="hs-identifier hs-var">accepted</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-747"></span><span>  </span><span id="local-6989586621679322510"><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322510"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; m EntityId
forall (m :: * -&gt; *). ICM m =&gt; Int -&gt; m EntityId
</span><a href="IC.Ref.html#calleeOfCallID"><span class="hs-identifier hs-var">calleeOfCallID</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322513"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span>
</span><span id="line-748"></span><span>
</span><span id="line-749"></span><span>  </span><span class="hs-comment">-- Eventually update when we track cycle consumption</span><span>
</span><span id="line-750"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679322509"><span class="annot"><span class="annottext">max_cycles :: Natural
</span><a href="#local-6989586621679322509"><span class="hs-identifier hs-var hs-var">max_cycles</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-number">0</span></span><span>
</span><span id="line-751"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679322508"><span class="annot"><span class="annottext">cycles_consumed :: Natural
</span><a href="#local-6989586621679322508"><span class="hs-identifier hs-var hs-var">cycles_consumed</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-number">0</span></span><span>
</span><span id="line-752"></span><span>
</span><span id="line-753"></span><span>  </span><span id="local-6989586621679322507"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679322507"><span class="hs-identifier hs-var">prev_balance</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; m Natural
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; m Natural
</span><a href="IC.Ref.html#getBalance"><span class="hs-identifier hs-var">getBalance</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322510"><span class="hs-identifier hs-var">cid</span></a></span><span>
</span><span id="line-754"></span><span>  </span><span id="local-6989586621679322506"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679322506"><span class="hs-identifier hs-var">available</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; m Natural
forall (m :: * -&gt; *). ICM m =&gt; Int -&gt; m Natural
</span><a href="IC.Ref.html#getCallContextCycles"><span class="hs-identifier hs-var">getCallContextCycles</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322513"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span>
</span><span id="line-755"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679322511"><span class="hs-identifier hs-var">accepted</span></a></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; Natural -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679322506"><span class="hs-identifier hs-var">available</span></a></span><span>
</span><span id="line-756"></span><span>  </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-757"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679322504"><span class="annot"><span class="annottext">to_spend :: Natural
</span><a href="#local-6989586621679322504"><span class="hs-identifier hs-var hs-var">to_spend</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679322507"><span class="hs-identifier hs-var">prev_balance</span></a></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; Natural -&gt; Natural
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679322511"><span class="hs-identifier hs-var">accepted</span></a></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; Natural -&gt; Natural
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679322509"><span class="hs-identifier hs-var">max_cycles</span></a></span><span>
</span><span id="line-758"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679322503"><span class="annot"><span class="annottext">transferred :: Natural
</span><a href="#local-6989586621679322503"><span class="hs-identifier hs-var hs-var">transferred</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Natural] -&gt; Natural
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">sum</span></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">MethodCall -&gt; Natural
</span><a href="IC.Types.html#call_transferred_cycles"><span class="hs-identifier hs-var hs-var">call_transferred_cycles</span></a></span><span> </span><span class="annot"><span class="annottext">MethodCall
</span><a href="#local-6989586621679322500"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621679322500"><span class="annot"><span class="annottext">MethodCall
</span><a href="#local-6989586621679322500"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[MethodCall]
</span><a href="#local-6989586621679322512"><span class="hs-identifier hs-var">new_calls</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-759"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679322503"><span class="hs-identifier hs-var">transferred</span></a></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; Natural -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679322504"><span class="hs-identifier hs-var">to_spend</span></a></span><span>
</span><span id="line-760"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-761"></span><span>      </span><span class="annot"><span class="annottext">EntityId -&gt; Natural -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; Natural -&gt; m ()
</span><a href="IC.Ref.html#setBalance"><span class="hs-identifier hs-var">setBalance</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322510"><span class="hs-identifier hs-var">cid</span></a></span><span> </span><span class="annot"><span class="annottext">(Natural -&gt; m ()) -&gt; Natural -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679322507"><span class="hs-identifier hs-var">prev_balance</span></a></span><span>
</span><span id="line-762"></span><span>        </span><span class="annot"><span class="annottext">Natural -&gt; Natural -&gt; Natural
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679322511"><span class="hs-identifier hs-var">accepted</span></a></span><span>
</span><span id="line-763"></span><span>        </span><span class="annot"><span class="annottext">Natural -&gt; Natural -&gt; Natural
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679322508"><span class="hs-identifier hs-var">cycles_consumed</span></a></span><span>
</span><span id="line-764"></span><span>        </span><span class="annot"><span class="annottext">Natural -&gt; Natural -&gt; Natural
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679322503"><span class="hs-identifier hs-var">transferred</span></a></span><span>
</span><span id="line-765"></span><span>      </span><span class="annot"><span class="annottext">Int -&gt; Natural -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; Int -&gt; Natural -&gt; m ()
</span><a href="IC.Ref.html#setCallContextCycles"><span class="hs-identifier hs-var">setCallContextCycles</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322513"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span> </span><span class="annot"><span class="annottext">(Natural -&gt; m ()) -&gt; Natural -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679322506"><span class="hs-identifier hs-var">available</span></a></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; Natural -&gt; Natural
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679322511"><span class="hs-identifier hs-var">accepted</span></a></span><span>
</span><span id="line-766"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">String -&gt; m ()
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Internal error: More cycles transferred than available&quot;</span></span><span>
</span><span id="line-767"></span><span>  </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">String -&gt; m ()
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Internal error: More cycles accepted than available&quot;</span></span><span>
</span><span id="line-768"></span><span>
</span><span id="line-769"></span><span>
</span><span id="line-770"></span><span class="annot"><a href="IC.Ref.html#managementCanisterId"><span class="hs-identifier hs-type">managementCanisterId</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Types.html#EntityId"><span class="hs-identifier hs-type">EntityId</span></a></span><span>
</span><span id="line-771"></span><span id="managementCanisterId"><span class="annot"><span class="annottext">managementCanisterId :: EntityId
</span><a href="IC.Ref.html#managementCanisterId"><span class="hs-identifier hs-var hs-var">managementCanisterId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Blob -&gt; EntityId
</span><a href="IC.Types.html#EntityId"><span class="hs-identifier hs-var">EntityId</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-772"></span><span>
</span><span id="line-773"></span><span>
</span><span id="line-774"></span><span class="annot"><a href="IC.Ref.html#invokeManagementCanister"><span class="hs-identifier hs-type">invokeManagementCanister</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-775"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679323305"><span class="annot"><a href="#local-6989586621679323305"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Ref.html#CanReject"><span class="hs-identifier hs-type">CanReject</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323305"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323305"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#EntityId"><span class="hs-identifier hs-type">EntityId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Ref.html#CallId"><span class="hs-identifier hs-type">CallId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Ref.html#EntryPoint"><span class="hs-identifier hs-type">EntryPoint</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323305"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-776"></span><span id="invokeManagementCanister"><span class="annot"><span class="annottext">invokeManagementCanister :: EntityId -&gt; Int -&gt; EntryPoint -&gt; m ()
</span><a href="IC.Ref.html#invokeManagementCanister"><span class="hs-identifier hs-var hs-var">invokeManagementCanister</span></a></span></span><span> </span><span id="local-6989586621679322499"><span class="annot"><span class="annottext">caller :: EntityId
</span><a href="#local-6989586621679322499"><span class="hs-identifier hs-var">caller</span></a></span></span><span> </span><span id="local-6989586621679322498"><span class="annot"><span class="annottext">ctxt_id :: Int
</span><a href="#local-6989586621679322498"><span class="hs-identifier hs-var">ctxt_id</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Ref.html#Public"><span class="hs-identifier hs-type">Public</span></a></span><span> </span><span id="local-6989586621679322497"><span class="annot"><span class="annottext">method_name :: String
</span><a href="#local-6989586621679322497"><span class="hs-identifier hs-var">method_name</span></a></span></span><span> </span><span id="local-6989586621679322496"><span class="annot"><span class="annottext">arg :: Blob
</span><a href="#local-6989586621679322496"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-777"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679322497"><span class="hs-identifier hs-var">method_name</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-778"></span><span>      </span><span class="hs-string">&quot;create_canister&quot;</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Rec
   ('R
      '[ &quot;settings&quot;
         ':-&gt; Maybe
                (Rec
                   ('R
                      '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                         &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                         &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                         &quot;memory_allocation&quot; ':-&gt; Maybe Natural]))])
 -&gt; m (Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])))
-&gt; m ()
forall a b. (CandidArg a, CandidArg b) =&gt; (a -&gt; m b) -&gt; m ()
</span><a href="#local-6989586621679322495"><span class="hs-identifier hs-var">atomic</span></a></span><span> </span><span class="annot"><span class="annottext">((Rec
    ('R
       '[ &quot;settings&quot;
          ':-&gt; Maybe
                 (Rec
                    ('R
                       '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                          &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                          &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                          &quot;memory_allocation&quot; ':-&gt; Maybe Natural]))])
  -&gt; m (Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])))
 -&gt; m ())
-&gt; (Rec
      ('R
         '[ &quot;settings&quot;
            ':-&gt; Maybe
                   (Rec
                      ('R
                         '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                            &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                            &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                            &quot;memory_allocation&quot; ':-&gt; Maybe Natural]))])
    -&gt; m (Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])))
-&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; Int -&gt; ICManagement m .! &quot;create_canister&quot;
forall (m :: * -&gt; *).
(ICM m, CanReject m) =&gt;
EntityId -&gt; Int -&gt; ICManagement m .! &quot;create_canister&quot;
</span><a href="IC.Ref.html#icCreateCanister"><span class="hs-identifier hs-var">icCreateCanister</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322499"><span class="hs-identifier hs-var">caller</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322498"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span>
</span><span id="line-779"></span><span>      </span><span class="hs-string">&quot;install_code&quot;</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Rec
   ('R
      '[ &quot;arg&quot; ':-&gt; Blob, &quot;canister_id&quot; ':-&gt; Principal,
         &quot;mode&quot;
         ':-&gt; Var
                ('R '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()]),
         &quot;wasm_module&quot; ':-&gt; Blob])
 -&gt; m ())
-&gt; m ()
forall a b. (CandidArg a, CandidArg b) =&gt; (a -&gt; m b) -&gt; m ()
</span><a href="#local-6989586621679322495"><span class="hs-identifier hs-var">atomic</span></a></span><span> </span><span class="annot"><span class="annottext">((Rec
    ('R
       '[ &quot;arg&quot; ':-&gt; Blob, &quot;canister_id&quot; ':-&gt; Principal,
          &quot;mode&quot;
          ':-&gt; Var
                 ('R '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()]),
          &quot;wasm_module&quot; ':-&gt; Blob])
  -&gt; m ())
 -&gt; m ())
-&gt; (Rec
      ('R
         '[ &quot;arg&quot; ':-&gt; Blob, &quot;canister_id&quot; ':-&gt; Principal,
            &quot;mode&quot;
            ':-&gt; Var
                   ('R '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()]),
            &quot;wasm_module&quot; ':-&gt; Blob])
    -&gt; m ())
-&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">EntityId
-&gt; (Rec
      ('R
         '[ &quot;arg&quot; ':-&gt; Blob, &quot;canister_id&quot; ':-&gt; Principal,
            &quot;mode&quot;
            ':-&gt; Var
                   ('R '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()]),
            &quot;wasm_module&quot; ':-&gt; Blob])
    -&gt; m ())
-&gt; Rec
     ('R
        '[ &quot;arg&quot; ':-&gt; Blob, &quot;canister_id&quot; ':-&gt; Principal,
           &quot;mode&quot;
           ':-&gt; Var
                  ('R '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()]),
           &quot;wasm_module&quot; ':-&gt; Blob])
-&gt; m ()
forall (m :: * -&gt; *) (r :: Row *) a.
(ICM m, CanReject m, (r .! &quot;canister_id&quot;) ~ Principal) =&gt;
EntityId -&gt; (Rec r -&gt; m a) -&gt; Rec r -&gt; m a
</span><a href="IC.Ref.html#onlyController"><span class="hs-identifier hs-var">onlyController</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322499"><span class="hs-identifier hs-var">caller</span></a></span><span> </span><span class="annot"><span class="annottext">((Rec
    ('R
       '[ &quot;arg&quot; ':-&gt; Blob, &quot;canister_id&quot; ':-&gt; Principal,
          &quot;mode&quot;
          ':-&gt; Var
                 ('R '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()]),
          &quot;wasm_module&quot; ':-&gt; Blob])
  -&gt; m ())
 -&gt; Rec
      ('R
         '[ &quot;arg&quot; ':-&gt; Blob, &quot;canister_id&quot; ':-&gt; Principal,
            &quot;mode&quot;
            ':-&gt; Var
                   ('R '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()]),
            &quot;wasm_module&quot; ':-&gt; Blob])
 -&gt; m ())
-&gt; (Rec
      ('R
         '[ &quot;arg&quot; ':-&gt; Blob, &quot;canister_id&quot; ':-&gt; Principal,
            &quot;mode&quot;
            ':-&gt; Var
                   ('R '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()]),
            &quot;wasm_module&quot; ':-&gt; Blob])
    -&gt; m ())
-&gt; Rec
     ('R
        '[ &quot;arg&quot; ':-&gt; Blob, &quot;canister_id&quot; ':-&gt; Principal,
           &quot;mode&quot;
           ':-&gt; Var
                  ('R '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()]),
           &quot;wasm_module&quot; ':-&gt; Blob])
-&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; ICManagement m .! &quot;install_code&quot;
forall (m :: * -&gt; *).
(ICM m, CanReject m) =&gt;
EntityId -&gt; ICManagement m .! &quot;install_code&quot;
</span><a href="IC.Ref.html#icInstallCode"><span class="hs-identifier hs-var">icInstallCode</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322499"><span class="hs-identifier hs-var">caller</span></a></span><span>
</span><span id="line-780"></span><span>      </span><span class="hs-string">&quot;uninstall_code&quot;</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal]) -&gt; m ()) -&gt; m ()
forall a b. (CandidArg a, CandidArg b) =&gt; (a -&gt; m b) -&gt; m ()
</span><a href="#local-6989586621679322495"><span class="hs-identifier hs-var">atomic</span></a></span><span> </span><span class="annot"><span class="annottext">((Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal]) -&gt; m ()) -&gt; m ())
-&gt; (Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal]) -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">EntityId
-&gt; (Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal]) -&gt; m ())
-&gt; Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; m ()
forall (m :: * -&gt; *) (r :: Row *) a.
(ICM m, CanReject m, (r .! &quot;canister_id&quot;) ~ Principal) =&gt;
EntityId -&gt; (Rec r -&gt; m a) -&gt; Rec r -&gt; m a
</span><a href="IC.Ref.html#onlyController"><span class="hs-identifier hs-var">onlyController</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322499"><span class="hs-identifier hs-var">caller</span></a></span><span> </span><span class="annot"><span class="annottext">((Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal]) -&gt; m ())
 -&gt; Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal]) -&gt; m ())
-&gt; (Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal]) -&gt; m ())
-&gt; Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal]) -&gt; m ()
forall (m :: * -&gt; *).
(ICM m, CanReject m) =&gt;
ICManagement m .! &quot;uninstall_code&quot;
</span><a href="IC.Ref.html#icUninstallCode"><span class="hs-identifier hs-var">icUninstallCode</span></a></span><span>
</span><span id="line-781"></span><span>      </span><span class="hs-string">&quot;update_settings&quot;</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Rec
   ('R
      '[ &quot;canister_id&quot; ':-&gt; Principal,
         &quot;settings&quot;
         ':-&gt; Rec
                ('R
                   '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                      &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                      &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                      &quot;memory_allocation&quot; ':-&gt; Maybe Natural])])
 -&gt; m ())
-&gt; m ()
forall a b. (CandidArg a, CandidArg b) =&gt; (a -&gt; m b) -&gt; m ()
</span><a href="#local-6989586621679322495"><span class="hs-identifier hs-var">atomic</span></a></span><span> </span><span class="annot"><span class="annottext">((Rec
    ('R
       '[ &quot;canister_id&quot; ':-&gt; Principal,
          &quot;settings&quot;
          ':-&gt; Rec
                 ('R
                    '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                       &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                       &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                       &quot;memory_allocation&quot; ':-&gt; Maybe Natural])])
  -&gt; m ())
 -&gt; m ())
-&gt; (Rec
      ('R
         '[ &quot;canister_id&quot; ':-&gt; Principal,
            &quot;settings&quot;
            ':-&gt; Rec
                   ('R
                      '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                         &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                         &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                         &quot;memory_allocation&quot; ':-&gt; Maybe Natural])])
    -&gt; m ())
-&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">EntityId
-&gt; (Rec
      ('R
         '[ &quot;canister_id&quot; ':-&gt; Principal,
            &quot;settings&quot;
            ':-&gt; Rec
                   ('R
                      '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                         &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                         &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                         &quot;memory_allocation&quot; ':-&gt; Maybe Natural])])
    -&gt; m ())
-&gt; Rec
     ('R
        '[ &quot;canister_id&quot; ':-&gt; Principal,
           &quot;settings&quot;
           ':-&gt; Rec
                  ('R
                     '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                        &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                        &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                        &quot;memory_allocation&quot; ':-&gt; Maybe Natural])])
-&gt; m ()
forall (m :: * -&gt; *) (r :: Row *) a.
(ICM m, CanReject m, (r .! &quot;canister_id&quot;) ~ Principal) =&gt;
EntityId -&gt; (Rec r -&gt; m a) -&gt; Rec r -&gt; m a
</span><a href="IC.Ref.html#onlyController"><span class="hs-identifier hs-var">onlyController</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322499"><span class="hs-identifier hs-var">caller</span></a></span><span> </span><span class="annot"><span class="annottext">Rec
  ('R
     '[ &quot;canister_id&quot; ':-&gt; Principal,
        &quot;settings&quot;
        ':-&gt; Rec
               ('R
                  '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                     &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                     &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                     &quot;memory_allocation&quot; ':-&gt; Maybe Natural])])
-&gt; m ()
forall (m :: * -&gt; *).
(ICM m, CanReject m) =&gt;
ICManagement m .! &quot;update_settings&quot;
</span><a href="IC.Ref.html#icUpdateCanisterSettings"><span class="hs-identifier hs-var">icUpdateCanisterSettings</span></a></span><span>
</span><span id="line-782"></span><span>      </span><span class="hs-string">&quot;start_canister&quot;</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal]) -&gt; m ()) -&gt; m ()
forall a b. (CandidArg a, CandidArg b) =&gt; (a -&gt; m b) -&gt; m ()
</span><a href="#local-6989586621679322495"><span class="hs-identifier hs-var">atomic</span></a></span><span> </span><span class="annot"><span class="annottext">((Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal]) -&gt; m ()) -&gt; m ())
-&gt; (Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal]) -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">EntityId
-&gt; (Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal]) -&gt; m ())
-&gt; Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; m ()
forall (m :: * -&gt; *) (r :: Row *) a.
(ICM m, CanReject m, (r .! &quot;canister_id&quot;) ~ Principal) =&gt;
EntityId -&gt; (Rec r -&gt; m a) -&gt; Rec r -&gt; m a
</span><a href="IC.Ref.html#onlyController"><span class="hs-identifier hs-var">onlyController</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322499"><span class="hs-identifier hs-var">caller</span></a></span><span> </span><span class="annot"><span class="annottext">Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal]) -&gt; m ()
forall (m :: * -&gt; *).
(ICM m, CanReject m) =&gt;
ICManagement m .! &quot;start_canister&quot;
</span><a href="IC.Ref.html#icStartCanister"><span class="hs-identifier hs-var">icStartCanister</span></a></span><span>
</span><span id="line-783"></span><span>      </span><span class="hs-string">&quot;stop_canister&quot;</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal]) -&gt; m ()) -&gt; m ()
forall a. CandidArg a =&gt; (a -&gt; m ()) -&gt; m ()
</span><a href="#local-6989586621679322488"><span class="hs-identifier hs-var">deferred</span></a></span><span> </span><span class="annot"><span class="annottext">((Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal]) -&gt; m ()) -&gt; m ())
-&gt; (Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal]) -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">EntityId
-&gt; (Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal]) -&gt; m ())
-&gt; Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; m ()
forall (m :: * -&gt; *) (r :: Row *) a.
(ICM m, CanReject m, (r .! &quot;canister_id&quot;) ~ Principal) =&gt;
EntityId -&gt; (Rec r -&gt; m a) -&gt; Rec r -&gt; m a
</span><a href="IC.Ref.html#onlyController"><span class="hs-identifier hs-var">onlyController</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322499"><span class="hs-identifier hs-var">caller</span></a></span><span> </span><span class="annot"><span class="annottext">((Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal]) -&gt; m ())
 -&gt; Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal]) -&gt; m ())
-&gt; (Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal]) -&gt; m ())
-&gt; Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal]) -&gt; m ()
forall (m :: * -&gt; *) a b.
(ICM m, CanReject m,
 (a -&gt; m b) ~ (ICManagement m .! &quot;stop_canister&quot;)) =&gt;
Int -&gt; a -&gt; m ()
</span><a href="IC.Ref.html#icStopCanister"><span class="hs-identifier hs-var">icStopCanister</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322498"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span>
</span><span id="line-784"></span><span>      </span><span class="hs-string">&quot;canister_status&quot;</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
 -&gt; m (Rec
         ('R
            '[ &quot;cycles&quot; ':-&gt; Natural, &quot;memory_size&quot; ':-&gt; Natural,
               &quot;module_hash&quot; ':-&gt; Maybe Blob,
               &quot;settings&quot;
               ':-&gt; Rec
                      ('R
                         '[ &quot;compute_allocation&quot; ':-&gt; Natural,
                            &quot;controllers&quot; ':-&gt; Vector Principal,
                            &quot;freezing_threshold&quot; ':-&gt; Natural,
                            &quot;memory_allocation&quot; ':-&gt; Natural]),
               &quot;status&quot;
               ':-&gt; Var
                      ('R
                         '[ &quot;running&quot; ':-&gt; (), &quot;stopped&quot; ':-&gt; (), &quot;stopping&quot; ':-&gt; ()])])))
-&gt; m ()
forall a b. (CandidArg a, CandidArg b) =&gt; (a -&gt; m b) -&gt; m ()
</span><a href="#local-6989586621679322495"><span class="hs-identifier hs-var">atomic</span></a></span><span> </span><span class="annot"><span class="annottext">((Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
  -&gt; m (Rec
          ('R
             '[ &quot;cycles&quot; ':-&gt; Natural, &quot;memory_size&quot; ':-&gt; Natural,
                &quot;module_hash&quot; ':-&gt; Maybe Blob,
                &quot;settings&quot;
                ':-&gt; Rec
                       ('R
                          '[ &quot;compute_allocation&quot; ':-&gt; Natural,
                             &quot;controllers&quot; ':-&gt; Vector Principal,
                             &quot;freezing_threshold&quot; ':-&gt; Natural,
                             &quot;memory_allocation&quot; ':-&gt; Natural]),
                &quot;status&quot;
                ':-&gt; Var
                       ('R
                          '[ &quot;running&quot; ':-&gt; (), &quot;stopped&quot; ':-&gt; (), &quot;stopping&quot; ':-&gt; ()])])))
 -&gt; m ())
-&gt; (Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
    -&gt; m (Rec
            ('R
               '[ &quot;cycles&quot; ':-&gt; Natural, &quot;memory_size&quot; ':-&gt; Natural,
                  &quot;module_hash&quot; ':-&gt; Maybe Blob,
                  &quot;settings&quot;
                  ':-&gt; Rec
                         ('R
                            '[ &quot;compute_allocation&quot; ':-&gt; Natural,
                               &quot;controllers&quot; ':-&gt; Vector Principal,
                               &quot;freezing_threshold&quot; ':-&gt; Natural,
                               &quot;memory_allocation&quot; ':-&gt; Natural]),
                  &quot;status&quot;
                  ':-&gt; Var
                         ('R
                            '[ &quot;running&quot; ':-&gt; (), &quot;stopped&quot; ':-&gt; (), &quot;stopping&quot; ':-&gt; ()])])))
-&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">EntityId
-&gt; (Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
    -&gt; m (Rec
            ('R
               '[ &quot;cycles&quot; ':-&gt; Natural, &quot;memory_size&quot; ':-&gt; Natural,
                  &quot;module_hash&quot; ':-&gt; Maybe Blob,
                  &quot;settings&quot;
                  ':-&gt; Rec
                         ('R
                            '[ &quot;compute_allocation&quot; ':-&gt; Natural,
                               &quot;controllers&quot; ':-&gt; Vector Principal,
                               &quot;freezing_threshold&quot; ':-&gt; Natural,
                               &quot;memory_allocation&quot; ':-&gt; Natural]),
                  &quot;status&quot;
                  ':-&gt; Var
                         ('R
                            '[ &quot;running&quot; ':-&gt; (), &quot;stopped&quot; ':-&gt; (), &quot;stopping&quot; ':-&gt; ()])])))
-&gt; Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; m (Rec
        ('R
           '[ &quot;cycles&quot; ':-&gt; Natural, &quot;memory_size&quot; ':-&gt; Natural,
              &quot;module_hash&quot; ':-&gt; Maybe Blob,
              &quot;settings&quot;
              ':-&gt; Rec
                     ('R
                        '[ &quot;compute_allocation&quot; ':-&gt; Natural,
                           &quot;controllers&quot; ':-&gt; Vector Principal,
                           &quot;freezing_threshold&quot; ':-&gt; Natural,
                           &quot;memory_allocation&quot; ':-&gt; Natural]),
              &quot;status&quot;
              ':-&gt; Var
                     ('R
                        '[ &quot;running&quot; ':-&gt; (), &quot;stopped&quot; ':-&gt; (), &quot;stopping&quot; ':-&gt; ()])]))
forall (m :: * -&gt; *) (r :: Row *) a.
(ICM m, CanReject m, (r .! &quot;canister_id&quot;) ~ Principal) =&gt;
EntityId -&gt; (Rec r -&gt; m a) -&gt; Rec r -&gt; m a
</span><a href="IC.Ref.html#onlyController"><span class="hs-identifier hs-var">onlyController</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322499"><span class="hs-identifier hs-var">caller</span></a></span><span> </span><span class="annot"><span class="annottext">Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; m (Rec
        ('R
           '[ &quot;cycles&quot; ':-&gt; Natural, &quot;memory_size&quot; ':-&gt; Natural,
              &quot;module_hash&quot; ':-&gt; Maybe Blob,
              &quot;settings&quot;
              ':-&gt; Rec
                     ('R
                        '[ &quot;compute_allocation&quot; ':-&gt; Natural,
                           &quot;controllers&quot; ':-&gt; Vector Principal,
                           &quot;freezing_threshold&quot; ':-&gt; Natural,
                           &quot;memory_allocation&quot; ':-&gt; Natural]),
              &quot;status&quot;
              ':-&gt; Var
                     ('R
                        '[ &quot;running&quot; ':-&gt; (), &quot;stopped&quot; ':-&gt; (), &quot;stopping&quot; ':-&gt; ()])]))
forall (m :: * -&gt; *).
(ICM m, CanReject m) =&gt;
ICManagement m .! &quot;canister_status&quot;
</span><a href="IC.Ref.html#icCanisterStatus"><span class="hs-identifier hs-var">icCanisterStatus</span></a></span><span>
</span><span id="line-785"></span><span>      </span><span class="hs-string">&quot;delete_canister&quot;</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal]) -&gt; m ()) -&gt; m ()
forall a b. (CandidArg a, CandidArg b) =&gt; (a -&gt; m b) -&gt; m ()
</span><a href="#local-6989586621679322495"><span class="hs-identifier hs-var">atomic</span></a></span><span> </span><span class="annot"><span class="annottext">((Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal]) -&gt; m ()) -&gt; m ())
-&gt; (Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal]) -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">EntityId
-&gt; (Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal]) -&gt; m ())
-&gt; Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; m ()
forall (m :: * -&gt; *) (r :: Row *) a.
(ICM m, CanReject m, (r .! &quot;canister_id&quot;) ~ Principal) =&gt;
EntityId -&gt; (Rec r -&gt; m a) -&gt; Rec r -&gt; m a
</span><a href="IC.Ref.html#onlyController"><span class="hs-identifier hs-var">onlyController</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322499"><span class="hs-identifier hs-var">caller</span></a></span><span> </span><span class="annot"><span class="annottext">Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal]) -&gt; m ()
forall (m :: * -&gt; *).
(ICM m, CanReject m) =&gt;
ICManagement m .! &quot;delete_canister&quot;
</span><a href="IC.Ref.html#icDeleteCanister"><span class="hs-identifier hs-var">icDeleteCanister</span></a></span><span>
</span><span id="line-786"></span><span>      </span><span class="hs-string">&quot;deposit_cycles&quot;</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal]) -&gt; m ()) -&gt; m ()
forall a b. (CandidArg a, CandidArg b) =&gt; (a -&gt; m b) -&gt; m ()
</span><a href="#local-6989586621679322495"><span class="hs-identifier hs-var">atomic</span></a></span><span> </span><span class="annot"><span class="annottext">((Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal]) -&gt; m ()) -&gt; m ())
-&gt; (Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal]) -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; ICManagement m .! &quot;deposit_cycles&quot;
forall (m :: * -&gt; *).
(ICM m, CanReject m) =&gt;
Int -&gt; ICManagement m .! &quot;deposit_cycles&quot;
</span><a href="IC.Ref.html#icDepositCycles"><span class="hs-identifier hs-var">icDepositCycles</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322498"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span>
</span><span id="line-787"></span><span>      </span><span class="hs-string">&quot;provisional_create_canister_with_cycles&quot;</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Rec
   ('R
      '[ &quot;amount&quot; ':-&gt; Maybe Natural,
         &quot;settings&quot;
         ':-&gt; Maybe
                (Rec
                   ('R
                      '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                         &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                         &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                         &quot;memory_allocation&quot; ':-&gt; Maybe Natural]))])
 -&gt; m (Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])))
-&gt; m ()
forall a b. (CandidArg a, CandidArg b) =&gt; (a -&gt; m b) -&gt; m ()
</span><a href="#local-6989586621679322495"><span class="hs-identifier hs-var">atomic</span></a></span><span> </span><span class="annot"><span class="annottext">((Rec
    ('R
       '[ &quot;amount&quot; ':-&gt; Maybe Natural,
          &quot;settings&quot;
          ':-&gt; Maybe
                 (Rec
                    ('R
                       '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                          &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                          &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                          &quot;memory_allocation&quot; ':-&gt; Maybe Natural]))])
  -&gt; m (Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])))
 -&gt; m ())
-&gt; (Rec
      ('R
         '[ &quot;amount&quot; ':-&gt; Maybe Natural,
            &quot;settings&quot;
            ':-&gt; Maybe
                   (Rec
                      ('R
                         '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                            &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                            &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                            &quot;memory_allocation&quot; ':-&gt; Maybe Natural]))])
    -&gt; m (Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])))
-&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">EntityId
-&gt; ICManagement m .! &quot;provisional_create_canister_with_cycles&quot;
forall (m :: * -&gt; *).
(ICM m, CanReject m) =&gt;
EntityId
-&gt; ICManagement m .! &quot;provisional_create_canister_with_cycles&quot;
</span><a href="IC.Ref.html#icCreateCanisterWithCycles"><span class="hs-identifier hs-var">icCreateCanisterWithCycles</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322499"><span class="hs-identifier hs-var">caller</span></a></span><span>
</span><span id="line-788"></span><span>      </span><span class="hs-string">&quot;provisional_top_up_canister&quot;</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Rec ('R '[ &quot;amount&quot; ':-&gt; Natural, &quot;canister_id&quot; ':-&gt; Principal])
 -&gt; m ())
-&gt; m ()
forall a b. (CandidArg a, CandidArg b) =&gt; (a -&gt; m b) -&gt; m ()
</span><a href="#local-6989586621679322495"><span class="hs-identifier hs-var">atomic</span></a></span><span> </span><span class="annot"><span class="annottext">Rec ('R '[ &quot;amount&quot; ':-&gt; Natural, &quot;canister_id&quot; ':-&gt; Principal])
-&gt; m ()
forall (m :: * -&gt; *).
(ICM m, CanReject m) =&gt;
ICManagement m .! &quot;provisional_top_up_canister&quot;
</span><a href="IC.Ref.html#icTopUpCanister"><span class="hs-identifier hs-var">icTopUpCanister</span></a></span><span>
</span><span id="line-789"></span><span>      </span><span class="hs-string">&quot;raw_rand&quot;</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(() -&gt; m Blob) -&gt; m ()
forall a b. (CandidArg a, CandidArg b) =&gt; (a -&gt; m b) -&gt; m ()
</span><a href="#local-6989586621679322495"><span class="hs-identifier hs-var">atomic</span></a></span><span> </span><span class="annot"><span class="annottext">() -&gt; m Blob
forall (m :: * -&gt; *). ICM m =&gt; ICManagement m .! &quot;raw_rand&quot;
</span><a href="IC.Ref.html#icRawRand"><span class="hs-identifier hs-var">icRawRand</span></a></span><span>
</span><span id="line-790"></span><span>      </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RejectCode -&gt; String -&gt; m ()
forall (m :: * -&gt; *) a2.
CanReject m =&gt;
RejectCode -&gt; String -&gt; m a2
</span><a href="IC.Ref.html#reject"><span class="hs-identifier hs-var">reject</span></a></span><span> </span><span class="annot"><span class="annottext">RejectCode
</span><a href="IC.Types.html#RC_DESTINATION_INVALID"><span class="hs-identifier hs-var">RC_DESTINATION_INVALID</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; m ()) -&gt; String -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Unsupported management function &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679322497"><span class="hs-identifier hs-var">method_name</span></a></span><span>
</span><span id="line-791"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-792"></span><span>    </span><span class="hs-comment">-- always responds</span><span>
</span><span id="line-793"></span><span>    </span><span class="annot"><a href="#local-6989586621679322495"><span class="hs-identifier hs-type">atomic</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679323277"><span class="annot"><a href="#local-6989586621679323277"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span id="local-6989586621679323276"><span class="annot"><a href="#local-6989586621679323276"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-operator">.</span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">CandidArg</span></span><span> </span><span class="annot"><a href="#local-6989586621679323277"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">CandidArg</span></span><span> </span><span class="annot"><a href="#local-6989586621679323276"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679323277"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323305"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323276"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323305"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-794"></span><span>    </span><span id="local-6989586621679322495"><span class="annot"><span class="annottext">atomic :: (a -&gt; m b) -&gt; m ()
</span><a href="#local-6989586621679322495"><span class="hs-identifier hs-var hs-var">atomic</span></a></span></span><span> </span><span id="local-6989586621679322480"><span class="annot"><span class="annottext">meth :: a -&gt; m b
</span><a href="#local-6989586621679322480"><span class="hs-identifier hs-var">meth</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((b -&gt; m ()) -&gt; a -&gt; m ()) -&gt; (Blob -&gt; m ()) -&gt; Blob -&gt; m ()
forall a b.
(CandidArg a, CandidArg b) =&gt;
((b -&gt; m ()) -&gt; a -&gt; m ()) -&gt; (Blob -&gt; m ()) -&gt; Blob -&gt; m ()
</span><a href="#local-6989586621679322479"><span class="hs-identifier hs-var">wrap</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679322478"><span class="annot"><span class="annottext">k :: b -&gt; m ()
</span><a href="#local-6989586621679322478"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span id="local-6989586621679322477"><span class="annot"><span class="annottext">x :: a
</span><a href="#local-6989586621679322477"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; m b
</span><a href="#local-6989586621679322480"><span class="hs-identifier hs-var">meth</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679322477"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">m b -&gt; (b -&gt; m ()) -&gt; m ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">b -&gt; m ()
</span><a href="#local-6989586621679322478"><span class="hs-identifier hs-var">k</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Blob -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; Int -&gt; Blob -&gt; m ()
</span><a href="IC.Ref.html#replyCallContext"><span class="hs-identifier hs-var">replyCallContext</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322498"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679322496"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-795"></span><span>
</span><span id="line-796"></span><span>    </span><span class="hs-comment">-- no implict reply</span><span>
</span><span id="line-797"></span><span>    </span><span class="annot"><a href="#local-6989586621679322488"><span class="hs-identifier hs-type">deferred</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679323265"><span class="annot"><a href="#local-6989586621679323265"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">CandidArg</span></span><span> </span><span class="annot"><a href="#local-6989586621679323265"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679323265"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323305"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323305"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-798"></span><span>    </span><span id="local-6989586621679322488"><span class="annot"><span class="annottext">deferred :: (a -&gt; m ()) -&gt; m ()
</span><a href="#local-6989586621679322488"><span class="hs-identifier hs-var hs-var">deferred</span></a></span></span><span> </span><span id="local-6989586621679322476"><span class="annot"><span class="annottext">meth :: a -&gt; m ()
</span><a href="#local-6989586621679322476"><span class="hs-identifier hs-var">meth</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((() -&gt; m ()) -&gt; a -&gt; m ()) -&gt; (Blob -&gt; m ()) -&gt; Blob -&gt; m ()
forall a b.
(CandidArg a, CandidArg b) =&gt;
((b -&gt; m ()) -&gt; a -&gt; m ()) -&gt; (Blob -&gt; m ()) -&gt; Blob -&gt; m ()
</span><a href="#local-6989586621679322479"><span class="hs-identifier hs-var">wrap</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621679323265"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679322475"><span class="annot"><span class="annottext">_k :: () -&gt; m ()
</span><a href="#local-6989586621679322475"><span class="hs-identifier hs-var">_k</span></a></span></span><span> </span><span id="local-6989586621679322474"><span class="annot"><span class="annottext">x :: a
</span><a href="#local-6989586621679322474"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; m ()
</span><a href="#local-6989586621679322476"><span class="hs-identifier hs-var">meth</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679322474"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Blob -&gt; m ()
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="hs-string">&quot;unused&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679322496"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-799"></span><span>
</span><span id="line-800"></span><span>    </span><span class="annot"><a href="#local-6989586621679322479"><span class="hs-identifier hs-type">wrap</span></a></span><span>
</span><span id="line-801"></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679323253"><span class="annot"><a href="#local-6989586621679323253"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span id="local-6989586621679323252"><span class="annot"><a href="#local-6989586621679323252"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-802"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">CandidArg</span></span><span> </span><span class="annot"><a href="#local-6989586621679323253"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">CandidArg</span></span><span> </span><span class="annot"><a href="#local-6989586621679323252"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-803"></span><span>      </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679323252"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323305"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323253"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323305"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-804"></span><span>      </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><a href="IC.Types.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323305"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323305"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-805"></span><span>    </span><span id="local-6989586621679322479"><span class="annot"><span class="annottext">wrap :: ((b -&gt; m ()) -&gt; a -&gt; m ()) -&gt; (Blob -&gt; m ()) -&gt; Blob -&gt; m ()
</span><a href="#local-6989586621679322479"><span class="hs-identifier hs-var hs-var">wrap</span></a></span></span><span> </span><span id="local-6989586621679322473"><span class="annot"><span class="annottext">method :: (b -&gt; m ()) -&gt; a -&gt; m ()
</span><a href="#local-6989586621679322473"><span class="hs-identifier hs-var">method</span></a></span></span><span> </span><span id="local-6989586621679322472"><span class="annot"><span class="annottext">raw_reply :: Blob -&gt; m ()
</span><a href="#local-6989586621679322472"><span class="hs-identifier hs-var">raw_reply</span></a></span></span><span> </span><span id="local-6989586621679322471"><span class="annot"><span class="annottext">blob :: Blob
</span><a href="#local-6989586621679322471"><span class="hs-identifier hs-var">blob</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-806"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Blob -&gt; Either String a
forall a. CandidArg a =&gt; Blob -&gt; Either String a
</span><span class="hs-identifier hs-var">decode</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621679323253"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679322471"><span class="hs-identifier hs-var">blob</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-807"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679322470"><span class="annot"><span class="annottext">msg :: String
</span><a href="#local-6989586621679322470"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RejectCode -&gt; String -&gt; m ()
forall (m :: * -&gt; *) a2.
CanReject m =&gt;
RejectCode -&gt; String -&gt; m a2
</span><a href="IC.Ref.html#reject"><span class="hs-identifier hs-var">reject</span></a></span><span> </span><span class="annot"><span class="annottext">RejectCode
</span><a href="IC.Types.html#RC_CANISTER_ERROR"><span class="hs-identifier hs-var">RC_CANISTER_ERROR</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; m ()) -&gt; String -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Candid failed to decode: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679322470"><span class="hs-identifier hs-var">msg</span></a></span><span>
</span><span id="line-808"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679322469"><span class="annot"><span class="annottext">x :: a
</span><a href="#local-6989586621679322469"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(b -&gt; m ()) -&gt; a -&gt; m ()
</span><a href="#local-6989586621679322473"><span class="hs-identifier hs-var">method</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Blob -&gt; m ()
</span><a href="#local-6989586621679322472"><span class="hs-identifier hs-var">raw_reply</span></a></span><span> </span><span class="annot"><span class="annottext">(Blob -&gt; m ()) -&gt; (b -&gt; Blob) -&gt; b -&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">CandidArg b =&gt; b -&gt; Blob
forall a. CandidArg a =&gt; a -&gt; Blob
</span><span class="hs-identifier hs-var">encode</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621679323252"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679322469"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-809"></span><span>
</span><span id="line-810"></span><span class="annot"><a href="IC.Ref.html#invokeManagementCanister"><span class="hs-identifier hs-var">invokeManagementCanister</span></a></span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="annot"><a href="IC.Ref.html#Closure"><span class="hs-identifier hs-type">Closure</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; m ()
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="hs-string">&quot;closure invoked on management function &quot;</span></span><span>
</span><span id="line-811"></span><span>
</span><span id="line-812"></span><span id="local-6989586621679323274"><span class="annot"><a href="IC.Ref.html#icCreateCanister"><span class="hs-identifier hs-type">icCreateCanister</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323274"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#CanReject"><span class="hs-identifier hs-type">CanReject</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323274"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#EntityId"><span class="hs-identifier hs-type">EntityId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Ref.html#CallId"><span class="hs-identifier hs-type">CallId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Management.html#ICManagement"><span class="hs-identifier hs-type">ICManagement</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323274"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">.!</span></span><span> </span><span class="annot"><span class="hs-string">&quot;create_canister&quot;</span></span></span><span>
</span><span id="line-813"></span><span id="icCreateCanister"><span class="annot"><span class="annottext">icCreateCanister :: EntityId -&gt; Int -&gt; ICManagement m .! &quot;create_canister&quot;
</span><a href="IC.Ref.html#icCreateCanister"><span class="hs-identifier hs-var hs-var">icCreateCanister</span></a></span></span><span> </span><span id="local-6989586621679322467"><span class="annot"><span class="annottext">caller :: EntityId
</span><a href="#local-6989586621679322467"><span class="hs-identifier hs-var">caller</span></a></span></span><span> </span><span id="local-6989586621679322466"><span class="annot"><span class="annottext">ctxt_id :: Int
</span><a href="#local-6989586621679322466"><span class="hs-identifier hs-var">ctxt_id</span></a></span></span><span> </span><span id="local-6989586621679322465"><span class="annot"><span class="annottext">r :: Rec
  ('R
     '[ &quot;settings&quot;
        ':-&gt; Maybe
               (Rec
                  ('R
                     '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                        &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                        &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                        &quot;memory_allocation&quot; ':-&gt; Maybe Natural]))])
</span><a href="#local-6989586621679322465"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-814"></span><span>    </span><span class="annot"><span class="annottext">Maybe
  (Rec
     ('R
        '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
           &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
           &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
           &quot;memory_allocation&quot; ':-&gt; Maybe Natural]))
-&gt; (Rec
      ('R
         '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
            &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
            &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
            &quot;memory_allocation&quot; ':-&gt; Maybe Natural])
    -&gt; m ())
-&gt; m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Rec
  ('R
     '[ &quot;settings&quot;
        ':-&gt; Maybe
               (Rec
                  ('R
                     '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                        &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                        &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                        &quot;memory_allocation&quot; ':-&gt; Maybe Natural]))])
</span><a href="#local-6989586621679322465"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Rec
  ('R
     '[ &quot;settings&quot;
        ':-&gt; Maybe
               (Rec
                  ('R
                     '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                        &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                        &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                        &quot;memory_allocation&quot; ':-&gt; Maybe Natural]))])
-&gt; Label &quot;settings&quot;
-&gt; 'R
     '[ &quot;settings&quot;
        ':-&gt; Maybe
               (Rec
                  ('R
                     '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                        &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                        &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                        &quot;memory_allocation&quot; ':-&gt; Maybe Natural]))]
   .! &quot;settings&quot;
forall (l :: Symbol) (r :: Row *).
KnownSymbol l =&gt;
Rec r -&gt; Label l -&gt; r .! l
</span><span class="hs-operator hs-var">.!</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;settings&quot; (Label &quot;settings&quot;)
Label &quot;settings&quot;
</span><a href="#local-6989586621679322464"><span class="hs-var">#settings</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Rec
  ('R
     '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
        &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
        &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
        &quot;memory_allocation&quot; ':-&gt; Maybe Natural])
-&gt; m ()
forall (m :: * -&gt; *). CanReject m =&gt; Settings -&gt; m ()
</span><a href="IC.Ref.html#validateSettings"><span class="hs-identifier hs-var">validateSettings</span></a></span><span>
</span><span id="line-815"></span><span>    </span><span id="local-6989586621679322462"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679322462"><span class="hs-identifier hs-var">available</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; m Natural
forall (m :: * -&gt; *). ICM m =&gt; Int -&gt; m Natural
</span><a href="IC.Ref.html#getCallContextCycles"><span class="hs-identifier hs-var">getCallContextCycles</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322466"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span>
</span><span id="line-816"></span><span>    </span><span class="annot"><span class="annottext">Int -&gt; Natural -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; Int -&gt; Natural -&gt; m ()
</span><a href="IC.Ref.html#setCallContextCycles"><span class="hs-identifier hs-var">setCallContextCycles</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322466"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span> </span><span class="annot"><span class="hs-number">0</span></span><span>
</span><span id="line-817"></span><span>    </span><span id="local-6989586621679322461"><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322461"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; Natural -&gt; m EntityId
forall (m :: * -&gt; *).
(ICM m, CanReject m) =&gt;
EntityId -&gt; Natural -&gt; m EntityId
</span><a href="IC.Ref.html#icCreateCanisterCommon"><span class="hs-identifier hs-var">icCreateCanisterCommon</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322467"><span class="hs-identifier hs-var">caller</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679322462"><span class="hs-identifier hs-var">available</span></a></span><span>
</span><span id="line-818"></span><span>    </span><span class="annot"><span class="annottext">Maybe
  (Rec
     ('R
        '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
           &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
           &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
           &quot;memory_allocation&quot; ':-&gt; Maybe Natural]))
-&gt; (Rec
      ('R
         '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
            &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
            &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
            &quot;memory_allocation&quot; ':-&gt; Maybe Natural])
    -&gt; m ())
-&gt; m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Rec
  ('R
     '[ &quot;settings&quot;
        ':-&gt; Maybe
               (Rec
                  ('R
                     '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                        &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                        &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                        &quot;memory_allocation&quot; ':-&gt; Maybe Natural]))])
</span><a href="#local-6989586621679322465"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Rec
  ('R
     '[ &quot;settings&quot;
        ':-&gt; Maybe
               (Rec
                  ('R
                     '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                        &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                        &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                        &quot;memory_allocation&quot; ':-&gt; Maybe Natural]))])
-&gt; Label &quot;settings&quot;
-&gt; 'R
     '[ &quot;settings&quot;
        ':-&gt; Maybe
               (Rec
                  ('R
                     '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                        &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                        &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                        &quot;memory_allocation&quot; ':-&gt; Maybe Natural]))]
   .! &quot;settings&quot;
forall (l :: Symbol) (r :: Row *).
KnownSymbol l =&gt;
Rec r -&gt; Label l -&gt; r .! l
</span><span class="hs-operator hs-var">.!</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;settings&quot; (Label &quot;settings&quot;)
Label &quot;settings&quot;
</span><a href="#local-6989586621679322459"><span class="hs-var">#settings</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((Rec
    ('R
       '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
          &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
          &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
          &quot;memory_allocation&quot; ':-&gt; Maybe Natural])
  -&gt; m ())
 -&gt; m ())
-&gt; (Rec
      ('R
         '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
            &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
            &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
            &quot;memory_allocation&quot; ':-&gt; Maybe Natural])
    -&gt; m ())
-&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; Settings -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; Settings -&gt; m ()
</span><a href="IC.Ref.html#applySettings"><span class="hs-identifier hs-var">applySettings</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322461"><span class="hs-identifier hs-var">cid</span></a></span><span>
</span><span id="line-819"></span><span>    </span><span class="annot"><span class="annottext">Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; m (Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal]))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IsLabel &quot;canister_id&quot; (Label &quot;canister_id&quot;)
Label &quot;canister_id&quot;
</span><a href="#local-6989586621679322457"><span class="hs-var">#canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">Label &quot;canister_id&quot;
-&gt; Principal -&gt; Rec (&quot;canister_id&quot; .== Principal)
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec (l .== a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; Principal
</span><a href="IC.Management.html#entityIdToPrincipal"><span class="hs-identifier hs-var">entityIdToPrincipal</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322461"><span class="hs-identifier hs-var">cid</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-820"></span><span>
</span><span id="line-821"></span><span id="local-6989586621679323258"><span class="annot"><a href="IC.Ref.html#icCreateCanisterWithCycles"><span class="hs-identifier hs-type">icCreateCanisterWithCycles</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323258"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#CanReject"><span class="hs-identifier hs-type">CanReject</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323258"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#EntityId"><span class="hs-identifier hs-type">EntityId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Management.html#ICManagement"><span class="hs-identifier hs-type">ICManagement</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323258"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">.!</span></span><span> </span><span class="annot"><span class="hs-string">&quot;provisional_create_canister_with_cycles&quot;</span></span></span><span>
</span><span id="line-822"></span><span id="icCreateCanisterWithCycles"><span class="annot"><span class="annottext">icCreateCanisterWithCycles :: EntityId
-&gt; ICManagement m .! &quot;provisional_create_canister_with_cycles&quot;
</span><a href="IC.Ref.html#icCreateCanisterWithCycles"><span class="hs-identifier hs-var hs-var">icCreateCanisterWithCycles</span></a></span></span><span> </span><span id="local-6989586621679322455"><span class="annot"><span class="annottext">caller :: EntityId
</span><a href="#local-6989586621679322455"><span class="hs-identifier hs-var">caller</span></a></span></span><span> </span><span id="local-6989586621679322454"><span class="annot"><span class="annottext">r :: Rec
  ('R
     '[ &quot;amount&quot; ':-&gt; Maybe Natural,
        &quot;settings&quot;
        ':-&gt; Maybe
               (Rec
                  ('R
                     '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                        &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                        &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                        &quot;memory_allocation&quot; ':-&gt; Maybe Natural]))])
</span><a href="#local-6989586621679322454"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-823"></span><span>    </span><span class="annot"><span class="annottext">Maybe
  (Rec
     ('R
        '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
           &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
           &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
           &quot;memory_allocation&quot; ':-&gt; Maybe Natural]))
-&gt; (Rec
      ('R
         '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
            &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
            &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
            &quot;memory_allocation&quot; ':-&gt; Maybe Natural])
    -&gt; m ())
-&gt; m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Rec
  ('R
     '[ &quot;amount&quot; ':-&gt; Maybe Natural,
        &quot;settings&quot;
        ':-&gt; Maybe
               (Rec
                  ('R
                     '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                        &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                        &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                        &quot;memory_allocation&quot; ':-&gt; Maybe Natural]))])
</span><a href="#local-6989586621679322454"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Rec
  ('R
     '[ &quot;amount&quot; ':-&gt; Maybe Natural,
        &quot;settings&quot;
        ':-&gt; Maybe
               (Rec
                  ('R
                     '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                        &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                        &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                        &quot;memory_allocation&quot; ':-&gt; Maybe Natural]))])
-&gt; Label &quot;settings&quot;
-&gt; 'R
     '[ &quot;amount&quot; ':-&gt; Maybe Natural,
        &quot;settings&quot;
        ':-&gt; Maybe
               (Rec
                  ('R
                     '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                        &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                        &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                        &quot;memory_allocation&quot; ':-&gt; Maybe Natural]))]
   .! &quot;settings&quot;
forall (l :: Symbol) (r :: Row *).
KnownSymbol l =&gt;
Rec r -&gt; Label l -&gt; r .! l
</span><span class="hs-operator hs-var">.!</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;settings&quot; (Label &quot;settings&quot;)
Label &quot;settings&quot;
</span><a href="#local-6989586621679322453"><span class="hs-var">#settings</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Rec
  ('R
     '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
        &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
        &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
        &quot;memory_allocation&quot; ':-&gt; Maybe Natural])
-&gt; m ()
forall (m :: * -&gt; *). CanReject m =&gt; Settings -&gt; m ()
</span><a href="IC.Ref.html#validateSettings"><span class="hs-identifier hs-var">validateSettings</span></a></span><span>
</span><span id="line-824"></span><span>    </span><span id="local-6989586621679322452"><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322452"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; Natural -&gt; m EntityId
forall (m :: * -&gt; *).
(ICM m, CanReject m) =&gt;
EntityId -&gt; Natural -&gt; m EntityId
</span><a href="IC.Ref.html#icCreateCanisterCommon"><span class="hs-identifier hs-var">icCreateCanisterCommon</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322455"><span class="hs-identifier hs-var">caller</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Natural -&gt; Maybe Natural -&gt; Natural
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="IC.Constants.html#cMAX_CANISTER_BALANCE"><span class="hs-identifier hs-var">cMAX_CANISTER_BALANCE</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Rec
  ('R
     '[ &quot;amount&quot; ':-&gt; Maybe Natural,
        &quot;settings&quot;
        ':-&gt; Maybe
               (Rec
                  ('R
                     '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                        &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                        &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                        &quot;memory_allocation&quot; ':-&gt; Maybe Natural]))])
</span><a href="#local-6989586621679322454"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Rec
  ('R
     '[ &quot;amount&quot; ':-&gt; Maybe Natural,
        &quot;settings&quot;
        ':-&gt; Maybe
               (Rec
                  ('R
                     '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                        &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                        &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                        &quot;memory_allocation&quot; ':-&gt; Maybe Natural]))])
-&gt; Label &quot;amount&quot;
-&gt; 'R
     '[ &quot;amount&quot; ':-&gt; Maybe Natural,
        &quot;settings&quot;
        ':-&gt; Maybe
               (Rec
                  ('R
                     '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                        &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                        &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                        &quot;memory_allocation&quot; ':-&gt; Maybe Natural]))]
   .! &quot;amount&quot;
forall (l :: Symbol) (r :: Row *).
KnownSymbol l =&gt;
Rec r -&gt; Label l -&gt; r .! l
</span><span class="hs-operator hs-var">.!</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;amount&quot; (Label &quot;amount&quot;)
Label &quot;amount&quot;
</span><a href="#local-6989586621679322451"><span class="hs-var">#amount</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-825"></span><span>    </span><span class="annot"><span class="annottext">Maybe
  (Rec
     ('R
        '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
           &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
           &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
           &quot;memory_allocation&quot; ':-&gt; Maybe Natural]))
-&gt; (Rec
      ('R
         '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
            &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
            &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
            &quot;memory_allocation&quot; ':-&gt; Maybe Natural])
    -&gt; m ())
-&gt; m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Rec
  ('R
     '[ &quot;amount&quot; ':-&gt; Maybe Natural,
        &quot;settings&quot;
        ':-&gt; Maybe
               (Rec
                  ('R
                     '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                        &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                        &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                        &quot;memory_allocation&quot; ':-&gt; Maybe Natural]))])
</span><a href="#local-6989586621679322454"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Rec
  ('R
     '[ &quot;amount&quot; ':-&gt; Maybe Natural,
        &quot;settings&quot;
        ':-&gt; Maybe
               (Rec
                  ('R
                     '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                        &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                        &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                        &quot;memory_allocation&quot; ':-&gt; Maybe Natural]))])
-&gt; Label &quot;settings&quot;
-&gt; 'R
     '[ &quot;amount&quot; ':-&gt; Maybe Natural,
        &quot;settings&quot;
        ':-&gt; Maybe
               (Rec
                  ('R
                     '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                        &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                        &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                        &quot;memory_allocation&quot; ':-&gt; Maybe Natural]))]
   .! &quot;settings&quot;
forall (l :: Symbol) (r :: Row *).
KnownSymbol l =&gt;
Rec r -&gt; Label l -&gt; r .! l
</span><span class="hs-operator hs-var">.!</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;settings&quot; (Label &quot;settings&quot;)
Label &quot;settings&quot;
</span><a href="#local-6989586621679322450"><span class="hs-var">#settings</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((Rec
    ('R
       '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
          &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
          &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
          &quot;memory_allocation&quot; ':-&gt; Maybe Natural])
  -&gt; m ())
 -&gt; m ())
-&gt; (Rec
      ('R
         '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
            &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
            &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
            &quot;memory_allocation&quot; ':-&gt; Maybe Natural])
    -&gt; m ())
-&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; Settings -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; Settings -&gt; m ()
</span><a href="IC.Ref.html#applySettings"><span class="hs-identifier hs-var">applySettings</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322452"><span class="hs-identifier hs-var">cid</span></a></span><span>
</span><span id="line-826"></span><span>    </span><span class="annot"><span class="annottext">Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; m (Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal]))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IsLabel &quot;canister_id&quot; (Label &quot;canister_id&quot;)
Label &quot;canister_id&quot;
</span><a href="#local-6989586621679322449"><span class="hs-var">#canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">Label &quot;canister_id&quot;
-&gt; Principal -&gt; Rec (&quot;canister_id&quot; .== Principal)
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec (l .== a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; Principal
</span><a href="IC.Management.html#entityIdToPrincipal"><span class="hs-identifier hs-var">entityIdToPrincipal</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322452"><span class="hs-identifier hs-var">cid</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-827"></span><span>
</span><span id="line-828"></span><span id="local-6989586621679323243"><span class="annot"><a href="IC.Ref.html#icCreateCanisterCommon"><span class="hs-identifier hs-type">icCreateCanisterCommon</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323243"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#CanReject"><span class="hs-identifier hs-type">CanReject</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323243"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#EntityId"><span class="hs-identifier hs-type">EntityId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Natural</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323243"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="IC.Types.html#EntityId"><span class="hs-identifier hs-type">EntityId</span></a></span></span><span>
</span><span id="line-829"></span><span id="icCreateCanisterCommon"><span class="annot"><span class="annottext">icCreateCanisterCommon :: EntityId -&gt; Natural -&gt; m EntityId
</span><a href="IC.Ref.html#icCreateCanisterCommon"><span class="hs-identifier hs-var hs-var">icCreateCanisterCommon</span></a></span></span><span> </span><span id="local-6989586621679322448"><span class="annot"><span class="annottext">controller :: EntityId
</span><a href="#local-6989586621679322448"><span class="hs-identifier hs-var">controller</span></a></span></span><span> </span><span id="local-6989586621679322447"><span class="annot"><span class="annottext">amount :: Natural
</span><a href="#local-6989586621679322447"><span class="hs-identifier hs-var">amount</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-830"></span><span>    </span><span id="local-6989586621679322446"><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322446"><span class="hs-identifier hs-var">new_id</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(IC -&gt; EntityId) -&gt; m EntityId
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[EntityId] -&gt; EntityId
</span><a href="IC.Id.Fresh.html#freshId"><span class="hs-identifier hs-var">freshId</span></a></span><span> </span><span class="annot"><span class="annottext">([EntityId] -&gt; EntityId) -&gt; (IC -&gt; [EntityId]) -&gt; IC -&gt; EntityId
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(EntityId &#8614; CanState) -&gt; [EntityId]
forall k a. Map k a -&gt; [k]
</span><span class="hs-identifier hs-var">M.keys</span></span><span> </span><span class="annot"><span class="annottext">((EntityId &#8614; CanState) -&gt; [EntityId])
-&gt; (IC -&gt; EntityId &#8614; CanState) -&gt; IC -&gt; [EntityId]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">IC -&gt; EntityId &#8614; CanState
</span><a href="IC.Ref.html#canisters"><span class="hs-identifier hs-var hs-var">canisters</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-831"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679322443"><span class="annot"><span class="annottext">currentTime :: Timestamp
</span><a href="#local-6989586621679322443"><span class="hs-identifier hs-var hs-var">currentTime</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-number">0</span></span><span> </span><span class="hs-comment">-- ic-ref lives in the 70ies</span><span>
</span><span id="line-832"></span><span>    </span><span class="annot"><span class="annottext">EntityId -&gt; Set EntityId -&gt; Timestamp -&gt; m ()
forall (m :: * -&gt; *).
ICM m =&gt;
EntityId -&gt; Set EntityId -&gt; Timestamp -&gt; m ()
</span><a href="IC.Ref.html#createEmptyCanister"><span class="hs-identifier hs-var">createEmptyCanister</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322446"><span class="hs-identifier hs-var">new_id</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EntityId -&gt; Set EntityId
forall a. a -&gt; Set a
</span><span class="hs-identifier hs-var">S.singleton</span></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322448"><span class="hs-identifier hs-var">controller</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Timestamp
</span><a href="#local-6989586621679322443"><span class="hs-identifier hs-var">currentTime</span></a></span><span>
</span><span id="line-833"></span><span>    </span><span class="hs-comment">-- Here we fill up the canister with the cycles provided by the caller</span><span>
</span><span id="line-834"></span><span>    </span><span class="annot"><span class="annottext">EntityId -&gt; Natural -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; Natural -&gt; m ()
</span><a href="IC.Ref.html#setBalance"><span class="hs-identifier hs-var">setBalance</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322446"><span class="hs-identifier hs-var">new_id</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679322447"><span class="hs-identifier hs-var">amount</span></a></span><span>
</span><span id="line-835"></span><span>    </span><span class="annot"><span class="annottext">EntityId -&gt; m EntityId
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322446"><span class="hs-identifier hs-var">new_id</span></a></span><span>
</span><span id="line-836"></span><span>
</span><span id="line-837"></span><span id="local-6989586621679323245"><span class="annot"><a href="IC.Ref.html#validateSettings"><span class="hs-identifier hs-type">validateSettings</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#CanReject"><span class="hs-identifier hs-type">CanReject</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323245"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Management.html#Settings"><span class="hs-identifier hs-type">Settings</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323245"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-838"></span><span id="validateSettings"><span class="annot"><span class="annottext">validateSettings :: Settings -&gt; m ()
</span><a href="IC.Ref.html#validateSettings"><span class="hs-identifier hs-var hs-var">validateSettings</span></a></span></span><span> </span><span id="local-6989586621679322441"><span class="annot"><span class="annottext">r :: Settings
</span><a href="#local-6989586621679322441"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-839"></span><span>    </span><span class="annot"><span class="annottext">Maybe Natural -&gt; (Natural -&gt; m ()) -&gt; m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Settings
Rec
  ('R
     '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
        &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
        &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
        &quot;memory_allocation&quot; ':-&gt; Maybe Natural])
</span><a href="#local-6989586621679322441"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Rec
  ('R
     '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
        &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
        &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
        &quot;memory_allocation&quot; ':-&gt; Maybe Natural])
-&gt; Label &quot;compute_allocation&quot;
-&gt; 'R
     '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
        &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
        &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
        &quot;memory_allocation&quot; ':-&gt; Maybe Natural]
   .! &quot;compute_allocation&quot;
forall (l :: Symbol) (r :: Row *).
KnownSymbol l =&gt;
Rec r -&gt; Label l -&gt; r .! l
</span><span class="hs-operator hs-var">.!</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;compute_allocation&quot; (Label &quot;compute_allocation&quot;)
Label &quot;compute_allocation&quot;
</span><a href="#local-6989586621679322440"><span class="hs-var">#compute_allocation</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((Natural -&gt; m ()) -&gt; m ()) -&gt; (Natural -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679322439"><span class="annot"><span class="annottext">n :: Natural
</span><a href="#local-6989586621679322439"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-840"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679322439"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; Natural -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="hs-number">100</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-841"></span><span>            </span><span class="annot"><span class="annottext">RejectCode -&gt; String -&gt; m ()
forall (m :: * -&gt; *) a2.
CanReject m =&gt;
RejectCode -&gt; String -&gt; m a2
</span><a href="IC.Ref.html#reject"><span class="hs-identifier hs-var">reject</span></a></span><span> </span><span class="annot"><span class="annottext">RejectCode
</span><a href="IC.Types.html#RC_SYS_FATAL"><span class="hs-identifier hs-var">RC_SYS_FATAL</span></a></span><span>  </span><span class="annot"><span class="hs-string">&quot;Compute allocation not &lt;= 100&quot;</span></span><span>
</span><span id="line-842"></span><span>    </span><span class="annot"><span class="annottext">Maybe Natural -&gt; (Natural -&gt; m ()) -&gt; m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Settings
Rec
  ('R
     '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
        &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
        &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
        &quot;memory_allocation&quot; ':-&gt; Maybe Natural])
</span><a href="#local-6989586621679322441"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Rec
  ('R
     '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
        &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
        &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
        &quot;memory_allocation&quot; ':-&gt; Maybe Natural])
-&gt; Label &quot;memory_allocation&quot;
-&gt; 'R
     '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
        &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
        &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
        &quot;memory_allocation&quot; ':-&gt; Maybe Natural]
   .! &quot;memory_allocation&quot;
forall (l :: Symbol) (r :: Row *).
KnownSymbol l =&gt;
Rec r -&gt; Label l -&gt; r .! l
</span><span class="hs-operator hs-var">.!</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;memory_allocation&quot; (Label &quot;memory_allocation&quot;)
Label &quot;memory_allocation&quot;
</span><a href="#local-6989586621679322437"><span class="hs-var">#memory_allocation</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((Natural -&gt; m ()) -&gt; m ()) -&gt; (Natural -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679322436"><span class="annot"><span class="annottext">n :: Natural
</span><a href="#local-6989586621679322436"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-843"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679322436"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; Natural -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="hs-number">2</span></span><span class="annot"><span class="annottext">Natural -&gt; Int -&gt; Natural
forall a b. (Num a, Integral b) =&gt; a -&gt; b -&gt; a
</span><span class="hs-operator hs-var">^</span></span><span class="hs-special">(</span><span class="annot"><span class="hs-number">48</span></span><span class="hs-glyph">::</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-844"></span><span>            </span><span class="annot"><span class="annottext">RejectCode -&gt; String -&gt; m ()
forall (m :: * -&gt; *) a2.
CanReject m =&gt;
RejectCode -&gt; String -&gt; m a2
</span><a href="IC.Ref.html#reject"><span class="hs-identifier hs-var">reject</span></a></span><span> </span><span class="annot"><span class="annottext">RejectCode
</span><a href="IC.Types.html#RC_SYS_FATAL"><span class="hs-identifier hs-var">RC_SYS_FATAL</span></a></span><span>  </span><span class="annot"><span class="hs-string">&quot;Memory allocation not &lt;= 2^48&quot;</span></span><span>
</span><span id="line-845"></span><span>    </span><span class="annot"><span class="annottext">Maybe Natural -&gt; (Natural -&gt; m ()) -&gt; m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Settings
Rec
  ('R
     '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
        &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
        &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
        &quot;memory_allocation&quot; ':-&gt; Maybe Natural])
</span><a href="#local-6989586621679322441"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Rec
  ('R
     '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
        &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
        &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
        &quot;memory_allocation&quot; ':-&gt; Maybe Natural])
-&gt; Label &quot;freezing_threshold&quot;
-&gt; 'R
     '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
        &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
        &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
        &quot;memory_allocation&quot; ':-&gt; Maybe Natural]
   .! &quot;freezing_threshold&quot;
forall (l :: Symbol) (r :: Row *).
KnownSymbol l =&gt;
Rec r -&gt; Label l -&gt; r .! l
</span><span class="hs-operator hs-var">.!</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;freezing_threshold&quot; (Label &quot;freezing_threshold&quot;)
Label &quot;freezing_threshold&quot;
</span><a href="#local-6989586621679322434"><span class="hs-var">#freezing_threshold</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((Natural -&gt; m ()) -&gt; m ()) -&gt; (Natural -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679322433"><span class="annot"><span class="annottext">n :: Natural
</span><a href="#local-6989586621679322433"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-846"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679322433"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; Natural -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="hs-number">2</span></span><span class="annot"><span class="annottext">Natural -&gt; Int -&gt; Natural
forall a b. (Num a, Integral b) =&gt; a -&gt; b -&gt; a
</span><span class="hs-operator hs-var">^</span></span><span class="hs-special">(</span><span class="annot"><span class="hs-number">64</span></span><span class="hs-glyph">::</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-847"></span><span>            </span><span class="annot"><span class="annottext">RejectCode -&gt; String -&gt; m ()
forall (m :: * -&gt; *) a2.
CanReject m =&gt;
RejectCode -&gt; String -&gt; m a2
</span><a href="IC.Ref.html#reject"><span class="hs-identifier hs-var">reject</span></a></span><span> </span><span class="annot"><span class="annottext">RejectCode
</span><a href="IC.Types.html#RC_SYS_FATAL"><span class="hs-identifier hs-var">RC_SYS_FATAL</span></a></span><span>  </span><span class="annot"><span class="hs-string">&quot;Memory allocation not &lt; 2^64&quot;</span></span><span>
</span><span id="line-848"></span><span>    </span><span class="annot"><span class="annottext">Maybe (Vector Principal) -&gt; (Vector Principal -&gt; m ()) -&gt; m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Settings
Rec
  ('R
     '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
        &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
        &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
        &quot;memory_allocation&quot; ':-&gt; Maybe Natural])
</span><a href="#local-6989586621679322441"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Rec
  ('R
     '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
        &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
        &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
        &quot;memory_allocation&quot; ':-&gt; Maybe Natural])
-&gt; Label &quot;controllers&quot;
-&gt; 'R
     '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
        &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
        &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
        &quot;memory_allocation&quot; ':-&gt; Maybe Natural]
   .! &quot;controllers&quot;
forall (l :: Symbol) (r :: Row *).
KnownSymbol l =&gt;
Rec r -&gt; Label l -&gt; r .! l
</span><span class="hs-operator hs-var">.!</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;controllers&quot; (Label &quot;controllers&quot;)
Label &quot;controllers&quot;
</span><a href="#local-6989586621679322431"><span class="hs-var">#controllers</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((Vector Principal -&gt; m ()) -&gt; m ())
-&gt; (Vector Principal -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679322430"><span class="annot"><span class="annottext">n :: Vector Principal
</span><a href="#local-6989586621679322430"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-849"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Vector Principal -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">Vector Principal
</span><a href="#local-6989586621679322430"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="hs-number">10</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-850"></span><span>            </span><span class="annot"><span class="annottext">RejectCode -&gt; String -&gt; m ()
forall (m :: * -&gt; *) a2.
CanReject m =&gt;
RejectCode -&gt; String -&gt; m a2
</span><a href="IC.Ref.html#reject"><span class="hs-identifier hs-var">reject</span></a></span><span> </span><span class="annot"><span class="annottext">RejectCode
</span><a href="IC.Types.html#RC_SYS_FATAL"><span class="hs-identifier hs-var">RC_SYS_FATAL</span></a></span><span>  </span><span class="annot"><span class="hs-string">&quot;Controllers cannot be &gt; 10&quot;</span></span><span>
</span><span id="line-851"></span><span>
</span><span id="line-852"></span><span id="local-6989586621679323242"><span class="annot"><a href="IC.Ref.html#applySettings"><span class="hs-identifier hs-type">applySettings</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323242"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#EntityId"><span class="hs-identifier hs-type">EntityId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Management.html#Settings"><span class="hs-identifier hs-type">Settings</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323242"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-853"></span><span id="applySettings"><span class="annot"><span class="annottext">applySettings :: EntityId -&gt; Settings -&gt; m ()
</span><a href="IC.Ref.html#applySettings"><span class="hs-identifier hs-var hs-var">applySettings</span></a></span></span><span> </span><span id="local-6989586621679322428"><span class="annot"><span class="annottext">cid :: EntityId
</span><a href="#local-6989586621679322428"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span id="local-6989586621679322427"><span class="annot"><span class="annottext">r :: Settings
</span><a href="#local-6989586621679322427"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-854"></span><span>    </span><span class="annot"><span class="annottext">Maybe (Vector Principal) -&gt; (Vector Principal -&gt; m ()) -&gt; m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Settings
Rec
  ('R
     '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
        &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
        &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
        &quot;memory_allocation&quot; ':-&gt; Maybe Natural])
</span><a href="#local-6989586621679322427"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Rec
  ('R
     '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
        &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
        &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
        &quot;memory_allocation&quot; ':-&gt; Maybe Natural])
-&gt; Label &quot;controllers&quot;
-&gt; 'R
     '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
        &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
        &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
        &quot;memory_allocation&quot; ':-&gt; Maybe Natural]
   .! &quot;controllers&quot;
forall (l :: Symbol) (r :: Row *).
KnownSymbol l =&gt;
Rec r -&gt; Label l -&gt; r .! l
</span><span class="hs-operator hs-var">.!</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;controllers&quot; (Label &quot;controllers&quot;)
Label &quot;controllers&quot;
</span><a href="#local-6989586621679322426"><span class="hs-var">#controllers</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((Vector Principal -&gt; m ()) -&gt; m ())
-&gt; (Vector Principal -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; Set EntityId -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; Set EntityId -&gt; m ()
</span><a href="IC.Ref.html#setControllers"><span class="hs-identifier hs-var">setControllers</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322428"><span class="hs-identifier hs-var">cid</span></a></span><span> </span><span class="annot"><span class="annottext">(Set EntityId -&gt; m ())
-&gt; (Vector Principal -&gt; Set EntityId) -&gt; Vector Principal -&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[EntityId] -&gt; Set EntityId
forall a. Ord a =&gt; [a] -&gt; Set a
</span><span class="hs-identifier hs-var">S.fromList</span></span><span> </span><span class="annot"><span class="annottext">([EntityId] -&gt; Set EntityId)
-&gt; (Vector Principal -&gt; [EntityId])
-&gt; Vector Principal
-&gt; Set EntityId
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Principal -&gt; EntityId) -&gt; [Principal] -&gt; [EntityId]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Principal -&gt; EntityId
</span><a href="IC.Management.html#principalToEntityId"><span class="hs-identifier hs-var">principalToEntityId</span></a></span><span> </span><span class="annot"><span class="annottext">([Principal] -&gt; [EntityId])
-&gt; (Vector Principal -&gt; [Principal])
-&gt; Vector Principal
-&gt; [EntityId]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Vector Principal -&gt; [Principal]
forall a. Vector a -&gt; [a]
</span><span class="hs-identifier hs-var">Vec.toList</span></span><span>
</span><span id="line-855"></span><span>    </span><span class="annot"><span class="annottext">Maybe Natural -&gt; (Natural -&gt; m ()) -&gt; m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Settings
Rec
  ('R
     '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
        &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
        &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
        &quot;memory_allocation&quot; ':-&gt; Maybe Natural])
</span><a href="#local-6989586621679322427"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Rec
  ('R
     '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
        &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
        &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
        &quot;memory_allocation&quot; ':-&gt; Maybe Natural])
-&gt; Label &quot;compute_allocation&quot;
-&gt; 'R
     '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
        &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
        &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
        &quot;memory_allocation&quot; ':-&gt; Maybe Natural]
   .! &quot;compute_allocation&quot;
forall (l :: Symbol) (r :: Row *).
KnownSymbol l =&gt;
Rec r -&gt; Label l -&gt; r .! l
</span><span class="hs-operator hs-var">.!</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;compute_allocation&quot; (Label &quot;compute_allocation&quot;)
Label &quot;compute_allocation&quot;
</span><a href="#local-6989586621679322423"><span class="hs-var">#compute_allocation</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((Natural -&gt; m ()) -&gt; m ()) -&gt; (Natural -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; Natural -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; Natural -&gt; m ()
</span><a href="IC.Ref.html#setComputeAllocation"><span class="hs-identifier hs-var">setComputeAllocation</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322428"><span class="hs-identifier hs-var">cid</span></a></span><span>
</span><span id="line-856"></span><span>    </span><span class="annot"><span class="annottext">Maybe Natural -&gt; (Natural -&gt; m ()) -&gt; m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Settings
Rec
  ('R
     '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
        &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
        &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
        &quot;memory_allocation&quot; ':-&gt; Maybe Natural])
</span><a href="#local-6989586621679322427"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Rec
  ('R
     '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
        &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
        &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
        &quot;memory_allocation&quot; ':-&gt; Maybe Natural])
-&gt; Label &quot;memory_allocation&quot;
-&gt; 'R
     '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
        &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
        &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
        &quot;memory_allocation&quot; ':-&gt; Maybe Natural]
   .! &quot;memory_allocation&quot;
forall (l :: Symbol) (r :: Row *).
KnownSymbol l =&gt;
Rec r -&gt; Label l -&gt; r .! l
</span><span class="hs-operator hs-var">.!</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;memory_allocation&quot; (Label &quot;memory_allocation&quot;)
Label &quot;memory_allocation&quot;
</span><a href="#local-6989586621679322422"><span class="hs-var">#memory_allocation</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((Natural -&gt; m ()) -&gt; m ()) -&gt; (Natural -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; Natural -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; Natural -&gt; m ()
</span><a href="IC.Ref.html#setMemoryAllocation"><span class="hs-identifier hs-var">setMemoryAllocation</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322428"><span class="hs-identifier hs-var">cid</span></a></span><span>
</span><span id="line-857"></span><span>    </span><span class="annot"><span class="annottext">Maybe Natural -&gt; (Natural -&gt; m ()) -&gt; m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Settings
Rec
  ('R
     '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
        &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
        &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
        &quot;memory_allocation&quot; ':-&gt; Maybe Natural])
</span><a href="#local-6989586621679322427"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Rec
  ('R
     '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
        &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
        &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
        &quot;memory_allocation&quot; ':-&gt; Maybe Natural])
-&gt; Label &quot;freezing_threshold&quot;
-&gt; 'R
     '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
        &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
        &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
        &quot;memory_allocation&quot; ':-&gt; Maybe Natural]
   .! &quot;freezing_threshold&quot;
forall (l :: Symbol) (r :: Row *).
KnownSymbol l =&gt;
Rec r -&gt; Label l -&gt; r .! l
</span><span class="hs-operator hs-var">.!</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;freezing_threshold&quot; (Label &quot;freezing_threshold&quot;)
Label &quot;freezing_threshold&quot;
</span><a href="#local-6989586621679322421"><span class="hs-var">#freezing_threshold</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((Natural -&gt; m ()) -&gt; m ()) -&gt; (Natural -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; Natural -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; Natural -&gt; m ()
</span><a href="IC.Ref.html#setFreezingThreshold"><span class="hs-identifier hs-var">setFreezingThreshold</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322428"><span class="hs-identifier hs-var">cid</span></a></span><span>
</span><span id="line-858"></span><span>
</span><span id="line-859"></span><span id="local-6989586621679323270"><span id="local-6989586621679323271"><span id="local-6989586621679323272"><span class="annot"><a href="IC.Ref.html#onlyController"><span class="hs-identifier hs-type">onlyController</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-860"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323272"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#CanReject"><span class="hs-identifier hs-type">CanReject</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323272"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679323271"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">.!</span></span><span> </span><span class="annot"><span class="hs-string">&quot;canister_id&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-glyph hs-type">~</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Principal</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-861"></span><span>  </span><span class="annot"><a href="IC.Types.html#EntityId"><span class="hs-identifier hs-type">EntityId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">R.Rec</span></span><span> </span><span class="annot"><a href="#local-6989586621679323271"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323272"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323270"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">R.Rec</span></span><span> </span><span class="annot"><a href="#local-6989586621679323271"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323272"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323270"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-862"></span><span id="onlyController"><span class="annot"><span class="annottext">onlyController :: EntityId -&gt; (Rec r -&gt; m a) -&gt; Rec r -&gt; m a
</span><a href="IC.Ref.html#onlyController"><span class="hs-identifier hs-var hs-var">onlyController</span></a></span></span><span> </span><span id="local-6989586621679322420"><span class="annot"><span class="annottext">caller :: EntityId
</span><a href="#local-6989586621679322420"><span class="hs-identifier hs-var">caller</span></a></span></span><span> </span><span id="local-6989586621679322419"><span class="annot"><span class="annottext">act :: Rec r -&gt; m a
</span><a href="#local-6989586621679322419"><span class="hs-identifier hs-var">act</span></a></span></span><span> </span><span id="local-6989586621679322418"><span class="annot"><span class="annottext">r :: Rec r
</span><a href="#local-6989586621679322418"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-863"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679322417"><span class="annot"><span class="annottext">canister_id :: EntityId
</span><a href="#local-6989586621679322417"><span class="hs-identifier hs-var hs-var">canister_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Principal -&gt; EntityId
</span><a href="IC.Management.html#principalToEntityId"><span class="hs-identifier hs-var">principalToEntityId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Rec r
</span><a href="#local-6989586621679322418"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Rec r -&gt; Label &quot;canister_id&quot; -&gt; r .! &quot;canister_id&quot;
forall (l :: Symbol) (r :: Row *).
KnownSymbol l =&gt;
Rec r -&gt; Label l -&gt; r .! l
</span><span class="hs-operator hs-var">.!</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;canister_id&quot; (Label &quot;canister_id&quot;)
Label &quot;canister_id&quot;
</span><a href="#local-6989586621679322416"><span class="hs-var">#canister_id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-864"></span><span>    </span><span class="annot"><span class="annottext">EntityId -&gt; m ()
forall (m :: * -&gt; *). (CanReject m, ICM m) =&gt; EntityId -&gt; m ()
</span><a href="IC.Ref.html#canisterMustExist"><span class="hs-identifier hs-var">canisterMustExist</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322417"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-865"></span><span>    </span><span id="local-6989586621679322415"><span class="annot"><span class="annottext">Set EntityId
</span><a href="#local-6989586621679322415"><span class="hs-identifier hs-var">controllers</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; m (Set EntityId)
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; m (Set EntityId)
</span><a href="IC.Ref.html#getControllers"><span class="hs-identifier hs-var">getControllers</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322417"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-866"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322420"><span class="hs-identifier hs-var">caller</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; Set EntityId -&gt; Bool
forall a. Ord a =&gt; a -&gt; Set a -&gt; Bool
</span><span class="hs-operator hs-var">`S.member`</span></span><span> </span><span class="annot"><span class="annottext">Set EntityId
</span><a href="#local-6989586621679322415"><span class="hs-identifier hs-var">controllers</span></a></span><span>
</span><span id="line-867"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Rec r -&gt; m a
</span><a href="#local-6989586621679322419"><span class="hs-identifier hs-var">act</span></a></span><span> </span><span class="annot"><span class="annottext">Rec r
</span><a href="#local-6989586621679322418"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-868"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">RejectCode -&gt; String -&gt; m a
forall (m :: * -&gt; *) a2.
CanReject m =&gt;
RejectCode -&gt; String -&gt; m a2
</span><a href="IC.Ref.html#reject"><span class="hs-identifier hs-var">reject</span></a></span><span> </span><span class="annot"><span class="annottext">RejectCode
</span><a href="IC.Types.html#RC_SYS_FATAL"><span class="hs-identifier hs-var">RC_SYS_FATAL</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; m a) -&gt; String -&gt; m a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-869"></span><span>        </span><span class="annot"><span class="annottext">EntityId -&gt; String
</span><a href="IC.Types.html#prettyID"><span class="hs-identifier hs-var">prettyID</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322420"><span class="hs-identifier hs-var">caller</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="hs-string">&quot; is not authorized to manage canister &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span>
</span><span id="line-870"></span><span>        </span><span class="annot"><span class="annottext">EntityId -&gt; String
</span><a href="IC.Types.html#prettyID"><span class="hs-identifier hs-var">prettyID</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322417"><span class="hs-identifier hs-var">canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="hs-string">&quot;, Controllers are: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; [String] -&gt; String
forall a. [a] -&gt; [[a]] -&gt; [a]
</span><span class="hs-identifier hs-var">intercalate</span></span><span> </span><span class="annot"><span class="hs-string">&quot;, &quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(EntityId -&gt; String) -&gt; [EntityId] -&gt; [String]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; String
</span><a href="IC.Types.html#prettyID"><span class="hs-identifier hs-var">prettyID</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set EntityId -&gt; [EntityId]
forall a. Set a -&gt; [a]
</span><span class="hs-identifier hs-var">S.toList</span></span><span> </span><span class="annot"><span class="annottext">Set EntityId
</span><a href="#local-6989586621679322415"><span class="hs-identifier hs-var">controllers</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-871"></span><span>
</span><span id="line-872"></span><span id="local-6989586621679323269"><span class="annot"><a href="IC.Ref.html#icInstallCode"><span class="hs-identifier hs-type">icInstallCode</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323269"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#CanReject"><span class="hs-identifier hs-type">CanReject</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323269"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#EntityId"><span class="hs-identifier hs-type">EntityId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Management.html#ICManagement"><span class="hs-identifier hs-type">ICManagement</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323269"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">.!</span></span><span> </span><span class="annot"><span class="hs-string">&quot;install_code&quot;</span></span></span><span>
</span><span id="line-873"></span><span id="icInstallCode"><span class="annot"><span class="annottext">icInstallCode :: EntityId -&gt; ICManagement m .! &quot;install_code&quot;
</span><a href="IC.Ref.html#icInstallCode"><span class="hs-identifier hs-var hs-var">icInstallCode</span></a></span></span><span> </span><span id="local-6989586621679322413"><span class="annot"><span class="annottext">caller :: EntityId
</span><a href="#local-6989586621679322413"><span class="hs-identifier hs-var">caller</span></a></span></span><span> </span><span id="local-6989586621679322412"><span class="annot"><span class="annottext">r :: Rec
  ('R
     '[ &quot;arg&quot; ':-&gt; Blob, &quot;canister_id&quot; ':-&gt; Principal,
        &quot;mode&quot;
        ':-&gt; Var
               ('R '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()]),
        &quot;wasm_module&quot; ':-&gt; Blob])
</span><a href="#local-6989586621679322412"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-874"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679322411"><span class="annot"><span class="annottext">canister_id :: EntityId
</span><a href="#local-6989586621679322411"><span class="hs-identifier hs-var hs-var">canister_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Principal -&gt; EntityId
</span><a href="IC.Management.html#principalToEntityId"><span class="hs-identifier hs-var">principalToEntityId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Rec
  ('R
     '[ &quot;arg&quot; ':-&gt; Blob, &quot;canister_id&quot; ':-&gt; Principal,
        &quot;mode&quot;
        ':-&gt; Var
               ('R '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()]),
        &quot;wasm_module&quot; ':-&gt; Blob])
</span><a href="#local-6989586621679322412"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Rec
  ('R
     '[ &quot;arg&quot; ':-&gt; Blob, &quot;canister_id&quot; ':-&gt; Principal,
        &quot;mode&quot;
        ':-&gt; Var
               ('R '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()]),
        &quot;wasm_module&quot; ':-&gt; Blob])
-&gt; Label &quot;canister_id&quot;
-&gt; 'R
     '[ &quot;arg&quot; ':-&gt; Blob, &quot;canister_id&quot; ':-&gt; Principal,
        &quot;mode&quot;
        ':-&gt; Var
               ('R '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()]),
        &quot;wasm_module&quot; ':-&gt; Blob]
   .! &quot;canister_id&quot;
forall (l :: Symbol) (r :: Row *).
KnownSymbol l =&gt;
Rec r -&gt; Label l -&gt; r .! l
</span><span class="hs-operator hs-var">.!</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;canister_id&quot; (Label &quot;canister_id&quot;)
Label &quot;canister_id&quot;
</span><a href="#local-6989586621679322410"><span class="hs-var">#canister_id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-875"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679322409"><span class="annot"><span class="annottext">arg :: 'R
  '[ &quot;arg&quot; ':-&gt; Blob, &quot;canister_id&quot; ':-&gt; Principal,
     &quot;mode&quot;
     ':-&gt; Var
            ('R '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()]),
     &quot;wasm_module&quot; ':-&gt; Blob]
.! &quot;arg&quot;
</span><a href="#local-6989586621679322409"><span class="hs-identifier hs-var hs-var">arg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Rec
  ('R
     '[ &quot;arg&quot; ':-&gt; Blob, &quot;canister_id&quot; ':-&gt; Principal,
        &quot;mode&quot;
        ':-&gt; Var
               ('R '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()]),
        &quot;wasm_module&quot; ':-&gt; Blob])
</span><a href="#local-6989586621679322412"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Rec
  ('R
     '[ &quot;arg&quot; ':-&gt; Blob, &quot;canister_id&quot; ':-&gt; Principal,
        &quot;mode&quot;
        ':-&gt; Var
               ('R '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()]),
        &quot;wasm_module&quot; ':-&gt; Blob])
-&gt; Label &quot;arg&quot;
-&gt; 'R
     '[ &quot;arg&quot; ':-&gt; Blob, &quot;canister_id&quot; ':-&gt; Principal,
        &quot;mode&quot;
        ':-&gt; Var
               ('R '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()]),
        &quot;wasm_module&quot; ':-&gt; Blob]
   .! &quot;arg&quot;
forall (l :: Symbol) (r :: Row *).
KnownSymbol l =&gt;
Rec r -&gt; Label l -&gt; r .! l
</span><span class="hs-operator hs-var">.!</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;arg&quot; (Label &quot;arg&quot;)
Label &quot;arg&quot;
</span><a href="#local-6989586621679322408"><span class="hs-var">#arg</span></a></span><span>
</span><span id="line-876"></span><span>    </span><span id="local-6989586621679322407"><span class="annot"><span class="annottext">CanisterModule
</span><a href="#local-6989586621679322407"><span class="hs-identifier hs-var">new_can_mod</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Either String CanisterModule -&gt; m (Either String CanisterModule)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Blob -&gt; Either String CanisterModule
</span><a href="IC.Canister.html#parseCanister"><span class="hs-identifier hs-var">parseCanister</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Rec
  ('R
     '[ &quot;arg&quot; ':-&gt; Blob, &quot;canister_id&quot; ':-&gt; Principal,
        &quot;mode&quot;
        ':-&gt; Var
               ('R '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()]),
        &quot;wasm_module&quot; ':-&gt; Blob])
</span><a href="#local-6989586621679322412"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Rec
  ('R
     '[ &quot;arg&quot; ':-&gt; Blob, &quot;canister_id&quot; ':-&gt; Principal,
        &quot;mode&quot;
        ':-&gt; Var
               ('R '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()]),
        &quot;wasm_module&quot; ':-&gt; Blob])
-&gt; Label &quot;wasm_module&quot;
-&gt; 'R
     '[ &quot;arg&quot; ':-&gt; Blob, &quot;canister_id&quot; ':-&gt; Principal,
        &quot;mode&quot;
        ':-&gt; Var
               ('R '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()]),
        &quot;wasm_module&quot; ':-&gt; Blob]
   .! &quot;wasm_module&quot;
forall (l :: Symbol) (r :: Row *).
KnownSymbol l =&gt;
Rec r -&gt; Label l -&gt; r .! l
</span><span class="hs-operator hs-var">.!</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;wasm_module&quot; (Label &quot;wasm_module&quot;)
Label &quot;wasm_module&quot;
</span><a href="#local-6989586621679322405"><span class="hs-var">#wasm_module</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-877"></span><span>      </span><span class="annot"><span class="annottext">m (Either String CanisterModule)
-&gt; (String -&gt; m CanisterModule) -&gt; m CanisterModule
forall (m :: * -&gt; *) a b.
Monad m =&gt;
m (Either a b) -&gt; (a -&gt; m b) -&gt; m b
</span><a href="IC.Ref.html#onErr"><span class="hs-operator hs-var">`onErr`</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679322403"><span class="annot"><span class="annottext">err :: String
</span><a href="#local-6989586621679322403"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RejectCode -&gt; String -&gt; m CanisterModule
forall (m :: * -&gt; *) a2.
CanReject m =&gt;
RejectCode -&gt; String -&gt; m a2
</span><a href="IC.Ref.html#reject"><span class="hs-identifier hs-var">reject</span></a></span><span> </span><span class="annot"><span class="annottext">RejectCode
</span><a href="IC.Types.html#RC_SYS_FATAL"><span class="hs-identifier hs-var">RC_SYS_FATAL</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; m CanisterModule) -&gt; String -&gt; m CanisterModule
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Parsing failed: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679322403"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-878"></span><span>    </span><span id="local-6989586621679322402"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679322402"><span class="hs-identifier hs-var">was_empty</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; m Bool
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; m Bool
</span><a href="IC.Ref.html#isCanisterEmpty"><span class="hs-identifier hs-var">isCanisterEmpty</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322411"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-879"></span><span>    </span><span id="local-6989586621679322401"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679322401"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; m Env
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; m Env
</span><a href="IC.Ref.html#canisterEnv"><span class="hs-identifier hs-var">canisterEnv</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322411"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-880"></span><span>
</span><span id="line-881"></span><span>    </span><span class="hs-keyword">let</span><span>
</span><span id="line-882"></span><span>      </span><span id="local-6989586621679322400"><span class="annot"><span class="annottext">reinstall :: m ()
</span><a href="#local-6989586621679322400"><span class="hs-identifier hs-var hs-var">reinstall</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-883"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621679322399"><span class="annot"><span class="annottext">wasm_state :: WasmState
</span><a href="#local-6989586621679322399"><span class="hs-identifier hs-var">wasm_state</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679322398"><span class="annot"><span class="annottext">ca :: CanisterActions
</span><a href="#local-6989586621679322398"><span class="hs-identifier hs-var">ca</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TrapOr (WasmState, CanisterActions)
-&gt; m (TrapOr (WasmState, CanisterActions))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CanisterModule -&gt; InitFunc
</span><a href="IC.Canister.html#init_method"><span class="hs-identifier hs-var hs-var">init_method</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterModule
</span><a href="#local-6989586621679322407"><span class="hs-identifier hs-var">new_can_mod</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322413"><span class="hs-identifier hs-var">caller</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679322401"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
'R
  '[ &quot;arg&quot; ':-&gt; Blob, &quot;canister_id&quot; ':-&gt; Principal,
     &quot;mode&quot;
     ':-&gt; Var
            ('R '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()]),
     &quot;wasm_module&quot; ':-&gt; Blob]
.! &quot;arg&quot;
</span><a href="#local-6989586621679322409"><span class="hs-identifier hs-var">arg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-884"></span><span>          </span><span class="annot"><span class="annottext">m (TrapOr (WasmState, CanisterActions))
-&gt; (String -&gt; m (WasmState, CanisterActions))
-&gt; m (WasmState, CanisterActions)
forall (m :: * -&gt; *) a.
Monad m =&gt;
m (TrapOr a) -&gt; (String -&gt; m a) -&gt; m a
</span><a href="IC.Ref.html#onTrap"><span class="hs-operator hs-var">`onTrap`</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679322395"><span class="annot"><span class="annottext">msg :: String
</span><a href="#local-6989586621679322395"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RejectCode -&gt; String -&gt; m (WasmState, CanisterActions)
forall (m :: * -&gt; *) a2.
CanReject m =&gt;
RejectCode -&gt; String -&gt; m a2
</span><a href="IC.Ref.html#reject"><span class="hs-identifier hs-var">reject</span></a></span><span> </span><span class="annot"><span class="annottext">RejectCode
</span><a href="IC.Types.html#RC_CANISTER_ERROR"><span class="hs-identifier hs-var">RC_CANISTER_ERROR</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; m (WasmState, CanisterActions))
-&gt; String -&gt; m (WasmState, CanisterActions)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Initialization trapped: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679322395"><span class="hs-identifier hs-var">msg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-885"></span><span>        </span><span class="annot"><span class="annottext">EntityId -&gt; CanisterContent -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; CanisterContent -&gt; m ()
</span><a href="IC.Ref.html#setCanisterContent"><span class="hs-identifier hs-var">setCanisterContent</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322411"><span class="hs-identifier hs-var">canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">(CanisterContent -&gt; m ()) -&gt; CanisterContent -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CanisterContent :: CanisterModule -&gt; WasmState -&gt; CanisterContent
</span><a href="IC.Ref.html#CanisterContent"><span class="hs-identifier hs-type hs-type">CanisterContent</span></a></span><span>
</span><span id="line-886"></span><span>            </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">can_mod :: CanisterModule
</span><a href="IC.Ref.html#can_mod"><span class="hs-identifier hs-var">can_mod</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CanisterModule
</span><a href="#local-6989586621679322407"><span class="hs-identifier hs-var">new_can_mod</span></a></span><span>
</span><span id="line-887"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">wasm_state :: WasmState
</span><a href="IC.Ref.html#wasm_state"><span class="hs-identifier hs-var">wasm_state</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679322399"><span class="hs-identifier hs-var">wasm_state</span></a></span><span>
</span><span id="line-888"></span><span>            </span><span class="hs-special">}</span><span>
</span><span id="line-889"></span><span>        </span><span class="annot"><span class="annottext">EntityId -&gt; CanisterActions -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; CanisterActions -&gt; m ()
</span><a href="IC.Ref.html#performCanisterActions"><span class="hs-identifier hs-var">performCanisterActions</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322411"><span class="hs-identifier hs-var">canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterActions
</span><a href="#local-6989586621679322398"><span class="hs-identifier hs-var">ca</span></a></span><span>
</span><span id="line-890"></span><span>
</span><span id="line-891"></span><span>      </span><span id="local-6989586621679322393"><span class="annot"><span class="annottext">install :: m ()
</span><a href="#local-6989586621679322393"><span class="hs-identifier hs-var hs-var">install</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-892"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679322402"><span class="hs-identifier hs-var">was_empty</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-893"></span><span>          </span><span class="annot"><span class="annottext">RejectCode -&gt; String -&gt; m ()
forall (m :: * -&gt; *) a2.
CanReject m =&gt;
RejectCode -&gt; String -&gt; m a2
</span><a href="IC.Ref.html#reject"><span class="hs-identifier hs-var">reject</span></a></span><span> </span><span class="annot"><span class="annottext">RejectCode
</span><a href="IC.Types.html#RC_DESTINATION_INVALID"><span class="hs-identifier hs-var">RC_DESTINATION_INVALID</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;canister is not empty during installation&quot;</span></span><span>
</span><span id="line-894"></span><span>        </span><span class="annot"><span class="annottext">m ()
</span><a href="#local-6989586621679322400"><span class="hs-identifier hs-var">reinstall</span></a></span><span>
</span><span id="line-895"></span><span>
</span><span id="line-896"></span><span>      </span><span id="local-6989586621679322392"><span class="annot"><span class="annottext">upgrade :: m ()
</span><a href="#local-6989586621679322392"><span class="hs-identifier hs-var hs-var">upgrade</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-897"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679322402"><span class="hs-identifier hs-var">was_empty</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-898"></span><span>          </span><span class="annot"><span class="annottext">RejectCode -&gt; String -&gt; m ()
forall (m :: * -&gt; *) a2.
CanReject m =&gt;
RejectCode -&gt; String -&gt; m a2
</span><a href="IC.Ref.html#reject"><span class="hs-identifier hs-var">reject</span></a></span><span> </span><span class="annot"><span class="annottext">RejectCode
</span><a href="IC.Types.html#RC_DESTINATION_INVALID"><span class="hs-identifier hs-var">RC_DESTINATION_INVALID</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;canister is empty during upgrade&quot;</span></span><span>
</span><span id="line-899"></span><span>        </span><span id="local-6989586621679322391"><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679322391"><span class="hs-identifier hs-var">old_wasm_state</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; m WasmState
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; m WasmState
</span><a href="IC.Ref.html#getCanisterState"><span class="hs-identifier hs-var">getCanisterState</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322411"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-900"></span><span>        </span><span id="local-6989586621679322390"><span class="annot"><span class="annottext">CanisterModule
</span><a href="#local-6989586621679322390"><span class="hs-identifier hs-var">old_can_mod</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; m CanisterModule
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; m CanisterModule
</span><a href="IC.Ref.html#getCanisterMod"><span class="hs-identifier hs-var">getCanisterMod</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322411"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-901"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621679322389"><span class="annot"><span class="annottext">ca1 :: CanisterActions
</span><a href="#local-6989586621679322389"><span class="hs-identifier hs-var">ca1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679322388"><span class="annot"><span class="annottext">mem :: Blob
</span><a href="#local-6989586621679322388"><span class="hs-identifier hs-var">mem</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TrapOr (CanisterActions, Blob)
-&gt; m (TrapOr (CanisterActions, Blob))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CanisterModule
-&gt; WasmState -&gt; EntityId -&gt; Env -&gt; TrapOr (CanisterActions, Blob)
</span><a href="IC.Canister.html#pre_upgrade_method"><span class="hs-identifier hs-var hs-var">pre_upgrade_method</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterModule
</span><a href="#local-6989586621679322390"><span class="hs-identifier hs-var">old_can_mod</span></a></span><span> </span><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679322391"><span class="hs-identifier hs-var">old_wasm_state</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322413"><span class="hs-identifier hs-var">caller</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679322401"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-902"></span><span>          </span><span class="annot"><span class="annottext">m (TrapOr (CanisterActions, Blob))
-&gt; (String -&gt; m (CanisterActions, Blob))
-&gt; m (CanisterActions, Blob)
forall (m :: * -&gt; *) a.
Monad m =&gt;
m (TrapOr a) -&gt; (String -&gt; m a) -&gt; m a
</span><a href="IC.Ref.html#onTrap"><span class="hs-operator hs-var">`onTrap`</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679322386"><span class="annot"><span class="annottext">msg :: String
</span><a href="#local-6989586621679322386"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RejectCode -&gt; String -&gt; m (CanisterActions, Blob)
forall (m :: * -&gt; *) a2.
CanReject m =&gt;
RejectCode -&gt; String -&gt; m a2
</span><a href="IC.Ref.html#reject"><span class="hs-identifier hs-var">reject</span></a></span><span> </span><span class="annot"><span class="annottext">RejectCode
</span><a href="IC.Types.html#RC_CANISTER_ERROR"><span class="hs-identifier hs-var">RC_CANISTER_ERROR</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; m (CanisterActions, Blob))
-&gt; String -&gt; m (CanisterActions, Blob)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Pre-upgrade trapped: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679322386"><span class="hs-identifier hs-var">msg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-903"></span><span>        </span><span class="hs-comment">-- TODO: update balance in env based on ca1 here, once canister actions</span><span>
</span><span id="line-904"></span><span>        </span><span class="hs-comment">-- can change balances</span><span>
</span><span id="line-905"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679322385"><span class="annot"><span class="annottext">env2 :: Env
</span><a href="#local-6989586621679322385"><span class="hs-identifier hs-var hs-var">env2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679322401"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-906"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621679322384"><span class="annot"><span class="annottext">new_wasm_state :: WasmState
</span><a href="#local-6989586621679322384"><span class="hs-identifier hs-var">new_wasm_state</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679322383"><span class="annot"><span class="annottext">ca2 :: CanisterActions
</span><a href="#local-6989586621679322383"><span class="hs-identifier hs-var">ca2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TrapOr (WasmState, CanisterActions)
-&gt; m (TrapOr (WasmState, CanisterActions))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CanisterModule
-&gt; EntityId
-&gt; Env
-&gt; Blob
-&gt; Blob
-&gt; TrapOr (WasmState, CanisterActions)
</span><a href="IC.Canister.html#post_upgrade_method"><span class="hs-identifier hs-var hs-var">post_upgrade_method</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterModule
</span><a href="#local-6989586621679322407"><span class="hs-identifier hs-var">new_can_mod</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322413"><span class="hs-identifier hs-var">caller</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679322385"><span class="hs-identifier hs-var">env2</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679322388"><span class="hs-identifier hs-var">mem</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
'R
  '[ &quot;arg&quot; ':-&gt; Blob, &quot;canister_id&quot; ':-&gt; Principal,
     &quot;mode&quot;
     ':-&gt; Var
            ('R '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()]),
     &quot;wasm_module&quot; ':-&gt; Blob]
.! &quot;arg&quot;
</span><a href="#local-6989586621679322409"><span class="hs-identifier hs-var">arg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-907"></span><span>          </span><span class="annot"><span class="annottext">m (TrapOr (WasmState, CanisterActions))
-&gt; (String -&gt; m (WasmState, CanisterActions))
-&gt; m (WasmState, CanisterActions)
forall (m :: * -&gt; *) a.
Monad m =&gt;
m (TrapOr a) -&gt; (String -&gt; m a) -&gt; m a
</span><a href="IC.Ref.html#onTrap"><span class="hs-operator hs-var">`onTrap`</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679322381"><span class="annot"><span class="annottext">msg :: String
</span><a href="#local-6989586621679322381"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RejectCode -&gt; String -&gt; m (WasmState, CanisterActions)
forall (m :: * -&gt; *) a2.
CanReject m =&gt;
RejectCode -&gt; String -&gt; m a2
</span><a href="IC.Ref.html#reject"><span class="hs-identifier hs-var">reject</span></a></span><span> </span><span class="annot"><span class="annottext">RejectCode
</span><a href="IC.Types.html#RC_CANISTER_ERROR"><span class="hs-identifier hs-var">RC_CANISTER_ERROR</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; m (WasmState, CanisterActions))
-&gt; String -&gt; m (WasmState, CanisterActions)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Post-upgrade trapped: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679322381"><span class="hs-identifier hs-var">msg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-908"></span><span>
</span><span id="line-909"></span><span>        </span><span class="annot"><span class="annottext">EntityId -&gt; CanisterContent -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; CanisterContent -&gt; m ()
</span><a href="IC.Ref.html#setCanisterContent"><span class="hs-identifier hs-var">setCanisterContent</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322411"><span class="hs-identifier hs-var">canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">(CanisterContent -&gt; m ()) -&gt; CanisterContent -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CanisterContent :: CanisterModule -&gt; WasmState -&gt; CanisterContent
</span><a href="IC.Ref.html#CanisterContent"><span class="hs-identifier hs-type hs-type">CanisterContent</span></a></span><span>
</span><span id="line-910"></span><span>            </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">can_mod :: CanisterModule
</span><a href="IC.Ref.html#can_mod"><span class="hs-identifier hs-var">can_mod</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CanisterModule
</span><a href="#local-6989586621679322407"><span class="hs-identifier hs-var">new_can_mod</span></a></span><span>
</span><span id="line-911"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">wasm_state :: WasmState
</span><a href="IC.Ref.html#wasm_state"><span class="hs-identifier hs-var">wasm_state</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679322384"><span class="hs-identifier hs-var">new_wasm_state</span></a></span><span>
</span><span id="line-912"></span><span>            </span><span class="hs-special">}</span><span>
</span><span id="line-913"></span><span>        </span><span class="annot"><span class="annottext">EntityId -&gt; CanisterActions -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; CanisterActions -&gt; m ()
</span><a href="IC.Ref.html#performCanisterActions"><span class="hs-identifier hs-var">performCanisterActions</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322411"><span class="hs-identifier hs-var">canister_id</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CanisterActions
</span><a href="#local-6989586621679322389"><span class="hs-identifier hs-var">ca1</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterActions -&gt; CanisterActions -&gt; CanisterActions
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">CanisterActions
</span><a href="#local-6989586621679322383"><span class="hs-identifier hs-var">ca2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-914"></span><span>
</span><span id="line-915"></span><span>    </span><span class="annot"><span class="annottext">Var
  ('R '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()])
-&gt; Rec
     ('R
        '[ &quot;install&quot; ':-&gt; (() -&gt; m ()), &quot;reinstall&quot; ':-&gt; (() -&gt; m ()),
           &quot;upgrade&quot; ':-&gt; (() -&gt; m ())])
-&gt; m ()
forall (v :: Row *) (r :: Row *) x.
BiForall r v (AppliesTo x) =&gt;
Var v -&gt; Rec r -&gt; x
</span><span class="hs-identifier hs-var">R.switch</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Rec
  ('R
     '[ &quot;arg&quot; ':-&gt; Blob, &quot;canister_id&quot; ':-&gt; Principal,
        &quot;mode&quot;
        ':-&gt; Var
               ('R '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()]),
        &quot;wasm_module&quot; ':-&gt; Blob])
</span><a href="#local-6989586621679322412"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Rec
  ('R
     '[ &quot;arg&quot; ':-&gt; Blob, &quot;canister_id&quot; ':-&gt; Principal,
        &quot;mode&quot;
        ':-&gt; Var
               ('R '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()]),
        &quot;wasm_module&quot; ':-&gt; Blob])
-&gt; Label &quot;mode&quot;
-&gt; 'R
     '[ &quot;arg&quot; ':-&gt; Blob, &quot;canister_id&quot; ':-&gt; Principal,
        &quot;mode&quot;
        ':-&gt; Var
               ('R '[ &quot;install&quot; ':-&gt; (), &quot;reinstall&quot; ':-&gt; (), &quot;upgrade&quot; ':-&gt; ()]),
        &quot;wasm_module&quot; ':-&gt; Blob]
   .! &quot;mode&quot;
forall (l :: Symbol) (r :: Row *).
KnownSymbol l =&gt;
Rec r -&gt; Label l -&gt; r .! l
</span><span class="hs-operator hs-var">.!</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;mode&quot; (Label &quot;mode&quot;)
Label &quot;mode&quot;
</span><a href="#local-6989586621679322379"><span class="hs-var">#mode</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Rec
   ('R
      '[ &quot;install&quot; ':-&gt; (() -&gt; m ()), &quot;reinstall&quot; ':-&gt; (() -&gt; m ()),
         &quot;upgrade&quot; ':-&gt; (() -&gt; m ())])
 -&gt; m ())
-&gt; Rec
     ('R
        '[ &quot;install&quot; ':-&gt; (() -&gt; m ()), &quot;reinstall&quot; ':-&gt; (() -&gt; m ()),
           &quot;upgrade&quot; ':-&gt; (() -&gt; m ())])
-&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Rec Empty
</span><span class="hs-identifier hs-var">R.empty</span></span><span>
</span><span id="line-916"></span><span>      </span><span class="annot"><span class="annottext">Rec Empty
-&gt; Rec ('R '[ &quot;install&quot; ':-&gt; (() -&gt; m ())])
-&gt; Rec (Empty .+ 'R '[ &quot;install&quot; ':-&gt; (() -&gt; m ())])
forall (l :: Row *) (r :: Row *).
FreeForall l =&gt;
Rec l -&gt; Rec r -&gt; Rec (l .+ r)
</span><span class="hs-operator hs-var">.+</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;install&quot; (Label &quot;install&quot;)
Label &quot;install&quot;
</span><a href="#local-6989586621679322377"><span class="hs-var">#install</span></a></span><span> </span><span class="annot"><span class="annottext">Label &quot;install&quot; -&gt; (() -&gt; m ()) -&gt; Rec (&quot;install&quot; .== (() -&gt; m ()))
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec (l .== a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">m ()
</span><a href="#local-6989586621679322393"><span class="hs-identifier hs-var">install</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-917"></span><span>      </span><span class="annot"><span class="annottext">Rec ('R '[ &quot;install&quot; ':-&gt; (() -&gt; m ())])
-&gt; Rec ('R '[ &quot;reinstall&quot; ':-&gt; (() -&gt; m ())])
-&gt; Rec
     ('R '[ &quot;install&quot; ':-&gt; (() -&gt; m ())]
      .+ 'R '[ &quot;reinstall&quot; ':-&gt; (() -&gt; m ())])
forall (l :: Row *) (r :: Row *).
FreeForall l =&gt;
Rec l -&gt; Rec r -&gt; Rec (l .+ r)
</span><span class="hs-operator hs-var">.+</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;reinstall&quot; (Label &quot;reinstall&quot;)
Label &quot;reinstall&quot;
</span><a href="#local-6989586621679322376"><span class="hs-var">#reinstall</span></a></span><span> </span><span class="annot"><span class="annottext">Label &quot;reinstall&quot;
-&gt; (() -&gt; m ()) -&gt; Rec (&quot;reinstall&quot; .== (() -&gt; m ()))
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec (l .== a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">m ()
</span><a href="#local-6989586621679322400"><span class="hs-identifier hs-var">reinstall</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-918"></span><span>      </span><span class="annot"><span class="annottext">Rec
  ('R '[ &quot;install&quot; ':-&gt; (() -&gt; m ()), &quot;reinstall&quot; ':-&gt; (() -&gt; m ())])
-&gt; Rec ('R '[ &quot;upgrade&quot; ':-&gt; (() -&gt; m ())])
-&gt; Rec
     ('R '[ &quot;install&quot; ':-&gt; (() -&gt; m ()), &quot;reinstall&quot; ':-&gt; (() -&gt; m ())]
      .+ 'R '[ &quot;upgrade&quot; ':-&gt; (() -&gt; m ())])
forall (l :: Row *) (r :: Row *).
FreeForall l =&gt;
Rec l -&gt; Rec r -&gt; Rec (l .+ r)
</span><span class="hs-operator hs-var">.+</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;upgrade&quot; (Label &quot;upgrade&quot;)
Label &quot;upgrade&quot;
</span><a href="#local-6989586621679322375"><span class="hs-var">#upgrade</span></a></span><span> </span><span class="annot"><span class="annottext">Label &quot;upgrade&quot; -&gt; (() -&gt; m ()) -&gt; Rec (&quot;upgrade&quot; .== (() -&gt; m ()))
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec (l .== a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">m ()
</span><a href="#local-6989586621679322392"><span class="hs-identifier hs-var">upgrade</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-919"></span><span>
</span><span id="line-920"></span><span id="local-6989586621679323268"><span class="annot"><a href="IC.Ref.html#icUninstallCode"><span class="hs-identifier hs-type">icUninstallCode</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323268"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#CanReject"><span class="hs-identifier hs-type">CanReject</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323268"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Management.html#ICManagement"><span class="hs-identifier hs-type">ICManagement</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323268"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">.!</span></span><span> </span><span class="annot"><span class="hs-string">&quot;uninstall_code&quot;</span></span></span><span>
</span><span id="line-921"></span><span id="icUninstallCode"><span class="annot"><span class="annottext">icUninstallCode :: ICManagement m .! &quot;uninstall_code&quot;
</span><a href="IC.Ref.html#icUninstallCode"><span class="hs-identifier hs-var hs-var">icUninstallCode</span></a></span></span><span> </span><span id="local-6989586621679322374"><span class="annot"><span class="annottext">r :: Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
</span><a href="#local-6989586621679322374"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-922"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679322373"><span class="annot"><span class="annottext">canister_id :: EntityId
</span><a href="#local-6989586621679322373"><span class="hs-identifier hs-var hs-var">canister_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Principal -&gt; EntityId
</span><a href="IC.Management.html#principalToEntityId"><span class="hs-identifier hs-var">principalToEntityId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
</span><a href="#local-6989586621679322374"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; Label &quot;canister_id&quot;
-&gt; 'R '[ &quot;canister_id&quot; ':-&gt; Principal] .! &quot;canister_id&quot;
forall (l :: Symbol) (r :: Row *).
KnownSymbol l =&gt;
Rec r -&gt; Label l -&gt; r .! l
</span><span class="hs-operator hs-var">.!</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;canister_id&quot; (Label &quot;canister_id&quot;)
Label &quot;canister_id&quot;
</span><a href="#local-6989586621679322372"><span class="hs-var">#canister_id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-923"></span><span>    </span><span class="hs-comment">-- empty canister, resetting selected state</span><span>
</span><span id="line-924"></span><span>    </span><span class="annot"><span class="annottext">EntityId -&gt; (CanState -&gt; CanState) -&gt; m ()
forall (m :: * -&gt; *).
ICM m =&gt;
EntityId -&gt; (CanState -&gt; CanState) -&gt; m ()
</span><a href="IC.Ref.html#modCanister"><span class="hs-identifier hs-var">modCanister</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322373"><span class="hs-identifier hs-var">canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">((CanState -&gt; CanState) -&gt; m ()) -&gt; (CanState -&gt; CanState) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679322371"><span class="annot"><span class="annottext">can_state :: CanState
</span><a href="#local-6989586621679322371"><span class="hs-identifier hs-var">can_state</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CanState
</span><a href="#local-6989586621679322371"><span class="hs-identifier hs-var">can_state</span></a></span><span>
</span><span id="line-925"></span><span>      </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">content :: Maybe CanisterContent
</span><a href="IC.Ref.html#content"><span class="hs-identifier hs-var">content</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe CanisterContent
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-926"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">certified_data :: Blob
</span><a href="IC.Ref.html#certified_data"><span class="hs-identifier hs-var">certified_data</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-string">&quot;&quot;</span></span><span>
</span><span id="line-927"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-928"></span><span>    </span><span class="hs-comment">-- reject all call open contexts of this canister</span><span>
</span><span id="line-929"></span><span>    </span><span class="annot"><span class="annottext">(IC -&gt; [(Int, CallContext)]) -&gt; m [(Int, CallContext)]
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Int &#8614; CallContext) -&gt; [(Int, CallContext)]
forall k a. Map k a -&gt; [(k, a)]
</span><span class="hs-identifier hs-var">M.toList</span></span><span> </span><span class="annot"><span class="annottext">((Int &#8614; CallContext) -&gt; [(Int, CallContext)])
-&gt; (IC -&gt; Int &#8614; CallContext) -&gt; IC -&gt; [(Int, CallContext)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">IC -&gt; Int &#8614; CallContext
</span><a href="IC.Ref.html#call_contexts"><span class="hs-identifier hs-var hs-var">call_contexts</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">m [(Int, CallContext)] -&gt; ([(Int, CallContext)] -&gt; m ()) -&gt; m ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">((Int, CallContext) -&gt; m ()) -&gt; [(Int, CallContext)] -&gt; m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679322370"><span class="annot"><span class="annottext">ctxt_id :: Int
</span><a href="#local-6989586621679322370"><span class="hs-identifier hs-var">ctxt_id</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679322369"><span class="annot"><span class="annottext">ctxt :: CallContext
</span><a href="#local-6989586621679322369"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-930"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CallContext -&gt; EntityId
</span><a href="IC.Ref.html#canister"><span class="hs-identifier hs-var hs-var">canister</span></a></span><span> </span><span class="annot"><span class="annottext">CallContext
</span><a href="#local-6989586621679322369"><span class="hs-identifier hs-var">ctxt</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; EntityId -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322373"><span class="hs-identifier hs-var">canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">CallContext -&gt; Responded
</span><a href="IC.Ref.html#responded"><span class="hs-identifier hs-var hs-var">responded</span></a></span><span> </span><span class="annot"><span class="annottext">CallContext
</span><a href="#local-6989586621679322369"><span class="hs-identifier hs-var">ctxt</span></a></span><span> </span><span class="annot"><span class="annottext">Responded -&gt; Responded -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Responded
</span><a href="IC.Types.html#Responded"><span class="hs-identifier hs-var">Responded</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-931"></span><span>            </span><span class="annot"><span class="annottext">Int -&gt; (RejectCode, String) -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; Int -&gt; (RejectCode, String) -&gt; m ()
</span><a href="IC.Ref.html#rejectCallContext"><span class="hs-identifier hs-var">rejectCallContext</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322370"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RejectCode
</span><a href="IC.Types.html#RC_CANISTER_REJECT"><span class="hs-identifier hs-var">RC_CANISTER_REJECT</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;Canister has been uninstalled&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-932"></span><span>            </span><span class="annot"><span class="annottext">Int -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; Int -&gt; m ()
</span><a href="IC.Ref.html#deleteCallContext"><span class="hs-identifier hs-var">deleteCallContext</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322370"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span>
</span><span id="line-933"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-934"></span><span>
</span><span id="line-935"></span><span id="local-6989586621679323267"><span class="annot"><a href="IC.Ref.html#icUpdateCanisterSettings"><span class="hs-identifier hs-type">icUpdateCanisterSettings</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323267"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#CanReject"><span class="hs-identifier hs-type">CanReject</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323267"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Management.html#ICManagement"><span class="hs-identifier hs-type">ICManagement</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323267"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">.!</span></span><span> </span><span class="annot"><span class="hs-string">&quot;update_settings&quot;</span></span></span><span>
</span><span id="line-936"></span><span id="icUpdateCanisterSettings"><span class="annot"><span class="annottext">icUpdateCanisterSettings :: ICManagement m .! &quot;update_settings&quot;
</span><a href="IC.Ref.html#icUpdateCanisterSettings"><span class="hs-identifier hs-var hs-var">icUpdateCanisterSettings</span></a></span></span><span> </span><span id="local-6989586621679322366"><span class="annot"><span class="annottext">r :: Rec
  ('R
     '[ &quot;canister_id&quot; ':-&gt; Principal,
        &quot;settings&quot;
        ':-&gt; Rec
               ('R
                  '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                     &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                     &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                     &quot;memory_allocation&quot; ':-&gt; Maybe Natural])])
</span><a href="#local-6989586621679322366"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-937"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679322365"><span class="annot"><span class="annottext">canister_id :: EntityId
</span><a href="#local-6989586621679322365"><span class="hs-identifier hs-var hs-var">canister_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Principal -&gt; EntityId
</span><a href="IC.Management.html#principalToEntityId"><span class="hs-identifier hs-var">principalToEntityId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Rec
  ('R
     '[ &quot;canister_id&quot; ':-&gt; Principal,
        &quot;settings&quot;
        ':-&gt; Rec
               ('R
                  '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                     &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                     &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                     &quot;memory_allocation&quot; ':-&gt; Maybe Natural])])
</span><a href="#local-6989586621679322366"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Rec
  ('R
     '[ &quot;canister_id&quot; ':-&gt; Principal,
        &quot;settings&quot;
        ':-&gt; Rec
               ('R
                  '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                     &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                     &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                     &quot;memory_allocation&quot; ':-&gt; Maybe Natural])])
-&gt; Label &quot;canister_id&quot;
-&gt; 'R
     '[ &quot;canister_id&quot; ':-&gt; Principal,
        &quot;settings&quot;
        ':-&gt; Rec
               ('R
                  '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                     &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                     &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                     &quot;memory_allocation&quot; ':-&gt; Maybe Natural])]
   .! &quot;canister_id&quot;
forall (l :: Symbol) (r :: Row *).
KnownSymbol l =&gt;
Rec r -&gt; Label l -&gt; r .! l
</span><span class="hs-operator hs-var">.!</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;canister_id&quot; (Label &quot;canister_id&quot;)
Label &quot;canister_id&quot;
</span><a href="#local-6989586621679322364"><span class="hs-var">#canister_id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-938"></span><span>    </span><span class="annot"><span class="annottext">Settings -&gt; m ()
forall (m :: * -&gt; *). CanReject m =&gt; Settings -&gt; m ()
</span><a href="IC.Ref.html#validateSettings"><span class="hs-identifier hs-var">validateSettings</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Rec
  ('R
     '[ &quot;canister_id&quot; ':-&gt; Principal,
        &quot;settings&quot;
        ':-&gt; Rec
               ('R
                  '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                     &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                     &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                     &quot;memory_allocation&quot; ':-&gt; Maybe Natural])])
</span><a href="#local-6989586621679322366"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Rec
  ('R
     '[ &quot;canister_id&quot; ':-&gt; Principal,
        &quot;settings&quot;
        ':-&gt; Rec
               ('R
                  '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                     &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                     &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                     &quot;memory_allocation&quot; ':-&gt; Maybe Natural])])
-&gt; Label &quot;settings&quot;
-&gt; 'R
     '[ &quot;canister_id&quot; ':-&gt; Principal,
        &quot;settings&quot;
        ':-&gt; Rec
               ('R
                  '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                     &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                     &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                     &quot;memory_allocation&quot; ':-&gt; Maybe Natural])]
   .! &quot;settings&quot;
forall (l :: Symbol) (r :: Row *).
KnownSymbol l =&gt;
Rec r -&gt; Label l -&gt; r .! l
</span><span class="hs-operator hs-var">.!</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;settings&quot; (Label &quot;settings&quot;)
Label &quot;settings&quot;
</span><a href="#local-6989586621679322363"><span class="hs-var">#settings</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-939"></span><span>    </span><span class="annot"><span class="annottext">EntityId -&gt; Settings -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; Settings -&gt; m ()
</span><a href="IC.Ref.html#applySettings"><span class="hs-identifier hs-var">applySettings</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322365"><span class="hs-identifier hs-var">canister_id</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Rec
  ('R
     '[ &quot;canister_id&quot; ':-&gt; Principal,
        &quot;settings&quot;
        ':-&gt; Rec
               ('R
                  '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                     &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                     &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                     &quot;memory_allocation&quot; ':-&gt; Maybe Natural])])
</span><a href="#local-6989586621679322366"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Rec
  ('R
     '[ &quot;canister_id&quot; ':-&gt; Principal,
        &quot;settings&quot;
        ':-&gt; Rec
               ('R
                  '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                     &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                     &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                     &quot;memory_allocation&quot; ':-&gt; Maybe Natural])])
-&gt; Label &quot;settings&quot;
-&gt; 'R
     '[ &quot;canister_id&quot; ':-&gt; Principal,
        &quot;settings&quot;
        ':-&gt; Rec
               ('R
                  '[ &quot;compute_allocation&quot; ':-&gt; Maybe Natural,
                     &quot;controllers&quot; ':-&gt; Maybe (Vector Principal),
                     &quot;freezing_threshold&quot; ':-&gt; Maybe Natural,
                     &quot;memory_allocation&quot; ':-&gt; Maybe Natural])]
   .! &quot;settings&quot;
forall (l :: Symbol) (r :: Row *).
KnownSymbol l =&gt;
Rec r -&gt; Label l -&gt; r .! l
</span><span class="hs-operator hs-var">.!</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;settings&quot; (Label &quot;settings&quot;)
Label &quot;settings&quot;
</span><a href="#local-6989586621679322362"><span class="hs-var">#settings</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-940"></span><span>
</span><span id="line-941"></span><span id="local-6989586621679323266"><span class="annot"><a href="IC.Ref.html#icStartCanister"><span class="hs-identifier hs-type">icStartCanister</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323266"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#CanReject"><span class="hs-identifier hs-type">CanReject</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323266"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Management.html#ICManagement"><span class="hs-identifier hs-type">ICManagement</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323266"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">.!</span></span><span> </span><span class="annot"><span class="hs-string">&quot;start_canister&quot;</span></span></span><span>
</span><span id="line-942"></span><span id="icStartCanister"><span class="annot"><span class="annottext">icStartCanister :: ICManagement m .! &quot;start_canister&quot;
</span><a href="IC.Ref.html#icStartCanister"><span class="hs-identifier hs-var hs-var">icStartCanister</span></a></span></span><span> </span><span id="local-6989586621679322361"><span class="annot"><span class="annottext">r :: Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
</span><a href="#local-6989586621679322361"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-943"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679322360"><span class="annot"><span class="annottext">canister_id :: EntityId
</span><a href="#local-6989586621679322360"><span class="hs-identifier hs-var hs-var">canister_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Principal -&gt; EntityId
</span><a href="IC.Management.html#principalToEntityId"><span class="hs-identifier hs-var">principalToEntityId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
</span><a href="#local-6989586621679322361"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; Label &quot;canister_id&quot;
-&gt; 'R '[ &quot;canister_id&quot; ':-&gt; Principal] .! &quot;canister_id&quot;
forall (l :: Symbol) (r :: Row *).
KnownSymbol l =&gt;
Rec r -&gt; Label l -&gt; r .! l
</span><span class="hs-operator hs-var">.!</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;canister_id&quot; (Label &quot;canister_id&quot;)
Label &quot;canister_id&quot;
</span><a href="#local-6989586621679322359"><span class="hs-var">#canister_id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-944"></span><span>    </span><span class="annot"><span class="annottext">EntityId -&gt; m RunStatus
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; m RunStatus
</span><a href="IC.Ref.html#getRunStatus"><span class="hs-identifier hs-var">getRunStatus</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322360"><span class="hs-identifier hs-var">canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">m RunStatus -&gt; (RunStatus -&gt; m ()) -&gt; m ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-945"></span><span>        </span><span class="annot"><a href="IC.Ref.html#IsRunning"><span class="hs-identifier hs-type">IsRunning</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-946"></span><span>        </span><span class="annot"><a href="IC.Ref.html#IsStopping"><span class="hs-identifier hs-type">IsStopping</span></a></span><span> </span><span id="local-6989586621679322358"><span class="annot"><span class="annottext">pending :: [Int]
</span><a href="#local-6989586621679322358"><span class="hs-identifier hs-var">pending</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; (Int -&gt; m ()) -&gt; m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621679322358"><span class="hs-identifier hs-var">pending</span></a></span><span> </span><span class="annot"><span class="annottext">((Int -&gt; m ()) -&gt; m ()) -&gt; (Int -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679322357"><span class="annot"><span class="annottext">ctxt_id :: Int
</span><a href="#local-6989586621679322357"><span class="hs-identifier hs-var">ctxt_id</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-947"></span><span>            </span><span class="annot"><span class="annottext">Int -&gt; (RejectCode, String) -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; Int -&gt; (RejectCode, String) -&gt; m ()
</span><a href="IC.Ref.html#rejectCallContext"><span class="hs-identifier hs-var">rejectCallContext</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322357"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RejectCode
</span><a href="IC.Types.html#RC_CANISTER_ERROR"><span class="hs-identifier hs-var">RC_CANISTER_ERROR</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;Canister has been restarted&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-948"></span><span>        </span><span class="annot"><a href="IC.Ref.html#IsStopped"><span class="hs-identifier hs-type">IsStopped</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; RunStatus -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; RunStatus -&gt; m ()
</span><a href="IC.Ref.html#setRunStatus"><span class="hs-identifier hs-var">setRunStatus</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322360"><span class="hs-identifier hs-var">canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">RunStatus
</span><a href="IC.Ref.html#IsRunning"><span class="hs-identifier hs-var">IsRunning</span></a></span><span>
</span><span id="line-949"></span><span>        </span><span class="annot"><a href="IC.Ref.html#IsDeleted"><span class="hs-identifier hs-type">IsDeleted</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; m ()
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="hs-string">&quot;deleted canister encountered&quot;</span></span><span>
</span><span id="line-950"></span><span>
</span><span id="line-951"></span><span id="local-6989586621679323262"><span id="local-6989586621679323263"><span id="local-6989586621679323264"><span class="annot"><a href="IC.Ref.html#icStopCanister"><span class="hs-identifier hs-type">icStopCanister</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-952"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323264"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#CanReject"><span class="hs-identifier hs-type">CanReject</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323264"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-953"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679323263"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323264"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323262"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-glyph hs-type">~</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Management.html#ICManagement"><span class="hs-identifier hs-type">ICManagement</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323264"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">.!</span></span><span> </span><span class="annot"><span class="hs-string">&quot;stop_canister&quot;</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-954"></span><span>  </span><span class="annot"><a href="IC.Ref.html#CallId"><span class="hs-identifier hs-type">CallId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323263"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323264"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-955"></span><span id="icStopCanister"><span class="annot"><span class="annottext">icStopCanister :: Int -&gt; a -&gt; m ()
</span><a href="IC.Ref.html#icStopCanister"><span class="hs-identifier hs-var hs-var">icStopCanister</span></a></span></span><span> </span><span id="local-6989586621679322356"><span class="annot"><span class="annottext">ctxt_id :: Int
</span><a href="#local-6989586621679322356"><span class="hs-identifier hs-var">ctxt_id</span></a></span></span><span> </span><span id="local-6989586621679322355"><span class="annot"><span class="annottext">r :: a
</span><a href="#local-6989586621679322355"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-956"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679322354"><span class="annot"><span class="annottext">canister_id :: EntityId
</span><a href="#local-6989586621679322354"><span class="hs-identifier hs-var hs-var">canister_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Principal -&gt; EntityId
</span><a href="IC.Management.html#principalToEntityId"><span class="hs-identifier hs-var">principalToEntityId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
</span><a href="#local-6989586621679322355"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; Label &quot;canister_id&quot;
-&gt; 'R '[ &quot;canister_id&quot; ':-&gt; Principal] .! &quot;canister_id&quot;
forall (l :: Symbol) (r :: Row *).
KnownSymbol l =&gt;
Rec r -&gt; Label l -&gt; r .! l
</span><span class="hs-operator hs-var">.!</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;canister_id&quot; (Label &quot;canister_id&quot;)
Label &quot;canister_id&quot;
</span><a href="#local-6989586621679322353"><span class="hs-var">#canister_id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-957"></span><span>    </span><span class="annot"><span class="annottext">EntityId -&gt; m RunStatus
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; m RunStatus
</span><a href="IC.Ref.html#getRunStatus"><span class="hs-identifier hs-var">getRunStatus</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322354"><span class="hs-identifier hs-var">canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">m RunStatus -&gt; (RunStatus -&gt; m ()) -&gt; m ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-958"></span><span>        </span><span class="annot"><a href="IC.Ref.html#IsRunning"><span class="hs-identifier hs-type">IsRunning</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; RunStatus -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; RunStatus -&gt; m ()
</span><a href="IC.Ref.html#setRunStatus"><span class="hs-identifier hs-var">setRunStatus</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322354"><span class="hs-identifier hs-var">canister_id</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Int] -&gt; RunStatus
</span><a href="IC.Ref.html#IsStopping"><span class="hs-identifier hs-var">IsStopping</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322356"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-959"></span><span>        </span><span class="annot"><a href="IC.Ref.html#IsStopping"><span class="hs-identifier hs-type">IsStopping</span></a></span><span> </span><span id="local-6989586621679322352"><span class="annot"><span class="annottext">pending :: [Int]
</span><a href="#local-6989586621679322352"><span class="hs-identifier hs-var">pending</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; RunStatus -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; RunStatus -&gt; m ()
</span><a href="IC.Ref.html#setRunStatus"><span class="hs-identifier hs-var">setRunStatus</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322354"><span class="hs-identifier hs-var">canister_id</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Int] -&gt; RunStatus
</span><a href="IC.Ref.html#IsStopping"><span class="hs-identifier hs-var">IsStopping</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621679322352"><span class="hs-identifier hs-var">pending</span></a></span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; [Int] -&gt; [Int]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322356"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-960"></span><span>        </span><span class="annot"><a href="IC.Ref.html#IsStopped"><span class="hs-identifier hs-type">IsStopped</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Blob -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; Int -&gt; Blob -&gt; m ()
</span><a href="IC.Ref.html#replyCallContext"><span class="hs-identifier hs-var">replyCallContext</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322356"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; Blob
forall a. CandidArg a =&gt; a -&gt; Blob
</span><span class="hs-identifier hs-var">encode</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-961"></span><span>        </span><span class="annot"><a href="IC.Ref.html#IsDeleted"><span class="hs-identifier hs-type">IsDeleted</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; m ()
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="hs-string">&quot;deleted canister encountered&quot;</span></span><span>
</span><span id="line-962"></span><span>
</span><span id="line-963"></span><span id="local-6989586621679323138"><span class="annot"><a href="IC.Ref.html#actuallyStopCanister"><span class="hs-identifier hs-type">actuallyStopCanister</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323138"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323138"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-964"></span><span id="actuallyStopCanister"><span class="annot"><span class="annottext">actuallyStopCanister :: EntityId -&gt; m ()
</span><a href="IC.Ref.html#actuallyStopCanister"><span class="hs-identifier hs-var hs-var">actuallyStopCanister</span></a></span></span><span> </span><span id="local-6989586621679322350"><span class="annot"><span class="annottext">canister_id :: EntityId
</span><a href="#local-6989586621679322350"><span class="hs-identifier hs-var">canister_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-965"></span><span>    </span><span class="annot"><span class="annottext">EntityId -&gt; m RunStatus
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; m RunStatus
</span><a href="IC.Ref.html#getRunStatus"><span class="hs-identifier hs-var">getRunStatus</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322350"><span class="hs-identifier hs-var">canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">m RunStatus -&gt; (RunStatus -&gt; m ()) -&gt; m ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-966"></span><span>        </span><span class="annot"><a href="IC.Ref.html#IsStopping"><span class="hs-identifier hs-type">IsStopping</span></a></span><span> </span><span id="local-6989586621679322349"><span class="annot"><span class="annottext">pending :: [Int]
</span><a href="#local-6989586621679322349"><span class="hs-identifier hs-var">pending</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-967"></span><span>            </span><span class="annot"><span class="annottext">EntityId -&gt; RunStatus -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; RunStatus -&gt; m ()
</span><a href="IC.Ref.html#setRunStatus"><span class="hs-identifier hs-var">setRunStatus</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322350"><span class="hs-identifier hs-var">canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">RunStatus
</span><a href="IC.Ref.html#IsStopped"><span class="hs-identifier hs-var">IsStopped</span></a></span><span>
</span><span id="line-968"></span><span>            </span><span class="annot"><span class="annottext">[Int] -&gt; (Int -&gt; m ()) -&gt; m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621679322349"><span class="hs-identifier hs-var">pending</span></a></span><span> </span><span class="annot"><span class="annottext">((Int -&gt; m ()) -&gt; m ()) -&gt; (Int -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679322348"><span class="annot"><span class="annottext">ctxt_id :: Int
</span><a href="#local-6989586621679322348"><span class="hs-identifier hs-var">ctxt_id</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-969"></span><span>              </span><span class="annot"><span class="annottext">Int -&gt; Blob -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; Int -&gt; Blob -&gt; m ()
</span><a href="IC.Ref.html#replyCallContext"><span class="hs-identifier hs-var">replyCallContext</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322348"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; Blob
forall a. CandidArg a =&gt; a -&gt; Blob
</span><span class="hs-identifier hs-var">Codec.Candid.encode</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-970"></span><span>        </span><span class="annot"><a href="IC.Ref.html#IsRunning"><span class="hs-identifier hs-type">IsRunning</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; m ()
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="hs-string">&quot;unexpected canister status&quot;</span></span><span>
</span><span id="line-971"></span><span>        </span><span class="annot"><a href="IC.Ref.html#IsStopped"><span class="hs-identifier hs-type">IsStopped</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; m ()
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="hs-string">&quot;unexpected canister status&quot;</span></span><span>
</span><span id="line-972"></span><span>        </span><span class="annot"><a href="IC.Ref.html#IsDeleted"><span class="hs-identifier hs-type">IsDeleted</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; m ()
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="hs-string">&quot;deleted canister encountered&quot;</span></span><span>
</span><span id="line-973"></span><span>
</span><span id="line-974"></span><span id="local-6989586621679323261"><span class="annot"><a href="IC.Ref.html#icCanisterStatus"><span class="hs-identifier hs-type">icCanisterStatus</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323261"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#CanReject"><span class="hs-identifier hs-type">CanReject</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323261"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Management.html#ICManagement"><span class="hs-identifier hs-type">ICManagement</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323261"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">.!</span></span><span> </span><span class="annot"><span class="hs-string">&quot;canister_status&quot;</span></span></span><span>
</span><span id="line-975"></span><span id="icCanisterStatus"><span class="annot"><span class="annottext">icCanisterStatus :: ICManagement m .! &quot;canister_status&quot;
</span><a href="IC.Ref.html#icCanisterStatus"><span class="hs-identifier hs-var hs-var">icCanisterStatus</span></a></span></span><span> </span><span id="local-6989586621679322347"><span class="annot"><span class="annottext">r :: Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
</span><a href="#local-6989586621679322347"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-976"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679322346"><span class="annot"><span class="annottext">canister_id :: EntityId
</span><a href="#local-6989586621679322346"><span class="hs-identifier hs-var hs-var">canister_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Principal -&gt; EntityId
</span><a href="IC.Management.html#principalToEntityId"><span class="hs-identifier hs-var">principalToEntityId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
</span><a href="#local-6989586621679322347"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; Label &quot;canister_id&quot;
-&gt; 'R '[ &quot;canister_id&quot; ':-&gt; Principal] .! &quot;canister_id&quot;
forall (l :: Symbol) (r :: Row *).
KnownSymbol l =&gt;
Rec r -&gt; Label l -&gt; r .! l
</span><span class="hs-operator hs-var">.!</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;canister_id&quot; (Label &quot;canister_id&quot;)
Label &quot;canister_id&quot;
</span><a href="#local-6989586621679322345"><span class="hs-var">#canister_id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-977"></span><span>    </span><span id="local-6989586621679322344"><span class="annot"><span class="annottext">Var
  ('R '[ &quot;running&quot; ':-&gt; (), &quot;stopped&quot; ':-&gt; (), &quot;stopping&quot; ':-&gt; ()])
</span><a href="#local-6989586621679322344"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; m RunStatus
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; m RunStatus
</span><a href="IC.Ref.html#getRunStatus"><span class="hs-identifier hs-var">getRunStatus</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322346"><span class="hs-identifier hs-var">canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">m RunStatus
-&gt; (RunStatus
    -&gt; m (Var
            ('R '[ &quot;running&quot; ':-&gt; (), &quot;stopped&quot; ':-&gt; (), &quot;stopping&quot; ':-&gt; ()])))
-&gt; m (Var
        ('R '[ &quot;running&quot; ':-&gt; (), &quot;stopped&quot; ':-&gt; (), &quot;stopping&quot; ':-&gt; ()]))
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-978"></span><span>        </span><span class="annot"><a href="IC.Ref.html#IsRunning"><span class="hs-identifier hs-type">IsRunning</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Var
  ('R '[ &quot;running&quot; ':-&gt; (), &quot;stopped&quot; ':-&gt; (), &quot;stopping&quot; ':-&gt; ()])
-&gt; m (Var
        ('R '[ &quot;running&quot; ':-&gt; (), &quot;stopped&quot; ':-&gt; (), &quot;stopping&quot; ':-&gt; ()]))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Label &quot;running&quot;
-&gt; ('R '[ &quot;running&quot; ':-&gt; (), &quot;stopped&quot; ':-&gt; (), &quot;stopping&quot; ':-&gt; ()]
    .! &quot;running&quot;)
-&gt; Var
     ('R '[ &quot;running&quot; ':-&gt; (), &quot;stopped&quot; ':-&gt; (), &quot;stopping&quot; ':-&gt; ()])
forall (l :: Symbol) (r :: Row *).
(AllUniqueLabels r, KnownSymbol l) =&gt;
Label l -&gt; (r .! l) -&gt; Var r
</span><span class="hs-identifier hs-var">V.IsJust</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;running&quot; (Label &quot;running&quot;)
Label &quot;running&quot;
</span><a href="#local-6989586621679322342"><span class="hs-var">#running</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-979"></span><span>        </span><span class="annot"><a href="IC.Ref.html#IsStopping"><span class="hs-identifier hs-type">IsStopping</span></a></span><span> </span><span id="local-6989586621679322341"><span class="annot"><span class="annottext">_pending :: [Int]
</span><a href="#local-6989586621679322341"><span class="hs-identifier hs-var">_pending</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Var
  ('R '[ &quot;running&quot; ':-&gt; (), &quot;stopped&quot; ':-&gt; (), &quot;stopping&quot; ':-&gt; ()])
-&gt; m (Var
        ('R '[ &quot;running&quot; ':-&gt; (), &quot;stopped&quot; ':-&gt; (), &quot;stopping&quot; ':-&gt; ()]))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Label &quot;stopping&quot;
-&gt; ('R '[ &quot;running&quot; ':-&gt; (), &quot;stopped&quot; ':-&gt; (), &quot;stopping&quot; ':-&gt; ()]
    .! &quot;stopping&quot;)
-&gt; Var
     ('R '[ &quot;running&quot; ':-&gt; (), &quot;stopped&quot; ':-&gt; (), &quot;stopping&quot; ':-&gt; ()])
forall (l :: Symbol) (r :: Row *).
(AllUniqueLabels r, KnownSymbol l) =&gt;
Label l -&gt; (r .! l) -&gt; Var r
</span><span class="hs-identifier hs-var">V.IsJust</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;stopping&quot; (Label &quot;stopping&quot;)
Label &quot;stopping&quot;
</span><a href="#local-6989586621679322340"><span class="hs-var">#stopping</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-980"></span><span>        </span><span class="annot"><a href="IC.Ref.html#IsStopped"><span class="hs-identifier hs-type">IsStopped</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Var
  ('R '[ &quot;running&quot; ':-&gt; (), &quot;stopped&quot; ':-&gt; (), &quot;stopping&quot; ':-&gt; ()])
-&gt; m (Var
        ('R '[ &quot;running&quot; ':-&gt; (), &quot;stopped&quot; ':-&gt; (), &quot;stopping&quot; ':-&gt; ()]))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Label &quot;stopped&quot;
-&gt; ('R '[ &quot;running&quot; ':-&gt; (), &quot;stopped&quot; ':-&gt; (), &quot;stopping&quot; ':-&gt; ()]
    .! &quot;stopped&quot;)
-&gt; Var
     ('R '[ &quot;running&quot; ':-&gt; (), &quot;stopped&quot; ':-&gt; (), &quot;stopping&quot; ':-&gt; ()])
forall (l :: Symbol) (r :: Row *).
(AllUniqueLabels r, KnownSymbol l) =&gt;
Label l -&gt; (r .! l) -&gt; Var r
</span><span class="hs-identifier hs-var">V.IsJust</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;stopped&quot; (Label &quot;stopped&quot;)
Label &quot;stopped&quot;
</span><a href="#local-6989586621679322339"><span class="hs-var">#stopped</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-981"></span><span>        </span><span class="annot"><a href="IC.Ref.html#IsDeleted"><span class="hs-identifier hs-type">IsDeleted</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String
-&gt; m (Var
        ('R '[ &quot;running&quot; ':-&gt; (), &quot;stopped&quot; ':-&gt; (), &quot;stopping&quot; ':-&gt; ()]))
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="hs-string">&quot;deleted canister encountered&quot;</span></span><span>
</span><span id="line-982"></span><span>    </span><span id="local-6989586621679322338"><span class="annot"><span class="annottext">CanState
</span><a href="#local-6989586621679322338"><span class="hs-identifier hs-var">can_state</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; m CanState
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; m CanState
</span><a href="IC.Ref.html#getCanister"><span class="hs-identifier hs-var">getCanister</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322346"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-983"></span><span>    </span><span id="local-6989586621679322337"><span class="annot"><span class="annottext">Maybe Blob
</span><a href="#local-6989586621679322337"><span class="hs-identifier hs-var">hash</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CanState -&gt; Maybe Blob
</span><a href="IC.Ref.html#module_hash"><span class="hs-identifier hs-var">module_hash</span></a></span><span> </span><span class="annot"><span class="annottext">(CanState -&gt; Maybe Blob) -&gt; m CanState -&gt; m (Maybe Blob)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; m CanState
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; m CanState
</span><a href="IC.Ref.html#getCanister"><span class="hs-identifier hs-var">getCanister</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322346"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-984"></span><span>    </span><span id="local-6989586621679322336"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679322336"><span class="hs-identifier hs-var">cycles</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; m Natural
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; m Natural
</span><a href="IC.Ref.html#getBalance"><span class="hs-identifier hs-var">getBalance</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322346"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-985"></span><span>    </span><span class="annot"><span class="annottext">Rec
  ('R
     (Inject
        (&quot;cycles&quot; ':-&gt; Natural)
        '[ &quot;memory_size&quot; ':-&gt; Natural, &quot;module_hash&quot; ':-&gt; Maybe Blob,
           &quot;settings&quot;
           ':-&gt; Rec
                  ('R
                     '[ &quot;compute_allocation&quot; ':-&gt; Natural,
                        &quot;controllers&quot; ':-&gt; Vector Principal,
                        &quot;freezing_threshold&quot; ':-&gt; Natural,
                        &quot;memory_allocation&quot; ':-&gt; Natural]),
           &quot;status&quot;
           ':-&gt; Var
                  ('R
                     '[ &quot;running&quot; ':-&gt; (), &quot;stopped&quot; ':-&gt; (), &quot;stopping&quot; ':-&gt; ()])]))
-&gt; m (Rec
        ('R
           (Inject
              (&quot;cycles&quot; ':-&gt; Natural)
              '[ &quot;memory_size&quot; ':-&gt; Natural, &quot;module_hash&quot; ':-&gt; Maybe Blob,
                 &quot;settings&quot;
                 ':-&gt; Rec
                        ('R
                           '[ &quot;compute_allocation&quot; ':-&gt; Natural,
                              &quot;controllers&quot; ':-&gt; Vector Principal,
                              &quot;freezing_threshold&quot; ':-&gt; Natural,
                              &quot;memory_allocation&quot; ':-&gt; Natural]),
                 &quot;status&quot;
                 ':-&gt; Var
                        ('R
                           '[ &quot;running&quot; ':-&gt; (), &quot;stopped&quot; ':-&gt; (), &quot;stopping&quot; ':-&gt; ()])])))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Rec
   ('R
      (Inject
         (&quot;cycles&quot; ':-&gt; Natural)
         '[ &quot;memory_size&quot; ':-&gt; Natural, &quot;module_hash&quot; ':-&gt; Maybe Blob,
            &quot;settings&quot;
            ':-&gt; Rec
                   ('R
                      '[ &quot;compute_allocation&quot; ':-&gt; Natural,
                         &quot;controllers&quot; ':-&gt; Vector Principal,
                         &quot;freezing_threshold&quot; ':-&gt; Natural,
                         &quot;memory_allocation&quot; ':-&gt; Natural]),
            &quot;status&quot;
            ':-&gt; Var
                   ('R
                      '[ &quot;running&quot; ':-&gt; (), &quot;stopped&quot; ':-&gt; (), &quot;stopping&quot; ':-&gt; ()])]))
 -&gt; m (Rec
         ('R
            (Inject
               (&quot;cycles&quot; ':-&gt; Natural)
               '[ &quot;memory_size&quot; ':-&gt; Natural, &quot;module_hash&quot; ':-&gt; Maybe Blob,
                  &quot;settings&quot;
                  ':-&gt; Rec
                         ('R
                            '[ &quot;compute_allocation&quot; ':-&gt; Natural,
                               &quot;controllers&quot; ':-&gt; Vector Principal,
                               &quot;freezing_threshold&quot; ':-&gt; Natural,
                               &quot;memory_allocation&quot; ':-&gt; Natural]),
                  &quot;status&quot;
                  ':-&gt; Var
                         ('R
                            '[ &quot;running&quot; ':-&gt; (), &quot;stopped&quot; ':-&gt; (), &quot;stopping&quot; ':-&gt; ()])]))))
-&gt; Rec
     ('R
        (Inject
           (&quot;cycles&quot; ':-&gt; Natural)
           '[ &quot;memory_size&quot; ':-&gt; Natural, &quot;module_hash&quot; ':-&gt; Maybe Blob,
              &quot;settings&quot;
              ':-&gt; Rec
                     ('R
                        '[ &quot;compute_allocation&quot; ':-&gt; Natural,
                           &quot;controllers&quot; ':-&gt; Vector Principal,
                           &quot;freezing_threshold&quot; ':-&gt; Natural,
                           &quot;memory_allocation&quot; ':-&gt; Natural]),
              &quot;status&quot;
              ':-&gt; Var
                     ('R
                        '[ &quot;running&quot; ':-&gt; (), &quot;stopped&quot; ':-&gt; (), &quot;stopping&quot; ':-&gt; ()])]))
-&gt; m (Rec
        ('R
           (Inject
              (&quot;cycles&quot; ':-&gt; Natural)
              '[ &quot;memory_size&quot; ':-&gt; Natural, &quot;module_hash&quot; ':-&gt; Maybe Blob,
                 &quot;settings&quot;
                 ':-&gt; Rec
                        ('R
                           '[ &quot;compute_allocation&quot; ':-&gt; Natural,
                              &quot;controllers&quot; ':-&gt; Vector Principal,
                              &quot;freezing_threshold&quot; ':-&gt; Natural,
                              &quot;memory_allocation&quot; ':-&gt; Natural]),
                 &quot;status&quot;
                 ':-&gt; Var
                        ('R
                           '[ &quot;running&quot; ':-&gt; (), &quot;stopped&quot; ':-&gt; (), &quot;stopping&quot; ':-&gt; ()])])))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Rec Empty
</span><span class="hs-identifier hs-var">R.empty</span></span><span>
</span><span id="line-986"></span><span>      </span><span class="annot"><span class="annottext">Rec Empty
-&gt; Rec
     ('R
        '[ &quot;status&quot;
           ':-&gt; Var
                  ('R '[ &quot;running&quot; ':-&gt; (), &quot;stopped&quot; ':-&gt; (), &quot;stopping&quot; ':-&gt; ()])])
-&gt; Rec
     (Empty
      .+ 'R
           '[ &quot;status&quot;
              ':-&gt; Var
                     ('R '[ &quot;running&quot; ':-&gt; (), &quot;stopped&quot; ':-&gt; (), &quot;stopping&quot; ':-&gt; ()])])
forall (l :: Row *) (r :: Row *).
FreeForall l =&gt;
Rec l -&gt; Rec r -&gt; Rec (l .+ r)
</span><span class="hs-operator hs-var">.+</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;status&quot; (Label &quot;status&quot;)
Label &quot;status&quot;
</span><a href="#local-6989586621679322335"><span class="hs-var">#status</span></a></span><span> </span><span class="annot"><span class="annottext">Label &quot;status&quot;
-&gt; Var
     ('R '[ &quot;running&quot; ':-&gt; (), &quot;stopped&quot; ':-&gt; (), &quot;stopping&quot; ':-&gt; ()])
-&gt; Rec
     (&quot;status&quot;
      .== Var
            ('R '[ &quot;running&quot; ':-&gt; (), &quot;stopped&quot; ':-&gt; (), &quot;stopping&quot; ':-&gt; ()]))
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec (l .== a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">Var
  ('R '[ &quot;running&quot; ':-&gt; (), &quot;stopped&quot; ':-&gt; (), &quot;stopping&quot; ':-&gt; ()])
</span><a href="#local-6989586621679322344"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-987"></span><span>      </span><span class="annot"><span class="annottext">Rec
  ('R
     '[ &quot;status&quot;
        ':-&gt; Var
               ('R '[ &quot;running&quot; ':-&gt; (), &quot;stopped&quot; ':-&gt; (), &quot;stopping&quot; ':-&gt; ()])])
-&gt; Rec
     ('R
        '[ &quot;settings&quot;
           ':-&gt; Rec
                  ('R
                     (Inject
                        (&quot;freezing_threshold&quot; ':-&gt; Natural)
                        '[ &quot;compute_allocation&quot; ':-&gt; Natural,
                           &quot;controllers&quot; ':-&gt; Vector Principal,
                           &quot;memory_allocation&quot; ':-&gt; Natural]))])
-&gt; Rec
     ('R
        '[ &quot;status&quot;
           ':-&gt; Var
                  ('R '[ &quot;running&quot; ':-&gt; (), &quot;stopped&quot; ':-&gt; (), &quot;stopping&quot; ':-&gt; ()])]
      .+ 'R
           '[ &quot;settings&quot;
              ':-&gt; Rec
                     ('R
                        (Inject
                           (&quot;freezing_threshold&quot; ':-&gt; Natural)
                           '[ &quot;compute_allocation&quot; ':-&gt; Natural,
                              &quot;controllers&quot; ':-&gt; Vector Principal,
                              &quot;memory_allocation&quot; ':-&gt; Natural]))])
forall (l :: Row *) (r :: Row *).
FreeForall l =&gt;
Rec l -&gt; Rec r -&gt; Rec (l .+ r)
</span><span class="hs-operator hs-var">.+</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;settings&quot; (Label &quot;settings&quot;)
Label &quot;settings&quot;
</span><a href="#local-6989586621679322334"><span class="hs-var">#settings</span></a></span><span> </span><span class="annot"><span class="annottext">Label &quot;settings&quot;
-&gt; Rec
     ('R
        (Inject
           (&quot;freezing_threshold&quot; ':-&gt; Natural)
           '[ &quot;compute_allocation&quot; ':-&gt; Natural,
              &quot;controllers&quot; ':-&gt; Vector Principal,
              &quot;memory_allocation&quot; ':-&gt; Natural]))
-&gt; Rec
     (&quot;settings&quot;
      .== Rec
            ('R
               (Inject
                  (&quot;freezing_threshold&quot; ':-&gt; Natural)
                  '[ &quot;compute_allocation&quot; ':-&gt; Natural,
                     &quot;controllers&quot; ':-&gt; Vector Principal,
                     &quot;memory_allocation&quot; ':-&gt; Natural])))
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec (l .== a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Rec Empty
</span><span class="hs-identifier hs-var">R.empty</span></span><span>
</span><span id="line-988"></span><span>        </span><span class="annot"><span class="annottext">Rec Empty
-&gt; Rec ('R '[ &quot;controllers&quot; ':-&gt; Vector Principal])
-&gt; Rec (Empty .+ 'R '[ &quot;controllers&quot; ':-&gt; Vector Principal])
forall (l :: Row *) (r :: Row *).
FreeForall l =&gt;
Rec l -&gt; Rec r -&gt; Rec (l .+ r)
</span><span class="hs-operator hs-var">.+</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;controllers&quot; (Label &quot;controllers&quot;)
Label &quot;controllers&quot;
</span><a href="#local-6989586621679322333"><span class="hs-var">#controllers</span></a></span><span> </span><span class="annot"><span class="annottext">Label &quot;controllers&quot;
-&gt; Vector Principal -&gt; Rec (&quot;controllers&quot; .== Vector Principal)
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec (l .== a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">[Principal] -&gt; Vector Principal
forall a. [a] -&gt; Vector a
</span><span class="hs-identifier hs-var">Vec.fromList</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(EntityId -&gt; Principal) -&gt; [EntityId] -&gt; [Principal]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; Principal
</span><a href="IC.Management.html#entityIdToPrincipal"><span class="hs-identifier hs-var">entityIdToPrincipal</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set EntityId -&gt; [EntityId]
forall a. Set a -&gt; [a]
</span><span class="hs-identifier hs-var">S.toList</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CanState -&gt; Set EntityId
</span><a href="IC.Ref.html#controllers"><span class="hs-identifier hs-var hs-var">controllers</span></a></span><span> </span><span class="annot"><span class="annottext">CanState
</span><a href="#local-6989586621679322338"><span class="hs-identifier hs-var">can_state</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-989"></span><span>        </span><span class="annot"><span class="annottext">Rec ('R '[ &quot;controllers&quot; ':-&gt; Vector Principal])
-&gt; Rec ('R '[ &quot;memory_allocation&quot; ':-&gt; Natural])
-&gt; Rec
     ('R '[ &quot;controllers&quot; ':-&gt; Vector Principal]
      .+ 'R '[ &quot;memory_allocation&quot; ':-&gt; Natural])
forall (l :: Row *) (r :: Row *).
FreeForall l =&gt;
Rec l -&gt; Rec r -&gt; Rec (l .+ r)
</span><span class="hs-operator hs-var">.+</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;memory_allocation&quot; (Label &quot;memory_allocation&quot;)
Label &quot;memory_allocation&quot;
</span><a href="#local-6989586621679322331"><span class="hs-var">#memory_allocation</span></a></span><span> </span><span class="annot"><span class="annottext">Label &quot;memory_allocation&quot;
-&gt; Natural -&gt; Rec (&quot;memory_allocation&quot; .== Natural)
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec (l .== a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">CanState -&gt; Natural
</span><a href="IC.Ref.html#memory_allocation"><span class="hs-identifier hs-var hs-var">memory_allocation</span></a></span><span> </span><span class="annot"><span class="annottext">CanState
</span><a href="#local-6989586621679322338"><span class="hs-identifier hs-var">can_state</span></a></span><span>
</span><span id="line-990"></span><span>        </span><span class="annot"><span class="annottext">Rec
  ('R
     '[ &quot;controllers&quot; ':-&gt; Vector Principal,
        &quot;memory_allocation&quot; ':-&gt; Natural])
-&gt; Rec ('R '[ &quot;compute_allocation&quot; ':-&gt; Natural])
-&gt; Rec
     ('R
        '[ &quot;controllers&quot; ':-&gt; Vector Principal,
           &quot;memory_allocation&quot; ':-&gt; Natural]
      .+ 'R '[ &quot;compute_allocation&quot; ':-&gt; Natural])
forall (l :: Row *) (r :: Row *).
FreeForall l =&gt;
Rec l -&gt; Rec r -&gt; Rec (l .+ r)
</span><span class="hs-operator hs-var">.+</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;compute_allocation&quot; (Label &quot;compute_allocation&quot;)
Label &quot;compute_allocation&quot;
</span><a href="#local-6989586621679322330"><span class="hs-var">#compute_allocation</span></a></span><span> </span><span class="annot"><span class="annottext">Label &quot;compute_allocation&quot;
-&gt; Natural -&gt; Rec (&quot;compute_allocation&quot; .== Natural)
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec (l .== a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">CanState -&gt; Natural
</span><a href="IC.Ref.html#compute_allocation"><span class="hs-identifier hs-var hs-var">compute_allocation</span></a></span><span> </span><span class="annot"><span class="annottext">CanState
</span><a href="#local-6989586621679322338"><span class="hs-identifier hs-var">can_state</span></a></span><span>
</span><span id="line-991"></span><span>        </span><span class="annot"><span class="annottext">Rec
  ('R
     '[ &quot;compute_allocation&quot; ':-&gt; Natural,
        &quot;controllers&quot; ':-&gt; Vector Principal,
        &quot;memory_allocation&quot; ':-&gt; Natural])
-&gt; Rec ('R '[ &quot;freezing_threshold&quot; ':-&gt; Natural])
-&gt; Rec
     ('R
        '[ &quot;compute_allocation&quot; ':-&gt; Natural,
           &quot;controllers&quot; ':-&gt; Vector Principal,
           &quot;memory_allocation&quot; ':-&gt; Natural]
      .+ 'R '[ &quot;freezing_threshold&quot; ':-&gt; Natural])
forall (l :: Row *) (r :: Row *).
FreeForall l =&gt;
Rec l -&gt; Rec r -&gt; Rec (l .+ r)
</span><span class="hs-operator hs-var">.+</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;freezing_threshold&quot; (Label &quot;freezing_threshold&quot;)
Label &quot;freezing_threshold&quot;
</span><a href="#local-6989586621679322329"><span class="hs-var">#freezing_threshold</span></a></span><span> </span><span class="annot"><span class="annottext">Label &quot;freezing_threshold&quot;
-&gt; Natural -&gt; Rec (&quot;freezing_threshold&quot; .== Natural)
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec (l .== a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">CanState -&gt; Natural
</span><a href="IC.Ref.html#freezing_threshold"><span class="hs-identifier hs-var hs-var">freezing_threshold</span></a></span><span> </span><span class="annot"><span class="annottext">CanState
</span><a href="#local-6989586621679322338"><span class="hs-identifier hs-var">can_state</span></a></span><span>
</span><span id="line-992"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-993"></span><span>      </span><span class="annot"><span class="annottext">Rec
  ('R
     '[ &quot;settings&quot;
        ':-&gt; Rec
               ('R
                  (Inject
                     (&quot;freezing_threshold&quot; ':-&gt; Natural)
                     '[ &quot;compute_allocation&quot; ':-&gt; Natural,
                        &quot;controllers&quot; ':-&gt; Vector Principal,
                        &quot;memory_allocation&quot; ':-&gt; Natural])),
        &quot;status&quot;
        ':-&gt; Var
               ('R '[ &quot;running&quot; ':-&gt; (), &quot;stopped&quot; ':-&gt; (), &quot;stopping&quot; ':-&gt; ()])])
-&gt; Rec ('R '[ &quot;memory_size&quot; ':-&gt; Natural])
-&gt; Rec
     ('R
        '[ &quot;settings&quot;
           ':-&gt; Rec
                  ('R
                     (Inject
                        (&quot;freezing_threshold&quot; ':-&gt; Natural)
                        '[ &quot;compute_allocation&quot; ':-&gt; Natural,
                           &quot;controllers&quot; ':-&gt; Vector Principal,
                           &quot;memory_allocation&quot; ':-&gt; Natural])),
           &quot;status&quot;
           ':-&gt; Var
                  ('R '[ &quot;running&quot; ':-&gt; (), &quot;stopped&quot; ':-&gt; (), &quot;stopping&quot; ':-&gt; ()])]
      .+ 'R '[ &quot;memory_size&quot; ':-&gt; Natural])
forall (l :: Row *) (r :: Row *).
FreeForall l =&gt;
Rec l -&gt; Rec r -&gt; Rec (l .+ r)
</span><span class="hs-operator hs-var">.+</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;memory_size&quot; (Label &quot;memory_size&quot;)
Label &quot;memory_size&quot;
</span><a href="#local-6989586621679322328"><span class="hs-var">#memory_size</span></a></span><span> </span><span class="annot"><span class="annottext">Label &quot;memory_size&quot; -&gt; Natural -&gt; Rec (&quot;memory_size&quot; .== Natural)
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec (l .== a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="hs-number">0</span></span><span> </span><span class="hs-comment">-- not implemented here</span><span>
</span><span id="line-994"></span><span>      </span><span class="annot"><span class="annottext">Rec
  ('R
     '[ &quot;memory_size&quot; ':-&gt; Natural,
        &quot;settings&quot;
        ':-&gt; Rec
               ('R
                  '[ &quot;compute_allocation&quot; ':-&gt; Natural,
                     &quot;controllers&quot; ':-&gt; Vector Principal,
                     &quot;freezing_threshold&quot; ':-&gt; Natural,
                     &quot;memory_allocation&quot; ':-&gt; Natural]),
        &quot;status&quot;
        ':-&gt; Var
               ('R '[ &quot;running&quot; ':-&gt; (), &quot;stopped&quot; ':-&gt; (), &quot;stopping&quot; ':-&gt; ()])])
-&gt; Rec ('R '[ &quot;module_hash&quot; ':-&gt; Maybe Blob])
-&gt; Rec
     ('R
        '[ &quot;memory_size&quot; ':-&gt; Natural,
           &quot;settings&quot;
           ':-&gt; Rec
                  ('R
                     '[ &quot;compute_allocation&quot; ':-&gt; Natural,
                        &quot;controllers&quot; ':-&gt; Vector Principal,
                        &quot;freezing_threshold&quot; ':-&gt; Natural,
                        &quot;memory_allocation&quot; ':-&gt; Natural]),
           &quot;status&quot;
           ':-&gt; Var
                  ('R '[ &quot;running&quot; ':-&gt; (), &quot;stopped&quot; ':-&gt; (), &quot;stopping&quot; ':-&gt; ()])]
      .+ 'R '[ &quot;module_hash&quot; ':-&gt; Maybe Blob])
forall (l :: Row *) (r :: Row *).
FreeForall l =&gt;
Rec l -&gt; Rec r -&gt; Rec (l .+ r)
</span><span class="hs-operator hs-var">.+</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;module_hash&quot; (Label &quot;module_hash&quot;)
Label &quot;module_hash&quot;
</span><a href="#local-6989586621679322327"><span class="hs-var">#module_hash</span></a></span><span> </span><span class="annot"><span class="annottext">Label &quot;module_hash&quot;
-&gt; Maybe Blob -&gt; Rec (&quot;module_hash&quot; .== Maybe Blob)
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec (l .== a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">Maybe Blob
</span><a href="#local-6989586621679322337"><span class="hs-identifier hs-var">hash</span></a></span><span>
</span><span id="line-995"></span><span>      </span><span class="annot"><span class="annottext">Rec
  ('R
     '[ &quot;memory_size&quot; ':-&gt; Natural, &quot;module_hash&quot; ':-&gt; Maybe Blob,
        &quot;settings&quot;
        ':-&gt; Rec
               ('R
                  '[ &quot;compute_allocation&quot; ':-&gt; Natural,
                     &quot;controllers&quot; ':-&gt; Vector Principal,
                     &quot;freezing_threshold&quot; ':-&gt; Natural,
                     &quot;memory_allocation&quot; ':-&gt; Natural]),
        &quot;status&quot;
        ':-&gt; Var
               ('R '[ &quot;running&quot; ':-&gt; (), &quot;stopped&quot; ':-&gt; (), &quot;stopping&quot; ':-&gt; ()])])
-&gt; Rec ('R '[ &quot;cycles&quot; ':-&gt; Natural])
-&gt; Rec
     ('R
        '[ &quot;memory_size&quot; ':-&gt; Natural, &quot;module_hash&quot; ':-&gt; Maybe Blob,
           &quot;settings&quot;
           ':-&gt; Rec
                  ('R
                     '[ &quot;compute_allocation&quot; ':-&gt; Natural,
                        &quot;controllers&quot; ':-&gt; Vector Principal,
                        &quot;freezing_threshold&quot; ':-&gt; Natural,
                        &quot;memory_allocation&quot; ':-&gt; Natural]),
           &quot;status&quot;
           ':-&gt; Var
                  ('R '[ &quot;running&quot; ':-&gt; (), &quot;stopped&quot; ':-&gt; (), &quot;stopping&quot; ':-&gt; ()])]
      .+ 'R '[ &quot;cycles&quot; ':-&gt; Natural])
forall (l :: Row *) (r :: Row *).
FreeForall l =&gt;
Rec l -&gt; Rec r -&gt; Rec (l .+ r)
</span><span class="hs-operator hs-var">.+</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;cycles&quot; (Label &quot;cycles&quot;)
Label &quot;cycles&quot;
</span><a href="#local-6989586621679322326"><span class="hs-var">#cycles</span></a></span><span> </span><span class="annot"><span class="annottext">Label &quot;cycles&quot; -&gt; Natural -&gt; Rec (&quot;cycles&quot; .== Natural)
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec (l .== a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679322336"><span class="hs-identifier hs-var">cycles</span></a></span><span>
</span><span id="line-996"></span><span>
</span><span id="line-997"></span><span>
</span><span id="line-998"></span><span id="local-6989586621679323260"><span class="annot"><a href="IC.Ref.html#icDeleteCanister"><span class="hs-identifier hs-type">icDeleteCanister</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323260"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#CanReject"><span class="hs-identifier hs-type">CanReject</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323260"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Management.html#ICManagement"><span class="hs-identifier hs-type">ICManagement</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323260"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">.!</span></span><span> </span><span class="annot"><span class="hs-string">&quot;delete_canister&quot;</span></span></span><span>
</span><span id="line-999"></span><span id="icDeleteCanister"><span class="annot"><span class="annottext">icDeleteCanister :: ICManagement m .! &quot;delete_canister&quot;
</span><a href="IC.Ref.html#icDeleteCanister"><span class="hs-identifier hs-var hs-var">icDeleteCanister</span></a></span></span><span> </span><span id="local-6989586621679322325"><span class="annot"><span class="annottext">r :: Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
</span><a href="#local-6989586621679322325"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1000"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679322324"><span class="annot"><span class="annottext">canister_id :: EntityId
</span><a href="#local-6989586621679322324"><span class="hs-identifier hs-var hs-var">canister_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Principal -&gt; EntityId
</span><a href="IC.Management.html#principalToEntityId"><span class="hs-identifier hs-var">principalToEntityId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
</span><a href="#local-6989586621679322325"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; Label &quot;canister_id&quot;
-&gt; 'R '[ &quot;canister_id&quot; ':-&gt; Principal] .! &quot;canister_id&quot;
forall (l :: Symbol) (r :: Row *).
KnownSymbol l =&gt;
Rec r -&gt; Label l -&gt; r .! l
</span><span class="hs-operator hs-var">.!</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;canister_id&quot; (Label &quot;canister_id&quot;)
Label &quot;canister_id&quot;
</span><a href="#local-6989586621679322323"><span class="hs-var">#canister_id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1001"></span><span>    </span><span class="annot"><span class="annottext">EntityId -&gt; m RunStatus
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; m RunStatus
</span><a href="IC.Ref.html#getRunStatus"><span class="hs-identifier hs-var">getRunStatus</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322324"><span class="hs-identifier hs-var">canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">m RunStatus -&gt; (RunStatus -&gt; m ()) -&gt; m ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-1002"></span><span>        </span><span class="annot"><a href="IC.Ref.html#IsRunning"><span class="hs-identifier hs-type">IsRunning</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RejectCode -&gt; String -&gt; m ()
forall (m :: * -&gt; *) a2.
CanReject m =&gt;
RejectCode -&gt; String -&gt; m a2
</span><a href="IC.Ref.html#reject"><span class="hs-identifier hs-var">reject</span></a></span><span> </span><span class="annot"><span class="annottext">RejectCode
</span><a href="IC.Types.html#RC_SYS_FATAL"><span class="hs-identifier hs-var">RC_SYS_FATAL</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;Cannot delete running canister&quot;</span></span><span>
</span><span id="line-1003"></span><span>        </span><span class="annot"><a href="IC.Ref.html#IsStopping"><span class="hs-identifier hs-type">IsStopping</span></a></span><span> </span><span id="local-6989586621679322322"><span class="annot"><span class="annottext">_pending :: [Int]
</span><a href="#local-6989586621679322322"><span class="hs-identifier hs-var">_pending</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RejectCode -&gt; String -&gt; m ()
forall (m :: * -&gt; *) a2.
CanReject m =&gt;
RejectCode -&gt; String -&gt; m a2
</span><a href="IC.Ref.html#reject"><span class="hs-identifier hs-var">reject</span></a></span><span> </span><span class="annot"><span class="annottext">RejectCode
</span><a href="IC.Types.html#RC_SYS_FATAL"><span class="hs-identifier hs-var">RC_SYS_FATAL</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;Cannot delete stopping canister&quot;</span></span><span>
</span><span id="line-1004"></span><span>        </span><span class="annot"><a href="IC.Ref.html#IsStopped"><span class="hs-identifier hs-type">IsStopped</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1005"></span><span>        </span><span class="annot"><a href="IC.Ref.html#IsDeleted"><span class="hs-identifier hs-type">IsDeleted</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; m ()
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="hs-string">&quot;deleted canister encountered&quot;</span></span><span>
</span><span id="line-1006"></span><span>
</span><span id="line-1007"></span><span>    </span><span class="annot"><span class="annottext">EntityId -&gt; RunStatus -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; RunStatus -&gt; m ()
</span><a href="IC.Ref.html#setRunStatus"><span class="hs-identifier hs-var">setRunStatus</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322324"><span class="hs-identifier hs-var">canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">RunStatus
</span><a href="IC.Ref.html#IsDeleted"><span class="hs-identifier hs-var">IsDeleted</span></a></span><span>
</span><span id="line-1008"></span><span>
</span><span id="line-1009"></span><span id="local-6989586621679323259"><span class="annot"><a href="IC.Ref.html#icDepositCycles"><span class="hs-identifier hs-type">icDepositCycles</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323259"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#CanReject"><span class="hs-identifier hs-type">CanReject</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323259"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Ref.html#CallId"><span class="hs-identifier hs-type">CallId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Management.html#ICManagement"><span class="hs-identifier hs-type">ICManagement</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323259"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">.!</span></span><span> </span><span class="annot"><span class="hs-string">&quot;deposit_cycles&quot;</span></span></span><span>
</span><span id="line-1010"></span><span id="icDepositCycles"><span class="annot"><span class="annottext">icDepositCycles :: Int -&gt; ICManagement m .! &quot;deposit_cycles&quot;
</span><a href="IC.Ref.html#icDepositCycles"><span class="hs-identifier hs-var hs-var">icDepositCycles</span></a></span></span><span> </span><span id="local-6989586621679322321"><span class="annot"><span class="annottext">ctxt_id :: Int
</span><a href="#local-6989586621679322321"><span class="hs-identifier hs-var">ctxt_id</span></a></span></span><span> </span><span id="local-6989586621679322320"><span class="annot"><span class="annottext">r :: Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
</span><a href="#local-6989586621679322320"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1011"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679322319"><span class="annot"><span class="annottext">canister_id :: EntityId
</span><a href="#local-6989586621679322319"><span class="hs-identifier hs-var hs-var">canister_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Principal -&gt; EntityId
</span><a href="IC.Management.html#principalToEntityId"><span class="hs-identifier hs-var">principalToEntityId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
</span><a href="#local-6989586621679322320"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; Label &quot;canister_id&quot;
-&gt; 'R '[ &quot;canister_id&quot; ':-&gt; Principal] .! &quot;canister_id&quot;
forall (l :: Symbol) (r :: Row *).
KnownSymbol l =&gt;
Rec r -&gt; Label l -&gt; r .! l
</span><span class="hs-operator hs-var">.!</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;canister_id&quot; (Label &quot;canister_id&quot;)
Label &quot;canister_id&quot;
</span><a href="#local-6989586621679322318"><span class="hs-var">#canister_id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1012"></span><span>    </span><span class="annot"><span class="annottext">EntityId -&gt; m ()
forall (m :: * -&gt; *). (CanReject m, ICM m) =&gt; EntityId -&gt; m ()
</span><a href="IC.Ref.html#canisterMustExist"><span class="hs-identifier hs-var">canisterMustExist</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322319"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-1013"></span><span>
</span><span id="line-1014"></span><span>    </span><span id="local-6989586621679322317"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679322317"><span class="hs-identifier hs-var">cycles</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; m Natural
forall (m :: * -&gt; *). ICM m =&gt; Int -&gt; m Natural
</span><a href="IC.Ref.html#getCallContextCycles"><span class="hs-identifier hs-var">getCallContextCycles</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322321"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span>
</span><span id="line-1015"></span><span>    </span><span id="local-6989586621679322316"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679322316"><span class="hs-identifier hs-var">available</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; m Natural
forall (m :: * -&gt; *). ICM m =&gt; Int -&gt; m Natural
</span><a href="IC.Ref.html#getCallContextCycles"><span class="hs-identifier hs-var">getCallContextCycles</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322321"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span>
</span><span id="line-1016"></span><span>    </span><span class="annot"><span class="annottext">Int -&gt; Natural -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; Int -&gt; Natural -&gt; m ()
</span><a href="IC.Ref.html#setCallContextCycles"><span class="hs-identifier hs-var">setCallContextCycles</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322321"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679322316"><span class="hs-identifier hs-var">available</span></a></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; Natural -&gt; Natural
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679322317"><span class="hs-identifier hs-var">cycles</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1017"></span><span>    </span><span id="local-6989586621679322315"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679322315"><span class="hs-identifier hs-var">prev_balance</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; m Natural
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; m Natural
</span><a href="IC.Ref.html#getBalance"><span class="hs-identifier hs-var">getBalance</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322319"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-1018"></span><span>    </span><span class="annot"><span class="annottext">EntityId -&gt; Natural -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; Natural -&gt; m ()
</span><a href="IC.Ref.html#setBalance"><span class="hs-identifier hs-var">setBalance</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322319"><span class="hs-identifier hs-var">canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">(Natural -&gt; m ()) -&gt; Natural -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679322315"><span class="hs-identifier hs-var">prev_balance</span></a></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; Natural -&gt; Natural
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679322317"><span class="hs-identifier hs-var">cycles</span></a></span><span>
</span><span id="line-1019"></span><span>
</span><span id="line-1020"></span><span id="local-6989586621679323257"><span class="annot"><a href="IC.Ref.html#icTopUpCanister"><span class="hs-identifier hs-type">icTopUpCanister</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323257"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#CanReject"><span class="hs-identifier hs-type">CanReject</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323257"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Management.html#ICManagement"><span class="hs-identifier hs-type">ICManagement</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323257"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">.!</span></span><span> </span><span class="annot"><span class="hs-string">&quot;provisional_top_up_canister&quot;</span></span></span><span>
</span><span id="line-1021"></span><span id="icTopUpCanister"><span class="annot"><span class="annottext">icTopUpCanister :: ICManagement m .! &quot;provisional_top_up_canister&quot;
</span><a href="IC.Ref.html#icTopUpCanister"><span class="hs-identifier hs-var hs-var">icTopUpCanister</span></a></span></span><span> </span><span id="local-6989586621679322314"><span class="annot"><span class="annottext">r :: Rec ('R '[ &quot;amount&quot; ':-&gt; Natural, &quot;canister_id&quot; ':-&gt; Principal])
</span><a href="#local-6989586621679322314"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1022"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679322313"><span class="annot"><span class="annottext">canister_id :: EntityId
</span><a href="#local-6989586621679322313"><span class="hs-identifier hs-var hs-var">canister_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Principal -&gt; EntityId
</span><a href="IC.Management.html#principalToEntityId"><span class="hs-identifier hs-var">principalToEntityId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Rec ('R '[ &quot;amount&quot; ':-&gt; Natural, &quot;canister_id&quot; ':-&gt; Principal])
</span><a href="#local-6989586621679322314"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Rec ('R '[ &quot;amount&quot; ':-&gt; Natural, &quot;canister_id&quot; ':-&gt; Principal])
-&gt; Label &quot;canister_id&quot;
-&gt; 'R '[ &quot;amount&quot; ':-&gt; Natural, &quot;canister_id&quot; ':-&gt; Principal]
   .! &quot;canister_id&quot;
forall (l :: Symbol) (r :: Row *).
KnownSymbol l =&gt;
Rec r -&gt; Label l -&gt; r .! l
</span><span class="hs-operator hs-var">.!</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;canister_id&quot; (Label &quot;canister_id&quot;)
Label &quot;canister_id&quot;
</span><a href="#local-6989586621679322312"><span class="hs-var">#canister_id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1023"></span><span>    </span><span class="annot"><span class="annottext">EntityId -&gt; m ()
forall (m :: * -&gt; *). (CanReject m, ICM m) =&gt; EntityId -&gt; m ()
</span><a href="IC.Ref.html#canisterMustExist"><span class="hs-identifier hs-var">canisterMustExist</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322313"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-1024"></span><span>
</span><span id="line-1025"></span><span>    </span><span id="local-6989586621679322311"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679322311"><span class="hs-identifier hs-var">prev_balance</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; m Natural
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; m Natural
</span><a href="IC.Ref.html#getBalance"><span class="hs-identifier hs-var">getBalance</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322313"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-1026"></span><span>    </span><span class="annot"><span class="annottext">EntityId -&gt; Natural -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; Natural -&gt; m ()
</span><a href="IC.Ref.html#setBalance"><span class="hs-identifier hs-var">setBalance</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322313"><span class="hs-identifier hs-var">canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">(Natural -&gt; m ()) -&gt; Natural -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679322311"><span class="hs-identifier hs-var">prev_balance</span></a></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; Natural -&gt; Natural
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Rec ('R '[ &quot;amount&quot; ':-&gt; Natural, &quot;canister_id&quot; ':-&gt; Principal])
</span><a href="#local-6989586621679322314"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Rec ('R '[ &quot;amount&quot; ':-&gt; Natural, &quot;canister_id&quot; ':-&gt; Principal])
-&gt; Label &quot;amount&quot;
-&gt; 'R '[ &quot;amount&quot; ':-&gt; Natural, &quot;canister_id&quot; ':-&gt; Principal]
   .! &quot;amount&quot;
forall (l :: Symbol) (r :: Row *).
KnownSymbol l =&gt;
Rec r -&gt; Label l -&gt; r .! l
</span><span class="hs-operator hs-var">.!</span></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;amount&quot; (Label &quot;amount&quot;)
Label &quot;amount&quot;
</span><a href="#local-6989586621679322310"><span class="hs-var">#amount</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1027"></span><span>
</span><span id="line-1028"></span><span id="local-6989586621679323256"><span class="annot"><a href="IC.Ref.html#icRawRand"><span class="hs-identifier hs-type">icRawRand</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323256"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Management.html#ICManagement"><span class="hs-identifier hs-type">ICManagement</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323256"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">.!</span></span><span> </span><span class="annot"><span class="hs-string">&quot;raw_rand&quot;</span></span></span><span>
</span><span id="line-1029"></span><span id="icRawRand"><span class="annot"><span class="annottext">icRawRand :: ICManagement m .! &quot;raw_rand&quot;
</span><a href="IC.Ref.html#icRawRand"><span class="hs-identifier hs-var hs-var">icRawRand</span></a></span></span><span> </span><span id="local-6989586621679322309"><span class="annot"><span class="annottext">_r :: ()
</span><a href="#local-6989586621679322309"><span class="hs-identifier hs-var">_r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Rand StdGen Blob -&gt; m Blob
forall (m :: * -&gt; *) a. ICM m =&gt; Rand StdGen a -&gt; m a
</span><a href="IC.Ref.html#runRandIC"><span class="hs-identifier hs-var">runRandIC</span></a></span><span> </span><span class="annot"><span class="annottext">(Rand StdGen Blob -&gt; m Blob) -&gt; Rand StdGen Blob -&gt; m Blob
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Word8] -&gt; Blob
</span><span class="hs-identifier hs-var">BS.pack</span></span><span> </span><span class="annot"><span class="annottext">([Word8] -&gt; Blob)
-&gt; RandT StdGen Identity [Word8] -&gt; Rand StdGen Blob
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; RandT StdGen Identity Word8 -&gt; RandT StdGen Identity [Word8]
forall (m :: * -&gt; *) a. Applicative m =&gt; Int -&gt; m a -&gt; m [a]
</span><span class="hs-identifier hs-var">replicateM</span></span><span> </span><span class="annot"><span class="hs-number">32</span></span><span> </span><span class="annot"><span class="annottext">RandT StdGen Identity Word8
forall (m :: * -&gt; *) a. (MonadRandom m, Random a) =&gt; m a
</span><span class="hs-identifier hs-var">getRandom</span></span><span>
</span><span id="line-1030"></span><span>
</span><span id="line-1031"></span><span id="local-6989586621679323181"><span id="local-6989586621679323182"><span class="annot"><a href="IC.Ref.html#runRandIC"><span class="hs-identifier hs-type">runRandIC</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323182"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Rand</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">StdGen</span></span><span> </span><span class="annot"><a href="#local-6989586621679323181"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323182"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323181"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-1032"></span><span id="runRandIC"><span class="annot"><span class="annottext">runRandIC :: Rand StdGen a -&gt; m a
</span><a href="IC.Ref.html#runRandIC"><span class="hs-identifier hs-var hs-var">runRandIC</span></a></span></span><span> </span><span id="local-6989586621679322304"><span class="annot"><span class="annottext">a :: Rand StdGen a
</span><a href="#local-6989586621679322304"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(IC -&gt; (a, IC)) -&gt; m a
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; (a, s)) -&gt; m a
</span><span class="hs-identifier hs-var">state</span></span><span> </span><span class="annot"><span class="annottext">((IC -&gt; (a, IC)) -&gt; m a) -&gt; (IC -&gt; (a, IC)) -&gt; m a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679322303"><span class="annot"><span class="annottext">ic :: IC
</span><a href="#local-6989586621679322303"><span class="hs-identifier hs-var">ic</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1033"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679322302"><span class="annot"><span class="annottext">x :: a
</span><a href="#local-6989586621679322302"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679322301"><span class="annot"><span class="annottext">g :: StdGen
</span><a href="#local-6989586621679322301"><span class="hs-identifier hs-var">g</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Rand StdGen a -&gt; StdGen -&gt; (a, StdGen)
forall g a. Rand g a -&gt; g -&gt; (a, g)
</span><span class="hs-identifier hs-var">runRand</span></span><span> </span><span class="annot"><span class="annottext">Rand StdGen a
</span><a href="#local-6989586621679322304"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IC -&gt; StdGen
</span><a href="IC.Ref.html#rng"><span class="hs-identifier hs-var hs-var">rng</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679322303"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1034"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679322302"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679322303"><span class="hs-identifier hs-var">ic</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">rng :: StdGen
</span><a href="IC.Ref.html#rng"><span class="hs-identifier hs-var">rng</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StdGen
</span><a href="#local-6989586621679322301"><span class="hs-identifier hs-var">g</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1035"></span><span>
</span><span id="line-1036"></span><span id="local-6989586621679323303"><span class="annot"><a href="IC.Ref.html#invokeEntry"><span class="hs-identifier hs-type">invokeEntry</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323303"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1037"></span><span>    </span><span class="annot"><a href="IC.Ref.html#CallId"><span class="hs-identifier hs-type">CallId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Canister.html#WasmState"><span class="hs-identifier hs-type">WasmState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Canister.html#CanisterModule"><span class="hs-identifier hs-type">CanisterModule</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Ref.html#EntryPoint"><span class="hs-identifier hs-type">EntryPoint</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1038"></span><span>    </span><span class="annot"><a href="#local-6989586621679323303"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Types.html#TrapOr"><span class="hs-identifier hs-type">TrapOr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Canister.html#WasmState"><span class="hs-identifier hs-type">WasmState</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Types.html#UpdateResult"><span class="hs-identifier hs-type">UpdateResult</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-1039"></span><span id="invokeEntry"><span class="annot"><span class="annottext">invokeEntry :: Int
-&gt; WasmState
-&gt; CanisterModule
-&gt; Env
-&gt; EntryPoint
-&gt; m (TrapOr (WasmState, UpdateResult))
</span><a href="IC.Ref.html#invokeEntry"><span class="hs-identifier hs-var hs-var">invokeEntry</span></a></span></span><span> </span><span id="local-6989586621679322299"><span class="annot"><span class="annottext">ctxt_id :: Int
</span><a href="#local-6989586621679322299"><span class="hs-identifier hs-var">ctxt_id</span></a></span></span><span> </span><span id="local-6989586621679322298"><span class="annot"><span class="annottext">wasm_state :: WasmState
</span><a href="#local-6989586621679322298"><span class="hs-identifier hs-var">wasm_state</span></a></span></span><span> </span><span id="local-6989586621679322297"><span class="annot"><span class="annottext">can_mod :: CanisterModule
</span><a href="#local-6989586621679322297"><span class="hs-identifier hs-var">can_mod</span></a></span></span><span> </span><span id="local-6989586621679322296"><span class="annot"><span class="annottext">env :: Env
</span><a href="#local-6989586621679322296"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621679322295"><span class="annot"><span class="annottext">entry :: EntryPoint
</span><a href="#local-6989586621679322295"><span class="hs-identifier hs-var">entry</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1040"></span><span>    </span><span id="local-6989586621679322294"><span class="annot"><span class="annottext">Responded
</span><a href="#local-6989586621679322294"><span class="hs-identifier hs-var">responded</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; m Responded
forall (m :: * -&gt; *). ICM m =&gt; Int -&gt; m Responded
</span><a href="IC.Ref.html#respondedCallID"><span class="hs-identifier hs-var">respondedCallID</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322299"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span>
</span><span id="line-1041"></span><span>    </span><span id="local-6989586621679322293"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679322293"><span class="hs-identifier hs-var">available</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; m Natural
forall (m :: * -&gt; *). ICM m =&gt; Int -&gt; m Natural
</span><a href="IC.Ref.html#getCallContextCycles"><span class="hs-identifier hs-var">getCallContextCycles</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322299"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span>
</span><span id="line-1042"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">EntryPoint
</span><a href="#local-6989586621679322295"><span class="hs-identifier hs-var">entry</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1043"></span><span>      </span><span class="annot"><a href="IC.Ref.html#Public"><span class="hs-identifier hs-type">Public</span></a></span><span> </span><span id="local-6989586621679322292"><span class="annot"><span class="annottext">method :: String
</span><a href="#local-6989586621679322292"><span class="hs-identifier hs-var">method</span></a></span></span><span> </span><span id="local-6989586621679322291"><span class="annot"><span class="annottext">dat :: Blob
</span><a href="#local-6989586621679322291"><span class="hs-identifier hs-var">dat</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1044"></span><span>        </span><span id="local-6989586621679322290"><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322290"><span class="hs-identifier hs-var">caller</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; m EntityId
forall (m :: * -&gt; *). ICM m =&gt; Int -&gt; m EntityId
</span><a href="IC.Ref.html#callerOfCallID"><span class="hs-identifier hs-var">callerOfCallID</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322299"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span>
</span><span id="line-1045"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">String
-&gt; CanisterModule
-&gt; Maybe
     (EntityId -&gt; Env -&gt; Responded -&gt; Natural -&gt; Blob -&gt; UpdateFunc)
</span><a href="#local-6989586621679322289"><span class="hs-identifier hs-var">lookupUpdate</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679322292"><span class="hs-identifier hs-var">method</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterModule
</span><a href="#local-6989586621679322297"><span class="hs-identifier hs-var">can_mod</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1046"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679322288"><span class="annot"><span class="annottext">f :: EntityId -&gt; Env -&gt; Responded -&gt; Natural -&gt; Blob -&gt; UpdateFunc
</span><a href="#local-6989586621679322288"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TrapOr (WasmState, UpdateResult)
-&gt; m (TrapOr (WasmState, UpdateResult))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(TrapOr (WasmState, UpdateResult)
 -&gt; m (TrapOr (WasmState, UpdateResult)))
-&gt; TrapOr (WasmState, UpdateResult)
-&gt; m (TrapOr (WasmState, UpdateResult))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; Env -&gt; Responded -&gt; Natural -&gt; Blob -&gt; UpdateFunc
</span><a href="#local-6989586621679322288"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322290"><span class="hs-identifier hs-var">caller</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679322296"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Responded
</span><a href="#local-6989586621679322294"><span class="hs-identifier hs-var">responded</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679322293"><span class="hs-identifier hs-var">available</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679322291"><span class="hs-identifier hs-var">dat</span></a></span><span> </span><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679322298"><span class="hs-identifier hs-var">wasm_state</span></a></span><span>
</span><span id="line-1047"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1048"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679322287"><span class="annot"><span class="annottext">reject :: Response
</span><a href="#local-6989586621679322287"><span class="hs-identifier hs-var hs-var">reject</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(RejectCode, String) -&gt; Response
</span><a href="IC.Types.html#Reject"><span class="hs-identifier hs-var">Reject</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RejectCode
</span><a href="IC.Types.html#RC_DESTINATION_INVALID"><span class="hs-identifier hs-var">RC_DESTINATION_INVALID</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;method does not exist: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679322292"><span class="hs-identifier hs-var">method</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1049"></span><span>            </span><span class="annot"><span class="annottext">TrapOr (WasmState, UpdateResult)
-&gt; m (TrapOr (WasmState, UpdateResult))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(TrapOr (WasmState, UpdateResult)
 -&gt; m (TrapOr (WasmState, UpdateResult)))
-&gt; TrapOr (WasmState, UpdateResult)
-&gt; m (TrapOr (WasmState, UpdateResult))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(WasmState, UpdateResult) -&gt; TrapOr (WasmState, UpdateResult)
forall a. a -&gt; TrapOr a
</span><a href="IC.Types.html#Return"><span class="hs-identifier hs-var">Return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679322298"><span class="hs-identifier hs-var">wasm_state</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CallActions
</span><a href="IC.Types.html#noCallActions"><span class="hs-identifier hs-var">noCallActions</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ca_response :: Maybe Response
</span><a href="IC.Types.html#ca_response"><span class="hs-identifier hs-var">ca_response</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Response -&gt; Maybe Response
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621679322287"><span class="hs-identifier hs-var">reject</span></a></span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CanisterActions
</span><a href="IC.Types.html#noCanisterActions"><span class="hs-identifier hs-var">noCanisterActions</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1050"></span><span>      </span><span class="annot"><a href="IC.Ref.html#Closure"><span class="hs-identifier hs-type">Closure</span></a></span><span> </span><span id="local-6989586621679322284"><span class="annot"><span class="annottext">cb :: Callback
</span><a href="#local-6989586621679322284"><span class="hs-identifier hs-var">cb</span></a></span></span><span> </span><span id="local-6989586621679322283"><span class="annot"><span class="annottext">r :: Response
</span><a href="#local-6989586621679322283"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span id="local-6989586621679322282"><span class="annot"><span class="annottext">refund :: Natural
</span><a href="#local-6989586621679322282"><span class="hs-identifier hs-var">refund</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TrapOr (WasmState, UpdateResult)
-&gt; m (TrapOr (WasmState, UpdateResult))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(TrapOr (WasmState, UpdateResult)
 -&gt; m (TrapOr (WasmState, UpdateResult)))
-&gt; TrapOr (WasmState, UpdateResult)
-&gt; m (TrapOr (WasmState, UpdateResult))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1051"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CanisterModule
-&gt; Callback
-&gt; Env
-&gt; Responded
-&gt; Natural
-&gt; Response
-&gt; Natural
-&gt; UpdateFunc
</span><a href="IC.Canister.html#callbacks"><span class="hs-identifier hs-var hs-var">callbacks</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterModule
</span><a href="#local-6989586621679322297"><span class="hs-identifier hs-var">can_mod</span></a></span><span> </span><span class="annot"><span class="annottext">Callback
</span><a href="#local-6989586621679322284"><span class="hs-identifier hs-var">cb</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679322296"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Responded
</span><a href="#local-6989586621679322294"><span class="hs-identifier hs-var">responded</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679322293"><span class="hs-identifier hs-var">available</span></a></span><span> </span><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621679322283"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679322282"><span class="hs-identifier hs-var">refund</span></a></span><span> </span><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679322298"><span class="hs-identifier hs-var">wasm_state</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1052"></span><span>            </span><span class="annot"><a href="IC.Types.html#Trap"><span class="hs-identifier hs-type">Trap</span></a></span><span> </span><span id="local-6989586621679322280"><span class="annot"><span class="annottext">err :: String
</span><a href="#local-6989586621679322280"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Callback -&gt; Maybe WasmClosure
</span><a href="IC.Types.html#cleanup_callback"><span class="hs-identifier hs-var hs-var">cleanup_callback</span></a></span><span> </span><span class="annot"><span class="annottext">Callback
</span><a href="#local-6989586621679322284"><span class="hs-identifier hs-var">cb</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1053"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679322278"><span class="annot"><span class="annottext">closure :: WasmClosure
</span><a href="#local-6989586621679322278"><span class="hs-identifier hs-var">closure</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CanisterModule
-&gt; WasmClosure -&gt; Env -&gt; WasmState -&gt; TrapOr (WasmState, ())
</span><a href="IC.Canister.html#cleanup"><span class="hs-identifier hs-var hs-var">cleanup</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterModule
</span><a href="#local-6989586621679322297"><span class="hs-identifier hs-var">can_mod</span></a></span><span> </span><span class="annot"><span class="annottext">WasmClosure
</span><a href="#local-6989586621679322278"><span class="hs-identifier hs-var">closure</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679322296"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679322298"><span class="hs-identifier hs-var">wasm_state</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1054"></span><span>                    </span><span class="annot"><a href="IC.Types.html#Trap"><span class="hs-identifier hs-type">Trap</span></a></span><span> </span><span id="local-6989586621679322276"><span class="annot"><span class="annottext">err' :: String
</span><a href="#local-6989586621679322276"><span class="hs-identifier hs-var">err'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; TrapOr (WasmState, UpdateResult)
forall a. String -&gt; TrapOr a
</span><a href="IC.Types.html#Trap"><span class="hs-identifier hs-var">Trap</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679322276"><span class="hs-identifier hs-var">err'</span></a></span><span>
</span><span id="line-1055"></span><span>                    </span><span class="annot"><a href="IC.Types.html#Return"><span class="hs-identifier hs-type">Return</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679322275"><span class="annot"><span class="annottext">wasm_state' :: WasmState
</span><a href="#local-6989586621679322275"><span class="hs-identifier hs-var">wasm_state'</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1056"></span><span>                        </span><span class="annot"><span class="annottext">(WasmState, UpdateResult) -&gt; TrapOr (WasmState, UpdateResult)
forall a. a -&gt; TrapOr a
</span><a href="IC.Types.html#Return"><span class="hs-identifier hs-var">Return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679322275"><span class="hs-identifier hs-var">wasm_state'</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CallActions
</span><a href="IC.Types.html#noCallActions"><span class="hs-identifier hs-var">noCallActions</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CanisterActions
</span><a href="IC.Types.html#noCanisterActions"><span class="hs-identifier hs-var">noCanisterActions</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1057"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; TrapOr (WasmState, UpdateResult)
forall a. String -&gt; TrapOr a
</span><a href="IC.Types.html#Trap"><span class="hs-identifier hs-var">Trap</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679322280"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-1058"></span><span>            </span><span class="annot"><a href="IC.Types.html#Return"><span class="hs-identifier hs-type">Return</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679322274"><span class="annot"><span class="annottext">wasm_state :: WasmState
</span><a href="#local-6989586621679322274"><span class="hs-identifier hs-var">wasm_state</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679322273"><span class="annot"><span class="annottext">actions :: UpdateResult
</span><a href="#local-6989586621679322273"><span class="hs-identifier hs-var">actions</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(WasmState, UpdateResult) -&gt; TrapOr (WasmState, UpdateResult)
forall a. a -&gt; TrapOr a
</span><a href="IC.Types.html#Return"><span class="hs-identifier hs-var">Return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679322274"><span class="hs-identifier hs-var">wasm_state</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">UpdateResult
</span><a href="#local-6989586621679322273"><span class="hs-identifier hs-var">actions</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1059"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1060"></span><span>    </span><span id="local-6989586621679322289"><span class="annot"><span class="annottext">lookupUpdate :: String
-&gt; CanisterModule
-&gt; Maybe
     (EntityId -&gt; Env -&gt; Responded -&gt; Natural -&gt; Blob -&gt; UpdateFunc)
</span><a href="#local-6989586621679322289"><span class="hs-identifier hs-var hs-var">lookupUpdate</span></a></span></span><span> </span><span id="local-6989586621679322272"><span class="annot"><span class="annottext">method :: String
</span><a href="#local-6989586621679322272"><span class="hs-identifier hs-var">method</span></a></span></span><span> </span><span id="local-6989586621679322271"><span class="annot"><span class="annottext">can_mod :: CanisterModule
</span><a href="#local-6989586621679322271"><span class="hs-identifier hs-var">can_mod</span></a></span></span><span>
</span><span id="line-1061"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679322270"><span class="annot"><span class="annottext">f :: EntityId -&gt; Env -&gt; Responded -&gt; Natural -&gt; Blob -&gt; UpdateFunc
</span><a href="#local-6989586621679322270"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String
-&gt; Map
     String
     (EntityId -&gt; Env -&gt; Responded -&gt; Natural -&gt; Blob -&gt; UpdateFunc)
-&gt; Maybe
     (EntityId -&gt; Env -&gt; Responded -&gt; Natural -&gt; Blob -&gt; UpdateFunc)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679322272"><span class="hs-identifier hs-var">method</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CanisterModule
-&gt; Map
     String
     (EntityId -&gt; Env -&gt; Responded -&gt; Natural -&gt; Blob -&gt; UpdateFunc)
</span><a href="IC.Canister.html#update_methods"><span class="hs-identifier hs-var hs-var">update_methods</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterModule
</span><a href="#local-6989586621679322271"><span class="hs-identifier hs-var">can_mod</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(EntityId -&gt; Env -&gt; Responded -&gt; Natural -&gt; Blob -&gt; UpdateFunc)
-&gt; Maybe
     (EntityId -&gt; Env -&gt; Responded -&gt; Natural -&gt; Blob -&gt; UpdateFunc)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; Env -&gt; Responded -&gt; Natural -&gt; Blob -&gt; UpdateFunc
</span><a href="#local-6989586621679322270"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-1062"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679322268"><span class="annot"><span class="annottext">f :: EntityId -&gt; Env -&gt; Blob -&gt; QueryFunc
</span><a href="#local-6989586621679322268"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String
-&gt; Map String (EntityId -&gt; Env -&gt; Blob -&gt; QueryFunc)
-&gt; Maybe (EntityId -&gt; Env -&gt; Blob -&gt; QueryFunc)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679322272"><span class="hs-identifier hs-var">method</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CanisterModule -&gt; Map String (EntityId -&gt; Env -&gt; Blob -&gt; QueryFunc)
</span><a href="IC.Canister.html#query_methods"><span class="hs-identifier hs-var hs-var">query_methods</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterModule
</span><a href="#local-6989586621679322271"><span class="hs-identifier hs-var">can_mod</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(EntityId -&gt; Env -&gt; Responded -&gt; Natural -&gt; Blob -&gt; UpdateFunc)
-&gt; Maybe
     (EntityId -&gt; Env -&gt; Responded -&gt; Natural -&gt; Blob -&gt; UpdateFunc)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(EntityId -&gt; Env -&gt; Blob -&gt; QueryFunc)
-&gt; EntityId -&gt; Env -&gt; Responded -&gt; Natural -&gt; Blob -&gt; UpdateFunc
</span><a href="IC.Canister.html#asUpdate"><span class="hs-identifier hs-var">asUpdate</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; Env -&gt; Blob -&gt; QueryFunc
</span><a href="#local-6989586621679322268"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1063"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe
  (EntityId -&gt; Env -&gt; Responded -&gt; Natural -&gt; Blob -&gt; UpdateFunc)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1064"></span><span>
</span><span id="line-1065"></span><span id="local-6989586621679323286"><span class="annot"><a href="IC.Ref.html#newCall"><span class="hs-identifier hs-type">newCall</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323286"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Ref.html#CallId"><span class="hs-identifier hs-type">CallId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#MethodCall"><span class="hs-identifier hs-type">MethodCall</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323286"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-1066"></span><span id="newCall"><span class="annot"><span class="annottext">newCall :: Int -&gt; MethodCall -&gt; m ()
</span><a href="IC.Ref.html#newCall"><span class="hs-identifier hs-var hs-var">newCall</span></a></span></span><span> </span><span id="local-6989586621679322266"><span class="annot"><span class="annottext">from_ctxt_id :: Int
</span><a href="#local-6989586621679322266"><span class="hs-identifier hs-var">from_ctxt_id</span></a></span></span><span> </span><span id="local-6989586621679322265"><span class="annot"><span class="annottext">call :: MethodCall
</span><a href="#local-6989586621679322265"><span class="hs-identifier hs-var">call</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1067"></span><span>  </span><span id="local-6989586621679322264"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322264"><span class="hs-identifier hs-var">new_ctxt_id</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CallContext -&gt; m Int
forall (m :: * -&gt; *). ICM m =&gt; CallContext -&gt; m Int
</span><a href="IC.Ref.html#newCallContext"><span class="hs-identifier hs-var">newCallContext</span></a></span><span> </span><span class="annot"><span class="annottext">(CallContext -&gt; m Int) -&gt; CallContext -&gt; m Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CallContext :: EntityId
-&gt; CallOrigin
-&gt; Responded
-&gt; Bool
-&gt; Natural
-&gt; Maybe String
-&gt; CallContext
</span><a href="IC.Ref.html#CallContext"><span class="hs-identifier hs-type hs-type">CallContext</span></a></span><span>
</span><span id="line-1068"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">canister :: EntityId
</span><a href="IC.Ref.html#canister"><span class="hs-identifier hs-var">canister</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MethodCall -&gt; EntityId
</span><a href="IC.Types.html#call_callee"><span class="hs-identifier hs-var hs-var">call_callee</span></a></span><span> </span><span class="annot"><span class="annottext">MethodCall
</span><a href="#local-6989586621679322265"><span class="hs-identifier hs-var">call</span></a></span><span>
</span><span id="line-1069"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">origin :: CallOrigin
</span><a href="IC.Ref.html#origin"><span class="hs-identifier hs-var">origin</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Callback -&gt; CallOrigin
</span><a href="IC.Ref.html#FromCanister"><span class="hs-identifier hs-var">FromCanister</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322266"><span class="hs-identifier hs-var">from_ctxt_id</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MethodCall -&gt; Callback
</span><a href="IC.Types.html#call_callback"><span class="hs-identifier hs-var hs-var">call_callback</span></a></span><span> </span><span class="annot"><span class="annottext">MethodCall
</span><a href="#local-6989586621679322265"><span class="hs-identifier hs-var">call</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1070"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">responded :: Responded
</span><a href="IC.Ref.html#responded"><span class="hs-identifier hs-var">responded</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Responded
</span><a href="IC.Types.html#Responded"><span class="hs-identifier hs-var">Responded</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1071"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">deleted :: Bool
</span><a href="IC.Ref.html#deleted"><span class="hs-identifier hs-var">deleted</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1072"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">last_trap :: Maybe String
</span><a href="IC.Ref.html#last_trap"><span class="hs-identifier hs-var">last_trap</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe String
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1073"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">available_cycles :: Natural
</span><a href="IC.Ref.html#available_cycles"><span class="hs-identifier hs-var">available_cycles</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MethodCall -&gt; Natural
</span><a href="IC.Types.html#call_transferred_cycles"><span class="hs-identifier hs-var hs-var">call_transferred_cycles</span></a></span><span> </span><span class="annot"><span class="annottext">MethodCall
</span><a href="#local-6989586621679322265"><span class="hs-identifier hs-var">call</span></a></span><span>
</span><span id="line-1074"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-1075"></span><span>  </span><span class="annot"><span class="annottext">Message -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; Message -&gt; m ()
</span><a href="IC.Ref.html#enqueueMessage"><span class="hs-identifier hs-var">enqueueMessage</span></a></span><span> </span><span class="annot"><span class="annottext">(Message -&gt; m ()) -&gt; Message -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CallMessage :: Int -&gt; EntryPoint -&gt; Message
</span><a href="IC.Ref.html#CallMessage"><span class="hs-identifier hs-type hs-type">CallMessage</span></a></span><span>
</span><span id="line-1076"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">call_context :: Int
</span><a href="IC.Ref.html#call_context"><span class="hs-identifier hs-var">call_context</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322264"><span class="hs-identifier hs-var">new_ctxt_id</span></a></span><span>
</span><span id="line-1077"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">entry :: EntryPoint
</span><a href="IC.Ref.html#entry"><span class="hs-identifier hs-var">entry</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Blob -&gt; EntryPoint
</span><a href="IC.Ref.html#Public"><span class="hs-identifier hs-var">Public</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MethodCall -&gt; String
</span><a href="IC.Types.html#call_method_name"><span class="hs-identifier hs-var hs-var">call_method_name</span></a></span><span> </span><span class="annot"><span class="annottext">MethodCall
</span><a href="#local-6989586621679322265"><span class="hs-identifier hs-var">call</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MethodCall -&gt; Blob
</span><a href="IC.Types.html#call_arg"><span class="hs-identifier hs-var hs-var">call_arg</span></a></span><span> </span><span class="annot"><span class="annottext">MethodCall
</span><a href="#local-6989586621679322265"><span class="hs-identifier hs-var">call</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1078"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-1079"></span><span>
</span><span id="line-1080"></span><span class="hs-comment">-- Scheduling</span><span>
</span><span id="line-1081"></span><span>
</span><span id="line-1082"></span><span class="hs-comment">-- | Pick next request in state `received`</span><span>
</span><span id="line-1083"></span><span id="local-6989586621679323143"><span class="annot"><a href="IC.Ref.html#nextReceived"><span class="hs-identifier hs-type">nextReceived</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323143"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323143"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Types.html#RequestID"><span class="hs-identifier hs-type">RequestID</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#CallRequest"><span class="hs-identifier hs-type">CallRequest</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-1084"></span><span id="nextReceived"><span class="annot"><span class="annottext">nextReceived :: m (Maybe (Blob, CallRequest))
</span><a href="IC.Ref.html#nextReceived"><span class="hs-identifier hs-var hs-var">nextReceived</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(IC -&gt; Maybe (Blob, CallRequest)) -&gt; m (Maybe (Blob, CallRequest))
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">((IC -&gt; Maybe (Blob, CallRequest))
 -&gt; m (Maybe (Blob, CallRequest)))
-&gt; (IC -&gt; Maybe (Blob, CallRequest))
-&gt; m (Maybe (Blob, CallRequest))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679322258"><span class="annot"><span class="annottext">ic :: IC
</span><a href="#local-6989586621679322258"><span class="hs-identifier hs-var">ic</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[(Blob, CallRequest)] -&gt; Maybe (Blob, CallRequest)
forall a. [a] -&gt; Maybe a
</span><span class="hs-identifier hs-var">listToMaybe</span></span><span>
</span><span id="line-1085"></span><span>  </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679322256"><span class="hs-identifier hs-var">rid</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">CallRequest
</span><a href="#local-6989586621679322255"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679322256"><span class="annot"><span class="annottext">rid :: Blob
</span><a href="#local-6989586621679322256"><span class="hs-identifier hs-var">rid</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679322255"><span class="annot"><span class="annottext">r :: CallRequest
</span><a href="#local-6989586621679322255"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#Received"><span class="hs-identifier hs-type">Received</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Blob &#8614; (CallRequest, RequestStatus))
-&gt; [(Blob, (CallRequest, RequestStatus))]
forall k a. Map k a -&gt; [(k, a)]
</span><span class="hs-identifier hs-var">M.toList</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IC -&gt; Blob &#8614; (CallRequest, RequestStatus)
</span><a href="IC.Ref.html#requests"><span class="hs-identifier hs-var hs-var">requests</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679322258"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-1086"></span><span>
</span><span id="line-1087"></span><span class="hs-comment">-- A call context is still waiting for a response if&#8230;</span><span>
</span><span id="line-1088"></span><span class="annot"><a href="IC.Ref.html#willReceiveResponse"><span class="hs-identifier hs-type">willReceiveResponse</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#IC"><span class="hs-identifier hs-type">IC</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Ref.html#CallId"><span class="hs-identifier hs-type">CallId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1089"></span><span id="willReceiveResponse"><span class="annot"><span class="annottext">willReceiveResponse :: IC -&gt; Int -&gt; Bool
</span><a href="IC.Ref.html#willReceiveResponse"><span class="hs-identifier hs-var hs-var">willReceiveResponse</span></a></span></span><span> </span><span id="local-6989586621679322253"><span class="annot"><span class="annottext">ic :: IC
</span><a href="#local-6989586621679322253"><span class="hs-identifier hs-var">ic</span></a></span></span><span> </span><span id="local-6989586621679322252"><span class="annot"><span class="annottext">c :: Int
</span><a href="#local-6989586621679322252"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322252"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Int] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span>
</span><span id="line-1090"></span><span>  </span><span class="hs-comment">-- there is another call context promising to respond to this</span><span>
</span><span id="line-1091"></span><span>  </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322251"><span class="hs-identifier hs-var">c'</span></a></span><span>
</span><span id="line-1092"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="IC.Ref.html#CallContext"><span class="hs-identifier hs-type">CallContext</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">responded :: CallContext -&gt; Responded
</span><a href="IC.Ref.html#responded"><span class="hs-identifier hs-var">responded</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="IC.Types.html#Responded"><span class="hs-identifier hs-type">Responded</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">False</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">deleted :: CallContext -&gt; Bool
</span><a href="IC.Ref.html#deleted"><span class="hs-identifier hs-var">deleted</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">origin :: CallContext -&gt; CallOrigin
</span><a href="IC.Ref.html#origin"><span class="hs-identifier hs-var">origin</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="IC.Ref.html#FromCanister"><span class="hs-identifier hs-type">FromCanister</span></a></span><span> </span><span id="local-6989586621679322251"><span class="annot"><span class="annottext">c' :: Int
</span><a href="#local-6989586621679322251"><span class="hs-identifier hs-var">c'</span></a></span></span><span> </span><span class="hs-identifier">_</span><span class="hs-special">}</span><span>
</span><span id="line-1093"></span><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Int &#8614; CallContext) -&gt; [CallContext]
forall k a. Map k a -&gt; [a]
</span><span class="hs-identifier hs-var">M.elems</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IC -&gt; Int &#8614; CallContext
</span><a href="IC.Ref.html#call_contexts"><span class="hs-identifier hs-var hs-var">call_contexts</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679322253"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1094"></span><span>  </span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; [Int] -&gt; [Int]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span>
</span><span id="line-1095"></span><span>  </span><span class="hs-comment">-- there is an in-flight call or response message:</span><span>
</span><span id="line-1096"></span><span>  </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Message -&gt; Int
</span><a href="IC.Ref.html#call_context"><span class="hs-identifier hs-var hs-var">call_context</span></a></span><span> </span><span class="annot"><span class="annottext">Message
</span><a href="#local-6989586621679322249"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621679322249"><span class="annot"><span class="annottext">Message
</span><a href="#local-6989586621679322249"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Seq Message -&gt; [Message]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><span class="hs-identifier hs-var">toList</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IC -&gt; Seq Message
</span><a href="IC.Ref.html#messages"><span class="hs-identifier hs-var hs-var">messages</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679322253"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; [Int] -&gt; [Int]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span>
</span><span id="line-1097"></span><span>  </span><span class="hs-comment">-- there this canister is waiting for some canister to stop</span><span>
</span><span id="line-1098"></span><span>  </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322248"><span class="hs-identifier hs-var">c'</span></a></span><span>
</span><span id="line-1099"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="IC.Ref.html#CanState"><span class="hs-identifier hs-type">CanState</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">run_status :: CanState -&gt; RunStatus
</span><a href="IC.Ref.html#run_status"><span class="hs-identifier hs-var">run_status</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="IC.Ref.html#IsStopping"><span class="hs-identifier hs-type">IsStopping</span></a></span><span> </span><span id="local-6989586621679322247"><span class="annot"><span class="annottext">pending :: [Int]
</span><a href="#local-6989586621679322247"><span class="hs-identifier hs-var">pending</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(EntityId &#8614; CanState) -&gt; [CanState]
forall k a. Map k a -&gt; [a]
</span><span class="hs-identifier hs-var">M.elems</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IC -&gt; EntityId &#8614; CanState
</span><a href="IC.Ref.html#canisters"><span class="hs-identifier hs-var hs-var">canisters</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679322253"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1100"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679322248"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322248"><span class="hs-identifier hs-var">c'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621679322247"><span class="hs-identifier hs-var">pending</span></a></span><span>
</span><span id="line-1101"></span><span>  </span><span class="hs-special">]</span><span>
</span><span id="line-1102"></span><span>  </span><span class="hs-comment">-- NB: this could be implemented more efficient if kepts a counter of</span><span>
</span><span id="line-1103"></span><span>  </span><span class="hs-comment">-- outstanding calls in each call context</span><span>
</span><span id="line-1104"></span><span>
</span><span id="line-1105"></span><span class="hs-comment">-- | Find a starved call context</span><span>
</span><span id="line-1106"></span><span id="local-6989586621679323140"><span class="annot"><a href="IC.Ref.html#nextStarved"><span class="hs-identifier hs-type">nextStarved</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323140"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323140"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="IC.Ref.html#CallId"><span class="hs-identifier hs-type">CallId</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-1107"></span><span id="nextStarved"><span class="annot"><span class="annottext">nextStarved :: m (Maybe Int)
</span><a href="IC.Ref.html#nextStarved"><span class="hs-identifier hs-var hs-var">nextStarved</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(IC -&gt; Maybe Int) -&gt; m (Maybe Int)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">((IC -&gt; Maybe Int) -&gt; m (Maybe Int))
-&gt; (IC -&gt; Maybe Int) -&gt; m (Maybe Int)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679322245"><span class="annot"><span class="annottext">ic :: IC
</span><a href="#local-6989586621679322245"><span class="hs-identifier hs-var">ic</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; Maybe Int
forall a. [a] -&gt; Maybe a
</span><span class="hs-identifier hs-var">listToMaybe</span></span><span>
</span><span id="line-1108"></span><span>  </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322244"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-1109"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679322244"><span class="annot"><span class="annottext">c :: Int
</span><a href="#local-6989586621679322244"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#CallContext"><span class="hs-identifier hs-type">CallContext</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">responded :: CallContext -&gt; Responded
</span><a href="IC.Ref.html#responded"><span class="hs-identifier hs-var">responded</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="IC.Types.html#Responded"><span class="hs-identifier hs-type">Responded</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">False</span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Int &#8614; CallContext) -&gt; [(Int, CallContext)]
forall k a. Map k a -&gt; [(k, a)]
</span><span class="hs-identifier hs-var">M.toList</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IC -&gt; Int &#8614; CallContext
</span><a href="IC.Ref.html#call_contexts"><span class="hs-identifier hs-var hs-var">call_contexts</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679322245"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1110"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IC -&gt; Int -&gt; Bool
</span><a href="IC.Ref.html#willReceiveResponse"><span class="hs-identifier hs-var">willReceiveResponse</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679322245"><span class="hs-identifier hs-var">ic</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322244"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-1111"></span><span>  </span><span class="hs-special">]</span><span>
</span><span id="line-1112"></span><span>
</span><span id="line-1113"></span><span class="hs-comment">-- | Find a canister in stopping state that is, well, stopped</span><span>
</span><span id="line-1114"></span><span id="local-6989586621679323139"><span class="annot"><a href="IC.Ref.html#nextStoppedCanister"><span class="hs-identifier hs-type">nextStoppedCanister</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323139"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323139"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-1115"></span><span id="nextStoppedCanister"><span class="annot"><span class="annottext">nextStoppedCanister :: m (Maybe EntityId)
</span><a href="IC.Ref.html#nextStoppedCanister"><span class="hs-identifier hs-var hs-var">nextStoppedCanister</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(IC -&gt; Maybe EntityId) -&gt; m (Maybe EntityId)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">((IC -&gt; Maybe EntityId) -&gt; m (Maybe EntityId))
-&gt; (IC -&gt; Maybe EntityId) -&gt; m (Maybe EntityId)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679322241"><span class="annot"><span class="annottext">ic :: IC
</span><a href="#local-6989586621679322241"><span class="hs-identifier hs-var">ic</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[EntityId] -&gt; Maybe EntityId
forall a. [a] -&gt; Maybe a
</span><span class="hs-identifier hs-var">listToMaybe</span></span><span>
</span><span id="line-1116"></span><span>  </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322240"><span class="hs-identifier hs-var">cid</span></a></span><span>
</span><span id="line-1117"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679322240"><span class="annot"><span class="annottext">cid :: EntityId
</span><a href="#local-6989586621679322240"><span class="hs-identifier hs-var">cid</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#CanState"><span class="hs-identifier hs-type">CanState</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">run_status :: CanState -&gt; RunStatus
</span><a href="IC.Ref.html#run_status"><span class="hs-identifier hs-var">run_status</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="IC.Ref.html#IsStopping"><span class="hs-identifier hs-type">IsStopping</span></a></span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(EntityId &#8614; CanState) -&gt; [(EntityId, CanState)]
forall k a. Map k a -&gt; [(k, a)]
</span><span class="hs-identifier hs-var">M.toList</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IC -&gt; EntityId &#8614; CanState
</span><a href="IC.Ref.html#canisters"><span class="hs-identifier hs-var hs-var">canisters</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679322241"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1118"></span><span>  </span><span class="hs-comment">-- no call context still waiting for a response</span><span>
</span><span id="line-1119"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[()] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1120"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679322238"><span class="annot"><span class="annottext">c :: Int
</span><a href="#local-6989586621679322238"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679322237"><span class="annot"><span class="annottext">ctxt :: CallContext
</span><a href="#local-6989586621679322237"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Int &#8614; CallContext) -&gt; [(Int, CallContext)]
forall k a. Map k a -&gt; [(k, a)]
</span><span class="hs-identifier hs-var">M.toList</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IC -&gt; Int &#8614; CallContext
</span><a href="IC.Ref.html#call_contexts"><span class="hs-identifier hs-var hs-var">call_contexts</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679322241"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1121"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CallContext -&gt; EntityId
</span><a href="IC.Ref.html#canister"><span class="hs-identifier hs-var hs-var">canister</span></a></span><span> </span><span class="annot"><span class="annottext">CallContext
</span><a href="#local-6989586621679322237"><span class="hs-identifier hs-var">ctxt</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; EntityId -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">EntityId
</span><a href="#local-6989586621679322240"><span class="hs-identifier hs-var">cid</span></a></span><span>
</span><span id="line-1122"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CallContext -&gt; Bool
</span><a href="IC.Ref.html#deleted"><span class="hs-identifier hs-var hs-var">deleted</span></a></span><span> </span><span class="annot"><span class="annottext">CallContext
</span><a href="#local-6989586621679322237"><span class="hs-identifier hs-var">ctxt</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1123"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IC -&gt; Int -&gt; Bool
</span><a href="IC.Ref.html#willReceiveResponse"><span class="hs-identifier hs-var">willReceiveResponse</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679322241"><span class="hs-identifier hs-var">ic</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679322238"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-1124"></span><span>    </span><span class="hs-special">]</span><span>
</span><span id="line-1125"></span><span>  </span><span class="hs-special">]</span><span>
</span><span id="line-1126"></span><span>
</span><span id="line-1127"></span><span>
</span><span id="line-1128"></span><span class="hs-comment">-- | Pick (and remove) next message from queue</span><span>
</span><span id="line-1129"></span><span id="local-6989586621679323141"><span class="annot"><a href="IC.Ref.html#popMessage"><span class="hs-identifier hs-type">popMessage</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323141"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323141"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="IC.Ref.html#Message"><span class="hs-identifier hs-type">Message</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-1130"></span><span id="popMessage"><span class="annot"><span class="annottext">popMessage :: m (Maybe Message)
</span><a href="IC.Ref.html#popMessage"><span class="hs-identifier hs-var hs-var">popMessage</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(IC -&gt; (Maybe Message, IC)) -&gt; m (Maybe Message)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; (a, s)) -&gt; m a
</span><span class="hs-identifier hs-var">state</span></span><span> </span><span class="annot"><span class="annottext">((IC -&gt; (Maybe Message, IC)) -&gt; m (Maybe Message))
-&gt; (IC -&gt; (Maybe Message, IC)) -&gt; m (Maybe Message)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679322235"><span class="annot"><span class="annottext">ic :: IC
</span><a href="#local-6989586621679322235"><span class="hs-identifier hs-var">ic</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1131"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">IC -&gt; Seq Message
</span><a href="IC.Ref.html#messages"><span class="hs-identifier hs-var hs-var">messages</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679322235"><span class="hs-identifier hs-var">ic</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1132"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Empty</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe Message
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679322235"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1133"></span><span>    </span><span id="local-6989586621679322233"><span class="annot"><span class="annottext">m :: Message
</span><a href="#local-6989586621679322233"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="annot"><span class="hs-operator hs-type">:&lt;|</span></span><span> </span><span id="local-6989586621679322231"><span class="annot"><span class="annottext">ms :: Seq Message
</span><a href="#local-6989586621679322231"><span class="hs-identifier hs-var">ms</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Message -&gt; Maybe Message
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Message
</span><a href="#local-6989586621679322233"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679322235"><span class="hs-identifier hs-var">ic</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">messages :: Seq Message
</span><a href="IC.Ref.html#messages"><span class="hs-identifier hs-var">messages</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Seq Message
</span><a href="#local-6989586621679322231"><span class="hs-identifier hs-var">ms</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1134"></span><span>
</span><span id="line-1135"></span><span>
</span><span id="line-1136"></span><span class="hs-comment">-- | Fake time increase</span><span>
</span><span id="line-1137"></span><span id="local-6989586621679323147"><span class="annot"><a href="IC.Ref.html#bumpTime"><span class="hs-identifier hs-type">bumpTime</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323147"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323147"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-1138"></span><span id="bumpTime"><span class="annot"><span class="annottext">bumpTime :: m ()
</span><a href="IC.Ref.html#bumpTime"><span class="hs-identifier hs-var hs-var">bumpTime</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(IC -&gt; IC) -&gt; m ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((IC -&gt; IC) -&gt; m ()) -&gt; (IC -&gt; IC) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1139"></span><span>  </span><span class="hs-glyph">\</span><span id="local-6989586621679322229"><span class="annot"><span class="annottext">ic :: IC
</span><a href="#local-6989586621679322229"><span class="hs-identifier hs-var">ic</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679322229"><span class="hs-identifier hs-var">ic</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">canisters :: EntityId &#8614; CanState
</span><a href="IC.Ref.html#canisters"><span class="hs-identifier hs-var">canisters</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CanState -&gt; CanState)
-&gt; (EntityId &#8614; CanState) -&gt; EntityId &#8614; CanState
forall a b k. (a -&gt; b) -&gt; Map k a -&gt; Map k b
</span><span class="hs-identifier hs-var">M.map</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679322227"><span class="annot"><span class="annottext">cs :: CanState
</span><a href="#local-6989586621679322227"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CanState
</span><a href="#local-6989586621679322227"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">time :: Timestamp
</span><a href="IC.Ref.html#time"><span class="hs-identifier hs-var">time</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CanState -&gt; Timestamp
</span><a href="IC.Ref.html#time"><span class="hs-identifier hs-var hs-var">time</span></a></span><span> </span><span class="annot"><span class="annottext">CanState
</span><a href="#local-6989586621679322227"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="annot"><span class="annottext">Timestamp -&gt; Timestamp -&gt; Timestamp
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span class="annot"><span class="hs-number">1</span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IC -&gt; EntityId &#8614; CanState
</span><a href="IC.Ref.html#canisters"><span class="hs-identifier hs-var hs-var">canisters</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679322229"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1140"></span><span>
</span><span id="line-1141"></span><span id="local-6989586621679322226"><span class="annot"><a href="IC.Ref.html#setAllTimesTo"><span class="hs-identifier hs-type">setAllTimesTo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679322226"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#Timestamp"><span class="hs-identifier hs-type">Timestamp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679322226"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-1142"></span><span id="setAllTimesTo"><span class="annot"><span class="annottext">setAllTimesTo :: Timestamp -&gt; m ()
</span><a href="IC.Ref.html#setAllTimesTo"><span class="hs-identifier hs-var hs-var">setAllTimesTo</span></a></span></span><span> </span><span id="local-6989586621679322225"><span class="annot"><span class="annottext">ts :: Timestamp
</span><a href="#local-6989586621679322225"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(IC -&gt; IC) -&gt; m ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((IC -&gt; IC) -&gt; m ()) -&gt; (IC -&gt; IC) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1143"></span><span>  </span><span class="hs-glyph">\</span><span id="local-6989586621679322224"><span class="annot"><span class="annottext">ic :: IC
</span><a href="#local-6989586621679322224"><span class="hs-identifier hs-var">ic</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679322224"><span class="hs-identifier hs-var">ic</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">canisters :: EntityId &#8614; CanState
</span><a href="IC.Ref.html#canisters"><span class="hs-identifier hs-var">canisters</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CanState -&gt; CanState)
-&gt; (EntityId &#8614; CanState) -&gt; EntityId &#8614; CanState
forall a b k. (a -&gt; b) -&gt; Map k a -&gt; Map k b
</span><span class="hs-identifier hs-var">M.map</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679322223"><span class="annot"><span class="annottext">cs :: CanState
</span><a href="#local-6989586621679322223"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CanState
</span><a href="#local-6989586621679322223"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">time :: Timestamp
</span><a href="IC.Ref.html#time"><span class="hs-identifier hs-var">time</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Timestamp
</span><a href="#local-6989586621679322225"><span class="hs-identifier hs-var">ts</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IC -&gt; EntityId &#8614; CanState
</span><a href="IC.Ref.html#canisters"><span class="hs-identifier hs-var hs-var">canisters</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679322224"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1144"></span><span>
</span><span id="line-1145"></span><span>
</span><span id="line-1146"></span><span class="hs-comment">-- | Returns true if a step was taken</span><span>
</span><span id="line-1147"></span><span id="local-6989586621679323129"><span class="annot"><a href="IC.Ref.html#runStep"><span class="hs-identifier hs-type">runStep</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323129"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323129"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span></span><span>
</span><span id="line-1148"></span><span id="runStep"><span class="annot"><span class="annottext">runStep :: m Bool
</span><a href="IC.Ref.html#runStep"><span class="hs-identifier hs-var hs-var">runStep</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1149"></span><span>  </span><span class="annot"><span class="annottext">m ()
forall (m :: * -&gt; *). ICM m =&gt; m ()
</span><a href="IC.Ref.html#bumpTime"><span class="hs-identifier hs-var">bumpTime</span></a></span><span>
</span><span id="line-1150"></span><span>  </span><span class="annot"><span class="annottext">[m Bool] -&gt; m Bool
</span><a href="#local-6989586621679322222"><span class="hs-identifier hs-var">try</span></a></span><span>
</span><span id="line-1151"></span><span>    </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">m (Maybe (Blob, CallRequest))
-&gt; ((Blob, CallRequest) -&gt; m ()) -&gt; m Bool
forall (m :: * -&gt; *) t a.
Monad m =&gt;
m (Maybe t) -&gt; (t -&gt; m a) -&gt; m Bool
</span><a href="#local-6989586621679322221"><span class="hs-identifier hs-var">with</span></a></span><span> </span><span class="annot"><span class="annottext">m (Maybe (Blob, CallRequest))
forall (m :: * -&gt; *). ICM m =&gt; m (Maybe (Blob, CallRequest))
</span><a href="IC.Ref.html#nextReceived"><span class="hs-identifier hs-var">nextReceived</span></a></span><span> </span><span class="annot"><span class="annottext">(Blob, CallRequest) -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; (Blob, CallRequest) -&gt; m ()
</span><a href="IC.Ref.html#processRequest"><span class="hs-identifier hs-var">processRequest</span></a></span><span>
</span><span id="line-1152"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">m (Maybe Message) -&gt; (Message -&gt; m ()) -&gt; m Bool
forall (m :: * -&gt; *) t a.
Monad m =&gt;
m (Maybe t) -&gt; (t -&gt; m a) -&gt; m Bool
</span><a href="#local-6989586621679322221"><span class="hs-identifier hs-var">with</span></a></span><span> </span><span class="annot"><span class="annottext">m (Maybe Message)
forall (m :: * -&gt; *). ICM m =&gt; m (Maybe Message)
</span><a href="IC.Ref.html#popMessage"><span class="hs-identifier hs-var">popMessage</span></a></span><span> </span><span class="annot"><span class="annottext">Message -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; Message -&gt; m ()
</span><a href="IC.Ref.html#processMessage"><span class="hs-identifier hs-var">processMessage</span></a></span><span>
</span><span id="line-1153"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">m (Maybe Int) -&gt; (Int -&gt; m ()) -&gt; m Bool
forall (m :: * -&gt; *) t a.
Monad m =&gt;
m (Maybe t) -&gt; (t -&gt; m a) -&gt; m Bool
</span><a href="#local-6989586621679322221"><span class="hs-identifier hs-var">with</span></a></span><span> </span><span class="annot"><span class="annottext">m (Maybe Int)
forall (m :: * -&gt; *). ICM m =&gt; m (Maybe Int)
</span><a href="IC.Ref.html#nextStarved"><span class="hs-identifier hs-var">nextStarved</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; Int -&gt; m ()
</span><a href="IC.Ref.html#starveCallContext"><span class="hs-identifier hs-var">starveCallContext</span></a></span><span>
</span><span id="line-1154"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">m (Maybe EntityId) -&gt; (EntityId -&gt; m ()) -&gt; m Bool
forall (m :: * -&gt; *) t a.
Monad m =&gt;
m (Maybe t) -&gt; (t -&gt; m a) -&gt; m Bool
</span><a href="#local-6989586621679322221"><span class="hs-identifier hs-var">with</span></a></span><span> </span><span class="annot"><span class="annottext">m (Maybe EntityId)
forall (m :: * -&gt; *). ICM m =&gt; m (Maybe EntityId)
</span><a href="IC.Ref.html#nextStoppedCanister"><span class="hs-identifier hs-var">nextStoppedCanister</span></a></span><span> </span><span class="annot"><span class="annottext">EntityId -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; EntityId -&gt; m ()
</span><a href="IC.Ref.html#actuallyStopCanister"><span class="hs-identifier hs-var">actuallyStopCanister</span></a></span><span>
</span><span id="line-1155"></span><span>    </span><span class="hs-special">]</span><span>
</span><span id="line-1156"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1157"></span><span>    </span><span id="local-6989586621679322222"><span class="annot"><span class="annottext">try :: [m Bool] -&gt; m Bool
</span><a href="#local-6989586621679322222"><span class="hs-identifier hs-var hs-var">try</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(m Bool -&gt; m Bool -&gt; m Bool) -&gt; m Bool -&gt; [m Bool] -&gt; m Bool
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldr</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679322219"><span class="annot"><span class="annottext">g :: m Bool
</span><a href="#local-6989586621679322219"><span class="hs-identifier hs-var">g</span></a></span></span><span> </span><span id="local-6989586621679322218"><span class="annot"><span class="annottext">r :: m Bool
</span><a href="#local-6989586621679322218"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">m Bool
</span><a href="#local-6989586621679322219"><span class="hs-identifier hs-var">g</span></a></span><span> </span><span class="annot"><span class="annottext">m Bool -&gt; (Bool -&gt; m Bool) -&gt; m Bool
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span> </span><span class="annot"><span class="hs-identifier hs-type">True</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; m Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">False</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">m Bool
</span><a href="#local-6989586621679322218"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; m Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span>
</span><span id="line-1158"></span><span>    </span><span id="local-6989586621679322221"><span class="annot"><span class="annottext">with :: m (Maybe t) -&gt; (t -&gt; m a) -&gt; m Bool
</span><a href="#local-6989586621679322221"><span class="hs-identifier hs-var hs-var">with</span></a></span></span><span> </span><span id="local-6989586621679322217"><span class="annot"><span class="annottext">sel :: m (Maybe t)
</span><a href="#local-6989586621679322217"><span class="hs-identifier hs-var">sel</span></a></span></span><span> </span><span id="local-6989586621679322216"><span class="annot"><span class="annottext">act :: t -&gt; m a
</span><a href="#local-6989586621679322216"><span class="hs-identifier hs-var">act</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m (Maybe t)
</span><a href="#local-6989586621679322217"><span class="hs-identifier hs-var">sel</span></a></span><span> </span><span class="annot"><span class="annottext">m (Maybe t) -&gt; (Maybe t -&gt; m Bool) -&gt; m Bool
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">m Bool -&gt; (t -&gt; m Bool) -&gt; Maybe t -&gt; m Bool
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; m Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679322214"><span class="annot"><span class="annottext">x :: t
</span><a href="#local-6989586621679322214"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">t -&gt; m a
</span><a href="#local-6989586621679322216"><span class="hs-identifier hs-var">act</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679322214"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">m a -&gt; m Bool -&gt; m Bool
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; m Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span>
</span><span id="line-1159"></span><span>
</span><span id="line-1160"></span><span id="local-6989586621679322213"><span class="annot"><a href="IC.Ref.html#runToCompletion"><span class="hs-identifier hs-type">runToCompletion</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679322213"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679322213"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-1161"></span><span id="runToCompletion"><span class="annot"><span class="annottext">runToCompletion :: m ()
</span><a href="IC.Ref.html#runToCompletion"><span class="hs-identifier hs-var hs-var">runToCompletion</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m Bool -&gt; m ()
forall (m :: * -&gt; *). Monad m =&gt; m Bool -&gt; m ()
</span><a href="IC.Utils.html#repeatWhileTrue"><span class="hs-identifier hs-var">repeatWhileTrue</span></a></span><span> </span><span class="annot"><span class="annottext">m Bool
forall (m :: * -&gt; *). ICM m =&gt; m Bool
</span><a href="IC.Ref.html#runStep"><span class="hs-identifier hs-var">runStep</span></a></span><span>
</span><span id="line-1162"></span><span>
</span><span id="line-1163"></span><span>
</span><span id="line-1164"></span><span>
</span><span id="line-1165"></span><span class="hs-comment">-- Error handling plumbing</span><span>
</span><span id="line-1166"></span><span>
</span><span id="line-1167"></span><span class="hs-keyword">type</span><span> </span><span id="CanReject"><span class="annot"><a href="IC.Ref.html#CanReject"><span class="hs-identifier hs-var">CanReject</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Types.html#RejectCode"><span class="hs-identifier hs-type">RejectCode</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span class="hs-special">)</span><span>
</span><span id="line-1168"></span><span id="local-6989586621679323471"><span id="local-6989586621679323473"><span class="annot"><a href="IC.Ref.html#reject"><span class="hs-identifier hs-type">reject</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#CanReject"><span class="hs-identifier hs-type">CanReject</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323473"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#RejectCode"><span class="hs-identifier hs-type">RejectCode</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323473"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323471"><span class="hs-identifier hs-type">a2</span></a></span></span></span><span>
</span><span id="line-1169"></span><span id="reject"><span class="annot"><span class="annottext">reject :: RejectCode -&gt; String -&gt; m a2
</span><a href="IC.Ref.html#reject"><span class="hs-identifier hs-var hs-var">reject</span></a></span></span><span> </span><span id="local-6989586621679322211"><span class="annot"><span class="annottext">code :: RejectCode
</span><a href="#local-6989586621679322211"><span class="hs-identifier hs-var">code</span></a></span></span><span> </span><span id="local-6989586621679322210"><span class="annot"><span class="annottext">msg :: String
</span><a href="#local-6989586621679322210"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(RejectCode, String) -&gt; m a2
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RejectCode
</span><a href="#local-6989586621679322211"><span class="hs-identifier hs-var">code</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679322210"><span class="hs-identifier hs-var">msg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1170"></span><span>
</span><span id="line-1171"></span><span class="hs-comment">-- To maintain the abstraction that the management canister is a canister,</span><span>
</span><span id="line-1172"></span><span class="hs-comment">-- all its errors are turned into canister errors</span><span>
</span><span id="line-1173"></span><span id="local-6989586621679323306"><span id="local-6989586621679323307"><span class="annot"><a href="IC.Ref.html#rejectAsCanister"><span class="hs-identifier hs-type">rejectAsCanister</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#CanReject"><span class="hs-identifier hs-type">CanReject</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323307"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323307"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323306"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323307"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323306"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-1174"></span><span id="rejectAsCanister"><span class="annot"><span class="annottext">rejectAsCanister :: m a -&gt; m a
</span><a href="IC.Ref.html#rejectAsCanister"><span class="hs-identifier hs-var hs-var">rejectAsCanister</span></a></span></span><span> </span><span id="local-6989586621679322209"><span class="annot"><span class="annottext">act :: m a
</span><a href="#local-6989586621679322209"><span class="hs-identifier hs-var">act</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m a -&gt; ((RejectCode, String) -&gt; m a) -&gt; m a
forall e (m :: * -&gt; *) a.
MonadError e m =&gt;
m a -&gt; (e -&gt; m a) -&gt; m a
</span><span class="hs-identifier hs-var">catchError</span></span><span> </span><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679322209"><span class="hs-identifier hs-var">act</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679322207"><span class="annot"><span class="annottext">_c :: RejectCode
</span><a href="#local-6989586621679322207"><span class="hs-identifier hs-var">_c</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679322206"><span class="annot"><span class="annottext">msg :: String
</span><a href="#local-6989586621679322206"><span class="hs-identifier hs-var">msg</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RejectCode -&gt; String -&gt; m a
forall (m :: * -&gt; *) a2.
CanReject m =&gt;
RejectCode -&gt; String -&gt; m a2
</span><a href="IC.Ref.html#reject"><span class="hs-identifier hs-var">reject</span></a></span><span> </span><span class="annot"><span class="annottext">RejectCode
</span><a href="IC.Types.html#RC_CANISTER_ERROR"><span class="hs-identifier hs-var">RC_CANISTER_ERROR</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679322206"><span class="hs-identifier hs-var">msg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1175"></span><span>
</span><span id="line-1176"></span><span id="local-6989586621679323402"><span id="local-6989586621679323403"><span class="annot"><a href="IC.Ref.html#onReject"><span class="hs-identifier hs-type">onReject</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323403"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1177"></span><span>  </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><a href="IC.Types.html#RejectCode"><span class="hs-identifier hs-type">RejectCode</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323403"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323402"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1178"></span><span>  </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679323404"><span class="annot"><a href="#local-6989586621679323404"><span class="hs-identifier hs-type">m'</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Ref.html#CanReject"><span class="hs-identifier hs-type">CanReject</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323404"><span class="hs-identifier hs-type">m'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323404"><span class="hs-identifier hs-type">m'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323404"><span class="hs-identifier hs-type">m'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323402"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323403"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323402"><span class="hs-identifier hs-type">b</span></a></span></span></span><span>
</span><span id="line-1179"></span><span id="onReject"><span class="annot"><span class="annottext">onReject :: ((RejectCode, String) -&gt; m b)
-&gt; (forall (m' :: * -&gt; *). (CanReject m', ICM m') =&gt; m' b) -&gt; m b
</span><a href="IC.Ref.html#onReject"><span class="hs-identifier hs-var hs-var">onReject</span></a></span></span><span> </span><span id="local-6989586621679322205"><span class="annot"><span class="annottext">h :: (RejectCode, String) -&gt; m b
</span><a href="#local-6989586621679322205"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span id="local-6989586621679322204"><span class="annot"><span class="annottext">act :: forall (m' :: * -&gt; *). (CanReject m', ICM m') =&gt; m' b
</span><a href="#local-6989586621679322204"><span class="hs-identifier hs-var">act</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExceptT (RejectCode, String) m b
-&gt; m (Either (RejectCode, String) b)
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="annot"><span class="annottext">ExceptT (RejectCode, String) m b
forall (m' :: * -&gt; *). (CanReject m', ICM m') =&gt; m' b
</span><a href="#local-6989586621679322204"><span class="hs-identifier hs-var">act</span></a></span><span> </span><span class="annot"><span class="annottext">m (Either (RejectCode, String) b)
-&gt; (Either (RejectCode, String) b -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-1180"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679322202"><span class="annot"><span class="annottext">cs :: (RejectCode, String)
</span><a href="#local-6989586621679322202"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(RejectCode, String) -&gt; m b
</span><a href="#local-6989586621679322205"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">(RejectCode, String)
</span><a href="#local-6989586621679322202"><span class="hs-identifier hs-var">cs</span></a></span><span>
</span><span id="line-1181"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679322201"><span class="annot"><span class="annottext">x :: b
</span><a href="#local-6989586621679322201"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">b -&gt; m b
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679322201"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-1182"></span><span>
</span><span id="line-1183"></span><span>
</span><span id="line-1184"></span><span id="local-6989586621679323216"><span id="local-6989586621679323217"><span id="local-6989586621679323218"><span class="annot"><a href="IC.Ref.html#onErr"><span class="hs-identifier hs-type">onErr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679323218"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323218"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="#local-6989586621679323217"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323216"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679323217"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323218"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323216"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323218"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323216"><span class="hs-identifier hs-type">b</span></a></span></span></span></span><span>
</span><span id="line-1185"></span><span id="onErr"><span class="annot"><span class="annottext">onErr :: m (Either a b) -&gt; (a -&gt; m b) -&gt; m b
</span><a href="IC.Ref.html#onErr"><span class="hs-identifier hs-var hs-var">onErr</span></a></span></span><span> </span><span id="local-6989586621679322200"><span class="annot"><span class="annottext">a :: m (Either a b)
</span><a href="#local-6989586621679322200"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679322199"><span class="annot"><span class="annottext">b :: a -&gt; m b
</span><a href="#local-6989586621679322199"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m (Either a b)
</span><a href="#local-6989586621679322200"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">m (Either a b) -&gt; (Either a b -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">(a -&gt; m b) -&gt; (b -&gt; m b) -&gt; Either a b -&gt; m b
forall a c b. (a -&gt; c) -&gt; (b -&gt; c) -&gt; Either a b -&gt; c
</span><span class="hs-identifier hs-var">either</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; m b
</span><a href="#local-6989586621679322199"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">b -&gt; m b
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-1186"></span><span>
</span><span id="line-1187"></span><span id="local-6989586621679323463"><span id="local-6989586621679323464"><span class="annot"><a href="IC.Ref.html#orElse"><span class="hs-identifier hs-type">orElse</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679323464"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323464"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621679323463"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323464"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323463"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323464"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323463"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-1188"></span><span id="orElse"><span class="annot"><span class="annottext">orElse :: m (Maybe a) -&gt; m a -&gt; m a
</span><a href="IC.Ref.html#orElse"><span class="hs-identifier hs-var hs-var">orElse</span></a></span></span><span> </span><span id="local-6989586621679322197"><span class="annot"><span class="annottext">a :: m (Maybe a)
</span><a href="#local-6989586621679322197"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679322196"><span class="annot"><span class="annottext">b :: m a
</span><a href="#local-6989586621679322196"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m (Maybe a)
</span><a href="#local-6989586621679322197"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">m (Maybe a) -&gt; (Maybe a -&gt; m a) -&gt; m a
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">m a -&gt; (a -&gt; m a) -&gt; Maybe a -&gt; m a
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679322196"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-1189"></span><span>
</span><span id="line-1190"></span><span id="local-6989586621679323213"><span id="local-6989586621679323214"><span class="annot"><a href="IC.Ref.html#onTrap"><span class="hs-identifier hs-type">onTrap</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679323214"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323214"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Types.html#TrapOr"><span class="hs-identifier hs-type">TrapOr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323213"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323214"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323213"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679323214"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679323213"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-1191"></span><span id="onTrap"><span class="annot"><span class="annottext">onTrap :: m (TrapOr a) -&gt; (String -&gt; m a) -&gt; m a
</span><a href="IC.Ref.html#onTrap"><span class="hs-identifier hs-var hs-var">onTrap</span></a></span></span><span> </span><span id="local-6989586621679322195"><span class="annot"><span class="annottext">a :: m (TrapOr a)
</span><a href="#local-6989586621679322195"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679322194"><span class="annot"><span class="annottext">b :: String -&gt; m a
</span><a href="#local-6989586621679322194"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m (TrapOr a)
</span><a href="#local-6989586621679322195"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">m (TrapOr a) -&gt; (TrapOr a -&gt; m a) -&gt; m a
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="IC.Types.html#Trap"><span class="hs-identifier hs-type">Trap</span></a></span><span> </span><span id="local-6989586621679322193"><span class="annot"><span class="annottext">msg :: String
</span><a href="#local-6989586621679322193"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; m a
</span><a href="#local-6989586621679322194"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679322193"><span class="hs-identifier hs-var">msg</span></a></span><span class="hs-special">;</span><span> </span><span class="annot"><a href="IC.Types.html#Return"><span class="hs-identifier hs-type">Return</span></a></span><span> </span><span id="local-6989586621679322192"><span class="annot"><span class="annottext">x :: a
</span><a href="#local-6989586621679322192"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679322192"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1192"></span><span>
</span><span id="line-1193"></span><span>
</span><span id="line-1194"></span></pre></body></html>